<!DOCTYPE html>
<html lang="en" dir="ltr" class="">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Rooza | Habit Tracker App</title>
    <meta name="description" content="Rooza, a personal habit and goal management application.">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <meta name="apple-mobile-web-app-title" content="Rooza">
    <meta name="application-name" content="Rooza">

    <link rel="icon" type="image/png" href="https://i.ibb.co/kV0P6jz5/rooza-app.png">

    <link rel="apple-touch-icon" href="https://i.ibb.co/kV0P6jz5/rooza-app.png">
    <link rel="apple-touch-icon" sizes="152x152" href="https://i.ibb.co/kV0P6jz5/rooza-app.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://i.ibb.co/kV0P6jz5/rooza-app.png">
    <link rel="apple-touch-icon" sizes="167x167" href="https://i.ibb.co/kV0P6jz5/rooza-app.png">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .sortable-ghost { opacity: 0.4; background-color: #cce7ff; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* Animations for Goal Cards */
        .goal-anim-in { animation: goal-fade-in 0.4s ease-out forwards; }
        .goal-anim-out { animation: goal-fade-out 0.3s ease-in forwards; }
        @keyframes goal-fade-in {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes goal-fade-out {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }
        /* Animations for Swipe Gestures */
        .cell-swipe-up { animation: cell-pop 0.2s ease-out forwards; }
        .cell-swipe-down { animation: cell-shrink 0.2s ease-out forwards; }
        @keyframes cell-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); background-color: hsla(120, 73%, 75%, 0.5); }
            100% { transform: scale(1); }
        }
        @keyframes cell-shrink {
            0% { transform: scale(1); }
            50% { transform: scale(0.85); background-color: hsla(0, 100%, 80%, 0.5); }
            100% { transform: scale(1); }
        }
        /* Styles for Stats Modal */
        .stat-card {
            @apply bg-white dark:bg-slate-700/50 p-4 rounded-xl text-center shadow-sm transition-all hover:shadow-md hover:scale-105;
        }
        .stat-value {
            @apply text-2xl font-bold text-indigo-600 dark:text-indigo-400 mb-1;
        }
        .stat-label {
            @apply text-xs text-slate-500 dark:text-slate-400 font-semibold;
        }
        /* NEW Pill Buttons Style for Report Selector */
        .report-tab-btn {
            @apply px-4 py-2 text-sm font-semibold rounded-full shadow-sm transition-colors duration-300 ease-in-out bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200 hover:bg-slate-300 dark:hover:bg-slate-600;
        }
        .report-tab-btn.active {
            @apply bg-indigo-600 text-white shadow-lg shadow-indigo-500/30;
        }

        .heatmap-day {
             @apply aspect-square rounded-lg flex items-center justify-center text-xs transition-colors relative cursor-pointer;
        }
        .heatmap-count {
            @apply absolute -top-1.5 -right-1.5 bg-sky-500 text-white text-[10px] font-bold rounded-full w-5 h-5 flex items-center justify-center border-2 border-white dark:border-slate-800 shadow-lg;
        }
        /* Glassmorphism Modal Style */
        .glass-modal-content {
            @apply bg-slate-50/95 dark:bg-slate-900/95 backdrop-blur-xl border border-slate-200/50 dark:border-slate-700/50;
            background-color: #fbfbfbf2;
        }
        .dark .glass-modal-content {
            background-color: #0e0e0ef2;
        }
        /* Custom style for completed day cells */
        .day-completed {
            background-color: #ebfaee !important;
        }
        .dark .day-completed {
            background-color: #e8f1ea8f !important;
        }
        /* Settings Menu */
        #settingsMenu { display: none; }
        #settingsMenu.visible { display: block; }
        /* Emoji Container Styles */
        .emoji-container {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 9999px;
            transition: background-color 0.2s;
            background-color: #f1f5f9;
        }
        .dark .emoji-container {
            background-color: rgb(59 130 246 / 13%);
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: { DEFAULT: 'hsl(250, 85%, 60%)', dark: 'hsl(250, 90%, 70%)' },
                        accent: 'hsl(205, 90%, 55%)',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200 antialiased">
    <div class="min-h-screen pt-[env(safe-area-inset-top)]">
        <header id="navbar" class="sticky top-0 z-50 bg-white/80 dark:bg-slate-900/80 backdrop-blur-lg flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700">
            <div class="flex-1">
                <div class="relative">
                    <button id="settingsMenuBtn" aria-label="Settings" class="text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full p-2 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>
                    <div id="settingsMenu" class="absolute left-0 mt-2 w-56 origin-top-left bg-white/80 dark:bg-slate-800/80 backdrop-blur-lg shadow-2xl rounded-xl border border-slate-200 dark:border-slate-700 p-2 text-base z-[1001]">
                        <button id="reportBtn" class="w-full text-left flex items-center gap-3 p-3 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                            <span>Reports</span>
                        </button>
                        <button id="archiveToggleBtn" class="w-full text-left flex items-center gap-3 p-3 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                            <span>Show Archive</span>
                        </button>
                         <button id="darkModeBtn" class="w-full text-left flex items-center gap-3 p-3 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors">
                            <span class="text-xl w-5 text-center">🌙</span>
                            <span>Change Theme</span>
                        </button>
                        <div class="my-1 h-px bg-slate-200 dark:bg-slate-700"></div>
                        <button id="backupBtn" class="w-full text-left flex items-center gap-3 p-3 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M12 15l-3-3m0 0l3-3m-3 3h12" />
                            </svg>
                            <span>Backup</span>
                        </button>
                         <button id="aboutBtn" class="w-full text-left flex items-center gap-3 p-3 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                 <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span>About</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-2">
                 <button id="prevWeekBtn" aria-label="Previous Week" class="text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full p-2 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <div id="weekTitle" class="text-base md:text-lg font-bold text-indigo-600 dark:text-indigo-400 w-40 text-center">Week</div>
                <button id="nextWeekBtn" aria-label="Next Week" class="text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full p-2 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </button>
            </div>
            <div class="flex-1 flex justify-end"></div>
        </header>

        <main id="mainContent" class="max-w-4xl mx-auto p-4 pb-32">
            <div id="currentDateDisplay" class="text-center text-sm text-slate-500 dark:text-slate-400 mb-6 font-semibold"></div>
            <div id="weekdayRow" class="grid grid-cols-7 gap-2 text-center mb-6"></div>
            <div id="categoryFilters" class="flex justify-center gap-2 mb-6 flex-wrap"></div>
            <div id="goalList" class="flex flex-col gap-4"></div>
            <div id="archivedGoalList" class="hidden">
                <h3 class="text-lg font-bold text-slate-500 dark:text-slate-400 my-4 p-2 border-b-2 border-slate-200 dark:border-slate-700">Archived Goals</h3>
                <div class="flex flex-col gap-4"></div>
            </div>
        </main>

        <footer id="totalsBar" class="fixed bottom-0 left-0 right-0 z-40 bg-white/80 dark:bg-slate-900/80 backdrop-blur-lg border-t border-slate-200 dark:border-slate-700 flex items-center justify-around pb-[calc(env(safe-area-inset-bottom)+0.5rem)] pt-3 text-center"></footer>
        <button id="fab" aria-label="Add Goal" class="fixed right-6 bottom-[calc(env(safe-area-inset-bottom)+5rem)] z-50 w-16 h-16 bg-indigo-600 text-white rounded-full flex items-center justify-center text-3xl shadow-lg hover:bg-indigo-700 active:scale-90 transition-transform">＋</button>
    </div>

    <div id="modalArea"></div>
    <div id="contextMenu" class="fixed z-[1000] min-w-[180px] bg-white/80 dark:bg-slate-800/80 backdrop-blur-lg shadow-2xl rounded-xl border border-slate-200 dark:border-slate-700 p-2 text-base" style="display:none"></div>

<script>
    // --- CONSTANTS & CONFIG ---
    const EMOJIS = ['✅','🎉','🔥','💪','🎯','👍','👎','❌','🤔','😴','🍔','💻','🧘','📖'];
    const CATEGORIES = {
        'Workout': 'bg-sky-100 text-sky-800 dark:bg-sky-900/50 dark:text-sky-300',
        'Work': 'bg-amber-100 text-amber-800 dark:bg-amber-900/50 dark:text-amber-300',
        'Personal': 'bg-violet-100 text-violet-800 dark:bg-violet-900/50 dark:text-violet-300',
        'Health': 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300',
    };
    const STORAGE_KEY = 'goal_tracker_data_v14_en';
    const STORAGE_ORDER = 'goal_tracker_order_v14_en';
    const STORAGE_THEME = 'goal_tracker_theme_v4';
    const WEEKDAY_NAMES_SHORT = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const GREGORIAN_MONTH_NAMES = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

    // --- STATE MANAGEMENT ---
    let appState = {
        currentWeek: getStartOfWeek(new Date()),
        goals: [], order: [], theme: 'auto', editing: null, showArchived: false,
        activeCategory: 'all',
        contextMenuGoalId: null
    };

    // --- UTILITY FUNCTIONS ---
    function getStartOfWeek(date) { const d = new Date(date); d.setHours(0, 0, 0, 0); d.setDate(d.getDate() - d.getDay()); return d; }
    function getWeekDates(base) { return Array.from({length: 7}, (_, i) => { const d = new Date(base); d.setDate(base.getDate() + i); return d; }); }
    function formatWeekRange(base) {
        const week = getWeekDates(base);
        const start = week[0];
        const end = week[6];
        const options = { month: 'short', day: 'numeric' };
        if (start.getMonth() === end.getMonth()) {
            return `${start.toLocaleDateString('en-US', {month: 'long'})} ${start.getDate()} - ${end.getDate()}`;
        }
        return `${start.toLocaleDateString('en-US', options)} - ${end.toLocaleDateString('en-US', options)}`;
    }
    function isToday(date) { const now = new Date(); return date.toDateString() === now.toDateString(); }
    function weekIdForDate(date) { const d = getStartOfWeek(date); return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`; }
    function escapeHtml(txt) { return (''+txt).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g, '&quot;'); }

    // --- DATA PERSISTENCE ---
    function getDefaultGoals() {
        const creationDate = new Date().toISOString();
        const goals = [
            { id: 'default_1', name: 'Daily Workout', emoji: '💪', days: [false, true, true, true, true, true, false], history: {}, type: 'binary', archived: false, category: 'Workout', creationDate },
            { id: 'default_2', name: 'Read a Book', emoji: '📖', days: [true, true, true, true, true, true, true], history: {}, type: 'binary', archived: false, category: 'Personal', creationDate },
            { id: 'default_3', name: 'Practice a Skill', emoji: '💻', days: [false, true, false, true, false, true, false], history: {}, type: 'binary', archived: false, category: 'Work', creationDate }
        ];
        const order = goals.map(g => g.id);
        return { goals, order };
    }
    function loadStateFromStorage() {
        const data = localStorage.getItem(STORAGE_KEY);
        const order = localStorage.getItem(STORAGE_ORDER);
        const theme = localStorage.getItem(STORAGE_THEME) || 'auto';
        let goals, orderArr;
        if (data && order) {
            try {
                goals = JSON.parse(data);
                orderArr = JSON.parse(order);
            } catch (e) {
                console.error("Failed to parse localStorage data, resetting to default.", e);
                const defaults = getDefaultGoals();
                goals = defaults.goals;
                orderArr = defaults.order;
            }
        } else {
            const defaults = getDefaultGoals();
            goals = defaults.goals;
            orderArr = defaults.order;
        }
        goals.forEach(g => {
            g.type = g.type || 'binary';
            if (typeof g.archived === 'undefined') g.archived = false;
            if (typeof g.category === 'undefined') g.category = 'Personal';
            if (typeof g.creationDate === 'undefined') g.creationDate = new Date().toISOString();
            if (g.history) {
                Object.values(g.history).forEach(week => {
                    if (Array.isArray(week)) {
                        week.forEach((day, i) => {
                            if (day && typeof day !== 'object') {
                                week[i] = { entries: [day === 1 ? '✅' : '❌'], note: '' };
                            } else if (day && !day.entries) {
                                week[i] = { entries: [], note: ''};
                            }
                        });
                    }
                });
            }
        });
        appState.goals = goals;
        appState.order = orderArr.filter(id => goals.some(g => g.id === id));
        appState.theme = theme;
    }
    function persistState() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(appState.goals));
        localStorage.setItem(STORAGE_ORDER, JSON.stringify(appState.order));
    }
    function setTheme(theme) {
        appState.theme = theme;
        localStorage.setItem(STORAGE_THEME, theme);
        applyTheme();
    }
    function applyTheme() {
        let themeToApply = appState.theme;
        if (themeToApply === 'auto') {
            themeToApply = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }
        document.documentElement.classList.toggle('dark', themeToApply === 'dark');
        document.querySelector('#darkModeBtn .text-xl').innerText = themeToApply === 'dark' ? '🌞' : '🌙';
    }

    // --- RENDER FUNCTIONS ---
    function fullRender() {
        renderHeader();
        renderGoals();
        renderTotals();
        renderCategoryFilters();
        applyTheme();
        initSortable();
        setupCellListeners();
        if (appState.editing) {
            setTimeout(() => initEditInput(appState.editing), 30);
        }
    }
    function renderHeader() {
        document.getElementById('weekTitle').innerText = formatWeekRange(appState.currentWeek);
        const today = new Date();
        const formattedDate = today.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        document.getElementById('currentDateDisplay').innerText = `Today is ${formattedDate}`;
        const weekDates = getWeekDates(appState.currentWeek);
        document.getElementById('weekdayRow').innerHTML = weekDates.map((d, i) => {
            const dayNumber = d.getDate();
            const dayName = WEEKDAY_NAMES_SHORT[i];
            let classes = "flex flex-col items-center justify-center p-2 rounded-lg transition-colors text-slate-500 dark:text-slate-400";
            if (isToday(d)) {
                classes = "flex flex-col items-center justify-center p-2 rounded-lg transition-colors bg-indigo-600 text-white font-bold shadow-lg shadow-indigo-500/30";
            }
            return `<div class="${classes}" data-day="${i}"><span class="text-sm font-semibold">${dayName}</span><span class="text-xs mt-1">${dayNumber}</span></div>`;
        }).join('');
    }
    function renderCategoryFilters() {
        const filters = ['all', ...Object.keys(CATEGORIES)];
        let html = filters.map(cat => {
            const isActive = appState.activeCategory === cat;
            const activeClass = 'bg-indigo-600 text-white';
            const inactiveClass = 'bg-white dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600';
            return `<button data-category="${cat}" class="px-4 py-2 text-sm font-semibold rounded-full shadow-sm transition-colors ${isActive ? activeClass : inactiveClass}">${cat === 'all' ? 'All' : cat}</button>`;
        }).join('');
        document.getElementById('categoryFilters').innerHTML = html;
    }
    function renderGoals() {
        const filteredGoals = appState.order
            .map(id => appState.goals.find(g => g.id === id))
            .filter(g => g && !g.archived && (appState.activeCategory === 'all' || g.category === appState.activeCategory));
        const archivedGoals = appState.goals.filter(g => g && g.archived);

        document.getElementById('goalList').innerHTML = filteredGoals.map(renderSingleGoalCard).join('');
        const archivedContainer = document.getElementById('archivedGoalList');
        if (appState.showArchived && archivedGoals.length > 0) {
            archivedContainer.classList.remove('hidden');
            archivedContainer.querySelector('.flex').innerHTML = archivedGoals.map(renderSingleGoalCard).join('');
        } else {
            archivedContainer.classList.add('hidden');
        }
    }
    function renderSingleGoalCard(goal) {
        const weekDates = getWeekDates(appState.currentWeek);
        const currentWeekId = weekIdForDate(appState.currentWeek);
        
        const { weekly } = calculateScores(goal);
        
        const categoryClasses = CATEGORIES[goal.category] || 'bg-slate-100 text-slate-800';
        const dayCellsHtml = weekDates.map((date, i) => {
            const isActive = !!goal.days[i];
            const dayData = goal.history?.[currentWeekId]?.[i] || { entries: [], note: '' };
            const dayCompleted = dayData.entries.length > 0;
            const baseClasses = "goal-day group aspect-square rounded-full flex items-center justify-center relative transition-colors cursor-pointer";
            const activeClasses = "active bg-slate-200 dark:bg-slate-700/50 hover:bg-slate-300 dark:hover:bg-slate-600";
            const disabledClasses = "bg-slate-100 dark:bg-slate-800/50 opacity-60 !cursor-not-allowed";
            const todayClasses = "border-2 border-sky-500 shadow-md shadow-sky-500/30";
            let classes = `${baseClasses} ${isActive ? activeClasses : disabledClasses}`;
            if(dayCompleted) classes += ' day-completed';
            if (isActive && isToday(date)) classes += ` ${todayClasses}`;
            let cellContent = `<div class="flex flex-wrap items-center justify-center gap-px leading-none p-1">${dayData.entries.map(em => em ? `<span class="text-sm md:text-base">${escapeHtml(em)}</span>` : '').join('')}</div>`;
            return `<div class="${classes}" data-goal-id="${goal.id}" data-day-index="${i}" tabindex="0">${cellContent}${dayData.note ? `<div class="absolute top-0 right-0 w-2 h-2 bg-amber-400 rounded-full" title="${escapeHtml(dayData.note)}"></div>` : ''}</div>`;
        }).join('');
        
        const statsHtml = `
            <div class="flex items-center gap-x-3 gap-y-1 flex-wrap text-sm text-slate-500 dark:text-slate-400 mt-1">
                <span class="text-xs font-semibold px-3 py-1 rounded-full ${categoryClasses}">${goal.category}</span>
                <div class="flex items-center gap-1">
                    <span class="weekly-score">Week: ${weekly}</span>
                </div>
            </div>
        `;

        return `
        <div class="goal-card bg-white dark:bg-slate-800 shadow-md rounded-2xl p-4 goal-anim-in ${goal.archived ? 'opacity-60' : ''}" data-id="${goal.id}">
            <div class="flex items-center gap-2 mb-4">
                <div class="emoji-container text-3xl">${goal.emoji || '🎯'}</div>
                <div class="flex-grow min-w-0">
                    <div class="flex items-center gap-2">
                        ${appState.editing === goal.id
                            ? `<input class="w-full bg-slate-100 dark:bg-slate-700 text-lg font-bold p-2 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500" id="edit-${goal.id}" value="${escapeHtml(goal.name)}" />`
                            : `<h3 class="text-lg font-bold truncate cursor-pointer hover:text-indigo-600" onclick="showStatsModal('${goal.id}')">${escapeHtml(goal.name || 'Untitled')}</h3>`
                        }
                    </div>
                    ${statsHtml}
                </div>
                ${!goal.archived ? `<div class="goal-handle text-slate-400 dark:text-slate-500 cursor-grab p-2 text-xl">&#x2630;</div>`: ''}
                <button onclick="showContextMenu(event, '${goal.id}')" class="text-slate-400 dark:text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full p-2 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" /></svg>
                </button>
            </div>
            <div class="grid grid-cols-7 gap-2">${dayCellsHtml}</div>
        </div>`;
    }
    function renderTotals() {
        const activeGoals = appState.goals.filter(g => !g.archived);
        let weeklyScore = 0, allTimeScore = 0;
        activeGoals.forEach(g => {
            const scores = calculateScores(g);
            weeklyScore += scores.weekly;
            allTimeScore += scores.allTime;
        });
        document.getElementById('totalsBar').innerHTML = `
            <div class="flex-1"><div class="font-bold text-lg text-indigo-600 dark:text-indigo-400">${weeklyScore}</div><div class="text-xs text-slate-500">Week Score</div></div>
            <div class="flex-1"><div class="font-bold text-lg text-indigo-600 dark:text-indigo-400">${allTimeScore}</div><div class="text-xs text-slate-500">Total Score</div></div>`;
    }

    // --- CALCULATIONS ---
    function getEntryCountOnDate(goal, date) {
        if (!date || !goal) return 0;
        const localDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
        const dayIndex = localDate.getDay();
        const weekId = weekIdForDate(localDate);
        const dayData = goal.history?.[weekId]?.[dayIndex];
        return dayData?.entries?.length || 0;
    }
    
    function calculateScores(goal) {
        let weekly = 0, allTime = 0;
        const currentWeekId = weekIdForDate(appState.currentWeek);
        if (goal.history) {
            for (const weekId in goal.history) {
                const weekData = goal.history[weekId];
                if (!weekData) continue;
                let scoreForWeek = 0;
                weekData.forEach((dayData, dayIndex) => {
                    if (!dayData) return;
                    if (goal.days[dayIndex]) {
                        scoreForWeek += (dayData.entries.length || 0);
                    }
                });
                if (weekId === currentWeekId) weekly = scoreForWeek;
                allTime += scoreForWeek;
            }
        }
        return { weekly, allTime };
    }

    // --- MODALS & MENUS ---
    function closeModal() {
        const modalArea = document.getElementById('modalArea');
        if (modalArea.lastElementChild) {
             modalArea.removeChild(modalArea.lastElementChild);
        }
    }
    function closeContextMenu() {
        const menu = document.getElementById('contextMenu');
        menu.style.display = 'none';
        appState.contextMenuGoalId = null;
    }
    function toggleSettingsMenu(visible) {
        const menu = document.getElementById('settingsMenu');
        menu.classList.toggle('visible', visible);
        if (visible) {
            setTimeout(() => document.addEventListener('click', closeSettingsMenuOnClickOutside, { once: true }), 10);
        }
    }
    function closeSettingsMenuOnClickOutside(e) {
        if (!e.target.closest('#settingsMenu') && !e.target.closest('#settingsMenuBtn')) {
            toggleSettingsMenu(false);
        } else {
            document.addEventListener('click', closeSettingsMenuOnClickOutside, { once: true });
        }
    }
    function showAboutModal() {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4';
        modal.innerHTML = `
            <div class="modal-content glass-modal-content rounded-2xl p-6 w-full max-w-md shadow-2xl">
                <div class="flex flex-col items-center text-center">
                    <div class="w-24 h-24 bg-white dark:bg-slate-800 rounded-3xl flex items-center justify-center mb-5 border border-slate-200 dark:border-slate-700 shadow-md">
                        <img src="https://i.ibb.co/kV0P6jz5/rooza-app.png" alt="Rooza Logo" class="w-16 h-16"/>
                    </div>
                    <h2 class="text-2xl font-bold mb-2 text-slate-900 dark:text-white">Rooza</h2>
                    <p class="text-base text-slate-600 dark:text-slate-300 mb-6">A personal habit and goal management app.</p>
                    <div class="text-sm text-slate-500 dark:text-slate-400 space-y-2">
                        <p>Version 1.0</p>
                        <p>Made to help you build better habits.</p>
                        <p>Copyright © ${new Date().getFullYear()} - Rooza</p>
                    </div>
                    <button class="close-modal-btn w-full mt-8 p-3 rounded-lg font-bold bg-indigo-600 text-white hover:bg-indigo-700 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Close</button>
                </div>
            </div>
        `;
        document.getElementById('modalArea').appendChild(modal);
        modal.onclick = e => { if (e.target === modal || e.target.closest('.close-modal-btn')) closeModal(); };
    }
    function showBackupModal() {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4';
        modal.innerHTML = `
            <div class="modal-content glass-modal-content rounded-2xl p-6 w-full max-w-lg shadow-2xl max-h-[90vh] overflow-y-auto no-scrollbar">
                <div class="flex justify-between items-center mb-5">
                    <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Backup & Restore</h2>
                    <button class="close-modal-btn text-slate-500 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-full p-2 transition-colors">&times;</button>
                </div>
                <div class="space-y-6">
                    <div class="bg-white/50 dark:bg-slate-800/50 p-5 rounded-xl border border-slate-200 dark:border-slate-700">
                        <div class="flex items-start gap-4">
                            <div class="flex-shrink-0 w-12 h-12 rounded-full bg-green-100 dark:bg-green-900/50 flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600 dark:text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg text-slate-800 dark:text-slate-100">Export Data</h3>
                                <p class="text-sm text-slate-600 dark:text-slate-400 mt-1 mb-4">Download a JSON file of all your goals and history. Keep it in a safe place to restore later.</p>
                                <button id="exportBtn" class="w-full sm:w-auto px-5 py-2.5 rounded-lg font-bold bg-green-600 text-white hover:bg-green-700 transition-colors">Download Backup</button>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white/50 dark:bg-slate-800/50 p-5 rounded-xl border border-slate-200 dark:border-slate-700">
                        <div class="flex items-start gap-4">
                            <div class="flex-shrink-0 w-12 h-12 rounded-full bg-sky-100 dark:bg-sky-900/50 flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-sky-600 dark:text-sky-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg text-slate-800 dark:text-slate-100">Import Data</h3>
                                <p class="text-sm text-slate-600 dark:text-slate-400 mt-1 mb-4">Select a JSON backup file to restore your data. Please note:</p>
                                <div class="p-3 mb-4 rounded-lg bg-amber-100/50 dark:bg-amber-900/30 border border-amber-300 dark:border-amber-800 text-amber-800 dark:text-amber-300 text-sm">
                                    <strong>Warning:</strong> This will overwrite all your current data and cannot be undone.
                                </div>
                                <button id="importBtn" class="w-full sm:w-auto px-5 py-2.5 rounded-lg font-bold bg-sky-600 text-white hover:bg-sky-700 transition-colors">Select File & Restore</button>
                            </div>
                        </div>
                    </div>
                </div>
                <input type="file" id="importFile" class="hidden" accept=".json">
            </div>
        `;
        document.getElementById('modalArea').appendChild(modal);
        modal.onclick = e => { if (e.target === modal || e.target.closest('.close-modal-btn')) closeModal(); };
        modal.querySelector('#exportBtn').onclick = exportData;
        modal.querySelector('#importBtn').onclick = () => document.getElementById('importFile').click();
        modal.querySelector('#importFile').onchange = importData;
    }
    function exportData() {
        try {
            const dataToExport = {
                goals: appState.goals,
                order: appState.order
            };
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            const today = new Date().toISOString().slice(0, 10);
            link.download = `rooza-backup-${today}.json`;
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
            closeModal();
        } catch (error) {
            console.error("Error exporting data:", error);
            alert("Error exporting data.");
        }
    }
    function importData(event) {
        const file = event.target.files[0];
        if (!file) return;
        if (!confirm("Are you sure? Importing will overwrite all current data. This action cannot be undone.")) {
            return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedData = JSON.parse(e.target.result);
                if (importedData && Array.isArray(importedData.goals) && Array.isArray(importedData.order)) {
                    appState.goals = importedData.goals;
                    appState.order = importedData.order;
                    persistState();
                    loadStateFromStorage();
                    fullRender();
                    closeModal();
                    alert("Data imported successfully.");
                } else {
                    throw new Error("Invalid file format.");
                }
            } catch (error) {
                console.error("Error importing data:", error);
                alert("Error importing data. The selected file is not valid.");
            }
        };
        reader.readAsText(file);
    }
    function renderMonthlyHeatmap(container, goal, year, month) {
        const firstDateOfMonth = new Date(year, month, 1);
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const startOffset = firstDateOfMonth.getDay(); // 0 for Sunday
        
        let html = `
            <div class="flex items-center justify-between mb-3 px-1">
                 <button data-action="prev" class="heatmap-nav-btn p-1 rounded-full hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <span class="font-bold text-sm">${firstDateOfMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric'})}</span>
                <button data-action="next" class="heatmap-nav-btn p-1 rounded-full hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">
                   <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>
            <div class="grid grid-cols-7 gap-1 text-center text-xs text-slate-400 mb-2">
                ${WEEKDAY_NAMES_SHORT.map(d => `<div>${d}</div>`).join('')}
            </div>
            <div class="grid grid-cols-7 gap-1.5">`;
        for (let i = 0; i < startOffset; i++) {
            html += '<div></div>';
        }
        for (let day = 1; day <= daysInMonth; day++) {
            const currentDate = new Date(year, month, day);
            let colorClass = 'bg-slate-200/80 dark:bg-slate-700/80';
            const entryCount = getEntryCountOnDate(goal, currentDate);
            if (entryCount > 0) {
                colorClass = 'bg-green-500 text-white font-bold';
            } else if (goal && !goal.days[currentDate.getDay()]) {
                colorClass = 'bg-slate-100 dark:bg-slate-800/60 opacity-70';
            }
            if(isToday(currentDate)) colorClass += ' ring-2 ring-sky-500';
            html += `<div class="heatmap-day ${colorClass}" title="${currentDate.toLocaleDateString('en-US')}">
                        <span class="text-sm font-semibold">${day}</span>
                        ${entryCount > 0 ? `<span class="heatmap-count">${entryCount}</span>` : ''}
                    </div>`;
        }
        html += `</div>`;
        container.innerHTML = html;
        container.querySelectorAll('.heatmap-nav-btn').forEach(btn => {
            btn.onclick = () => {
                let newDate = new Date(year, month, 1);
                if (btn.dataset.action === 'next') {
                    newDate.setMonth(newDate.getMonth() + 1);
                } else {
                    newDate.setMonth(newDate.getMonth() - 1);
                }
                renderMonthlyHeatmap(container, goal, newDate.getFullYear(), newDate.getMonth());
            }
        });
    }
    function showStatsModal(goalId) {
        const goal = appState.goals.find(g => g.id === goalId);
        if (!goal) return;
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4';
        modal.innerHTML = `
            <div class="modal-content bg-slate-100 dark:bg-slate-800 rounded-2xl p-4 md:p-6 w-full max-w-md max-h-[90vh] overflow-y-auto shadow-2xl no-scrollbar">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl md:text-2xl font-bold text-indigo-600 dark:text-indigo-400 flex items-center gap-3">
                        <span class="text-2xl">${goal.emoji}</span>
                        <span>${escapeHtml(goal.name)}</span>
                    </h2>
                    <button class="close-modal-btn text-slate-500 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-full p-2 transition-colors">&times;</button>
                </div>
                <div>
                    <h3 class="font-bold mb-3 text-slate-700 dark:text-slate-300 text-center">Activity Calendar</h3>
                    <div id="heatmap-container" class="p-3 bg-white dark:bg-slate-700/50 rounded-xl shadow-inner"></div>
                </div>
            </div>`;
        document.getElementById('modalArea').appendChild(modal);
        const heatmapContainer = modal.querySelector('#heatmap-container');
        const today = new Date();
        renderMonthlyHeatmap(heatmapContainer, goal, today.getFullYear(), today.getMonth());
        modal.onclick = e => { if (e.target === modal || e.target.closest('.close-modal-btn')) closeModal(); };
    }

    // --- NEW REPORT MODAL ---
    function showReportModal() {
        let currentReportDate = new Date();
        let currentReportView = 'month'; // 'day', 'week', 'month', 'overall'
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4';
        modal.innerHTML = `
            <div class="modal-content glass-modal-content rounded-2xl p-4 sm:p-6 w-full max-w-4xl max-h-[90vh] flex flex-col shadow-2xl">
                <div class="flex-shrink-0 flex justify-between items-center mb-4">
                    <h2 class="text-xl sm:text-2xl font-bold text-slate-900 dark:text-white">Progress Report</h2>
                    <button class="close-modal-btn text-slate-500 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-full p-2 transition-colors">&times;</button>
                </div>
                <div class="flex-shrink-0 flex flex-col sm:flex-row items-center justify-between gap-4 mb-4">
                     <div class="flex items-center gap-2">
                        <button id="report-prev-btn" aria-label="Previous" class="p-2 rounded-full hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors">
                             <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        </button>
                        <div id="report-date-display" class="w-48 text-center font-bold text-indigo-600 dark:text-indigo-400"></div>
                        <button id="report-next-btn" aria-label="Next" class="p-2 rounded-full hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                    </div>
                    <div id="report-tabs" class="w-full sm:w-auto flex flex-wrap items-center justify-center gap-2">
                         <button data-view="day" class="report-tab-btn">Day</button>
                         <button data-view="week" class="report-tab-btn">Week</button>
                         <button data-view="month" class="report-tab-btn active">Month</button>
                         <button data-view="overall" class="report-tab-btn">Year</button>
                    </div>
                </div>
                <div id="report-content" class="flex-grow overflow-y-auto space-y-3 p-1 -mr-2 pr-2 no-scrollbar"></div>
            </div>`;
        document.getElementById('modalArea').appendChild(modal);
        modal.onclick = e => { if (e.target === modal || e.target.closest('.close-modal-btn')) closeModal(); };

        const tabs = modal.querySelector('#report-tabs');
        const contentArea = modal.querySelector('#report-content');
        const dateDisplay = modal.querySelector('#report-date-display');
        const prevBtn = modal.querySelector('#report-prev-btn');
        const nextBtn = modal.querySelector('#report-next-btn');

        function updateReportView() {
            renderReportContent(contentArea, dateDisplay, currentReportView, currentReportDate);
            tabs.querySelectorAll('.report-tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === currentReportView);
            });
        }

        tabs.addEventListener('click', e => {
            const button = e.target.closest('.report-tab-btn');
            if (button) {
                currentReportView = button.dataset.view;
                currentReportDate = new Date();
                updateReportView();
            }
        });

        const navigate = (direction) => {
            if (currentReportView === 'day') currentReportDate.setDate(currentReportDate.getDate() + direction);
            else if (currentReportView === 'week') currentReportDate.setDate(currentReportDate.getDate() + (7 * direction));
            else if (currentReportView === 'month') currentReportDate.setMonth(currentReportDate.getMonth() + direction);
            else if (currentReportView === 'overall') currentReportDate.setFullYear(currentReportDate.getFullYear() + direction);
            updateReportView();
        };

        prevBtn.addEventListener('click', () => navigate(-1));
        nextBtn.addEventListener('click', () => navigate(1));

        updateReportView(); // Initial render
    }

    function renderReportContent(container, dateDisplay, view, date) {
        const goals = appState.goals.filter(g => !g.archived);
        if (goals.length === 0) {
            container.innerHTML = `<div class="text-center text-slate-500 p-8">No active habits to report.</div>`;
            dateDisplay.innerText = '-';
            return;
        }

        if (view === 'overall') {
            const year = date.getFullYear();
            dateDisplay.innerText = `Year ${year}`;
            renderOverallReport(container, year);
            return;
        }

        let startDate, endDate, dateLabel = '';
        if (view === 'day') {
            startDate = new Date(date); startDate.setHours(0,0,0,0);
            endDate = new Date(date); endDate.setHours(23,59,59,999);
            dateLabel = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        } else if (view === 'week') {
            startDate = getStartOfWeek(date);
            endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
            endDate.setHours(23,59,59,999);
            dateLabel = formatWeekRange(startDate);
        } else { // month
            startDate = new Date(date.getFullYear(), date.getMonth(), 1);
            endDate = new Date(date.getFullYear(), date.getMonth() + 1, 0);
            endDate.setHours(23,59,59,999);
            dateLabel = startDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
        }

        dateDisplay.innerText = dateLabel;
        let reportHtml = '';
        goals.forEach(goal => {
            let totalCompletions = 0;
            let totalTarget = 0;
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dayIndex = d.getDay();
                if (goal.days[dayIndex]) {
                    totalTarget++;
                    totalCompletions += getEntryCountOnDate(goal, d);
                }
            }
            const percentage = totalTarget > 0 ? Math.round((totalCompletions / totalTarget) * 100) : 0;

            reportHtml += `
                <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${goal.emoji}</span>
                            <span class="font-bold text-slate-700 dark:text-slate-200">${escapeHtml(goal.name)}</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center text-sm font-semibold text-slate-500 dark:text-slate-400 mb-2">
                        <span>Period Completion: ${totalCompletions} / ${totalTarget}</span>
                        <span class="font-bold text-indigo-500">${percentage}%</span>
                    </div>
                    <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5">
                        <div class="bg-indigo-600 h-2.5 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                </div>
            `;
        });
        container.innerHTML = reportHtml;
    }

    function renderOverallReport(container, year) {
        const { totalCompletions, busiestDay } = calculateOverallStats();

        const statsHtml = `
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                <div class="stat-card">
                    <div class="stat-value">${totalCompletions}</div>
                    <div class="stat-label">Total Completions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${busiestDay}</div>
                    <div class="stat-label">Busiest Day</div>
                </div>
            </div>`;

        const heatmapContainerId = `yearly-heatmap-${year}`;
        container.innerHTML = statsHtml + `<div id="${heatmapContainerId}" class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm"></div>`;
        renderYearlyHeatmap(document.getElementById(heatmapContainerId), year);
    }

    function calculateOverallStats() {
        let totalCompletions = 0;
        const dayCounts = [0, 0, 0, 0, 0, 0, 0]; // Sun, Mon, ..., Sat
        const goals = appState.goals.filter(g => !g.archived);
        
        goals.forEach(goal => {
            if (goal.history) {
                 Object.values(goal.history).forEach(weekData => {
                      if (weekData) {
                          weekData.forEach((dayData, dayIndex) => {
                               if (dayData && dayData.entries.length > 0) {
                                   totalCompletions += dayData.entries.length;
                                   dayCounts[dayIndex] += dayData.entries.length;
                               }
                          });
                      }
                 });
            }
        });

        const busiestDayIndex = dayCounts.indexOf(Math.max(...dayCounts));
        const busiestDay = totalCompletions > 0 ? WEEKDAY_NAMES_SHORT[busiestDayIndex] : '-';

        return { totalCompletions, busiestDay };
    }

    function renderYearlyHeatmap(container, year) {
        const completionsByDate = {};
        
        appState.goals.filter(g => !g.archived).forEach(goal => {
            if(goal.history) {
                for(const weekId in goal.history) {
                    const weekStartDate = new Date(weekId.replace(/-/g, '/'));
                    goal.history[weekId].forEach((dayData, dayIndex) => {
                        if (dayData && dayData.entries.length > 0) {
                            const date = new Date(weekStartDate);
                            date.setDate(date.getDate() + dayIndex);
                            if (date.getFullYear() === year) {
                                const dateStr = `${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`;
                                completionsByDate[dateStr] = (completionsByDate[dateStr] || 0) + dayData.entries.length;
                            }
                        }
                    });
                }
            }
        });

        const maxCompletions = Math.max(1, ...Object.values(completionsByDate));
        const getColor = (count) => {
            if (!count || count === 0) return 'bg-slate-200 dark:bg-slate-700/80';
            const intensity = Math.min(count / (maxCompletions * 0.6 + 1), 1);
            if (intensity < 0.25) return 'bg-emerald-200 dark:bg-emerald-900';
            if (intensity < 0.5) return 'bg-emerald-400 dark:bg-emerald-700';
            if (intensity < 0.75) return 'bg-emerald-600 dark:bg-emerald-500';
            return 'bg-emerald-800 dark:bg-emerald-300';
        };

        let html = `<h3 class="font-bold mb-4 text-center">Activity Map for ${year}</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-6">`;

        for (let month = 0; month < 12; month++) {
            const firstDateOfMonth = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startOffset = firstDateOfMonth.getDay(); // 0 = Sunday

            let monthHtml = `<div class="p-3 bg-slate-100 dark:bg-slate-900/50 rounded-lg">
                <h4 class="font-semibold text-center text-sm mb-2">${GREGORIAN_MONTH_NAMES[month]}</h4>
                <div class="grid grid-cols-7 gap-1 text-center text-[10px] text-slate-400 mb-1.5">
                   ${WEEKDAY_NAMES_SHORT.map(d => `<div>${d.slice(0,1)}</div>`).join('')}
                </div>
                <div class="grid grid-cols-7 gap-1.5">`;

            for (let i = 0; i < startOffset; i++) { monthHtml += '<div></div>'; }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${month}-${day}`;
                const count = completionsByDate[dateStr] || 0;
                const gDate = new Date(year, month, day);
                const colorClass = getColor(count);
                const todayClass = isToday(gDate) ? 'ring-2 ring-sky-500' : '';
                const title = `${GREGORIAN_MONTH_NAMES[month]} ${day}, ${year}: ${count} ${count === 1 ? 'item' : 'items'}`;
                monthHtml += `<div onclick="showDailySummaryModal(${year}, ${month}, ${day})" class="${colorClass} ${todayClass} heatmap-day text-slate-800 dark:text-slate-200 font-bold" title="${title}">${day}</div>`;
            }
            monthHtml += `</div></div>`;
            html += monthHtml;
        }

        html += `</div>`;
        container.innerHTML = html;
    }

    function showDailySummaryModal(year, month, day) {
        const gDate = new Date(year, month, day);
        const formattedDate = gDate.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-[101] flex items-center justify-center p-4';

        let completedGoalsHtml = '';
        let totalPlanned = 0;
        let totalCompletedCount = 0;
        const activeGoals = appState.goals.filter(g => !g.archived);
        const dayIndexForCheck = gDate.getDay();

        activeGoals.forEach(goal => {
            if (goal.days[dayIndexForCheck]) {
                totalPlanned++;
                const entryCount = getEntryCountOnDate(goal, gDate);
                if (entryCount > 0) {
                    totalCompletedCount++;
                    completedGoalsHtml += `
                        <div class="flex items-center justify-between p-3 bg-white dark:bg-slate-700/50 rounded-lg">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">${goal.emoji}</span>
                                <span class="font-semibold">${escapeHtml(goal.name)}</span>
                            </div>
                            <span class="font-bold text-indigo-500">${entryCount} ${entryCount > 1 ? 'times' : 'time'}</span>
                        </div>`;
                }
            }
        });

        const successRate = totalPlanned > 0 ? Math.round((totalCompletedCount / totalPlanned) * 100) : 0;
        const statsHtml = `
            <div class="mb-4">
                <h4 class="font-semibold text-sm mb-2 text-slate-600 dark:text-slate-300">Day Stats</h4>
                <div class="grid grid-cols-3 gap-2 text-center">
                    <div class="bg-slate-200 dark:bg-slate-700 p-2 rounded-lg">
                        <div class="text-xl font-bold text-green-600 dark:text-green-400">${totalCompletedCount}</div>
                        <div class="text-xs text-slate-500 dark:text-slate-400">Done</div>
                    </div>
                    <div class="bg-slate-200 dark:bg-slate-700 p-2 rounded-lg">
                        <div class="text-xl font-bold text-slate-700 dark:text-slate-200">${totalPlanned}</div>
                        <div class="text-xs text-slate-500 dark:text-slate-400">Planned</div>
                    </div>
                    <div class="bg-slate-200 dark:bg-slate-700 p-2 rounded-lg">
                        <div class="text-xl font-bold text-indigo-600 dark:text-indigo-400">${successRate}%</div>
                        <div class="text-xs text-slate-500 dark:text-slate-400">Success</div>
                    </div>
                </div>
            </div>`;

        if (completedGoalsHtml === '') {
            completedGoalsHtml = '<p class="text-center text-slate-500 dark:text-slate-400 py-4">No activities logged for this day.</p>';
        }

        modal.innerHTML = `
            <div class="modal-content glass-modal-content rounded-2xl p-5 w-full max-w-md shadow-2xl">
                <h3 class="font-bold text-lg text-indigo-600 dark:text-indigo-400 mb-1">Day Summary</h3>
                <p class="text-sm text-slate-500 dark:text-slate-400 font-semibold mb-4">${formattedDate}</p>
                ${statsHtml}
                <h4 class="font-semibold text-sm mb-2 mt-4 text-slate-600 dark:text-slate-300">Completed Habits</h4>
                <div class="space-y-2 max-h-52 overflow-y-auto no-scrollbar">${completedGoalsHtml}</div>
                <button class="close-modal-btn w-full mt-6 p-3 rounded-lg font-bold bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 transition">Close</button>
            </div>`;

        document.getElementById('modalArea').appendChild(modal);
        modal.onclick = e => { if (e.target === modal || e.target.closest('.close-modal-btn')) closeModal(); };
    }

    // --- HELPER for instant UI update ---
    function updateGoalCardStats(goalId) {
        const goal = appState.goals.find(g => g.id === goalId);
        if (!goal) return;
        const card = document.querySelector(`.goal-card[data-id="${goalId}"]`);
        if (!card) return;

        const { weekly } = calculateScores(goal);
        const categoryClasses = CATEGORIES[goal.category] || 'bg-slate-100 text-slate-800';
        
        const statsContainer = card.querySelector('.flex.items-center.gap-x-3');
        if (statsContainer) {
            statsContainer.innerHTML = `
                <span class="text-xs font-semibold px-3 py-1 rounded-full ${categoryClasses}">${goal.category}</span>
                <div class="flex items-center gap-1">
                    <span class="weekly-score">Week: ${weekly}</span>
                </div>
            `;
        }
    }

    // --- ACTIONS & LISTENERS ---
    window.editGoal = (goalId) => { const goal = appState.goals.find(g => g.id === goalId); if(goal) showGoalModal(goal); };
    window.startEdit = (goalId) => { appState.editing = goalId; fullRender(); };
    document.getElementById('navbar').onclick = e => {
        if (e.target.closest('#prevWeekBtn')) {
            appState.currentWeek.setDate(appState.currentWeek.getDate() - 7); fullRender();
        } else if (e.target.closest('#nextWeekBtn')) {
            appState.currentWeek.setDate(appState.currentWeek.getDate() + 7); fullRender();
        } else if (e.target.closest('#settingsMenuBtn')) {
             toggleSettingsMenu(!document.getElementById('settingsMenu').classList.contains('visible'));
        }
    };
    document.getElementById('settingsMenu').addEventListener('click', e => {
        if (e.target.closest('#reportBtn')) {
            showReportModal();
        } else if (e.target.closest('#archiveToggleBtn')) {
            appState.showArchived = !appState.showArchived;
            document.getElementById('archiveToggleBtn').classList.toggle('text-indigo-500', appState.showArchived);
            fullRender();
        } else if (e.target.closest('#darkModeBtn')) {
            const transition = { 'dark': 'light', 'light': 'auto', 'auto': 'dark' };
            let newTheme = transition[appState.theme];
            if (appState.theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches && newTheme === 'dark') {
                newTheme = transition[newTheme];
            }
            setTheme(newTheme);
        } else if (e.target.closest('#aboutBtn')) {
            showAboutModal();
        } else if (e.target.closest('#backupBtn')) {
            showBackupModal();
        }
        toggleSettingsMenu(false);
    });
    document.getElementById('fab').onclick = () => showGoalModal(null);

    document.getElementById('categoryFilters').onclick = (e) => {
        const button = e.target.closest('button');
        if(button) {
            appState.activeCategory = button.dataset.category;
            renderCategoryFilters();
            renderGoals(); 
            initSortable();
            setupCellListeners();
        }
    };

    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applyTheme);
    let sortable = null;
    loadStateFromStorage();
    fullRender();

    // --- Core Functions ---
    function initEditInput(goalId) {
        const el = document.getElementById('edit-' + goalId);
        if (!el) return;
        el.focus();
        el.select();
        const saveAndExit = () => {
            if (appState.editing !== goalId) return;
            const goal = appState.goals.find(g => g.id === goalId);
            if (goal) goal.name = el.value.trim() || 'Untitled';
            persistState();
            appState.editing = null;
            fullRender();
        };
        el.onblur = saveAndExit;
        el.onkeydown = (e) => { if (e.key === "Enter") el.blur(); if (e.key === "Escape") { appState.editing = null; fullRender(); } };
    }
    window.duplicateGoal = (goalId) => {
        const originalGoal = appState.goals.find(g => g.id === goalId);
        if (originalGoal) {
            const newGoal = JSON.parse(JSON.stringify(originalGoal));
            newGoal.id = '' + Date.now();
            newGoal.name = `${originalGoal.name} (Copy)`;
            newGoal.history = {};
            newGoal.archived = false;
            appState.goals.push(newGoal);
            const originalIndex = appState.order.indexOf(goalId);
            appState.order.splice(originalIndex + 1, 0, newGoal.id);
            persistState();
            fullRender();
        }
    };
    window.toggleArchiveGoal = (goalId) => {
        const goal = appState.goals.find(g => g.id === goalId);
        if (goal) { goal.archived = !goal.archived; persistState(); fullRender(); }
    };
    window.deleteGoal = (goalId) => {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4';
        modal.innerHTML = `
            <div class="modal-content bg-slate-50 dark:bg-slate-800 rounded-2xl p-5 w-full max-w-sm shadow-2xl text-center">
                <h3 class="font-bold text-lg mb-2">Confirm Deletion</h3>
                <p class="text-sm text-slate-600 dark:text-slate-300 mb-6">Are you sure you want to delete this goal? This action is irreversible.</p>
                <div class="grid grid-cols-2 gap-4">
                    <button id="cancel-delete" class="p-3 rounded-lg font-bold bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 transition">Cancel</button>
                    <button id="confirm-delete" class="p-3 rounded-lg font-bold bg-red-500 text-white hover:bg-red-600 transition">Delete</button>
                </div>
            </div>`;
        document.getElementById('modalArea').appendChild(modal);
        modal.querySelector('#cancel-delete').onclick = closeModal;
        modal.querySelector('#confirm-delete').onclick = () => {
            closeModal();
            const card = document.querySelector(`.goal-card[data-id="${goalId}"]`);
            if (card) {
                card.classList.add('goal-anim-out');
                setTimeout(() => {
                    appState.goals = appState.goals.filter(g => g.id !== goalId);
                    appState.order = appState.order.filter(id => id !== goalId);
                    persistState();
                    fullRender();
                }, 300);
            } else {
                appState.goals = appState.goals.filter(g => g.id !== goalId);
                appState.order = appState.order.filter(id => id !== goalId);
                persistState();
                fullRender();
            }
        };
    };
    function addCheckmark(goalId, dayIndex, cellElement) {
        const goal = appState.goals.find(g => g.id === goalId);
        if (!goal || !goal.days[dayIndex]) return;
        const weekId = weekIdForDate(appState.currentWeek);
        if (!goal.history) goal.history = {};
        if (!goal.history[weekId]) goal.history[weekId] = Array(7).fill(null).map(() => ({ entries: [], note: '' }));
        if (!goal.history[weekId][dayIndex]) goal.history[weekId][dayIndex] = { entries: [], note: '' };
        
        goal.history[weekId][dayIndex].entries.push('✅');
        persistState();
        
        const dayData = goal.history[weekId][dayIndex];
        cellElement.querySelector('div').innerHTML = dayData.entries.map(em => em ? `<span class="text-sm md:text-base">${escapeHtml(em)}</span>` : '').join('');
        cellElement.classList.add('day-completed');
        cellElement.classList.add('cell-swipe-up');
        cellElement.addEventListener('animationend', () => cellElement.classList.remove('cell-swipe-up'), { once: true });
        
        updateGoalCardStats(goalId);
        renderTotals();
    }
    function removeLastEmoji(goalId, dayIndex, cellElement) {
        const goal = appState.goals.find(g => g.id === goalId);
        if (!goal || !goal.days[dayIndex]) return;
        const weekId = weekIdForDate(appState.currentWeek);
        if (!goal.history?.[weekId]?.[dayIndex]?.entries.length > 0) return;
        
        goal.history[weekId][dayIndex].entries.pop();
        persistState();

        const dayData = goal.history[weekId][dayIndex];
        cellElement.querySelector('div').innerHTML = dayData.entries.map(em => em ? `<span class="text-sm md:text-base">${escapeHtml(em)}</span>` : '').join('');
        if (dayData.entries.length === 0) {
            cellElement.classList.remove('day-completed');
        }
        cellElement.classList.add('cell-swipe-down');
        cellElement.addEventListener('animationend', () => cellElement.classList.remove('cell-swipe-down'), { once: true });

        updateGoalCardStats(goalId);
        renderTotals();
    }
    function setupCellListeners() {
        document.querySelectorAll('.goal-day').forEach(cell => {
            let pressTimer = null;
            let longPressTriggered = false;
            let startY = 0, startX = 0;
            let isDragging = false;
            let swipeTriggered = false;
            let hasMoved = false;
            const handlePressStart = (e) => {
                if (cell.classList.contains('!cursor-not-allowed')) return;
                startY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
                startX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
                isDragging = true;
                swipeTriggered = false;
                longPressTriggered = false;
                hasMoved = false;
                pressTimer = setTimeout(() => {
                    longPressTriggered = true;
                    isDragging = false;
                    const { goalId, dayIndex } = cell.dataset;
                    showDayDetailModal(goalId, parseInt(dayIndex));
                    cleanupListeners();
                }, 500);
                document.addEventListener('mousemove', handlePressMove);
                document.addEventListener('touchmove', handlePressMove, { passive: false });
                document.addEventListener('mouseup', handlePressEnd, { once: true });
                document.addEventListener('touchend', handlePressEnd, { once: true });
            };
            const handlePressMove = (e) => {
                if (!isDragging || longPressTriggered || swipeTriggered) return;
                const currentY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
                const currentX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
                const deltaY = currentY - startY;
                const deltaX = currentX - startX;
                const SWIPE_THRESHOLD = 30;
                if (Math.abs(deltaY) > 10 || Math.abs(deltaX) > 10) {
                    hasMoved = true;
                    clearTimeout(pressTimer);
                    if (Math.abs(deltaY) > Math.abs(deltaX)) {
                        e.preventDefault();
                    }
                }
                if (Math.abs(deltaY) > SWIPE_THRESHOLD && Math.abs(deltaY) > Math.abs(deltaX)) {
                    swipeTriggered = true;
                    const { goalId, dayIndex } = cell.dataset;
                    if (deltaY < 0) {
                        addCheckmark(goalId, parseInt(dayIndex), cell);
                    } else {
                        removeLastEmoji(goalId, parseInt(dayIndex), cell);
                    }
                    cleanupListeners();
                }
            };
            const handlePressEnd = () => {
                clearTimeout(pressTimer);
                if (isDragging && !longPressTriggered && !swipeTriggered && !hasMoved) {
                    const { goalId, dayIndex } = cell.dataset;
                    showLogModal(goalId, parseInt(dayIndex));
                }
                cleanupListeners();
            };
            const cleanupListeners = () => {
                isDragging = false;
                clearTimeout(pressTimer);
                document.removeEventListener('mousemove', handlePressMove);
                document.removeEventListener('touchmove', handlePressMove);
                document.removeEventListener('mouseup', handlePressEnd);
                document.removeEventListener('touchend', handlePressEnd);
            }
            cell.removeEventListener('mousedown', handlePressStart);
            cell.removeEventListener('touchstart', handlePressStart);
            cell.addEventListener('mousedown', handlePressStart);
            cell.addEventListener('touchstart', handlePressStart, { passive: false });
        });
    }
    function initSortable() {
        if (sortable) sortable.destroy();
        const list = document.getElementById('goalList');
        if(!list) return;
        sortable = Sortable.create(list, {
            handle: '.goal-handle',
            animation: 200,
            ghostClass: 'sortable-ghost',
            onEnd: (evt) => {
                appState.order = Array.from(evt.to.children).map(card => card.dataset.id);
                persistState();
            }
        });
    }
    showGoalModal = (goal) => {
        const isEdit = !!goal;
        const draft = isEdit ? JSON.parse(JSON.stringify(goal)) : { id: '' + Date.now(), name: '', emoji: '🎯', days: Array(7).fill(true), history: {}, type: 'binary', archived: false, category: 'Personal', creationDate: new Date().toISOString() };
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/30 backdrop-blur-sm z-[100] flex items-end justify-center';
        modal.innerHTML = `
            <div class="modal-content bg-slate-50 dark:bg-slate-900 rounded-t-2xl p-4 w-full max-w-lg pb-[calc(env(safe-area-inset-bottom)+1rem)] shadow-2xl">
                <h2 class="text-xl font-bold text-center mb-6 text-indigo-600 dark:text-indigo-400">${isEdit ? 'Edit Goal' : 'New Goal'}</h2>
                <div class="space-y-4">
                    <div class="flex gap-4">
                        <div class="flex-grow"><label for="goalName" class="font-semibold mb-2 block text-sm">Goal Name</label><input type="text" id="goalName" value="${escapeHtml(draft.name)}" placeholder="e.g., Daily Workout" class="w-full p-3 bg-white dark:bg-slate-800 rounded-lg border border-slate-300 dark:border-slate-600 focus:ring-2 focus:ring-indigo-500 outline-none transition"></div>
                        <div><label for="goalEmoji" class="font-semibold mb-2 block text-sm">Emoji</label><input type="text" id="goalEmoji" value="${draft.emoji}" maxlength="2" class="w-20 text-center p-3 bg-white dark:bg-slate-800 rounded-lg border border-slate-300 dark:border-slate-600 focus:ring-2 focus:ring-indigo-500 outline-none transition"></div>
                    </div>
                    <div><label class="font-semibold mb-2 block text-sm">Category</label><select id="goalCategory" class="w-full p-3 bg-white dark:bg-slate-800 rounded-lg border border-slate-300 dark:border-slate-600 focus:ring-2 focus:ring-indigo-500 outline-none transition">${Object.keys(CATEGORIES).map(cat => `<option value="${cat}" ${draft.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}</select></div>
                    <div><label class="font-semibold mb-2 block text-sm">Active Days</label><div class="grid grid-cols-7 gap-2 rounded-lg bg-slate-200 dark:bg-slate-800 p-1 weekday-toggle-row">${WEEKDAY_NAMES_SHORT.map((d, i) => `<div class="weekday-toggle text-center font-bold p-2 rounded-md cursor-pointer transition-colors ${draft.days[i] ? 'bg-indigo-500 text-white' : 'hover:bg-slate-300'}" data-day="${i}">${d}</div>`).join('')}</div></div>
                </div>
                <div class="grid grid-cols-2 gap-4 mt-8">
                    <button class="action-btn-cancel w-full p-4 rounded-lg font-bold bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 transition">Cancel</button>
                    <button id="saveGoalBtn" class="w-full p-4 rounded-lg font-bold bg-indigo-600 text-white hover:bg-indigo-700 transition">${isEdit ? 'Save' : 'Add'}</button>
                </div>
            </div>`;
        document.getElementById('modalArea').appendChild(modal);
        document.getElementById('goalName').focus();
        modal.onclick = e => { if (e.target === modal) closeModal(); };
        modal.querySelector('.action-btn-cancel').onclick = closeModal;
        modal.querySelectorAll('.weekday-toggle').forEach(toggle => {
            toggle.onclick = () => { const day = parseInt(toggle.dataset.day); draft.days[day] = !draft.days[day]; toggle.classList.toggle('bg-indigo-500'); toggle.classList.toggle('text-white'); };
        });
        modal.querySelector('#saveGoalBtn').onclick = () => {
            draft.name = modal.querySelector('#goalName').value.trim();
            draft.emoji = modal.querySelector('#goalEmoji').value;
            draft.category = modal.querySelector('#goalCategory').value;
            draft.type = 'binary';
            if (isEdit) { const index = appState.goals.findIndex(g => g.id === goal.id); if (index > -1) appState.goals[index] = draft; } else { appState.goals.push(draft); appState.order.push(draft.id); }
            persistState(); closeModal(); fullRender();
        };
    };
    showLogModal = (goalId, dayIndex) => {
        const goal = appState.goals.find(g => g.id === goalId);
        if (!goal || !goal.days[dayIndex]) return;
        const weekId = weekIdForDate(appState.currentWeek);
        if (!goal.history) goal.history = {};
        if (!goal.history[weekId]) goal.history[weekId] = Array(7).fill(null).map(() => ({ entries: [], note: '' }));
        if (!goal.history[weekId][dayIndex]) goal.history[weekId][dayIndex] = { entries: [], note: '' };
        const dayData = goal.history[weekId][dayIndex];
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/30 backdrop-blur-sm z-[100] flex items-end justify-center';
        const renderEntries = (container) => {
            const listHtml = dayData.entries.map((entry, i) => `<div class="flex items-center gap-1 bg-slate-200 dark:bg-slate-700 rounded-full px-3 py-1 text-sm"><span>${entry}</span><button data-index="${i}" class="delete-entry-btn text-red-500 hover:text-red-700">&times;</button></div>`).join('');
            container.innerHTML = listHtml || '<span class="text-slate-400">Nothing logged yet.</span>';
        };
        modal.innerHTML = `
            <div class="modal-content bg-slate-50 dark:bg-slate-900 rounded-t-2xl p-4 w-full max-w-lg pb-[calc(env(safe-area-inset-bottom)+1rem)] shadow-2xl">
                <h2 class="text-xl font-bold text-center mb-4 truncate">${goal.name}</h2>
                <div class="space-y-4">
                    <div><label class="font-semibold mb-2 block text-sm">Logged Entries Today</label><div id="entries-list" class="flex flex-wrap gap-2 min-h-[40px] bg-white dark:bg-slate-800 p-2 rounded-lg"></div></div>
                    <div><label class="font-semibold mb-2 block text-sm">Log an Emoji</label><div class="emoji-grid grid grid-cols-7 gap-2 text-3xl">${EMOJIS.map(em => `<button class="emoji-btn text-center rounded-lg p-2 hover:bg-slate-200 dark:hover:bg-slate-700 transition-transform hover:scale-125">${em}</button>`).join('')}</div></div>
                    <div><label for="note-input" class="font-semibold mb-2 block text-sm">Note</label><textarea id="note-input" class="w-full p-3 bg-white dark:bg-slate-800 rounded-lg border border-slate-300 dark:border-slate-600 focus:ring-2 focus:ring-indigo-500 outline-none transition" rows="2" placeholder="Today's note...">${escapeHtml(dayData.note)}</textarea></div>
                </div>
                <div class="mt-8"><button class="action-btn-done w-full p-4 rounded-lg font-bold bg-indigo-600 text-white hover:bg-indigo-700 transition">Done</button></div>
            </div>`;
        document.getElementById('modalArea').appendChild(modal);
        const entriesList = modal.querySelector('#entries-list');
        renderEntries(entriesList);
        const saveAndClose = () => {
            goal.history[weekId][dayIndex].note = modal.querySelector('#note-input').value;
            persistState();
            fullRender(); 
            closeModal();
        };
        modal.onclick = e => { if (e.target === modal) saveAndClose(); };
        modal.querySelector('.action-btn-done').onclick = saveAndClose;
        
        const updateData = () => {
            persistState();
            renderEntries(entriesList);
            updateGoalCardStats(goalId);
            renderTotals();
        };

        entriesList.addEventListener('click', e => {
            if (e.target.classList.contains('delete-entry-btn')) {
                const index = parseInt(e.target.dataset.index);
                dayData.entries.splice(index, 1);
                updateData();
            }
        });
        modal.querySelectorAll('.emoji-btn').forEach(btn => {
            btn.onclick = () => {
                dayData.entries.push(btn.innerText);
                updateData();
            };
        });
    }
    function showDayDetailModal(goalId, dayIndex) {
        const goal = appState.goals.find(g => g.id === goalId);
        if (!goal) return;
        const weekDates = getWeekDates(appState.currentWeek);
        const date = weekDates[dayIndex];
        const weekId = weekIdForDate(appState.currentWeek);
        const dayData = goal.history?.[weekId]?.[dayIndex] || { entries: [], note: '' };
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4';
        const formattedDate = date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
        const entriesHtml = dayData.entries.length > 0
            ? dayData.entries.map(entry => `<span class="text-2xl">${escapeHtml(entry)}</span>`).join('')
            : '<span class="text-sm text-slate-400">Nothing logged.</span>';
        const noteHtml = dayData.note
            ? `<p class="text-sm bg-amber-100 dark:bg-amber-900/50 p-3 rounded-lg">${escapeHtml(dayData.note)}</p>`
            : '<span class="text-sm text-slate-400">No note provided.</span>';
        modal.innerHTML = `
            <div class="modal-content bg-slate-50 dark:bg-slate-800 rounded-2xl p-5 w-full max-w-sm shadow-2xl">
                <h3 class="font-bold text-lg text-indigo-600 dark:text-indigo-400 mb-2">${escapeHtml(goal.name)}</h3>
                <p class="text-sm text-slate-500 dark:text-slate-400 font-semibold mb-4">${formattedDate}</p>
                <div class="space-y-4">
                    <div>
                        <h4 class="font-semibold text-sm mb-2">Logged Entries</h4>
                        <div class="flex flex-wrap gap-3 items-center min-h-[40px] bg-white dark:bg-slate-700/50 p-3 rounded-lg">${entriesHtml}</div>
                    </div>
                    <div>
                        <h4 class="font-semibold text-sm mb-2">Note</h4>
                        <div class="min-h-[40px]">${noteHtml}</div>
                    </div>
                </div>
                 <button class="close-modal-btn w-full mt-6 p-3 rounded-lg font-bold bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 transition">Close</button>
            </div>`;
        document.getElementById('modalArea').appendChild(modal);
        modal.onclick = e => { if (e.target === modal || e.target.closest('.close-modal-btn')) closeModal(); };
    }
    showContextMenu = (e, goalId) => {
        e.preventDefault(); e.stopPropagation();
        if (appState.contextMenuGoalId === goalId) {
            closeContextMenu();
            return;
        }
        closeContextMenu();
        const goal = appState.goals.find(g => g.id === goalId); if (!goal) return;
        const menu = document.getElementById('contextMenu');
        menu.innerHTML = `<button onclick="editGoal('${goalId}')" class="w-full text-left flex items-center gap-3 p-3 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg">✏️ <span>Edit</span></button><button onclick="duplicateGoal('${goalId}')" class="w-full text-left flex items-center gap-3 p-3 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg">🗂️ <span>Duplicate</span></button><button onclick="toggleArchiveGoal('${goalId}')" class="w-full text-left flex items-center gap-3 p-3 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg">${goal.archived ? '📂 <span>Unarchive</span>' : '🗄️ <span>Archive</span>'}</button><div class="my-1 h-px bg-slate-200 dark:bg-slate-700"></div><button onclick="deleteGoal('${goalId}')" class="w-full text-left flex items-center gap-3 p-3 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/40 rounded-lg">🗑️ <span>Delete</span></button>`;
        menu.style.display = 'block';
        const rect = menu.getBoundingClientRect();
        let left = e.clientX;
        let top = e.clientY;
        if (left + rect.width > window.innerWidth - 10) { left = window.innerWidth - rect.width - 10; }
        if (top + rect.height > window.innerHeight - 10) { top = window.innerHeight - rect.height - 10; }
        menu.style.left = `${left}px`;
        menu.style.top = `${top}px`;
        appState.contextMenuGoalId = goalId;
        setTimeout(() => document.addEventListener('click', closeContextMenu, { once: true }), 10);
    };
</script>
</body>
</html>