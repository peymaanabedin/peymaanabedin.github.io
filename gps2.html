<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>PinPoint — GPS Booker</title>

  <!-- iOS PWA helpers -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <style>
    :root{
      --bg:#0b1220;--panel:#0f1726;--panel-2:#121a2b;--muted:#8aa0bf;--text:#eef3ff;--accent:#38bdf8;--accent-2:#34d399;
      --danger:#ef4444;--border:#1f273a;--shadow:0 10px 30px rgba(0,0,0,.28);
      --radius:18px;--tap:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:linear-gradient(180deg,#0b1220 0%,#0b1220 60%,#0e1628 100%);
      color:var(--text);font:16px/1.45 -apple-system,system-ui,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
    }
    header{
      position:sticky;top:0;z-index:15;background:rgba(11,18,32,.7);backdrop-filter:blur(10px);
      border-bottom:1px solid var(--border);
    }
    .wrap{max-width:900px;margin:0 auto;padding:14px 16px}
    .title{display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand svg{filter:drop-shadow(0 2px 10px rgba(56,189,248,.35))}
    .badge{font-size:12px;color:var(--muted)}
    .spacer{flex:1}
    .icon-btn{appearance:none;background:#101a20;border:1px solid #223049;border-radius:14px;padding:10px;cursor:pointer}
    .icon-btn:active{transform:translateY(1px)}
    .card{
      background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);
      box-shadow:var(--shadow);padding:14px;
    }
    .grid{display:grid;gap:12px}
    .grid-2{display:grid;gap:16px}
    @media(min-width:720px){ .grid-2{grid-template-columns:1.15fr .85fr} }
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .pill{border-radius:999px;padding:8px 12px;font-size:13px;color:var(--muted);border:1px solid #273247;background:#0b1426}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
    input[type="text"],input[type="search"]{width:100%;padding:12px 14px;border-radius:14px;border:1px solid #223049;background:#0f1726;color:var(--text)}
    .btn{appearance:none;border:0;border-radius:14px;padding:12px 14px;font-weight:700;display:inline-flex;align-items:center;gap:8px;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .primary{background:linear-gradient(180deg,#3cc8ff,#18a8e6);color:#011423;border:none}
    .success{background:linear-gradient(180deg,#43e6a1,#2cc38b);color:#02150c;border:none}
    .danger{background:linear-gradient(180deg,#ff6b6b,#ef4444);color:white;border:none}
    .ghost{background:#101a20;border:1px dashed #2a3a59;color:var(--muted)}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .progress{height:4px;background:#0f1726;border-radius:999px;overflow:hidden}
    .progress>i{display:block;height:100%;width:0;background:linear-gradient(90deg,#3cc8ff,#34d399)}
    .empty{border:1px dashed #2a3a59;border-radius:14px;padding:16px;text-align:center;color:var(--muted)}
    .loc-line{display:flex;align-items:center;gap:10px;justify-content:space-between;padding:12px;border-radius:14px;border:1px solid #223049;background:linear-gradient(180deg,#0e1626,#0b1423)}
    .loc-meta{display:flex;flex-direction:column;gap:4px;min-width:0}
    .loc-name{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .loc-sub{font-size:12px;color:var(--muted)}
    .loc-actions{display:flex;gap:8px;flex-wrap:wrap}
    .footer-space{height:68px}
    .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#101a2b;border:1px solid #223049;padding:10px 14px;border-radius:12px;color:var(--text);box-shadow:0 8px 20px rgba(0,0,0,.3);opacity:0;pointer-events:none;transition:.25s;z-index:50}
    .toast.show{opacity:1;pointer-events:auto;bottom:28px}

    /* Modal */
    dialog{width:min(560px,92vw);border:1px solid #223049;background:#0f1726;color:var(--text);border-radius:18px;padding:0;box-shadow:var(--shadow)}
    dialog::backdrop{background:rgba(0,0,0,.55)}
    .modal-head{padding:14px 16px;border-bottom:1px solid #203047;display:flex;align-items:center;gap:10px}
    .modal-body{padding:14px 16px;display:grid;gap:12px}
    .modal-actions{padding:12px 16px;border-top:1px solid #203047;display:flex;gap:8px;justify-content:flex-end}
    .help{font-size:12px;color:var(--muted)}
    label{font-size:13px;color:var(--muted)}
    .kv{display:grid;gap:8px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">
        <div class="brand">
          <!-- App icon -->
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 2v5m0 10v5M2 12h5m10 0h5M5 5l3.5 3.5M15.5 15.5 19 19M5 19l3.5-3.5M15.5 8.5 19 5" stroke="#38bdf8" stroke-width="1.6" stroke-linecap="round"/>
          </svg>
          <div>
            <div style="font-size:18px;font-weight:900;letter-spacing:.2px">PinPoint</div>
            <div class="badge">GPS Bookmark • Offline • Share</div>
          </div>
        </div>
        <div class="spacer"></div>
        <button id="installBtn" class="icon-btn" hidden title="Install">
          <!-- download icon -->
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 3v10m0 0 4-4m-4 4-4-4M5 21h14" stroke="#9cc7ff" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <button id="a2hsHint" class="icon-btn" hidden title="iOS Add to Home Screen">
          <!-- share box -->
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 3v9m0-9 3 3m-3-3-3 3M6 12v7a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-7" stroke="#9cc7ff" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <button id="settingsBtn" class="icon-btn" title="Settings">
          <!-- settings -->
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" stroke="#9cc7ff" stroke-width="1.7"/>
            <path d="M19.4 15a1 1 0 0 0 .2 1.1l.1.1a1.6 1.6 0 0 1-2.3 2.3l-.1-.1a1 1 0 0 0-1.1-.2 1 1 0 0 0-.6.9v.2a1.6 1.6 0 0 1-3.2 0v-.2a1 1 0 0 0-.6-.9 1 1 0 0 0-1.1.2l-.1.1a1.6 1.6 0 0 1-2.3-2.3l.1-.1a1 1 0 0 0 .2-1.1 1 1 0 0 0-.9-.6h-.2a1.6 1.6 0 0 1 0-3.2h.2a1 1 0 0 0 .9-.6 1 1 0 0 0-.2-1.1l-.1-.1a1.6 1.6 0 0 1 2.3-2.3l.1.1a1 1 0 0 0 1.1.2 1 1 0 0 0 .6-.9v-.2a1.6 1.6 0 0 1 3.2 0v.2a1 1 0 0 0 .6.9 1 1 0 0 0 1.1-.2l.1-.1a1.6 1.6 0 0 1 2.3 2.3l-.1.1a1 1 0 0 0-.2 1.1 1 1 0 0 0 .9.6h.2a1.6 1.6 0 0 1 0 3.2h-.2a1 1 0 0 0-.9.6Z" stroke="#9cc7ff" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <main class="wrap grid-2" style="padding-top:14px;padding-bottom:18px">
    <!-- live location -->
    <section class="card grid">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
        <h2 style="margin:0;font-size:16px;display:flex;align-items:center;gap:8px">
          <!-- crosshair icon -->
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 3v3m0 12v3M3 12h3m12 0h3M7 12a5 5 0 1 0 10 0 5 5 0 0 0-10 0Z" stroke="#38bdf8" stroke-width="1.6" stroke-linecap="round"/></svg>
          Current Location
        </h2>
        <span id="permStatus" class="pill">Permission: <b>unknown</b></span>
      </div>

      <div class="progress"><i id="progBar"></i></div>

      <div class="toolbar">
        <button id="locateBtn" class="btn primary">
          <!-- crosshair -->
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 3v3m0 12v3M3 12h3m12 0h3M7 12a5 5 0 1 0 10 0 5 5 0 0 0-10 0Z" stroke="#02121f" stroke-width="1.6" stroke-linecap="round"/></svg>
          Get Precise
        </button>
        <button id="saveBtn" class="btn success" disabled>
          <!-- star -->
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="m12 3 2.6 5.3 5.9.9-4.3 4.2 1 5.9L12 17l-5.2 2.3 1-5.9L3.5 9.2l5.9-.9L12 3Z" stroke="#02150c" stroke-width="1.4" stroke-linejoin="round"/></svg>
          Save
        </button>
        <button id="shareBtn" class="btn ghost" disabled>
          <!-- share -->
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 3v9m0-9 3 3m-3-3-3 3M6 12v7a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-7" stroke="#9cc7ff" stroke-width="1.6" stroke-linecap="round"/></svg>
          Share
        </button>
        <button id="copyBtn" class="btn ghost" disabled>
          <!-- copy -->
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M9 9h8a2 2 0 0 1 2 2v8M5 5h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2Z" stroke="#9cc7ff" stroke-width="1.6" stroke-linecap="round"/></svg>
          Copy
        </button>
      </div>

      <div class="grid" style="gap:8px">
        <div class="row">
          <div class="pill mono" id="latBox">lat: –</div>
          <div class="pill mono" id="lngBox">lng: –</div>
          <div class="pill" id="accBox">accuracy: –</div>
        </div>
        <div class="hint muted" id="tsBox">—</div>
        <div class="toolbar">
          <button id="openApple" class="btn" disabled>
            <!-- apple maps-ish pin -->
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 21s7-6.1 7-11.1A7 7 0 1 0 5 9.9C5 14.9 12 21 12 21Z" stroke="#cfd9ff" stroke-width="1.6" stroke-linejoin="round"/><circle cx="12" cy="9.9" r="2.4" stroke="#cfd9ff" stroke-width="1.4"/></svg>
            Apple Maps
          </button>
          <button id="openGoogle" class="btn" disabled>
            <!-- google maps-ish -->
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 21s7-6.1 7-11.1A7 7 0 1 0 5 9.9C5 14.9 12 21 12 21Z" stroke="#9cc7ff" stroke-width="1.6" stroke-linejoin="round"/></svg>
            Google Maps
          </button>
          <button id="openWaze" class="btn" disabled>
            <!-- car -->
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M5 15h14l-2-6a2 2 0 0 0-1.9-1.3H8.9A2 2 0 0 0 7 9l-2 6Zm0 0v2a1 1 0 0 0 1 1h1m12-3v2a1 1 0 0 1-1 1h-1M8 18h0m8 0h0" stroke="#c1e7ff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
            Waze
          </button>
          <button id="openCustom" class="btn" disabled>
            <!-- external -->
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M14 5h5v5M10 14 19 5M5 10v9a2 2 0 0 0 2 2h9" stroke="#b8f3e0" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
            Other App
          </button>
        </div>
      </div>
    </section>

    <!-- saved list -->
    <section class="card grid">
      <div class="row" style="justify-content:space-between">
        <h2 style="margin:0;font-size:16px;display:flex;align-items:center;gap:8px">
          <!-- bookmark -->
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M7 4h10v16l-5-3-5 3V4Z" stroke="#38bdf8" stroke-width="1.6" stroke-linejoin="round"/></svg>
          Saved Places
        </h2>
        <input id="searchBox" type="search" placeholder="Search by name…" aria-label="Search saved places" />
      </div>

      <div id="listArea" class="grid" style="gap:10px">
        <div class="empty">
          No places yet. Grab your GPS and tap <b>Save</b>.
        </div>
      </div>

      <div class="toolbar" style="justify-content:space-between">
        <div class="toolbar">
          <button id="exportBtn" class="btn ghost">
            <!-- download -->
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 3v10m0 0 4-4m-4 4-4-4M5 21h14" stroke="#9cc7ff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
            Export
          </button>
          <input id="importFile" type="file" accept="application/json" hidden />
          <button id="importBtn" class="btn ghost">
            <!-- upload -->
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 21V11m0 0-4 4m4-4 4 4M5 3h14" stroke="#9cc7ff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
            Import
          </button>
        </div>
        <button id="clearAllBtn" class="btn danger">
          <!-- trash -->
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 7h16M9 7V5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2m-9 0 1 12a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2l1-12" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Clear All
        </button>
      </div>
    </section>
  </main>

  <div class="footer-space"></div>
  <div id="toast" class="toast" role="status" aria-live="polite">Done</div>

  <!-- Settings Modal -->
  <dialog id="settingsModal">
    <div class="modal-head">
      <!-- settings icon -->
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="margin-right:6px">
        <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" stroke="#9cc7ff" stroke-width="1.7"/>
        <path d="M19.4 15a1 1 0 0 0 .2 1.1l.1.1a1.6 1.6 0 0 1-2.3 2.3l-.1-.1a1 1 0 0 0-1.1-.2 1 1 0 0 0-.6.9v.2a1.6 1.6 0 0 1-3.2 0v-.2a1 1 0 0 0-.6-.9 1 1 0 0 0-1.1.2l-.1.1a1.6 1.6 0 0 1-2.3-2.3l.1-.1a1 1 0 0 0 .2-1.1 1 1 0 0 0-.9-.6h-.2a1.6 1.6 0 0 1 0-3.2h.2a1 1 0 0 0 .9-.6 1 1 0 0 0-.2-1.1l-.1-.1a1.6 1.6 0 0 1 2.3-2.3l.1.1a1 1 0 0 0 1.1.2 1 1 0 0 0 .6-.9v-.2a1.6 1.6 0 0 1 3.2 0v.2a1 1 0 0 0 .6.9 1 1 0 0 0 1.1-.2l.1-.1a1.6 1.6 0 0 1 2.3 2.3l-.1.1a1 1 0 0 0-.2 1.1 1 1 0 0 0 .9.6h.2a1.6 1.6 0 0 1 0 3.2h-.2a1 1 0 0 0-.9.6Z" stroke="#9cc7ff" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <strong>Settings</strong>
      <div class="spacer"></div>
      <button id="closeSettings" class="icon-btn" title="Close">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6 6 18" stroke="#9cc7ff" stroke-width="1.7" stroke-linecap="round"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="kv">
        <label for="customName">Custom app name</label>
        <input id="customName" type="text" placeholder="e.g., My GIS App" />
      </div>
      <div class="kv">
        <label for="customTpl">Custom URL template</label>
        <input id="customTpl" type="text" placeholder="myapp://open?lat={lat}&lng={lng}&name={name}" />
        <div class="help">Use placeholders: <code>{lat}</code>, <code>{lng}</code>, <code>{name}</code>. Example: <code>waze://?ll={lat},{lng}&navigate=yes</code></div>
      </div>
      <div class="kv">
        <label for="shareTitle">Share title (optional)</label>
        <input id="shareTitle" type="text" placeholder="PinPoint Location" />
      </div>
      <div class="help">Tip: Apple Maps link uses <code>https://maps.apple.com/?ll=lat,lng&amp;q=name</code>, Google Maps uses <code>https://maps.google.com/?q=lat,lng</code>.</div>
    </div>
    <div class="modal-actions">
      <button id="testCustom" class="btn ghost">Test Custom Link</button>
      <div class="spacer"></div>
      <button id="saveSettings" class="btn success">Save</button>
    </div>
  </dialog>

  <script>
    /* ---------- Manifest (runtime) ---------- */
    (function makeManifest(){
      const manifest = {
        name:"PinPoint — GPS Booker",
        short_name:"PinPoint",
        start_url:"./",
        display:"standalone",
        background_color:"#0b1220",
        theme_color:"#0b1220",
        icons:[
          {"src":"data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M12 2v5m0 10v5M2 12h5m10 0h5M5 5l3.5 3.5M15.5 15.5 19 19M5 19l3.5-3.5M15.5 8.5 19 5' stroke='%2338bdf8' stroke-width='1.6' stroke-linecap='round' fill='none'/></svg>","sizes":"192x192","type":"image/svg+xml","purpose":"any maskable"},
          {"src":"data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M12 2v5m0 10v5M2 12h5m10 0h5M5 5l3.5 3.5M15.5 15.5 19 19M5 19l3.5-3.5M15.5 8.5 19 5' stroke='%2338bdf8' stroke-width='1.6' stroke-linecap='round' fill='none'/></svg>","sizes":"512x512","type":"image/svg+xml","purpose":"any maskable"}
        ]
      };
      const blob = new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"});
      const url = URL.createObjectURL(blob);
      const link = document.createElement('link'); link.rel = 'manifest'; link.href = url; document.head.appendChild(link);
    })();

    /* ---------- Service Worker (offline) ---------- */
    (function makeSW(){
      if(!('serviceWorker' in navigator)) return;
      const swCode = `
        const CACHE='pinpoint-v2';
        const ASSETS=['./'];
        self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS)).then(self.skipWaiting()))});
        self.addEventListener('activate',e=>{e.waitUntil(self.clients.claim())});
        self.addEventListener('fetch',e=>{
          const req=e.request;
          e.respondWith(
            caches.match(req).then(c=>c||fetch(req).then(res=>{
              const copy=res.clone(); caches.open(CACHE).then(cache=>cache.put(req,copy)).catch(()=>{});
              return res;
            }).catch(()=>caches.match('./')))
          );
        });
      `;
      const blob = new Blob([swCode], {type:'text/javascript'});
      navigator.serviceWorker.register(URL.createObjectURL(blob));
    })();

    /* ---------- Elements ---------- */
    const installBtn = document.getElementById('installBtn');
    const a2hsHint = document.getElementById('a2hsHint');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsModal = document.getElementById('settingsModal');
    const closeSettings = document.getElementById('closeSettings');
    const saveSettings = document.getElementById('saveSettings');
    const testCustom = document.getElementById('testCustom');

    const customName = document.getElementById('customName');
    const customTpl = document.getElementById('customTpl');
    const shareTitle = document.getElementById('shareTitle');

    const latBox = document.getElementById('latBox');
    const lngBox = document.getElementById('lngBox');
    const accBox = document.getElementById('accBox');
    const tsBox  = document.getElementById('tsBox');
    const locateBtn = document.getElementById('locateBtn');
    const saveBtn = document.getElementById('saveBtn');
    const copyBtn = document.getElementById('copyBtn');
    const shareBtn = document.getElementById('shareBtn');
    const progBar = document.getElementById('progBar');
    const permStatus = document.getElementById('permStatus');

    const openApple = document.getElementById('openApple');
    const openGoogle = document.getElementById('openGoogle');
    const openWaze = document.getElementById('openWaze');
    const openCustom = document.getElementById('openCustom');

    const listArea = document.getElementById('listArea');
    const searchBox = document.getElementById('searchBox');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const importFile = document.getElementById('importFile');
    const clearAllBtn = document.getElementById('clearAllBtn');

    /* ---------- Helpers ---------- */
    function toast(msg){
      const el = document.getElementById('toast');
      el.textContent = msg; el.classList.add('show');
      setTimeout(()=>el.classList.remove('show'), 1800);
    }
    function formatTs(t){ return new Date(t).toLocaleString(); }
    function setProgress(p){ progBar.style.width = Math.max(0, Math.min(100, p)) + '%'; }
    const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

    /* ---------- Install prompts ---------- */
    let deferredPrompt=null;
    window.addEventListener('beforeinstallprompt', (e)=>{
      e.preventDefault(); deferredPrompt=e; installBtn.hidden=false;
    });
    installBtn?.addEventListener('click', async ()=>{
      if(!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt=null; installBtn.hidden=true;
    });
    if(isIOS && !isStandalone){
      a2hsHint.hidden=false;
      a2hsHint.addEventListener('click', ()=> toast('On iPhone: Share ▸ Add to Home Screen'));
    }

    /* ---------- Permissions ---------- */
    async function checkPerm(){
      if(!navigator.permissions || !navigator.geolocation){ permStatus.innerHTML='Permission: <b>unknown</b>'; return; }
      try{
        const st = await navigator.permissions.query({name:'geolocation'});
        const map = { 'granted':'<b style="color:#34d399">granted</b>', 'denied':'<b style="color:#ef4444">denied</b>', 'prompt':'<b>prompt</b>' };
        permStatus.innerHTML = 'Permission: ' + (map[st.state] || '<b>unknown</b>');
        st.onchange = ()=>{ permStatus.innerHTML = 'Permission: ' + (map[st.state] || '<b>unknown</b>'); };
      }catch{ permStatus.innerHTML='Permission: <b>unknown</b>'; }
    }
    checkPerm();

    /* ---------- Storage ---------- */
    const KEY='pinpoint.places.v1';
    const PREF='pinpoint.prefs.v1';
    function readPlaces(){ try{ return JSON.parse(localStorage.getItem(KEY)) || []; }catch{ return []; } }
    function writePlaces(arr){ localStorage.setItem(KEY, JSON.stringify(arr)); }
    function readPrefs(){
      const def = { customName:'', customTpl:'', shareTitle:'PinPoint Location' };
      try{ return {...def, ...(JSON.parse(localStorage.getItem(PREF))||{})}; }catch{ return def; }
    }
    function writePrefs(p){ localStorage.setItem(PREF, JSON.stringify(p)); }

    /* ---------- State ---------- */
    let current=null;
    function enableLiveButtons(on){
      [saveBtn, copyBtn, shareBtn, openApple, openGoogle, openWaze, openCustom].forEach(b=>b.disabled=!on);
    }

    /* ---------- Geolocation ---------- */
    locateBtn.addEventListener('click', ()=>{
      if(!navigator.geolocation){ toast('Geolocation not supported'); return; }
      setProgress(10);
      navigator.geolocation.getCurrentPosition(onPos, onErr, {
        enableHighAccuracy:true, timeout:15000, maximumAge:0
      });
      let t=10, iv=setInterval(()=>{ t = Math.min(95,t+4); setProgress(t); }, 300);
      function onPos(pos){
        clearInterval(iv); setProgress(100);
        const { latitude, longitude, accuracy } = pos.coords;
        current = { lat: latitude, lng: longitude, acc: Math.round(accuracy), ts: Date.now(), name:'Current spot' };
        latBox.textContent = 'lat: ' + latitude.toFixed(6);
        lngBox.textContent = 'lng: ' + longitude.toFixed(6);
        accBox.textContent = 'accuracy: ±' + Math.round(accuracy) + ' m';
        tsBox.textContent = 'Timestamp: ' + formatTs(current.ts);
        enableLiveButtons(true);
        setTimeout(()=>setProgress(0), 500);
      }
      function onErr(err){
        clearInterval(iv); setProgress(0);
        toast(err.message || 'Location error');
      }
    });

    copyBtn.addEventListener('click', async ()=>{
      if(!current) return;
      const txt = `${current.lat},${current.lng} (±${current.acc}m @ ${new Date(current.ts).toISOString()})`;
      try{ await navigator.clipboard.writeText(txt); toast('Copied'); }catch{ toast('Copy failed'); }
    });

    shareBtn.addEventListener('click', async ()=>{
      if(!current) return;
      const prefs = readPrefs();
      const url = googleLink(current.lat,current.lng);
      const text = `${current.name||'Location'} — ${current.lat.toFixed(6)},${current.lng.toFixed(6)} (±${current.acc} m)`;
      if(navigator.share){
        try{
          await navigator.share({ title: prefs.shareTitle||'PinPoint Location', text, url });
        }catch(e){ /* user cancelled */ }
      }else{
        try{ await navigator.clipboard.writeText(`${text}\n${url}`); toast('Share copied to clipboard'); }catch{ toast('Share failed'); }
      }
    });

    saveBtn.addEventListener('click', ()=>{
      if(!current) return;
      const name = prompt('Name this place:', 'My Spot');
      if(name===null) return;
      const place = {
        id: crypto.randomUUID?.() || (Date.now()+'-'+Math.random().toString(16).slice(2)),
        name: (name || 'Unnamed').trim(),
        lat: +current.lat, lng: +current.lng, acc: +current.acc, ts: current.ts
      };
      const all = readPlaces(); all.unshift(place); writePlaces(all); renderList(); toast('Saved ⭐');
    });

    /* ---------- Map Links ---------- */
    function appleLink(lat,lng,name=''){
      const q = encodeURIComponent(name||`${lat.toFixed(6)},${lng.toFixed(6)}`);
      return `https://maps.apple.com/?ll=${lat},${lng}&q=${q}`;
    }
    function googleLink(lat,lng){ return `https://maps.google.com/?q=${lat},${lng}`; }
    function wazeLink(lat,lng){ return `https://waze.com/ul?ll=${lat},${lng}&navigate=yes`; }
    function customLink(lat,lng,name){
      const { customTpl } = readPrefs(); if(!customTpl) return '';
      const safeName = encodeURIComponent(name||'');
      return customTpl.replaceAll('{lat}', lat).replaceAll('{lng}', lng).replaceAll('{name}', safeName);
    }

    openApple.addEventListener('click', ()=>{ if(!current) return; window.open(appleLink(current.lat,current.lng,current.name),'_blank','noopener'); });
    openGoogle.addEventListener('click', ()=>{ if(!current) return; window.open(googleLink(current.lat,current.lng),'_blank','noopener'); });
    openWaze.addEventListener('click', ()=>{ if(!current) return; window.open(wazeLink(current.lat,current.lng),'_blank','noopener'); });
    openCustom.addEventListener('click', ()=>{ if(!current) return;
      const url = customLink(current.lat,current.lng,current.name);
      if(url){ window.location.href = url; } else { toast('Set a custom URL in Settings'); }
    });

    /* ---------- List rendering ---------- */
    function renderList(){
      const q = (searchBox.value||'').toLowerCase().trim();
      const items = readPlaces().filter(p=>!q || p.name.toLowerCase().includes(q));
      listArea.innerHTML = '';
      if(!items.length){
        const d = document.createElement('div'); d.className='empty'; d.innerHTML='No matches.';
        listArea.appendChild(d); return;
      }
      for(const p of items){
        const line = document.createElement('div'); line.className='loc-line';

        const meta = document.createElement('div'); meta.className='loc-meta';
        const name = document.createElement('div'); name.className='loc-name'; name.textContent=p.name;
        const sub  = document.createElement('div'); sub.className='loc-sub mono';
        sub.textContent = `${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}  •  ±${p.acc} m  •  ${formatTs(p.ts)}`;
        meta.append(name, sub);

        const actions = document.createElement('div'); actions.className='loc-actions';

        const mkBtn = (label, svgPath, handler, kind='')=>{
          const b=document.createElement('button'); b.className='btn '+kind;
          b.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="${svgPath}" stroke="#cfe6ff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>${label}`;
          b.addEventListener('click', handler); return b;
        };

        const openAppleBtn = mkBtn('Apple', 'M12 21s7-6.1 7-11.1A7 7 0 1 0 5 9.9C5 14.9 12 21 12 21Z', ()=>window.open(appleLink(p.lat,p.lng,p.name),'_blank','noopener'));
        const openGoogleBtn= mkBtn('Google', 'M12 21s7-6.1 7-11.1A7 7 0 1 0 5 9.9C5 14.9 12 21 12 21Z', ()=>window.open(googleLink(p.lat,p.lng),'_blank','noopener'));
        const wazeBtn     = mkBtn('Waze', 'M5 15h14l-2-6a2 2 0 0 0-1.9-1.3H8.9A2 2 0 0 0 7 9l-2 6Z', ()=>window.open(wazeLink(p.lat,p.lng),'_blank','noopener'));
        const shareBtn2   = mkBtn('Share', 'M12 3v9m0-9 3 3m-3-3-3 3M6 12v7a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-7', async ()=>{
          const prefs = readPrefs();
          const url = googleLink(p.lat,p.lng);
          const text = `${p.name} — ${p.lat.toFixed(6)},${p.lng.toFixed(6)} (±${p.acc} m)`;
          if(navigator.share){
            try{ await navigator.share({ title: prefs.shareTitle||'PinPoint Location', text, url }); }catch{}
          }else{
            try{ await navigator.clipboard.writeText(`${text}\n${url}`); toast('Share copied'); }catch{ toast('Share failed'); }
          }
        });
        const customBtn   = mkBtn('Other', 'M14 5h5v5M10 14 19 5M5 10v9a2 2 0 0 0 2 2h9', ()=>{
          const url = customLink(p.lat,p.lng,p.name);
          if(url){ window.location.href = url; } else { toast('Set a custom URL in Settings'); }
        });
        const renameBtn   = mkBtn('Rename', 'M4 20h4l10-10a2.8 2.8 0 0 0-4-4L4 16v4Z', ()=>{
          const nv = prompt('Rename:', p.name);
          if(nv===null) return; p.name = (nv||'Unnamed').trim(); update(p.id,p); renderList();
        }, 'ghost');
        const delBtn      = mkBtn('Delete', 'M4 7h16M9 7V5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2m-9 0 1 12a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2l1-12', ()=>{
          if(confirm('Delete this place?')){ remove(p.id); renderList(); toast('Deleted'); }
        }, 'danger');

        actions.append(openAppleBtn, openGoogleBtn, wazeBtn, shareBtn2, customBtn, renameBtn, delBtn);
        line.append(meta, actions);
        listArea.appendChild(line);
      }
    }

    function update(id, patch){
      const arr = readPlaces();
      const i = arr.findIndex(x=>x.id===id);
      if(i>-1){ arr[i] = {...arr[i], ...patch}; writePlaces(arr); }
    }
    function remove(id){
      const arr = readPlaces().filter(x=>x.id!==id); writePlaces(arr);
    }
    searchBox.addEventListener('input', renderList);

    /* ---------- Export / Import / Clear ---------- */
    exportBtn.addEventListener('click', ()=>{
      const data = JSON.stringify(readPlaces(), null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='pinpoint-places.json'; a.click();
      URL.revokeObjectURL(url);
    });
    importBtn.addEventListener('click', ()=> importFile.click());
    importFile.addEventListener('change', ()=>{
      const f = importFile.files[0]; if(!f) return;
      const fr = new FileReader();
      fr.onload = ()=>{
        try{
          const arr = JSON.parse(fr.result); if(!Array.isArray(arr)) throw new Error('Invalid file');
          const cur = readPlaces(); const map = new Map(cur.map(x=>[x.id,x]));
          for(const p of arr){ if(p && p.id){ map.set(p.id, {...map.get(p.id), ...p}); } }
          const merged = Array.from(map.values()).sort((a,b)=>b.ts-a.ts);
          writePlaces(merged); renderList(); toast('Imported');
        }catch(e){ toast('Import failed'); }
        importFile.value='';
      };
      fr.readAsText(f);
    });
    clearAllBtn.addEventListener('click', ()=>{
      if(confirm('Remove ALL saved places?')){ localStorage.removeItem(KEY); renderList(); toast('Cleared'); }
    });

    /* ---------- Settings ---------- */
    const prefsBoot = readPrefs();
    customName.value = prefsBoot.customName || '';
    customTpl.value = prefsBoot.customTpl || '';
    shareTitle.value = prefsBoot.shareTitle || 'PinPoint Location';

    settingsBtn.addEventListener('click', ()=> settingsModal.showModal());
    closeSettings.addEventListener('click', ()=> settingsModal.close());
    saveSettings.addEventListener('click', ()=>{
      writePrefs({ customName:customName.value.trim(), customTpl:customTpl.value.trim(), shareTitle:shareTitle.value.trim() });
      toast('Settings saved');
      settingsModal.close();
      enableLiveButtons(!!current); // refresh custom availability
    });
    testCustom.addEventListener('click', ()=>{
      const tpl = customTpl.value.trim();
      if(!tpl){ toast('Set a URL template first'); return; }
      const url = tpl.replaceAll('{lat}','35.6892').replaceAll('{lng}','51.3890').replaceAll('{name}', encodeURIComponent('Test Point'));
      window.location.href = url; // will open app if installed or show error/no-op
    });

    /* ---------- Initial render ---------- */
    function initButtons(){
      const hasCustom = !!(readPrefs().customTpl);
      openCustom.disabled = !hasCustom || !current;
    }
    renderList();
    initButtons();
    enableLiveButtons(false);
  </script>
</body>
</html>
