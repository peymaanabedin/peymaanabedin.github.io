<!DOCTYPE html>
<html lang="fa" dir="ltr" class="">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Rooza | Habit Tracker App</title>
    <meta name="description" content="Rooza (روزا) Personal Habit and Goal Tracker Application">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Rooza">
    <meta name="application-name" content="Rooza">
    <link rel="icon" type="image/png" href="https://i.postimg.cc/4xvMK8zQ/rooza-app-logo-final.png">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/4xvMK8zQ/rooza-app-logo-final.png">
    <link rel="apple-touch-icon" sizes="152x152" href="https://i.postimg.cc/4xvMK8zQ/rooza-app-logo-final.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://i.postimg.cc/4xvMK8zQ/rooza-app-logo-final.png">
    <link rel="apple-touch-icon" sizes="167x167" href="https://i.postimg.cc/4xvMK8zQ/rooza-app-logo-final.png">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style id="dynamic-theme-style"></style>
    <style>
           html, body {
            overscroll-behavior-y: contain;
        }
        body { font-family: 'Vazirmatn', sans-serif; background-color: var(--color-bg); color: var(--color-text);
     .sortable-ghost { opacity: 0.4; background-color: #cce7ff; }
    }

        .sortable-ghost { opacity: 0.4; background-color: #cce7ff; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .goal-anim-in { animation: goal-fade-in 0.4s ease-out forwards; }
        .goal-anim-out { animation: goal-fade-out 0.3s ease-in forwards; }
        @keyframes goal-fade-in { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes goal-fade-out { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        .cell-swipe-up { animation: cell-pop 0.2s ease-out forwards; }
        .cell-swipe-down { animation: cell-shrink 0.2s ease-out forwards; }
        @keyframes cell-pop { 0% { transform: scale(1); } 50% { transform: scale(1.15); background-color: hsla(120, 73%, 75%, 0.5); } 100% { transform: scale(1); } }
        @keyframes cell-shrink { 0% { transform: scale(1); } 50% { transform: scale(0.85); background-color: hsla(0, 100%, 80%, 0.5); } 100% { transform: scale(1); } }
        .stat-card { background-color: var(--color-card); padding: 1rem; border-radius: 0.75rem; text-align: center; box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); transition: all 0.2s; }
        .stat-card:hover { transform: scale(1.05); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--color-primary); margin-bottom: 0.25rem; }
        .stat-label { font-size: 0.75rem; color: var(--color-text-muted); font-weight: 600; }
        .report-tab-btn { background-color: var(--color-cell-inactive); color: var(--color-text); }
        .report-tab-btn.active { background-color: var(--color-primary); color: var(--color-primary-text); box-shadow: 0 4px 14px 0 var(--color-primary-shadow); }
        .heatmap-day { transition: background-color 0.2s; }
        .heatmap-count { background-color: #0ea5e9; color: white; }
        .glass-modal-content { background-color: var(--color-header); backdrop-filter: blur(16px); border: 1px solid var(--color-border); }
        #settingsMenu, #categoryMenu { display: none; }
        #settingsMenu.visible, #categoryMenu.visible { display: block; }
        /* .emoji-container { background-color: var(--color-cell-inactive); } */

        .shadow-sky-500\/30 {
  --tw-shadow-color: rgba(193, 193, 193, 0.72) !important;
  --tw-shadow: var(--tw-shadow-colored) !important;
}
.ring-2 {
  --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color) !important;
  --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color) !important;
  box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000) !important;
}
.ring-sky-500 {
  --tw-ring-opacity: 0.2 !important;
  --tw-ring-color: rgba(208, 208, 208, 0.32) !important
}
.emoji-in-cell-wrapper {
    position: relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}
.emoji-counter-badge {
    position: absolute;
    bottom: -2px;
    right: -4px;
    background-color: var(--color-primary);
    color: var(--color-primary-text);
    border-radius: 9999px;
    font-size: 9px;
    font-weight: 700;
    line-height: 1;
    min-width: 16px;
    height: 16px;
    padding: 0 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--color-card);
    transform-origin: bottom right;
    animation: badge-pop-in 0.3s ease-out forwards;
}
@keyframes badge-pop-in {
    0% { transform: scale(0.5); opacity: 0; }
    70% { transform: scale(1.15); opacity: 1; }
    100% { transform: scale(1); opacity: 1; }
}

/* --- Mobile Menu Redesign --- */
#mobileMenu {
    background-color: var(--color-header);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-left: 1px solid var(--color-border);
    box-shadow: -10px 0px 30px rgba(0, 0, 0, 0.1);
}

.mobile-menu-open #mainContent,
.mobile-menu-open #navbar,
.mobile-menu-open #fab {
    filter: blur(4px) brightness(0.8);
    transform: scale(0.98);
    transition: transform 0.4s ease, filter 0.4s ease;
}

body.mobile-menu-open {
    overflow: hidden;
}

.menu-item-fade-in {
    animation: menuItemFadeIn 0.5s ease-out forwards;
    opacity: 0;
}

@keyframes menuItemFadeIn {
    from {
        opacity: 0;
        transform: translateX(20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.menu-section-title {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-muted);
    padding: 0 1rem;
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
}

.mobile-menu-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    border-radius: 0.75rem;
    font-weight: 600;
    transition: background-color 0.2s, color 0.2s;
}
.mobile-menu-item:hover {
    background-color: var(--color-hover);
}
.mobile-menu-item.active {
    background-color: var(--color-primary);
    color: var(--color-primary-text);
    box-shadow: 0 4px 14px 0 var(--color-primary-shadow);
}
.mobile-menu-item .icon {
    width: 1.25rem;
    height: 1.25rem;
}

    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: 'var(--color-primary)',
                        'primary-text': 'var(--color-primary-text)',
                        'app-bg': 'var(--color-bg)',
                        'app-text': 'var(--color-text)',
                        'app-text-muted': 'var(--color-text-muted)',
                        'app-card': 'var(--color-card)',
                        'app-header': 'var(--color-header)',
                        'app-border': 'var(--color-border)',
                        'app-hover': 'var(--color-hover)',
                        'app-cell-inactive': 'var(--color-cell-inactive)',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-app-bg text-app-text antialiased">
    <div class="min-h-screen pt-[env(safe-area-inset-top)]">
       <header id="navbar" class="sticky top-0 z-50 bg-app-header backdrop-blur-lg flex items-center justify-between p-4 border-b border-app-border">
<div class="md:hidden flex items-center justify-between w-full">

    <button id="mobileReportsBtn" aria-label="گزارش‌ها" class="text-app-text-muted hover:bg-app-hover rounded-full p-2 transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
    </button>

    <div id="weekTitleMobile" class="text-base font-bold text-primary text-center truncate"></div>

    <button id="hamburgerBtn" aria-label="Open menu" class="text-app-text-muted hover:bg-app-hover rounded-full p-2 transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>

</div>

    <div class="hidden md:flex flex-1">
        <button id="todayBtn" class="text-sm text-app-text-muted font-semibold hover:text-primary transition-colors"></button>
    </div>
    <div class="hidden md:flex items-center gap-2">
        <button id="prevWeekBtn" aria-label="Previous Week" class="flex items-center gap-x-2 text-app-text-muted hover:bg-app-hover rounded-full px-3 py-2 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
            <span class="text-sm font-medium hidden sm:inline">هفته قبلی</span>
        </button>
        <div id="weekTitle" class="text-base md:text-lg font-bold text-primary w-40 text-center"></div>
        <button id="nextWeekBtn" aria-label="Next Week" class="flex items-center gap-x-2 text-app-text-muted hover:bg-app-hover rounded-full px-3 py-2 transition-colors">
            <span class="text-sm font-medium hidden sm:inline">هفته بعدی</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
        </button>
    </div>
    <div class="hidden md:flex flex-1 flex justify-end items-center">
        <div class="relative">
            <button id="categoryMenuBtn" aria-label="Categories" class="text-app-text-muted hover:bg-app-hover rounded-full p-2 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-5.414 5.414a1 1 0 00-.293.707V19l-4 2v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                </svg>
            </button>
            <div id="categoryMenu" class="absolute right-0 mt-2 w-56 origin-top-right bg-app-header backdrop-blur-lg shadow-2xl rounded-xl border border-app-border p-2 text-base z-[1001]"></div>
        </div>
        <div class="relative">
            <button id="settingsMenuBtn" aria-label="Settings" class="text-app-text-muted hover:bg-app-hover rounded-full p-2 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </button>
            <div id="settingsMenu" class="absolute right-0 mt-2 w-56 origin-top-right bg-app-header backdrop-blur-lg shadow-2xl rounded-xl border border-app-border p-2 text-base z-[1001]">
                </div>
        </div>
    </div>
    
</header>

<div id="mobileMenu" dir="rtl" class="fixed inset-0 transform translate-x-full transition-transform duration-300 ease-in-out z-[100] pt-[env(safe-area-inset-top)]">
    <div id="mobileMenuContent" class="h-full flex flex-col"></div>
</div>


        <main id="mainContent" class="max-w-4xl mx-auto p-4 pb-32">
            <div id="weekdayRow" class="grid grid-cols-7 gap-2 text-center my-6"></div>
            <div id="goalList" class="flex flex-col gap-4"></div>
            <div id="archivedGoalList" class="hidden">
                <h3 class="text-lg font-bold text-app-text-muted my-4 p-2 border-b-2 border-app-border">آرشیو شده‌ها</h3>
                <div class="flex flex-col gap-4"></div>
            </div>
        </main>
        <button id="fab" aria-label="افزودن هدف" class="fixed right-6 bottom-[calc(env(safe-area-inset-bottom)+1.5rem)] z-50 w-16 h-16 bg-primary text-primary-text rounded-full flex items-center justify-center text-3xl shadow-lg hover:opacity-90 active:scale-90 transition-all">＋</button>
    </div>
    <div id="modalArea"></div>
    <div id="contextMenu" class="fixed z-[1000] min-w-[180px] bg-app-header backdrop-blur-lg shadow-2xl rounded-xl border border-app-border p-2 text-base" style="display:none"></div>
<script>
    const checkmarkSVG = `<svg width="24" height="24" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"> <circle cx="16" cy="16" r="15" fill="url(#paint0_radial)" stroke="#4CAF50" stroke-width="2"></circle> <path d="M9 17.5L14 22L23 12.5" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"></path> <defs> <radialGradient id="paint0_radial" cx="0" cy="0" r="1" gradientTransform="translate(16 16) scale(16)"> <stop stop-color="#A5D6A7"></stop> <stop offset="1" stop-color="#4CAF50"></stop> </radialGradient> </defs></svg>`;
    // --- CONSTANTS & CONFIG ---
    const EMOJIS = [checkmarkSVG,'🎉','🔥','💪','🎯','👍','👎','❌','🤔','😴','🍔','💻','🧘','📖'];
    const CATEGORIES = {
        'ورزش': 'bg-sky-100 text-sky-800 dark:bg-sky-900/50 dark:text-sky-300',
        'کار': 'bg-amber-100 text-amber-800 dark:bg-amber-900/50 dark:text-amber-300',
        'شخصی': 'bg-violet-100 text-violet-800 dark:bg-violet-900/50 dark:text-violet-300',
        'سلامتی': 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300',
    };
    
const themesData = {
  modernDark: [
    { id: 'theme-cyberpunk', name: 'سایبرپانک', primary: '#f9f871', bg: '#0c0c27', text: '#a6fffa', isDark: true },
    { id: 'theme-vaporwave', name: 'ویپورویو', primary: '#ff77cc', bg: '#200c38', text: '#00e5e5', isDark: true },
    { id: 'theme-twilight', name: 'گرگ و میش', primary: '#ffc880', bg: '#1e1e3f', text: '#d4d4ff', isDark: true },
    { id: 'theme-matrix', name: 'ماتریکس', primary: '#00ff41', bg: '#0d0208', text: '#008f11', isDark: true },
    { id: 'theme-deep-space', name: 'اعماق فضا', primary: '#9d80ff', bg: '#00001a', text: '#f0f0ff', isDark: true },
    { id: 'theme-oled', name: 'OLED', primary: '#ff3385', bg: '#000000', text: '#e5e5e5', isDark: true },
    { id: 'theme-8bit-sunset', name: 'غروب ۸ بیتی', primary: '#f9d868', bg: '#34294b', text: '#f0e5ff', isDark: true },
    { id: 'theme-arcade', name: 'آرکید', primary: '#ffcc00', bg: '#1d1a33', text: '#eeebff', isDark: true },
    { id: 'theme-midnight-city', name: 'شهر نیمه‌شب', primary: '#f1fa8c', bg: '#191a21', text: '#e1e1e6', isDark: true },
    { id: 'theme-snes-dark', name: 'SNES', primary: '#aca8dd', bg: '#212121', text: '#e0e0e0', isDark: true },
    { id: 'theme-playstation-dark', name: 'پلی‌استیشن', primary: '#006fcd', bg: '#1f1f2e', text: '#f0f0f5', isDark: true },
    { id: 'theme-blade-runner-dark', name: 'بلیدرانر', primary: '#f05a28', bg: '#0a1128', text: '#00f6ff', isDark: true },
    { id: 'theme-dune-dark', name: 'تل‌ماسه', primary: '#e89f48', bg: '#2c221c', text: '#d5c8b8', isDark: true },
    { id: 'theme-ocean-dark', name: 'اقیانوس', primary: '#5efff5', bg: '#0b192f', text: '#ccd6f6', isDark: true },
    { id: 'theme-blood-moon', name: 'ماه خونین', primary: '#ff4d4d', bg: '#1a0000', text: '#ffcccc', isDark: true },
    { id: 'theme-nebula', name: 'سحابی', primary: '#d67ae9', bg: '#1d0f2b', text: '#e1d8f5', isDark: true },
    { id: 'theme-volcano', name: 'آتشفشان', primary: '#ff7a00', bg: '#1f120c', text: '#ffd8c9', isDark: true },
    { id: 'theme-aurora', name: 'شفق قطبی', primary: '#45fcd1', bg: '#011627', text: '#d6deeb', isDark: true },
    { id: 'theme-synthwave-84', name: 'موج سینتی', primary: '#ff8b42', bg: '#2b213a', text: '#f9f7f2', isDark: true },
    { id: 'theme-atlantis', name: 'آتلانتیس', primary: '#96e072', bg: '#262a33', text: '#f8f8f2', isDark: true },
    // START of 50 new Modern Dark themes
    { id: 'theme-starry-night', name: 'شب پرستاره', primary: '#f2c641', bg: '#0b1a3b', text: '#e0e5f0', isDark: true },
    { id: 'theme-tokyo-neon', name: 'نئون توکیو', primary: '#f92a82', bg: '#1a1a3a', text: '#a6e1ff', isDark: true },
    { id: 'theme-holographic', name: 'هولوگرافیک', primary: '#00f6ff', bg: '#0d0d2b', text: '#e5d4ff', isDark: true },
    { id: 'theme-supernova', name: 'ابرنواختر', primary: '#ffae42', bg: '#200c28', text: '#fce5d4', isDark: true },
    { id: 'theme-quantum', name: 'کوانتوم', primary: '#8effba', bg: '#0f0f1f', text: '#d1d1f0', isDark: true },
    { id: 'theme-peacock-dark', name: 'طاووس تیره', primary: '#00a99d', bg: '#0b2e34', text: '#b3e0d6', isDark: true },
    { id: 'theme-firefly-forest', name: 'جنگل کرم شب‌تاب', primary: '#d4ff00', bg: '#0a1d0a', text: '#c8e6c9', isDark: true },
    { id: 'theme-black-hole', name: 'سیاهچاله', primary: '#ff9a00', bg: '#000000', text: '#cccccc', isDark: true },
    { id: 'theme-art-deco-night', name: 'شب آرت دکو', primary: '#e6c300', bg: '#1a1a1a', text: '#f0eada', isDark: true },
    { id: 'theme-zaha-hadid', name: 'زاها حدید', primary: '#c0c0c0', bg: '#1f2229', text: '#e1e3e8', isDark: true },
    { id: 'theme-amethyst', name: 'آمتیست', primary: '#c395f3', bg: '#291c3d', text: '#e9e0f9', isDark: true },
    { id: 'theme-bioluminescent', name: 'زیست‌تابی', primary: '#40e0d0', bg: '#0a1f2c', text: '#c0f0e8', isDark: true },
    { id: 'theme-miami-vice', name: 'میامی وایس', primary: '#ee00ff', bg: '#0f0c29', text: '#00eaff', isDark: true },
    { id: 'theme-lunar-eclipse', name: 'ماه‌گرفتگی', primary: '#ff6b6b', bg: '#1a141e', text: '#ffc3c3', isDark: true },
    { id: 'theme-martian-sky', name: 'آسمان مریخ', primary: '#e58d45', bg: '#2a140e', text: '#e8d8d2', isDark: true },
    { id: 'theme-orchid-noir', name: 'ارکیده نوآر', primary: '#da70d6', bg: '#1c1822', text: '#e6dced', isDark: true },
    { id: 'theme-andromeda', name: 'آندرومدا', primary: '#a79aff', bg: '#12122d', text: '#e3e0ff', isDark: true },
    { id: 'theme-geode-dark', name: 'ژئود تیره', primary: '#aa7de0', bg: '#2d2a42', text: '#e8e5f5', isDark: true },
    { id: 'theme-glitch', name: 'گلیچ', primary: '#ff003c', bg: '#101010', text: '#00ffc3', isDark: true },
    { id: 'theme-crystal-cave', name: 'غار کریستالی', primary: '#80dfff', bg: '#1e293b', text: '#e2f3ff', isDark: true },
    { id: 'theme-velvet-galaxy', name: 'کهکشان مخملی', primary: '#c8a2c8', bg: '#201b2f', text: '#e5ddeb', isDark: true },
    { id: 'theme-monarch-dark', name: 'پروانه مونارک', primary: '#fc6a03', bg: '#1a120b', text: '#f2e6de', isDark: true },
    { id: 'theme-city-lights', name: 'چراغ‌های شهر', primary: '#f9d749', bg: '#0d1b2a', text: '#e0e1dd', isDark: true },
    { id: 'theme-techno', name: 'تکنو', primary: '#7efd7e', bg: '#0a0a0a', text: '#c1c1c1', isDark: true },
    { id: 'theme-futuristic-femme', name: 'بانوی آینده', primary: '#f470b9', bg: '#190e28', text: '#f9d8f4', isDark: true },
    { id: 'theme-dark-matter', name: 'ماده تاریک', primary: '#9e9e9e', bg: '#0f0f0f', text: '#dddddd', isDark: true },
    { id: 'theme-coral-night', name: 'شب مرجانی', primary: '#ff7f50', bg: '#002538', text: '#ccebff', isDark: true },
    { id: 'theme-cyber-rose', name: 'رز سایبری', primary: '#ff007f', bg: '#1b001a', text: '#ffcce7', isDark: true },
    { id: 'theme-lava-lamp', name: 'لامپ گدازه', primary: '#f55734', bg: '#230a1f', text: '#f9e3de', isDark: true },
    { id: 'theme-arctic-night', name: 'شب قطبی', primary: '#86c5da', bg: '#1f2937', text: '#d1e0e8', isDark: true },
    { id: 'theme-brutalist-dark', name: 'بروتالیست تیره', primary: '#a0a0a0', bg: '#303030', text: '#e0e0e0', isDark: true },
    { id: 'theme-glass-frog', name: 'قورباغه شیشه‌ای', primary: '#a6ffcb', bg: '#0b211a', text: '#d1f2e9', isDark: true },
    { id: 'theme-electric-eel', name: 'مارماهی الکتریکی', primary: '#fff352', bg: '#08172c', text: '#d9e7ff', isDark: true },
    { id: 'theme-diamond-dark', name: 'الماس تیره', primary: '#b9f2ff', bg: '#1c2541', text: '#e2f4ff', isDark: true },
    { id: 'theme-retro-futurism', name: 'آینده‌گرایی رترو', primary: '#ff9f1c', bg: '#2b2d42', text: '#edf2f4', isDark: true },
    { id: 'theme-mood-ring', name: 'انگشتر خلق‌وخو', primary: '#4deeea', bg: '#242e3a', text: '#d3dce6', isDark: true },
    { id: 'theme-digital-rain', name: 'باران دیجیتال', primary: '#43ff43', bg: '#050a05', text: '#90ff90', isDark: true },
    { id: 'theme-enchanted-forest', name: 'جنگل سحرآمیز', primary: '#9a7fdd', bg: '#1a1c33', text: '#dcd6f0', isDark: true },
    { id: 'theme-havana-nights', name: 'شب‌های هاوانا', primary: '#f7b801', bg: '#3d1c02', text: '#f4e7d7', isDark: true },
    { id: 'theme-stardust', name: 'گرد ستاره', primary: '#d4c1f5', bg: '#19192a', text: '#ebe6f9', isDark: true },
    { id: 'theme-comet-tail', name: 'دنباله دنباله‌دار', primary: '#a6e1ff', bg: '#0d1a32', text: '#e1ecf7', isDark: true },
    { id: 'theme-motherboard', name: 'مادربورد', primary: '#00b57a', bg: '#0c231f', text: '#a0d9c9', isDark: true },
    { id: 'theme-deep-sea-glow', name: 'درخشش اعماق دریا', primary: '#44f2e8', bg: '#040f28', text: '#c8daff', isDark: true },
    { id: 'theme-cinematic', name: 'سینمایی', primary: '#ffc107', bg: '#121212', text: '#e0e0e0', isDark: true },
    { id: 'theme-graphene', name: 'گرافن', primary: '#b3b3b3', bg: '#1e1e1e', text: '#dcdcdc', isDark: true },
    { id: 'theme-alien-jungle', name: 'جنگل بیگانه', primary: '#bfff00', bg: '#17220e', text: '#dfffaa', isDark: true },
    { id: 'theme-80s-bedroom', name: 'اتاق خواب دهه ۸۰', primary: '#ff69b4', bg: '#2c003e', text: '#ffc1e3', isDark: true },
    { id: 'theme-london-night', name: 'شب لندن', primary: '#d7c378', bg: '#25283d', text: '#d2d3db', isDark: true },
    { id: 'theme-dieselpunk', name: 'دیزل‌پانک', primary: '#c9a46f', bg: '#3a322c', text: '#e2dacf', isDark: true },
    { id: 'theme-dark-rhodium', name: 'رودیوم تیره', primary: '#a2a7b1', bg: '#292d34', text: '#e3e5e8', isDark: true },
    // END of 50 new Modern Dark themes
        // START of 25 new Modern Dark themes
    { id: 'theme-black-diamond', name: 'الماس سیاه', primary: '#d1d1d1', bg: '#0f0f0f', text: '#a8a8a8', isDark: true },
    { id: 'theme-onyx-gold', name: 'اونیکس و طلا', primary: '#e6c300', bg: '#1a1a1a', text: '#e0d8c4', isDark: true },
    { id: 'theme-sapphire-velvet', name: 'مخمل یاقوت کبود', primary: '#6d85b5', bg: '#0f172a', text: '#d4dbee', isDark: true },
    { id: 'theme-versailles-night', name: 'شب ورسای', primary: '#cba32a', bg: '#1c1624', text: '#e7e2ee', isDark: true },
    { id: 'theme-crystal-noir', name: 'کریستال نوآر', primary: '#a497b2', bg: '#1e1a26', text: '#e3e0e8', isDark: true },
    { id: 'theme-liquid-gold', name: 'طلای مایع', primary: '#f2d479', bg: '#120f0b', text: '#e1d9cc', isDark: true },
    { id: 'theme-midnight-orchid', name: 'ارکیده نیمه‌شب', primary: '#c87dd2', bg: '#1b0f1d', text: '#e8d8ea', isDark: true },
    { id: 'theme-luxury-lounge', name: 'سالن لوکس', primary: '#bfa38f', bg: '#2a2522', text: '#e4e0dd', isDark: true },
    { id: 'theme-stained-glass-dark', name: 'شیشه رنگی تیره', primary: '#8ab4f8', bg: '#1f2428', text: '#e8eaed', isDark: true },
    { id: 'theme-black-swan', name: 'قوی سیاه', primary: '#c0c0c0', bg: '#111111', text: '#d8d8d8', isDark: true },
    { id: 'theme-dark-topaz', name: 'توپاز تیره', primary: '#ffc107', bg: '#251d00', text: '#e8e1c9', isDark: true },
    { id: 'theme-royal-purple', name: 'بنفش سلطنتی', primary: '#ab87ff', bg: '#201a30', text: '#e4dfff', isDark: true },
    { id: 'theme-dark-silk', name: 'ابریشم تیره', primary: '#b38b96', bg: '#291e22', text: '#e6dfe1', isDark: true },
    { id: 'theme-diamond-heist', name: 'سرقت الماس', primary: '#a6e1ff', bg: '#0d1a2b', text: '#d1e5f0', isDark: true },
    { id: 'theme-gilded-onyx', name: 'اونیکس طلاکاری‌شده', primary: '#e8c975', bg: '#141414', text: '#dcd5c4', isDark: true },
    { id: 'theme-night-jasmine', name: 'یاس شب', primary: '#e0c4a4', bg: '#231f1a', text: '#f0e9e1', isDark: true },
    { id: 'theme-shadow-crystal', name: 'کریستال سایه', primary: '#a0a0d0', bg: '#1a1a2e', text: '#e0e0f0', isDark: true },
    { id: 'theme-penthouse-view', name: 'نمای پنت‌هاوس', primary: '#89cff0', bg: '#0b1d28', text: '#d9e8f0', isDark: true },
    { id: 'theme-jet-black', name: 'مشکی مطلق', primary: '#c9c9c9', bg: '#0a0a0a', text: '#a0a0a0', isDark: true },
    { id: 'theme-vvs-dark', name: 'VVS تیره', primary: '#b0e0e6', bg: '#1f2a38', text: '#e1ebee', isDark: true },
    { id: 'theme-black-iris', name: 'زنبق سیاه', primary: '#a999d9', bg: '#1e1c26', text: '#e4e1ed', isDark: true },
    { id: 'theme-obsidian-gold', name: 'ابسیدین و طلا', primary: '#d4af37', bg: '#1c1c1c', text: '#e8e2d0', isDark: true },
    { id: 'theme-luxe-noir', name: 'لوکس نوآر', primary: '#c4b3a2', bg: '#222222', text: '#e8e4e0', isDark: true },
    { id: 'theme-dark-peacock', name: 'طاووس تیره', primary: '#00a99d', bg: '#0b2e34', text: '#b3e0d6', isDark: true },
    { id: 'theme-midnight-jewel', name: 'جواهر نیمه‌شب', primary: '#7f5af0', bg: '#16161a', text: '#dcdcdc', isDark: true },
    // END of 25 new Modern Dark themes
  ],
  classicDark: [
    { id: 'theme-dracula', name: 'دراکولا', primary: '#ff79c6', bg: '#282a36', text: '#f8f8f2', isDark: true },
    { id: 'theme-monokai', name: 'مونوکای', primary: '#f92672', bg: '#272822', text: '#f8f8f2', isDark: true },
    { id: 'theme-nord', name: 'نورد', primary: '#88c0d0', bg: '#2e3440', text: '#d8dee9', isDark: true },
    { id: 'theme-gruvbox-dark', name: 'گراوباکس', primary: '#fe8019', bg: '#282828', text: '#ebdbb2', isDark: true },
    { id: 'theme-solarized-dark', name: 'سولارایزد', primary: '#268bd2', bg: '#002b36', text: '#eee8d5', isDark: true },
    { id: 'theme-old-terminal', name: 'ترمینال', primary: '#33ff33', bg: '#000000', text: '#33ff33', isDark: true },
    { id: 'theme-forest', name: 'جنگل', primary: '#b4e982', bg: '#1a2b23', text: '#d3e5d7', isDark: true },
    { id: 'theme-noir', name: 'نوآر', primary: '#f4a261', bg: '#1c1c1c', text: '#e0e0e0', isDark: true },
    { id: 'theme-velvet', name: 'مخملی', primary: '#ffd700', bg: '#4a0404', text: '#fff0f0', isDark: true },
    { id: 'theme-sublime', name: 'کدنویسی', primary: '#fd971f', bg: '#232323', text: '#f8f8f2', isDark: true },
    { id: 'theme-evergreen', name: 'همیشه‌سبز', primary: '#f4a261', bg: '#2a3d34', text: '#e8e4d1', isDark: true },
    { id: 'theme-gameboy-dark', name: 'گیم‌بوی', primary: '#3f6946', bg: '#0f380f', text: '#9bbc0f', isDark: true },
    { id: 'theme-gold-dark', name: 'طلای تیره', primary: '#ffd700', bg: '#141414', text: '#e8e8e8', isDark: true },
    { id: 'theme-rose-gold-dark', name: 'رزگلد تیره', primary: '#b76e79', bg: '#2c2426', text: '#f5f1f2', isDark: true },
    { id: 'theme-silver-dark', name: 'نقره‌ای تیره', primary: '#c0c0c0', bg: '#25282a', text: '#f0f0f0', isDark: true },
    { id: 'theme-ios-dark', name: 'iOS تیره', primary: '#0a84ff', bg: '#000000', text: '#ffffff', isDark: true },
    { id: 'theme-gothic', name: 'گوتیک', primary: '#9400d3', bg: '#121212', text: '#c8c8c8', isDark: true },
    { id: 'theme-retro-orange', name: 'نارنجی رترو', primary: '#e27d60', bg: '#27211e', text: '#e4d7d0', isDark: true },
    { id: 'theme-emerald', name: 'زمرد', primary: '#50c878', bg: '#1f2e2a', text: '#d4e9e2', isDark: true },
    { id: 'theme-coffee', name: 'قهوه', primary: '#c4a68a', bg: '#2a211c', text: '#d1c7b7', isDark: true },
    // START of 50 new Classic Dark themes
    { id: 'theme-klimt', name: 'گوستاو کلیمت', primary: '#e6b422', bg: '#3a2e0a', text: '#e8dcb5', isDark: true },
    { id: 'theme-redwood-night', name: 'شب ردوود', primary: '#b55b4e', bg: '#261b1a', text: '#d8cbc9', isDark: true },
    { id: 'theme-gothic-cathedral', name: 'کلیسای گوتیک', primary: '#a04f91', bg: '#22222a', text: '#c8c8d0', isDark: true },
    { id: 'theme-library-dark', name: 'کتابخانه تیره', primary: '#a56a42', bg: '#2a201c', text: '#d9cec6', isDark: true },
    { id: 'theme-stormy-sea', name: 'دریای طوفانی', primary: '#7b95a3', bg: '#2a3439', text: '#d6dde0', isDark: true },
    { id: 'theme-mossy-stone', name: 'سنگ خزه‌ای', primary: '#7a9e7e', bg: '#353e35', text: '#dce4dc', isDark: true },
    { id: 'theme-film-noir', name: 'فیلم نوآر', primary: '#a0a0a0', bg: '#1c1c1c', text: '#e0e0e0', isDark: true },
    { id: 'theme-charcoal', name: 'زغالی', primary: '#b0b0b0', bg: '#2d2d2d', text: '#e8e8e8', isDark: true },
    { id: 'theme-victorian-manor', name: 'عمارت ویکتوریایی', primary: '#8b4513', bg: '#2a2223', text: '#e3d7d8', isDark: true },
    { id: 'theme-autumn-leaves', name: 'برگ‌های پاییزی', primary: '#d86e3f', bg: '#36241e', text: '#e7d8d2', isDark: true },
    { id: 'theme-ancient-scroll', name: 'طومار باستانی', primary: '#c2a57f', bg: '#3f3123', text: '#e2d8ca', isDark: true },
    { id: 'theme-deep-emerald', name: 'زمرد عمیق', primary: '#009b77', bg: '#0e2d25', text: '#b3e0d4', isDark: true },
    { id: 'theme-sapphire-night', name: 'شب یاقوتی', primary: '#5b86e5', bg: '#1a233b', text: '#d3dcf2', isDark: true },
    { id: 'theme-ruby-embers', name: 'اخگر یاقوت', primary: '#d13f3f', bg: '#3b1a1a', text: '#f2d3d3', isDark: true },

    { id: 'theme-baroque', name: 'باروک', primary: '#eec44f', bg: '#3a2e22', text: '#eaddd0', isDark: true },
    { id: 'theme-witching-hour', name: 'ساعت جادوگری', primary: '#9932cc', bg: '#1d1126', text: '#e4d3ee', isDark: true },
    { id: 'theme-smoky-quartz', name: 'کوارتز دودی', primary: '#a89d91', bg: '#3d3733', text: '#e5e1de', isDark: true },
    { id: 'theme-maroon', name: 'عنابی', primary: '#c35b5b', bg: '#3b1b1b', text: '#e8d0d0', isDark: true },
    { id: 'theme-oxford-blue', name: 'آبی آکسفورد', primary: '#8da9c4', bg: '#2a3a4a', text: '#dae3ec', isDark: true },
    { id: 'theme-hunter-green', name: 'سبز شکاری', primary: '#8dbca0', bg: '#2b3a32', text: '#dbe7e1', isDark: true },
    { id: 'theme-midnight-blue', name: 'آبی نیمه‌شب', primary: '#7a9dcc', bg: '#1c253d', text: '#d4deee', isDark: true },
    { id: 'theme-spiced-wine', name: 'شراب ادویه‌ای', primary: '#a24949', bg: '#331a1a', text: '#e3d2d2', isDark: true },
    { id: 'theme-walnut', name: 'گردویی', primary: '#bca68e', bg: '#3d302a', text: '#e4dcd6', isDark: true },
    { id: 'theme-old-map', name: 'نقشه قدیمی', primary: '#c9a87c', bg: '#403528', text: '#e7e0d5', isDark: true },
    { id: 'theme-faded-photo', name: 'عکس رنگ‌پریده', primary: '#9a8c8c', bg: '#3a3636', text: '#e3e0e0', isDark: true },
    { id: 'theme-dark-academia', name: 'آکادمیای تاریک', primary: '#a38a6f', bg: '#2a241f', text: '#d8d1ca', isDark: true },
    { id: 'theme-renaissance', name: 'رنسانس', primary: '#be9b7b', bg: '#3a2f26', text: '#e4dcd3', isDark: true },
    { id: 'theme-tudor', name: 'تودور', primary: '#a96e5b', bg: '#3a2a26', text: '#e4d9d6', isDark: true },
    { id: 'theme-cobblestone', name: 'سنگفرش', primary: '#a0a0a0', bg: '#3c3c3c', text: '#e3e3e3', isDark: true },
    { id: 'theme-parchment-dark', name: 'پوست تیره', primary: '#c1b49a', bg: '#423c30', text: '#e6e2d9', isDark: true },
    { id: 'theme-art-nouveau-dark', name: 'آرت نوو تیره', primary: '#a98b64', bg: '#342f27', text: '#e0dcd4', isDark: true },
    { id: 'theme-tarnished-gold', name: 'طلای کدر', primary: '#c0a060', bg: '#332b1b', text: '#e0d9ca', isDark: true },
    { id: 'theme-aged-wine', name: 'شراب کهنه', primary: '#9e4242', bg: '#321d1d', text: '#e1d2d2', isDark: true },
    { id: 'theme-speakeasy', name: 'اسپیک‌ایزی', primary: '#daa520', bg: '#221e1a', text: '#ecd8ac', isDark: true },
    { id: 'theme-sculptors-clay', name: 'خاک رس مجسمه‌سازی', primary: '#ad9e92', bg: '#3d3936', text: '#e5e2e0', isDark: true },
    { id: 'theme-hemlock', name: 'شوکران', primary: '#9abf9e', bg: '#354339', text: '#dae5de', isDark: true },
    { id: 'theme-mahogany', name: 'ماهون', primary: '#b04a4a', bg: '#3d1e1e', text: '#e5d1d1', isDark: true },
    { id: 'theme-verdigris', name: 'زنگار', primary: '#77a399', bg: '#303f3c', text: '#d9e4e2', isDark: true },
    { id: 'theme-night-owl', name: 'جغد شب', primary: '#be9e7d', bg: '#3a3229', text: '#e3dcd5', isDark: true },
    { id: 'theme-boreal-forest', name: 'جنگل شمالی', primary: '#7da493', bg: '#2d3b36', text: '#dce5e0', isDark: true },
    { id: 'theme-fossil', name: 'فسیل', primary: '#b3a89a', bg: '#403c37', text: '#e5e3e0', isDark: true },
    { id: 'theme-cigar-lounge', name: 'سالن سیگار', primary: '#b37d4e', bg: '#3b2f27', text: '#e4dcd3', isDark: true },
    { id: 'theme-cast-iron', name: 'چدن', primary: '#8a8a8a', bg: '#2e2e2e', text: '#d8d8d8', isDark: true },
    { id: 'theme-gargoyle', name: 'گارگویل', primary: '#9e9e9e', bg: '#383838', text: '#e0e0e0', isDark: true },
    { id: 'theme-inkwell', name: 'دوات', primary: '#9ca9b7', bg: '#2c3036', text: '#dee1e5', isDark: true },
    { id: 'theme-odyssey', name: 'ادیسه', primary: '#8999ae', bg: '#303947', text: '#d8dde3', isDark: true },
    { id: 'theme-slate', name: 'سنگ لوح', primary: '#92a1b1', bg: '#363d45', text: '#dadee3', isDark: true },
    { id: 'theme-raven', name: 'کلاغ', primary: '#a0a0a0', bg: '#1f1f1f', text: '#dcdcdc', isDark: true },
    { id: 'theme-expedition', name: 'اکتشاف', primary: '#b39c7d', bg: '#3f362b', text: '#e4dfd6', isDark: true },
    // END of 50 new Classic Dark themes
        // START of 25 new Classic Dark themes
    { id: 'theme-garnet-gold', name: 'گارنت و طلا', primary: '#d16b55', bg: '#3b201c', text: '#e9d6d2', isDark: true },
    { id: 'theme-antique-gold', name: 'طلای عتیقه', primary: '#c8a864', bg: '#3a2e1c', text: '#e7e0d1', isDark: true },
    { id: 'theme-gothic-palace', name: 'کاخ گوتیک', primary: '#a48fb8', bg: '#2a2633', text: '#e3e0e8', isDark: true },
    { id: 'theme-damask-silk', name: 'ابریشم داماسک', primary: '#b8860b', bg: '#3b2f1f', text: '#e4dccd', isDark: true },
    { id: 'theme-dark-rose', name: 'رز تیره', primary: '#c25b75', bg: '#3a1f26', text: '#e8d4d9', isDark: true },
    { id: 'theme-venetian-glass', name: 'شیشه ونیزی', primary: '#7aaac2', bg: '#222d36', text: '#d6e0e6', isDark: true },
    { id: 'theme-kings-jewel', name: 'جواهر پادشاه', primary: '#e0b43a', bg: '#2b200e', text: '#ebe2cc', isDark: true },
    { id: 'theme-ballroom-noir', name: 'تالار رقص نوآر', primary: '#a9a9a9', bg: '#1e1e1e', text: '#e1e1e1', isDark: true },
    { id: 'theme-dark-marquise', name: 'مارکیز تیره', primary: '#bfa7d4', bg: '#2d2538', text: '#e8e2f0', isDark: true },
    { id: 'theme-byzantine-gold', name: 'طلای بیزانس', primary: '#bd9b3e', bg: '#382b18', text: '#e5dccb', isDark: true },
    { id: 'theme-moonstone-dark', name: 'سنگ ماه تیره', primary: '#a0b0c0', bg: '#2c333b', text: '#dfe4e8', isDark: true },
    { id: 'theme-royal-tapestry', name: 'پرده نقش‌دار سلطنتی', primary: '#b08b6e', bg: '#382e27', text: '#e3dcd5', isDark: true },
    { id: 'theme-black-pearl', name: 'مروارید سیاه', primary: '#9e9e9e', bg: '#2a2a2a', text: '#dcdcdc', isDark: true },
    { id: 'theme-vintage-brooch', name: 'سنجاق سینه وینتج', primary: '#c0a080', bg: '#3a322a', text: '#e6e0d9', isDark: true },
    { id: 'theme-dark-lily', name: 'سوسن تیره', primary: '#d8a8d8', bg: '#261e26', text: '#f0e3f0', isDark: true },
    { id: 'theme-sultan-palace', name: 'کاخ سلطان', primary: '#daa520', bg: '#291d0a', text: '#e9e2cc', isDark: true },
    { id: 'theme-heirloom-gold', name: 'طلای موروثی', primary: '#c2a66c', bg: '#332b1e', text: '#e6e0d3', isDark: true },
    { id: 'theme-smoky-amethyst', name: 'آمتیست دودی', primary: '#a993b8', bg: '#2d2833', text: '#e4e0e8', isDark: true },
    { id: 'theme-dark-brocade', name: 'زربفت تیره', primary: '#b5926c', bg: '#332a22', text: '#e4e0d8', isDark: true },
    { id: 'theme-secret-garden-night', name: 'باغ اسرارآمیز شب', primary: '#8baf8b', bg: '#222e22', text: '#d8e2d8', isDark: true },
    { id: 'theme-regal-blue', name: 'آبی باشکوه', primary: '#6a89c0', bg: '#222a3b', text: '#d4dae6', isDark: true },
    { id: 'theme-maharaja-jewel', name: 'جواهر مهاراجه', primary: '#ff8c00', bg: '#3b220a', text: '#f2e5d1', isDark: true },
    { id: 'theme-dark-cashmere', name: 'ترمه تیره', primary: '#b3a595', bg: '#33302c', text: '#e6e3e0', isDark: true },
    { id: 'theme-winter-palace', name: 'کاخ زمستانی', primary: '#a4c6d5', bg: '#2c353b', text: '#dfe8ec', isDark: true },
    { id: 'theme-ancient-gold', name: 'طلای باستانی', primary: '#b89b58', bg: '#332a1a', text: '#e4deca', isDark: true },
    // END of 25 new Classic Dark themes
  ],
  modernLight: [
    { id: 'theme-joes', name: 'Joes', isDark: false, primary: '#004080', bg: '#F5F5DC', text: '#3A3A3A', card: '#BBDDFF', cellInactive: '#F5F5DC', completedBg: '#F5F5DC' },
    { id: 'theme-sakura', name: 'ساکورا', primary: '#db88b5', bg: '#fff6f9', text: '#5b4d53', isDark: false },
    { id: 'theme-seaside', name: 'ساحلی', primary: '#1d74c4', bg: '#eef7ff', text: '#0b3954', isDark: false },
    { id: 'theme-matcha', name: 'ماچا', primary: '#75a99c', bg: '#f5f5e8', text: '#4a4a42', isDark: false },
    { id: 'theme-peaches', name: 'هلو', primary: '#ff6b6b', bg: '#fff2f2', text: '#5e3b3b', isDark: false },
    { id: 'theme-lavender', name: 'اسطوخودوس', primary: '#8a63d2', bg: '#f7f4ff', text: '#4b3d60', isDark: false },
    { id: 'theme-cotton-candy', name: 'پشمک', primary: '#ff9dcb', bg: '#f0f8ff', text: '#5b6a78', isDark: false },
    { id: 'theme-gummybear', name: 'پاستیلی', primary: '#ef476f', bg: '#ffffff', text: '#073b4c', isDark: false },
    { id: 'theme-snes-light', name: 'SNES روشن', primary: '#e60012', bg: '#e8e8e8', text: '#2c2c2c', isDark: false },
    { id: 'theme-playstation-light', name: 'پلی‌استیشن روشن', primary: '#006fcd', bg: '#eef2f7', text: '#333333', isDark: false },
    { id: 'theme-gold-light', name: 'طلای روشن', primary: '#b59410', bg: '#fdfaf0', text: '#3d3419', isDark: false },
    { id: 'theme-rose-gold-light', name: 'رزگلد روشن', primary: '#b76e79', bg: '#fcf6f7', text: '#5c373d', isDark: false },
    { id: 'theme-silver-light', name: 'نقره‌ای روشن', primary: '#8c8c8c', bg: '#f7f7f7', text: '#333333', isDark: false },
    { id: 'theme-ios-light', name: 'iOS روشن', primary: '#007aff', bg: '#f2f2f7', text: '#000000', isDark: false },
    { id: 'theme-pastel-dream', name: 'رویای پاستلی', primary: '#ffc0cb', bg: '#fdf5f6', text: '#6d5458', isDark: false },
    { id: 'theme-floral', name: 'گل‌گلی', primary: '#de5b83', bg: '#f9f2f5', text: '#573a45', isDark: false },
    { id: 'theme-strawberry', name: 'توت‌فرنگی', primary: '#e53935', bg: '#fff2f2', text: '#5e3b3b', isDark: false },
    { id: 'theme-blueberry', name: 'بلوبری', primary: '#3f51b5', bg: '#f2f3ff', text: '#39405f', isDark: false },
    { id: 'theme-apricot', name: 'زردآلو', primary: '#fb8c00', bg: '#fff8f0', text: '#613800', isDark: false },
    { id: 'theme-sky', name: 'آسمان', primary: '#03a9f4', bg: '#f0f9ff', text: '#014361', isDark: false },
    { id: 'theme-lilac', name: 'یاسی', primary: '#b39ddb', bg: '#f9f7fd', text: '#512da8', isDark: false },
    // START of 50 new Modern Light themes
    { id: 'theme-santorini', name: 'سانتورینی', primary: '#0057b7', bg: '#f4f8ff', text: '#2a3a57', isDark: false },
    { id: 'theme-champagne', name: 'شامپاین', primary: '#c9a77d', bg: '#fcf8f0', text: '#5d4b35', isDark: false },
    { id: 'theme-pearl', name: 'مروارید', primary: '#a0d2d8', bg: '#f6fafd', text: '#4a6063', isDark: false },
    { id: 'theme-watercolor', name: 'آبرنگ', primary: '#b19cd9', bg: '#f9f7fd', text: '#5c4e6e', isDark: false },
    { id: 'theme-sorbet', name: 'سوربت', primary: '#ff8c94', bg: '#fff5f6', text: '#6e3c40', isDark: false },
    { id: 'theme-scandinavian', name: 'اسکاندیناوی', primary: '#8da9c4', bg: '#f5f7fa', text: '#3c4a57', isDark: false },
    { id: 'theme-golden-hour', name: 'ساعت طلایی', primary: '#ffc55c', bg: '#fff9ed', text: '#6b501e', isDark: false },
    { id: 'theme-blue-lagoon', name: 'تالاب آبی', primary: '#00bfff', bg: '#f0fbff', text: '#00536b', isDark: false },
    { id: 'theme-succulent', name: 'ساکولنت', primary: '#7aa98b', bg: '#f4faf6', text: '#43574b', isDark: false },
    { id: 'theme-couture', name: 'کوتور', primary: '#c0a0c0', bg: '#f9f5f9', text: '#5a4a5a', isDark: false },
    { id: 'theme-parisian-cafe', name: 'کافه پاریسی', primary: '#d4af37', bg: '#fdfcf7', text: '#5e4e24', isDark: false },
    { id: 'theme-minimal-tech', name: 'تک مینیمال', primary: '#6c757d', bg: '#f8f9fa', text: '#212529', isDark: false },
    { id: 'theme-glass-ui', name: 'رابط شیشه‌ای', primary: '#6a85e3', bg: '#f0f3ff', text: '#3c4873', isDark: false },
    { id: 'theme-silk', name: 'ابریشم', primary: '#d4b8c0', bg: '#fdf8f9', text: '#645458', isDark: false },
    { id: 'theme-lipstick-red', name: 'قرمز ماتیکی', primary: '#c71585', bg: '#fdf2f7', text: '#5b243e', isDark: false },
    { id: 'theme-diamond-light', name: 'الماس روشن', primary: '#80bdde', bg: '#f3f9fc', text: '#3d5966', isDark: false },
    { id: 'theme-holographic-light', name: 'هولوگرافیک روشن', primary: '#be93d4', bg: '#f9f5fc', text: '#584565', isDark: false },
    { id: 'theme-marshmallow', name: 'مارشمالو', primary: '#f4b6c2', bg: '#fdf7f9', text: '#675055', isDark: false },
    { id: 'theme-ice-cream', name: 'بستنی', primary: '#f999b7', bg: '#fff5f8', text: '#6b4352', isDark: false },
    { id: 'theme-kyoto-garden', name: 'باغ کیوتو', primary: '#6fa673', bg: '#f3f9f3', text: '#3e5840', isDark: false },
    { id: 'theme-spring-blossom', name: 'شکوفه بهاری', primary: '#ffb7c5', bg: '#fff8f9', text: '#6e5157', isDark: false },
    { id: 'theme-macaron', name: 'ماکارون', primary: '#f6a6b2', bg: '#fef6f7', text: '#69484d', isDark: false },
    { id: 'theme-clean-code', name: 'کد تمیز', primary: '#007acc', bg: '#fcfcfc', text: '#2d2d2d', isDark: false },

    { id: 'theme-candy-floss', name: 'پشمک صورتی', primary: '#f6a8cc', bg: '#fef6fa', text: '#6a4959', isDark: false },
    { id: 'theme-sunny-day', name: 'روز آفتابی', primary: '#ffd700', bg: '#fffdf0', text: '#665700', isDark: false },
    { id: 'theme-fresh-air', name: 'هوای تازه', primary: '#87ceeb', bg: '#f5fbfe', text: '#40606e', isDark: false },
    { id: 'theme-peony', name: 'گل صدتومانی', primary: '#e89ab8', bg: '#fdf5f8', text: '#654452', isDark: false },

    { id: 'theme-flamingo', name: 'فلامینگو', primary: '#fc8eac', bg: '#fff6f8', text: '#6b3d4a', isDark: false },
    { id: 'theme-tiffany-blue', name: 'آبی تیفانی', primary: '#0abab5', bg: '#f0fafa', text: '#054e4c', isDark: false },
    { id: 'theme-hummingbird', name: 'مرغ مگس‌خوار', primary: '#b15a9a', bg: '#f9f2f8', text: '#502945', isDark: false },
    { id: 'theme-bauhaus-light', name: 'باوهاوس روشن', primary: '#e63946', bg: '#f1faee', text: '#1d3557', isDark: false },
    { id: 'theme-coral-reef-light', name: 'صخره مرجانی', primary: '#ff6f61', bg: '#fef4f3', text: '#6e3029', isDark: false },
    { id: 'theme-white-orchid', name: 'ارکیده سفید', primary: '#a8a8a8', bg: '#fcfcfc', text: '#4d4d4d', isDark: false },
    { id: 'theme-daydream', name: 'رویاپردازی', primary: '#a0c4ff', bg: '#f6f9ff', text: '#4a5b78', isDark: false },
    { id: 'theme-moma', name: 'موما', primary: '#e63946', bg: '#ffffff', text: '#1d3557', isDark: false },
    { id: 'theme-angel-food', name: 'کیک آنجل', primary: '#dbcba8', bg: '#fdfbf5', text: '#655b49', isDark: false },
    { id: 'theme-frosted-glass', name: 'شیشه مات', primary: '#a9cce3', bg: '#f7fafc', text: '#4d5c66', isDark: false },
    { id: 'theme-coconut', name: 'نارگیل', primary: '#a4886e', bg: '#fbfaf8', text: '#493d31', isDark: false },
    { id: 'theme-lemonade', name: 'لیموناد', primary: '#fce16d', bg: '#fffdef', text: '#695f2e', isDark: false },
    { id: 'theme-sea-salt', name: 'نمک دریا', primary: '#a0b8c8', bg: '#f7f9fa', text: '#48535a', isDark: false },
    { id: 'theme-celadon', name: 'سبز سلادون', primary: '#ace1af', bg: '#f7fcf7', text: '#4d664f', isDark: false },
    { id: 'theme-cloud', name: 'ابر', primary: '#b0c4de', bg: '#f8f9fc', text: '#4e5a68', isDark: false },
    { id: 'theme-quartz', name: 'کوارتز', primary: '#d7c7d9', bg: '#fcfafc', text: '#625963', isDark: false },
    { id: 'theme-breeze', name: 'نسیم', primary: '#a9d6e5', bg: '#f7fbfe', text: '#4c626a', isDark: false },
    { id: 'theme-periwinkle', name: 'پیچ امین‌الدوله', primary: '#ccccff', bg: '#fafafe', text: '#5c5c73', isDark: false },
    { id: 'theme-baby-blue', name: 'آبی نوزادی', primary: '#89cff0', bg: '#f5faff', text: '#3f5e6e', isDark: false },
    { id: 'theme-peach-sorbet', name: 'سوربت هلو', primary: '#ffb997', bg: '#fff8f5', text: '#6e4f3f', isDark: false },
    { id: 'theme-wildflower', name: 'گل وحشی', primary: '#dea5a4', bg: '#fcf6f6', text: '#644949', isDark: false },
    { id: 'theme-buttercream', name: 'کرم کره‌ای', primary: '#f6e5b3', bg: '#fefbf0', text: '#69624d', isDark: false },
    { id: 'theme-mint-green', name: 'سبز نعنایی', primary: '#98ff98', bg: '#f7fff7', text: '#447344', isDark: false },
    // END of 50 new Modern Light themes
        // START of 25 new Modern Light themes
    { id: 'theme-diamond-dust', name: 'گرد الماس', primary: '#a4c6d5', bg: '#f8fafc', text: '#4a5a62', isDark: false },
    { id: 'theme-crystal-clear', name: 'کریستال شفاف', primary: '#80bdde', bg: '#f3f9fc', text: '#3d5966', isDark: false },
    { id: 'theme-luxury-boutique', name: 'بوتیک لوکس', primary: '#c0a0c0', bg: '#f9f5f9', text: '#5a4a5a', isDark: false },
    { id: 'theme-white-gold', name: 'طلای سفید', primary: '#d4c8b8', bg: '#fcfaf8', text: '#605a52', isDark: false },

    { id: 'theme-peony-blush', name: 'سرخی پیونی', primary: '#e89ab8', bg: '#fdf5f8', text: '#654452', isDark: false },
    { id: 'theme-silk-kimono', name: 'کیمونوی ابریشمی', primary: '#d4a8b4', bg: '#fdf6f8', text: '#614b51', isDark: false },
    { id: 'theme-glass-palace', name: 'کاخ شیشه‌ای', primary: '#a9d6e5', bg: '#f7fbfe', text: '#4c626a', isDark: false },
    { id: 'theme-champagne-toast', name: 'نوش شامپاین', primary: '#f6e5b3', bg: '#fefbf0', text: '#69624d', isDark: false },
    { id: 'theme-opalescent', name: 'اوپال', primary: '#b8d8d2', bg: '#f8fbfb', text: '#53635f', isDark: false },
    { id: 'theme-white-orchid', name: 'ارکیده سفید', primary: '#b0b0b0', bg: '#fcfcfc', text: '#505050', isDark: false },
    { id: 'theme-rose-quartz-gold', name: 'رز کوارتز و طلا', primary: '#e6b3b8', bg: '#fdf8f8', text: '#685053', isDark: false },
    { id: 'theme-modern-princess', name: 'پرنسس مدرن', primary: '#f4c2c2', bg: '#fef9f9', text: '#685656', isDark: false },
    { id: 'theme-high-jewelry', name: 'جواهرات فاخر', primary: '#87cefa', bg: '#f5faff', text: '#3e5e72', isDark: false },
    { id: 'theme-satin-sheets', name: 'ملحفه ساتن', primary: '#d8c0c8', bg: '#fcf9fa', text: '#63565a', isDark: false },
    { id: 'theme-lily-of-the-valley', name: 'گل برف', primary: '#a8d8a8', bg: '#f7fcf7', text: '#4b634b', isDark: false },
    { id: 'theme-crystal-chandelier', name: 'لوستر کریستال', primary: '#c0c0c0', bg: '#f9f9f9', text: '#585858', isDark: false },
    { id: 'theme-golden-petal', name: 'گلبرگ طلایی', primary: '#ffd700', bg: '#fffdf0', text: '#665700', isDark: false },
    { id: 'theme-blush-silk', name: 'ابریشم رژگونه‌ای', primary: '#e6b8c2', bg: '#fdf8f9', text: '#685358', isDark: false },
    { id: 'theme-beverly-hills', name: 'بورلی هیلز', primary: '#ffb6c1', bg: '#fff8f9', text: '#6e5155', isDark: false },
    { id: 'theme-platinum', name: 'پلاتین', primary: '#cdd4da', bg: '#fafbfc', text: '#5d6165', isDark: false },
    { id: 'theme-magnolia', name: 'ماگنولیا', primary: '#d4bca2', bg: '#fdfaf5', text: '#605548', isDark: false },
    { id: 'theme-luxe-life', name: 'زندگی لوکس', primary: '#d4af37', bg: '#fdfcf7', text: '#5e4e24', isDark: false },
    { id: 'theme-frosted-rose', name: 'رز مات', primary: '#e0b0c0', bg: '#fdf7f9', text: '#654f57', isDark: false },
    { id: 'theme-aquamarine', name: 'آکوامارین', primary: '#7fffd4', bg: '#f4fffa', text: '#387363', isDark: false },
    { id: 'theme-white-diamond', name: 'الماس سفید', primary: '#b9f2ff', bg: '#f8fcfe', text: '#536d75', isDark: false },
    // END of 25 new Modern Light themes
  ],
  classicLight: [
    { id: 'theme-solarized-light', name: 'سولارایزد', primary: '#d33682', bg: '#fdf6e3', text: '#586e75', isDark: false },
    { id: 'theme-gruvbox-light', name: 'گراوباکس', primary: '#d65d0e', bg: '#fbf1c7', text: '#3c3836', isDark: false },
    { id: 'theme-daylight', name: 'روز روشن', primary: '#007bff', bg: '#f0f8ff', text: '#212529', isDark: false },
    { id: 'theme-paper', name: 'کاغذی', primary: '#d94d41', bg: '#f7f6f1', text: '#3a3a3a', isDark: false },
    { id: 'theme-classic-mac', name: 'مک کلاسیک', primary: '#000000', bg: '#e0e0e0', text: '#000000', isDark: false },
    { id: 'theme-blueprint', name: 'بلوپرینت', primary: '#295ddc', bg: '#eff3f9', text: '#333a56', isDark: false },
    { id: 'theme-sepia', name: 'سپیا', primary: '#704214', bg: '#fbf0d9', text: '#4a2d0b', isDark: false },
    { id: 'theme-mint-choco', name: 'نعنا شکلاتی', primary: '#3d2b24', bg: '#f0fff0', text: '#513e36', isDark: false },
    { id: 'theme-desert-oasis', name: 'واحه', primary: '#00bcd4', bg: '#faf3e0', text: '#7a6a53', isDark: false },
    { id: 'theme-botanical', name: 'گیاه‌شناسی', primary: '#4caf50', bg: '#f5fcf5', text: '#3e503f', isDark: false },
    { id: 'theme-e-ink', name: 'جوهر الکترونیک', primary: '#000000', bg: '#f5f5f5', text: '#333333', isDark: false },
    { id: 'theme-minimal-white', name: 'مینیمال', primary: '#888888', bg: '#ffffff', text: '#222222', isDark: false },
    { id: 'theme-newspaper', name: 'روزنامه', primary: '#d11c11', bg: '#f8f8f2', text: '#1c1c1a', isDark: false },
    { id: 'theme-gameboy-light', name: 'گیم‌بوی روشن', primary: '#0f380f', bg: '#9bbc0f', text: '#0f380f', isDark: false },
    { id: 'theme-dune-light', name: 'تل‌ماسه روشن', primary: '#a0522d', bg: '#f4e8d8', text: '#5d4037', isDark: false },
    { id: 'theme-vanilla', name: 'وانیلی', primary: '#8d6e63', bg: '#fdfcf7', text: '#4e342e', isDark: false },
    { id: 'theme-pistachio', name: 'پسته‌ای', primary: '#7cb342', bg: '#f7fff2', text: '#33491c', isDark: false },
    { id: 'theme-sand', name: 'شنی', primary: '#c2b280', bg: '#fbf9f4', text: '#5a523c', isDark: false },
    { id: 'theme-rose-quartz', name: 'رز کوارتز', primary: '#f0a1b8', bg: '#fdf6f8', text: '#6b404c', isDark: false },
    { id: 'theme-serenity', name: 'آرامش', primary: '#92a8d1', bg: '#f6f8fd', text: '#444e60', isDark: false },
    // START of 50 new Classic Light themes
    { id: 'theme-monet', name: 'کلود مونه', primary: '#6f9eaf', bg: '#f2f5f6', text: '#405861', isDark: false },
    { id: 'theme-parchment-light', name: 'پوست روشن', primary: '#a88d5e', bg: '#fbf8f0', text: '#4c3f29', isDark: false },
    { id: 'theme-vintage-dress', name: 'لباس وینتج', primary: '#c9898b', bg: '#fdfaed', text: '#6b5a5a', isDark: false },
    { id: 'theme-terracotta', name: 'تراکوتا', primary: '#e2725b', bg: '#fdf3f1', text: '#643229', isDark: false },
    { id: 'theme-linen', name: 'کتان', primary: '#b8a99a', bg: '#fbf9f7', text: '#544d46', isDark: false },
    { id: 'theme-old-hollywood', name: 'هالیوود قدیم', primary: '#daa520', bg: '#fdf9e8', text: '#61490d', isDark: false },
    { id: 'theme-french-riviera', name: 'ریویرای فرانسه', primary: '#0077b6', bg: '#eef8fc', text: '#003652', isDark: false },
    { id: 'theme-tuscany', name: 'توسکانی', primary: '#c89f64', bg: '#fcf7ed', text: '#5a472c', isDark: false },
    { id: 'theme-provence', name: 'پروانس', primary: '#9e8fb9', bg: '#f8f6fb', text: '#484254', isDark: false },
    { id: 'theme-heirloom', name: 'موروثی', primary: '#b48e8e', bg: '#fbf6f6', text: '#514141', isDark: false },
    { id: 'theme-pressed-flowers', name: 'گل‌های خشک', primary: '#a87ca8', bg: '#f9f5f9', text: '#4c394c', isDark: false },
    { id: 'theme-porcelain', name: 'پرسلان', primary: '#8db7d1', bg: '#f5f8fa', text: '#405360', isDark: false },
    { id: 'theme-calligraphy', name: 'خوشنویسی', primary: '#6e6e6e', bg: '#f9f9f9', text: '#333333', isDark: false },
    { id: 'theme-tea-stain', name: 'لکه چای', primary: '#c6a88b', bg: '#fbf8f4', text: '#594a3b', isDark: false },
    { id: 'theme-antique-brass', name: 'برنج عتیقه', primary: '#c9a96e', bg: '#fcf8f0', text: '#5a4a30', isDark: false },
    { id: 'theme-cameo', name: 'کامئو', primary: '#d4b4a4', bg: '#fdf8f6', text: '#605149', isDark: false },
    { id: 'theme-sea-glass', name: 'شیشه دریایی', primary: '#86b4a7', bg: '#f5faf9', text: '#3d514b', isDark: false },
    { id: 'theme-ivory', name: 'عاجی', primary: '#a1887f', bg: '#fffdfa', text: '#493d39', isDark: false },
    { id: 'theme-khaki', name: 'خاکی', primary: '#c3b091', bg: '#faf8f4', text: '#585042', isDark: false },
    { id: 'theme-wedgwood', name: 'وج‌وود', primary: '#9ab3d3', bg: '#f6f8fb', text: '#465161', isDark: false },
    { id: 'theme-naturalist', name: 'طبیعت‌گرا', primary: '#8f9d78', bg: '#f7f8f4', text: '#414837', isDark: false },
    { id: 'theme-sage', name: 'مریم‌گلی', primary: '#a2b4a5', bg: '#f7f9f7', text: '#49524a', isDark: false },
    { id: 'theme-stone', name: 'سنگی', primary: '#b0ab9a', bg: '#f9f9f7', text: '#504d46', isDark: false },
    { id: 'theme-willow', name: 'بید', primary: '#a3b596', bg: '#f8faf6', text: '#495244', isDark: false },
    { id: 'theme-heather', name: 'خلنگ', primary: '#c4a6c4', bg: '#faf7fa', text: '#584a58', isDark: false },
    { id: 'theme-oxford', name: 'آکسفورد', primary: '#879bba', bg: '#f5f7f9', text: '#3e4855', isDark: false },
    { id: 'theme-cashmere', name: 'ترمه', primary: '#d1c4b4', bg: '#fcfaf8', text: '#5f5850', isDark: false },
    { id: 'theme-latte', name: 'لاته', primary: '#c3a995', bg: '#faf7f5', text: '#584c44', isDark: false },
    { id: 'theme-buttercup', name: 'آلاله', primary: '#f3da73', bg: '#fefbec', text: '#695f31', isDark: false },
    { id: 'theme-driftwood', name: 'چوب آب‌آورده', primary: '#b7a89b', bg: '#faf8f7', text: '#534c46', isDark: false },
    { id: 'theme-parisian-apartment', name: 'آپارتمان پاریسی', primary: '#d4af37', bg: '#f9f8f6', text: '#5e4e24', isDark: false },
    { id: 'theme-renaissance-fresco', name: 'فرسک رنسانس', primary: '#d7a98b', bg: '#fbf5f2', text: '#624b3c', isDark: false },
    { id: 'theme-claire-de-lune', name: 'مهتاب', primary: '#a1b6d1', bg: '#f7f9fc', text: '#495360', isDark: false },
    { id: 'theme-english-garden', name: 'باغ انگلیسی', primary: '#de7a95', bg: '#fcf3f6', text: '#643744', isDark: false },
    { id: 'theme-chinoiserie', name: 'چینی‌کاری', primary: '#6995b3', bg: '#f2f6f9', text: '#304451', isDark: false },
    { id: 'theme-greige', name: 'خاکستری‌بژ', primary: '#c0b6a8', bg: '#f9f8f7', text: '#57524c', isDark: false },
    { id: 'ivory-tower', name: 'برج عاج', primary: '#9e917d', bg: '#fcfaf6', text: '#484238', isDark: false },
    { id: 'theme-art-nouveau-light', name: 'آرت نوو روشن', primary: '#b8a383', bg: '#fbf8f4', text: '#54493a', isDark: false },
    { id: 'theme-taupe', name: 'قهوه‌ای دودی', primary: '#b3a595', bg: '#f9f8f6', text: '#514a44', isDark: false },
    { id: 'theme-alabaster', name: 'آلاباستر', primary: '#c2b8b0', bg: '#fcfbf9', text: '#58544f', isDark: false },
    { id: 'theme-venetian', name: 'ونیزی', primary: '#d28f8f', bg: '#fdf5f5', text: '#5f4141', isDark: false },
    { id: 'theme-wisteria', name: 'ویستریا', primary: '#b79fc9', bg: '#f9f6fc', text: '#53485b', isDark: false },
    { id: 'theme-oatmeal', name: 'بلغور جو دوسر', primary: '#d4c8be', bg: '#fcfaf8', text: '#605a55', isdark: false },
    { id: 'theme-pottery', name: 'سفالگری', primary: '#b97b62', bg: '#f9f4f2', text: '#54382c', isDark: false },
    { id: 'theme-bisque', name: 'بیسک', primary: '#d3b8ae', bg: '#fdf8f7', text: '#5f534e', isDark: false },
    { id: 'theme-ecru', name: 'اکرو', primary: '#d4c7a6', bg: '#fcfaf3', text: '#60594a', isDark: false },
    { id: 'theme-classic-linen', name: 'کتان کلاسیک', primary: '#c9c0b4', bg: '#faf9f8', text: '#5b5650', isDark: false },
    { id: 'theme-dove-grey', name: 'خاکستری کبوتری', primary: '#bdbdbd', bg: '#f9f9f9', text: '#555555', isDark: false },
    { id: 'theme-bone-white', name: 'سفید استخوانی', primary: '#c5bbae', bg: '#fbfaf8', text: '#59544e', isDark: false },
    { id: 'theme-putty', name: 'بتونه‌ای', primary: '#c8bdae', bg: '#faf9f7', text: '#5a544e', isDark: false },
    // END of 50 new Classic Light themes
        // START of 25 new Classic Light themes
    { id: 'theme-pearl-necklace', name: 'گردنبند مروارید', primary: '#c8b8a8', bg: '#fbf9f7', text: '#5a534c', isDark: false },
    { id: 'theme-versailles-day', name: 'روز ورسای', primary: '#d4b77a', bg: '#fdf9f1', text: '#5f5236', isDark: false },
    { id: 'theme-antique-lace', name: 'توری عتیقه', primary: '#dcd0c0', bg: '#fdfbf9', text: '#635d55', isDark: false },
    { id: 'theme-rose-garden', name: 'باغ رز', primary: '#d98c9c', bg: '#fdf4f6', text: '#623e46', isDark: false },
    { id: 'theme-heirloom-pearl', name: 'مروارید موروثی', primary: '#d1c4b8', bg: '#fbfaf8', text: '#5f5852', isDark: false },
    { id: 'theme-porcelain-doll', name: 'عروسک پرسلان', primary: '#d4b8b8', bg: '#fdf8f8', text: '#605353', isDark: false },
    { id: 'theme-tiffany-breakfast', name: 'صبحانه در تیفانی', primary: '#81d8d0', bg: '#f4fbfb', text: '#3a635f', isDark: false },
    { id: 'theme-silk-scarf', name: 'روسری ابریشمی', primary: '#c0a0a0', bg: '#f9f5f5', text: '#5a4a4a', isDark: false },
    { id: 'theme-cameo-pink', name: 'صورتی کامئو', primary: '#e6c4ba', bg: '#fdfaf8', text: '#685852', isDark: false },
    { id: 'theme-gold-leaf', name: 'ورق طلا', primary: '#e0c47f', bg: '#fdfaf2', text: '#645839', isDark: false },
    { id: 'theme-vintage-rose', name: 'رز وینتج', primary: '#d4a3a3', bg: '#fcf6f6', text: '#604949', isDark: false },
    { id: 'theme-marble-palace', name: 'کاخ مرمر', primary: '#c0c0c0', bg: '#f9f9f9', text: '#585858', isDark: false },
    { id: 'theme-chantilly-lace', name: 'توری شانتیلی', primary: '#d8c8b8', bg: '#fdfaf8', text: '#625a52', isDark: false },
    { id: 'theme-hydrangea', name: 'گل ادریسی', primary: '#a8b8d8', bg: '#f7f8fc', text: '#4c5363', isDark: false },
    { id: 'theme-gold-filigree', name: 'ملیله‌کاری طلا', primary: '#d4b370', bg: '#fdf8f0', text: '#5f5031', isDark: false },
    { id: 'theme-rococo', name: 'روکوکو', primary: '#f0c0a0', bg: '#fdf8f5', text: '#6b5547', isDark: false },
    { id: 'theme-english-rose', name: 'رز انگلیسی', primary: '#e0a8b8', bg: '#fdf6f8', text: '#654b53', isDark: false },
    { id: 'theme-angel-skin-coral', name: 'مرجان پوست‌فرشته‌ای', primary: '#f4b8a8', bg: '#fef8f6', text: '#68534b', isDark: false },

    { id: 'theme-summer-palace', name: 'کاخ تابستانی', primary: '#f2d8a8', bg: '#fefbf5', text: '#685f4b', isDark: false },
    { id: 'theme-satin-gown', name: 'لباس ساتن', primary: '#c8b0b8', bg: '#faf7f8', text: '#5a4f53', isDark: false },
    { id: 'theme-morganite', name: 'مورگانیت', primary: '#e6b4b4', bg: '#fdf8f8', text: '#685151', isDark: false },
    { id: 'theme-classic-pearl', name: 'مروارید کلاسیک', primary: '#d8d0c8', bg: '#fcfbf9', text: '#625d5a', isDark: false },
    { id: 'theme-gilded-rose', name: 'رز طلاکاری‌شده', primary: '#daa520', bg: '#fdf9e8', text: '#61490d', isDark: false },
    { id: 'theme-ivory-silk', name: 'ابریشم عاجی', primary: '#dcd0c0', bg: '#fdfbf9', text: '#635d55', isDark: false },
    { id: 'theme-celadon-glaze', name: 'لعاب سلادون', primary: '#b3d1b3', bg: '#f8fbf8', text: '#505f50', isDark: false } ]
};

    const STORAGE_KEY = 'goal_tracker_data_v13_ltr';
    const STORAGE_ORDER = 'goal_tracker_order_v13_ltr';
    const STORAGE_ACTIVE_THEME = 'goal_tracker_active_theme_v5';
    const STORAGE_FAVORITE_THEMES = 'goal_tracker_favorite_themes_v1';
const STORAGE_RANDOM_THEME = 'goal_tracker_random_theme_v1';

const WEEKDAY_NAMES_SHORT = ['ش', 'ی', 'د', 'س', 'چ', 'پ', 'ج'];    const JALALI_MONTH_NAMES = ["فروردین", "اردیبهشت", "خرداد", "تیر", "مرداد", "شهریور", "مهر", "آبان", "آذر", "دی", "بهمن", "اسفند"];
        
let appState = {
    currentWeek: getStartOfWeek(new Date()),
    goals: [], 
    order: [], 
    activeThemeId: 'theme-paper', // تغییر به تم کاغذی به عنوان تم اولیه
    editing: null, 
    showArchived: false,
    activeCategory: 'all',
    contextMenuGoalId: null,
    userLight: 'theme-paper', // تم پیش‌فرض برای حالت روشن
    userDark: 'theme-synthwave-84', // تم پیش‌فرض برای حالت تیره
    favoriteThemes: [],
    randomThemeMode: false
};
    function toJalali(gy, gm, gd) { let g_d_m=[0,31,59,90,120,151,181,212,243,273,304,334];let jy=(gy<=1600)?0:979;gy-=(gy<=1600)?621:1600;let gy2=(gm>2)?(gy+1):gy;let days=(365*gy)+(parseInt((gy2+3)/4))-(parseInt((gy2+99)/100))+(parseInt((gy2+399)/400))-80+gd+g_d_m[gm-1];jy+=33*(parseInt(days/12053));days%=12053;jy+=4*(parseInt(days/1461));days%=1461;jy+=parseInt((days-1)/365);if(days>365)days=(days-1)%365;let jm=(days<186)?1+parseInt(days/31):7+parseInt((days-186)/30);let jd=1+((days<186)?(days%31):((days-186)%30));return[jy,jm,jd];}
    function toGregorian(jy, jm, jd) { let gy=(jy<=979)?621:1600;jy-=(jy<=979)?0:979;let days=(365*jy)+(parseInt(jy/33)*8)+(parseInt(((jy%33)+3)/4)) + 78 + jd + ((jm<7)?(jm-1)*31:((jm-7)*30)+186);gy+=400*(parseInt(days/146097));days%=146097;if(days>36524){gy+=100*(parseInt(--days/36524));days%=36524;if(days>=365)days++;}gy+=4*(parseInt(days/1461));days%=1461;gy+=parseInt((days-1)/365);if(days>365)days=(days-1)%365;let gd=days+1;let sal_a=[0,31,((gy%4===0&&gy%100!==0)||(gy%400===0))?29:28,31,30,31,30,31,31,30,31,30,31];let gm;for(gm=0;gm<13&&gd>sal_a[gm];gm++)gd-=sal_a[gm];return new Date(gy,gm-1,gd);}
    function isJalaliLeap(year) { return (((((year-474)%2820)+512)*682)%2816)<682; }
    function jalaliMonthLength(year, month) { if (month<=6) return 31; if (month<=11) return 30; if (isJalaliLeap(year)) return 30; return 29; }
    function toFa(num) { return (''+num).replace(/\d/g, d => '۰۱۲۳۴۵۶۷۸۹'[+d]); }
    function getStartOfWeek(date) { const d = new Date(date); d.setHours(0,0,0,0); const day = d.getDay(); const diff = (day + 1) % 7; d.setDate(d.getDate() - diff); return d; }
    function getWeekDates(base) { return Array.from({length:7}, (_,i) => { const d = new Date(base); d.setDate(base.getDate()+i); return d; }); }
    function formatWeekRange(base) { const week=getWeekDates(base); const startDate=week[0]; const endDate=week[6]; const [startJy, startJm, startJd]=toJalali(startDate.getFullYear(), startDate.getMonth()+1, startDate.getDate()); const [endJy, endJm, endJd]=toJalali(endDate.getFullYear(), endDate.getMonth()+1, endDate.getDate()); if (startJm === endJm) { const startDay=toFa(startJd); const endDay=toFa(endJd); const monthName=JALALI_MONTH_NAMES[startJm - 1]; return `${startDay} – ${endDay} ${monthName}`; } else { const fmt=(d) => d.toLocaleDateString('fa-IR', { month: 'short', day: 'numeric' }); return `${fmt(startDate)} – ${fmt(endDate)}`; }}
    function isToday(date) { const now = new Date(); return date.toDateString() === now.toDateString(); }
   function weekIdForDate(date) {
    const d = getStartOfWeek(date);
    // This creates a reliable YYYY-MM-DD format
    const month = (d.getMonth() + 1).toString().padStart(2, '0');
    const day = d.getDate().toString().padStart(2, '0');
    return `${d.getFullYear()}-${month}-${day}`;
}
    function escapeHtml(txt) { return (''+txt).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g, '&quot;'); }

    function generateDayCellContent(dayData) {
    if (!dayData || !dayData.entries || dayData.entries.length === 0) {
        return '';
    }

    // Count occurrences of each unique emoji
    const emojiCounts = dayData.entries.reduce((acc, emoji) => {
        acc[emoji] = (acc[emoji] || 0) + 1;
        return acc;
    }, {});

    let content = '';
    for (const emoji in emojiCounts) {
        const count = emojiCounts[emoji];
        const isSvg = emoji.startsWith('<svg');
        const emojiDisplay = isSvg 
            ? `<span class="inline-flex items-center justify-center w-8 h-8">${emoji}</span>` 
            : `<span class="text-sm md:text-base">${escapeHtml(emoji)}</span>`;

        // Create a wrapper for each emoji to position the badge correctly
        content += `<div class="emoji-in-cell-wrapper">
                        ${emojiDisplay}
                        ${count > 1 ? `<span class="emoji-counter-badge">${toFa(count)}</span>` : ''}
                    </div>`;
    }
    return `<div class="w-full h-full flex flex-wrap items-center justify-center gap-1.5 leading-none">${content}</div>`;
}

function getDefaultGoals() {
        const creationDate = "2025-07-03T17:13:33.798Z";
        const goals = [
            { id: "default_2", name: "خواندن کتاب", emoji: "📖", days: [true, true, true, true, true, true, true], history: { "2025-6-29": [ { entries:[], note:"" }, { entries:[], note:"" }, { entries:[], note:"" }, { entries:[], note:"" }, { entries:[], note:"" }, { entries:[], note:"" }, { entries:[], note:"" } ] }, type: "binary", archived: false, category: "شخصی", creationDate },
            { id: "1751566854259", name: "رفتن به باشگاه", emoji: "💪", days: [true, true, true, true, true, true, true], history: {}, type: "binary", archived: false, category: "ورزش", creationDate },
            { id: "1751566870084", name: "تمرین موسیقی", emoji: "🎸", days: [true, true, true, true, true, true, true], history: {}, type: "binary", archived: false, category: "شخصی", creationDate },
            { id: "1751566912252", name: "پیاده روی", emoji: "🚶", days: [true, true, true, true, true, true, true], history: {}, type: "binary", archived: false, category: "سلامتی", creationDate },
            { id: "1751566952796", name: "یادگیری آشپزی", emoji: "🍳", days: [true, true, true, true, true, true, true], history: {}, type: "binary", archived: false, category: "کار", creationDate }
        ];
        const order = ["default_2", "1751566854259", "1751566870084", "1751566912252", "1751566952796"];
        return { goals, order };
    }
    // REPLACE THIS FUNCTION
function loadStateFromStorage() {
    const data = localStorage.getItem(STORAGE_KEY);
    const order = localStorage.getItem(STORAGE_ORDER);
    const activeThemeId = localStorage.getItem(STORAGE_ACTIVE_THEME) || 'theme-paper'; // پیش‌فرض اولیه
    const favoriteThemes = localStorage.getItem(STORAGE_FAVORITE_THEMES);
    const randomThemeMode = localStorage.getItem(STORAGE_RANDOM_THEME);

    let goals, orderArr;
    if (data && order) {
        try {
            goals = JSON.parse(data);
            orderArr = JSON.parse(order);
        } catch (e) {
            console.error("Failed to parse localStorage data, resetting to default.", e);
            const defaults = getDefaultGoals();
            goals = defaults.goals;
            orderArr = defaults.order;
        }
    } else {
        const defaults = getDefaultGoals();
        goals = defaults.goals;
        orderArr = defaults.order;
    }
    goals.forEach(g => {
        g.type = g.type || 'binary';
        if (typeof g.archived === 'undefined') g.archived = false;
        if (typeof g.category === 'undefined') g.category = 'شخصی';
        if (typeof g.creationDate === 'undefined') g.creationDate = new Date().toISOString();
        if (g.history) {
            Object.values(g.history).forEach(week => {
                if (Array.isArray(week)) {
                    week.forEach((day, i) => {
                        if (day && typeof day !== 'object') { week[i] = { entries: [day === 1 ? checkmarkSVG : '❌'], note: '' }; }
                        else if (day && !day.entries) { week[i] = { entries: [], note: ''}; }
                    });
                }
            });
        }
    });
    appState.goals = goals;
    appState.order = orderArr.filter(id => goals.some(g => g.id === id));
    appState.activeThemeId = activeThemeId;
    appState.userLight = localStorage.getItem('goal_tracker_user_light_theme') || 'theme-paper'; // پیش‌فرض حالت روشن
    appState.userDark = localStorage.getItem('goal_tracker_user_dark_theme') || 'theme-synthwave-84'; // پیش‌فرض حالت تیره
    
    if (favoriteThemes) {
        appState.favoriteThemes = JSON.parse(favoriteThemes);
    }
    if (randomThemeMode) {
        appState.randomThemeMode = JSON.parse(randomThemeMode);
    }

    if (appState.randomThemeMode) {
        const allThemes = [].concat(...Object.values(themesData));
        if (allThemes.length > 0) {
            const randomTheme = allThemes[Math.floor(Math.random() * allThemes.length)];
            setActiveTheme(randomTheme.id, true);
        }
    }
}

// ADD THESE NEW FUNCTIONS
function addFavoriteTheme(themeId) {
    if (!appState.favoriteThemes.includes(themeId)) {
        appState.favoriteThemes.push(themeId);
        persistState();
    }
}

function removeFavoriteTheme(themeId) {
    appState.favoriteThemes = appState.favoriteThemes.filter(id => id !== themeId);
    persistState();
}

// REPLACE THIS FUNCTION
function persistState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(appState.goals));
    localStorage.setItem(STORAGE_ORDER, JSON.stringify(appState.order));
    localStorage.setItem('goal_tracker_user_light_theme', appState.userLight);
    localStorage.setItem('goal_tracker_user_dark_theme', appState.userDark);
    localStorage.setItem(STORAGE_FAVORITE_THEMES, JSON.stringify(appState.favoriteThemes));
    localStorage.setItem(STORAGE_RANDOM_THEME, JSON.stringify(appState.randomThemeMode));
}
    function setActiveTheme(themeId, fromToggle = false) {
        const theme = findThemeById(themeId);
        if (!theme) return;

        appState.activeThemeId = themeId;
        localStorage.setItem(STORAGE_ACTIVE_THEME, themeId);
        
        if (!fromToggle) {
             if(theme.isDark) {
                appState.userDark = themeId;
            } else {
                appState.userLight = themeId;
            }
        }
        
        applyActiveTheme();
        updateDarkModeToggleState();
    }
    function findThemeById(themeId) {
        for (const category in themesData) {
            const found = themesData[category].find(t => t.id === themeId);
            if (found) return found;
        }
        return themesData.classicDark.find(t => t.id === 'theme-ios-dark'); // Fallback
    }
 // REPLACE the old applyActiveTheme function with this one:
function applyActiveTheme() {
    const theme = findThemeById(appState.activeThemeId);
    const styleEl = document.getElementById('dynamic-theme-style');
    document.documentElement.classList.toggle('dark', theme.isDark);
    const primaryColor = theme.primary.replace('#', '');
    const r = parseInt(primaryColor.substr(0, 2), 16);
    const g = parseInt(primaryColor.substr(2, 2), 16);
    const b = parseInt(primaryColor.substr(4, 2), 16);
    const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
    const primaryTextColor = (yiq >= 128) ? '#000000' : '#ffffff';

    const cardColor = theme.card || (theme.isDark ? `rgba(255, 255, 255, 0.07)` : `#ffffff`);
    const headerColor = theme.header || (theme.isDark ? `${theme.bg}cc` : `#ffffffcc`);
    const cellInactiveColor = theme.cellInactive || (theme.isDark ? 'rgba(255, 255, 255, 0.08)' : '#e5e7eb');
    
    // Logic to handle custom completed cell color
    const completedColor = theme.completedBg ? theme.completedBg : `${theme.primary}20`;
    const darkCompletedColor = theme.completedBg ? theme.completedBg : `${theme.primary}30`;

    styleEl.innerHTML = `
      :root {
        --color-primary: ${theme.primary};
        --color-primary-text: ${primaryTextColor};
        --color-primary-shadow: ${theme.primary}50;
        --color-bg: ${theme.bg};
        --color-text: ${theme.text};
        --color-text-muted: ${theme.isDark ? '#a0a0a0' : '#6b7280'};
        --color-card: ${cardColor};
        --color-header: ${headerColor};
        --color-border: ${theme.isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'};
        --color-hover: ${theme.isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)'};
        --color-cell-inactive: ${cellInactiveColor};
      }
      .day-completed { background-color: ${completedColor} !important; }
      .dark .day-completed { background-color: ${darkCompletedColor} !important; }
    `;
}
    // --- RENDER FUNCTIONS ---
// REPLACE your existing fullRender function
function fullRender() {
    applyActiveTheme();
    renderHeader();
    renderSettingsMenu(); // This call is added
    renderCategoryMenu();
    renderMobileMenu();
    renderGoals();
    initSortable();
    setupCellListeners();
    updateDarkModeToggleState();
    if (appState.editing) {
        setTimeout(() => initEditInput(appState.editing), 30);
    }
}
    function renderHeader() {
        const weekTitleText = formatWeekRange(appState.currentWeek);
        document.getElementById('weekTitle').innerText = weekTitleText;
        document.getElementById('weekTitleMobile').innerText = weekTitleText;

        const today = new Date();
        const formattedDate = today.toLocaleDateString('fa-IR', { weekday: 'long', month: 'long', day: 'numeric' });
        document.getElementById('todayBtn').innerText = `امروز: ${formattedDate}`;
        
        const weekDates = getWeekDates(appState.currentWeek);
        document.getElementById('weekdayRow').innerHTML = weekDates.map((d, i) => {
            const dayNumber = toFa(new Date(d).toLocaleDateString('fa-IR-u-nu-latn', { day: 'numeric' }));
            const dayName = WEEKDAY_NAMES_SHORT[i];
            let classes = "flex flex-col items-center justify-center p-2 rounded-lg transition-colors text-app-text-muted";
            if (isToday(d)) {
                classes = "flex flex-col items-center justify-center p-2 rounded-lg transition-colors bg-primary text-primary-text font-bold shadow-lg";
            }
            return `<div class="${classes}" data-day="${i}"><span class="text-sm font-semibold">${dayName}</span><span class="text-xs mt-1">${dayNumber}</span></div>`;
        }).join('');
    }
    function renderCategoryMenu() {
        const menu = document.getElementById('categoryMenu');
        const filters = ['all', ...Object.keys(CATEGORIES)];
        const catButton = document.getElementById('categoryMenuBtn');
        if(appState.activeCategory !== 'all') { catButton.classList.add('text-primary'); }
        else { catButton.classList.remove('text-primary'); }
                
        let html = filters.map(cat => {
            const isActive = appState.activeCategory === cat;
            const activeClass = 'bg-app-hover font-bold text-primary';
            return `<button data-category="${cat}" class="w-full text-left flex items-center gap-3 p-3 hover:bg-app-hover rounded-lg transition-colors ${isActive ? activeClass : ''}">${cat === 'all' ? 'همه دسته‌بندی‌ها' : cat}</button>`;
        }).join('');
        menu.innerHTML = html;
    }
function renderMobileMenu() {
    const content = document.getElementById('mobileMenuContent');
    const today = new Date();
    const formattedDate = today.toLocaleDateString('fa-IR', { weekday: 'long', month: 'long', day: 'numeric' });
    const weekTitleText = formatWeekRange(appState.currentWeek);

    const filters = ['all', ...Object.keys(CATEGORIES)];
    const catHtml = filters.map(cat => {
        const isActive = appState.activeCategory === cat;
        return `<a href="#" data-category="${cat}" class="mobile-menu-item menu-item-fade-in ${isActive ? 'active' : ''}">
                    <span class="w-2.5 h-2.5 rounded-full ${cat === 'all' ? 'bg-primary' : CATEGORIES[cat]?.split(' ')[0]}"></span>
                    <span>${cat === 'all' ? 'همه دسته‌بندی‌ها' : cat}</span>
                </a>`;
    }).join('');

    const showArchived = appState.showArchived;
    const isDark = findThemeById(appState.activeThemeId).isDark;
    const isRandom = appState.randomThemeMode;

    content.innerHTML = `
        <div class="flex-shrink-0 flex justify-between items-center p-4">
            <div class="flex items-center gap-3">
                <img src="https://i.postimg.cc/4xvMK8zQ/rooza-app-logo-final.png" alt="Rooza Logo" class="w-10 h-10 flex-shrink-0"/>
                <div>
                    <h2 class="text-xl font-bold text-primary">روزا : مدیریت هدف و عادت</h2>
                    <p class="text-sm font-semibold text-app-text-muted mt-1">${formattedDate}</p>
                </div>
            </div>
            <button id="closeMobileMenuBtn" class="p-2 hover:bg-app-hover rounded-full transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <div class="flex-grow overflow-y-auto p-4 space-y-5">
            
            <div class="menu-item-fade-in">
                <div class="menu-section-title" style="margin-top: 0; padding-left: 0.25rem;">ناوبری</div>
                <div class="bg-app-card/50 p-3 rounded-xl">
                    <div class="text-center font-bold text-base text-primary mb-3">${weekTitleText}</div>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="mobile-nextWeekBtn" class="flex items-center justify-center gap-2 p-2 bg-app-hover rounded-lg transition-colors font-semibold text-sm">
                            <span>هفته بعد</span>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                        </button>
                        <button id="mobile-prevWeekBtn" class="flex items-center justify-center gap-2 p-2 bg-app-hover rounded-lg transition-colors font-semibold text-sm">
                             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                             <span>هفته قبل</span>
                        </button>
                    </div>
                </div>
                <a href="#" id="mobile-todayBtn" class="mobile-menu-item w-full mt-2 bg-app-card/50">
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                    <span>رفتن به امروز</span>
                </a>
            </div>
            
            <div class="menu-item-fade-in">
                <div class="menu-section-title" style="padding-left: 0.25rem;">گزارش‌ها</div>
                <div class="bg-app-card/50 rounded-xl">
                    <a href="#" id="mobile-report-day" class="mobile-menu-item">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        <span>گزارش روزانه</span>
                    </a>
                    <a href="#" id="mobile-report-week" class="mobile-menu-item">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2m8-10v10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2z" /></svg>
                        <span>گزارش هفتگی</span>
                    </a>
                    <a href="#" id="mobile-report-month" class="mobile-menu-item">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6z" /></svg>
                        <span>گزارش ماهانه</span>
                    </a>
                    <a href="#" id="mobile-report-year" class="mobile-menu-item">
                         <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                        <span>گزارش سالانه</span>
                    </a>
                </div>
            </div>

            <div class="menu-item-fade-in">
                <div class="menu-section-title" style="padding-left: 0.25rem;">دسته‌بندی‌ها</div>
                <div class="bg-app-card/50 rounded-xl">
                    ${catHtml}
                </div>
            </div>

            <div class="menu-item-fade-in">
                <div class="menu-section-title" style="padding-left: 0.25rem;">تنظیمات و برنامه</div>
                <div class="bg-app-card/50 rounded-xl">
                    <a href="#" id="mobile-archiveToggleBtn" class="mobile-menu-item ${showArchived ? 'text-primary' : ''}">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                        <span>نمایش آرشیو</span>
                    </a>
                    <a href="#" id="mobile-themeSelectorBtn" class="mobile-menu-item">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" /></svg>
                        <span>انتخاب تم</span>
                    </a>
                    <div class="mobile-menu-item">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.783-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>
                        <span>تم تصادفی</span>
                        <label for="randomThemeToggleMobile" class="relative inline-flex items-center cursor-pointer mr-auto">
                            <input type="checkbox" value="" id="randomThemeToggleMobile" class="sr-only peer" ${isRandom ? 'checked' : ''}>
                            <div class="w-11 h-6 bg-app-cell-inactive rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                        </label>
                    </div>
                    <div class="mobile-menu-item">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                        <span>حالت تیره</span>
                        <label for="darkModeToggleMobile" class="relative inline-flex items-center cursor-pointer mr-auto">
                            <input type="checkbox" value="" id="darkModeToggleMobile" class="sr-only peer" ${isDark ? 'checked' : ''}>
                            <div class="w-11 h-6 bg-app-cell-inactive rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                        </label>
                    </div>
                    <a href="#" id="mobile-backupBtn" class="mobile-menu-item">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                        <span>پشتیبان‌گیری و بازیابی</span>
                    </a>
                    <a href="#" id="mobile-aboutBtn" class="mobile-menu-item">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <span>درباره</span>
                    </a>
                </div>
            </div>
        </div>
    `;
}
    function renderGoals() {
        const filteredGoals = appState.order
            .map(id => appState.goals.find(g => g.id === id))
            .filter(Boolean)
            .filter(g => !g.archived && (appState.activeCategory === 'all' || g.category === appState.activeCategory));
        const archivedGoals = appState.goals.filter(g => g && g.archived);
        document.getElementById('goalList').innerHTML = filteredGoals.map(renderSingleGoalCard).join('');
        const archivedContainer = document.getElementById('archivedGoalList');
        if (appState.showArchived && archivedGoals.length > 0) {
            archivedContainer.classList.remove('hidden');
            archivedContainer.querySelector('.flex').innerHTML = archivedGoals.map(renderSingleGoalCard).join('');
        } else {
            archivedContainer.classList.add('hidden');
        }
    }
  function renderSingleGoalCard(goal) {
    const weekDates = getWeekDates(appState.currentWeek);
    const currentWeekId = weekIdForDate(appState.currentWeek);
    const { weekly, allTime } = calculateScores(goal);
    const streak = calculateStreak(goal);

    const dayCellsHtml = weekDates.map((date, i) => {
        const weekDayIndexForData = (i + 6) % 7;
        const isActive = !!goal.days[weekDayIndexForData];
        const dayData = goal.history?.[currentWeekId]?.[weekDayIndexForData] || { entries: [], note: '' };
        const dayCompleted = dayData.entries.length > 0;
        const baseClasses = "goal-day group aspect-square rounded-full flex items-center justify-center relative transition-colors cursor-pointer";
        const activeClasses = "active bg-app-cell-inactive hover:opacity-80";
        const disabledClasses = "bg-app-bg opacity-60 !cursor-not-allowed";
        let classes = `${baseClasses} ${isActive ? activeClasses : disabledClasses}`;
        if(dayCompleted) classes += ' day-completed';
        if (isActive && isToday(date)) classes += ` ring-2 ring-sky-500 shadow-md shadow-sky-500/30`;
        
        // Use the new helper function to generate cell content
        let cellContent = generateDayCellContent(dayData);

        return `<div class="${classes}" data-goal-id="${goal.id}" data-day-index="${weekDayIndexForData}" tabindex="0">${cellContent}${dayData.note ? `<div class="absolute top-0 right-0 w-2 h-2 bg-amber-400 rounded-full" title="${escapeHtml(dayData.note)}"></div>` : ''}</div>`;
    }).join('');

    const statsHtml = `
        <div class="goal-stats-container flex items-center gap-x-2 md:gap-x-3 text-xs font-medium text-app-text-muted whitespace-nowrap">
            <span class="flex items-center gap-1" title="کل"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg><span>${toFa(allTime)}</span></span>
            <span class="flex items-center gap-1" title="استریک"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg><span>${toFa(streak)}</span></span>
            <span class="flex items-center gap-1" title="هفته"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg><span>${toFa(weekly)}</span></span>
        </div>
    `;

    return `<div class="goal-card bg-app-card shadow-md rounded-2xl p-4 goal-anim-in ${goal.archived ? 'opacity-60' : ''}" data-id="${goal.id}">
        <div class="flex items-center gap-3 mb-4">
            <div class="emoji-container text-2xl md:text-3xl">${goal.emoji || '🎯'}</div>
            <div class="flex-grow min-w-0">
                ${appState.editing === goal.id
                   ? `<input class="w-full bg-app-cell-inactive text-base md:text-lg font-bold p-2 rounded-lg outline-none focus:ring-2 focus:ring-primary" id="edit-${goal.id}" name="goal_name_${goal.id}" autocomplete="off" value="${escapeHtml(goal.name)}" />`
                    : `<h3 class="text-base md:text-lg font-bold truncate cursor-pointer hover:text-primary" onclick="showGoalHeatmapModal('${goal.id}')">${escapeHtml(goal.name || 'بی‌نام')}</h3>`
                }
            </div>
            <div class="flex-shrink-0 flex items-center gap-2 md:gap-3 ml-auto">
                ${statsHtml}
                <button onclick="showContextMenu(event, '${goal.id}')" class="text-app-text-muted hover:bg-app-hover rounded-full p-2 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" /></svg>
                </button>
                ${!goal.archived ? `<div class="goal-handle text-app-text-muted cursor-grab p-2 text-xl">&#x2630;</div>`: ''}
            </div>
        </div>
        <div class="grid grid-cols-7 gap-2">${dayCellsHtml}</div>
    </div>`;
}
    // --- CALCULATIONS ---
   function getHistoricalDayInfo(goal, targetDate) {
    const d = new Date(targetDate);
    d.setHours(0, 0, 0, 0);
    const dayIndex = d.getDay();

    const startOfWeekDate = getStartOfWeek(d);
    // Use the exact same reliable YYYY-MM-DD format for reading
    const month = (startOfWeekDate.getMonth() + 1).toString().padStart(2, '0');
    const day = startOfWeekDate.getDate().toString().padStart(2, '0');
    const weekId = `${startOfWeekDate.getFullYear()}-${month}-${day}`;

    const dayData = goal.history?.[weekId]?.[dayIndex];
    const entryCount = dayData?.entries?.length || 0;
    
    return { dayIndex, entryCount };
}
    function getEntryCountOnDate(goal, date) { return getHistoricalDayInfo(goal, date).entryCount; }
function calculateStreak(goal) {
    let streak = 0;
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const isScheduledToday = goal.days[today.getDay()];
    const isCompleteToday = getEntryCountOnDate(goal, today) > 0;

    let dateToCheck = new Date(today);

    if (isScheduledToday && !isCompleteToday) {
        // If scheduled for today but not done, the current streak is 0.
        return 0;
    }
    
    if (!isScheduledToday) {
        // If not scheduled for today, start counting from yesterday.
        dateToCheck.setDate(dateToCheck.getDate() - 1);
    }
    // If it was scheduled and completed today, the count will start from today.

    for (let i = 0; i < 365 * 5; i++) {
        const dayOfWeek = dateToCheck.getDay();
        const isScheduled = goal.days[dayOfWeek];
        
        if (isScheduled) {
            const isComplete = getEntryCountOnDate(goal, dateToCheck) > 0;
            if (isComplete) {
                streak++;
            } else {
                // If it was scheduled but not complete, the streak is broken.
                break;
            }
        }
        // If not scheduled for a given day, we ignore it and continue the streak.
        
        dateToCheck.setDate(dateToCheck.getDate() - 1);
    }
    
    return streak;
}
function calculateScores(goal) {
    let weekly = 0;
    let allTime = 0;
    const currentWeekId = weekIdForDate(appState.currentWeek);

    if (goal.history) {
        for (const weekId in goal.history) {
            const weekData = goal.history[weekId];
            if (!weekData) continue;

            weekData.forEach((dayData) => {
                if (dayData && dayData.entries) {
                    const entryCount = dayData.entries.length;
                    // اضافه کردن به شمارشگر کل
                    allTime += entryCount;
                    // محاسبه آمار هفتگی فقط برای هفته جاری
                    if (weekId === currentWeekId) {
                        weekly += entryCount;
                    }
                }
            });
        }
    }
    return { weekly, allTime };
}
    // --- MODALS & MENUS ---
    function closeModal() { const modalArea=document.getElementById('modalArea'); if (modalArea.lastElementChild) { modalArea.removeChild(modalArea.lastElementChild); } }
    function closeContextMenu() { const menu=document.getElementById('contextMenu'); menu.style.display='none'; appState.contextMenuGoalId=null; }
    function toggleSettingsMenu(visible) { const menu=document.getElementById('settingsMenu'); menu.classList.toggle('visible',visible); if(visible){setTimeout(()=>document.addEventListener('click',closeSettingsMenuOnClickOutside,{once:true}),10);} }
    function closeSettingsMenuOnClickOutside(e) { if (!e.target.closest('#settingsMenu') && !e.target.closest('#settingsMenuBtn') && !e.target.closest('#settingsMenuBtnMobile')) { toggleSettingsMenu(false); } else { document.addEventListener('click', closeSettingsMenuOnClickOutside, { once: true }); } }
    function toggleCategoryMenu(visible) { const menu=document.getElementById('categoryMenu'); menu.classList.toggle('visible',visible); if(visible){setTimeout(()=>document.addEventListener('click',closeCategoryMenuOnClickOutside,{once:true}),10);} }
    function closeCategoryMenuOnClickOutside(e) { if (!e.target.closest('#categoryMenu') && !e.target.closest('#categoryMenuBtn')) { toggleCategoryMenu(false); } else { document.addEventListener('click', closeCategoryMenuOnClickOutside, { once: true }); } }
    
// REPLACE THIS FUNCTION
// REPLACE THIS FUNCTION
function showThemeSelectorModal(options = {}) {
    const { scrollPosition = 0, activeTab: initialActiveTab } = options;
    closeModal();
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4';

    const themeCategories = [
        { key: 'favorites', title: 'مورد علاقه ها' },
        { key: 'modernDark', title: 'مدرن تیره' },
        { key: 'classicDark', title: 'کلاسیک تیره' },
        { key: 'modernLight', title: 'مدرن روشن' },
        { key: 'classicLight', title: 'کلاسیک روشن' }
    ];
    
    const activeTheme = findThemeById(appState.activeThemeId);
    const isCurrentThemeFavorite = appState.favoriteThemes.includes(appState.activeThemeId);
    let activeTabKey = initialActiveTab || 'favorites';

    if (!initialActiveTab) {
        for (const cat of themeCategories) {
            if (cat.key !== 'favorites' && themesData[cat.key] && themesData[cat.key].some(t => t.id === appState.activeThemeId)) {
                activeTabKey = cat.key;
                break;
            }
        }
    }
    
    const renderThemes = (themes) => {
        if (!themes || themes.length === 0) {
            return `<div class="col-span-1 sm:col-span-2 text-center text-app-text-muted p-8">برای افزودن، ستاره ⭐ کنار هر تم را لمس کنید.</div>`;
        }
        return themes.map(theme => {
            const isActive = theme.id === appState.activeThemeId;
            const isFavorite = appState.favoriteThemes.includes(theme.id);
            return `
                <div class="theme-btn-wrapper flex items-center rounded-lg transition-colors ${isActive ? 'bg-primary/20 ring-2 ring-primary' : 'hover:bg-app-hover'}">
                    <button data-theme-id="${theme.id}" class="theme-select-btn flex-grow text-right p-3 flex items-center gap-4">
                        <div class="flex-shrink-0 h-10 w-10 rounded-full flex items-center justify-center" style="background-color:${theme.bg}; border: 2px solid ${theme.primary};">
                            <div class="w-4 h-4 rounded-full" style="background-color: ${theme.text}"></div>
                        </div>
                        <span class="font-semibold">${theme.name}</span>
                        ${isActive ? '<span class="selected-checkmark ml-auto text-primary font-bold">✓</span>' : ''}
                    </button>
                    <button class="favorite-star-btn p-3 text-2xl text-amber-400 hover:opacity-75 transition-opacity" data-theme-id="${theme.id}">
                        ${isFavorite ? '★' : '☆'}
                    </button>
                </div>
            `;
        }).join('');
    }

    const favoriteThemesData = appState.favoriteThemes.map(id => findThemeById(id)).filter(Boolean);

    const tabContentsHtml = themeCategories.map((cat) => {
        const themes = cat.key === 'favorites' ? favoriteThemesData : (themesData[cat.key] || []);
        return `<div id="tab-content-${cat.key}" class="tab-content grid grid-cols-1 sm:grid-cols-2 gap-2 ${cat.key !== activeTabKey ? 'hidden' : ''}">${renderThemes(themes)}</div>`;
    }).join('');

    modal.innerHTML = `
        <div class="modal-content glass-modal-content rounded-2xl p-4 sm:p-6 w-full max-w-4xl max-h-[90vh] flex flex-col shadow-2xl">
            <div class="flex-shrink-0 flex justify-between items-center mb-4">
                <h2 class="text-xl sm:text-2xl font-bold text-app-text" id="theme-modal-title">
                    انتخاب تم: <span class="text-primary">${escapeHtml(activeTheme.name)}</span>
                </h2>
                
                ${!isCurrentThemeFavorite ? `
                  <button id="addCurrentThemeToFavoritesBtn" class="flex items-center gap-2 text-sm font-semibold text-amber-500 hover:text-amber-400 transition-colors ml-auto mr-4">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                    <span>افزودن به علاقه‌مندی</span>
                  </button>
                ` : ''}
                <button class="close-modal-btn text-app-text-muted hover:bg-app-hover rounded-full p-2 transition-colors">&times;</button>
            </div>
            <div id="theme-modal-tabs" class="flex-shrink-0 flex flex-wrap items-center gap-2 p-1 mb-4 bg-app-card rounded-xl">
                ${themeCategories.map(c => `<button data-tab="${c.key}" class="tab-btn flex-1 p-3 font-semibold text-sm rounded-lg transition-colors ${c.key === activeTabKey ? 'bg-primary text-primary-text' : 'text-app-text-muted hover:bg-app-hover'}">${c.title}</button>`).join('')}
            </div>
            <div id="theme-scroll-container" class="flex-grow overflow-y-auto space-y-3 p-1 -ml-2 pl-2">
                ${tabContentsHtml}
            </div>
        </div>`;

    document.getElementById('modalArea').appendChild(modal);
    
    const scrollContainer = document.getElementById('theme-scroll-container');
    if (scrollContainer) scrollContainer.scrollTop = scrollPosition;
    
    modal.onclick = e => { if (e.target === modal || e.target.closest('.close-modal-btn')) closeModal(); };

    modal.querySelectorAll('.tab-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            const tabId = e.currentTarget.dataset.tab;
            modal.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-primary', 'text-primary-text');
                btn.classList.add('text-app-text-muted', 'hover:bg-app-hover');
            });
            e.currentTarget.classList.add('bg-primary', 'text-primary-text');
            e.currentTarget.classList.remove('text-app-text-muted', 'hover:bg-app-hover');
            modal.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            modal.querySelector(`#tab-content-${tabId}`).classList.remove('hidden');
        });
    });

    modal.querySelectorAll('.theme-select-btn').forEach(button => {
        button.addEventListener('click', () => {
            const newThemeId = button.dataset.themeId;
            if (newThemeId === appState.activeThemeId) return;
            setActiveTheme(newThemeId);
            
            // Re-render modal to reflect changes without closing it
            const currentScroll = scrollContainer ? scrollContainer.scrollTop : 0;
            const currentTab = modal.querySelector('.tab-btn.bg-primary')?.dataset.tab;
            showThemeSelectorModal({ scrollPosition: currentScroll, activeTab: currentTab });
        });
    });

    modal.querySelectorAll('.favorite-star-btn').forEach(starButton => {
        starButton.addEventListener('click', (e) => {
            e.stopPropagation();
            const themeId = starButton.dataset.themeId;
            const isFavorite = appState.favoriteThemes.includes(themeId);
            
            if (isFavorite) {
                removeFavoriteTheme(themeId);
            } else {
                addFavoriteTheme(themeId);
            }

            const currentScroll = scrollContainer ? scrollContainer.scrollTop : 0;
            const currentTab = modal.querySelector('.tab-btn.bg-primary')?.dataset.tab;
            showThemeSelectorModal({ scrollPosition: currentScroll, activeTab: currentTab });
        });
    });

    // Add listener for the new button
    const addToFavoritesBtn = modal.querySelector('#addCurrentThemeToFavoritesBtn');
    if (addToFavoritesBtn) {
        addToFavoritesBtn.addEventListener('click', () => {
            addFavoriteTheme(appState.activeThemeId);
            
            // Re-render the modal to show the change (button will disappear, star will be filled)
            const currentScroll = scrollContainer ? scrollContainer.scrollTop : 0;
            const currentTab = modal.querySelector('.tab-btn.bg-primary')?.dataset.tab;
            showThemeSelectorModal({ scrollPosition: currentScroll, activeTab: currentTab });
        });
    }
}
    function showAboutModal() { const modal=document.createElement('div');modal.className='fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4';modal.innerHTML=`<div class="modal-content glass-modal-content rounded-2xl p-6 w-full max-w-md shadow-2xl"><div class="flex flex-col items-center text-center"><div class="w-24 h-24 bg-app-card rounded-3xl flex items-center justify-center mb-5 border border-app-border shadow-md"><img src="https://i.postimg.cc/4xvMK8zQ/rooza-app-logo-final.png" alt="Rooza Logo" class="w-16 h-16"/></div><h2 class="text-2xl font-bold mb-2 text-app-text">روزا (Rooza)</h2><p class="text-base text-app-text-muted mb-6">اپلیکیشن مدیریت عادت و هدف شخصی</p><div class="text-sm text-app-text-muted space-y-2"><p>نسخه 0.121-ltr</p><p>ساخته شده برای کمک به شما در ساختن عادات بهتر.</p><p>کپی رایت 1404 © کدنویسی شده توسط پیمان عابدین پور ${new Date().getFullYear()} - Rooza</p></div><button class="close-modal-btn w-full mt-8 p-3 rounded-lg font-bold bg-primary text-primary-text hover:opacity-90 transition-all">بستن</button></div></div>`;document.getElementById('modalArea').appendChild(modal);modal.onclick=e=>{if(e.target===modal||e.target.closest('.close-modal-btn'))closeModal();};}
    function showBackupModal() { const modal=document.createElement('div');modal.className='fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4';modal.innerHTML=`<div class="modal-content glass-modal-content rounded-2xl p-6 w-full max-w-lg shadow-2xl max-h-[90vh] overflow-y-auto no-scrollbar"><div class="flex justify-between items-center mb-5"><h2 class="text-2xl font-bold text-app-text">پشتیبان‌گیری و بازیابی</h2><button class="close-modal-btn text-app-text-muted hover:bg-app-hover rounded-full p-2 transition-colors">&times;</button></div><div class="space-y-6"><div class="bg-app-card/50 p-5 rounded-xl border border-app-border"><div class="flex items-start gap-4"><div class="flex-shrink-0 w-12 h-12 rounded-full bg-green-500/10 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg></div><div><h3 class="font-bold text-lg text-app-text">خروجی گرفتن اطلاعات</h3><p class="text-sm text-app-text-muted mt-1 mb-4">یک فایل JSON از تمام اهداف و تاریخچه خود دانلود کنید.</p><button id="exportBtn" class="w-full sm:w-auto px-5 py-2.5 rounded-lg font-bold bg-green-600 text-white hover:bg-green-700 transition-colors">دانلود فایل پشتیبان</button></div></div></div><div class="bg-app-card/50 p-5 rounded-xl border border-app-border"><div class="flex items-start gap-4"><div class="flex-shrink-0 w-12 h-12 rounded-full bg-sky-500/10 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-sky-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg></div><div><h3 class="font-bold text-lg text-app-text">ورودی گرفتن اطلاعات</h3><p class="text-sm text-app-text-muted mt-1 mb-4">یک فایل پشتیبان JSON را برای بازیابی اطلاعات خود انتخاب کنید.</p><div class="p-3 mb-4 rounded-lg bg-amber-500/10 border border-amber-500/20 text-amber-600 dark:text-amber-400 text-sm"><strong>هشدار:</strong> این عمل تمام اطلاعات فعلی شما را بازنویسی خواهد کرد.</div><button id="importBtn" class="w-full sm:w-auto px-5 py-2.5 rounded-lg font-bold bg-sky-600 text-white hover:bg-sky-700 transition-colors">انتخاب فایل و بازیابی</button></div></div></div></div><input type="file" id="importFile" class="hidden" accept=".json"></div>`;document.getElementById('modalArea').appendChild(modal);modal.onclick=e=>{if(e.target===modal||e.target.closest('.close-modal-btn'))closeModal();};modal.querySelector('#exportBtn').onclick=exportData;modal.querySelector('#importBtn').onclick=()=>document.getElementById('importFile').click();modal.querySelector('#importFile').onchange=importData;}
    function exportData(){try{const dataToExport={goals:appState.goals,order:appState.order,userLight:appState.userLight,userDark:appState.userDark};const dataStr=JSON.stringify(dataToExport,null,2);const dataBlob=new Blob([dataStr],{type:"application/json"});const url=URL.createObjectURL(dataBlob);const link=document.createElement('a');const today=new Date().toISOString().slice(0,10);link.download=`rooza-backup-${today}.json`;link.href=url;link.click();URL.revokeObjectURL(url);closeModal();}catch(error){console.error("Error exporting data:",error);alert("خطا در خروجی گرفتن اطلاعات.");}}
    function importData(event){const file=event.target.files[0];if(!file)return;if(!confirm("آیا مطمئن هستید؟ با وارد کردن اطلاعات جدید، تمام اطلاعات فعلی شما بازنویسی خواهد شد. این عمل غیرقابل بازگشت است.")){return;}const reader=new FileReader();reader.onload=(e)=>{try{const importedData=JSON.parse(e.target.result);if(importedData&&Array.isArray(importedData.goals)&&Array.isArray(importedData.order)){appState.goals=importedData.goals;appState.order=importedData.order;if(importedData.userLight) appState.userLight = importedData.userLight;if(importedData.userDark) appState.userDark = importedData.userDark;persistState();loadStateFromStorage();fullRender();closeModal();alert("اطلاعات با موفقیت وارد شد.");}else{throw new Error("Invalid file format.");}}catch(error){console.error("Error importing data:",error);alert("خطا در وارد کردن اطلاعات. فایل انتخاب شده معتبر نیست.");}};reader.readAsText(file);}
    // --- ACTIONS & LISTENERS ---
    window.editGoal = (goalId) => { const goal = appState.goals.find(g => g.id === goalId); if(goal) showGoalModal(goal); };
    window.startEdit = (goalId) => { appState.editing = goalId; fullRender(); };
    function handleDarkModeToggle() {
        const currentTheme = findThemeById(appState.activeThemeId);
        if (currentTheme.isDark) {
            setActiveTheme(appState.userLight, true);
        } else {
            setActiveTheme(appState.userDark, true);
        }
        fullRender();
    }
    function updateDarkModeToggleState() {
        const isDark = findThemeById(appState.activeThemeId).isDark;
        const desktopToggle = document.getElementById('darkModeToggle');
        const mobileToggle = document.getElementById('darkModeToggleMobile');
        if (desktopToggle) desktopToggle.checked = isDark;
        if (mobileToggle) mobileToggle.checked = isDark;
    }
   // REPLACE your existing setupGlobalListeners function
function setupGlobalListeners() {
    const mobileMenu = document.getElementById('mobileMenu');

    // --- Menu Opening/Closing Logic ---
    const openMenu = () => {
        document.body.classList.add('mobile-menu-open');
        mobileMenu.classList.remove('translate-x-full');
        
        // Staggering animation for menu items
        const items = mobileMenu.querySelectorAll('.menu-item-fade-in');
        items.forEach((item, index) => {
            item.style.animationDelay = `${index * 0.04}s`;
        });
    };

    const closeMenu = () => {
        document.body.classList.remove('mobile-menu-open');
        mobileMenu.classList.add('translate-x-full');
    };

    document.getElementById('hamburgerBtn').onclick = openMenu;

    // --- Listeners for Desktop Navbar ---
    document.getElementById('navbar').onclick = e => {
        const target = e.target.closest('button');
        if (!target) return;
        switch (target.id) {
            case 'prevWeekBtn': appState.currentWeek.setDate(appState.currentWeek.getDate() - 7); fullRender(); break;
            case 'nextWeekBtn': appState.currentWeek.setDate(appState.currentWeek.getDate() + 7); fullRender(); break;
            case 'settingsMenuBtn': toggleSettingsMenu(!document.getElementById('settingsMenu').classList.contains('visible')); break;
            case 'categoryMenuBtn': toggleCategoryMenu(!document.getElementById('categoryMenu').classList.contains('visible')); break;
            case 'todayBtn': appState.currentWeek = getStartOfWeek(new Date()); fullRender(); break;
            case 'mobileReportsBtn': showReportModal(); break;
        }
    };

    // --- Listeners for Desktop Settings Dropdown ---
    document.getElementById('settingsMenu').addEventListener('click', e => {
        const button = e.target.closest('button');
        if (!button) return;
        switch (button.id) {
            case 'reportBtn': showReportModal(); break;
            case 'archiveToggleBtn': appState.showArchived = !appState.showArchived; button.classList.toggle('text-primary', appState.showArchived); fullRender(); break;
            case 'themeSelectorBtn': showThemeSelectorModal(); break;
            case 'aboutBtn': showAboutModal(); break;
            case 'backupBtn': showBackupModal(); break;
        }
        if (button.id !== 'archiveToggleBtn') toggleSettingsMenu(false);
    });
    
    // --- FAB Listener ---
    document.getElementById('fab').onclick = () => showGoalModal(null);

    // --- Desktop Category Menu Listener ---
    document.getElementById('categoryMenu').addEventListener('click', e => {
        const button = e.target.closest('button[data-category]');
        if (button) {
            appState.activeCategory = button.dataset.category;
            toggleCategoryMenu(false);
            fullRender();
        }
    });

    // --- Mobile Menu Click Handler ---
    mobileMenu.addEventListener('click', e => {
        const target = e.target.closest('a, button');
        if (!target) return;
        
        e.preventDefault(); // Prevent default link behavior
        let shouldClose = true;

        switch (target.id) {
            case 'closeMobileMenuBtn': break;
            case 'mobile-todayBtn': appState.currentWeek = getStartOfWeek(new Date()); fullRender(); break;
            case 'mobile-prevWeekBtn': appState.currentWeek.setDate(appState.currentWeek.getDate() - 7); fullRender(); shouldClose = false; break;
            case 'mobile-nextWeekBtn': appState.currentWeek.setDate(appState.currentWeek.getDate() + 7); fullRender(); shouldClose = false; break;
            case 'mobile-report-day': showReportModal('day'); break;
            case 'mobile-report-week': showReportModal('week'); break;
            case 'mobile-report-month': showReportModal('month'); break;
            case 'mobile-report-year': showReportModal('overall'); break;
            case 'mobile-archiveToggleBtn': appState.showArchived = !appState.showArchived; fullRender(); shouldClose = false; break;
            case 'mobile-themeSelectorBtn': showThemeSelectorModal(); break;
            case 'mobile-backupBtn': showBackupModal(); break;
            case 'mobile-aboutBtn': showAboutModal(); break;
            default: if (!target.dataset.category) shouldClose = false; break;
        }

        if (target.dataset.category) {
            appState.activeCategory = target.dataset.category;
            fullRender();
        }

        if (shouldClose) {
            closeMenu();
        }
    });

    // --- Global Toggles Listener ---
    document.body.addEventListener('change', e => {
        if (e.target.id === 'darkModeToggle' || e.target.id === 'darkModeToggleMobile') {
            handleDarkModeToggle();
        }
        if (e.target.id === 'randomThemeToggle' || e.target.id === 'randomThemeToggleMobile') {
            appState.randomThemeMode = e.target.checked;
            persistState();
            renderSettingsMenu();
            renderMobileMenu();
        }
    });
}
    let sortable = null;
    loadStateFromStorage();
    fullRender();
    setupGlobalListeners();
    setupHeaderSwipe(); // <-- این خط را اضافه کنید
    // --- All other functions (deleteGoal, addCheckmark, showGoalModal etc.) are assumed to be here ---
    function initEditInput(goalId) { const el=document.getElementById('edit-'+goalId);if(!el)return;el.focus();el.select();const saveAndExit=()=>{if(appState.editing!==goalId)return;const goal=appState.goals.find(g=>g.id===goalId);if(goal)goal.name=el.value.trim()||'بی‌نام';persistState();appState.editing=null;fullRender();};el.onblur=saveAndExit;el.onkeydown=(e)=>{if(e.key==="Enter")el.blur();if(e.key==="Escape"){appState.editing=null;fullRender();}};}
    window.duplicateGoal=(goalId)=>{const originalGoal=appState.goals.find(g=>g.id===goalId);if(originalGoal){const newGoal=JSON.parse(JSON.stringify(originalGoal));newGoal.id=''+Date.now();newGoal.name=`${originalGoal.name} (کپی)`;newGoal.history={};newGoal.archived=false;appState.goals.push(newGoal);const originalIndex=appState.order.indexOf(goalId);appState.order.splice(originalIndex+1,0,newGoal.id);persistState();fullRender();}};
    window.toggleArchiveGoal=(goalId)=>{const goal=appState.goals.find(g=>g.id===goalId);if(goal){goal.archived=!goal.archived;persistState();fullRender();}};
    window.deleteGoal=(goalId)=>{const modal=document.createElement('div');modal.className='fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4';modal.innerHTML=`<div class="modal-content bg-app-card rounded-2xl p-5 w-full max-w-sm shadow-2xl text-center"><h3 class="font-bold text-lg mb-2">تایید حذف</h3><p class="text-sm text-app-text-muted mb-6">آیا از حذف این هدف مطمئن هستید؟ این عمل غیرقابل بازگشت است.</p><div class="grid grid-cols-2 gap-4"><button id="cancel-delete" class="p-3 rounded-lg font-bold bg-app-cell-inactive hover:opacity-80 transition">لغو</button><button id="confirm-delete" class="p-3 rounded-lg font-bold bg-red-500 text-white hover:bg-red-600 transition">حذف</button></div></div>`;document.getElementById('modalArea').appendChild(modal);modal.querySelector('#cancel-delete').onclick=closeModal;modal.querySelector('#confirm-delete').onclick=()=>{closeModal();const card=document.querySelector(`.goal-card[data-id="${goalId}"]`);if(card){card.classList.add('goal-anim-out');setTimeout(()=>{appState.goals=appState.goals.filter(g=>g.id!==goalId);appState.order=appState.order.filter(id=>id!==goalId);persistState();fullRender();},300);}else{appState.goals=appState.goals.filter(g=>g.id!==goalId);appState.order=appState.order.filter(id=>id!==goalId);persistState();fullRender();}};};
    function addCheckmark(goalId, dayIndex, cellElement) {
    const goal = appState.goals.find(g => g.id === goalId);
    if (!goal || !goal.days[dayIndex]) return;
    const weekId = weekIdForDate(appState.currentWeek);
    if (!goal.history) goal.history = {};
    if (!goal.history[weekId]) goal.history[weekId] = Array(7).fill(null).map(() => ({ entries: [], note: '' }));
    if (!goal.history[weekId][dayIndex]) goal.history[weekId][dayIndex] = { entries: [], note: '' };
    goal.history[weekId][dayIndex].entries.push(checkmarkSVG);
    persistState();
    const dayData = goal.history[weekId][dayIndex];
    
    // Re-render cell content using the new function
    const noteIndicatorHtml = dayData.note ? `<div class="absolute top-0 right-0 w-2 h-2 bg-amber-400 rounded-full" title="${escapeHtml(dayData.note)}"></div>` : '';
    cellElement.innerHTML = generateDayCellContent(dayData) + noteIndicatorHtml;

    cellElement.classList.add('day-completed');
    cellElement.classList.add('cell-swipe-up');
    cellElement.addEventListener('animationend', () => cellElement.classList.remove('cell-swipe-up'), { once: true });
    updateGoalCardStats(goalId);
}

function removeLastEmoji(goalId, dayIndex, cellElement) {
    const goal = appState.goals.find(g => g.id === goalId);
    if (!goal || !goal.days[dayIndex]) return;
    const weekId = weekIdForDate(appState.currentWeek);
    if (!goal.history?.[weekId]?.[dayIndex]?.entries.length > 0) return;
    goal.history[weekId][dayIndex].entries.pop();
    persistState();
    const dayData = goal.history[weekId][dayIndex];

    // Re-render cell content using the new function
    const noteIndicatorHtml = dayData.note ? `<div class="absolute top-0 right-0 w-2 h-2 bg-amber-400 rounded-full" title="${escapeHtml(dayData.note)}"></div>` : '';
    cellElement.innerHTML = generateDayCellContent(dayData) + noteIndicatorHtml;
    
    if (dayData.entries.length === 0) {
        cellElement.classList.remove('day-completed');
    }
    cellElement.classList.add('cell-shrink');
    cellElement.addEventListener('animationend', () => cellElement.classList.remove('cell-shrink'), { once: true });
    updateGoalCardStats(goalId);
}
    function removeLastEmoji(goalId, dayIndex, cellElement) {
    const goal = appState.goals.find(g => g.id === goalId);
    if (!goal || !goal.days[dayIndex]) return;
    const weekId = weekIdForDate(appState.currentWeek);
    if (!goal.history?.[weekId]?.[dayIndex]?.entries.length > 0) return;

    // Remove the last emoji from the data
    goal.history[weekId][dayIndex].entries.pop();
    persistState();

    const dayData = goal.history[weekId][dayIndex];

    // Re-render the cell's content using the NEW counting logic
    const noteIndicatorHtml = dayData.note ? `<div class="absolute top-0 right-0 w-2 h-2 bg-amber-400 rounded-full" title="${escapeHtml(dayData.note)}"></div>` : '';
    cellElement.innerHTML = generateDayCellContent(dayData) + noteIndicatorHtml;
    
    // If no entries are left, remove the completed background
    if (dayData.entries.length === 0) {
        cellElement.classList.remove('day-completed');
    }
    
    // Trigger the "shrink" animation
    cellElement.classList.add('cell-swipe-down');
    cellElement.addEventListener('animationend', () => cellElement.classList.remove('cell-swipe-down'), { once: true });
    
    // Update the total scores in the header
    updateGoalCardStats(goalId);
}

function setupCellListeners() {
    document.querySelectorAll('.goal-day').forEach(cell => {
        let pressTimer = null;
        let longPressTriggered = false;
        let startY = 0,
            startX = 0;
        let isDragging = false;
        let swipeTriggered = false;
        let hasMoved = false;

        const handlePressStart = (e) => {
            if (cell.classList.contains('!cursor-not-allowed')) return;
            startY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
            startX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
            isDragging = true;
            swipeTriggered = false;
            longPressTriggered = false;
            hasMoved = false;

            pressTimer = setTimeout(() => {
                longPressTriggered = true;
                isDragging = false;
                const {
                    goalId,
                    dayIndex
                } = cell.dataset;
                showDayDetailModal(goalId, parseInt(dayIndex));
                cleanupListeners();
            }, 500);

            document.addEventListener('mousemove', handlePressMove);
            document.addEventListener('touchmove', handlePressMove, {
                passive: false
            });
            document.addEventListener('mouseup', handlePressEnd, {
                once: true
            });
            document.addEventListener('touchend', handlePressEnd, {
                once: true
            });
        };

        const handlePressMove = (e) => {
            if (!isDragging || longPressTriggered || swipeTriggered) return;

            const currentY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
            const currentX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
            const deltaY = currentY - startY;
            const deltaX = currentX - startX;
            const SWIPE_THRESHOLD = 30;

            if (Math.abs(deltaY) > 10 || Math.abs(deltaX) > 10) {
                hasMoved = true;
                clearTimeout(pressTimer);
                if (Math.abs(deltaY) > Math.abs(deltaX)) {
                    e.preventDefault();
                }
            }

            if (Math.abs(deltaY) > SWIPE_THRESHOLD && Math.abs(deltaY) > Math.abs(deltaX)) {
                swipeTriggered = true;
                const {
                    goalId,
                    dayIndex
                } = cell.dataset;
                // Swipe down to add, swipe up to remove.
                if (deltaY > 0) {
                    addCheckmark(goalId, parseInt(dayIndex), cell);
                } else {
                    removeLastEmoji(goalId, parseInt(dayIndex), cell);
                }
                cleanupListeners();
            }
        };

        const handlePressEnd = () => {
            clearTimeout(pressTimer);
            if (isDragging && !longPressTriggered && !swipeTriggered && !hasMoved) {
                const {
                    goalId,
                    dayIndex
                } = cell.dataset;
                showLogModal(goalId, parseInt(dayIndex));
            }
            cleanupListeners();
        };

        const cleanupListeners = () => {
            isDragging = false;
            clearTimeout(pressTimer);
            document.removeEventListener('mousemove', handlePressMove);
            document.removeEventListener('touchmove', handlePressMove);
            document.removeEventListener('mouseup', handlePressEnd);
            document.removeEventListener('touchend', handlePressEnd);
        }

        cell.removeEventListener('mousedown', handlePressStart);
        cell.removeEventListener('touchstart', handlePressStart);
        cell.addEventListener('mousedown', handlePressStart);
        cell.addEventListener('touchstart', handlePressStart, {
            passive: false
        });
    });
}


    function initSortable(){if(sortable)sortable.destroy();const list=document.getElementById('goalList');if(!list)return;sortable=Sortable.create(list,{handle:'.goal-handle',animation:200,ghostClass:'sortable-ghost',onEnd:(evt)=>{appState.order=Array.from(evt.to.children).map(card=>card.dataset.id);persistState();}});}

    showGoalModal = (goal) => {
    const isEdit = !!goal;
    const draft = isEdit ? JSON.parse(JSON.stringify(goal)) : { id: '' + Date.now(), name: '', emoji: '🎯', days: Array(7).fill(true), history: {}, type: 'binary', archived: false, category: 'شخصی', creationDate: new Date().toISOString() };
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/30 backdrop-blur-sm z-[100] flex items-end justify-center';
    modal.innerHTML = `<div class="modal-content bg-app-bg rounded-t-2xl p-4 w-full max-w-lg pb-[calc(env(safe-area-inset-bottom)+1rem)] shadow-2xl"><h2 class="text-xl font-bold text-center mb-6 text-primary">${isEdit?'ویرایش هدف':'هدف جدید'}</h2><div class="space-y-4"><div class="flex gap-4"><div class="flex-grow"><label for="goalName" class="font-semibold mb-2 block text-sm">نام هدف</label><input type="text" id="goalName" value="${escapeHtml(draft.name)}" placeholder="مثلا: ورزش روزانه" class="w-full p-3 bg-app-card rounded-lg border border-app-border focus:ring-2 focus:ring-primary outline-none transition" autocomplete="off"></div><div><label for="goalEmoji" class="font-semibold mb-2 block text-sm">ایموجی</label><input type="text" id="goalEmoji" value="${draft.emoji}" maxlength="2" class="w-20 text-center p-3 bg-app-card rounded-lg border border-app-border focus:ring-2 focus:ring-primary outline-none transition" autocomplete="off"></div></div><div><label class="font-semibold mb-2 block text-sm">دسته‌بندی</label><select id="goalCategory" class="w-full p-3 bg-app-card rounded-lg border border-app-border focus:ring-2 focus:ring-primary outline-none transition">${Object.keys(CATEGORIES).map(cat=>`<option value="${cat}" ${draft.category===cat?'selected':''}>${cat}</option>`).join('')}</select></div><div><label class="font-semibold mb-2 block text-sm">روزهای فعال</label><div class="grid grid-cols-7 gap-2 rounded-lg bg-app-cell-inactive p-1 weekday-toggle-row">${WEEKDAY_NAMES_SHORT.map((d, i) => {
        const dataIndex = (i + 6) % 7; // Convert visual index (Sat=0) to data index (Sun=0)
        return `<div class="weekday-toggle text-center font-bold p-2 rounded-md cursor-pointer transition-colors ${draft.days[dataIndex] ? 'bg-primary text-primary-text' : 'hover:bg-app-hover'}" data-day="${dataIndex}">${d}</div>`;
    }).join('')}</div></div></div><div class="grid grid-cols-2 gap-4 mt-8"><button class="action-btn-cancel w-full p-4 rounded-lg font-bold bg-app-cell-inactive hover:opacity-80 transition">لغو</button><button id="saveGoalBtn" class="w-full p-4 rounded-lg font-bold bg-primary text-primary-text hover:opacity-90 transition">${isEdit ? 'ذخیره' : 'افزودن'}</button></div></div>`;
    document.getElementById('modalArea').appendChild(modal);
    document.getElementById('goalName').focus();
    modal.onclick = e => { if (e.target === modal) closeModal(); };
    modal.querySelector('.action-btn-cancel').onclick = closeModal;
    modal.querySelectorAll('.weekday-toggle').forEach(toggle => {
        toggle.onclick = () => {
            const day = parseInt(toggle.dataset.day); // This is already the correct data index (Sun=0)
            draft.days[day] = !draft.days[day];
            toggle.classList.toggle('bg-primary');
            toggle.classList.toggle('text-primary-text');
        };
    });
    modal.querySelector('#saveGoalBtn').onclick = () => {
        draft.name = modal.querySelector('#goalName').value.trim();
        draft.emoji = modal.querySelector('#goalEmoji').value;
        draft.category = modal.querySelector('#goalCategory').value;
        draft.type = 'binary';
        if (isEdit) {
            const index = appState.goals.findIndex(g => g.id === goal.id);
            if (index > -1) appState.goals[index] = draft;
        } else {
            appState.goals.push(draft);
            appState.order.push(draft.id);
        }
        persistState();
        closeModal();
        fullRender();
    };
};

    showLogModal = (goalId,dayIndex)=>{const goal=appState.goals.find(g=>g.id===goalId);if(!goal||!goal.days[dayIndex])return;const weekId=weekIdForDate(appState.currentWeek);if(!goal.history)goal.history={};if(!goal.history[weekId])goal.history[weekId]=Array(7).fill(null).map(()=>({entries:[],note:''}));if(!goal.history[weekId][dayIndex])goal.history[weekId][dayIndex]={entries:[],note:''};const dayData=goal.history[weekId][dayIndex];const modal=document.createElement('div');modal.className='fixed inset-0 bg-black/30 backdrop-blur-sm z-[100] flex items-end justify-center';const renderEntriesInModal=(container)=>{const listHtml=dayData.entries.map((entry,i)=>{const content=entry.startsWith('<svg')?`<span class="w-6 h-6 inline-block">${entry}</span>`:escapeHtml(entry);return`<div class="flex items-center justify-between gap-1 bg-app-cell-inactive rounded-lg px-2 py-1 text-sm"><span>${content}</span><button data-index="${i}" class="delete-entry-btn text-red-500 hover:text-red-700 font-bold text-lg">&times;</button></div>`;}).join('');container.innerHTML=listHtml||`<span class="text-app-text-muted text-sm p-2">موردی ثبت نشده</span>`;};modal.innerHTML=`<div class="modal-content bg-app-bg rounded-t-2xl p-4 w-full max-w-lg pb-[calc(env(safe-area-inset-bottom)+1rem)] shadow-2xl"><h2 class="text-xl font-bold text-center mb-4 truncate">${goal.name}</h2><div class="space-y-4"><div><label class="font-semibold mb-2 block text-sm">موارد ثبت شده امروز</label><div id="entries-list" class="flex flex-wrap gap-2 min-h-[40px] bg-app-card p-2 rounded-lg border border-app-border"></div></div><div><label class="font-semibold mb-2 block text-sm">ثبت ایموجی</label><div class="emoji-grid grid grid-cols-7 gap-2 text-3xl">${EMOJIS.map(em=>{const content=em.startsWith('<svg')?`<span class="w-8 h-8 inline-block">${em}</span>`:escapeHtml(em);return`<button class="emoji-btn text-center rounded-lg p-2 hover:bg-app-hover transition-transform active:scale-125 focus:outline-none focus:ring-2 focus:ring-primary">${content}</button>`;}).join('')}</div></div><div><label for="note-input" class="font-semibold mb-2 block text-sm">یادداشت</label><textarea id="note-input" class="w-full p-3 bg-app-card rounded-lg border border-app-border focus:ring-2 focus:ring-primary outline-none transition" rows="2" placeholder="یادداشت امروز...">${escapeHtml(dayData.note)}</textarea></div></div><div class="mt-8"><button class="action-btn-done w-full p-4 rounded-lg font-bold bg-primary text-primary-text hover:opacity-90 transition">انجام شد</button></div></div>`;document.getElementById('modalArea').appendChild(modal);const entriesList=modal.querySelector('#entries-list');renderEntriesInModal(entriesList);const saveAndClose=()=>{goal.history[weekId][dayIndex].note=modal.querySelector('#note-input').value;persistState();fullRender();closeModal();};modal.onclick=e=>{if(e.target===modal)saveAndClose();};modal.querySelector('.action-btn-done').onclick=saveAndClose;const updateData=()=>{persistState();renderEntriesInModal(entriesList);updateGoalCardStats(goalId);};entriesList.addEventListener('click',e=>{if(e.target.classList.contains('delete-entry-btn')){const index=parseInt(e.target.dataset.index);dayData.entries.splice(index,1);updateData();}});modal.querySelectorAll('.emoji-btn').forEach((btn,index)=>{btn.onclick=()=>{dayData.entries.push(EMOJIS[index]);updateData();};});}
    showDayDetailModal = (goalId,dayIndex)=>{const goal=appState.goals.find(g=>g.id===goalId);if(!goal)return;const weekDates=getWeekDates(appState.currentWeek);const date=weekDates[dayIndex];const weekId=weekIdForDate(appState.currentWeek);const dayData=goal.history?.[weekId]?.[dayIndex]||{entries:[],note:''};const modal=document.createElement('div');modal.className='fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4';const formattedDate=date.toLocaleDateString('fa-IR',{weekday:'long',month:'long',day:'numeric'});const entriesHtml=dayData.entries.length>0?dayData.entries.map(entry=>{if(entry.startsWith('<svg')){return`<span class="inline-block align-middle w-8 h-8">${entry}</span>`;}return`<span class="text-2xl">${escapeHtml(entry)}</span>`;}).join(''):'<span class="text-sm text-app-text-muted">موردی ثبت نشده</span>';const noteHtml=dayData.note?`<p class="text-sm bg-amber-500/10 p-3 rounded-lg">${escapeHtml(dayData.note)}</p>`:'<span class="text-sm text-app-text-muted">یادداشتی وجود ندارد</span>';modal.innerHTML=`<div class="modal-content bg-app-card rounded-2xl p-5 w-full max-w-sm shadow-2xl"><h3 class="font-bold text-lg text-primary mb-2">${escapeHtml(goal.name)}</h3><p class="text-sm text-app-text-muted font-semibold mb-4">${formattedDate}</p><div class="space-y-4"><div><h4 class="font-semibold text-sm mb-2">موارد ثبت شده</h4><div class="flex flex-wrap gap-3 items-center min-h-[40px] bg-app-bg p-3 rounded-lg">${entriesHtml}</div></div><div><h4 class="font-semibold text-sm mb-2">یادداشت</h4><div class="min-h-[40px]">${noteHtml}</div></div></div><button class="close-modal-btn w-full mt-6 p-3 rounded-lg font-bold bg-app-cell-inactive hover:opacity-80 transition">بستن</button></div>`;document.getElementById('modalArea').appendChild(modal);modal.onclick=e=>{if(e.target===modal||e.target.classList.contains('close-modal-btn'))closeModal();};}
    showContextMenu=(e,goalId)=>{e.preventDefault();e.stopPropagation();if(appState.contextMenuGoalId===goalId){closeContextMenu();return;}closeContextMenu();const goal=appState.goals.find(g=>g.id===goalId);if(!goal)return;const menu=document.getElementById('contextMenu');menu.innerHTML=`<button onclick="editGoal('${goalId}')" class="w-full text-left flex items-center gap-3 p-3 hover:bg-app-hover rounded-lg">✏️ <span>ویرایش</span></button><button onclick="duplicateGoal('${goalId}')" class="w-full text-left flex items-center gap-3 p-3 hover:bg-app-hover rounded-lg">🗂️ <span>کپی</span></button><button onclick="toggleArchiveGoal('${goalId}')" class="w-full text-left flex items-center gap-3 p-3 hover:bg-app-hover rounded-lg">${goal.archived?'📂 <span>لغو آرشیو</span>':'🗄️ <span>آرشیو</span>'}</button><div class="my-1 h-px bg-app-border"></div><button onclick="deleteGoal('${goalId}')" class="w-full text-left flex items-center gap-3 p-3 text-red-500 hover:bg-red-500/10 rounded-lg">🗑️ <span>حذف</span></button>`;menu.style.display='block';const rect=menu.getBoundingClientRect();let left=e.clientX;let top=e.clientY;if(left+rect.width>window.innerWidth-10){left=window.innerWidth-rect.width-10;}if(top+rect.height>window.innerHeight-10){top=window.innerHeight-rect.height-10;}menu.style.left=`${left}px`;menu.style.top=`${top}px`;appState.contextMenuGoalId=goalId;setTimeout(()=>document.addEventListener('click',closeContextMenu,{once:true}),10);};
function updateGoalCardStats(goalId) {
    const goal = appState.goals.find(g => g.id === goalId);
    if (!goal) return;
    const card = document.querySelector(`.goal-card[data-id="${goalId}"]`);
    if (!card) return;

    // محاسبه مجدد تمام آمار
    const { weekly, allTime } = calculateScores(goal);
    const streak = calculateStreak(goal);

    // ساختار HTML داخلی آمار
    const statsInnerHtml = `
        <span class="flex items-center gap-1" title="کل"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg><span>${toFa(allTime)}</span></span>
        <span class="flex items-center gap-1" title="استریک"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg><span>${toFa(streak)}</span></span>
        <span class="flex items-center gap-1" title="هفته"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg><span>${toFa(weekly)}</span></span>
    `;

    // پیدا کردن و به‌روزرسانی بخش آمار
    const statsContainer = card.querySelector('.goal-stats-container');
    if (statsContainer) {
        statsContainer.innerHTML = statsInnerHtml;
    }
}
    //report
    

// ADD THESE THREE NEW FUNCTIONS TO YOUR SCRIPT

/**
 * Calculates the total number of completions for each day of the week for a specific goal.
 * @param {string} goalId The ID of the goal.
 * @returns {number[]} An array of 7 numbers representing total completions from Sunday to Saturday.
 */
function calculateWeekdayTotals(goalId) {
    const goal = appState.goals.find(g => g.id === goalId);
    if (!goal || !goal.history) return Array(7).fill(0);

    const totals = Array(7).fill(0); // [Sun, Mon, Tue, Wed, Thu, Fri, Sat]

    for (const weekId in goal.history) {
        const weekData = goal.history[weekId];
        if (weekData) {
            weekData.forEach((dayData, dayIndex) => {
                if (dayData && dayData.entries.length > 0) {
                    // dayIndex is 0 for Sunday, 1 for Monday, etc.
                    totals[dayIndex] += dayData.entries.length;
                }
            });
        }
    }
    return totals;
}

/**
 * Renders a yearly heatmap for a single goal inside a container.
 * @param {HTMLElement} container The element to render the heatmap into.
 * @param {object} goal The goal object.
 * @param {number} jYear The Jalali year to display.
 * @param {number[]} weekdayTotals Pre-calculated totals for each day of the week.
 */
function renderGoalHeatmap(container, goal, jYear, weekdayTotals) {
    const completionsByJalaliDate = {};
    if (goal.history) {
        for (const weekId in goal.history) {
            const weekStartDate = new Date(weekId.replace(/-/g, '/'));
            goal.history[weekId].forEach((dayData, dayIndex) => {
                if (dayData && dayData.entries.length > 0) {
                    const date = new Date(weekStartDate);
                    date.setDate(date.getDate() + dayIndex);
                    const [jy, jm, jd] = toJalali(date.getFullYear(), date.getMonth() + 1, date.getDate());
                    if (jy === jYear) {
                        const jDateStr = `${jy}-${jm}-${jd}`;
                        completionsByJalaliDate[jDateStr] = (completionsByJalaliDate[jDateStr] || 0) + dayData.entries.length;
                    }
                }
            });
        }
    }

    const maxCompletions = Math.max(1, ...Object.values(completionsByJalaliDate));
    const theme = findThemeById(appState.activeThemeId);
    
    const getDayStyle = (count) => {
        if (!count || count === 0) {
            return { bg: 'bg-app-cell-inactive opacity-75', text: '' };
        }
        const intensity = Math.min(count / maxCompletions, 1.0);
        if (theme.isDark) {
            if (intensity < 0.25) return { bg: 'bg-emerald-900', text: 'text-emerald-200' };
            if (intensity < 0.5) return { bg: 'bg-emerald-700', text: 'text-emerald-100' };
            if (intensity < 0.75) return { bg: 'bg-emerald-500', text: 'text-black' };
            return { bg: 'bg-emerald-300', text: 'text-black font-bold' };
        } else {
            if (intensity < 0.25) return { bg: 'bg-green-200', text: 'text-green-900' };
            if (intensity < 0.5) return { bg: 'bg-green-400', text: 'text-green-900' };
            if (intensity < 0.75) return { bg: 'bg-green-600', text: 'text-white' };
            return { bg: 'bg-green-800', text: 'text-white font-bold' };
        }
    };

    const weekdayHeaders = WEEKDAY_NAMES_SHORT.map((dayName, index) => {
        const dataIndex = (index + 6) % 7; // Map visual index (Sat=0) to data index (Sun=0)
        const count = weekdayTotals[dataIndex];
        if (count > 0) {
            return `<div class="relative flex items-center justify-center">
                        ${dayName}
                        <span class="absolute -top-1.5 -right-1.5 text-[9px] font-bold bg-primary/80 text-primary-text rounded-full w-4 h-4 flex items-center justify-center leading-none">${toFa(count)}</span>
                    </div>`;
        }
        return `<div>${dayName}</div>`;
    }).join('');

    let html = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-6">`;
    for (let jm = 1; jm <= 12; jm++) {
        const monthLength = jalaliMonthLength(jYear, jm);
        const firstGregorianDate = toGregorian(jYear, jm, 1);
        const startOffset = (firstGregorianDate.getDay() + 1) % 7; // Adjusted for Sat start
        
        let monthHtml = `<div class="p-3 bg-app-bg rounded-lg">
            <h4 class="font-semibold text-center text-sm mb-2">${JALALI_MONTH_NAMES[jm-1]}</h4>
            <div class="grid grid-cols-7 gap-1 text-center text-[10px] text-app-text-muted mb-1.5">
               ${weekdayHeaders}
            </div>
            <div class="grid grid-cols-7 gap-1.5 text-xs">`;
        
        for (let i = 0; i < startOffset; i++) { monthHtml += '<div></div>'; }
        for (let jd = 1; jd <= monthLength; jd++) {
            const jDateStr = `${jYear}-${jm}-${jd}`;
            const count = completionsByJalaliDate[jDateStr] || 0;
            const gDate = toGregorian(jYear, jm, jd);
            
            const style = getDayStyle(count);
            const todayClass = isToday(gDate) ? 'ring-2 ring-primary' : '';
            const title = `${toFa(jd)} ${JALALI_MONTH_NAMES[jm-1]} ${toFa(jYear)}: ${toFa(count)} مورد`;

            monthHtml += `<div onclick="showDailySummaryModal(${jYear}, ${jm}, ${jd})" class="heatmap-day aspect-square rounded-sm flex items-center justify-center cursor-pointer transition-colors ${style.bg} ${style.text} ${todayClass}" title="${title}">${toFa(jd)}</div>`;
        }
        monthHtml += `</div></div>`;
        html += monthHtml;
    }
    html += `</div>`;
    container.innerHTML = html;
}
/**
 * Creates and displays the goal-specific heatmap modal.
 * @param {string} goalId The ID of the goal to display.
 */
function showGoalHeatmapModal(goalId) {
    const goal = appState.goals.find(g => g.id === goalId);
    if (!goal) return;

    let currentYearDate = new Date();
    const weekdayTotals = calculateWeekdayTotals(goalId);

    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4';
    
    modal.innerHTML = `
        <div class="modal-content glass-modal-content rounded-2xl p-4 sm:p-6 w-full max-w-4xl max-h-[90vh] flex flex-col shadow-2xl">
            <div class="flex-shrink-0 flex justify-between items-center mb-4">
                <div class="flex items-center gap-3">
                    <span class="text-3xl">${goal.emoji}</span>
                    <h2 class="text-xl sm:text-2xl font-bold text-app-text">${escapeHtml(goal.name)}</h2>
                </div>
                <button class="close-modal-btn text-app-text-muted hover:bg-app-hover rounded-full p-2 transition-colors">&times;</button>
            </div>
            <div class="flex-shrink-0 flex items-center justify-center gap-2 mb-4">
                 <button id="heatmap-prev-btn" aria-label="Previous Year" class="p-2 rounded-full hover:bg-app-hover transition-colors">
                     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <div id="heatmap-date-display" class="w-36 text-center font-bold text-primary"></div>
                <button id="heatmap-next-btn" aria-label="Next Year" class="p-2 rounded-full hover:bg-app-hover transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>
            <div id="goal-heatmap-content" class="flex-grow overflow-y-auto p-1 -ml-2 pl-2 no-scrollbar"></div>
        </div>
    `;

    document.getElementById('modalArea').appendChild(modal);
    modal.onclick = e => { if (e.target === modal || e.target.closest('.close-modal-btn')) closeModal(); };

    const contentArea = modal.querySelector('#goal-heatmap-content');
    const dateDisplay = modal.querySelector('#heatmap-date-display');
    
    function updateView() {
        const [jYear] = toJalali(currentYearDate.getFullYear(), currentYearDate.getMonth() + 1, currentYearDate.getDate());
        dateDisplay.innerText = `سال ${toFa(jYear)}`;
        renderGoalHeatmap(contentArea, goal, jYear, weekdayTotals);
    }

    modal.querySelector('#heatmap-prev-btn').onclick = () => {
        currentYearDate.setFullYear(currentYearDate.getFullYear() - 1);
        updateView();
    };
    modal.querySelector('#heatmap-next-btn').onclick = () => {
        currentYearDate.setFullYear(currentYearDate.getFullYear() + 1);
        updateView();
    };

    updateView(); // Initial render
}




    //end
   //report
 function showReportModal(initialView = 'month') {
    let currentReportDate = new Date();
    let currentReportView = initialView; // 'day', 'week', 'month', 'overall'
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4';
    modal.innerHTML = `
        <div class="modal-content glass-modal-content rounded-2xl p-4 sm:p-6 w-full max-w-4xl max-h-[90vh] flex flex-col shadow-2xl">
            <div class="flex-shrink-0 flex justify-between items-center mb-4">
                <h2 class="text-xl sm:text-2xl font-bold text-app-text">گزارش پیشرفت</h2>
                <button class="close-modal-btn text-app-text-muted hover:bg-app-hover rounded-full p-2 transition-colors">&times;</button>
            </div>
            <div class="flex-shrink-0 flex flex-col sm:flex-row items-center justify-between gap-4 mb-4">
                <div id="report-tabs" class="w-full sm:w-auto flex flex-wrap items-center justify-center gap-2 bg-app-card/50 p-1 rounded-xl">
                    <button data-view="day" class="report-tab-btn px-4 py-2 text-sm font-semibold rounded-lg">روزانه</button>
                    <button data-view="week" class="report-tab-btn px-4 py-2 text-sm font-semibold rounded-lg">هفتگی</button>
                    <button data-view="month" class="report-tab-btn px-4 py-2 text-sm font-semibold rounded-lg">ماهانه</button>
                    <button data-view="overall" class="report-tab-btn px-4 py-2 text-sm font-semibold rounded-lg">سالیانه</button>
                </div>
                <div class="flex items-center gap-2">
                    <button id="report-prev-btn" aria-label="Previous" class="p-2 rounded-full hover:bg-app-hover transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <div id="report-date-display" class="w-36 text-center font-bold text-primary"></div>
                    <button id="report-next-btn" aria-label="Next" class="p-2 rounded-full hover:bg-app-hover transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                </div>
            </div>
            <div id="report-content" class="flex-grow overflow-y-auto space-y-3 p-1 -ml-2 pl-2 no-scrollbar"></div>
        </div>`;
    document.getElementById('modalArea').appendChild(modal);
    modal.onclick = e => { if (e.target === modal || e.target.closest('.close-modal-btn')) closeModal(); };
    const tabs = modal.querySelector('#report-tabs');
    const contentArea = modal.querySelector('#report-content');
    const dateDisplay = modal.querySelector('#report-date-display');
    const prevBtn = modal.querySelector('#report-prev-btn');
    const nextBtn = modal.querySelector('#report-next-btn');
    function updateReportView() {
        renderReportContent(contentArea, dateDisplay, currentReportView, currentReportDate);
        tabs.querySelectorAll('.report-tab-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.view === currentReportView);
        });
    }
    tabs.addEventListener('click', e => {
        const button = e.target.closest('.report-tab-btn');
        if (button) {
            currentReportView = button.dataset.view;
            currentReportDate = new Date();
            updateReportView();
        }
    });
    const navigate = (direction) => {
        if (currentReportView === 'day') currentReportDate.setDate(currentReportDate.getDate() + direction);
        else if (currentReportView === 'week') currentReportDate.setDate(currentReportDate.getDate() + (7 * direction));
        else if (currentReportView === 'month') currentReportDate.setMonth(currentReportDate.getMonth() + direction);
        else if (currentReportView === 'overall') currentReportDate.setFullYear(currentReportDate.getFullYear() + direction);
        updateReportView();
    };
    prevBtn.addEventListener('click', () => navigate(-1));
    nextBtn.addEventListener('click', () => navigate(1));
    updateReportView(); // Initial render
}
    function renderReportContent(container, dateDisplay, view, date) {
        const goals = appState.goals.filter(g => !g.archived);
        if (goals.length === 0) {
            container.innerHTML = `<div class="text-center text-slate-500 p-8">هیچ عادت فعالی برای گزارش وجود ندارد.</div>`;
            dateDisplay.innerText = '-';
            return;
        }
        if (view === 'overall') {
            const [jYear] = toJalali(date.getFullYear(), date.getMonth() + 1, date.getDate());
            dateDisplay.innerText = `سال ${toFa(jYear)}`;
            renderOverallReport(container, jYear);
            return;
        }
        let startDate, endDate, dateLabel = '';
        if (view === 'day') {
            startDate = new Date(date); startDate.setHours(0,0,0,0);
            endDate = new Date(date); endDate.setHours(23,59,59,999);
            dateLabel = date.toLocaleDateString('fa-IR', { year: 'numeric', month: 'long', day: 'numeric' });
        } else if (view === 'week') {
            startDate = getStartOfWeek(date);
            endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
            endDate.setHours(23,59,59,999);
            dateLabel = formatWeekRange(startDate);
        } else { // month
            const [jYear, jMonth] = toJalali(date.getFullYear(), date.getMonth() + 1, date.getDate());
            startDate = toGregorian(jYear, jMonth, 1);
            const monthLen = jalaliMonthLength(jYear, jMonth);
            endDate = toGregorian(jYear, jMonth, monthLen);
            endDate.setHours(23,59,59,999);
            dateLabel = startDate.toLocaleDateString('fa-IR', { year: 'numeric', month: 'long' });
        }
        dateDisplay.innerText = dateLabel;
        let reportHtml = '';
        goals.forEach(goal => {
            let totalCompletions = 0;
            let totalTarget = 0;
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dayIndex = d.getDay(); // Sunday is 0
                if (goal.days[dayIndex]) {
                    totalTarget++;
                    totalCompletions += getEntryCountOnDate(goal, d);
                }
            }
            const percentage = totalTarget > 0 ? Math.round((totalCompletions / totalTarget) * 100) : 0;
            const streak = calculateStreak(goal);
            reportHtml += `
                <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${goal.emoji}</span>
                            <span class="font-bold text-slate-700 dark:text-slate-200">${escapeHtml(goal.name)}</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center flex-wrap gap-x-4 gap-y-2 text-sm font-semibold text-slate-500 dark:text-slate-400 mb-2">
                        <span>تکمیل دوره: ${toFa(totalCompletions)} / ${toFa(totalTarget)}</span>
                        <div class="flex items-center gap-1 text-amber-500" title="استریک فعلی">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" /></svg>
                            <span class="font-bold">${toFa(streak)}</span>
                        </div>
                        <span class="font-bold text-indigo-500">${toFa(percentage)}٪</span>
                    </div>
                    <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5">
                        <div class="bg-indigo-600 h-2.5 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                </div>
            `;
        });
        container.innerHTML = reportHtml;
    }
    function renderOverallReport(container, jYear) {
        const { totalCompletions, busiestDay } = calculateOverallStats();
        const statsHtml = `
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                <div class="stat-card">
                    <div class="stat-value">${toFa(totalCompletions)}</div>
                    <div class="stat-label">مجموع عملکرد</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${busiestDay}</div>
                    <div class="stat-label">فعال‌ترین روز</div>
                </div>
            </div>`;
        const heatmapContainerId = `yearly-heatmap-${jYear}`;
        container.innerHTML = statsHtml + `<div id="${heatmapContainerId}" class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm"></div>`;
        renderYearlyHeatmap(document.getElementById(heatmapContainerId), jYear);
    }
    function calculateOverallStats() {
        let totalCompletions = 0;
        const dayCounts = [0, 0, 0, 0, 0, 0, 0]; // Sun, Mon, Tue, Wed, Thu, Fri, Sat
        const goals = appState.goals.filter(g => !g.archived);
        goals.forEach(goal => {
            if (goal.history) {
                 Object.values(goal.history).forEach(weekData => {
                     if (weekData) {
                         weekData.forEach((dayData, dayIndex) => {
                            if (dayData && dayData.entries.length > 0) {
                                 totalCompletions += dayData.entries.length;
                                 dayCounts[dayIndex] += dayData.entries.length;
                            }
                         });
                     }
                 });
            }
        });
        const busiestDayIndex = dayCounts.indexOf(Math.max(...dayCounts));
        const dayNames = ['یکشنبه', 'دوشنبه', 'سه‌شنبه', 'چهارشنبه', 'پنجشنبه', 'جمعه', 'شنبه'];
        const busiestDay = totalCompletions > 0 ? dayNames[busiestDayIndex] : '-';
        return { totalCompletions, busiestDay };
    }
   function renderYearlyHeatmap(container, jYear) {
    const completionsByJalaliDate = {};
    appState.goals.filter(g => !g.archived).forEach(goal => {
        if(goal.history) {
            for(const weekId in goal.history) {
                const weekStartDate = new Date(weekId.replace(/-/g, '/'));
                goal.history[weekId].forEach((dayData, dayIndex) => {
                    if (dayData && dayData.entries.length > 0) {
                        const date = new Date(weekStartDate);
                        date.setDate(date.getDate() + dayIndex);
                        const [jy, jm, jd] = toJalali(date.getFullYear(), date.getMonth() + 1, date.getDate());
                        if (jy === jYear) {
                            const jDateStr = `${jy}-${jm}-${jd}`;
                            completionsByJalaliDate[jDateStr] = (completionsByJalaliDate[jDateStr] || 0) + dayData.entries.length;
                        }
                    }
                });
            }
        }
    });
    const maxCompletions = Math.max(1, ...Object.values(completionsByJalaliDate));
    const getColor = (count) => {
        if (!count || count === 0) return 'bg-slate-200 dark:bg-slate-700/80';
        const intensity = Math.min(count / (maxCompletions * 0.6 + 1), 1);
        if (intensity < 0.25) return 'bg-emerald-200 dark:bg-emerald-900';
        if (intensity < 0.5) return 'bg-emerald-400 dark:bg-emerald-700';
        if (intensity < 0.75) return 'bg-emerald-600 dark:bg-emerald-500';
        return 'bg-emerald-800 dark:bg-emerald-300';
    };
    let html = `<h3 class="font-bold mb-4 text-center">نقشه فعالیت سال ${toFa(jYear)}</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-6">`;
    for (let jm = 1; jm <= 12; jm++) {
        const monthLength = jalaliMonthLength(jYear, jm);
        const firstGregorianDate = toGregorian(jYear, jm, 1);
        const startOffset = (firstGregorianDate.getDay() + 1) % 7; // Adjusted for Sat start
        let monthHtml = `<div class="p-3 bg-slate-100 dark:bg-slate-900/50 rounded-lg">
            <h4 class="font-semibold text-center text-sm mb-2">${JALALI_MONTH_NAMES[jm-1]}</h4>
            <div class="grid grid-cols-7 gap-1 text-center text-[10px] text-slate-400 mb-1.5">
               ${WEEKDAY_NAMES_SHORT.map(d => `<div>${d}</div>`).join('')}
            </div>
            <div class="grid grid-cols-7 gap-1.5">`;
        for (let i = 0; i < startOffset; i++) { monthHtml += '<div></div>'; }
        for (let jd = 1; jd <= monthLength; jd++) {
            const jDateStr = `${jYear}-${jm}-${jd}`;
            const count = completionsByJalaliDate[jDateStr] || 0;
            const gDate = toGregorian(jYear, jm, jd);
            const colorClass = getColor(count);
            const todayClass = isToday(gDate) ? 'ring-2 ring-sky-500' : '';
            const title = `${toFa(jd)} ${JALALI_MONTH_NAMES[jm-1]} ${toFa(jYear)}: ${toFa(count)} مورد`;
            monthHtml += `<div onclick="showDailySummaryModal(${jYear}, ${jm}, ${jd})" class="${colorClass} ${todayClass} heatmap-day text-slate-800 dark:text-slate-200 font-bold" title="${title}">${toFa(jd)}</div>`;
        }
        monthHtml += `</div></div>`;
        html += monthHtml;
    }
    html += `</div>`;
    container.innerHTML = html;
}
    function showDailySummaryModal(jYear, jMonth, jDay) {
        const gDate = toGregorian(jYear, jMonth, jDay);
        const formattedDate = gDate.toLocaleDateString('fa-IR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-[101] flex items-center justify-center p-4';
        let completedGoalsHtml = '';
        let totalPlanned = 0;
        let totalCompletedCount = 0;
        const activeGoals = appState.goals.filter(g => !g.archived);
        const dayIndexForCheck = gDate.getDay(); // Sunday is 0
        activeGoals.forEach(goal => {
            if (goal.days[dayIndexForCheck]) {
                totalPlanned++;
                const entryCount = getEntryCountOnDate(goal, gDate);
                if (entryCount > 0) {
                    totalCompletedCount++;
                    completedGoalsHtml += `
                        <div class="flex items-center justify-between p-3 bg-white dark:bg-slate-700/50 rounded-lg">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">${goal.emoji}</span>
                                <span class="font-semibold">${escapeHtml(goal.name)}</span>
                            </div>
                            <span class="font-bold text-indigo-500">${toFa(entryCount)} بار</span>
                        </div>`;
                }
            }
        });
        const successRate = totalPlanned > 0 ? Math.round((totalCompletedCount / totalPlanned) * 100) : 0;
        const statsHtml = `
            <div class="mb-4">
                <h4 class="font-semibold text-sm mb-2 text-slate-600 dark:text-slate-300">آمار روز</h4>
                <div class="grid grid-cols-3 gap-2 text-center">
                    <div class="bg-slate-200 dark:bg-slate-700 p-2 rounded-lg">
                        <div class="text-xl font-bold text-green-600 dark:text-green-400">${toFa(totalCompletedCount)}</div>
                        <div class="text-xs text-slate-500 dark:text-slate-400">انجام‌شده</div>
                    </div>
                    <div class="bg-slate-200 dark:bg-slate-700 p-2 rounded-lg">
                        <div class="text-xl font-bold text-slate-700 dark:text-slate-200">${toFa(totalPlanned)}</div>
                        <div class="text-xs text-slate-500 dark:text-slate-400">برنامه‌ریزی</div>
                    </div>
                    <div class="bg-slate-200 dark:bg-slate-700 p-2 rounded-lg">
                        <div class="text-xl font-bold text-indigo-600 dark:text-indigo-400">${toFa(successRate)}٪</div>
                        <div class="text-xs text-slate-500 dark:text-slate-400">موفقیت</div>
                    </div>
                </div>
            </div>`;
        if (completedGoalsHtml === '') {
            completedGoalsHtml = '<p class="text-center text-slate-500 dark:text-slate-400 py-4">هیچ فعالیتی در این روز ثبت نشده است.</p>';
        }
        modal.innerHTML = `
            <div class="modal-content glass-modal-content rounded-2xl p-5 w-full max-w-md shadow-2xl">
                <h3 class="font-bold text-lg text-indigo-600 dark:text-indigo-400 mb-1">خلاصه روز</h3>
                <p class="text-sm text-slate-500 dark:text-slate-400 font-semibold mb-4">${formattedDate}</p>
                ${statsHtml}
                <h4 class="font-semibold text-sm mb-2 mt-4 text-slate-600 dark:text-slate-300">عادت‌های انجام‌شده</h4>
                <div class="space-y-2 max-h-52 overflow-y-auto no-scrollbar">${completedGoalsHtml}</div>
                <button class="close-modal-btn w-full mt-6 p-3 rounded-lg font-bold bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 transition">بستن</button>
            </div>`;
        document.getElementById('modalArea').appendChild(modal);
        modal.onclick = e => { if (e.target === modal || e.target.closest('.close-modal-btn')) closeModal(); };
    }
// ADD THIS NEW FUNCTION TO YOUR SCRIPT
// REPLACE THIS FUNCTION
// REPLACE THIS FUNCTION
function renderSettingsMenu() {
    const menu = document.getElementById('settingsMenu');
    if (!menu) return;

    const showArchived = appState.showArchived;
    const isDark = findThemeById(appState.activeThemeId).isDark;

    menu.innerHTML = `
        <div class="space-y-1">
            <button id="reportBtn" class="w-full text-left flex items-center gap-3 p-3 hover:bg-app-hover rounded-lg transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                <span>گزارش‌ها</span>
            </button>
            <button id="archiveToggleBtn" class="w-full text-left flex items-center gap-3 p-3 hover:bg-app-hover rounded-lg transition-colors ${showArchived ? 'text-primary' : ''}">
               <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                <span>${showArchived ? 'پنهان کردن آرشیو' : 'نمایش آرشیو'}</span>
            </button>
            <button id="themeSelectorBtn" class="w-full text-left flex items-center gap-3 p-3 hover:bg-app-hover rounded-lg transition-colors">
                <span class="text-xl w-5 text-center">🎨</span>
                <span>انتخاب تم</span>
            </button>
            <div class="my-1 h-px bg-app-border"></div>
            <div class="w-full text-left flex items-center justify-between gap-3 p-3">
                <div class="flex items-center gap-3">
                    <span class="text-xl w-5 text-center">🎲</span>
                    <span>تم تصادفی</span>
                </div>
                <label for="randomThemeToggle" class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" value="" id="randomThemeToggle" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                </label>
            </div>
            <div class="w-full text-left flex items-center justify-between gap-3 p-3">
                <div class="flex items-center gap-3">
                    <span class="text-xl w-5 text-center">🌗</span>
                    <span>حالت تیره</span>
                </div>
                <label for="darkModeToggle" class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" value="" id="darkModeToggle" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                </label>
            </div>
            <div class="my-1 h-px bg-app-border"></div>
            <button id="backupBtn" class="w-full text-left flex items-center gap-3 p-3 hover:bg-app-hover rounded-lg transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M12 15l-3-3m0 0l3-3m-3 3h12" /> </svg>
                <span>پشتیبان‌گیری</span>
            </button>
             <button id="aboutBtn" class="w-full text-left flex items-center gap-3 p-3 hover:bg-app-hover rounded-lg transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">  <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /> </svg>
                <span>درباره</span>
            </button>
        </div>
    `;
    const desktopToggle = menu.querySelector('#darkModeToggle');
    if (desktopToggle) desktopToggle.checked = isDark;
    
    const randomThemeToggle = menu.querySelector('#randomThemeToggle');
    if (randomThemeToggle) {
        randomThemeToggle.checked = appState.randomThemeMode;
    }
}
// You should also add the "Random Theme" toggle to renderMobileMenu if you wish.
function setupHeaderSwipe() {
    const navbar = document.getElementById('navbar');
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    let touchStartX = 0;
    let touchEndX = 0;

    navbar.addEventListener('touchstart', function(event) {
        // فقط در حالت موبایل اجرا شود
        if (hamburgerBtn.offsetParent === null) return;
        touchStartX = event.changedTouches[0].screenX;
    }, { passive: true });

    navbar.addEventListener('touchend', function(event) {
        // فقط در حالت موبایل اجرا شود
        if (hamburgerBtn.offsetParent === null) return;
        touchEndX = event.changedTouches[0].screenX;
        handleHeaderSwipe();
    });

    function handleHeaderSwipe() {
        const swipeThreshold = 50; // حداقل فاصله برای تشخیص اسلاید

        // اسلاید به راست -> هفته بعدی
        if (touchEndX > touchStartX + swipeThreshold) {
            appState.currentWeek.setDate(appState.currentWeek.getDate() + 7);
            fullRender();
        }
        // اسلاید به چپ -> هفته قبلی
        else if (touchStartX > touchEndX + swipeThreshold) {
            appState.currentWeek.setDate(appState.currentWeek.getDate() - 7);
            fullRender();
        }
    }
}

</script>
</body>
</html>