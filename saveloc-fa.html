<!DOCTYPE html>
<html lang="fa" dir="rtl" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" media="(prefers-color-scheme: dark)">
  <meta name="theme-color" content="#f7f7fb" media="(prefers-color-scheme: light)">
  <title>Save Loc â€” Ø°Ø®ÛŒØ±Ù‡ Ù…Ú©Ø§Ù†</title>

  <link rel="apple-touch-icon" href="https://i.postimg.cc/vT811GJ3/App-Icon-2x.png" />
  <link rel="icon" href="https://i.postimg.cc/vT811GJ3/App-Icon-2x.png" />

  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;700;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Custom CSS Variables and Overrides for a polished, professional look */
    :root {
      --bg: #0b1220;
      --bg-grad: #0e1628;
      --panel: #0f1726;
      --panel-2: #121a2b;
      --muted: #8aa0bf;
      --text: #eef3ff;
      --accent: #0a84ff;
      --accent-2: #34d399;
      --danger: #ff453a;
      --border: #1f273a;
      --shadow: 0 14px 34px rgba(0, 0, 0, .30);
    }

    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f7f7fb;
        --bg-grad: #fff;
        --panel: #ffffff;
        --panel-2: #fafafa;
        --muted: #6e7a8a;
        --text: #0d0f14;
        --accent: #007aff;
        --accent-2: #34c759;
        --danger: #ff3b30;
        --border: #e7e9ee;
        --shadow: 0 12px 28px rgba(0, 0, 0, .08);
      }
    }

    [data-theme="light"] {
      --bg: #f7f7fb;
      --bg-grad: #fff;
      --panel: #ffffff;
      --panel-2: #fafafa;
      --muted: #6e7a8a;
      --text: #0d0f14;
      --accent: #007aff;
      --accent-2: #34c759;
      --danger: #ff3b30;
      --border: #e7e9ee;
      --shadow: 0 12px 28px rgba(0, 0, 0, .08);
    }

    [data-theme="dark"] {
      --bg: #0b1220;
      --bg-grad: #0e1628;
      --panel: #0f1726;
      --panel-2: #121a2b;
      --muted: #8aa0bf;
      --text: #eef3ff;
      --accent: #0a84ff;
      --accent-2: #34d399;
      --danger: #ff453a;
      --border: #1f273a;
      --shadow: 0 14px 34px rgba(0, 0, 0, .30);
    }

    body {
      background: linear-gradient(180deg, var(--bg) 0%, var(--bg) 55%, var(--bg-grad) 100%);
      color: var(--text);
      font-family: 'Vazirmatn', -apple-system, system-ui, Segoe UI, Roboto, Inter, Helvetica, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      -webkit-text-size-adjust: 100%;
    }

    .appbar {
      position: sticky;
      top: 0;
      z-index: 30;
      background: color-mix(in oklab, var(--bg) 88%, transparent);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      padding-top: env(safe-area-inset-top);
    }

    .btn,
    .icon-btn {
      transition: transform 0.1s ease, background-color 0.2s ease, box-shadow 0.2s ease, color 0.2s ease;
      min-height: 44px;
    }

    .btn:active,
    .icon-btn:active {
      transform: translateY(1px);
    }
    
    .toast {
      position: fixed;
      left: 50%;
      bottom: 20px;
      transform: translateX(-50%);
      background: var(--panel);
      border: 1px solid var(--border);
      padding: 10px 14px;
      border-radius: 12px;
      color: var(--text);
      box-shadow: var(--shadow);
      opacity: 0;
      pointer-events: none;
      transition: 0.25s;
      z-index: 60;
    }

    .toast.show {
      opacity: 1;
      pointer-events: auto;
      bottom: 28px;
    }

    /* Additional custom classes */
    .pill {
      border-radius: 9999px;
      padding: 10px 12px;
      font-size: 13px;
      color: var(--muted);
      border: 1px solid var(--border);
      background: var(--panel-2);
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 9px 12px;
      border: 1px solid var(--border);
      background: var(--panel-2);
      border-radius: 9999px;
      cursor: pointer;
      min-height: 40px;
    }

    .chip[aria-pressed="true"] {
      background: var(--panel);
      box-shadow: var(--shadow);
    }

    dialog::backdrop {
      background: rgba(0, 0, 0, .55);
    }
  </style>
</head>
<body class="h-full">

  <div class="appbar">
    <div class="flex items-center gap-3 p-3 max-w-5xl mx-auto">
      <div class="flex items-center gap-3 min-w-0">
        <img class="w-8 h-8 rounded-lg shadow-lg" src="https://i.postimg.cc/vT811GJ3/App-Icon-2x.png" alt="Save Loc icon" />
        <div class="min-w-0">
          <div class="font-extrabold text-lg">Save Loc</div>
          <div class="text-xs text-muted" data-i18n="subtitle">Ø°Ø®ÛŒØ±Ù‡ Ù…Ú©Ø§Ù† â€¢ Ø¢ÙÙ„Ø§ÛŒÙ† â€¢ Ø§Ø´ØªØ±Ø§Ú©</div>
        </div>
      </div>
      <div class="flex-grow"></div>

      <div class="flex p-1 rounded-full bg-[var(--panel-2)] border border-[var(--border)] gap-1" role="tablist" aria-label="Theme">
        <button id="themeAuto" aria-pressed="true" class="px-3 py-2 rounded-full font-semibold min-h-[44px] text-[var(--muted)] hover:bg-[var(--panel)] hover:text-[var(--text)] transition-colors duration-200">Ø®ÙˆØ¯Ú©Ø§Ø±</button>
        <button id="themeLight" aria-pressed="false" class="px-3 py-2 rounded-full font-semibold min-h-[44px] text-[var(--muted)] hover:bg-[var(--panel)] hover:text-[var(--text)] transition-colors duration-200">Ø±ÙˆØ´Ù†</button>
        <button id="themeDark" aria-pressed="false" class="px-3 py-2 rounded-full font-semibold min-h-[44px] text-[var(--muted)] hover:bg-[var(--panel)] hover:text-[var(--text)] transition-colors duration-200">ØªØ§Ø±ÛŒÚ©</button>
      </div>

      <div class="flex p-1 rounded-full bg-[var(--panel-2)] border border-[var(--border)] gap-1 ms-2" role="tablist" aria-label="Language">
        <button id="langFa" aria-pressed="true" class="px-3 py-2 rounded-full font-semibold min-h-[44px] text-[var(--muted)] hover:bg-[var(--panel)] hover:text-[var(--text)] transition-colors duration-200">ÙØ§</button>
        <button id="langEn" aria-pressed="false" class="px-3 py-2 rounded-full font-semibold min-h-[44px] text-[var(--muted)] hover:bg-[var(--panel)] hover:text-[var(--text)] transition-colors duration-200">EN</button>
      </div>

      <button id="installBtn" class="icon-btn" hidden title="Install">â¬‡ï¸</button>
      <button id="a2hsHint" class="icon-btn" hidden title="Add to Home">ï¼‹</button>
      <button id="settingsBtn" class="icon-btn" title="Settings">âš™ï¸</button>
    </div>
  </div>

  <main class="max-w-5xl mx-auto p-4 md:p-6 grid gap-5" style="padding-bottom:calc(14px + env(safe-area-inset-bottom))">
    <section class="bg-[var(--panel)] border border-[var(--border)] rounded-3xl shadow-xl p-4 grid gap-4">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-bold" data-i18n="current.title">Ù…Ú©Ø§Ù† ÙØ¹Ù„ÛŒ</h2>
        <span id="permStatus" class="pill" data-i18n="perm.unknown">Ø¯Ø³ØªØ±Ø³ÛŒ: <b>Ù†Ø§Ù…Ø´Ø®Øµ</b></span>
      </div>
      <div class="h-1.5 bg-[var(--panel-2)] rounded-full overflow-hidden">
        <i id="progBar" class="block h-full w-0 bg-gradient-to-r from-[var(--accent)] to-[var(--accent-2)] transition-all duration-300"></i>
      </div>

      <div class="flex flex-wrap gap-3">
        <button id="locateBtn" class="bg-[var(--accent)] text-white px-4 py-3 rounded-xl font-bold flex-1 flex justify-center items-center gap-2 hover:bg-opacity-80 active:scale-95 transition-all">ğŸ“ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¯Ù‚ÛŒÙ‚</button>
        <button id="openPicker" class="bg-[var(--panel-2)] border border-[var(--border)] text-[var(--text)] px-4 py-3 rounded-xl font-bold flex-1 flex justify-center items-center gap-2 hover:bg-[var(--panel)] active:scale-95 transition-all">ğŸ—ºï¸ Ø§Ù†ØªØ®Ø§Ø¨ Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡</button>
        <button id="saveLiveBtn" class="bg-[var(--accent-2)] text-white px-4 py-3 rounded-xl font-bold flex-1 flex justify-center items-center gap-2 disabled:opacity-50 disabled:pointer-events-none hover:bg-opacity-80 active:scale-95 transition-all" disabled>â­ Ø°Ø®ÛŒØ±Ù‡</button>
        <button id="shareBtn" class="bg-[var(--panel-2)] border border-[var(--border)] text-[var(--text)] px-4 py-3 rounded-xl font-bold flex-1 flex justify-center items-center gap-2 disabled:opacity-50 disabled:pointer-events-none hover:bg-[var(--panel)] active:scale-95 transition-all" disabled>â†—ï¸ Ø§Ø´ØªØ±Ø§Ú©</button>
      </div>

      <div class="flex flex-wrap gap-2">
        <div class="pill mono" id="latBox" data-i18n="current.lat">Ø¹Ø±Ø¶: â€“</div>
        <div class="pill mono" id="lngBox" data-i18n="current.lng">Ø·ÙˆÙ„: â€“</div>
        <div class="pill" id="accBox" data-i18n="current.acc">Ø¯Ù‚Øª: â€“</div>
      </div>
      <div class="flex flex-wrap gap-2">
        <button id="copyLat" class="btn bg-[var(--panel-2)] border border-[var(--border)] text-[var(--text)] px-4 py-3 rounded-xl font-bold flex items-center gap-2 disabled:opacity-50 disabled:pointer-events-none hover:bg-[var(--panel)]">ğŸ“‹ Ú©Ù¾ÛŒ Ø¹Ø±Ø¶</button>
        <button id="copyLng" class="btn bg-[var(--panel-2)] border border-[var(--border)] text-[var(--text)] px-4 py-3 rounded-xl font-bold flex items-center gap-2 disabled:opacity-50 disabled:pointer-events-none hover:bg-[var(--panel)]">ğŸ“‹ Ú©Ù¾ÛŒ Ø·ÙˆÙ„</button>
        <button id="copyBoth" class="btn bg-[var(--panel-2)] border border-[var(--border)] text-[var(--text)] px-4 py-3 rounded-xl font-bold flex items-center gap-2 disabled:opacity-50 disabled:pointer-events-none hover:bg-[var(--panel)]">ğŸ“‹ Ú©Ù¾ÛŒ Ø¹Ø±Ø¶ØŒØ·ÙˆÙ„</button>
      </div>
      <div class="flex flex-wrap gap-2" id="addrRow" style="display:none">
        <div class="pill" id="addrChip" data-i18n="current.resolving">ğŸ“ Ø¯Ø±Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø¢Ø¯Ø±Ø³â€¦</div>
      </div>
      <div class="text-[var(--muted)] text-sm" id="tsBox">â€”</div>

      <div class="flex flex-wrap gap-2">
        <button id="openApple" class="btn bg-[var(--panel-2)] border border-[var(--border)] text-[var(--text)] px-4 py-3 rounded-xl font-bold disabled:opacity-50 disabled:pointer-events-none hover:bg-[var(--panel)]">ğŸ—ºï¸ Ø§Ù¾Ù„</button>
        <button id="openGoogle" class="btn bg-[var(--panel-2)] border border-[var(--border)] text-[var(--text)] px-4 py-3 rounded-xl font-bold disabled:opacity-50 disabled:pointer-events-none hover:bg-[var(--panel)]">ğŸ—ºï¸ Ú¯ÙˆÚ¯Ù„</button>
        <button id="openWaze" class="btn bg-[var(--panel-2)] border border-[var(--border)] text-[var(--text)] px-4 py-3 rounded-xl font-bold disabled:opacity-50 disabled:pointer-events-none hover:bg-[var(--panel)]">ğŸš˜ ÙˆÛŒØ²</button>
        <button id="dirApple" class="btn bg-[var(--panel-2)] border border-[var(--border)] text-[var(--text)] px-4 py-3 rounded-xl font-bold disabled:opacity-50 disabled:pointer-events-none hover:bg-[var(--panel)]">â¡ï¸ Ù…Ø³ÛŒÙ€Ø±ÛŒØ§Ø¨ÛŒ Ø§Ù¾Ù„</button>
        <button id="openCustom" class="btn bg-[var(--panel-2)] border border-[var(--border)] text-[var(--text)] px-4 py-3 rounded-xl font-bold disabled:opacity-50 disabled:pointer-events-none hover:bg-[var(--panel)]">ğŸ”— Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯ÛŒÚ¯Ø±</button>
      </div>
    </section>

    <section class="bg-[var(--panel)] border border-[var(--border)] rounded-3xl shadow-xl p-4 grid gap-4">
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <h2 class="text-lg font-bold" data-i18n="saved.title">Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡</h2>
        <input id="searchBox" type="search" data-i18n-placeholder="saved.searchPh" placeholder="Ø¬Ø³ØªØ¬Ùˆ: Ù†Ø§Ù…ØŒ Ø¢Ø¯Ø±Ø³ØŒ ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€¦" aria-label="Search" class="w-full md:w-auto p-3 rounded-xl border border-[var(--border)] bg-[var(--panel-2)] text-[var(--text)] placeholder-[var(--muted)] focus:outline-none focus:ring-2 focus:ring-[var(--accent)]" />
      </div>
      <div id="listArea" class="grid gap-4">
        <div class="border border-dashed border-[var(--border)] rounded-xl p-5 text-center text-[var(--muted)]" data-i18n="saved.empty">Ù‡Ù†ÙˆØ² Ù…Ú©Ø§Ù†ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯Ù‡. Ø§Ø² <b>Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¯Ù‚ÛŒÙ‚</b> ÛŒØ§ <b>Ø§Ù†ØªØ®Ø§Ø¨ Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡</b> Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.</div>
      </div>
      <div class="flex flex-wrap justify-between items-center gap-4">
        <div class="flex flex-wrap gap-2">
          <button id="exportBtn" class="btn bg-[var(--panel-2)] border border-[var(--border)] text-[var(--text)] px-4 py-3 rounded-xl font-bold flex items-center gap-2 hover:bg-[var(--panel)]">â¬‡ï¸ Ø®Ø±ÙˆØ¬ÛŒ</button>
          <input id="importFile" type="file" accept="application/json" hidden />
          <button id="importBtn" class="btn bg-[var(--panel-2)] border border-[var(--border)] text-[var(--text)] px-4 py-3 rounded-xl font-bold flex items-center gap-2 hover:bg-[var(--panel)]">â¬†ï¸ ÙˆØ±ÙˆØ¯</button>
        </div>
        <div class="flex flex-wrap gap-2">
          <button id="backupBtn" class="btn bg-[var(--panel-2)] border border-[var(--border)] text-[var(--text)] px-4 py-3 rounded-xl font-bold flex items-center gap-2 hover:bg-[var(--panel)]">ğŸ§° Ù¾Ø´ØªÛŒØ¨Ø§Ù†</button>
          <input id="restoreFile" type="file" accept="application/json" hidden />
          <button id="restoreBtn" class="btn bg-[var(--panel-2)] border border-[var(--border)] text-[var(--text)] px-4 py-3 rounded-xl font-bold flex items-center gap-2 hover:bg-[var(--panel)]">ğŸ§³ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ</button>
          <button id="clearAllBtn" class="btn bg-[var(--danger)] text-white px-4 py-3 rounded-xl font-bold flex items-center gap-2 hover:bg-opacity-80 active:scale-95 transition-all">ğŸ—‘ï¸ Ø­Ø°Ù Ù‡Ù…Ù‡</button>
        </div>
      </div>
    </section>
  </main>

  <footer class="p-4 text-center text-[var(--muted)] text-sm" data-i18n="footer">Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· <b>Peymaan Abedinpour V0.03</b></footer>
  <div id="toast" class="toast" role="status" aria-live="polite">â€”</div>

  <dialog id="settingsModal" class="bg-[var(--panel)] border border-[var(--border)] rounded-2xl shadow-xl w-11/12 max-w-2xl p-0">
    <div class="p-4 border-b border-[var(--border)] flex items-center gap-3">
      <strong class="text-lg font-bold" data-i18n="settings.title">ØªÙ†Ø¸ÛŒÙ…Ø§Øª</strong>
      <div class="flex-grow"></div>
      <button id="closeSettings" class="icon-btn bg-[var(--panel-2)] border border-[var(--border)] rounded-xl p-3 cursor-pointer hover:bg-[var(--panel)]">âœ•</button>
    </div>
    <div class="p-4 grid gap-4">
      <div>
        <label for="customTpl" class="text-[var(--muted)] text-sm" data-i18n="settings.customTpl">Ù‚Ø§Ù„Ø¨ Ù„ÛŒÙ†Ú© Ø³ÙØ§Ø±Ø´ÛŒ (Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯ÛŒÚ¯Ø±)</label>
        <input id="customTpl" type="text" placeholder="myapp://open?lat={lat}&lng={lng}&name={name}" class="w-full p-3 rounded-xl border border-[var(--border)] bg-[var(--panel-2)] text-[var(--text)] placeholder-[var(--muted)] focus:outline-none focus:ring-2 focus:ring-[var(--accent)]" />
        <div class="text-xs text-[var(--muted)] mt-1" data-i18n="settings.customHelp">Ø¬Ø§ÛŒâ€ŒÚ¯Ø°Ø§Ø±Ù‡Ø§: {lat}ØŒ {lng}ØŒ {name} â€” Ù…Ø«Ø§Ù„: waze://?ll={lat},{lng}&navigate=yes</div>
      </div>

      <div>
        <label class="text-[var(--muted)] text-sm" data-i18n="settings.categories">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§</label>
        <div id="catList" class="grid gap-3" style="grid-template-columns:repeat(auto-fill,minmax(220px,1fr))"></div>
        <div class="flex flex-wrap gap-2 mt-2">
          <input id="newCatName" type="text" data-i18n-placeholder="settings.newCatPh" placeholder="Ù†Ø§Ù… Ø¯Ø³ØªÙ‡ (Ù…Ø«Ù„Ø§Ù‹: Ù¾Ø§Ø±Ú©ÛŒÙ†Ú¯)" class="flex-grow p-3 rounded-xl border border-[var(--border)] bg-[var(--panel-2)] text-[var(--text)] focus:outline-none focus:ring-2 focus:ring-[var(--accent)]" />
          <input id="newCatIcon" type="text" data-i18n-placeholder="settings.newCatIconPh" placeholder="Ø§ÛŒÙ…ÙˆØ¬ÛŒ (Ù…Ø«Ù„Ø§Ù‹: ğŸ…¿ï¸)" class="w-24 p-3 rounded-xl border border-[var(--border)] bg-[var(--panel-2)] text-[var(--text)] focus:outline-none focus:ring-2 focus:ring-[var(--accent)]" />
          <button id="addCatBtn" class="btn bg-[var(--accent-2)] text-white px-4 py-3 rounded-xl font-bold flex-shrink-0 hover:bg-opacity-80 active:scale-95">Ø§ÙØ²ÙˆØ¯Ù†</button>
        </div>
        <div class="text-xs text-[var(--muted)] mt-1" data-i18n="settings.catTip">Ø§Ø² Ø§ÛŒÙ…ÙˆØ¬ÛŒ Ø¨Ù‡â€ŒØ¹Ù†ÙˆØ§Ù† Ø¢ÛŒÚ©Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯ (ğŸ  ğŸ’¼ ğŸ…¿ï¸ â­ ğŸ‘¤ ğŸ“Œ).</div>
      </div>

      <div>
        <label for="shareTitle" class="text-[var(--muted)] text-sm" data-i18n="settings.shareTitle">Ø¹Ù†ÙˆØ§Ù† Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ</label>
        <input id="shareTitle" type="text" placeholder="Save Loc" class="w-full p-3 rounded-xl border border-[var(--border)] bg-[var(--panel-2)] text-[var(--text)] focus:outline-none focus:ring-2 focus:ring-[var(--accent)]" />
      </div>
    </div>
    <div class="p-4 border-t border-[var(--border)] flex gap-2 justify-start">
      <button id="testCustom" class="btn bg-[var(--panel-2)] border border-[var(--border)] text-[var(--text)] px-4 py-3 rounded-xl font-bold hover:bg-[var(--panel)]">Ø¢Ø²Ù…ÙˆÙ† Ù„ÛŒÙ†Ú©</button>
      <div class="flex-grow"></div>
      <button id="saveSettings" class="btn bg-[var(--accent)] text-white px-4 py-3 rounded-xl font-bold hover:bg-opacity-80 active:scale-95">Ø°Ø®ÛŒØ±Ù‡</button>
    </div>
  </dialog>

  <dialog id="saveModal" class="bg-[var(--panel)] border border-[var(--border)] rounded-2xl shadow-xl w-11/12 max-w-2xl p-0">
    <div class="p-4 border-b border-[var(--border)] flex items-center gap-3">
      <strong id="saveModalTitle" class="text-lg font-bold" data-i18n="save.title">Ø°Ø®ÛŒØ±Ù‡ Ù…Ú©Ø§Ù†</strong>
      <div class="flex-grow"></div>
      <button id="closeSave" class="icon-btn bg-[var(--panel-2)] border border-[var(--border)] rounded-xl p-3 cursor-pointer hover:bg-[var(--panel)]">âœ•</button>
    </div>
    <div class="p-4 grid gap-4">
      <div>
        <label class="text-[var(--muted)] text-sm" for="placeName" data-i18n="save.nameLabel">Ù†Ø§Ù…</label>
        <input id="placeName" type="text" data-i18n-placeholder="save.namePh" placeholder="Ù†Ù‚Ø·Ù‡ Ù…Ù†" class="w-full p-3 rounded-xl border border-[var(--border)] bg-[var(--panel-2)] text-[var(--text)] focus:outline-none focus:ring-2 focus:ring-[var(--accent)]" />
      </div>
      <div>
        <label class="text-[var(--muted)] text-sm" data-i18n="save.catLabel">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</label>
        <div id="catChips" class="flex flex-wrap gap-2"></div>
        <div class="flex flex-wrap gap-2 mt-2">
          <input id="quickCatName" type="text" data-i18n-placeholder="save.newCatNamePh" placeholder="Ù†Ø§Ù… Ø¯Ø³ØªÙ‡ Ø¬Ø¯ÛŒØ¯" class="flex-grow p-3 rounded-xl border border-[var(--border)] bg-[var(--panel-2)] text-[var(--text)] focus:outline-none focus:ring-2 focus:ring-[var(--accent)]" />
          <input id="quickCatIcon" type="text" data-i18n-placeholder="save.newCatIconPh" placeholder="Ø§ÛŒÙ…ÙˆØ¬ÛŒ (ğŸ“Œ)" class="w-24 p-3 rounded-xl border border-[var(--border)] bg-[var(--panel-2)] text-[var(--text)] focus:outline-none focus:ring-2 focus:ring-[var(--accent)]" />
          <button id="quickAddCat" class="btn bg-[var(--accent-2)] text-white px-4 py-3 rounded-xl font-bold hover:bg-opacity-80 active:scale-95">Ø§ÙØ²ÙˆØ¯Ù†</button>
        </div>
      </div>
      <div>
        <label class="text-[var(--muted)] text-sm" for="placeNotes" data-i18n="save.notesLabel">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</label>
        <textarea id="placeNotes" rows="3" data-i18n-placeholder="save.notesPh" placeholder="ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø§Ø®ØªÛŒØ§Ø±ÛŒ (Ú©Ø¯ Ø¯Ø±ØŒ Ø·Ø¨Ù‚Ù‡ØŒ ØªÙ…Ø§Ø³â€¦)" class="w-full p-3 rounded-xl border border-[var(--border)] bg-[var(--panel-2)] text-[var(--text)] focus:outline-none focus:ring-2 focus:ring-[var(--accent)]"></textarea>
      </div>
      <div class="flex flex-wrap gap-2">
        <div class="pill mono" id="saveLat" data-i18n="current.lat">Ø¹Ø±Ø¶: â€”</div>
        <div class="pill mono" id="saveLng" data-i18n="current.lng">Ø·ÙˆÙ„: â€”</div>
        <div class="pill" id="saveAcc" data-i18n="current.acc">Ø¯Ù‚Øª: â€”</div>
      </div>
      <div class="flex flex-wrap gap-2">
        <div class="pill" id="saveAddr">ğŸ“ â€”</div>
      </div>
    </div>
    <div class="p-4 border-t border-[var(--border)] flex gap-2 justify-end">
      <button id="saveCancel" class="btn bg-[var(--panel-2)] border border-[var(--border)] text-[var(--text)] px-4 py-3 rounded-xl font-bold hover:bg-[var(--panel)]">Ø§Ù†ØµØ±Ø§Ù</button>
      <button id="saveConfirm" class="btn bg-[var(--accent)] text-white px-4 py-3 rounded-xl font-bold hover:bg-opacity-80 active:scale-95">Ø°Ø®ÛŒØ±Ù‡</button>
    </div>
  </dialog>

  <dialog id="pickerModal" class="bg-[var(--panel)] border border-[var(--border)] rounded-2xl shadow-xl w-11/12 max-w-2xl p-0">
    <div class="p-4 border-b border-[var(--border)] flex items-center gap-3">
      <strong class="text-lg font-bold" data-i18n="picker.title">Ø§Ù†ØªØ®Ø§Ø¨ Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡</strong>
      <div class="flex-grow"></div>
      <button id="closePicker" class="icon-btn bg-[var(--panel-2)] border border-[var(--border)] rounded-xl p-3 cursor-pointer hover:bg-[var(--panel)]">âœ•</button>
    </div>
    <div class="p-4 grid gap-4">
      <div id="pickerMap" class="w-full h-80 rounded-xl border border-[var(--border)] overflow-hidden"></div>
      <div class="flex flex-col md:flex-row gap-2 mt-2">
        <input id="pickerSearch" type="text" data-i18n-placeholder="picker.searchPh" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¢Ø¯Ø±Ø³â€¦" class="w-full p-3 rounded-xl border border-[var(--border)] bg-[var(--panel-2)] text-[var(--text)] focus:outline-none focus:ring-2 focus:ring-[var(--accent)]" />
        <button id="pickerSearchBtn" class="btn bg-[var(--panel-2)] border border-[var(--border)] text-[var(--text)] px-4 py-3 rounded-xl font-bold flex-shrink-0 hover:bg-[var(--panel)]">ğŸ” Ø¬Ø³ØªØ¬Ùˆ</button>
        <button id="pickerUse" class="btn bg-[var(--accent-2)] text-white px-4 py-3 rounded-xl font-bold flex-shrink-0 hover:bg-opacity-80 active:scale-95">Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§ÛŒÙ† Ù†Ù‚Ø·Ù‡</button>
      </div>
      <div class="text-xs text-[var(--muted)]" data-i18n="picker.help">Ù¾ÛŒÙ† Ø±Ø§ Ø¨Ú©Ø´ÛŒØ¯ ÛŒØ§ Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡ Ø¨Ø²Ù†ÛŒØ¯. Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø§Ø¹Ø« Ø²ÙˆÙ… Ù…ØªÙ†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
    </div>
  </dialog>

  <dialog id="previewModal" class="bg-[var(--panel)] border border-[var(--border)] rounded-2xl shadow-xl w-11/12 max-w-2xl p-0">
    <div class="p-4 border-b border-[var(--border)] flex items-center gap-3">
      <strong id="previewTitle" class="text-lg font-bold" data-i18n="preview.title">Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´</strong>
      <div class="flex-grow"></div>
      <button id="closePreview" class="icon-btn bg-[var(--panel-2)] border border-[var(--border)] rounded-xl p-3 cursor-pointer hover:bg-[var(--panel)]">âœ•</button>
    </div>
    <div class="p-4 grid gap-4">
      <div id="previewMap" class="w-full h-80 rounded-xl border border-[var(--border)] overflow-hidden"></div>
      <div id="previewAddr" class="text-[var(--muted)] text-sm">â€”</div>
      <div class="flex flex-wrap gap-2">
        <button id="pvApple" class="btn bg-[var(--panel-2)] border border-[var(--border)] text-[var(--text)] px-4 py-3 rounded-xl font-bold hover:bg-[var(--panel)]">ğŸ—ºï¸ Ø§Ù¾Ù„</button>
        <button id="pvGoogle" class="btn bg-[var(--panel-2)] border border-[var(--border)] text-[var(--text)] px-4 py-3 rounded-xl font-bold hover:bg-[var(--panel)]">ğŸ—ºï¸ Ú¯ÙˆÚ¯Ù„</button>
        <button id="pvWaze" class="btn bg-[var(--panel-2)] border border-[var(--border)] text-[var(--text)] px-4 py-3 rounded-xl font-bold hover:bg-[var(--panel)]">ğŸš˜ ÙˆÛŒØ²</button>
        <button id="pvDir" class="btn bg-[var(--panel-2)] border border-[var(--border)] text-[var(--text)] px-4 py-3 rounded-xl font-bold hover:bg-[var(--panel)]">â¡ï¸ Ù…Ø³ÛŒÙ€Ø±ÛŒØ§Ø¨ÛŒ Ø§Ù¾Ù„</button>
        <button id="pvShare" class="btn bg-[var(--panel-2)] border border-[var(--border)] text-[var(--text)] px-4 py-3 rounded-xl font-bold hover:bg-[var(--panel)]">â†—ï¸ Ø§Ø´ØªØ±Ø§Ú©</button>
      </div>
    </div>
  </dialog>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    /* Manifest */
    (function(){
      const manifest = {
        name:"Save Loc â€” Ø°Ø®ÛŒØ±Ù‡ Ù…Ú©Ø§Ù†",
        short_name:"Save Loc",
        start_url:"./",
        display:"standalone",
        background_color:"#0b1220",
        theme_color:"#0b1220",
        icons:[
          {"src":"https://i.postimg.cc/vT811GJ3/App-Icon-2x.png","sizes":"192x192","type":"image/png","purpose":"any maskable"},
          {"src":"https://i.postimg.cc/vT811GJ3/App-Icon-2x.png","sizes":"512x512","type":"image/png","purpose":"any maskable"}
        ]
      };
      const blob = new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"});
      const url = URL.createObjectURL(blob);
      const link = document.createElement('link'); link.rel = 'manifest'; link.href = url; document.head.appendChild(link);
    })();

    /* SW */
    (function(){
      if(!('serviceWorker' in navigator)) return;
      const swCode = `
        const CACHE='saveloc-v6';
        const ASSETS=['./'];
        self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS)).then(self.skipWaiting()))});
        self.addEventListener('activate',e=>{e.waitUntil(self.clients.claim())});
        self.addEventListener('fetch',e=>{
          e.respondWith(
            caches.match(e.request).then(c=>c||fetch(e.request).then(res=>{
              const copy=res.clone(); caches.open(CACHE).then(cache=>cache.put(e.request,copy)).catch(()=>{});
              return res;
            }).catch(()=>caches.match('./')))
          );
        });
      `;
      const blob = new Blob([swCode], {type:'text/javascript'});
      navigator.serviceWorker.register(URL.createObjectURL(blob));
    })();

    /* Elements */
    const themeAuto = document.getElementById('themeAuto');
    const themeLight = document.getElementById('themeLight');
    const themeDark = document.getElementById('themeDark');
    const langFa = document.getElementById('langFa');
    const langEn = document.getElementById('langEn');

    const installBtn = document.getElementById('installBtn');
    const a2hsHint = document.getElementById('a2hsHint');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsModal = document.getElementById('settingsModal');
    const closeSettings = document.getElementById('closeSettings');
    const saveSettingsBtn = document.getElementById('saveSettings');
    const testCustom = document.getElementById('testCustom');

    const customTpl = document.getElementById('customTpl');
    const shareTitle = document.getElementById('shareTitle');

    const locateBtn = document.getElementById('locateBtn');
    const openPicker = document.getElementById('openPicker');
    const saveLiveBtn = document.getElementById('saveLiveBtn');
    const shareBtn = document.getElementById('shareBtn');
    const progBar = document.getElementById('progBar');
    const permStatus = document.getElementById('permStatus');

    const latBox = document.getElementById('latBox');
    const lngBox = document.getElementById('lngBox');
    const accBox = document.getElementById('accBox');
    const tsBox  = document.getElementById('tsBox');
    const addrRow = document.getElementById('addrRow');
    const addrChip = document.getElementById('addrChip');

    const copyLat = document.getElementById('copyLat');
    const copyLng = document.getElementById('copyLng');
    const copyBoth = document.getElementById('copyBoth');

    const openApple = document.getElementById('openApple');
    const openGoogle = document.getElementById('openGoogle');
    const openWaze = document.getElementById('openWaze');
    const openCustom = document.getElementById('openCustom');
    const dirApple = document.getElementById('dirApple');

    const listArea = document.getElementById('listArea');
    const searchBox = document.getElementById('searchBox');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const importFile = document.getElementById('importFile');
    const backupBtn = document.getElementById('backupBtn');
    const restoreBtn = document.getElementById('restoreBtn');
    const restoreFile = document.getElementById('restoreFile');
    const clearAllBtn = document.getElementById('clearAllBtn');

    const pickerModal = document.getElementById('pickerModal');
    const pickerMapEl = document.getElementById('pickerMap');
    const pickerSearch = document.getElementById('pickerSearch');
    const pickerSearchBtn = document.getElementById('pickerSearchBtn');
    const pickerUse = document.getElementById('pickerUse');
    const closePicker = document.getElementById('closePicker');

    const previewModal = document.getElementById('previewModal');
    const previewTitle = document.getElementById('previewTitle');
    const previewMapEl = document.getElementById('previewMap');
    const previewAddr = document.getElementById('previewAddr');
    const pvApple = document.getElementById('pvApple');
    const pvGoogle = document.getElementById('pvGoogle');
    const pvWaze = document.getElementById('pvWaze');
    const pvDir = document.getElementById('pvDir');
    const pvShare = document.getElementById('pvShare');
    const closePreview = document.getElementById('closePreview');

    const saveModal = document.getElementById('saveModal');
    const saveModalTitle = document.getElementById('saveModalTitle');
    const closeSave = document.getElementById('closeSave');
    const saveLat = document.getElementById('saveLat');
    const saveLng = document.getElementById('saveLng');
    const saveAcc = document.getElementById('saveAcc');
    const saveAddr = document.getElementById('saveAddr');
    const placeName = document.getElementById('placeName');
    const placeNotes = document.getElementById('placeNotes');
    const catChips = document.getElementById('catChips');
    const quickCatName = document.getElementById('quickCatName');
    const quickCatIcon = document.getElementById('quickCatIcon');
    const quickAddCat = document.getElementById('quickAddCat');
    const saveCancel = document.getElementById('saveCancel');
    const saveConfirm = document.getElementById('saveConfirm');

    /* i18n */
    const i18n = {
      fa: {
        locale:'fa-IR', dir:'rtl',
        subtitle:'Ø°Ø®ÛŒØ±Ù‡ Ù…Ú©Ø§Ù† â€¢ Ø¢ÙÙ„Ø§ÛŒÙ† â€¢ Ø§Ø´ØªØ±Ø§Ú©',
        theme:{auto:'Ø®ÙˆØ¯Ú©Ø§Ø±', light:'Ø±ÙˆØ´Ù†', dark:'ØªØ§Ø±ÛŒÚ©'},
        footer:'Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· <b>Peymaan Abedinpour V0.03</b>',
        current:{
          title:'Ù…Ú©Ø§Ù† ÙØ¹Ù„ÛŒ', getPrecise:'ğŸ“ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¯Ù‚ÛŒÙ‚', mapPicker:'ğŸ—ºï¸ Ø§Ù†ØªØ®Ø§Ø¨ Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡', save:'â­ Ø°Ø®ÛŒØ±Ù‡',
          lat:'Ø¹Ø±Ø¶: â€”', lng:'Ø·ÙˆÙ„: â€”', acc:'Ø¯Ù‚Øª: â€”', resolving:'ğŸ“ Ø¯Ø±Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø¢Ø¯Ø±Ø³â€¦',
          copyLat:'ğŸ“‹ Ú©Ù¾ÛŒ Ø¹Ø±Ø¶', copyLng:'ğŸ“‹ Ú©Ù¾ÛŒ Ø·ÙˆÙ„', copyBoth:'ğŸ“‹ Ú©Ù¾ÛŒ Ø¹Ø±Ø¶ØŒØ·ÙˆÙ„',
          timestamp:(s)=>'Ø²Ù…Ø§Ù†: '+s, accUnit:(m)=>'Ø¯Ù‚Øª: Â±'+m+' Ù…ØªØ±', latVal:(v)=>'Ø¹Ø±Ø¶: '+v, lngVal:(v)=>'Ø·ÙˆÙ„: '+v
        },
        perm:{unknown:'Ø¯Ø³ØªØ±Ø³ÛŒ: <b>Ù†Ø§Ù…Ø´Ø®Øµ</b>', granted:'Ø¯Ø³ØªØ±Ø³ÛŒ: <b style="color:var(--accent-2)">Ù…Ø¬Ø§Ø²</b>', denied:'Ø¯Ø³ØªØ±Ø³ÛŒ: <b style="color:var(--danger)">Ø±Ø¯</b>', prompt:'Ø¯Ø³ØªØ±Ø³ÛŒ: <b>Ù¾Ø±Ø³Ø´</b>'},
        maps:{apple:'ğŸ—ºï¸ Ø§Ù¾Ù„', google:'ğŸ—ºï¸ Ú¯ÙˆÚ¯Ù„', waze:'ğŸš˜ ÙˆÛŒØ²', appleDir:'â¡ï¸ Ù…Ø³ÛŒÙ€Ø±ÛŒØ§Ø¨ÛŒ Ø§Ù¾Ù„', otherApp:'ğŸ”— Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯ÛŒÚ¯Ø±'},
        saved:{
          title:'Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡',
          searchPh:'Ø¬Ø³ØªØ¬Ùˆ: Ù†Ø§Ù…ØŒ Ø¢Ø¯Ø±Ø³ØŒ ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€¦',
          empty:'Ù‡Ù†ÙˆØ² Ù…Ú©Ø§Ù†ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯Ù‡. Ø§Ø² <b>Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¯Ù‚ÛŒÙ‚</b> ÛŒØ§ <b>Ø§Ù†ØªØ®Ø§Ø¨ Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡</b> Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.',
          coords:(lat,lng,acc,time)=>`${lat}ØŒ ${lng} â€¢ Â±${acc} Ù…ØªØ± â€¢ ${time}`
        },
        preview:{title:'Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´'},
        picker:{title:'Ø§Ù†ØªØ®Ø§Ø¨ Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡', searchPh:'Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¢Ø¯Ø±Ø³â€¦', searchBtn:'ğŸ” Ø¬Ø³ØªØ¬Ùˆ', useBtn:'Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§ÛŒÙ† Ù†Ù‚Ø·Ù‡', help:'Ù¾ÛŒÙ† Ø±Ø§ Ø¨Ú©Ø´ÛŒØ¯ ÛŒØ§ Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡ Ø¨Ø²Ù†ÛŒØ¯. Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø§Ø¹Ø« Ø²ÙˆÙ… Ù…ØªÙ†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯.'},
        settings:{
          title:'ØªÙ†Ø¸ÛŒÙ…Ø§Øª',
          customTpl:'Ù‚Ø§Ù„Ø¨ Ù„ÛŒÙ†Ú© Ø³ÙØ§Ø±Ø´ÛŒ (Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯ÛŒÚ¯Ø±)',
          customHelp:'Ø¬Ø§ÛŒâ€ŒÚ¯Ø°Ø§Ø±Ù‡Ø§: {lat}ØŒ {lng}ØŒ {name} â€” Ù…Ø«Ø§Ù„: waze://?ll={lat},{lng}&navigate=yes',
          categories:'Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§',
          newCatPh:'Ù†Ø§Ù… Ø¯Ø³ØªÙ‡ (Ù…Ø«Ù„Ø§Ù‹: Ù¾Ø§Ø±Ú©ÛŒÙ†Ú¯)',
          newCatIconPh:'Ø§ÛŒÙ…ÙˆØ¬ÛŒ (Ù…Ø«Ù„Ø§Ù‹: ğŸ…¿ï¸)',
          catTip:'Ø§Ø² Ø§ÛŒÙ…ÙˆØ¬ÛŒ Ø¨Ù‡â€ŒØ¹Ù†ÙˆØ§Ù† Ø¢ÛŒÚ©Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯ (ğŸ  ğŸ’¼ ğŸ…¿ï¸ â­ ğŸ‘¤ ğŸ“Œ).',
          shareTitle:'Ø¹Ù†ÙˆØ§Ù† Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ',
          testLink:'Ø¢Ø²Ù…ÙˆÙ† Ù„ÛŒÙ†Ú©',
          edit:'ÙˆÛŒØ±Ø§ÛŒØ´', del:'Ø­Ø°Ù', updated:'Ø¯Ø³ØªÙ‡ Ø¨Ù‡â€ŒØ±ÙˆØ² Ø´Ø¯', deleted:'Ø­Ø°Ù Ø´Ø¯'
        },
        save:{
          title:'Ø°Ø®ÛŒØ±Ù‡ Ù…Ú©Ø§Ù†', nameLabel:'Ù†Ø§Ù…', namePh:'Ù†Ù‚Ø·Ù‡ Ù…Ù†', catLabel:'Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ',
          newCatNamePh:'Ù†Ø§Ù… Ø¯Ø³ØªÙ‡ Ø¬Ø¯ÛŒØ¯', newCatIconPh:'Ø§ÛŒÙ…ÙˆØ¬ÛŒ (ğŸ“Œ)',
          notesLabel:'ÛŒØ§Ø¯Ø¯Ø§Ø´Øª', notesPh:'ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø§Ø®ØªÛŒØ§Ø±ÛŒ (Ú©Ø¯ Ø¯Ø±ØŒ Ø·Ø¨Ù‚Ù‡ØŒ ØªÙ…Ø§Ø³â€¦)'
        },
        common:{share:'â†—ï¸ Ø§Ø´ØªØ±Ø§Ú©', add:'Ø§ÙØ²ÙˆØ¯Ù†', save:'Ø°Ø®ÛŒØ±Ù‡', cancel:'Ø§Ù†ØµØ±Ø§Ù'},
        backup:{export:'â¬‡ï¸ Ø®Ø±ÙˆØ¬ÛŒ', import:'â¬†ï¸ ÙˆØ±ÙˆØ¯', backup:'ğŸ§° Ù¾Ø´ØªÛŒØ¨Ø§Ù†', restore:'ğŸ§³ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ', clearAll:'ğŸ—‘ï¸ Ø­Ø°Ù Ù‡Ù…Ù‡',
          importOk:'ÙˆØ±ÙˆØ¯ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯', importFail:'ÙˆØ±ÙˆØ¯ Ù†Ø§Ù…ÙˆÙÙ‚', restoreOk:'Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯', restoreFail:'Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ù†Ø§Ù…ÙˆÙÙ‚', cleared:'Ù¾Ø§Ú© Ø´Ø¯'
        },
        toasts:{
          copied:'Ú©Ù¾ÛŒ Ø´Ø¯', copyFail:'Ú©Ù¾ÛŒ Ù†Ø§Ù…ÙˆÙÙ‚', shareCopied:'Ù…ØªÙ† Ø§Ø´ØªØ±Ø§Ú© Ø¯Ø± Ú©Ù„ÛŒÙ¾â€ŒØ¨ÙˆØ±Ø¯ Ø§Ø³Øª', shareFail:'Ø§Ø´ØªØ±Ø§Ú© Ù†Ø§Ù…ÙˆÙÙ‚',
          saved:'Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ â­', updated:'Ø¨Ù‡â€ŒØ±ÙˆØ² Ø´Ø¯ âœ…', deleted:'Ø­Ø°Ù Ø´Ø¯', notFound:'Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯', found:'ÛŒØ§ÙØª Ø´Ø¯',
          searchErr:'Ø®Ø·Ø§ÛŒ Ø¬Ø³ØªØ¬Ùˆ', needCustom:'Ø§Ø¨ØªØ¯Ø§ Ù‚Ø§Ù„Ø¨ Ù„ÛŒÙ†Ú© Ø³ÙØ§Ø±Ø´ÛŒ Ø±Ø§ Ø¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯',
          settingsSaved:'ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', enterCatName:'Ù†Ø§Ù… Ø¯Ø³ØªÙ‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', catAdded:'Ø¯Ø³ØªÙ‡ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯',
          geoUnsupported:'Ø§ÛŒÙ† Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø§Ø² Ù…Ú©Ø§Ù†â€ŒÛŒØ§Ø¨ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯', geoError:'Ø®Ø·Ø§ÛŒ Ù…Ú©Ø§Ù†'
        },
        dialogs:{
          deletePlace:'Ø§ÛŒÙ† Ù…Ú©Ø§Ù† Ø­Ø°Ù Ø´ÙˆØ¯ØŸ', clearAll:'Ù‡Ù…Ù‡Ù” Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§ Ø­Ø°Ù Ø´ÙˆÙ†Ø¯ØŸ', namePromptDefault:'Ø¨Ø¯ÙˆÙ† Ù†Ø§Ù…'
        },
        catsDefault:[
          {id:'home',name:'Ø®Ø§Ù†Ù‡',icon:'ğŸ '},
          {id:'work',name:'Ú©Ø§Ø±',icon:'ğŸ’¼'},
          {id:'parking',name:'Ù¾Ø§Ø±Ú©ÛŒÙ†Ú¯',icon:'ğŸ…¿ï¸'},
          {id:'fav',name:'Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒ',icon:'â­'},
          {id:'customer',name:'Ù…Ø´ØªØ±ÛŒ',icon:'ğŸ‘¤'}
        ]
      },
      en: {
        locale:'en-US', dir:'ltr',
        subtitle:'GPS bookmarks â€¢ offline â€¢ share',
        theme:{auto:'Auto', light:'Light', dark:'Dark'},
        footer:'App created by <b>Peymaan Abedinpour V0.03</b>',
        current:{
          title:'Current Location', getPrecise:'ğŸ“ Get Precise', mapPicker:'ğŸ—ºï¸ Map Picker', save:'â­ Save',
          lat:'lat: â€”', lng:'lng: â€”', acc:'accuracy: â€”', resolving:'ğŸ“ Resolving addressâ€¦',
          copyLat:'ğŸ“‹ Copy lat', copyLng:'ğŸ“‹ Copy lng', copyBoth:'ğŸ“‹ Copy lat,lng',
          timestamp:(s)=>'Timestamp: '+s, accUnit:(m)=>'accuracy: Â±'+m+' m', latVal:(v)=>'lat: '+v, lngVal:(v)=>'lng: '+v
        },
        perm:{unknown:'Permission: <b>unknown</b>', granted:'Permission: <b style="color:var(--accent-2)">granted</b>', denied:'Permission: <b style="color:var(--danger)">denied</b>', prompt:'Permission: <b>prompt</b>'},
        maps:{apple:'ğŸ—ºï¸ Apple', google:'ğŸ—ºï¸ Google', waze:'ğŸš˜ Waze', appleDir:'â¡ï¸ Apple Directions', otherApp:'ğŸ”— Other App'},
        saved:{
          title:'Saved Places',
          searchPh:'Search name, address, notesâ€¦',
          empty:'No places yet. Use <b>Get Precise</b> or <b>Map Picker</b>.',
          coords:(lat,lng,acc,time)=>`${lat}, ${lng} â€¢ Â±${acc} m â€¢ ${time}`
        },
        preview:{title:'Preview'},
        picker:{title:'Pick on Map', searchPh:'Search addressâ€¦', searchBtn:'ğŸ” Search', useBtn:'Use This Point', help:'Drag the pin or tap the map. Search wonâ€™t trigger text zoom.'},
        settings:{
          title:'Settings',
          customTpl:'Custom URL template (Other App)',
          customHelp:'Placeholders: {lat}, {lng}, {name} â€” Example: waze://?ll={lat},{lng}&navigate=yes',
          categories:'Categories',
          newCatPh:'Category name (e.g., Parking)',
          newCatIconPh:'Emoji (e.g., ğŸ…¿ï¸)',
          catTip:'Use emoji as icons (ğŸ  ğŸ’¼ ğŸ…¿ï¸ â­ ğŸ‘¤ ğŸ“Œ).',
          shareTitle:'Share title',
          testLink:'Test Custom',
          edit:'Edit', del:'Delete', updated:'Category updated', deleted:'Deleted'
        },
        save:{
          title:'Save Location', nameLabel:'Name', namePh:'My Spot', catLabel:'Category',
          newCatNamePh:'New category name', newCatIconPh:'Emoji (ğŸ“Œ)',
          notesLabel:'Notes', notesPh:'Optional notes (gate code, floor, contactâ€¦)'
        },
        common:{share:'â†—ï¸ Share', add:'Add', save:'Save', cancel:'Cancel'},
        backup:{export:'â¬‡ï¸ Export', import:'â¬†ï¸ Import', backup:'ğŸ§° Backup', restore:'ğŸ§³ Restore', clearAll:'ğŸ—‘ï¸ Clear All',
          importOk:'Imported', importFail:'Import failed', restoreOk:'Backup restored', restoreFail:'Restore failed', cleared:'Cleared'
        },
        toasts:{
          copied:'Copied', copyFail:'Copy failed', shareCopied:'Share copied', shareFail:'Share failed',
          saved:'Saved â­', updated:'Updated âœ…', deleted:'Deleted', notFound:'Not found', found:'Found',
          searchErr:'Search error', needCustom:'Set a custom URL in Settings first',
          settingsSaved:'Settings saved', enterCatName:'Enter a category name', catAdded:'Category added',
          geoUnsupported:'Geolocation not supported', geoError:'Location error'
        },
        dialogs:{
          deletePlace:'Delete this place?', clearAll:'Remove ALL saved places?', namePromptDefault:'Unnamed'
        },
        catsDefault:[
          {id:'home',name:'Home',icon:'ğŸ '},
          {id:'work',name:'Work',icon:'ğŸ’¼'},
          {id:'parking',name:'Parking',icon:'ğŸ…¿ï¸'},
          {id:'fav',name:'Favorite',icon:'â­'},
          {id:'customer',name:'Customer',icon:'ğŸ‘¤'}
        ]
      }
    };

    const PREF_THEME='saveloc.theme';
    const PREF_LANG='saveloc.lang';
    let LANG = localStorage.getItem(PREF_LANG) || 'fa';

    function applyTheme(val){
      const themeButtons = [themeAuto, themeLight, themeDark];
      const htmlEl = document.documentElement;

      htmlEl.removeAttribute('data-theme');
      if (val === 'light' || val === 'dark') {
        htmlEl.setAttribute('data-theme', val);
      }
      
      themeButtons.forEach(b => b.classList.remove('bg-[var(--panel)]', 'text-[var(--text)]', 'shadow-xl'));
      
      let pressedButton;
      if (val === 'light') pressedButton = themeLight;
      else if (val === 'dark') pressedButton = themeDark;
      else pressedButton = themeAuto;
      
      themeButtons.forEach(b => b.setAttribute('aria-pressed', 'false'));
      pressedButton.setAttribute('aria-pressed', 'true');
      pressedButton.classList.add('bg-[var(--panel)]', 'text-[var(--text)]', 'shadow-xl');

      localStorage.setItem(PREF_THEME, val);
    }

    [themeAuto,themeLight,themeDark].forEach(btn=>btn.addEventListener('click',()=>applyTheme(btn===themeLight?'light':btn===themeDark?'dark':'auto')));
    
    let current = null;

    function setLang(lang){
      LANG = (lang==='en'?'en':'fa');
      localStorage.setItem(PREF_LANG, LANG);
      document.documentElement.lang = (LANG==='en')?'en':'fa';
      document.documentElement.dir = i18n[LANG].dir;
      
      [langFa, langEn].forEach(b => {
          b.setAttribute('aria-pressed', 'false');
          b.classList.remove('bg-[var(--panel)]', 'text-[var(--text)]', 'shadow-xl');
      });
      const pressedButton = (LANG === 'en') ? langEn : langFa;
      pressedButton.setAttribute('aria-pressed', 'true');
      pressedButton.classList.add('bg-[var(--panel)]', 'text-[var(--text)]', 'shadow-xl');


      // Static texts
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const key = el.getAttribute('data-i18n');
        const val = deepGet(i18n[LANG], key);
        if(typeof val==='string') el.innerHTML = val;
      });
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{
        const key = el.getAttribute('data-i18n-placeholder');
        const val = deepGet(i18n[LANG], key);
        if(typeof val==='string') el.setAttribute('placeholder', val);
      });

      // Update button texts
      locateBtn.innerHTML = i18n[LANG].current.getPrecise;
      openPicker.innerHTML = i18n[LANG].current.mapPicker;
      saveLiveBtn.innerHTML = i18n[LANG].current.save;
      shareBtn.innerHTML = i18n[LANG].common.share;
      copyLat.innerHTML = i18n[LANG].current.copyLat;
      copyLng.innerHTML = i18n[LANG].current.copyLng;
      copyBoth.innerHTML = i18n[LANG].current.copyBoth;
      openApple.innerHTML = i18n[LANG].maps.apple;
      openGoogle.innerHTML = i18n[LANG].maps.google;
      openWaze.innerHTML = i18n[LANG].maps.waze;
      dirApple.innerHTML = i18n[LANG].maps.appleDir;
      openCustom.innerHTML = i18n[LANG].maps.otherApp;
      exportBtn.innerHTML = i18n[LANG].backup.export;
      importBtn.innerHTML = i18n[LANG].backup.import;
      backupBtn.innerHTML = i18n[LANG].backup.backup;
      restoreBtn.innerHTML = i18n[LANG].backup.restore;
      clearAllBtn.innerHTML = i18n[LANG].backup.clearAll;
      testCustom.innerHTML = i18n[LANG].settings.testLink;
      saveSettingsBtn.innerHTML = i18n[LANG].common.save;
      quickAddCat.innerHTML = i18n[LANG].common.add;
      saveCancel.innerHTML = i18n[LANG].common.cancel;
      saveConfirm.innerHTML = i18n[LANG].common.save;
      pickerSearchBtn.innerHTML = i18n[LANG].picker.searchBtn;
      pickerUse.innerHTML = i18n[LANG].picker.useBtn;
      pvApple.innerHTML = i18n[LANG].maps.apple;
      pvGoogle.innerHTML = i18n[LANG].maps.google;
      pvWaze.innerHTML = i18n[LANG].maps.waze;
      pvDir.innerHTML = i18n[LANG].maps.appleDir;
      pvShare.innerHTML = i18n[LANG].common.share;


      // Live labels if we already have current
      if(current){
        latBox.textContent = i18n[LANG].current.latVal(current.lat.toFixed(6));
        lngBox.textContent = i18n[LANG].current.lngVal(current.lng.toFixed(6));
        accBox.textContent = i18n[LANG].current.accUnit(current.acc);
        tsBox.textContent  = i18n[LANG].current.timestamp(new Date(current.ts).toLocaleString(i18n[LANG].locale));
      }else{
        latBox.textContent = i18n[LANG].current.lat;
        lngBox.textContent = i18n[LANG].current.lng;
        accBox.textContent = i18n[LANG].current.acc;
        tsBox.textContent = 'â€”'; // Set a default value to avoid errors
      }
      
      // Update dialog text on lang change
      if(settingsModal.open) settingsBtn.onclick();
      if(saveModal.open) openSaveModal(pendingSave, editId ? 'edit' : 'save');

      // Rerender places for translated action buttons / subtitles
      renderList();
    }
    
    function deepGet(obj, path){
      return path.split('.').reduce((o,k)=>o && o[k], obj);
    }
    langFa.addEventListener('click', ()=>setLang('fa'));
    langEn.addEventListener('click', ()=>setLang('en'));
    
    
    /* Install/A2HS */
    const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    let deferredPrompt=null;
    window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; installBtn.hidden=false; });
    installBtn.addEventListener('click', async ()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; installBtn.hidden=true; });
    if(isIOS && !isStandalone){ a2hsHint.hidden=false; a2hsHint.addEventListener('click', ()=> toast('On iPhone: Share â–¸ Add to Home Screen')); }

    /* Small helpers */
    function toast(msg){ const el=document.getElementById('toast'); el.textContent=msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),1800); }
    function formatTs(t){ return new Date(t).toLocaleString(i18n[LANG].locale); }
    function setProgress(p){ progBar.style.width = Math.max(0, Math.min(100, p)) + '%'; }
    function downloadBlob(data, type, name){ const blob=new Blob([data],{type}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url); }

    /* Permissions */
    async function checkPerm(){
      if(!navigator.permissions || !navigator.geolocation){ permStatus.innerHTML=i18n[LANG].perm.unknown; return; }
      try{
        const st = await navigator.permissions.query({name:'geolocation'});
        const map = { 'granted':i18n[LANG].perm.granted, 'denied':i18n[LANG].perm.denied, 'prompt':i18n[LANG].perm.prompt };
        permStatus.innerHTML = map[st.state] || i18n[LANG].perm.unknown;
        st.onchange = ()=>{ permStatus.innerHTML = map[st.state] || i18n[LANG].perm.unknown; };
      }catch{ permStatus.innerHTML=i18n[LANG].perm.unknown; }
    }
    checkPerm();

    /* Storage */
    const KEY='saveloc.places.v1';
    const PREF='saveloc.prefs.v1';
    const CATS='saveloc.categories.v1';
    function readPlaces(){ try{ return JSON.parse(localStorage.getItem(KEY)) || []; }catch{ return []; } }
    function writePlaces(arr){ localStorage.setItem(KEY, JSON.stringify(arr)); }
    function readPrefs(){ const def={customTpl:'',shareTitle:'Save Loc'}; try{ return {...def, ...(JSON.parse(localStorage.getItem(PREF))||{})}; }catch{ return def; } }
    function writePrefs(p){ localStorage.setItem(PREF, JSON.stringify(p)); }
    function readCats(){
      try{
        const saved = JSON.parse(localStorage.getItem(CATS));
        if(Array.isArray(saved) && saved.length) return saved;
        const def = i18n[LANG].catsDefault;
        localStorage.setItem(CATS, JSON.stringify(def));
        return def;
      }catch{ return i18n[LANG].catsDefault; }
    }
    function writeCats(arr){ localStorage.setItem(CATS, JSON.stringify(arr)); }

    /* Reverse Geocode (cached) */
    function reverseGeocode(lat,lng){
      const key='addr:'+lat.toFixed(5)+','+lng.toFixed(5);
      const cached=localStorage.getItem(key); if(cached) return Promise.resolve(cached);
      return fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}&zoom=18&addressdetails=0`,{headers:{'Accept':'application/json'}})
        .then(r=>r.ok?r.json():Promise.reject()).then(j=>j.display_name||'').then(addr=>{ if(addr) localStorage.setItem(key,addr); return addr; })
        .catch(()=> '');
    }

    /* Map links */
    const appleLink = (lat,lng,name='') => `https://maps.apple.com/?ll=${lat},${lng}&q=${encodeURIComponent(name||`${lat.toFixed(6)},${lng.toFixed(6)}`)}`;
    const googleLink = (lat,lng) => `http://maps.google.com/maps?q=${lat},${lng}`;
    const wazeLink = (lat,lng) => `https://waze.com/ul?ll=${lat},${lng}&navigate=yes`;
    const appleDirections = (lat,lng,addr='') => `https://maps.apple.com/?daddr=${lat},${lng}&q=${encodeURIComponent(addr||`${lat.toFixed(6)},${lng.toFixed(6)}`)}&dirflg=d&saddr=Current%20Location`;
    function customLink(lat,lng,name){ const {customTpl}=readPrefs(); if(!customTpl) return ''; return customTpl.replaceAll('{lat}',lat).replaceAll('{lng}',lng).replaceAll('{name}',encodeURIComponent(name||'')); }

    /* Live Location */
    function enableLive(on){
      [saveLiveBtn,shareBtn,openApple,openGoogle,openWaze,dirApple,openCustom,copyLat,copyLng,copyBoth].forEach(b=>b.disabled=!on);
    }
    locateBtn.addEventListener('click', ()=>{
      if(!navigator.geolocation){ toast(i18n[LANG].toasts.geoUnsupported); return; }
      setProgress(10); addrRow.style.display='none';
      navigator.geolocation.getCurrentPosition(onPos,onErr,{enableHighAccuracy:true,timeout:15000,maximumAge:0});
      let t=10, iv=setInterval(()=>{ t=Math.min(95,t+4); setProgress(t); },300);
      function onPos(pos){
        clearInterval(iv); setProgress(100);
        const {latitude,longitude,accuracy}=pos.coords;
        current={lat:latitude,lng:longitude,acc:Math.round(accuracy),ts:Date.now()};
        latBox.textContent=i18n[LANG].current.latVal(latitude.toFixed(6));
        lngBox.textContent=i18n[LANG].current.lngVal(longitude.toFixed(6));
        accBox.textContent=i18n[LANG].current.accUnit(Math.round(accuracy));
        tsBox.textContent=i18n[LANG].current.timestamp(new Date(current.ts).toLocaleString(i18n[LANG].locale));
        enableLive(true);
        reverseGeocode(latitude,longitude).then(addr=>{ if(addr){ current.address=addr; addrChip.textContent='ğŸ“ '+addr; addrRow.style.display='flex'; } });
        setTimeout(()=>setProgress(0),400);
      }
      function onErr(err){ clearInterval(iv); setProgress(0); toast(err.message||i18n[LANG].toasts.geoError); }
    });

    copyLat.onclick = async ()=>{ if(!current) return; try{ await navigator.clipboard.writeText(String(current.lat)); toast(i18n[LANG].toasts.copied); }catch{ toast(i18n[LANG].toasts.copyFail); } };
    copyLng.onclick = async ()=>{ if(!current) return; try{ await navigator.clipboard.writeText(String(current.lng)); toast(i18n[LANG].toasts.copied); }catch{ toast(i18n[LANG].toasts.copyFail); } };
    copyBoth.onclick = async ()=>{ if(!current) return; try{ await navigator.clipboard.writeText(`${current.lat},${current.lng}`); toast(i18n[LANG].toasts.copied); }catch{ toast(i18n[LANG].toasts.copyFail); } };

    shareBtn.addEventListener('click', async ()=>{
      if(!current) return;
      const prefs = readPrefs();
      const url = googleLink(current.lat,current.lng);
      const text = `${current.address? current.address : (LANG==='fa'?'Ù…Ú©Ø§Ù† Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡':'Pinned location')} â€” ${current.lat.toFixed(6)},${current.lng.toFixed(6)} (Â±${current.acc} ${LANG==='fa'?'Ù…ØªØ±':'m'})`;
      if(navigator.share){ try{ await navigator.share({ title:prefs.shareTitle||'Save Loc', text, url }); }catch{} }
      else{ try{ await navigator.clipboard.writeText(`${text}\n${url}`); toast(i18n[LANG].toasts.shareCopied); }catch{ toast(i18n[LANG].toasts.shareFail); } }
    });

    openApple.onclick = ()=>{ if(!current) return; window.open(appleLink(current.lat,current.lng,current.address||'Location'),'_blank','noopener'); };
    openGoogle.onclick = ()=>{ if(!current) return; window.open(googleLink(current.lat,current.lng),'_blank','noopener'); };
    openWaze.onclick = ()=>{ if(!current) return; window.open(wazeLink(current.lat,current.lng),'_blank','noopener'); };
    dirApple.onclick = ()=>{ if(!current) return; window.open(appleDirections(current.lat,current.lng,current.address||'Destination'),'_blank','noopener'); };
    openCustom.onclick = ()=>{ if(!current) return; const url=customLink(current.lat,current.lng,current.address||''); if(url) window.location.href=url; else toast(i18n[LANG].toasts.needCustom); };

    /* Save/Edit */
    let pendingSave = null, editId = null;

    function openSaveModal(record, mode='save'){
      pendingSave = record; editId = (mode==='edit') ? record.id : null;
      saveModalTitle.innerHTML = (mode==='edit') ? (LANG==='fa'?'ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ú©Ø§Ù†':'Edit Location') : i18n[LANG].save.title;
      placeName.value = record.name || (record.address? record.address.split(',')[0] : (LANG==='fa'?'Ù†Ù‚Ø·Ù‡ Ù…Ù†':'My Spot'));
      placeNotes.value = record.notes || '';
      saveLat.textContent = i18n[LANG].current.latVal(record.lat.toFixed(6));
      saveLng.textContent = i18n[LANG].current.lngVal(record.lng.toFixed(6));
      saveAcc.textContent = i18n[LANG].current.accUnit(record.acc ?? 'â€”');
      saveAddr.textContent = 'ğŸ“ ' + (record.address || 'â€”');
      renderCatChips(record.category);
      saveModal.showModal();
    }
    saveLiveBtn.onclick = ()=>{ if(!current) return; openSaveModal({ ...current, name:(LANG==='fa'?'Ù…Ú©Ø§Ù† ÙØ¹Ù„ÛŒ':'Current spot') }, 'save'); };
    closeSave.onclick = ()=> saveModal.close();
    saveCancel.onclick = ()=> saveModal.close();
    saveConfirm.onclick = ()=>{
      if(!pendingSave) return;
      const cat = selectedCatFromChips();
      const place = {
        id: editId || (crypto.randomUUID?.() || (Date.now()+'-'+Math.random().toString(16).slice(2))),
        name: (placeName.value || (LANG==='fa'?i18n[LANG].dialogs.namePromptDefault:'Unnamed')).trim(),
        lat: +pendingSave.lat, lng: +pendingSave.lng, acc: +pendingSave.acc || 0,
        ts: pendingSave.ts || Date.now(),
        address: pendingSave.address || '',
        category: cat, notes: (placeNotes.value||'').trim()
      };
      if(editId){
        const arr=readPlaces(); const i=arr.findIndex(x=>x.id===editId); if(i>-1) arr[i]=place; writePlaces(arr);
        toast(i18n[LANG].toasts.updated);
      }else{
        const arr=readPlaces(); arr.unshift(place); writePlaces(arr);
        toast(i18n[LANG].toasts.saved);
      }
      saveModal.close(); renderList();
    };

    /* Picker */
    let picker = null, pickerMarker = null;
    openPicker.onclick = ()=>{
      pickerModal.showModal();
      setTimeout(initPicker, 20);
    };
    closePicker.onclick = ()=> pickerModal.close();
    function initPicker(){
      if(!picker){
        picker = L.map(pickerMapEl,{zoomControl:true, attributionControl:false}).setView([35.6892,51.3890],13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(picker);
        pickerMarker = L.marker(picker.getCenter(),{draggable:true}).addTo(picker);
        picker.on('click', e=>{ pickerMarker.setLatLng(e.latlng); });
      } else { picker.invalidateSize(); }
      if(current){ picker.setView([current.lat,current.lng],16); pickerMarker.setLatLng([current.lat,current.lng]); }
    }
    pickerSearchBtn.onclick = ()=>{
      const q = pickerSearch.value.trim(); if(!q) return;
      fetch(`https://nominatim.openstreetmap.org/search?format=jsonv2&q=${encodeURIComponent(q)}&limit=1`)
        .then(r=>r.ok?r.json():[]).then(arr=>{
          if(arr && arr[0]){ const {lat,lon}=arr[0]; const latf=+lat, lonf=+lon; picker.setView([latf,lonf],16); pickerMarker.setLatLng([latf,lonf]); toast(i18n[LANG].toasts.found); }
          else toast(i18n[LANG].toasts.notFound);
        }).catch(()=>toast(i18n[LANG].toasts.searchErr));
    };
    pickerUse.onclick = ()=>{
      const {lat,lng} = pickerMarker.getLatLng();
      const rec = {lat: +lat, lng: +lng, acc: 0, ts: Date.now()};
      reverseGeocode(lat,lng).then(addr=>{ if(addr) rec.address=addr; openSaveModal(rec,'save'); });
      pickerModal.close();
    };

    /* Settings: categories */
    const catList = document.getElementById('catList');
    const newCatName = document.getElementById('newCatName');
    const newCatIcon = document.getElementById('newCatIcon');
    const addCatBtn = document.getElementById('addCatBtn');

    function renderCatList(){
      const cats = readCats(); catList.innerHTML='';
      cats.forEach((c,idx)=>{
        const row = document.createElement('div'); row.className='flex items-center justify-between gap-2';
        const left = document.createElement('div'); left.className='chip'; left.textContent = `${c.icon} ${c.name}`;
        const right = document.createElement('div'); right.className='flex items-center gap-2';
        const edit = document.createElement('button'); edit.className='btn bg-[var(--panel-2)] border border-[var(--border)] text-[var(--text)] px-4 py-2 rounded-xl text-sm font-bold hover:bg-[var(--panel)]'; edit.textContent=i18n[LANG].settings.edit;
        edit.onclick = ()=>{
          const nn = prompt(i18n[LANG].settings.edit, c.name); if(nn===null) return;
          const ni = prompt('Emoji', c.icon); if(ni===null) return;
          const arr=readCats(); arr[idx]={...c,name:(nn||c.name).trim(),icon:(ni||c.icon).trim()}; writeCats(arr); renderCatList(); toast(i18n[LANG].settings.updated);
        };
        const del = document.createElement('button'); del.className='btn bg-[var(--danger)] text-white px-4 py-2 rounded-xl text-sm font-bold hover:bg-opacity-80 active:scale-95'; del.textContent=i18n[LANG].settings.del;
        del.onclick = ()=>{
          if(!confirm(i18n[LANG].dialogs.deletePlace)) return;
          const arr=readCats().filter(x=>x.id!==c.id); writeCats(arr); renderCatList(); toast(i18n[LANG].settings.deleted);
        };
        right.append(edit,del); row.append(left,right); catList.appendChild(row);
      });
    }
    function renderCatChips(selected){
      const cats=readCats(); catChips.innerHTML='';
      cats.forEach(c=>{
        const b=document.createElement('button'); b.className='chip text-[var(--text)] focus:outline-none focus:ring-2 focus:ring-[var(--accent)]'; b.setAttribute('aria-pressed', selected && selected.id===c.id ? 'true':'false');
        b.textContent = `${c.icon} ${c.name}`;
        b.onclick = ()=>{
          [...catChips.children].forEach(n=>n.setAttribute('aria-pressed','false'));
          b.setAttribute('aria-pressed','true'); b.dataset.catId = c.id;
        };
        b.dataset.catId = c.id;
        catChips.appendChild(b);
      });
    }
    function selectedCatFromChips(){
      const cats=readCats();
      const btn=[...catChips.children].find(x=>x.getAttribute('aria-pressed')==='true');
      const id=btn?btn.dataset.catId:cats[0]?.id;
      return cats.find(c=>c.id===id) || cats[0];
    }
    quickAddCat.onclick = ()=>{
      const name=(quickCatName.value||'').trim(); const icon=(quickCatIcon.value||'ğŸ“Œ').trim();
      if(!name){ toast(i18n[LANG].toasts.enterCatName); return; }
      const arr=readCats(); const cat={id:(crypto.randomUUID?.() || (Date.now()+'-'+Math.random().toString(16).slice(2))), name, icon}; arr.push(cat); writeCats(arr);
      quickCatName.value=''; quickCatIcon.value='';
      renderCatChips(cat); toast(i18n[LANG].toasts.catAdded);
    };

    settingsBtn.onclick = ()=>{
      const p=readPrefs();
      customTpl.value=p.customTpl||'';
      shareTitle.value=p.shareTitle||'Save Loc';
      // Translate modal labels/placeholders each open (in case language changed)
      settingsModal.querySelectorAll('[data-i18n]').forEach(el=>{ const k=el.getAttribute('data-i18n'); const v=deepGet(i18n[LANG],k); if(typeof v==='string') el.innerHTML=v; });
      settingsModal.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{ const k=el.getAttribute('data-i18n-placeholder'); const v=deepGet(i18n[LANG],k); if(typeof v==='string') el.setAttribute('placeholder',v); });
      renderCatList();
      settingsModal.showModal();
    };
    closeSettings.onclick = ()=> settingsModal.close();
    saveSettingsBtn.onclick = ()=>{ writePrefs({customTpl:customTpl.value.trim(), shareTitle:shareTitle.value.trim()}); toast(i18n[LANG].toasts.settingsSaved); settingsModal.close(); };
    testCustom.onclick = ()=>{
      const tpl=customTpl.value.trim(); if(!tpl){ toast(i18n[LANG].toasts.needCustom); return; }
      const url=tpl.replaceAll('{lat}','35.6892').replaceAll('{lng}','51.3890').replaceAll('{name}',encodeURIComponent('Test'));
      window.location.href=url;
    };

    /* List rendering */
    function renderList(){
      const q=(searchBox.value||'').toLowerCase().trim();
      const items=readPlaces().filter(p=>{
        const hay=(p.name||'')+' '+(p.address||'')+' '+(p.notes||'')+' '+(p.category?.name||'');
        return !q || hay.toLowerCase().includes(q);
      });
      listArea.innerHTML='';
      if(!items.length){
        const d=document.createElement('div'); d.className='border border-dashed border-[var(--border)] rounded-xl p-5 text-center text-[var(--muted)]';
        d.innerHTML = i18n[LANG].saved.empty;
        listArea.appendChild(d); return;
      }

      items.forEach(p=>{
        const card=document.createElement('div'); card.className='bg-[var(--panel)] border border-[var(--border)] rounded-2xl p-4 shadow-xl cursor-pointer';
        card.onclick = (e)=>{ if(e.target.closest('button')) return; card.classList.toggle('open'); card.querySelector('.place-actions').classList.toggle('hidden'); };
        
        const head=document.createElement('div'); head.className='flex items-baseline gap-2';
        const title=document.createElement('div'); title.className='font-extrabold min-w-0 truncate'; title.textContent=`${p.category?.icon||'ğŸ“Œ'} ${p.name}`;
        const sub=document.createElement('div'); sub.className='text-sm text-[var(--muted)] font-mono';
        const latStr = p.lat.toFixed(6), lngStr = p.lng.toFixed(6);
        sub.textContent = i18n[LANG].saved.coords(latStr, lngStr, p.acc, formatTs(p.ts));
        head.append(title);
        
        const meta=document.createElement('div'); meta.className='space-y-1'; meta.appendChild(sub);
        if(p.address){ const a=document.createElement('div'); a.className='text-sm text-[var(--muted)]'; a.textContent='ğŸ“ '+p.address; meta.appendChild(a); }
        if(p.notes){ const n=document.createElement('div'); n.className='text-sm text-[var(--muted)]'; n.textContent=(LANG==='fa'?'ğŸ“ ':'ğŸ“ ')+p.notes; meta.appendChild(n); }

        const headerRow=document.createElement('div'); headerRow.className='flex flex-col gap-2 md:flex-row md:items-center md:justify-between'; headerRow.append(head, meta);

        const actions=document.createElement('div'); actions.className='place-actions hidden mt-3 pt-3 border-t border-[var(--border)] flex flex-wrap gap-2';
        const mk=(label,cls,fn)=>{ const b=document.createElement('button'); b.className=`btn ${cls} px-3 py-2 rounded-xl font-bold flex items-center gap-2 text-sm hover:bg-[var(--panel)]`; b.textContent=label; b.onclick=fn; return b; };

        const previewBtn = mk(i18n[LANG].preview.title,'bg-[var(--panel-2)] border border-[var(--border)] text-[var(--text)]',()=>openPreview(p));
        const appleBtn   = mk(i18n[LANG].maps.apple,'bg-[var(--panel-2)] border border-[var(--border)] text-[var(--text)]',()=>window.open(appleLink(p.lat,p.lng,p.name),'_blank','noopener'));
        const googleBtn  = mk(i18n[LANG].maps.google,'bg-[var(--panel-2)] border border-[var(--border)] text-[var(--text)]',()=>window.open(googleLink(p.lat,p.lng),'_blank','noopener'));
        const wazeBtn    = mk(i18n[LANG].maps.waze,'bg-[var(--panel-2)] border border-[var(--border)] text-[var(--text)]',()=>window.open(wazeLink(p.lat,p.lng),'_blank','noopener'));
        const dirBtn     = mk(i18n[LANG].maps.appleDir,'bg-[var(--panel-2)] border border-[var(--border)] text-[var(--text)]',()=>window.open(appleDirections(p.lat,p.lng,p.address||p.name),'_blank','noopener'));
        const shareBtn2  = mk(i18n[LANG].common.share,'bg-[var(--panel-2)] border border-[var(--border)] text-[var(--text)]',()=>sharePlace(p));
        const copyPair   = mk(i18n[LANG].current.copyBoth, 'bg-[var(--panel-2)] border border-[var(--border)] text-[var(--text)]',async()=>{ try{ await navigator.clipboard.writeText(`${p.lat},${p.lng}`); toast(i18n[LANG].toasts.copied); }catch{ toast(i18n[LANG].toasts.copyFail); } });
        const editBtn    = mk(i18n[LANG].settings.edit,'bg-[var(--panel-2)] border border-[var(--border)] text-[var(--text)]',()=>openSaveModal(p,'edit'));
        const delBtn     = mk(i18n[LANG].settings.del,'bg-[var(--danger)] text-white hover:bg-opacity-80 active:scale-95',()=> { if(confirm(i18n[LANG].dialogs.deletePlace)){ remove(p.id); renderList(); toast(i18n[LANG].toasts.deleted); } });

        actions.append(previewBtn, appleBtn, googleBtn, wazeBtn, dirBtn, shareBtn2, copyPair, editBtn, delBtn);

        card.append(headerRow, actions);
        listArea.appendChild(card);
      });
    }

    async function sharePlace(p){
      const prefs=readPrefs(); const url=googleLink(p.lat,p.lng);
      const text=`${p.name} â€” ${p.lat.toFixed(6)},${p.lng.toFixed(6)} (Â±${p.acc} ${LANG==='fa'?'Ù…ØªØ±':'m'})${p.address? '\n'+p.address:''}${p.notes? '\nğŸ“ '+p.notes:''}`;
      if(navigator.share){ try{ await navigator.share({title:prefs.shareTitle||'Save Loc', text, url}); }catch{} }
      else{ try{ await navigator.clipboard.writeText(`${text}\n${url}`); toast(i18n[LANG].toasts.shareCopied); }catch{ toast(i18n[LANG].toasts.shareFail); } }
    }
    function update(id,patch){ const arr=readPlaces(); const i=arr.findIndex(x=>x.id===id); if(i>-1){ arr[i]={...arr[i],...patch}; writePlaces(arr); } }
    function remove(id){ writePlaces(readPlaces().filter(x=>x.id!==id)); }
    searchBox.addEventListener('input', renderList);

    /* Preview (Leaflet) */
    let preview=null, previewMarker=null;
    function openPreview(p){
      previewModal.showModal();
      setTimeout(()=>{
        if(!preview){
          preview=L.map(previewMapEl,{zoomControl:true, attributionControl:false});
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(preview);
        }
        preview.setView([p.lat,p.lng],16);
        if(previewMarker) preview.removeLayer(previewMarker);
        previewMarker=L.marker([p.lat,p.lng]).addTo(preview);
        preview.invalidateSize();
      },20);
      previewTitle.textContent = i18n[LANG].preview.title + ' â€” ' + (p.category?.icon||'ğŸ“Œ')+' '+p.name;
      previewAddr.textContent = p.address || 'â€”';
      pvApple.onclick = ()=>window.open(appleLink(p.lat,p.lng,p.name),'_blank','noopener');
      pvGoogle.onclick = ()=>window.open(googleLink(p.lat,p.lng),'_blank','noopener');
      pvWaze.onclick = ()=>window.open(wazeLink(p.lat,p.lng),'_blank','noopener');
      pvDir.onclick = ()=>window.open(appleDirections(p.lat,p.lng,p.address||p.name),'_blank','noopener');
      pvShare.onclick = ()=>sharePlace(p);
      if(!p.address){ reverseGeocode(p.lat,p.lng).then(addr=>{ if(addr){ p.address=addr; update(p.id,{address:addr}); previewAddr.textContent=addr; renderList(); } }); }
    }
    closePreview.onclick = ()=> previewModal.close();

    /* Export/Import/Backup/Restore */
    exportBtn.onclick = ()=> downloadBlob(JSON.stringify(readPlaces(),null,2),'application/json','saveloc-places.json');
    importBtn.onclick = ()=> importFile.click();
    importFile.onchange = ()=>{
      const f=importFile.files[0]; if(!f) return;
      const fr=new FileReader(); fr.onload=()=>{
        try{ const arr=JSON.parse(fr.result); if(!Array.isArray(arr)) throw 0;
          const cur=readPlaces(); const map=new Map(cur.map(x=>[x.id,x])); for(const p of arr){ if(p&&p.id){ map.set(p.id,{...map.get(p.id),...p}); } }
          writePlaces([...map.values()].sort((a,b)=>b.ts-a.ts)); renderList(); toast(i18n[LANG].backup.importOk);
        }catch{ toast(i18n[LANG].backup.importFail); }
        importFile.value='';
      }; fr.readAsText(f);
    };

    backupBtn.onclick = ()=>{
      const backup={places:readPlaces(),categories:readCats(),prefs:readPrefs(),version:1,saved_at:new Date().toISOString()};
      downloadBlob(JSON.stringify(backup,null,2),'application/json','saveloc-backup.json');
    };
    restoreBtn.onclick = ()=> restoreFile.click();
    restoreFile.onchange = ()=>{
      const f=restoreFile.files[0]; if(!f) return;
      const fr=new FileReader(); fr.onload=()=>{
        try{ const obj=JSON.parse(fr.result);
          if(!obj || !Array.isArray(obj.places) || !Array.isArray(obj.categories)) throw 0;
          writePlaces(obj.places||[]); writeCats(obj.categories||[]); if(obj.prefs) writePrefs(obj.prefs);
          renderList(); toast(i18n[LANG].backup.restoreOk);
        }catch{ toast(i18n[LANG].backup.restoreFail); }
        restoreFile.value='';
      }; fr.readAsText(f);
    };

    clearAllBtn.onclick = ()=>{ if(confirm(i18n[LANG].dialogs.clearAll)){ localStorage.removeItem(KEY); renderList(); toast(i18n[LANG].backup.cleared); } };

    /* Settings open */
    settingsBtn.addEventListener('click', ()=>{}); // handled above in onclick

    /* Install language texts initially (already setLang), render */
    setLang(LANG);
    applyTheme(localStorage.getItem(PREF_THEME)||'auto');
    enableLive(false);
    renderList();

  </script>
</body>
</html>