<!DOCTYPE html>
<html lang="fa" dir="rtl" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" media="(prefers-color-scheme: dark)">
  <meta name="theme-color" content="#f7f7fb" media="(prefers-color-scheme: light)">
  <title>Save Loc — ذخیره مکان</title>

  <!-- App icons -->
  <link rel="apple-touch-icon" href="https://i.postimg.cc/vT811GJ3/App-Icon-2x.png" />
  <link rel="icon" href="https://i.postimg.cc/vT811GJ3/App-Icon-2x.png" />

  <!-- Vazirmatn (FA) -->
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- Leaflet (map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />

  <style>
    :root{
      --bg:#0b1220;--bg-grad:#0e1628;--panel:#0f1726;--panel-2:#121a2b;--muted:#8aa0bf;--text:#eef3ff;
      --accent:#0a84ff;--accent-2:#34d399;--danger:#ff453a;--border:#1f273a;--shadow:0 14px 34px rgba(0,0,0,.30);
      --radius:18px;--gap:14px;--radius-sm:12px;--ring:0 0 0 3px color-mix(in oklab,var(--accent) 35%,transparent);
      --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom);
    }
    @media (prefers-color-scheme:light){
      :root{
        --bg:#f7f7fb;--bg-grad:#fff;--panel:#ffffff;--panel-2:#fafafa;--muted:#6e7a8a;--text:#0d0f14;
        --accent:#007aff;--accent-2:#34c759;--danger:#ff3b30;--border:#e7e9ee;--shadow:0 12px 28px rgba(0,0,0,.08);
      }
    }
    [data-theme="light"]{
      --bg:#f7f7fb;--bg-grad:#fff;--panel:#ffffff;--panel-2:#fafafa;--muted:#6e7a8a;--text:#0d0f14;
      --accent:#007aff;--accent-2:#34c759;--danger:#ff3b30;--border:#e7e9ee;--shadow:0 12px 28px rgba(0,0,0,.08);
    }
    [data-theme="dark"]{
      --bg:#0b1220;--bg-grad:#0e1628;--panel:#0f1726;--panel-2:#121a2b;--muted:#8aa0bf;--text:#eef3ff;
      --accent:#0a84ff;--accent-2:#34d399;--danger:#ff453a;--border:#1f273a;--shadow:0 14px 34px rgba(0,0,0,.30);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:linear-gradient(180deg,var(--bg) 0%,var(--bg) 55%,var(--bg-grad) 100%);
      color:var(--text);
      font:16px/1.6 "Vazirmatn",-apple-system,system-ui,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
      -webkit-text-size-adjust:100%;
      accent-color: var(--accent);
      -webkit-tap-highlight-color: transparent;
    }

    /* App Bar */
    .appbar{
      position:sticky;top:0;z-index:30;background:color-mix(in oklab,var(--bg) 88%,transparent);
      backdrop-filter:blur(10px);border-bottom:1px solid var(--border);padding-top:var(--safe-top);
    }
    .appbar .row{display:flex;align-items:center;gap:12px;padding:10px 12px;max-width:980px;margin-inline:auto}
    .brand{display:flex;align-items:center;gap:12px;min-width:0}
    .brand img{width:30px;height:30px;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,.20)}
    .brand .title{font-weight:800;letter-spacing:.1px;white-space:nowrap}
    .brand .sub{font-size:12.5px;color:var(--muted);white-space:nowrap}
    .grow{flex:1}

    .seg{background:var(--panel-2);border:1px solid var(--border);padding:4px;border-radius:999px;display:flex;gap:4px}
    .seg button{border:0;background:transparent;padding:8px 12px;border-radius:999px;color:var(--muted);font-weight:600;min-height:44px}
    .seg button[aria-pressed="true"]{background:var(--panel);color:var(--text);box-shadow:var(--shadow)}

    .icon-btn{appearance:none;background:var(--panel-2);border:1px solid var(--border);border-radius:12px;padding:10px;cursor:pointer;min-height:44px}
    .icon-btn:active{transform:translateY(1px)}
    .icon-btn:focus-visible{outline:none;box-shadow:var(--ring)}

    /* Layout */
    .wrap{max-width:980px;margin-inline:auto;padding:14px;padding-bottom:calc(14px + var(--safe-bottom))}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .grid{display:grid;gap:18px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .pill{border-radius:999px;padding:10px 12px;font-size:13px;color:var(--muted);border:1px solid var(--border);background:var(--panel-2)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}

    input[type="text"],input[type="search"],textarea{
      width:100%;padding:13px 14px;border-radius:12px;border:1px solid var(--border);background:var(--panel-2);color:var(--text);font-size:16px;min-height:44px
    }
    input::placeholder,textarea::placeholder{color:color-mix(in oklab,var(--muted) 80%,transparent)}
    .btn{appearance:none;border:1px solid var(--border);border-radius:12px;padding:12px 14px;font-weight:700;display:inline-flex;align-items:center;gap:8px;cursor:pointer;background:var(--panel-2);color:var(--text);min-height:44px}
    .btn:active{transform:translateY(1px)}
    .btn:focus-visible{outline:none;box-shadow:var(--ring)}
    .primary{background:linear-gradient(180deg,color-mix(in oklab,var(--accent) 90%,#fff 10%),var(--accent));color:#fff;border:none}
    .success{background:linear-gradient(180deg,color-mix(in oklab,var(--accent-2) 85%,#fff 15%),var(--accent-2));color:#042a18;border:none}
    .danger{background:linear-gradient(180deg,#ff6b6b,var(--danger));color:#fff;border:none}
    .ghost{background:var(--panel-2)}

    .progress{height:6px;background:var(--panel-2);border-radius:999px;overflow:hidden}
    .progress>i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent-2))}

    /* List Cards */
    .empty{border:1px dashed var(--border);border-radius:12px;padding:20px;text-align:center;color:var(--muted)}
    .place{border:1px solid var(--border);border-radius:16px;background:linear-gradient(180deg,var(--panel),color-mix(in oklab,var(--panel) 75%,var(--panel-2) 25%));padding:12px}
    .place-h{display:flex;align-items:baseline;gap:10px}
    .place-title{font-weight:800;min-width:0;overflow:hidden;text-overflow:ellipsis}
    .place-sub{font-size:13px;color:var(--muted)}
    .place-actions{display:none;margin-top:12px;gap:8px;flex-wrap:wrap}
    .place.open .place-actions{display:flex}
    .place:hover{transform:translateY(-1px);transition:.15s ease;box-shadow:0 6px 20px rgba(0,0,0,.15)}

    /* Chips */
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:9px 12px;border:1px solid var(--border);background:var(--panel-2);border-radius:999px;cursor:pointer;min-height:40px}
    .chip[aria-pressed="true"]{background:var(--panel);box-shadow:var(--shadow)}
    .chip:focus-visible{outline:none;box-shadow:var(--ring)}

    /* Dialogs */
    dialog{width:min(640px,94vw);border:1px solid var(--border);background:var(--panel);color:var(--text);border-radius:16px;padding:0;box-shadow:var(--shadow)}
    dialog::backdrop{background:rgba(0,0,0,.55)}
    .modal-head{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
    .modal-body{padding:14px 16px;display:grid;gap:14px}
    .modal-actions{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-start}
    .help{font-size:12.5px;color:var(--muted)}

    /* Maps */
    #pickerMap, #previewMap{width:100%;height:min(60vh,460px);border-radius:14px;border:1px solid var(--border);overflow:hidden}

    /* Toast */
    .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:var(--panel);border:1px solid var(--border);padding:10px 14px;border-radius:12px;color:var(--text);box-shadow:var(--shadow);opacity:0;pointer-events:none;transition:.25s;z-index:60}
    .toast.show{opacity:1;pointer-events:auto;bottom:28px}

    footer{padding:12px;text-align:center;color:var(--muted)}
  </style>
</head>
<body>
  <!-- App Bar -->
  <div class="appbar">
    <div class="row">
      <div class="brand" style="min-width:0">
        <img src="https://i.postimg.cc/vT811GJ3/App-Icon-2x.png" alt="Save Loc icon" />
        <div style="min-width:0">
          <div class="title">Save Loc</div>
          <div class="sub" data-i18n="subtitle">ذخیره مکان • آفلاین • اشتراک</div>
        </div>
      </div>
      <div class="grow"></div>

      <!-- Theme -->
      <div class="seg" role="tablist" aria-label="Theme">
        <button id="themeAuto" aria-pressed="true" data-i18n="theme.auto">خودکار</button>
        <button id="themeLight" aria-pressed="false" data-i18n="theme.light">روشن</button>
        <button id="themeDark" aria-pressed="false" data-i18n="theme.dark">تاریک</button>
      </div>

      <!-- Language (always shows both labels; فارسی is visible even when EN is active) -->
      <div class="seg" role="tablist" aria-label="Language" style="margin-inline-start:8px">
        <button id="langFa" aria-pressed="true">فا</button>
        <button id="langEn" aria-pressed="false">EN</button>
      </div>

      <button id="installBtn" class="icon-btn" hidden title="Install">⬇️</button>
      <button id="a2hsHint" class="icon-btn" hidden title="Add to Home">＋</button>
      <button id="settingsBtn" class="icon-btn" title="Settings">⚙️</button>
    </div>
  </div>

  <main class="wrap grid" style="padding-top:10px">
    <!-- Live location -->
    <section class="card grid">
      <div class="row" style="justify-content:space-between">
        <h2 style="margin:0;font-size:16px" data-i18n="current.title">مکان فعلی</h2>
        <span id="permStatus" class="pill" data-i18n="perm.unknown">دسترسی: <b>نامشخص</b></span>
      </div>
      <div class="progress"><i id="progBar"></i></div>

      <div class="row">
        <button id="locateBtn" class="btn primary" data-i18n="current.getPrecise">📍 موقعیت دقیق</button>
        <button id="openPicker" class="btn ghost" data-i18n="current.mapPicker">🗺️ انتخاب روی نقشه</button>
        <button id="saveLiveBtn" class="btn success" disabled data-i18n="current.save">⭐ ذخیره</button>
        <button id="shareBtn" class="btn ghost" disabled data-i18n="common.share">↗︎ اشتراک</button>
      </div>

      <div class="row">
        <div class="pill mono" id="latBox" data-i18n="current.lat">عرض: –</div>
        <div class="pill mono" id="lngBox" data-i18n="current.lng">طول: –</div>
        <div class="pill" id="accBox" data-i18n="current.acc">دقت: –</div>
      </div>
      <div class="row">
        <button id="copyLat" class="btn ghost" disabled data-i18n="current.copyLat">📋 کپی عرض</button>
        <button id="copyLng" class="btn ghost" disabled data-i18n="current.copyLng">📋 کپی طول</button>
        <button id="copyBoth" class="btn ghost" disabled data-i18n="current.copyBoth">📋 کپی عرض،طول</button>
      </div>
      <div class="row" id="addrRow" style="display:none">
        <div class="pill" id="addrChip" data-i18n="current.resolving">📍 درحال دریافت آدرس…</div>
      </div>
      <div class="muted" id="tsBox">—</div>

      <div class="row">
        <button id="openApple" class="btn" disabled data-i18n="maps.apple">🗺️ اپل</button>
        <button id="openGoogle" class="btn" disabled data-i18n="maps.google">🗺️ گوگل</button>
        <button id="openWaze" class="btn" disabled data-i18n="maps.waze">🚘 ویز</button>
        <button id="dirApple" class="btn" disabled data-i18n="maps.appleDir">➡️ مسیـریابی اپل</button>
        <button id="openCustom" class="btn" disabled data-i18n="maps.otherApp">🔗 برنامه دیگر</button>
      </div>
    </section>

    <!-- Saved places -->
    <section class="card grid">
      <div class="row" style="justify-content:space-between">
        <h2 style="margin:0;font-size:16px" data-i18n="saved.title">مکان‌های ذخیره‌شده</h2>
        <input id="searchBox" type="search" data-i18n-placeholder="saved.searchPh" placeholder="جستجو: نام، آدرس، یادداشت…" aria-label="Search" />
      </div>
      <div id="listArea" class="grid">
        <div class="empty" data-i18n="saved.empty">هنوز مکانی ذخیره نشده. از <b>موقعیت دقیق</b> یا <b>انتخاب روی نقشه</b> استفاده کنید.</div>
      </div>
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <button id="exportBtn" class="btn ghost" data-i18n="backup.export">⬇️ خروجی</button>
          <input id="importFile" type="file" accept="application/json" hidden />
          <button id="importBtn" class="btn ghost" data-i18n="backup.import">⬆️ ورود</button>
        </div>
        <div class="row">
          <button id="backupBtn" class="btn ghost" data-i18n="backup.backup">🧰 پشتیبان</button>
          <input id="restoreFile" type="file" accept="application/json" hidden />
          <button id="restoreBtn" class="btn ghost" data-i18n="backup.restore">🧳 بازیابی</button>
          <button id="clearAllBtn" class="btn danger" data-i18n="backup.clearAll">🗑️ حذف همه</button>
        </div>
      </div>
    </section>
  </main>

  <footer data-i18n="footer">ساخته شده توسط <b>peym</b></footer>
  <div id="toast" class="toast" role="status" aria-live="polite">—</div>

  <!-- Settings -->
  <dialog id="settingsModal">
    <div class="modal-head">
      <strong data-i18n="settings.title">تنظیمات</strong>
      <div class="grow"></div>
      <button id="closeSettings" class="icon-btn" title="Close">✕</button>
    </div>
    <div class="modal-body">
      <div>
        <label for="customTpl" class="muted" data-i18n="settings.customTpl">قالب لینک سفارشی (برنامه دیگر)</label>
        <input id="customTpl" type="text" placeholder="myapp://open?lat={lat}&lng={lng}&name={name}" />
        <div class="help" data-i18n="settings.customHelp">جای‌گذارها: {lat}، {lng}، {name} — مثال: waze://?ll={lat},{lng}&navigate=yes</div>
      </div>

      <div>
        <label class="muted" data-i18n="settings.categories">دسته‌بندی‌ها</label>
        <div id="catList" class="grid" style="grid-template-columns:repeat(auto-fill,minmax(220px,1fr))"></div>
        <div class="row">
          <input id="newCatName" type="text" data-i18n-placeholder="settings.newCatPh" placeholder="نام دسته (مثلاً: پارکینگ)" />
          <input id="newCatIcon" type="text" data-i18n-placeholder="settings.newCatIconPh" placeholder="ایموجی (مثلاً: 🅿️)" style="max-width:140px" />
          <button id="addCatBtn" class="btn success" data-i18n="common.add">افزودن</button>
        </div>
        <div class="help" data-i18n="settings.catTip">از ایموجی به‌عنوان آیکن استفاده کنید (🏠 💼 🅿️ ⭐ 👤 📌).</div>
      </div>

      <div>
        <label for="shareTitle" class="muted" data-i18n="settings.shareTitle">عنوان اشتراک‌گذاری</label>
        <input id="shareTitle" type="text" placeholder="Save Loc" />
      </div>
    </div>
    <div class="modal-actions">
      <button id="testCustom" class="btn ghost" data-i18n="settings.testLink">آزمون لینک</button>
      <div class="grow"></div>
      <button id="saveSettings" class="btn primary" data-i18n="common.save">ذخیره</button>
    </div>
  </dialog>

  <!-- Save/Edit -->
  <dialog id="saveModal">
    <div class="modal-head">
      <strong id="saveModalTitle" data-i18n="save.title">ذخیره مکان</strong>
      <div class="grow"></div>
      <button id="closeSave" class="icon-btn">✕</button>
    </div>
    <div class="modal-body">
      <div>
        <label class="muted" for="placeName" data-i18n="save.nameLabel">نام</label>
        <input id="placeName" type="text" data-i18n-placeholder="save.namePh" placeholder="نقطه من" />
      </div>
      <div>
        <label class="muted" data-i18n="save.catLabel">دسته‌بندی</label>
        <div id="catChips" class="chips"></div>
        <div class="row">
          <input id="quickCatName" type="text" data-i18n-placeholder="save.newCatNamePh" placeholder="نام دسته جدید" />
          <input id="quickCatIcon" type="text" data-i18n-placeholder="save.newCatIconPh" placeholder="ایموجی (📌)" style="max-width:140px" />
          <button id="quickAddCat" class="btn success" data-i18n="common.add">افزودن</button>
        </div>
      </div>
      <div>
        <label class="muted" for="placeNotes" data-i18n="save.notesLabel">یادداشت</label>
        <textarea id="placeNotes" rows="3" data-i18n-placeholder="save.notesPh" placeholder="یادداشت اختیاری (کد در، طبقه، تماس…)"></textarea>
      </div>
      <div class="row">
        <div class="pill mono" id="saveLat" data-i18n="current.lat">عرض: —</div>
        <div class="pill mono" id="saveLng" data-i18n="current.lng">طول: —</div>
        <div class="pill" id="saveAcc" data-i18n="current.acc">دقت: —</div>
      </div>
      <div class="row"><div class="pill" id="saveAddr">📍 —</div></div>
    </div>
    <div class="modal-actions">
      <button id="saveCancel" class="btn ghost" data-i18n="common.cancel">انصراف</button>
      <button id="saveConfirm" class="btn primary" data-i18n="common.save">ذخیره</button>
    </div>
  </dialog>

  <!-- Map Picker -->
  <dialog id="pickerModal">
    <div class="modal-head">
      <strong data-i18n="picker.title">انتخاب روی نقشه</strong>
      <div class="grow"></div>
      <button id="closePicker" class="icon-btn">✕</button>
    </div>
    <div class="modal-body">
      <div id="pickerMap"></div>
      <div class="row" style="margin-top:8px">
        <input id="pickerSearch" type="text" data-i18n-placeholder="picker.searchPh" placeholder="جستجوی آدرس…" />
        <button id="pickerSearchBtn" class="btn ghost" data-i18n="picker.searchBtn">🔎 جستجو</button>
        <button id="pickerUse" class="btn success" data-i18n="picker.useBtn">استفاده از این نقطه</button>
      </div>
      <div class="help" data-i18n="picker.help">پین را بکشید یا روی نقشه بزنید. جستجو باعث زوم متنی نمی‌شود.</div>
    </div>
  </dialog>

  <!-- Preview -->
  <dialog id="previewModal">
    <div class="modal-head">
      <strong id="previewTitle" data-i18n="preview.title">پیش‌نمایش</strong>
      <div class="grow"></div>
      <button id="closePreview" class="icon-btn">✕</button>
    </div>
    <div class="modal-body">
      <div id="previewMap"></div>
      <div id="previewAddr" class="muted">—</div>
      <div class="row">
        <button id="pvApple" class="btn" data-i18n="maps.apple">🗺️ اپل</button>
        <button id="pvGoogle" class="btn" data-i18n="maps.google">🗺️ گوگل</button>
        <button id="pvWaze" class="btn" data-i18n="maps.waze">🚘 ویز</button>
        <button id="pvDir" class="btn" data-i18n="maps.appleDir">➡️ مسیـریابی اپل</button>
        <button id="pvShare" class="btn ghost" data-i18n="common.share">↗︎ اشتراک</button>
      </div>
    </div>
  </dialog>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    /* Manifest */
    (function(){
      const manifest = {
        name:"Save Loc — ذخیره مکان",
        short_name:"Save Loc",
        start_url:"./",
        display:"standalone",
        background_color:"#0b1220",
        theme_color:"#0b1220",
        icons:[
          {"src":"https://i.postimg.cc/vT811GJ3/App-Icon-2x.png","sizes":"192x192","type":"image/png","purpose":"any maskable"},
          {"src":"https://i.postimg.cc/vT811GJ3/App-Icon-2x.png","sizes":"512x512","type":"image/png","purpose":"any maskable"}
        ]
      };
      const blob = new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"});
      const url = URL.createObjectURL(blob);
      const link = document.createElement('link'); link.rel = 'manifest'; link.href = url; document.head.appendChild(link);
    })();

    /* SW */
    (function(){
      if(!('serviceWorker' in navigator)) return;
      const swCode = `
        const CACHE='saveloc-v6';
        const ASSETS=['./'];
        self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS)).then(self.skipWaiting()))});
        self.addEventListener('activate',e=>{e.waitUntil(self.clients.claim())});
        self.addEventListener('fetch',e=>{
          e.respondWith(
            caches.match(e.request).then(c=>c||fetch(e.request).then(res=>{
              const copy=res.clone(); caches.open(CACHE).then(cache=>cache.put(e.request,copy)).catch(()=>{});
              return res;
            }).catch(()=>caches.match('./')))
          );
        });
      `;
      const blob = new Blob([swCode], {type:'text/javascript'});
      navigator.serviceWorker.register(URL.createObjectURL(blob));
    })();

    /* Elements */
    const themeAuto = document.getElementById('themeAuto');
    const themeLight = document.getElementById('themeLight');
    const themeDark = document.getElementById('themeDark');
    const langFa = document.getElementById('langFa');
    const langEn = document.getElementById('langEn');

    const installBtn = document.getElementById('installBtn');
    const a2hsHint = document.getElementById('a2hsHint');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsModal = document.getElementById('settingsModal');
    const closeSettings = document.getElementById('closeSettings');
    const saveSettingsBtn = document.getElementById('saveSettings');
    const testCustom = document.getElementById('testCustom');

    const customTpl = document.getElementById('customTpl');
    const shareTitle = document.getElementById('shareTitle');

    const locateBtn = document.getElementById('locateBtn');
    const openPicker = document.getElementById('openPicker');
    const saveLiveBtn = document.getElementById('saveLiveBtn');
    const shareBtn = document.getElementById('shareBtn');
    const progBar = document.getElementById('progBar');
    const permStatus = document.getElementById('permStatus');

    const latBox = document.getElementById('latBox');
    const lngBox = document.getElementById('lngBox');
    const accBox = document.getElementById('accBox');
    const tsBox  = document.getElementById('tsBox');
    const addrRow = document.getElementById('addrRow');
    const addrChip = document.getElementById('addrChip');

    const copyLat = document.getElementById('copyLat');
    const copyLng = document.getElementById('copyLng');
    const copyBoth = document.getElementById('copyBoth');

    const openApple = document.getElementById('openApple');
    const openGoogle = document.getElementById('openGoogle');
    const openWaze = document.getElementById('openWaze');
    const openCustom = document.getElementById('openCustom');
    const dirApple = document.getElementById('dirApple');

    const listArea = document.getElementById('listArea');
    const searchBox = document.getElementById('searchBox');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const importFile = document.getElementById('importFile');
    const backupBtn = document.getElementById('backupBtn');
    const restoreBtn = document.getElementById('restoreBtn');
    const restoreFile = document.getElementById('restoreFile');
    const clearAllBtn = document.getElementById('clearAllBtn');

    const pickerModal = document.getElementById('pickerModal');
    const pickerMapEl = document.getElementById('pickerMap');
    const pickerSearch = document.getElementById('pickerSearch');
    const pickerSearchBtn = document.getElementById('pickerSearchBtn');
    const pickerUse = document.getElementById('pickerUse');
    const closePicker = document.getElementById('closePicker');

    const previewModal = document.getElementById('previewModal');
    const previewTitle = document.getElementById('previewTitle');
    const previewMapEl = document.getElementById('previewMap');
    const previewAddr = document.getElementById('previewAddr');
    const pvApple = document.getElementById('pvApple');
    const pvGoogle = document.getElementById('pvGoogle');
    const pvWaze = document.getElementById('pvWaze');
    const pvDir = document.getElementById('pvDir');
    const pvShare = document.getElementById('pvShare');
    const closePreview = document.getElementById('closePreview');

    const saveModal = document.getElementById('saveModal');
    const saveModalTitle = document.getElementById('saveModalTitle');
    const closeSave = document.getElementById('closeSave');
    const saveLat = document.getElementById('saveLat');
    const saveLng = document.getElementById('saveLng');
    const saveAcc = document.getElementById('saveAcc');
    const saveAddr = document.getElementById('saveAddr');
    const placeName = document.getElementById('placeName');
    const placeNotes = document.getElementById('placeNotes');
    const catChips = document.getElementById('catChips');
    const quickCatName = document.getElementById('quickCatName');
    const quickCatIcon = document.getElementById('quickCatIcon');
    const quickAddCat = document.getElementById('quickAddCat');
    const saveCancel = document.getElementById('saveCancel');
    const saveConfirm = document.getElementById('saveConfirm');

    /* i18n */
    const i18n = {
      fa: {
        locale:'fa-IR', dir:'rtl',
        subtitle:'ذخیره مکان • آفلاین • اشتراک',
        theme:{auto:'خودکار', light:'روشن', dark:'تاریک'},
        footer:'ساخته شده توسط <b>peym</b>',
        current:{
          title:'مکان فعلی', getPrecise:'📍 موقعیت دقیق', mapPicker:'🗺️ انتخاب روی نقشه', save:'⭐ ذخیره',
          lat:'عرض: —', lng:'طول: —', acc:'دقت: —', resolving:'📍 درحال دریافت آدرس…',
          copyLat:'📋 کپی عرض', copyLng:'📋 کپی طول', copyBoth:'📋 کپی عرض،طول',
          timestamp:(s)=>'زمان: '+s, accUnit:(m)=>'دقت: ±'+m+' متر', latVal:(v)=>'عرض: '+v, lngVal:(v)=>'طول: '+v
        },
        perm:{unknown:'دسترسی: <b>نامشخص</b>', granted:'دسترسی: <b style="color:var(--accent-2)">مجاز</b>', denied:'دسترسی: <b style="color:var(--danger)">رد</b>', prompt:'دسترسی: <b>پرسش</b>'},
        maps:{apple:'🗺️ اپل', google:'🗺️ گوگل', waze:'🚘 ویز', appleDir:'➡️ مسیـریابی اپل', otherApp:'🔗 برنامه دیگر'},
        saved:{
          title:'مکان‌های ذخیره‌شده',
          searchPh:'جستجو: نام، آدرس، یادداشت…',
          empty:'هنوز مکانی ذخیره نشده. از <b>موقعیت دقیق</b> یا <b>انتخاب روی نقشه</b> استفاده کنید.',
          coords:(lat,lng,acc,time)=>`${lat}، ${lng} • ±${acc} متر • ${time}`
        },
        preview:{title:'پیش‌نمایش'},
        picker:{title:'انتخاب روی نقشه', searchPh:'جستجوی آدرس…', searchBtn:'🔎 جستجو', useBtn:'استفاده از این نقطه', help:'پین را بکشید یا روی نقشه بزنید. جستجو باعث زوم متنی نمی‌شود.'},
        settings:{
          title:'تنظیمات',
          customTpl:'قالب لینک سفارشی (برنامه دیگر)',
          customHelp:'جای‌گذارها: {lat}، {lng}، {name} — مثال: waze://?ll={lat},{lng}&navigate=yes',
          categories:'دسته‌بندی‌ها',
          newCatPh:'نام دسته (مثلاً: پارکینگ)',
          newCatIconPh:'ایموجی (مثلاً: 🅿️)',
          catTip:'از ایموجی به‌عنوان آیکن استفاده کنید (🏠 💼 🅿️ ⭐ 👤 📌).',
          shareTitle:'عنوان اشتراک‌گذاری',
          testLink:'آزمون لینک',
          edit:'ویرایش', del:'حذف', updated:'دسته به‌روز شد', deleted:'حذف شد'
        },
        save:{
          title:'ذخیره مکان', nameLabel:'نام', namePh:'نقطه من', catLabel:'دسته‌بندی',
          newCatNamePh:'نام دسته جدید', newCatIconPh:'ایموجی (📌)',
          notesLabel:'یادداشت', notesPh:'یادداشت اختیاری (کد در، طبقه، تماس…)'
        },
        common:{share:'↗︎ اشتراک', add:'افزودن', save:'ذخیره', cancel:'انصراف'},
        backup:{export:'⬇️ خروجی', import:'⬆️ ورود', backup:'🧰 پشتیبان', restore:'🧳 بازیابی', clearAll:'🗑️ حذف همه',
          importOk:'ورود انجام شد', importFail:'ورود ناموفق', restoreOk:'بازیابی شد', restoreFail:'بازیابی ناموفق', cleared:'پاک شد'
        },
        toasts:{
          copied:'کپی شد', copyFail:'کپی ناموفق', shareCopied:'متن اشتراک در کلیپ‌بورد است', shareFail:'اشتراک ناموفق',
          saved:'ذخیره شد ⭐', updated:'به‌روز شد ✅', deleted:'حذف شد', notFound:'پیدا نشد', found:'یافت شد',
          searchErr:'خطای جستجو', needCustom:'ابتدا قالب لینک سفارشی را در تنظیمات وارد کنید',
          settingsSaved:'تنظیمات ذخیره شد', enterCatName:'نام دسته را وارد کنید', catAdded:'دسته اضافه شد',
          geoUnsupported:'این دستگاه از مکان‌یابی پشتیبانی نمی‌کند', geoError:'خطای مکان'
        },
        dialogs:{
          deletePlace:'این مکان حذف شود؟', clearAll:'همهٔ مکان‌ها حذف شوند؟', namePromptDefault:'بدون نام'
        },
        catsDefault:[
          {id:'home',name:'خانه',icon:'🏠'},
          {id:'work',name:'کار',icon:'💼'},
          {id:'parking',name:'پارکینگ',icon:'🅿️'},
          {id:'fav',name:'علاقه‌مندی',icon:'⭐'},
          {id:'customer',name:'مشتری',icon:'👤'}
        ]
      },
      en: {
        locale:'en-US', dir:'ltr',
        subtitle:'GPS bookmarks • offline • share',
        theme:{auto:'Auto', light:'Light', dark:'Dark'},
        footer:'App created by <b>peymaan abedinpour   ver0.2</b>',
        current:{
          title:'Current Location', getPrecise:'📍 Get Precise', mapPicker:'🗺️ Map Picker', save:'⭐ Save',
          lat:'lat: —', lng:'lng: —', acc:'accuracy: —', resolving:'📍 Resolving address…',
          copyLat:'📋 Copy lat', copyLng:'📋 Copy lng', copyBoth:'📋 Copy lat,lng',
          timestamp:(s)=>'Timestamp: '+s, accUnit:(m)=>'accuracy: ±'+m+' m', latVal:(v)=>'lat: '+v, lngVal:(v)=>'lng: '+v
        },
        perm:{unknown:'Permission: <b>unknown</b>', granted:'Permission: <b style="color:var(--accent-2)">granted</b>', denied:'Permission: <b style="color:var(--danger)">denied</b>', prompt:'Permission: <b>prompt</b>'},
        maps:{apple:'🗺️ Apple', google:'🗺️ Google', waze:'🚘 Waze', appleDir:'➡️ Apple Directions', otherApp:'🔗 Other App'},
        saved:{
          title:'Saved Places',
          searchPh:'Search name, address, notes…',
          empty:'No places yet. Use <b>Get Precise</b> or <b>Map Picker</b>.',
          coords:(lat,lng,acc,time)=>`${lat}, ${lng} • ±${acc} m • ${time}`
        },
        preview:{title:'Preview'},
        picker:{title:'Pick on Map', searchPh:'Search address…', searchBtn:'🔎 Search', useBtn:'Use This Point', help:'Drag the pin or tap the map. Search won’t trigger text zoom.'},
        settings:{
          title:'Settings',
          customTpl:'Custom URL template (Other App)',
          customHelp:'Placeholders: {lat}, {lng}, {name} — Example: waze://?ll={lat},{lng}&navigate=yes',
          categories:'Categories',
          newCatPh:'Category name (e.g., Parking)',
          newCatIconPh:'Emoji (e.g., 🅿️)',
          catTip:'Use emoji as icons (🏠 💼 🅿️ ⭐ 👤 📌).',
          shareTitle:'Share title',
          testLink:'Test Custom',
          edit:'Edit', del:'Delete', updated:'Category updated', deleted:'Deleted'
        },
        save:{
          title:'Save Location', nameLabel:'Name', namePh:'My Spot', catLabel:'Category',
          newCatNamePh:'New category name', newCatIconPh:'Emoji (📌)',
          notesLabel:'Notes', notesPh:'Optional notes (gate code, floor, contact…)'
        },
        common:{share:'↗︎ Share', add:'Add', save:'Save', cancel:'Cancel'},
        backup:{export:'⬇️ Export', import:'⬆️ Import', backup:'🧰 Backup', restore:'🧳 Restore', clearAll:'🗑️ Clear All',
          importOk:'Imported', importFail:'Import failed', restoreOk:'Backup restored', restoreFail:'Restore failed', cleared:'Cleared'
        },
        toasts:{
          copied:'Copied', copyFail:'Copy failed', shareCopied:'Share copied', shareFail:'Share failed',
          saved:'Saved ⭐', updated:'Updated ✅', deleted:'Deleted', notFound:'Not found', found:'Found',
          searchErr:'Search error', needCustom:'Set a custom URL in Settings first',
          settingsSaved:'Settings saved', enterCatName:'Enter a category name', catAdded:'Category added',
          geoUnsupported:'Geolocation not supported', geoError:'Location error'
        },
        dialogs:{
          deletePlace:'Delete this place?', clearAll:'Remove ALL saved places?', namePromptDefault:'Unnamed'
        },
        catsDefault:[
          {id:'home',name:'Home',icon:'🏠'},
          {id:'work',name:'Work',icon:'💼'},
          {id:'parking',name:'Parking',icon:'🅿️'},
          {id:'fav',name:'Favorite',icon:'⭐'},
          {id:'customer',name:'Customer',icon:'👤'}
        ]
      }
    };

    const PREF_THEME='saveloc.theme';
    const PREF_LANG='saveloc.lang';
    let LANG = localStorage.getItem(PREF_LANG) || 'fa';

    function applyTheme(val){
      document.documentElement.removeAttribute('data-theme');
      if(val==='light'||val==='dark') document.documentElement.setAttribute('data-theme',val);
      [themeAuto,themeLight,themeDark].forEach(b=>b.setAttribute('aria-pressed','false'));
      (val==='light'?themeLight:val==='dark'?themeDark:themeAuto).setAttribute('aria-pressed','true');
      localStorage.setItem(PREF_THEME,val);
    }
    [themeAuto,themeLight,themeDark].forEach(btn=>btn.addEventListener('click',()=>applyTheme(btn===themeLight?'light':btn===themeDark?'dark':'auto')));
    applyTheme(localStorage.getItem(PREF_THEME)||'auto');

    function setLang(lang){
      LANG = (lang==='en'?'en':'fa');
      localStorage.setItem(PREF_LANG, LANG);
      document.documentElement.lang = (LANG==='en')?'en':'fa';
      document.documentElement.dir = i18n[LANG].dir;
      [langFa,langEn].forEach(b=>b.setAttribute('aria-pressed','false'));
      (LANG==='en'?langEn:langFa).setAttribute('aria-pressed','true');

      // Static texts
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const key = el.getAttribute('data-i18n');
        const val = deepGet(i18n[LANG], key);
        if(typeof val==='string') el.innerHTML = val;
      });
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{
        const key = el.getAttribute('data-i18n-placeholder');
        const val = deepGet(i18n[LANG], key);
        if(typeof val==='string') el.setAttribute('placeholder', val);
      });

      // Footer
      document.querySelector('footer').innerHTML = i18n[LANG].footer;

      // Live labels if we already have current
      if(current){
        latBox.textContent = i18n[LANG].current.latVal(current.lat.toFixed(6));
        lngBox.textContent = i18n[LANG].current.lngVal(current.lng.toFixed(6));
        accBox.textContent = i18n[LANG].current.accUnit(current.acc);
        tsBox.textContent  = i18n[LANG].current.timestamp(new Date(current.ts).toLocaleString(i18n[LANG].locale));
      }else{
        latBox.textContent = i18n[LANG].current.lat;
        lngBox.textContent = i18n[LANG].current.lng;
        accBox.textContent = i18n[LANG].current.acc;
      }

      // Rerender places for translated action buttons / subtitles
      renderList();
    }
    function deepGet(obj, path){
      return path.split('.').reduce((o,k)=>o && o[k], obj);
    }
    langFa.addEventListener('click', ()=>setLang('fa'));
    langEn.addEventListener('click', ()=>setLang('en'));
    setLang(LANG);

    /* Install/A2HS */
    const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    let deferredPrompt=null;
    window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; installBtn.hidden=false; });
    installBtn.addEventListener('click', async ()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; installBtn.hidden=true; });
    if(isIOS && !isStandalone){ a2hsHint.hidden=false; a2hsHint.addEventListener('click', ()=> toast('On iPhone: Share ▸ Add to Home Screen')); }

    /* Small helpers */
    function toast(msg){ const el=document.getElementById('toast'); el.textContent=msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),1800); }
    function formatTs(t){ return new Date(t).toLocaleString(i18n[LANG].locale); }
    function setProgress(p){ progBar.style.width = Math.max(0, Math.min(100, p)) + '%'; }
    function downloadBlob(data, type, name){ const blob=new Blob([data],{type}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url); }

    /* Permissions */
    async function checkPerm(){
      if(!navigator.permissions || !navigator.geolocation){ permStatus.innerHTML=i18n[LANG].perm.unknown; return; }
      try{
        const st = await navigator.permissions.query({name:'geolocation'});
        const map = { 'granted':i18n[LANG].perm.granted, 'denied':i18n[LANG].perm.denied, 'prompt':i18n[LANG].perm.prompt };
        permStatus.innerHTML = map[st.state] || i18n[LANG].perm.unknown;
        st.onchange = ()=>{ permStatus.innerHTML = map[st.state] || i18n[LANG].perm.unknown; };
      }catch{ permStatus.innerHTML=i18n[LANG].perm.unknown; }
    }
    checkPerm();

    /* Storage */
    const KEY='saveloc.places.v1';
    const PREF='saveloc.prefs.v1';
    const CATS='saveloc.categories.v1';
    function readPlaces(){ try{ return JSON.parse(localStorage.getItem(KEY)) || []; }catch{ return []; } }
    function writePlaces(arr){ localStorage.setItem(KEY, JSON.stringify(arr)); }
    function readPrefs(){ const def={customTpl:'',shareTitle:'Save Loc'}; try{ return {...def, ...(JSON.parse(localStorage.getItem(PREF))||{})}; }catch{ return def; } }
    function writePrefs(p){ localStorage.setItem(PREF, JSON.stringify(p)); }
    function readCats(){
      try{
        const saved = JSON.parse(localStorage.getItem(CATS));
        if(Array.isArray(saved) && saved.length) return saved;
        const def = i18n[LANG].catsDefault;
        localStorage.setItem(CATS, JSON.stringify(def));
        return def;
      }catch{ return i18n[LANG].catsDefault; }
    }
    function writeCats(arr){ localStorage.setItem(CATS, JSON.stringify(arr)); }

    /* Reverse Geocode (cached) */
    function reverseGeocode(lat,lng){
      const key='addr:'+lat.toFixed(5)+','+lng.toFixed(5);
      const cached=localStorage.getItem(key); if(cached) return Promise.resolve(cached);
      return fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}&zoom=18&addressdetails=0`,{headers:{'Accept':'application/json'}})
        .then(r=>r.ok?r.json():Promise.reject()).then(j=>j.display_name||'').then(addr=>{ if(addr) localStorage.setItem(key,addr); return addr; })
        .catch(()=> '');
    }

    /* Map links */
    const appleLink = (lat,lng,name='') => `https://maps.apple.com/?ll=${lat},${lng}&q=${encodeURIComponent(name||`${lat.toFixed(6)},${lng.toFixed(6)}`)}`;
    const googleLink = (lat,lng) => `https://maps.google.com/?q=${lat},${lng}`;
    const wazeLink = (lat,lng) => `https://waze.com/ul?ll=${lat},${lng}&navigate=yes`;
    const appleDirections = (lat,lng,addr='') => `https://maps.apple.com/?daddr=${lat},${lng}&q=${encodeURIComponent(addr||`${lat.toFixed(6)},${lng.toFixed(6)}`)}&dirflg=d&saddr=Current%20Location`;
    function customLink(lat,lng,name){ const {customTpl}=readPrefs(); if(!customTpl) return ''; return customTpl.replaceAll('{lat}',lat).replaceAll('{lng}',lng).replaceAll('{name}',encodeURIComponent(name||'')); }

    /* Live Location */
    let current = null;
    function enableLive(on){
      [saveLiveBtn,shareBtn,openApple,openGoogle,openWaze,dirApple,openCustom,copyLat,copyLng,copyBoth].forEach(b=>b.disabled=!on);
    }
    locateBtn.addEventListener('click', ()=>{
      if(!navigator.geolocation){ toast(i18n[LANG].toasts.geoUnsupported); return; }
      setProgress(10); addrRow.style.display='none';
      navigator.geolocation.getCurrentPosition(onPos,onErr,{enableHighAccuracy:true,timeout:15000,maximumAge:0});
      let t=10, iv=setInterval(()=>{ t=Math.min(95,t+4); setProgress(t); },300);
      function onPos(pos){
        clearInterval(iv); setProgress(100);
        const {latitude,longitude,accuracy}=pos.coords;
        current={lat:latitude,lng:longitude,acc:Math.round(accuracy),ts:Date.now()};
        latBox.textContent=i18n[LANG].current.latVal(latitude.toFixed(6));
        lngBox.textContent=i18n[LANG].current.lngVal(longitude.toFixed(6));
        accBox.textContent=i18n[LANG].current.accUnit(Math.round(accuracy));
        tsBox.textContent=i18n[LANG].current.timestamp(new Date(current.ts).toLocaleString(i18n[LANG].locale));
        enableLive(true);
        reverseGeocode(latitude,longitude).then(addr=>{ if(addr){ current.address=addr; addrChip.textContent='📍 '+addr; addrRow.style.display='flex'; } });
        setTimeout(()=>setProgress(0),400);
      }
      function onErr(err){ clearInterval(iv); setProgress(0); toast(err.message||i18n[LANG].toasts.geoError); }
    });

    copyLat.onclick = async ()=>{ if(!current) return; try{ await navigator.clipboard.writeText(String(current.lat)); toast(i18n[LANG].toasts.copied); }catch{ toast(i18n[LANG].toasts.copyFail); } };
    copyLng.onclick = async ()=>{ if(!current) return; try{ await navigator.clipboard.writeText(String(current.lng)); toast(i18n[LANG].toasts.copied); }catch{ toast(i18n[LANG].toasts.copyFail); } };
    copyBoth.onclick = async ()=>{ if(!current) return; try{ await navigator.clipboard.writeText(`${current.lat},${current.lng}`); toast(i18n[LANG].toasts.copied); }catch{ toast(i18n[LANG].toasts.copyFail); } };

    shareBtn.addEventListener('click', async ()=>{
      if(!current) return;
      const prefs = readPrefs();
      const url = googleLink(current.lat,current.lng);
      const text = `${current.address? current.address : (LANG==='fa'?'مکان ذخیره‌شده':'Pinned location')} — ${current.lat.toFixed(6)},${current.lng.toFixed(6)} (±${current.acc} ${LANG==='fa'?'متر':'m'})`;
      if(navigator.share){ try{ await navigator.share({ title:prefs.shareTitle||'Save Loc', text, url }); }catch{} }
      else{ try{ await navigator.clipboard.writeText(`${text}\n${url}`); toast(i18n[LANG].toasts.shareCopied); }catch{ toast(i18n[LANG].toasts.shareFail); } }
    });

    openApple.onclick = ()=>{ if(!current) return; window.open(appleLink(current.lat,current.lng,current.address||'Location'),'_blank','noopener'); };
    openGoogle.onclick = ()=>{ if(!current) return; window.open(googleLink(current.lat,current.lng),'_blank','noopener'); };
    openWaze.onclick = ()=>{ if(!current) return; window.open(wazeLink(current.lat,current.lng),'_blank','noopener'); };
    dirApple.onclick = ()=>{ if(!current) return; window.open(appleDirections(current.lat,current.lng,current.address||'Destination'),'_blank','noopener'); };
    openCustom.onclick = ()=>{ if(!current) return; const url=customLink(current.lat,current.lng,current.address||''); if(url) window.location.href=url; else toast(i18n[LANG].toasts.needCustom); };

    /* Save/Edit */
    let pendingSave = null, editId = null;

    function openSaveModal(record, mode='save'){
      pendingSave = record; editId = (mode==='edit') ? record.id : null;
      saveModalTitle.innerHTML = (mode==='edit') ? (LANG==='fa'?'ویرایش مکان':'Edit Location') : i18n[LANG].save.title;
      placeName.value = record.name || (record.address? record.address.split(',')[0] : (LANG==='fa'?'نقطه من':'My Spot'));
      placeNotes.value = record.notes || '';
      saveLat.textContent = i18n[LANG].current.latVal(record.lat.toFixed(6));
      saveLng.textContent = i18n[LANG].current.lngVal(record.lng.toFixed(6));
      saveAcc.textContent = i18n[LANG].current.accUnit(record.acc ?? '—');
      saveAddr.textContent = '📍 ' + (record.address || '—');
      renderCatChips(record.category);
      saveModal.showModal();
    }
    saveLiveBtn.onclick = ()=>{ if(!current) return; openSaveModal({ ...current, name:(LANG==='fa'?'مکان فعلی':'Current spot') }, 'save'); };
    closeSave.onclick = ()=> saveModal.close();
    saveCancel.onclick = ()=> saveModal.close();
    saveConfirm.onclick = ()=>{
      if(!pendingSave) return;
      const cat = selectedCatFromChips();
      const place = {
        id: editId || (crypto.randomUUID?.() || (Date.now()+'-'+Math.random().toString(16).slice(2))),
        name: (placeName.value || (LANG==='fa'?i18n[LANG].dialogs.namePromptDefault:'Unnamed')).trim(),
        lat: +pendingSave.lat, lng: +pendingSave.lng, acc: +pendingSave.acc || 0,
        ts: pendingSave.ts || Date.now(),
        address: pendingSave.address || '',
        category: cat, notes: (placeNotes.value||'').trim()
      };
      if(editId){
        const arr=readPlaces(); const i=arr.findIndex(x=>x.id===editId); if(i>-1) arr[i]=place; writePlaces(arr);
        toast(i18n[LANG].toasts.updated);
      }else{
        const arr=readPlaces(); arr.unshift(place); writePlaces(arr);
        toast(i18n[LANG].toasts.saved);
      }
      saveModal.close(); renderList();
    };

    /* Picker */
    let picker = null, pickerMarker = null;
    openPicker.onclick = ()=>{
      pickerModal.showModal();
      setTimeout(initPicker, 20);
    };
    closePicker.onclick = ()=> pickerModal.close();
    function initPicker(){
      if(!picker){
        picker = L.map(pickerMapEl,{zoomControl:true, attributionControl:false}).setView([35.6892,51.3890],13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(picker);
        pickerMarker = L.marker(picker.getCenter(),{draggable:true}).addTo(picker);
        picker.on('click', e=>{ pickerMarker.setLatLng(e.latlng); });
      } else { picker.invalidateSize(); }
      if(current){ picker.setView([current.lat,current.lng],16); pickerMarker.setLatLng([current.lat,current.lng]); }
    }
    pickerSearchBtn.onclick = ()=>{
      const q = pickerSearch.value.trim(); if(!q) return;
      fetch(`https://nominatim.openstreetmap.org/search?format=jsonv2&q=${encodeURIComponent(q)}&limit=1`)
        .then(r=>r.ok?r.json():[]).then(arr=>{
          if(arr && arr[0]){ const {lat,lon}=arr[0]; const latf=+lat, lonf=+lon; picker.setView([latf,lonf],16); pickerMarker.setLatLng([latf,lonf]); toast(i18n[LANG].toasts.found); }
          else toast(i18n[LANG].toasts.notFound);
        }).catch(()=>toast(i18n[LANG].toasts.searchErr));
    };
    pickerUse.onclick = ()=>{
      const {lat,lng} = pickerMarker.getLatLng();
      const rec = {lat: +lat, lng: +lng, acc: 0, ts: Date.now()};
      reverseGeocode(lat,lng).then(addr=>{ if(addr) rec.address=addr; openSaveModal(rec,'save'); });
      pickerModal.close();
    };

    /* Settings: categories */
    const catList = document.getElementById('catList');
    const newCatName = document.getElementById('newCatName');
    const newCatIcon = document.getElementById('newCatIcon');
    const addCatBtn = document.getElementById('addCatBtn');

    function renderCatList(){
      const cats = readCats(); catList.innerHTML='';
      cats.forEach((c,idx)=>{
        const row = document.createElement('div'); row.className='row'; row.style.justifyContent='space-between';
        const left = document.createElement('div'); left.className='chip'; left.textContent = `${c.icon} ${c.name}`;
        const right = document.createElement('div'); right.className='row';
        const edit = document.createElement('button'); edit.className='btn ghost'; edit.textContent=i18n[LANG].settings.edit;
        edit.onclick = ()=>{
          const nn = prompt(i18n[LANG].settings.edit, c.name); if(nn===null) return;
          const ni = prompt('Emoji', c.icon); if(ni===null) return;
          const arr=readCats(); arr[idx]={...c,name:(nn||c.name).trim(),icon:(ni||c.icon).trim()}; writeCats(arr); renderCatList(); toast(i18n[LANG].settings.updated);
        };
        const del = document.createElement('button'); del.className='btn danger'; del.textContent=i18n[LANG].settings.del;
        del.onclick = ()=>{
          if(!confirm(i18n[LANG].dialogs.deletePlace)) return;
          const arr=readCats().filter(x=>x.id!==c.id); writeCats(arr); renderCatList(); toast(i18n[LANG].settings.deleted);
        };
        right.append(edit,del); row.append(left,right); catList.appendChild(row);
      });
    }
    function renderCatChips(selected){
      const cats=readCats(); catChips.innerHTML='';
      cats.forEach(c=>{
        const b=document.createElement('button'); b.className='chip'; b.setAttribute('aria-pressed', selected && selected.id===c.id ? 'true':'false');
        b.textContent = `${c.icon} ${c.name}`;
        b.onclick = ()=>{
          [...catChips.children].forEach(n=>n.setAttribute('aria-pressed','false'));
          b.setAttribute('aria-pressed','true'); b.dataset.catId = c.id;
        };
        b.dataset.catId = c.id;
        catChips.appendChild(b);
      });
      if(selected){
        const btn=[...catChips.children].find(x=>x.dataset.catId===selected.id);
        if(btn) btn.setAttribute('aria-pressed','true');
      } else if(catChips.firstChild){
        catChips.firstChild.setAttribute('aria-pressed','true');
      }
    }
    function selectedCatFromChips(){
      const cats=readCats();
      const btn=[...catChips.children].find(x=>x.getAttribute('aria-pressed')==='true');
      const id=btn?btn.dataset.catId:cats[0]?.id;
      return cats.find(c=>c.id===id) || cats[0];
    }
    quickAddCat.onclick = ()=>{
      const name=(quickCatName.value||'').trim(); const icon=(quickCatIcon.value||'📌').trim();
      if(!name){ toast(i18n[LANG].toasts.enterCatName); return; }
      const arr=readCats(); const cat={id:(Date.now()+'-'+Math.random().toString(16).slice(2)), name, icon}; arr.push(cat); writeCats(arr);
      quickCatName.value=''; quickCatIcon.value='';
      renderCatChips(cat); toast(i18n[LANG].toasts.catAdded);
    };

    settingsBtn.onclick = ()=>{
      const p=readPrefs();
      customTpl.value=p.customTpl||'';
      shareTitle.value=p.shareTitle||'Save Loc';
      // Translate modal labels/placeholders each open (in case language changed)
      settingsModal.querySelectorAll('[data-i18n]').forEach(el=>{ const k=el.getAttribute('data-i18n'); const v=deepGet(i18n[LANG],k); if(typeof v==='string') el.innerHTML=v; });
      settingsModal.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{ const k=el.getAttribute('data-i18n-placeholder'); const v=deepGet(i18n[LANG],k); if(typeof v==='string') el.setAttribute('placeholder',v); });
      renderCatList();
      settingsModal.showModal();
    };
    closeSettings.onclick = ()=> settingsModal.close();
    saveSettingsBtn.onclick = ()=>{ writePrefs({customTpl:customTpl.value.trim(), shareTitle:shareTitle.value.trim()}); toast(i18n[LANG].toasts.settingsSaved); settingsModal.close(); };
    testCustom.onclick = ()=>{
      const tpl=customTpl.value.trim(); if(!tpl){ toast(i18n[LANG].toasts.needCustom); return; }
      const url=tpl.replaceAll('{lat}','35.6892').replaceAll('{lng}','51.3890').replaceAll('{name}',encodeURIComponent('Test'));
      window.location.href=url;
    };

    /* List rendering */
    function renderList(){
      const q=(searchBox.value||'').toLowerCase().trim();
      const items=readPlaces().filter(p=>{
        const hay=(p.name||'')+' '+(p.address||'')+' '+(p.notes||'')+' '+(p.category?.name||'');
        return !q || hay.toLowerCase().includes(q);
      });
      listArea.innerHTML='';
      if(!items.length){
        const d=document.createElement('div'); d.className='empty';
        d.innerHTML = i18n[LANG].saved.empty;
        listArea.appendChild(d); return;
      }

      items.forEach(p=>{
        const card=document.createElement('div'); card.className='place';
        const head=document.createElement('div'); head.className='place-h';
        const title=document.createElement('div'); title.className='place-title'; title.textContent=`${p.category?.icon||'📌'} ${p.name}`;
        const sub=document.createElement('div'); sub.className='place-sub mono';
        const latStr = p.lat.toFixed(6), lngStr = p.lng.toFixed(6);
        sub.textContent = i18n[LANG].saved.coords(latStr, lngStr, p.acc, formatTs(p.ts));
        head.append(title);
        const meta=document.createElement('div'); meta.appendChild(sub);
        if(p.address){ const a=document.createElement('div'); a.className='place-sub'; a.textContent='📍 '+p.address; meta.appendChild(a); }
        if(p.notes){ const n=document.createElement('div'); n.className='place-sub'; n.textContent=(LANG==='fa'?'📝 ':'📝 ')+p.notes; meta.appendChild(n); }

        const headerRow=document.createElement('div'); headerRow.style.display='flex'; headerRow.style.justifyContent='space-between'; headerRow.style.gap='10px';
        headerRow.append(head, meta);

        const actions=document.createElement('div'); actions.className='place-actions';
        const mk=(label,cls,fn)=>{ const b=document.createElement('button'); b.className='btn '+cls; b.textContent=label; b.onclick=fn; return b; };

        const previewBtn = mk(i18n[LANG].preview.title,'',()=>openPreview(p));
        const appleBtn   = mk(i18n[LANG].maps.apple,'',()=>window.open(appleLink(p.lat,p.lng,p.name),'_blank','noopener'));
        const googleBtn  = mk(i18n[LANG].maps.google,'',()=>window.open(googleLink(p.lat,p.lng),'_blank','noopener'));
        const wazeBtn    = mk(i18n[LANG].maps.waze,'',()=>window.open(wazeLink(p.lat,p.lng),'_blank','noopener'));
        const dirBtn     = mk(i18n[LANG].maps.appleDir,'',()=>window.open(appleDirections(p.lat,p.lng,p.address||p.name),'_blank','noopener'));
        const shareBtn2  = mk(i18n[LANG].common.share,'ghost',()=>sharePlace(p));
        const copyPair   = mk((LANG==='fa'?'کپی عرض،طول':'Copy lat,lng'),'ghost',async()=>{ try{ await navigator.clipboard.writeText(`${p.lat},${p.lng}`); toast(i18n[LANG].toasts.copied); }catch{ toast(i18n[LANG].toasts.copyFail); } });
        const editBtn    = mk((LANG==='fa'?'ویرایش':'Edit'),'ghost',()=>{ openSaveModal(p,'edit'); });
        const delBtn     = mk((LANG==='fa'?'حذف':'Delete'),'danger',()=>{ if(confirm(i18n[LANG].dialogs.deletePlace)){ remove(p.id); renderList(); toast(i18n[LANG].toasts.deleted); } });

        actions.append(previewBtn, appleBtn, googleBtn, wazeBtn, dirBtn, shareBtn2, copyPair, editBtn, delBtn);

        card.append(headerRow, actions);
        card.addEventListener('click', (e)=>{ if(e.target.closest('.btn')) return; card.classList.toggle('open'); });

        listArea.appendChild(card);
      });
    }

    async function sharePlace(p){
      const prefs=readPrefs(); const url=googleLink(p.lat,p.lng);
      const text=`${p.name} — ${p.lat.toFixed(6)},${p.lng.toFixed(6)} (±${p.acc} ${LANG==='fa'?'متر':'m'})${p.address? '\n'+p.address:''}${p.notes? '\n📝 '+p.notes:''}`;
      if(navigator.share){ try{ await navigator.share({title:prefs.shareTitle||'Save Loc', text, url}); }catch{} }
      else{ try{ await navigator.clipboard.writeText(`${text}\n${url}`); toast(i18n[LANG].toasts.shareCopied); }catch{ toast(i18n[LANG].toasts.shareFail); } }
    }
    function update(id,patch){ const arr=readPlaces(); const i=arr.findIndex(x=>x.id===id); if(i>-1){ arr[i]={...arr[i],...patch}; writePlaces(arr); } }
    function remove(id){ writePlaces(readPlaces().filter(x=>x.id!==id)); }
    searchBox.addEventListener('input', renderList);

    /* Preview (Leaflet) */
    let preview=null, previewMarker=null;
    function openPreview(p){
      previewModal.showModal();
      setTimeout(()=>{
        if(!preview){
          preview=L.map(previewMapEl,{zoomControl:true, attributionControl:false});
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(preview);
        }
        preview.setView([p.lat,p.lng],16);
        if(previewMarker) preview.removeLayer(previewMarker);
        previewMarker=L.marker([p.lat,p.lng]).addTo(preview);
        preview.invalidateSize();
      },20);
      previewTitle.textContent = i18n[LANG].preview.title + ' — ' + (p.category?.icon||'📌')+' '+p.name;
      previewAddr.textContent = p.address || '—';
      pvApple.onclick = ()=>window.open(appleLink(p.lat,p.lng,p.name),'_blank','noopener');
      pvGoogle.onclick = ()=>window.open(googleLink(p.lat,p.lng),'_blank','noopener');
      pvWaze.onclick = ()=>window.open(wazeLink(p.lat,p.lng),'_blank','noopener');
      pvDir.onclick = ()=>window.open(appleDirections(p.lat,p.lng,p.address||p.name),'_blank','noopener');
      pvShare.onclick = ()=>sharePlace(p);
      if(!p.address){ reverseGeocode(p.lat,p.lng).then(addr=>{ if(addr){ p.address=addr; update(p.id,{address:addr}); previewAddr.textContent=addr; renderList(); } }); }
    }
    closePreview.onclick = ()=> previewModal.close();

    /* Export/Import/Backup/Restore */
    exportBtn.onclick = ()=> downloadBlob(JSON.stringify(readPlaces(),null,2),'application/json','saveloc-places.json');
    importBtn.onclick = ()=> importFile.click();
    importFile.onchange = ()=>{
      const f=importFile.files[0]; if(!f) return;
      const fr=new FileReader(); fr.onload=()=>{
        try{ const arr=JSON.parse(fr.result); if(!Array.isArray(arr)) throw 0;
          const cur=readPlaces(); const map=new Map(cur.map(x=>[x.id,x])); for(const p of arr){ if(p&&p.id){ map.set(p.id,{...map.get(p.id),...p}); } }
          writePlaces([...map.values()].sort((a,b)=>b.ts-a.ts)); renderList(); toast(i18n[LANG].backup.importOk);
        }catch{ toast(i18n[LANG].backup.importFail); }
        importFile.value='';
      }; fr.readAsText(f);
    };

    backupBtn.onclick = ()=>{
      const backup={places:readPlaces(),categories:readCats(),prefs:readPrefs(),version:1,saved_at:new Date().toISOString()};
      downloadBlob(JSON.stringify(backup,null,2),'application/json','saveloc-backup.json');
    };
    restoreBtn.onclick = ()=> restoreFile.click();
    restoreFile.onchange = ()=>{
      const f=restoreFile.files[0]; if(!f) return;
      const fr=new FileReader(); fr.onload=()=>{
        try{ const obj=JSON.parse(fr.result);
          if(!obj || !Array.isArray(obj.places) || !Array.isArray(obj.categories)) throw 0;
          writePlaces(obj.places||[]); writeCats(obj.categories||[]); if(obj.prefs) writePrefs(obj.prefs);
          renderList(); toast(i18n[LANG].backup.restoreOk);
        }catch{ toast(i18n[LANG].backup.restoreFail); }
        restoreFile.value='';
      }; fr.readAsText(f);
    };

    clearAllBtn.onclick = ()=>{ if(confirm(i18n[LANG].dialogs.clearAll)){ localStorage.removeItem(KEY); renderList(); toast(i18n[LANG].backup.cleared); } };

    /* Settings open */
    settingsBtn.addEventListener('click', ()=>{}); // handled above in onclick

    /* Install language texts initially (already setLang), render */
    enableLive(false);
    renderList();

  </script>
</body>
</html>
