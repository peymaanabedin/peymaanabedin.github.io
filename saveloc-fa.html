<!DOCTYPE html>
<html lang="fa" dir="rtl" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" media="(prefers-color-scheme: dark)">
  <meta name="theme-color" content="#f7f7fb" media="(prefers-color-scheme: light)">
  <title>Save Loc â€” Ø°Ø®ÛŒØ±Ù‡ Ù…Ú©Ø§Ù†</title>

  <!-- Ø¢ÛŒÚ©Ù† Ø¨Ø±Ù†Ø§Ù…Ù‡ -->
  <link rel="apple-touch-icon" href="https://i.postimg.cc/vT811GJ3/App-Icon-2x.png" />
  <link rel="icon" href="https://i.postimg.cc/vT811GJ3/App-Icon-2x.png" />

  <!-- Leaflet (Ù†Ù‚Ø´Ù‡) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />

  <style>
    :root{
      --bg:#0b1220;--bg-grad:#0e1628;--panel:#0f1726;--panel-2:#121a2b;--muted:#8aa0bf;--text:#eef3ff;
      --accent:#0a84ff;--accent-2:#34d399;--danger:#ff453a;--border:#1f273a;--shadow:0 12px 28px rgba(0,0,0,.28);
      --radius:18px;--gap:14px;
    }
    @media (prefers-color-scheme:light){
      :root{
        --bg:#f7f7fb;--bg-grad:#fff;--panel:#ffffff;--panel-2:#fafafa;--muted:#6e7a8a;--text:#0d0f14;
        --accent:#007aff;--accent-2:#34c759;--danger:#ff3b30;--border:#e7e9ee;--shadow:0 10px 24px rgba(0,0,0,.06);
      }
    }
    [data-theme="light"]{
      --bg:#f7f7fb;--bg-grad:#fff;--panel:#ffffff;--panel-2:#fafafa;--muted:#6e7a8a;--text:#0d0f14;
      --accent:#007aff;--accent-2:#34c759;--danger:#ff3b30;--border:#e7e9ee;--shadow:0 10px 24px rgba(0,0,0,.06);
    }
    [data-theme="dark"]{
      --bg:#0b1220;--bg-grad:#0e1628;--panel:#0f1726;--panel-2:#121a2b;--muted:#8aa0bf;--text:#eef3ff;
      --accent:#0a84ff;--accent-2:#34d399;--danger:#ff453a;--border:#1f273a;--shadow:0 12px 28px rgba(0,0,0,.28);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:linear-gradient(180deg,var(--bg) 0%,var(--bg) 60%,var(--bg-grad) 100%);
      color:var(--text);font:16px/1.5 -apple-system,system-ui,Segoe UI,Roboto,IRANSans,Inter,Helvetica,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
      -webkit-text-size-adjust:100%;
    }

    /* Ù†ÙˆØ§Ø± Ø¨Ø§Ù„Ø§ (Ù…ÙˆØ¨Ø§ÛŒÙ„) */
    .appbar{
      position:sticky;top:0;z-index:30;background:color-mix(in oklab,var(--bg) 88%,transparent);
      backdrop-filter:blur(10px);border-bottom:1px solid var(--border);
    }
    .appbar .row{display:flex;align-items:center;gap:12px;padding:10px 12px;max-width:960px;margin-inline:auto}
    .brand{display:flex;align-items:center;gap:10px;min-width:0}
    .brand img{width:28px;height:28px;border-radius:7px;box-shadow:0 4px 18px rgba(0,0,0,.18)}
    .brand .title{font-weight:900;letter-spacing:.2px;white-space:nowrap}
    .brand .sub{font-size:12px;color:var(--muted);white-space:nowrap}
    .grow{flex:1}

    .seg{background:var(--panel-2);border:1px solid var(--border);padding:3px;border-radius:999px;display:flex;gap:3px}
    .seg button{border:0;background:transparent;padding:8px 12px;border-radius:999px;color:var(--muted);font-weight:600}
    .seg button[aria-pressed="true"]{background:var(--panel);color:var(--text);box-shadow:var(--shadow)}

    .icon-btn{appearance:none;background:var(--panel-2);border:1px solid var(--border);border-radius:12px;padding:9px;cursor:pointer}
    .icon-btn:active{transform:translateY(1px)}

    .wrap{max-width:960px;margin-inline:auto;padding:12px}

    .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    .grid{display:grid;gap:var(--gap)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .pill{border-radius:999px;padding:8px 12px;font-size:13px;color:var(--muted);border:1px solid var(--border);background:var(--panel-2)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}

    input[type="text"],input[type="search"],textarea{
      width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:var(--panel-2);color:var(--text);font-size:16px;
    }
    .btn{appearance:none;border:1px solid var(--border);border-radius:12px;padding:12px 14px;font-weight:700;display:inline-flex;align-items:center;gap:8px;cursor:pointer;background:var(--panel-2);color:var(--text)}
    .btn:active{transform:translateY(1px)}
    .primary{background:linear-gradient(180deg,color-mix(in oklab,var(--accent) 90%,#fff 10%),var(--accent));color:#fff;border:none}
    .success{background:linear-gradient(180deg,color-mix(in oklab,var(--accent-2) 85%,#fff 15%),var(--accent-2));color:#042a18;border:none}
    .danger{background:linear-gradient(180deg,#ff6b6b,var(--danger));color:#fff;border:none}
    .ghost{background:var(--panel-2)}
    .soft{background:var(--panel-2);border:1px dashed var(--border);color:var(--muted);font-weight:600}

    .progress{height:4px;background:var(--panel-2);border-radius:999px;overflow:hidden}
    .progress>i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent-2))}

    /* Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ù„ÛŒØ³Øª */
    .empty{border:1px dashed var(--border);border-radius:12px;padding:18px;text-align:center;color:var(--muted)}
    .place{border:1px solid var(--border);border-radius:14px;background:linear-gradient(180deg,var(--panel),color-mix(in oklab,var(--panel) 75%,var(--panel-2) 25%));padding:12px}
    .place-h{display:flex;align-items:center;gap:10px}
    .place-title{font-weight:800;min-width:0;overflow:hidden;text-overflow:ellipsis}
    .place-sub{font-size:12px;color:var(--muted)}
    .place-actions{display:none;margin-top:10px;gap:8px;flex-wrap:wrap}
    .place.open .place-actions{display:flex}

    /* Ú†ÛŒÙ¾â€ŒÙ‡Ø§ÛŒ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ */
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border:1px solid var(--border);background:var(--panel-2);border-radius:999px;cursor:pointer}
    .chip[aria-pressed="true"]{background:var(--panel);box-shadow:var(--shadow)}
    .chip input{display:none}

    /* Ø¯ÛŒØ§Ù„ÙˆÚ¯â€ŒÙ‡Ø§ */
    dialog{width:min(640px,94vw);border:1px solid var(--border);background:var(--panel);color:var(--text);border-radius:16px;padding:0;box-shadow:var(--shadow)}
    dialog::backdrop{background:rgba(0,0,0,.55)}
    .modal-head{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
    .modal-body{padding:12px 14px;display:grid;gap:12px}
    .modal-actions{padding:12px 14px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-start}
    .help{font-size:12px;color:var(--muted)}

    /* Ù†Ù‚Ø´Ù‡â€ŒÙ‡Ø§ */
    #pickerMap, #previewMap{width:100%;height:min(60vh,440px);border-radius:12px;border:1px solid var(--border);overflow:hidden}
    .map-toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}

    /* Ø§Ø¹Ù„Ø§Ù† Ú©ÙˆØªØ§Ù‡ */
    .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:var(--panel);border:1px solid var(--border);padding:10px 14px;border-radius:12px;color:var(--text);box-shadow:var(--shadow);opacity:0;pointer-events:none;transition:.25s;z-index:60}
    .toast.show{opacity:1;pointer-events:auto;bottom:28px}

    footer{padding:12px;text-align:center;color:var(--muted)}
  </style>
</head>
<body>
  <!-- Ù†ÙˆØ§Ø± Ø¨Ø§Ù„Ø§ -->
  <div class="appbar">
    <div class="row">
      <div class="brand" style="min-width:0">
        <img src="https://i.postimg.cc/vT811GJ3/App-Icon-2x.png" alt="Ø¢ÛŒÚ©Ù† Save Loc" />
        <div style="min-width:0">
          <div class="title">Save Loc</div>
          <div class="sub">Ø°Ø®ÛŒØ±Ù‡ Ù…Ú©Ø§Ù† â€¢ Ø¢ÙÙ„Ø§ÛŒÙ† â€¢ Ø§Ø´ØªØ±Ø§Ú©</div>
        </div>
      </div>
      <div class="grow"></div>
      <!-- ØªØºÛŒÛŒØ± ØªÙ… -->
      <div class="seg" role="tablist" aria-label="Theme">
        <button id="themeAuto" aria-pressed="true">Ø®ÙˆØ¯Ú©Ø§Ø±</button>
        <button id="themeLight" aria-pressed="false">Ø±ÙˆØ´Ù†</button>
        <button id="themeDark" aria-pressed="false">ØªØ§Ø±ÛŒÚ©</button>
      </div>
      <!-- Ø²Ø¨Ø§Ù† (Ù¾ÛŒØ´â€ŒÙØ±Ø¶ ÙØ§Ø±Ø³ÛŒ) -->
      <div class="seg" role="tablist" aria-label="Lang" style="margin-inline-start:8px">
        <button id="langFa" aria-pressed="true">ÙØ§</button>
        <button id="langEn" aria-pressed="false">EN</button>
      </div>
      <button id="installBtn" class="icon-btn" hidden title="Ù†ØµØ¨">â¬‡ï¸</button>
      <button id="a2hsHint" class="icon-btn" hidden title="Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ">ï¼‹</button>
      <button id="settingsBtn" class="icon-btn" title="ØªÙ†Ø¸ÛŒÙ…Ø§Øª">âš™ï¸</button>
    </div>
  </div>

  <main class="wrap grid" style="padding-top:10px">
    <!-- Ù…Ú©Ø§Ù† ÙØ¹Ù„ÛŒ -->
    <section class="card grid">
      <div class="row" style="justify-content:space-between">
        <h2 style="margin:0;font-size:16px">Ù…Ú©Ø§Ù† ÙØ¹Ù„ÛŒ</h2>
        <span id="permStatus" class="pill">Ø¯Ø³ØªØ±Ø³ÛŒ: <b>Ù†Ø§Ù…Ø´Ø®Øµ</b></span>
      </div>
      <div class="progress"><i id="progBar"></i></div>

      <div class="row">
        <button id="locateBtn" class="btn primary">ğŸ“ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¯Ù‚ÛŒÙ‚</button>
        <button id="openPicker" class="btn ghost">ğŸ—ºï¸ Ø§Ù†ØªØ®Ø§Ø¨ Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡</button>
        <button id="saveLiveBtn" class="btn success" disabled>â­ Ø°Ø®ÛŒØ±Ù‡</button>
        <button id="shareBtn" class="btn ghost" disabled>â†—ï¸ Ø§Ø´ØªØ±Ø§Ú©</button>
      </div>

      <div class="row">
        <div class="pill mono" id="latBox">Ø¹Ø±Ø¶: â€“</div>
        <div class="pill mono" id="lngBox">Ø·ÙˆÙ„: â€“</div>
        <div class="pill" id="accBox">Ø¯Ù‚Øª: â€“</div>
      </div>
      <div class="row">
        <button id="copyLat" class="btn ghost" disabled>ğŸ“‹ Ú©Ù¾ÛŒ Ø¹Ø±Ø¶</button>
        <button id="copyLng" class="btn ghost" disabled>ğŸ“‹ Ú©Ù¾ÛŒ Ø·ÙˆÙ„</button>
        <button id="copyBoth" class="btn ghost" disabled>ğŸ“‹ Ú©Ù¾ÛŒ Ø¹Ø±Ø¶ØŒØ·ÙˆÙ„</button>
      </div>
      <div class="row" id="addrRow" style="display:none">
        <div class="pill" id="addrChip">ğŸ“ Ø¯Ø±Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø¢Ø¯Ø±Ø³â€¦</div>
      </div>
      <div class="muted" id="tsBox">â€”</div>

      <div class="row">
        <button id="openApple" class="btn" disabled>ğŸ—ºï¸ Ø§Ù¾Ù„</button>
        <button id="openGoogle" class="btn" disabled>ğŸ—ºï¸ Ú¯ÙˆÚ¯Ù„</button>
        <button id="openWaze" class="btn" disabled>ğŸš˜ ÙˆÛŒØ²</button>
        <button id="dirApple" class="btn" disabled>â¡ï¸ Ù…Ø³ÛŒÙ€Ø±ÛŒØ§Ø¨ÛŒ Ø§Ù¾Ù„</button>
        <button id="openCustom" class="btn" disabled>ğŸ”— Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯ÛŒÚ¯Ø±</button>
      </div>
    </section>

    <!-- Ù„ÛŒØ³Øª Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡ -->
    <section class="card grid">
      <div class="row" style="justify-content:space-between">
        <h2 style="margin:0;font-size:16px">Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡</h2>
        <input id="searchBox" type="search" placeholder="Ø¬Ø³ØªØ¬Ùˆ: Ù†Ø§Ù…ØŒ Ø¢Ø¯Ø±Ø³ØŒ ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€¦" aria-label="Ø¬Ø³ØªØ¬Ùˆ" />
      </div>
      <div id="listArea" class="grid">
        <div class="empty">Ù‡Ù†ÙˆØ² Ù…Ú©Ø§Ù†ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯Ù‡. Ø§Ø² <b>Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¯Ù‚ÛŒÙ‚</b> ÛŒØ§ <b>Ø§Ù†ØªØ®Ø§Ø¨ Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡</b> Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.</div>
      </div>
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <button id="exportBtn" class="btn ghost">â¬‡ï¸ Ø®Ø±ÙˆØ¬ÛŒ</button>
          <input id="importFile" type="file" accept="application/json" hidden />
          <button id="importBtn" class="btn ghost">â¬†ï¸ ÙˆØ±ÙˆØ¯</button>
        </div>
        <div class="row">
          <button id="backupBtn" class="btn ghost">ğŸ§° Ù¾Ø´ØªÛŒØ¨Ø§Ù†</button>
          <input id="restoreFile" type="file" accept="application/json" hidden />
          <button id="restoreBtn" class="btn ghost">ğŸ§³ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ</button>
          <button id="clearAllBtn" class="btn danger">ğŸ—‘ï¸ Ø­Ø°Ù Ù‡Ù…Ù‡</button>
        </div>
      </div>
    </section>
  </main>

  <footer>Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· <b>peymaan abedinpour</b></footer>
  <div id="toast" class="toast" role="status" aria-live="polite">Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯</div>

  <!-- ØªÙ†Ø¸ÛŒÙ…Ø§Øª -->
  <dialog id="settingsModal">
    <div class="modal-head">
      <strong>ØªÙ†Ø¸ÛŒÙ…Ø§Øª</strong>
      <div class="grow"></div>
      <button id="closeSettings" class="icon-btn" title="Ø¨Ø³ØªÙ†">âœ•</button>
    </div>
    <div class="modal-body">
      <div>
        <label for="customTpl" class="muted">Ù‚Ø§Ù„Ø¨ Ù„ÛŒÙ†Ú© Ø³ÙØ§Ø±Ø´ÛŒ (Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯ÛŒÚ¯Ø±)</label>
        <input id="customTpl" type="text" placeholder="myapp://open?lat={lat}&lng={lng}&name={name}" />
        <div class="help">Ø¬Ø§ÛŒâ€ŒÚ¯Ø°Ø§Ø±Ù‡Ø§: <code>{lat}</code>ØŒ <code>{lng}</code>ØŒ <code>{name}</code> â€” Ù…Ø«Ø§Ù„: <code>waze://?ll={lat},{lng}&navigate=yes</code></div>
      </div>

      <div>
        <label class="muted">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§</label>
        <div id="catList" class="grid" style="grid-template-columns:repeat(auto-fill,minmax(220px,1fr))"></div>
        <div class="row">
          <input id="newCatName" type="text" placeholder="Ù†Ø§Ù… Ø¯Ø³ØªÙ‡ (Ù…Ø«Ù„Ø§Ù‹: Ù¾Ø§Ø±Ú©ÛŒÙ†Ú¯)" />
          <input id="newCatIcon" type="text" placeholder="Ø§ÛŒÙ…ÙˆØ¬ÛŒ (Ù…Ø«Ù„Ø§Ù‹: ğŸ…¿ï¸)" style="max-width:140px" />
          <button id="addCatBtn" class="btn success">Ø§ÙØ²ÙˆØ¯Ù†</button>
        </div>
        <div class="help">Ø§Ø² Ø§ÛŒÙ…ÙˆØ¬ÛŒ Ø¨Ù‡â€ŒØ¹Ù†ÙˆØ§Ù† Ø¢ÛŒÚ©Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯ (ğŸ  ğŸ’¼ ğŸ…¿ï¸ â­ ğŸ‘¤ ğŸ“Œ).</div>
      </div>

      <div>
        <label for="shareTitle" class="muted">Ø¹Ù†ÙˆØ§Ù† Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ</label>
        <input id="shareTitle" type="text" placeholder="Save Loc" />
      </div>
    </div>
    <div class="modal-actions">
      <button id="testCustom" class="btn ghost">Ø¢Ø²Ù…ÙˆÙ† Ù„ÛŒÙ†Ú©</button>
      <div class="grow"></div>
      <button id="saveSettings" class="btn primary">Ø°Ø®ÛŒØ±Ù‡</button>
    </div>
  </dialog>

  <!-- Ø°Ø®ÛŒØ±Ù‡/ÙˆÛŒØ±Ø§ÛŒØ´ -->
  <dialog id="saveModal">
    <div class="modal-head">
      <strong id="saveModalTitle">Ø°Ø®ÛŒØ±Ù‡ Ù…Ú©Ø§Ù†</strong>
      <div class="grow"></div>
      <button id="closeSave" class="icon-btn">âœ•</button>
    </div>
    <div class="modal-body">
      <div>
        <label class="muted" for="placeName">Ù†Ø§Ù…</label>
        <input id="placeName" type="text" placeholder="Ù†Ù‚Ø·Ù‡ Ù…Ù†" />
      </div>
      <div>
        <label class="muted">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</label>
        <div id="catChips" class="chips"></div>
        <div class="row">
          <input id="quickCatName" type="text" placeholder="Ù†Ø§Ù… Ø¯Ø³ØªÙ‡ Ø¬Ø¯ÛŒØ¯" />
          <input id="quickCatIcon" type="text" placeholder="Ø§ÛŒÙ…ÙˆØ¬ÛŒ (ğŸ“Œ)" style="max-width:140px" />
          <button id="quickAddCat" class="btn success">Ø§ÙØ²ÙˆØ¯Ù†</button>
        </div>
      </div>
      <div>
        <label class="muted" for="placeNotes">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</label>
        <textarea id="placeNotes" rows="3" placeholder="ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø§Ø®ØªÛŒØ§Ø±ÛŒ (Ú©Ø¯ Ø¯Ø±ØŒ Ø·Ø¨Ù‚Ù‡ØŒ ØªÙ…Ø§Ø³â€¦)"></textarea>
      </div>
      <div class="row">
        <div class="pill mono" id="saveLat">Ø¹Ø±Ø¶: â€”</div>
        <div class="pill mono" id="saveLng">Ø·ÙˆÙ„: â€”</div>
        <div class="pill" id="saveAcc">Ø¯Ù‚Øª: â€”</div>
      </div>
      <div class="row"><div class="pill" id="saveAddr">ğŸ“ â€”</div></div>
    </div>
    <div class="modal-actions">
      <button id="saveCancel" class="btn ghost">Ø§Ù†ØµØ±Ø§Ù</button>
      <button id="saveConfirm" class="btn primary">Ø°Ø®ÛŒØ±Ù‡</button>
    </div>
  </dialog>

  <!-- Ø§Ù†ØªØ®Ø§Ø¨ Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡ -->
  <dialog id="pickerModal">
    <div class="modal-head">
      <strong>Ø§Ù†ØªØ®Ø§Ø¨ Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡</strong>
      <div class="grow"></div>
      <button id="closePicker" class="icon-btn">âœ•</button>
    </div>
    <div class="modal-body">
      <div id="pickerMap"></div>
      <div class="map-toolbar">
        <input id="pickerSearch" type="text" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¢Ø¯Ø±Ø³â€¦" />
        <button id="pickerSearchBtn" class="btn ghost">ğŸ” Ø¬Ø³ØªØ¬Ùˆ</button>
        <button id="pickerUse" class="btn success">Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§ÛŒÙ† Ù†Ù‚Ø·Ù‡</button>
      </div>
      <div class="help">Ù¾ÛŒÙ† Ø±Ø§ Ø¨Ú©Ø´ÛŒØ¯ ÛŒØ§ Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡ Ù„Ù…Ø³ Ø·ÙˆÙ„Ø§Ù†ÛŒ/Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯. Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø§Ø¹Ø« Ø²ÙˆÙ… Ù…ØªÙ†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
    </div>
  </dialog>

  <!-- Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ -->
  <dialog id="previewModal">
    <div class="modal-head">
      <strong id="previewTitle">Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´</strong>
      <div class="grow"></div>
      <button id="closePreview" class="icon-btn">âœ•</button>
    </div>
    <div class="modal-body">
      <div id="previewMap"></div>
      <div id="previewAddr" class="muted">â€”</div>
      <div class="row">
        <button id="pvApple" class="btn">ğŸ—ºï¸ Ø§Ù¾Ù„</button>
        <button id="pvGoogle" class="btn">ğŸ—ºï¸ Ú¯ÙˆÚ¯Ù„</button>
        <button id="pvWaze" class="btn">ğŸš˜ ÙˆÛŒØ²</button>
        <button id="pvDir" class="btn">â¡ï¸ Ù…Ø³ÛŒØ± Ø§Ù¾Ù„</button>
        <button id="pvShare" class="btn ghost">â†—ï¸ Ø§Ø´ØªØ±Ø§Ú©</button>
      </div>
    </div>
  </dialog>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    /* ========= Manifest ========= */
    (function makeManifest(){
      const manifest = {
        name:"Save Loc â€” Ø°Ø®ÛŒØ±Ù‡ Ù…Ú©Ø§Ù†",
        short_name:"Save Loc",
        start_url:"./",
        display:"standalone",
        background_color:"#0b1220",
        theme_color:"#0b1220",
        icons:[
          {"src":"https://i.postimg.cc/vT811GJ3/App-Icon-2x.png","sizes":"192x192","type":"image/png","purpose":"any maskable"},
          {"src":"https://i.postimg.cc/vT811GJ3/App-Icon-2x.png","sizes":"512x512","type":"image/png","purpose":"any maskable"}
        ]
      };
      const blob = new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"});
      const url = URL.createObjectURL(blob);
      const link = document.createElement('link'); link.rel = 'manifest'; link.href = url; document.head.appendChild(link);
    })();

    /* ========= Service Worker (offline shell) ========= */
    (function makeSW(){
      if(!('serviceWorker' in navigator)) return;
      const swCode = `
        const CACHE='saveloc-v5';
        const ASSETS=['./'];
        self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS)).then(self.skipWaiting()))});
        self.addEventListener('activate',e=>{e.waitUntil(self.clients.claim())});
        self.addEventListener('fetch',e=>{
          e.respondWith(
            caches.match(e.request).then(c=>c||fetch(e.request).then(res=>{
              const copy=res.clone(); caches.open(CACHE).then(cache=>cache.put(e.request,copy)).catch(()=>{});
              return res;
            }).catch(()=>caches.match('./')))
          );
        });
      `;
      const blob = new Blob([swCode], {type:'text/javascript'});
      navigator.serviceWorker.register(URL.createObjectURL(blob));
    })();

    /* ========= Ø¹Ù†Ø§ØµØ± ========= */
    const themeAuto = document.getElementById('themeAuto');
    const themeLight = document.getElementById('themeLight');
    const themeDark = document.getElementById('themeDark');
    const langFa = document.getElementById('langFa');
    const langEn = document.getElementById('langEn');

    const installBtn = document.getElementById('installBtn');
    const a2hsHint = document.getElementById('a2hsHint');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsModal = document.getElementById('settingsModal');
    const closeSettings = document.getElementById('closeSettings');
    const saveSettingsBtn = document.getElementById('saveSettings');
    const testCustom = document.getElementById('testCustom');

    const customTpl = document.getElementById('customTpl');
    const shareTitle = document.getElementById('shareTitle');

    const catList = document.getElementById('catList');
    const newCatName = document.getElementById('newCatName');
    const newCatIcon = document.getElementById('newCatIcon');
    const addCatBtn = document.getElementById('addCatBtn');

    const locateBtn = document.getElementById('locateBtn');
    const openPicker = document.getElementById('openPicker');
    const saveLiveBtn = document.getElementById('saveLiveBtn');
    const shareBtn = document.getElementById('shareBtn');
    const progBar = document.getElementById('progBar');
    const permStatus = document.getElementById('permStatus');

    const latBox = document.getElementById('latBox');
    const lngBox = document.getElementById('lngBox');
    const accBox = document.getElementById('accBox');
    const tsBox  = document.getElementById('tsBox');
    const addrRow = document.getElementById('addrRow');
    const addrChip = document.getElementById('addrChip');

    const copyLat = document.getElementById('copyLat');
    const copyLng = document.getElementById('copyLng');
    const copyBoth = document.getElementById('copyBoth');

    const openApple = document.getElementById('openApple');
    const openGoogle = document.getElementById('openGoogle');
    const openWaze = document.getElementById('openWaze');
    const openCustom = document.getElementById('openCustom');
    const dirApple = document.getElementById('dirApple');

    const listArea = document.getElementById('listArea');
    const searchBox = document.getElementById('searchBox');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const importFile = document.getElementById('importFile');
    const backupBtn = document.getElementById('backupBtn');
    const restoreBtn = document.getElementById('restoreBtn');
    const restoreFile = document.getElementById('restoreFile');
    const clearAllBtn = document.getElementById('clearAllBtn');

    const pickerModal = document.getElementById('pickerModal');
    const pickerMapEl = document.getElementById('pickerMap');
    const pickerSearch = document.getElementById('pickerSearch');
    const pickerSearchBtn = document.getElementById('pickerSearchBtn');
    const pickerUse = document.getElementById('pickerUse');
    const closePicker = document.getElementById('closePicker');

    const previewModal = document.getElementById('previewModal');
    const previewTitle = document.getElementById('previewTitle');
    const previewMapEl = document.getElementById('previewMap');
    const previewAddr = document.getElementById('previewAddr');
    const pvApple = document.getElementById('pvApple');
    const pvGoogle = document.getElementById('pvGoogle');
    const pvWaze = document.getElementById('pvWaze');
    const pvDir = document.getElementById('pvDir');
    const pvShare = document.getElementById('pvShare');
    const closePreview = document.getElementById('closePreview');

    const saveModal = document.getElementById('saveModal');
    const saveModalTitle = document.getElementById('saveModalTitle');
    const closeSave = document.getElementById('closeSave');
    const saveLat = document.getElementById('saveLat');
    const saveLng = document.getElementById('saveLng');
    const saveAcc = document.getElementById('saveAcc');
    const saveAddr = document.getElementById('saveAddr');
    const placeName = document.getElementById('placeName');
    const placeNotes = document.getElementById('placeNotes');
    const catChips = document.getElementById('catChips');
    const quickCatName = document.getElementById('quickCatName');
    const quickCatIcon = document.getElementById('quickCatIcon');
    const quickAddCat = document.getElementById('quickAddCat');
    const saveCancel = document.getElementById('saveCancel');
    const saveConfirm = document.getElementById('saveConfirm');

    /* ========= Ú©Ù…Ú©â€ŒÚ©Ø§Ø±Ù‡Ø§ ========= */
    const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    function toast(msg){ const el = document.getElementById('toast'); el.textContent=msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),1800); }
    function formatTs(t){ return new Date(t).toLocaleString('fa-IR'); }
    function setProgress(p){ progBar.style.width = Math.max(0, Math.min(100, p)) + '%'; }
    function downloadBlob(data, type, name){ const blob=new Blob([data],{type}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url); }

    /* ========= ØªÙ… Ùˆ Ø²Ø¨Ø§Ù† ========= */
    const PREF_THEME='saveloc.theme';
    const PREF_LANG='saveloc.lang';
    function applyTheme(val){
      document.documentElement.removeAttribute('data-theme');
      if(val==='light'||val==='dark') document.documentElement.setAttribute('data-theme',val);
      [themeAuto,themeLight,themeDark].forEach(b=>b.setAttribute('aria-pressed','false'));
      (val==='light'?themeLight:val==='dark'?themeDark:themeAuto).setAttribute('aria-pressed','true');
      localStorage.setItem(PREF_THEME,val);
    }
    [themeAuto,themeLight,themeDark].forEach(btn=>btn.addEventListener('click',()=>applyTheme(btn===themeLight?'light':btn===themeDark?'dark':'auto')));
    applyTheme(localStorage.getItem(PREF_THEME)||'auto');

    function applyLang(val){
      document.documentElement.lang = (val==='en') ? 'en' : 'fa';
      document.documentElement.dir = (val==='en') ? 'ltr' : 'rtl';
      [langFa,langEn].forEach(b=>b.setAttribute('aria-pressed','false'));
      (val==='en'?langEn:langFa).setAttribute('aria-pressed','true');
      localStorage.setItem(PREF_LANG,val);
    }
    langFa.addEventListener('click', ()=>applyLang('fa'));
    langEn.addEventListener('click', ()=>applyLang('en'));
    applyLang(localStorage.getItem(PREF_LANG)||'fa'); // Ù¾ÛŒØ´â€ŒÙØ±Ø¶ ÙØ§Ø±Ø³ÛŒ

    /* ========= Ù†ØµØ¨ PWA ========= */
    let deferredPrompt=null;
    window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; installBtn.hidden=false; });
    installBtn.addEventListener('click', async ()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; installBtn.hidden=true; });
    if(isIOS && !isStandalone){ a2hsHint.hidden=false; a2hsHint.addEventListener('click', ()=> toast('Ø¯Ø± Ø¢ÛŒÙÙˆÙ†: Share â–¸ Add to Home Screen')); }

    /* ========= Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ú©Ø§Ù† ========= */
    async function checkPerm(){
      if(!navigator.permissions || !navigator.geolocation){ permStatus.innerHTML='Ø¯Ø³ØªØ±Ø³ÛŒ: <b>Ù†Ø§Ù…Ø´Ø®Øµ</b>'; return; }
      try{
        const st = await navigator.permissions.query({name:'geolocation'});
        const map = { 'granted':'<b style="color:var(--accent-2)">Ù…Ø¬Ø§Ø²</b>', 'denied':'<b style="color:var(--danger)">Ø±Ø¯</b>', 'prompt':'<b>Ù¾Ø±Ø³Ø´</b>' };
        permStatus.innerHTML = 'Ø¯Ø³ØªØ±Ø³ÛŒ: ' + (map[st.state] || '<b>Ù†Ø§Ù…Ø´Ø®Øµ</b>');
        st.onchange = ()=>{ permStatus.innerHTML = 'Ø¯Ø³ØªØ±Ø³ÛŒ: ' + (map[st.state] || '<b>Ù†Ø§Ù…Ø´Ø®Øµ</b>'); };
      }catch{ permStatus.innerHTML='Ø¯Ø³ØªØ±Ø³ÛŒ: <b>Ù†Ø§Ù…Ø´Ø®Øµ</b>'; }
    }
    checkPerm();

    /* ========= Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ ========= */
    const KEY='saveloc.places.v1';
    const PREF='saveloc.prefs.v1';
    const CATS='saveloc.categories.v1';
    function readPlaces(){ try{ return JSON.parse(localStorage.getItem(KEY)) || []; }catch{ return []; } }
    function writePlaces(arr){ localStorage.setItem(KEY, JSON.stringify(arr)); }
    function readPrefs(){ const def={customTpl:'',shareTitle:'Save Loc'}; try{ return {...def, ...(JSON.parse(localStorage.getItem(PREF))||{})}; }catch{ return def; } }
    function writePrefs(p){ localStorage.setItem(PREF, JSON.stringify(p)); }
    function readCats(){
      const def=[{id:'home',name:'Ø®Ø§Ù†Ù‡',icon:'ğŸ '},{id:'work',name:'Ú©Ø§Ø±',icon:'ğŸ’¼'},{id:'parking',name:'Ù¾Ø§Ø±Ú©ÛŒÙ†Ú¯',icon:'ğŸ…¿ï¸'},{id:'fav',name:'Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒ',icon:'â­'},{id:'customer',name:'Ù…Ø´ØªØ±ÛŒ',icon:'ğŸ‘¤'}];
      try{ const saved = JSON.parse(localStorage.getItem(CATS)); if(Array.isArray(saved)&&saved.length) return saved; localStorage.setItem(CATS, JSON.stringify(def)); return def; }catch{ return def; }
    }
    function writeCats(arr){ localStorage.setItem(CATS, JSON.stringify(arr)); }

    /* ========= Ù…Ø¹Ú©ÙˆØ³ Ø¢Ø¯Ø±Ø³ (Ú©Ø´â€ŒØ´Ø¯Ù‡) ========= */
    function reverseGeocode(lat,lng){
      const key='addr:'+lat.toFixed(5)+','+lng.toFixed(5);
      const cached=localStorage.getItem(key); if(cached) return Promise.resolve(cached);
      return fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}&zoom=18&addressdetails=0`,{headers:{'Accept':'application/json'}})
        .then(r=>r.ok?r.json():Promise.reject()).then(j=>j.display_name||'').then(addr=>{ if(addr) localStorage.setItem(key,addr); return addr; })
        .catch(()=> '');
    }

    /* ========= Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ù†Ù‚Ø´Ù‡ ========= */
    const appleLink = (lat,lng,name='') => `https://maps.apple.com/?ll=${lat},${lng}&q=${encodeURIComponent(name||`${lat.toFixed(6)},${lng.toFixed(6)}`)}`;
    const googleLink = (lat,lng) => `https://maps.google.com/?q=${lat},${lng}`;
    const wazeLink = (lat,lng) => `https://waze.com/ul?ll=${lat},${lng}&navigate=yes`;
    const appleDirections = (lat,lng,addr='') => `https://maps.apple.com/?daddr=${lat},${lng}&q=${encodeURIComponent(addr||`${lat.toFixed(6)},${lng.toFixed(6)}`)}&dirflg=d&saddr=Current%20Location`;
    function customLink(lat,lng,name){ const {customTpl}=readPrefs(); if(!customTpl) return ''; return customTpl.replaceAll('{lat}',lat).replaceAll('{lng}',lng).replaceAll('{name}',encodeURIComponent(name||'')); }

    /* ========= Ù…Ú©Ø§Ù† ÙØ¹Ù„ÛŒ ========= */
    let current = null;
    function enableLive(on){
      [saveLiveBtn,shareBtn,openApple,openGoogle,openWaze,dirApple,openCustom,copyLat,copyLng,copyBoth].forEach(b=>b.disabled=!on);
    }
    locateBtn.addEventListener('click', ()=>{
      if(!navigator.geolocation){ toast('Ø§ÛŒÙ† Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø§Ø² Ù…Ú©Ø§Ù†â€ŒÛŒØ§Ø¨ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯'); return; }
      setProgress(10); addrRow.style.display='none';
      navigator.geolocation.getCurrentPosition(onPos,onErr,{enableHighAccuracy:true,timeout:15000,maximumAge:0});
      let t=10, iv=setInterval(()=>{ t=Math.min(95,t+4); setProgress(t); },300);
      function onPos(pos){
        clearInterval(iv); setProgress(100);
        const {latitude,longitude,accuracy}=pos.coords;
        current={lat:latitude,lng:longitude,acc:Math.round(accuracy),ts:Date.now()};
        latBox.textContent='Ø¹Ø±Ø¶: '+latitude.toFixed(6);
        lngBox.textContent='Ø·ÙˆÙ„: '+longitude.toFixed(6);
        accBox.textContent='Ø¯Ù‚Øª: Â±'+Math.round(accuracy)+' Ù…ØªØ±';
        tsBox.textContent='Ø²Ù…Ø§Ù†: '+formatTs(current.ts);
        enableLive(true);
        reverseGeocode(latitude,longitude).then(addr=>{ if(addr){ current.address=addr; addrChip.textContent='ğŸ“ '+addr; addrRow.style.display='flex'; } });
        setTimeout(()=>setProgress(0),400);
      }
      function onErr(err){ clearInterval(iv); setProgress(0); toast(err.message||'Ø®Ø·Ø§ÛŒ Ù…Ú©Ø§Ù†'); }
    });

    copyLat.onclick = async ()=>{ if(!current) return; try{ await navigator.clipboard.writeText(String(current.lat)); toast('Ø¹Ø±Ø¶ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ Ú©Ù¾ÛŒ Ø´Ø¯'); }catch{ toast('Ú©Ù¾ÛŒ Ù†Ø§Ù…ÙˆÙÙ‚'); } };
    copyLng.onclick = async ()=>{ if(!current) return; try{ await navigator.clipboard.writeText(String(current.lng)); toast('Ø·ÙˆÙ„ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ Ú©Ù¾ÛŒ Ø´Ø¯'); }catch{ toast('Ú©Ù¾ÛŒ Ù†Ø§Ù…ÙˆÙÙ‚'); } };
    copyBoth.onclick = async ()=>{ if(!current) return; try{ await navigator.clipboard.writeText(`${current.lat},${current.lng}`); toast('Ø¹Ø±Ø¶ØŒØ·ÙˆÙ„ Ú©Ù¾ÛŒ Ø´Ø¯'); }catch{ toast('Ú©Ù¾ÛŒ Ù†Ø§Ù…ÙˆÙÙ‚'); } };

    shareBtn.addEventListener('click', async ()=>{
      if(!current) return;
      const prefs = readPrefs();
      const url = googleLink(current.lat,current.lng);
      const text = `${current.address? current.address : 'Ù…Ú©Ø§Ù† Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡'} â€” ${current.lat.toFixed(6)},${current.lng.toFixed(6)} (Â±${current.acc} Ù…ØªØ±)`;
      if(navigator.share){ try{ await navigator.share({ title:prefs.shareTitle||'Save Loc', text, url }); }catch{} }
      else{ try{ await navigator.clipboard.writeText(`${text}\n${url}`); toast('Ù…ØªÙ† Ø§Ø´ØªØ±Ø§Ú© Ø¯Ø± Ú©Ù„ÛŒÙ¾â€ŒØ¨ÙˆØ±Ø¯ Ø§Ø³Øª'); }catch{ toast('Ø§Ø´ØªØ±Ø§Ú© Ù†Ø§Ù…ÙˆÙÙ‚'); } }
    });

    openApple.onclick = ()=>{ if(!current) return; window.open(appleLink(current.lat,current.lng,current.address||'Location'),'_blank','noopener'); };
    openGoogle.onclick = ()=>{ if(!current) return; window.open(googleLink(current.lat,current.lng),'_blank','noopener'); };
    openWaze.onclick = ()=>{ if(!current) return; window.open(wazeLink(current.lat,current.lng),'_blank','noopener'); };
    dirApple.onclick = ()=>{ if(!current) return; window.open(appleDirections(current.lat,current.lng,current.address||'Destination'),'_blank','noopener'); };
    openCustom.onclick = ()=>{ if(!current) return; const url=customLink(current.lat,current.lng,current.address||''); if(url) window.location.href=url; else toast('Ø§Ø¨ØªØ¯Ø§ Ù‚Ø§Ù„Ø¨ Ù„ÛŒÙ†Ú© Ø³ÙØ§Ø±Ø´ÛŒ Ø±Ø§ Ø¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); };

    /* ========= Ø°Ø®ÛŒØ±Ù‡/ÙˆÛŒØ±Ø§ÛŒØ´ ========= */
    let pendingSave = null;
    let editId = null;

    function openSaveModal(record, mode='save'){
      pendingSave = record; editId = (mode==='edit') ? record.id : null;
      saveModalTitle.textContent = (mode==='edit') ? 'ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ú©Ø§Ù†' : 'Ø°Ø®ÛŒØ±Ù‡ Ù…Ú©Ø§Ù†';
      placeName.value = record.name || (record.address? record.address.split(',')[0] : 'Ù†Ù‚Ø·Ù‡ Ù…Ù†');
      placeNotes.value = record.notes || '';
      saveLat.textContent = 'Ø¹Ø±Ø¶: '+record.lat.toFixed(6);
      saveLng.textContent = 'Ø·ÙˆÙ„: '+record.lng.toFixed(6);
      saveAcc.textContent = 'Ø¯Ù‚Øª: Â±'+(record.acc ?? 'â€”')+' Ù…ØªØ±';
      saveAddr.textContent = 'ğŸ“ '+(record.address || 'â€”');
      renderCatChips(record.category);
      saveModal.showModal();
    }
    const saveLiveBtnHandler = ()=>{ if(!current) return; openSaveModal({ ...current, name:'Ù…Ú©Ø§Ù† ÙØ¹Ù„ÛŒ' }, 'save'); };
    saveLiveBtn.onclick = saveLiveBtnHandler;
    closeSave.onclick = ()=> saveModal.close();
    saveCancel.onclick = ()=> saveModal.close();
    saveConfirm.onclick = ()=>{
      if(!pendingSave) return;
      const cat = selectedCatFromChips();
      const place = {
        id: editId || (crypto.randomUUID?.() || (Date.now()+'-'+Math.random().toString(16).slice(2))),
        name: (placeName.value||'Ø¨Ø¯ÙˆÙ† Ù†Ø§Ù…').trim(),
        lat: +pendingSave.lat, lng: +pendingSave.lng, acc: +pendingSave.acc || 0,
        ts: pendingSave.ts || Date.now(),
        address: pendingSave.address || '',
        category: cat,
        notes: (placeNotes.value||'').trim()
      };
      if(editId){
        const arr=readPlaces(); const i=arr.findIndex(x=>x.id===editId); if(i>-1) arr[i]=place; writePlaces(arr);
      }else{
        const arr=readPlaces(); arr.unshift(place); writePlaces(arr);
      }
      saveModal.close(); renderList(); toast(editId?'Ø¨Ù‡â€ŒØ±ÙˆØ² Ø´Ø¯ âœ…':'Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ â­');
    };

    /* ========= Ø§Ù†ØªØ®Ø§Ø¨ Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡ ========= */
    let picker = null, pickerMarker = null;
    openPicker.onclick = ()=>{
      pickerModal.showModal();
      setTimeout(initPicker, 20);
    };
    closePicker.onclick = ()=> pickerModal.close();
    function initPicker(){
      if(!picker){
        picker = L.map(pickerMapEl,{zoomControl:true, attributionControl:false}).setView([35.6892,51.3890],13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(picker);
        pickerMarker = L.marker(picker.getCenter(),{draggable:true}).addTo(picker);
        picker.on('click', e=>{ pickerMarker.setLatLng(e.latlng); });
      } else { picker.invalidateSize(); }
      if(current){ picker.setView([current.lat,current.lng],16); pickerMarker.setLatLng([current.lat,current.lng]); }
    }
    pickerSearchBtn.onclick = ()=>{
      const q = pickerSearch.value.trim(); if(!q) return;
      fetch(`https://nominatim.openstreetmap.org/search?format=jsonv2&q=${encodeURIComponent(q)}&limit=1`)
        .then(r=>r.ok?r.json():[]).then(arr=>{
          if(arr && arr[0]){ const {lat,lon}=arr[0]; const latf=+lat, lonf=+lon; picker.setView([latf,lonf],16); pickerMarker.setLatLng([latf,lonf]); toast('ÛŒØ§ÙØª Ø´Ø¯'); }
          else toast('Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯');
        }).catch(()=>toast('Ø®Ø·Ø§ÛŒ Ø¬Ø³ØªØ¬Ùˆ'));
    };
    pickerUse.onclick = ()=>{
      const {lat,lng} = pickerMarker.getLatLng();
      const rec = {lat: +lat, lng: +lng, acc: 0, ts: Date.now()};
      reverseGeocode(lat,lng).then(addr=>{ if(addr) rec.address=addr; openSaveModal(rec,'save'); });
      pickerModal.close();
    };

    /* ========= ØªÙ†Ø¸ÛŒÙ…Ø§Øª (Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§/Ø§Ø´ØªØ±Ø§Ú©) ========= */
    function renderCatList(){
      const cats = readCats(); catList.innerHTML='';
      cats.forEach((c,idx)=>{
        const row = document.createElement('div'); row.className='row'; row.style.justifyContent='space-between';
        const left = document.createElement('div'); left.className='chip'; left.textContent = `${c.icon} ${c.name}`;
        const right = document.createElement('div'); right.className='row';
        const edit = document.createElement('button'); edit.className='btn ghost'; edit.textContent='ÙˆÛŒØ±Ø§ÛŒØ´';
        edit.onclick = ()=>{
          const nn = prompt('Ù†Ø§Ù…:', c.name); if(nn===null) return;
          const ni = prompt('Ø§ÛŒÙ…ÙˆØ¬ÛŒ:', c.icon); if(ni===null) return;
          const arr=readCats(); arr[idx]={...c,name:(nn||c.name).trim(),icon:(ni||c.icon).trim()}; writeCats(arr); renderCatList(); toast('Ø¯Ø³ØªÙ‡ Ø¨Ù‡â€ŒØ±ÙˆØ² Ø´Ø¯');
        };
        const del = document.createElement('button'); del.className='btn danger'; del.textContent='Ø­Ø°Ù';
        del.onclick = ()=>{
          if(!confirm('Ø§ÛŒÙ† Ø¯Ø³ØªÙ‡ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
          const arr = readCats().filter(x=>x.id!==c.id); writeCats(arr); renderCatList(); toast('Ø­Ø°Ù Ø´Ø¯');
        };
        right.append(edit,del); row.append(left,right); catList.appendChild(row);
      });
    }
    function renderCatChips(selected){
      const cats=readCats(); catChips.innerHTML='';
      cats.forEach(c=>{
        const b=document.createElement('button'); b.className='chip'; b.setAttribute('aria-pressed', selected && selected.id===c.id ? 'true':'false');
        b.textContent = `${c.icon} ${c.name}`;
        b.onclick = ()=>{
          [...catChips.children].forEach(n=>n.setAttribute('aria-pressed','false'));
          b.setAttribute('aria-pressed','true'); b.dataset.catId = c.id;
        };
        b.dataset.catId = c.id;
        catChips.appendChild(b);
      });
      if(selected){
        const btn=[...catChips.children].find(x=>x.dataset.catId===selected.id);
        if(btn) btn.setAttribute('aria-pressed','true');
      } else if(catChips.firstChild){
        catChips.firstChild.setAttribute('aria-pressed','true');
      }
    }
    function selectedCatFromChips(){
      const cats=readCats();
      const btn=[...catChips.children].find(x=>x.getAttribute('aria-pressed')==='true');
      const id=btn?btn.dataset.catId:cats[0]?.id;
      return cats.find(c=>c.id===id) || cats[0];
    }
    quickAddCat.onclick = ()=>{
      const name=(quickCatName.value||'').trim(); const icon=(quickCatIcon.value||'ğŸ“Œ').trim();
      if(!name){ toast('Ù†Ø§Ù… Ø¯Ø³ØªÙ‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
      const arr=readCats(); const cat={id:(Date.now()+'-'+Math.random().toString(16).slice(2)), name, icon}; arr.push(cat); writeCats(arr);
      quickCatName.value=''; quickCatIcon.value='';
      renderCatChips(cat); toast('Ø¯Ø³ØªÙ‡ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯');
    };

    settingsBtn.onclick = ()=>{ const p=readPrefs(); customTpl.value=p.customTpl||''; shareTitle.value=p.shareTitle||'Save Loc'; renderCatList(); settingsModal.showModal(); };
    closeSettings.onclick = ()=> settingsModal.close();
    saveSettingsBtn.onclick = ()=>{ writePrefs({customTpl:customTpl.value.trim(), shareTitle:shareTitle.value.trim()}); toast('ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯'); settingsModal.close(); };
    testCustom.onclick = ()=>{
      const tpl=customTpl.value.trim(); if(!tpl){ toast('Ø§Ø¨ØªØ¯Ø§ Ù‚Ø§Ù„Ø¨ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
      const url=tpl.replaceAll('{lat}','35.6892').replaceAll('{lng}','51.3890').replaceAll('{name}',encodeURIComponent('Test'));
      window.location.href=url;
    };

    /* ========= Ù„ÛŒØ³Øª Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§ ========= */
    function renderList(){
      const q=(searchBox.value||'').toLowerCase().trim();
      const items=readPlaces().filter(p=>{
        const hay=(p.name||'')+' '+(p.address||'')+' '+(p.notes||'')+' '+(p.category?.name||'');
        return !q || hay.toLowerCase().includes(q);
      });
      listArea.innerHTML='';
      if(!items.length){ const d=document.createElement('div'); d.className='empty'; d.textContent='Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.'; listArea.appendChild(d); return; }

      items.forEach(p=>{
        const card=document.createElement('div'); card.className='place';
        const head=document.createElement('div'); head.className='place-h';
        const title=document.createElement('div'); title.className='place-title'; title.textContent=`${p.category?.icon||'ğŸ“Œ'} ${p.name}`;
        const sub=document.createElement('div'); sub.className='place-sub mono';
        sub.textContent=`${p.lat.toFixed(6)}, ${p.lng.toFixed(6)} â€¢ Â±${p.acc} Ù…ØªØ± â€¢ ${formatTs(p.ts)}`;
        head.append(title);
        const meta=document.createElement('div'); meta.appendChild(sub);
        if(p.address){ const a=document.createElement('div'); a.className='place-sub'; a.textContent='ğŸ“ '+p.address; meta.appendChild(a); }
        if(p.notes){ const n=document.createElement('div'); n.className='place-sub'; n.textContent='ğŸ“ '+p.notes; meta.appendChild(n); }

        const headerRow=document.createElement('div'); headerRow.style.display='flex'; headerRow.style.justifyContent='space-between'; headerRow.style.gap='10px';
        headerRow.append(head, meta);

        const actions=document.createElement('div'); actions.className='place-actions';
        const btn=(label,cls,fn)=>{ const b=document.createElement('button'); b.className='btn '+cls; b.textContent=label; b.onclick=fn; return b; };

        const previewBtn = btn('Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´','',()=>openPreview(p));
        const appleBtn = btn('Ø§Ù¾Ù„','',()=>window.open(appleLink(p.lat,p.lng,p.name),'_blank','noopener'));
        const googleBtn = btn('Ú¯ÙˆÚ¯Ù„','',()=>window.open(googleLink(p.lat,p.lng),'_blank','noopener'));
        const wazeBtn = btn('ÙˆÛŒØ²','',()=>window.open(wazeLink(p.lat,p.lng),'_blank','noopener'));
        const dirBtn = btn('Ù…Ø³ÛŒØ± Ø§Ù¾Ù„','',()=>window.open(appleDirections(p.lat,p.lng,p.address||p.name),'_blank','noopener'));
        const shareBtn2 = btn('Ø§Ø´ØªØ±Ø§Ú©','ghost',()=>sharePlace(p));
        const copyPair = btn('Ú©Ù¾ÛŒ Ø¹Ø±Ø¶ØŒØ·ÙˆÙ„','ghost',async()=>{ try{ await navigator.clipboard.writeText(`${p.lat},${p.lng}`); toast('Ú©Ù¾ÛŒ Ø´Ø¯'); }catch{ toast('Ú©Ù¾ÛŒ Ù†Ø§Ù…ÙˆÙÙ‚'); } });
        const editBtn = btn('ÙˆÛŒØ±Ø§ÛŒØ´','ghost',()=>{ openSaveModal(p,'edit'); });
        const delBtn = btn('Ø­Ø°Ù','danger',()=>{ if(confirm('Ø§ÛŒÙ† Ù…Ú©Ø§Ù† Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')){ remove(p.id); renderList(); toast('Ø­Ø°Ù Ø´Ø¯'); } });

        actions.append(previewBtn, appleBtn, googleBtn, wazeBtn, dirBtn, shareBtn2, copyPair, editBtn, delBtn);

        card.append(headerRow, actions);
        card.addEventListener('click', (e)=>{ if(e.target.closest('.btn')) return; card.classList.toggle('open'); });
        listArea.appendChild(card);
      });
    }

    async function sharePlace(p){
      const prefs=readPrefs(); const url=googleLink(p.lat,p.lng);
      const text=`${p.name} â€” ${p.lat.toFixed(6)},${p.lng.toFixed(6)} (Â±${p.acc} Ù…ØªØ±)${p.address? '\n'+p.address:''}${p.notes? '\nğŸ“ '+p.notes:''}`;
      if(navigator.share){ try{ await navigator.share({title:prefs.shareTitle||'Save Loc', text, url}); }catch{} }
      else{ try{ await navigator.clipboard.writeText(`${text}\n${url}`); toast('Ø¯Ø± Ú©Ù„ÛŒÙ¾â€ŒØ¨ÙˆØ±Ø¯ Ù‚Ø±Ø§Ø± Ú¯Ø±ÙØª'); }catch{ toast('Ù†Ø§Ù…ÙˆÙÙ‚'); } }
    }
    function update(id,patch){ const arr=readPlaces(); const i=arr.findIndex(x=>x.id===id); if(i>-1){ arr[i]={...arr[i],...patch}; writePlaces(arr); } }
    function remove(id){ writePlaces(readPlaces().filter(x=>x.id!==id)); }
    searchBox.addEventListener('input', renderList);

    /* ========= Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ (Leaflet) ========= */
    let preview=null, previewMarker=null;
    function openPreview(p){
      previewModal.showModal();
      setTimeout(()=>{
        if(!preview){
          preview=L.map(previewMapEl,{zoomControl:true, attributionControl:false});
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(preview);
        }
        preview.setView([p.lat,p.lng],16);
        if(previewMarker) preview.removeLayer(previewMarker);
        previewMarker=L.marker([p.lat,p.lng]).addTo(preview);
        preview.invalidateSize();
      },20);
      previewTitle.textContent = `${p.category?.icon||'ğŸ“Œ'} ${p.name}`;
      previewAddr.textContent = p.address || 'â€”';
      pvApple.onclick = ()=>window.open(appleLink(p.lat,p.lng,p.name),'_blank','noopener');
      pvGoogle.onclick = ()=>window.open(googleLink(p.lat,p.lng),'_blank','noopener');
      pvWaze.onclick = ()=>window.open(wazeLink(p.lat,p.lng),'_blank','noopener');
      pvDir.onclick = ()=>window.open(appleDirections(p.lat,p.lng,p.address||p.name),'_blank','noopener');
      pvShare.onclick = ()=>sharePlace(p);
      if(!p.address){ reverseGeocode(p.lat,p.lng).then(addr=>{ if(addr){ p.address=addr; update(p.id,{address:addr}); previewAddr.textContent=addr; renderList(); } }); }
    }
    closePreview.onclick = ()=> previewModal.close();

    /* ========= Ø®Ø±ÙˆØ¬ÛŒ/ÙˆØ±ÙˆØ¯ÛŒ Ùˆ Ù¾Ø´ØªÛŒØ¨Ø§Ù† ========= */
    exportBtn.onclick = ()=> downloadBlob(JSON.stringify(readPlaces(),null,2),'application/json','saveloc-places.json');
    importBtn.onclick = ()=> importFile.click();
    importFile.onchange = ()=>{
      const f=importFile.files[0]; if(!f) return;
      const fr=new FileReader(); fr.onload=()=>{
        try{ const arr=JSON.parse(fr.result); if(!Array.isArray(arr)) throw 0;
          const cur=readPlaces(); const map=new Map(cur.map(x=>[x.id,x])); for(const p of arr){ if(p&&p.id){ map.set(p.id,{...map.get(p.id),...p}); } }
          writePlaces([...map.values()].sort((a,b)=>b.ts-a.ts)); renderList(); toast('ÙˆØ±ÙˆØ¯ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯');
        }catch{ toast('ÙˆØ±ÙˆØ¯ Ù†Ø§Ù…ÙˆÙÙ‚'); }
        importFile.value='';
      }; fr.readAsText(f);
    };

    backupBtn.onclick = ()=>{
      const backup={places:readPlaces(),categories:readCats(),prefs:readPrefs(),version:1,saved_at:new Date().toISOString()};
      downloadBlob(JSON.stringify(backup,null,2),'application/json','saveloc-backup.json');
    };
    restoreBtn.onclick = ()=> restoreFile.click();
    restoreFile.onchange = ()=>{
      const f=restoreFile.files[0]; if(!f) return;
      const fr=new FileReader(); fr.onload=()=>{
        try{ const obj=JSON.parse(fr.result);
          if(!obj || !Array.isArray(obj.places) || !Array.isArray(obj.categories)) throw 0;
          writePlaces(obj.places||[]); writeCats(obj.categories||[]); if(obj.prefs) writePrefs(obj.prefs);
          renderList(); toast('Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯');
        }catch{ toast('Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ù†Ø§Ù…ÙˆÙÙ‚'); }
        restoreFile.value='';
      }; fr.readAsText(f);
    };

    clearAllBtn.onclick = ()=>{ if(confirm('Ù‡Ù…Ù‡Ù” Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§ Ø­Ø°Ù Ø´ÙˆÙ†Ø¯ØŸ')){ localStorage.removeItem(KEY); renderList(); toast('Ù¾Ø§Ú© Ø´Ø¯'); } };

    /* ========= Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ========= */
    function renderCatListInit(){ renderCatList(); }
    function renderCatChipsInit(){ renderCatChips(); }

    enableLive(false);
    renderList();

  </script>
</body>
</html>
