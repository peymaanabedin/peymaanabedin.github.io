<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
Â  <title>ÛŒØ§Ø¨Ù†Ø¯Ù‡ Ø¢Ø³Ù…Ø§Ù†ÛŒ â€¢ Ù†Ø³Ø®Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„</title>
Â  <meta name="color-scheme" content="dark" />
Â  <meta name="theme-color" content="#0a0000" />
Â  <link rel="preconnect" href="https://fonts.googleapis.com" />
Â  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
Â  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet" />
Â  <style>
Â  Â  :root {
Â  Â  Â  /* Base palette */
Â  Â  Â  --bg-color-red: #090607;
Â  Â  Â  --card-color-red: rgba(26, 5, 5, 0.5);
Â  Â  Â  --text-color-red: #f0c0c0;
Â  Â  Â  --highlight-color-red: #ff4545;
Â  Â  Â  --accent-color-red: #ff7a57;
Â  Â  Â  --border-color-red: rgba(255, 74, 74, 0.22);
Â  Â  Â  --glow-color-red: rgba(255, 58, 58, 0.25);

Â  Â  Â  --bg-color-green: #020b05;
Â  Â  Â  --card-color-green: rgba(5, 26, 10, 0.5);
Â  Â  Â  --text-color-green: #c9f7d0;
Â  Â  Â  --highlight-color-green: #29ff5a;
Â  Â  Â  --accent-color-green: #57ff9a;
Â  Â  Â  --border-color-green: rgba(74, 255, 74, 0.22);
Â  Â  Â  --glow-color-green: rgba(58, 255, 58, 0.25);

Â  Â  Â  --radius-xl: 20px;
Â  Â  Â  --radius-lg: 14px;
Â  Â  Â  --radius-md: 10px;
Â  Â  Â  --shadow-1: 0 8px 30px rgba(0, 0, 0, 0.5);
Â  Â  Â  --shadow-2: 0 2px 10px rgba(0, 0, 0, 0.35);
Â  Â  Â  --focus: 0 0 0 3px rgba(255, 113, 113, 0.5);

Â  Â  Â  --safe-top: env(safe-area-inset-top);
Â  Â  Â  --safe-bottom: env(safe-area-inset-bottom);
Â  Â  }

Â  Â  html, body {
Â  Â  Â  height: 100%;
Â  Â  Â  background: var(--bg-color-red);
Â  Â  }

Â  Â  body {
Â  Â  Â  font-family: "Vazirmatn", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
Â  Â  Â  color: var(--text-color-red);
Â  Â  Â  margin: 0;
Â  Â  Â  -webkit-tap-highlight-color: transparent;
Â  Â  Â  padding: calc(16px + var(--safe-top)) 12px calc(18px + var(--safe-bottom));
Â  Â  Â  display: grid;
Â  Â  Â  place-items: center;
Â  Â  Â  background-image: radial-gradient(circle, var(--card-color-red) 1px, transparent 1px);
Â  Â  Â  background-size: 28px 28px;
Â  Â  Â  transition: background-color 0.6s ease;
Â  Â  }

Â  Â  .container {
Â  Â  Â  width: 100%;
Â  Â  Â  max-width: 560px;
Â  Â  Â  display: grid;
Â  Â  Â  gap: 14px;
Â  Â  Â  animation: fadeIn 800ms ease;
Â  Â  }

Â  Â  @keyframes fadeIn { from { opacity: 0; translate: 0 8px; } to { opacity: 1; translate: 0 0; } }

Â  Â  /* Aligned state (success theme) */
Â  Â  body.aligned { background-color: var(--bg-color-green); background-image: radial-gradient(circle, var(--card-color-green) 1px, transparent 1px); }
Â  Â  body.aligned .card { background-color: var(--card-color-green); border-color: var(--border-color-green); box-shadow: 0 0 38px var(--glow-color-green); }
Â  Â  body.aligned h1, body.aligned h2 { color: var(--highlight-color-green); text-shadow: 0 0 10px var(--glow-color-green); }
Â  Â  body.aligned .status { background: var(--highlight-color-green); color: #001b08; }
Â  Â  body.aligned .chip, body.aligned select { border-color: var(--border-color-green); }
Â  Â  body.aligned .meter .bar { background: var(--border-color-green); }
Â  Â  body.aligned .meter .fill { background: var(--highlight-color-green); }

Â  Â  h1 {
Â  Â  Â  font-size: clamp(20px, 4.8vw, 28px);
Â  Â  Â  margin: 0 0 6px;
Â  Â  Â  text-align: center;
Â  Â  Â  color: var(--highlight-color-red);
Â  Â  Â  text-shadow: 0 0 10px var(--glow-color-red);
Â  Â  }
Â  Â  h2 {
Â  Â  Â  font-size: clamp(16px, 4.2vw, 22px);
Â  Â  Â  margin: 0 0 10px;
Â  Â  Â  color: var(--highlight-color-red);
Â  Â  }

Â  Â  .card {
Â  Â  Â  background: var(--card-color-red);
Â  Â  Â  border: 1px solid var(--border-color-red);
Â  Â  Â  border-radius: var(--radius-xl);
Â  Â  Â  padding: 18px 16px;
Â  Â  Â  box-shadow: var(--shadow-1);
Â  Â  Â  backdrop-filter: blur(10px);
Â  Â  }

Â  Â  .status {
Â  Â  Â  display: grid;
Â  Â  Â  place-items: center;
Â  Â  Â  padding: 14px 16px;
Â  Â  Â  border-radius: var(--radius-lg);
Â  Â  Â  background: var(--highlight-color-red);
Â  Â  Â  color: #160606;
Â  Â  Â  font-weight: 700;
Â  Â  Â  box-shadow: var(--shadow-2);
Â  Â  Â  min-height: 44px;
Â  Â  }

Â  Â  .cta {
Â  Â  Â  display: grid;
Â  Â  Â  gap: 10px;
Â  Â  Â  padding: 8px 0 0;
Â  Â  Â  text-align: center;
Â  Â  }

Â  Â  .btn {
Â  Â  Â  appearance: none;
Â  Â  Â  border: 0;
Â  Â  Â  width: 100%;
Â  Â  Â  height: 48px;
Â  Â  Â  border-radius: 999px;
Â  Â  Â  font-weight: 800;
Â  Â  Â  font-size: 16px;
Â  Â  Â  background: var(--highlight-color-red);
Â  Â  Â  color: #1b0a0a;
Â  Â  Â  box-shadow: 0 6px 18px rgba(255, 58, 58, 0.32);
Â  Â  Â  transition: transform 120ms ease, box-shadow 180ms ease, opacity 140ms ease;
Â  Â  }
Â  Â  .btn:active { transform: translateY(1px) scale(0.99); }
Â  Â  .btn:focus-visible { outline: none; box-shadow: var(--focus); }

Â  Â  .row { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 10px; padding: 6px 0; }
Â  Â  .kv { font-size: 14px; opacity: 0.9; }
Â  Â  .kv strong { font-size: 15px; color: var(--text-color-red); }

Â  Â  .select {
Â  Â  Â  margin-top: 10px;
Â  Â  }
Â  Â  select {
Â  Â  Â  width: 100%; height: 48px; padding: 0 44px 0 14px;
Â  Â  Â  color: var(--text-color-red);
Â  Â  Â  background: rgba(255,255,255,0.06);
Â  Â  Â  border: 1px solid var(--border-color-red);
Â  Â  Â  border-radius: var(--radius-md);
Â  Â  Â  backdrop-filter: blur(6px);
Â  Â  Â  font-size: 15px;
Â  Â  }
Â  Â  select:focus-visible { outline: none; box-shadow: var(--focus); }

Â  Â  .chips { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
Â  Â  .chip {
Â  Â  Â  background: rgba(255,255,255,0.06);
Â  Â  Â  border: 1px solid var(--border-color-red);
Â  Â  Â  border-radius: 12px;
Â  Â  Â  padding: 10px 12px;
Â  Â  Â  display: grid; gap: 2px;
Â  Â  Â  text-align: center;
Â  Â  }
Â  Â  .chip b { font-size: 13px; opacity: 0.85; }
Â  Â  .chip .val { font-size: 22px; font-weight: 800; }

Â  Â  .meter { display: grid; grid-template-columns: auto 1fr auto; gap: 10px; align-items: center; margin-top: 10px; }
Â  Â  .meter .label { font-size: 14px; white-space: nowrap; opacity: 0.85; }
Â  Â  .meter .bar { height: 10px; border-radius: 6px; background: var(--border-color-red); overflow: hidden; }
Â  Â  .meter .fill { height: 100%; width: 0%; background: var(--highlight-color-red); transition: width 200ms linear; }
Â  Â  .meter .sub { font-size: 12px; opacity: 0.8; }

Â  Â  .compass-wrap { position: relative; aspect-ratio: 1 / 1; width: 100%; margin: 14px 0; }
Â  Â  .compass {
Â  Â  Â  position: absolute; inset: 0; border-radius: 50%; border: 2px solid var(--highlight-color-red);
Â  Â  Â  background: conic-gradient(#0f3a0f 0deg, #0f3a0f 1deg, transparent 1deg, transparent 9deg);
Â  Â  Â  background-size: 10% 100%;
Â  Â  Â  display: grid; place-items: center; box-shadow: inset 0 0 12px rgba(0,0,0,0.5);
Â  Â  Â  transition: transform 160ms linear;
Â  Â  }
Â  Â  .compass::before, .compass::after { content: ""; position: absolute; width: 4px; height: 50%; left: 50%; transform: translateX(-50%); transform-origin: bottom; }
Â  Â  .compass::before { top: 0; background: var(--accent-color-red); }
Â  Â  .compass::after { bottom: 0; background: var(--text-color-red); }

Â  Â  .labels span { position: absolute; font-weight: 800; font-size: clamp(18px, 5vw, 22px); text-shadow: 0 0 5px rgba(0,0,0,0.55); }
Â  Â  .labels .n { top: 8px; right: 50%; translate: 50% 0; color: var(--accent-color-red); }
Â  Â  .labels .s { bottom: 8px; right: 50%; translate: 50% 0; }
Â  Â  .labels .e { right: 8px; top: 50%; translate: 0 -50%; }
Â  Â  .labels .w { left: 8px; top: 50%; translate: 0 -50%; }

Â  Â  .list { list-style: none; margin: 0; padding: 0; display: grid; gap: 8px; }
Â  Â  .item { border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.06); border-radius: 12px; padding: 12px; }
Â  Â  .item h4 { margin: 0 0 6px; font-size: 15px; }
Â  Â  .meta { display: flex; gap: 10px; font-size: 13px; opacity: 0.9; }
Â  Â  .note { margin-top: 6px; font-size: 12px; font-weight: 700; }
Â  Â  .visible { color: var(--highlight-color-green); }
Â  Â  .not-visible { color: var(--accent-color-red); }

Â  Â  /* Reduced motion */
Â  Â  @media (prefers-reduced-motion: reduce) {
Â  Â  Â  .compass, .fill { transition: none; }
Â  Â  }
Â  </style>
</head>
<body>
Â  <div class="container">
Â  Â  <h1>ÛŒØ§Ø¨Ù†Ø¯Ù‡ Ø¢Ø³Ù…Ø§Ù†ÛŒ ğŸ”­</h1>
Â  Â  <div id="status" class="status">Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ Ø§Ø¬Ø§Ø²Ù‡Ù” Ø­Ø³Ú¯Ø±/Ù…ÙˆÙ‚Ø¹ÛŒØª Ø±Ø§ Ø¨Ø¯Ù‡ÛŒØ¯.</div>

Â  Â  <div id="permission-cta" class="cta">
Â  Â  Â  <button id="btn-perm" class="btn">ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø­Ø³Ú¯Ø±Ù‡Ø§</button>
Â  Â  Â  <small style="opacity:.8">Ø¨Ù‡ØªØ± Ø§Ø³Øª ØµÙØ­Ù‡ Ø±ÙˆÛŒ HTTPS Ø¨Ø§Ø´Ø¯.</small>
Â  Â  </div>

Â  Â  <section id="app" style="display:none;" aria-live="polite">
Â  Â  Â  <div class="card">
Â  Â  Â  Â  <h2>Ù…ÙˆÙ‚Ø¹ÛŒØª Ø´Ù…Ø§</h2>
Â  Â  Â  Â  <div class="row"><div class="kv">Ø¹Ø±Ø¶ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ</div><div class="kv"><strong id="lat">--</strong></div></div>
Â  Â  Â  Â  <div class="row"><div class="kv">Ø·ÙˆÙ„ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ</div><div class="kv"><strong id="lon">--</strong></div></div>
Â  Â  Â  </div>

Â  Â  Â  <div class="card">
Â  Â  Â  Â  <h2>Ù‚Ø·Ø¨â€ŒÙ†Ù…Ø§ÛŒ Ø²Ù†Ø¯Ù‡</h2>
Â  Â  Â  Â  <div class="compass-wrap">
Â  Â  Â  Â  Â  <div id="compass" class="compass"></div>
Â  Â  Â  Â  Â  <div class="labels">
Â  Â  Â  Â  Â  Â  <span class="n">Ø´</span>
Â  Â  Â  Â  Â  Â  <span class="e">Ø®</span>
Â  Â  Â  Â  Â  Â  <span class="w">Øº</span>
Â  Â  Â  Â  Â  Â  <span class="s">Ø¬</span>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="row" style="grid-template-columns: 1fr auto;">
Â  Â  Â  Â  Â  <div class="kv">Ø¬Ù‡Øª ÙØ¹Ù„ÛŒ</div>
Â  Â  Â  Â  Â  <div class="kv"><strong id="headingText">--</strong></div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="card">
Â  Â  Â  Â  <h2>ÛŒØ§Ø¨Ù†Ø¯Ù‡Ù” Ø§Ø¬Ø±Ø§Ù…</h2>
Â  Â  Â  Â  <div class="select">
Â  Â  Â  Â  Â  <label for="sel" class="kv" style="display:block; margin-bottom:6px">Ø§Ù†ØªØ®Ø§Ø¨ Ø¬Ø±Ù…</label>
Â  Â  Â  Â  Â  <select id="sel">
Â  Â  Â  Â  Â  Â  <option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ --</option>
Â  Â  Â  Â  Â  Â  <optgroup label="Ø³ÛŒØ§Ø±Ø§Øª Ùˆ Ù…Ø§Ù‡">
Â  Â  Â  Â  Â  Â  Â  <option value="moon">Ù…Ø§Ù‡</option>
Â  Â  Â  Â  Â  Â  Â  <option value="mercury">Ø¹Ø·Ø§Ø±Ø¯</option>
Â  Â  Â  Â  Â  Â  Â  <option value="venus">Ø²Ù‡Ø±Ù‡</option>
Â  Â  Â  Â  Â  Â  Â  <option value="mars">Ù…Ø±ÛŒØ®</option>
Â  Â  Â  Â  Â  Â  Â  <option value="jupiter">Ù…Ø´ØªØ±ÛŒ</option>
Â  Â  Â  Â  Â  Â  Â  <option value="saturn">Ø²Ø­Ù„</option>
Â  Â  Â  Â  Â  Â  </optgroup>
Â  Â  Â  Â  Â  Â  <optgroup label="Ø³ØªØ§Ø±Ù‡â€ŒÙ‡Ø§ Ùˆ Ø³Ø­Ø§Ø¨ÛŒâ€ŒÙ‡Ø§">
Â  Â  Â  Â  Â  Â  Â  <option value="sirius">Ø´Ø¨Ø§Ù‡Ù†Ú¯ (Sirius)</option>
Â  Â  Â  Â  Â  Â  Â  <option value="canopus">Ø³Ù‡ÛŒÙ„ (Canopus)</option>
Â  Â  Â  Â  Â  Â  Â  <option value="polaris">Ø³ØªØ§Ø±Ù‡ Ù‚Ø·Ø¨ÛŒ (Polaris)</option>
Â  Â  Â  Â  Â  Â  Â  <option value="andromeda">Ú©Ù‡Ú©Ø´Ø§Ù† Ø¢Ù†Ø¯Ø±ÙˆÙ…Ø¯Ø§ (M31)</option>
Â  Â  Â  Â  Â  Â  Â  <option value="orion_nebula">Ø³Ø­Ø§Ø¨ÛŒ Ø¬Ø¨Ø§Ø± (M42)</option>
Â  Â  Â  Â  Â  Â  </optgroup>
Â  Â  Â  Â  Â  Â  <optgroup label="Ù…Ø§Ù‡ÙˆØ§Ø±Ù‡â€ŒÙ‡Ø§ (Ø¨Ù‡â€ŒØ²ÙˆØ¯ÛŒ)">
Â  Â  Â  Â  Â  Â  Â  <option disabled>ISS</option>
Â  Â  Â  Â  Â  Â  Â  <option disabled>Starlink</option>
Â  Â  Â  Â  Â  Â  </optgroup>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="chips">
Â  Â  Â  Â  Â  <div class="chip"><b>Ø³Ù…Øª Ù‡Ø¯Ù</b><div id="azVal" class="val">--</div></div>
Â  Â  Â  Â  Â  <div class="chip"><b>Ø§Ø±ØªÙØ§Ø¹ Ù‡Ø¯Ù</b><div id="elVal" class="val">--</div></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="meters" style="margin-top:10px">
Â  Â  Â  Â  Â  <div id="mAz" class="meter" style="display:none;">
Â  Â  Â  Â  Â  Â  <div class="label">Ø³Ù…Øª</div>
Â  Â  Â  Â  Â  Â  <div class="bar"><div id="azFill" class="fill"></div></div>
Â  Â  Â  Â  Â  Â  <div id="azSub" class="sub"></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div id="mEl" class="meter" style="display:none;">
Â  Â  Â  Â  Â  Â  <div class="label">Ø´ÛŒØ¨</div>
Â  Â  Â  Â  Â  Â  <div class="bar"><div id="elFill" class="fill"></div></div>
Â  Â  Â  Â  Â  Â  <div id="elSub" class="sub"></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <p id="note" class="note"></p>
Â  Â  Â  Â  <div id="callout" class="status" style="margin-top:10px">ÛŒÚ© Ø¬Ø±Ù… Ø¢Ø³Ù…Ø§Ù†ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</div>
Â  Â  Â  </div>

      <div class="card">
        <h2>Ù†Ù…ÙˆØ¯Ø§Ø± Ø¢Ø³Ù…Ø§Ù† Ø²Ù†Ø¯Ù‡</h2>
        <canvas id="sky-chart" style="width: 100%; aspect-ratio: 1 / 1; border-radius: var(--radius-md); margin-top: 10px;"></canvas>
      </div>

Â  Â  Â  <div class="card">
Â  Â  Â  Â  <h2>Ø§Ø¬Ø±Ø§Ù… Ù†Ø²Ø¯ÛŒÚ© Ø¯ÛŒØ¯ Ø´Ù…Ø§</h2>
Â  Â  Â  Â  <ul id="list" class="list">
Â  Â  Â  Â  Â  <li class="item" style="opacity:.7">Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬Ùˆâ€¦</li>
Â  Â  Â  Â  </ul>
Â  Â  Â  </div>
Â  Â  </section>
Â  </div>

Â  Â  <script src="https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js"></script>
Â  <script>
Â  Â  (function(){
Â  Â  Â  const $ = (id) => document.getElementById(id);

Â  Â  Â  // UI refs
Â  Â  Â  const statusEl = $("status");
Â  Â  Â  const permBtn = $("btn-perm");
Â  Â  Â  const permCta = $("permission-cta");
Â  Â  Â  const app = $("app");
Â  Â  Â  const latEl = $("lat");
Â  Â  Â  const lonEl = $("lon");
Â  Â  Â  const compassEl = $("compass");
Â  Â  Â  const headingText = $("headingText");
Â  Â  Â  const sel = $("sel");
Â  Â  Â  const azVal = $("azVal");
Â  Â  Â  const elVal = $("elVal");
Â  Â  Â  const mAz = $("mAz");
Â  Â  Â  const mEl = $("mEl");
Â  Â  Â  const azFill = $("azFill");
Â  Â  Â  const elFill = $("elFill");
Â  Â  Â  const azSub = $("azSub");
Â  Â  Â  const elSub = $("elSub");
Â  Â  Â  const callout = $("callout");
Â  Â  Â  const list = $("list");
Â  Â  Â  const note = $("note");
      const skyChartCanvas = $("sky-chart");
      const skyChartCtx = skyChartCanvas.getContext("2d");

Â  Â  Â  const BODY = Astronomy.Body;
Â  Â  Â  const BODY_MAP = { moon: BODY.Moon, mercury: BODY.Mercury, venus: BODY.Venus, mars: BODY.Mars, jupiter: BODY.Jupiter, saturn: BODY.Saturn, sun: BODY.Sun };

Â  Â  Â  const SKY = {
Â  Â  Â  Â  sun:{name:'Ø®ÙˆØ±Ø´ÛŒØ¯',type:'planet',body:'sun',visibility:'naked_eye'},
Â  Â  Â  Â  moon:{name:'Ù…Ø§Ù‡',type:'planet',body:'moon',visibility:'naked_eye'},
Â  Â  Â  Â  mercury:{name:'Ø¹Ø·Ø§Ø±Ø¯',type:'planet',body:'mercury',visibility:'naked_eye'},
Â  Â  Â  Â  venus:{name:'Ø²Ù‡Ø±Ù‡',type:'planet',body:'venus',visibility:'naked_eye'},
Â  Â  Â  Â  mars:{name:'Ù…Ø±ÛŒØ®',type:'planet',body:'mars',visibility:'naked_eye'},
Â  Â  Â  Â  jupiter:{name:'Ù…Ø´ØªØ±ÛŒ',type:'planet',body:'jupiter',visibility:'naked_eye'},
Â  Â  Â  Â  saturn:{name:'Ø²Ø­Ù„',type:'planet',body:'saturn',visibility:'naked_eye'},
Â  Â  Â  Â  sirius:{name:'Ø´Ø¨Ø§Ù‡Ù†Ú¯ (Sirius)',type:'star',starId:'Sirius',visibility:'naked_eye'},
Â  Â  Â  Â  canopus:{name:'Ø³Ù‡ÛŒÙ„ (Canopus)',type:'star',starId:'Canopus',visibility:'naked_eye'},
Â  Â  Â  Â  polaris:{name:'Ø³ØªØ§Ø±Ù‡ Ù‚Ø·Ø¨ÛŒ (Polaris)',type:'star',starId:'Polaris',visibility:'naked_eye'},
Â  Â  Â  Â  andromeda:{name:'Ú©Ù‡Ú©Ø´Ø§Ù† Ø¢Ù†Ø¯Ø±ÙˆÙ…Ø¯Ø§ (M31)',type:'dso',dsoId:'M31',visibility:'naked_eye'},
Â  Â  Â  Â  orion_nebula:{name:'Ø³Ø­Ø§Ø¨ÛŒ Ø¬Ø¨Ø§Ø± (M42)',type:'dso',dsoId:'M42',visibility:'naked_eye'}
Â  Â  Â  };

Â  Â  Â  // State
Â  Â  Â  let userLat = null, userLon = null;
Â  Â  Â  let heading = 0;Â  Â  // 0..360 (Ø´Ù…Ø§Ù„)
Â  Â  Â  let pitch = 0;Â  Â  Â  // -90..+90 ØªÙ‚Ø±ÛŒØ¨ÛŒ
Â  Â  Â  let observer = null;
Â  Â  Â  let selected = null;
Â  Â  Â  let targetAz = null, targetEl = null;
Â  Â  Â  let vibrated = false;
Â  Â  Â  let throttler = null;
      let chartThrottler = null;

Â  Â  Â  // Helpers
Â  Â  Â  const show = (el) => el.style.display = '';
Â  Â  Â  const hide = (el) => el.style.display = 'none';
Â  Â  Â  const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
Â  Â  Â  const ndeg = (x) => (x % 360 + 360) % 360;
Â  Â  Â  const sdiff = (a, b) => { let d = ndeg(a - b); if (d > 180) d -= 360; return d; };
Â  Â  Â  const setStatus = (msg, ms=2500) => { statusEl.textContent = msg; statusEl.style.display = 'grid'; if (ms>0) { clearTimeout(setStatus._t); setStatus._t = setTimeout(()=>statusEl.style.display='none', ms); } };

Â  Â  Â  // Permissions
Â  Â  Â  permBtn.addEventListener('click', async () => {
Â  Â  Â  Â  setStatus('Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…Ø¬ÙˆØ²Ù‡Ø§â€¦', 0);
Â  Â  Â  Â  const DOE = window.DeviceOrientationEvent;
Â  Â  Â  Â  const canReq = !!(DOE && typeof DOE.requestPermission === 'function');
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  if (canReq) {
Â  Â  Â  Â  Â  Â  const state = await DOE.requestPermission();
Â  Â  Â  Â  Â  Â  if (state !== 'granted') throw new Error('motion-permission-denied');
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  setupSensors();
Â  Â  Â  Â  Â  startGeo();
Â  Â  Â  Â  Â  app.style.display = '';
Â  Â  Â  Â  Â  permCta.style.display = 'none';
Â  Â  Â  Â  Â  setStatus('Ù…Ø¬ÙˆØ² Ø­Ø³Ú¯Ø±/Ù…ÙˆÙ‚Ø¹ÛŒØª ÙØ¹Ø§Ù„ Ø´Ø¯.');
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  Â  setStatus('Ù…Ø¬ÙˆØ² Ø­Ø³Ú¯Ø± Ø±Ø¯ Ø´Ø¯. Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.');
Â  Â  Â  Â  Â  permCta.style.display = '';
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  function setupSensors(){
Â  Â  Â  Â  if ('ondeviceorientation' in window) {
Â  Â  Â  Â  Â  window.addEventListener('deviceorientation', onOrientation, { passive: true });
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  setStatus('Ø§ÛŒÙ† Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø­Ø³Ú¯Ø± Ø¬Ù‡Øªâ€ŒÚ¯ÛŒØ±ÛŒ Ù†Ø¯Ø§Ø±Ø¯.');
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  function onOrientation(e){
Â  Â  Â  Â  let h = e.webkitCompassHeading;
Â  Â  Â  Â  if (h == null && typeof e.alpha === 'number') h = e.absolute ? e.alpha : (360 - e.alpha);
Â  Â  Â  Â  const ang = (screen.orientation && typeof screen.orientation.angle === 'number') ? screen.orientation.angle : 0;
Â  Â  Â  Â  if (ang === 90) h += 90; else if (ang === 180) h += 180; else if (ang === 270) h -= 90;
Â  Â  Â  Â  heading = ndeg(h || 0);
Â  Â  Â  Â  pitch = clamp(typeof e.beta === 'number' ? e.beta : 0, -90, 90);

Â  Â  Â  Â  compassEl.style.transform = `rotate(${-heading}deg)`;
Â  Â  Â  Â  headingText.textContent = `${heading.toFixed(0)}Â°`;

Â  Â  Â  Â  updateGuidance();

        if (!chartThrottler) {
          chartThrottler = setTimeout(() => {
            if (observer) drawSkyChart();
            chartThrottler = null;
          }, 150);
        }

Â  Â  Â  Â  if (!throttler) {
Â  Â  Â  Â  Â  throttler = setTimeout(()=>{ updateNearby(); throttler = null; }, 900);
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  function startGeo(){
Â  Â  Â  Â  if (!navigator.geolocation) { setStatus('Ù…ÙˆÙ‚Ø¹ÛŒØªâ€ŒÛŒØ§Ø¨ÛŒ Ø¯Ø± Ø§ÛŒÙ† Ù…Ø±ÙˆØ±Ú¯Ø± Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯.'); return; }
Â  Â  Â  Â  navigator.geolocation.watchPosition(pos => {
Â  Â  Â  Â  Â  userLat = pos.coords.latitude; userLon = pos.coords.longitude;
Â  Â  Â  Â  Â  latEl.textContent = userLat.toFixed(4); lonEl.textContent = userLon.toFixed(4);
Â  Â  Â  Â  Â  observer = new Astronomy.Observer(userLat, userLon, 0);
Â  Â  Â  Â  Â  updateTarget();
Â  Â  Â  Â  Â  updateNearby();
          drawSkyChart();
Â  Â  Â  Â  }, err => {
Â  Â  Â  Â  Â  let msg = 'Ø®Ø·Ø§ÛŒ Ù…ÙˆÙ‚Ø¹ÛŒØªâ€ŒÛŒØ§Ø¨ÛŒ: ' + err.message;
Â  Â  Â  Â  Â  if (location.protocol === 'http:') msg += ' Â· Ø¨Ø³ÛŒØ§Ø±ÛŒ Ø§Ø² Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ Ø¨Ù‡ HTTPS Ù†ÛŒØ§Ø² Ø¯Ø§Ø±Ù†Ø¯';
Â  Â  Â  Â  Â  setStatus(msg, 5000);
Â  Â  Â  Â  Â  console.error(err);
Â  Â  Â  Â  }, { enableHighAccuracy: true, timeout: 9000, maximumAge: 0 });
Â  Â  Â  }

Â  Â  Â  sel.addEventListener('change', () => {
Â  Â  Â  Â  const id = sel.value; selected = id ? { ...SKY[id], id } : null; updateTarget();
Â  Â  Â  });

Â  Â  Â  function updateTarget(){
Â  Â  Â  Â  if (!observer || !selected) { resetGuidance(); return; }
Â  Â  Â  Â  const now = new Date();
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  let ra, dec;
Â  Â  Â  Â  Â  if (selected.type === 'planet') {
Â  Â  Â  Â  Â  Â  const equ = Astronomy.Equator(BODY_MAP[selected.body], now, observer, true, true);
Â  Â  Â  Â  Â  Â  ra = equ.ra; dec = equ.dec;
Â  Â  Â  Â  Â  } else if (selected.type === 'star') {
Â  Â  Â  Â  Â  Â  const s = Astronomy.Star(selected.starId); ra = s.ra; dec = s.dec;
Â  Â  Â  Â  Â  } else if (selected.type === 'dso') {
Â  Â  Â  Â  Â  Â  const d = Astronomy.Dso(selected.dsoId); ra = d.ra; dec = d.dec;
Â  Â  Â  Â  Â  } else { // satellites disabled in this stable build
Â  Â  Â  Â  Â  Â  setStatus('Ø¯Ø§Ø¯Ù‡Ù” Ù…Ø§Ù‡ÙˆØ§Ø±Ù‡ ÙØ¹Ù„Ø§Ù‹ ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª.'); resetGuidance(); return;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  const hor = Astronomy.Horizon(now, observer, ra, dec, 'normal');
Â  Â  Â  Â  Â  targetAz = ndeg(hor.azimuth); targetEl = hor.altitude;
Â  Â  Â  Â  Â  azVal.textContent = `${targetAz.toFixed(0)}Â°`; elVal.textContent = `${targetEl.toFixed(0)}Â°`;

Â  Â  Â  Â  Â  if (targetEl <= 0) {
Â  Â  Â  Â  Â  Â  callout.textContent = 'Ø¬Ø±Ù… Ø§Ù†ØªØ®Ø§Ø¨ÛŒ Ø²ÛŒØ± Ø§ÙÙ‚ Ø§Ø³Øª.'; hide(mAz); hide(mEl); note.textContent = '';
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  callout.textContent = 'Ø¨Ø§ Ø³Ù…Øª Ùˆ Ø´ÛŒØ¨ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ Ø´ÙˆÛŒØ¯.';
Â  Â  Â  Â  Â  Â  updateGuidance();
Â  Â  Â  Â  Â  Â  note.textContent = selected.visibility === 'naked_eye' ? 'ğŸ‘€ Ù‚Ø§Ø¨Ù„ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¨Ø§ Ú†Ø´Ù… ØºÛŒØ±Ù…Ø³Ù„Ø­' : 'ğŸ”­ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø§Ø¨Ø²Ø§Ø± Ø§Ù¾ØªÛŒÚ©ÛŒ';
Â  Â  Â  Â  Â  Â  note.className = 'note ' + (selected.visibility === 'naked_eye' ? 'visible' : 'not-visible');
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  console.error(e); setStatus('Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡Ù” Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¬Ø±Ù….'); resetGuidance();
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  function resetGuidance(){
Â  Â  Â  Â  targetAz = targetEl = null; azVal.textContent = elVal.textContent = '--';
Â  Â  Â  Â  callout.textContent = 'ÛŒÚ© Ø¬Ø±Ù… Ø¢Ø³Ù…Ø§Ù†ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.'; hide(mAz); hide(mEl); note.textContent = '';
Â  Â  Â  Â  document.body.classList.remove('aligned'); vibrated = false;
Â  Â  Â  }

Â  Â  Â  function updateGuidance(){
Â  Â  Â  Â  if (targetAz == null || targetEl == null || targetEl <= 0) return;
Â  Â  Â  Â  const azTol = 5, elTol = 5;
Â  Â  Â  Â  const dAz = sdiff(targetAz, heading);Â  Â // >0: Ù‡Ø¯Ù Ø³Ù…Øª Ø±Ø§Ø³Øª
Â  Â  Â  Â  const dEl = targetEl - pitch;Â  Â  Â  Â  Â  Â // >0: Ø¨Ø§ÛŒØ¯ Ú¯ÙˆØ´ÛŒ Ø±Ø§ Ø¨Ø§Ù„Ø§ Ø¨Ø¨Ø±ÛŒ
Â  Â  Â  Â  const okAz = Math.abs(dAz) < azTol; const okEl = Math.abs(dEl) < elTol;
Â  Â  Â  Â  const aligned = okAz && okEl;

Â  Â  Â  Â  if (aligned) {
Â  Â  Â  Â  Â  document.body.classList.add('aligned'); callout.textContent = 'Ù‡Ù…â€ŒØ±Ø§Ø³ØªØ§ Ø´Ø¯!'; hide(mAz); hide(mEl);
Â  Â  Â  Â  Â  if ('vibrate' in navigator && !vibrated) { navigator.vibrate(180); vibrated = true; }
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  document.body.classList.remove('aligned'); vibrated = false; show(mAz); show(mEl);
Â  Â  Â  Â  const pAz = 100 - (Math.min(180, Math.abs(dAz)) / 180) * 100;
Â  Â  Â  Â  const pEl = 100 - (Math.min(90, Math.abs(dEl)) / 90) * 100;
Â  Â  Â  Â  azFill.style.width = `${pAz.toFixed(0)}%`; elFill.style.width = `${pEl.toFixed(0)}%`;
Â  Â  Â  Â  azSub.textContent = dAz > 0 ? 'Ø¨Ù‡ Ø±Ø§Ø³Øª Ø¨Ú†Ø±Ø®ÛŒØ¯' : 'Ø¨Ù‡ Ú†Ù¾ Ø¨Ú†Ø±Ø®ÛŒØ¯';
Â  Â  Â  Â  elSub.textContent = dEl > 0 ? 'Ø´ÛŒØ¨ Ø¨Ù‡ Ø¨Ø§Ù„Ø§' : 'Ø´ÛŒØ¨ Ø¨Ù‡ Ù¾Ø§ÛŒÛŒÙ†';
Â  Â  Â  }

      function drawSkyChart() {
          if (!observer) return;

          const canvas = skyChartCanvas;
          const rect = canvas.getBoundingClientRect();
          const dpr = window.devicePixelRatio || 1;
          canvas.width = rect.width * dpr;
          canvas.height = rect.height * dpr;
          const ctx = skyChartCtx;
          ctx.scale(dpr, dpr);

          const width = rect.width;
          const height = rect.height;
          const centerX = width / 2;
          const centerY = height / 2;
          const radius = Math.min(width, height) / 2 * 0.9;
          const now = new Date();

          ctx.fillStyle = 'rgba(10, 0, 0, 0.6)';
          ctx.fillRect(0, 0, width, height);
          ctx.beginPath();
          ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
          ctx.strokeStyle = 'rgba(255, 69, 69, 0.5)';
          ctx.lineWidth = 2;
          ctx.stroke();

          const cardinalPoints = { 'Ø´': 0, 'Ø®': 90, 'Ø¬': 180, 'Øº': 270 };
          ctx.font = 'bold 16px Vazirmatn';
          ctx.fillStyle = '#ff7a57'; // accent-color-red
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          for (const [label, angle] of Object.entries(cardinalPoints)) {
              const rad = (angle - 90) * Math.PI / 180;
              const x = centerX + (radius + 15) * Math.cos(rad);
              const y = centerY + (radius + 15) * Math.sin(rad);
              ctx.fillText(label, x, y);
          }

          const bodiesToDraw = ['sun', 'moon', 'mercury', 'venus', 'mars', 'jupiter', 'saturn'];
          const bodyColors = { moon: '#ffffff', sun: '#ffd700', 'default': '#f0c0c0' };
          ctx.font = '12px Vazirmatn';

          for (const id of bodiesToDraw) {
              const obj = SKY[id];
              if (!obj) continue;
              try {
                  const equ = Astronomy.Equator(BODY_MAP[obj.body], now, observer, true, true);
                  const hor = Astronomy.Horizon(now, observer, equ.ra, equ.dec, 'normal');
                  if (hor.altitude > 0) {
                      const alt_rad = (1 - hor.altitude / 90) * radius;
                      const az_rad = (hor.azimuth - 90) * Math.PI / 180;
                      const x = centerX + alt_rad * Math.cos(az_rad);
                      const y = centerY + alt_rad * Math.sin(az_rad);
                      
                      ctx.beginPath();
                      ctx.arc(x, y, id === 'sun' ? 4 : 3, 0, 2 * Math.PI);
                      ctx.fillStyle = bodyColors[id] || bodyColors.default;
                      ctx.fill();
                      
                      ctx.fillStyle = bodyColors[id] || bodyColors.default;
                      ctx.fillText(obj.name, x, y - 10);
                  }
              } catch (e) { /* ignore */ }
          }
          
          const view_alt_rad = (1 - (pitch / 90)) * radius;
          const view_az_rad = (heading - 90) * Math.PI / 180;
          const vx = centerX + view_alt_rad * Math.cos(view_az_rad);
          const vy = centerY + view_alt_rad * Math.sin(view_az_rad);
          
          ctx.strokeStyle = '#29ff5a'; // highlight-color-green
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.arc(vx, vy, 15, 0, 2 * Math.PI);
          ctx.stroke();
          
          const crosshairSize = 6;
          ctx.beginPath();
          ctx.moveTo(vx - crosshairSize, vy); ctx.lineTo(vx + crosshairSize, vy);
          ctx.moveTo(vx, vy - crosshairSize); ctx.lineTo(vx, vy + crosshairSize);
          ctx.stroke();
      }

Â  Â  Â  function addItem(o){
Â  Â  Â  Â  const li = document.createElement('li');
Â  Â  Â  Â  li.className = 'item';
Â  Â  Â  Â  li.innerHTML = `<h4>${o.name}</h4>
Â  Â  Â  Â  Â  <div class="meta"><span>Ø³Ù…Øª: ${o.az.toFixed(0)}Â°</span><span>Ø§Ø±ØªÙØ§Ø¹: ${o.el.toFixed(0)}Â°</span></div>
Â  Â  Â  Â  Â  <div class="note ${o.visibility==='naked_eye'?'visible':'not-visible'}">${o.visibility==='naked_eye'?'ğŸ‘€ Ø¨Ø§ Ú†Ø´Ù… ØºÛŒØ±Ù…Ø³Ù„Ø­':'ğŸ”­ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø§Ø¨Ø²Ø§Ø±'}</div>`;
Â  Â  Â  Â  li.addEventListener('click', () => { sel.value = o.id; selected = { ...SKY[o.id], id: o.id }; updateTarget(); window.scrollTo({top: 0, behavior: 'smooth'}); });
Â  Â  Â  Â  return li;
Â  Â  Â  }

Â  Â  Â  function updateNearby(){
Â  Â  Â  Â  if (!observer) return;
Â  Â  Â  Â  const now = new Date();
Â  Â  Â  Â  const ids = ['moon','mercury','venus','mars','jupiter','saturn','sirius','canopus','polaris','andromeda','orion_nebula'];
Â  Â  Â  Â  const items = [];
Â  Â  Â  Â  for (const id of ids){
Â  Â  Â  Â  Â  const obj = SKY[id];
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  let ra, dec;
Â  Â  Â  Â  Â  Â  if (obj.type === 'planet'){ const eq = Astronomy.Equator(BODY_MAP[obj.body], now, observer, true, true); ra = eq.ra; dec = eq.dec; }
Â  Â  Â  Â  Â  Â  else if (obj.type === 'star'){ const s = Astronomy.Star(obj.starId); ra = s.ra; dec = s.dec; }
Â  Â  Â  Â  Â  Â  else { const d = Astronomy.Dso(obj.dsoId); ra = d.ra; dec = d.dec; }
Â  Â  Â  Â  Â  Â  const hor = Astronomy.Horizon(now, observer, ra, dec, 'normal');
Â  Â  Â  Â  Â  Â  if (hor.altitude > 0){
Â  Â  Â  Â  Â  Â  Â  const dAz = sdiff(hor.azimuth, heading); const dEl = hor.altitude - pitch; const dist = Math.hypot(dAz, dEl);
Â  Â  Â  Â  Â  Â  Â  if (dist < 30) items.push({ id, name: obj.name, az: hor.azimuth, el: hor.altitude, visibility: obj.visibility, dist });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  } catch (e) { console.warn('nearby', id, e); }
Â  Â  Â  Â  }
Â  Â  Â  Â  items.sort((a,b)=>a.dist-b.dist);
Â  Â  Â  Â  list.innerHTML = '';
Â  Â  Â  Â  if (!items.length) { list.innerHTML = '<li class="item" style="opacity:.7">Ø¯Ø± Ù†Ø²Ø¯ÛŒÚ©ÛŒ Ø¯ÛŒØ¯ Ø´Ù…Ø§ Ú†ÛŒØ²ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</li>'; return; }
Â  Â  Â  Â  const frag = document.createDocumentFragment();
Â  Â  Â  Â  items.forEach(o => frag.appendChild(addItem(o)));
Â  Â  Â  Â  list.appendChild(frag);
Â  Â  Â  }

Â  Â  Â  // Auto hint for users without interaction (desktop)
Â  Â  Â  if (!('ontouchstart' in window)) setStatus('Ø§Ú¯Ø± Ø­Ø³Ú¯Ø± Ø¬Ù‡Øªâ€ŒÚ¯ÛŒØ±ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯ØŒ ÙÙ‚Ø· Â«Ù…ÙˆÙ‚Ø¹ÛŒØªÂ» Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯.');
Â  Â  })();
Â  </script>
</body>
</html>