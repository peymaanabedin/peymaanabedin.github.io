<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ÛŒØ§Ø¨Ù†Ø¯Ù‡ Ø¢Ø³Ù…Ø§Ù†ÛŒ â€“ Ù…ÙˆØ¨Ø§ÛŒÙ„</title>
  <meta name="theme-color" content="#0b0f17">
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { vazir: ['Vazirmatn','system-ui','sans-serif'] },
          colors: {
            ink: '#e8eefc', muted: '#aeb8d4',
            base: '#0b0f17', card: '#101623', accent: '#4ad6ff', ok:'#27d17c', warn:'#ffd166', danger:'#ff4a4a'
          },
          boxShadow:{ glass:'0 10px 30px rgba(0,0,0,.45)'}
        }
      }
    }
  </script>
  <style> html,body{height:100%} body{background:radial-gradient(1200px 800px at 50% -10%, #101623 0%, #0b0f17 60% 100%);} *{ -webkit-tap-highlight-color:transparent } </style>
</head>
<body class="font-vazir text-ink bg-base">
  <!-- Safe top -->
  <div class="px-4 pb-28 pt-[max(env(safe-area-inset-top),16px)] max-w-md mx-auto">

    <!-- Header -->
    <header class="sticky top-0 z-20 -mx-4 px-4 pt-3 pb-2 bg-base/70 backdrop-blur border-b border-white/5">
      <div class="flex items-center justify-between">
        <h1 class="text-lg font-extrabold tracking-tight flex items-center gap-2">ğŸ“¡ ÛŒØ§Ø¨Ù†Ø¯Ù‡ Ø¢Ø³Ù…Ø§Ù†ÛŒ</h1>
        <div class="flex items-center gap-2 text-xs">
          <span id="gps-pill" class="flex items-center gap-1 rounded-full border border-white/10 px-2 py-1 text-muted"><span id="gps-dot" class="inline-block w-2 h-2 rounded-full bg-warn shadow-[0_0_0_3px_rgba(255,209,102,.15)]"></span>GPS</span>
          <span id="sens-pill" class="flex items-center gap-1 rounded-full border border-white/10 px-2 py-1 text-muted"><span id="sens-dot" class="inline-block w-2 h-2 rounded-full bg-warn shadow-[0_0_0_3px_rgba(255,209,102,.15)]"></span>Ø³Ù†Ø³ÙˆØ±Ù‡Ø§</span>
        </div>
      </div>
    </header>

    <!-- Controls Card -->
    <section class="mt-3 rounded-2xl border border-white/10 bg-card/70 shadow-glass p-3">
      <div class="space-y-3">
        <!-- Satellite Search/Select -->
        <div>
          <label class="text-[12px] text-muted mb-1 block">Ù…Ø§Ù‡ÙˆØ§Ø±Ù‡</label>
          <div class="flex gap-2">
            <input id="satFilter" placeholder="Ø¬Ø³ØªØ¬Ùˆ ÛŒØ§ 13E / 7W" inputmode="search" class="flex-1 rounded-xl bg-base border border-white/10 px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-accent/50"/>
            <select id="satSel" class="w-40 rounded-xl bg-base border border-white/10 px-2.5 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-accent/50"></select>
          </div>
        </div>
        <!-- Actions -->
        <div class="grid grid-cols-2 gap-2">
          <button id="btnMyLoc" class="rounded-xl bg-gradient-to-b from-accent/40 to-base border border-white/10 py-2.5 font-semibold">ğŸ“ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ù†</button>
          <button id="btnSensors" class="rounded-xl bg-base border border-white/10 py-2.5 font-semibold">ğŸ›ï¸ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø³Ù†Ø³ÙˆØ±Ù‡Ø§</button>
        </div>
        <!-- Tuning row -->
        <div class="flex items-center justify-between gap-2 text-xs">
          <div class="flex items-center gap-1 text-muted">
            ØªÙ„Ø±Ø§Ù†Ø³: <span id="tol-read" class="font-bold text-ink">Â±2Â°</span>
          </div>
          <div class="flex gap-1">
            <button data-tol="1" class="tol rounded-full border border-white/10 px-2.5 py-1">Â±1Â°</button>
            <button data-tol="2" class="tol rounded-full border border-white/10 px-2.5 py-1 ring-1 ring-accent/40">Â±2Â°</button>
            <button data-tol="3" class="tol rounded-full border border-white/10 px-2.5 py-1">Â±3Â°</button>
            <button id="tolMore" class="rounded-full border border-white/10 px-2.5 py-1">Ø³ÙØ§Ø±Ø´ÛŒ</button>
          </div>
        </div>
        <div id="tolCustom" class="hidden items-center gap-3 text-xs text-muted">
          <span>Â±</span>
          <input id="tolAz" type="range" min="1" max="10" value="2" class="w-full accent-cyan-300">
          <span>Â° Ø³Ù…Øª</span>
          <input id="tolEl" type="range" min="1" max="10" value="2" class="w-full accent-cyan-300">
          <span>Â° Ø§Ø±ØªÙØ§Ø¹</span>
        </div>
        <!-- Sound / Declination -->
        <div class="flex items-center justify-between text-xs">
          <label class="flex items-center gap-2"><input id="soundToggle" type="checkbox" class="accent-cyan-300"/> ØµØ¯Ø§ÛŒ Ù‚ÙÙ„ Ø¨Ù‡â€ŒØ¬Ø§ÛŒ ÙˆÛŒØ¨Ø±Ù‡</label>
          <label class="flex items-center gap-2"><input id="declToggle" type="checkbox" class="accent-cyan-300"/> Ø§ØµÙ„Ø§Ø­ Ø´Ù…Ø§Ù„ Ù…ØºÙ†Ø§Ø·ÛŒØ³ÛŒ</label>
        </div>
        <div id="declBox" class="hidden flex items-center gap-2 text-xs text-muted">
          <span>Ø§Ù†Ø­Ø±Ø§Ù (Â°Â±):</span>
          <input id="declInput" type="number" step="0.1" value="0" class="w-24 rounded-lg bg-base border border-white/10 px-2 py-1"/>
          <span class="text-[11px]">(Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Ø¨Ø±Ø§ÛŒ Ù…Ù†Ø·Ù‚Ù‡â€ŒØªØ§Ù† ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯)</span>
        </div>
      </div>
    </section>

    <!-- Visualization -->
    <section class="mt-3 space-y-3">
      <!-- Compass -->
      <div id="compass" class="relative rounded-full aspect-square max-w-[420px] mx-auto border border-white/10 bg-[radial-gradient(40%_40%_at_50%_50%,rgba(122,144,187,.18),transparent_60%),conic-gradient(from_0deg,rgba(255,255,255,.05)_0_100%)] shadow-glass">
        <div class="absolute inset-2 rounded-full pointer-events-none" id="ringGlow"></div>
        <!-- ticks -->
        <div id="ticks" class="absolute inset-3 rounded-full"></div>
        <!-- target wedge -->
        <div id="winAz" class="absolute left-1/2 top-1/2 w-1.5 h-[54%] origin-bottom -translate-x-1/2 -translate-y-full bg-gradient-to-b from-ok/25 to-transparent"></div>
        <!-- target needle -->
        <div id="target" class="absolute left-1/2 top-1/2 w-[5px] h-1/2 origin-bottom -translate-x-1/2 -translate-y-full">
          <div class="absolute -inset-x-2 -bottom-3 h-3 rounded-b-xl bg-ok shadow-[0_0_0_2px_rgba(125,252,138,.35),0_0_22px_rgba(125,252,138,.35)]"></div>
        </div>
        <!-- current needle -->
        <div id="needle" class="absolute left-1/2 top-1/2 w-[3px] h-[45%] origin-bottom -translate-x-1/2 -translate-y-full bg-accent shadow-[0_0_12px_rgba(74,214,255,.7)]">
          <div class="absolute -inset-x-1 -bottom-2 h-2 rounded-b-md bg-accent"></div>
        </div>
        <!-- center label -->
        <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-center select-none">
          <div id="azRead" class="text-4xl font-extrabold">â€”Â°</div>
          <div class="text-[12px] text-muted"><span id="azDiff">â€”</span> Ø§Ø² Ù‡Ø¯Ù Â· Ø³Ù…Øª</div>
        </div>
      </div>

      <!-- Elevation -->
      <div id="elevCard" class="rounded-2xl border border-white/10 bg-card/70 shadow-glass p-3">
        <svg viewBox="0 0 1000 300" class="w-full h-[140px]">
          <g opacity=".25">
            <line x1="50" x2="950" y1="240" y2="240" stroke="rgba(255,255,255,.2)"/>
            <line x1="50" x2="950" y1="170" y2="170" stroke="rgba(255,255,255,.12)"/>
            <line x1="50" x2="950" y1="100" y2="100" stroke="rgba(255,255,255,.08)"/>
          </g>
          <path id="elevWindow" d="" fill="rgba(125,252,138,.18)" stroke="rgba(125,252,138,.3)" stroke-width="2" />
          <circle id="elevDot" cx="50" cy="240" r="10" fill="#4ad6ff"/>
        </svg>
        <div class="flex items-center justify-between gap-2 text-[12px] text-muted">
          <span>Ø²Ø§ÙˆÛŒÙ‡â€ŒØ¨Ø§Ù„Ø§: <b id="elevTarget" class="text-ink">â€”Â°</b></span>
          <span>Ø´ÛŒØ¨ Ú¯ÙˆØ´ÛŒ: <b id="tiltNow" class="text-ink">â€”Â°</b></span>
          <span>Ø§Ø®ØªÙ„Ø§Ù: <b id="elevDiff" class="text-ink">â€”Â°</b></span>
        </div>
      </div>

      <!-- Stats -->
      <div class="grid grid-cols-2 gap-2">
        <div class="rounded-xl border border-white/10 bg-card/60 p-3"><div class="text-[12px] text-muted">Ø¢Ø²ÛŒÙ…ÙˆØª Ù‡Ø¯Ù</div><div id="azTarget" class="text-lg font-bold">â€”Â°</div></div>
        <div class="rounded-xl border border-white/10 bg-card/60 p-3"><div class="text-[12px] text-muted">Ú†Ø±Ø®Ø´ LNB</div><div id="skew" class="text-lg font-bold">â€”Â°</div></div>
        <div class="rounded-xl border border-white/10 bg-card/60 p-3"><div class="text-[12px] text-muted">Ø¹Ø±Ø¶/Ø·ÙˆÙ„ Ù…Ù†</div><div id="myloc" class="text-lg font-bold">â€”</div></div>
        <div class="rounded-xl border border-white/10 bg-card/60 p-3"><div class="text-[12px] text-muted">Ø·ÙˆÙ„ Ù…Ø§Ù‡ÙˆØ§Ø±Ù‡</div><div id="satlon" class="text-lg font-bold">â€”</div></div>
      </div>
    </section>

    <!-- Footer -->
    <footer class="mt-3 text-[12px] text-muted leading-6">
      <p>âš ï¸ Ø¯Ù‚Øª Ù‚Ø·Ø¨â€ŒÙ†Ù…Ø§ Ø¨Ù‡ Ú©Ø§Ù„ÛŒØ¨Ø±Ø§Ø³ÛŒÙˆÙ† Ùˆ Ù…ÛŒØ¯Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ù…ØºÙ†Ø§Ø·ÛŒØ³ÛŒ Ø§Ø·Ø±Ø§Ù Ø­Ø³Ø§Ø³ Ø§Ø³Øª. Ú†Ù†Ø¯ Ø¨Ø§Ø± Ø´Ú©Ù„ Û¸ Ø­Ø±Ú©Øª Ø¯Ù‡ÛŒØ¯ Ùˆ Ø¯ÙˆØ± Ø§Ø² ÙÙ„Ø²Ø§Øª Ø³Ù†Ú¯ÛŒÙ† Ø¨Ø§ÛŒØ³ØªÛŒØ¯. Ø¢Ø²ÛŒÙ…ÙˆØª Ø§Ø² Ø´Ù…Ø§Ù„ Ø­Ù‚ÛŒÙ‚ÛŒ Ø³Ù†Ø¬ÛŒØ¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯Ø› Ø¯Ø± iOS Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ Ø­Ù‚ÛŒÙ‚ÛŒ Ø§Ø³ØªØŒ Ø¯Ø± Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù…ØºÙ†Ø§Ø·ÛŒØ³ÛŒ Ø¨Ø§Ø´Ø¯ (Ø§Ø² Â«Ø§ØµÙ„Ø§Ø­ Ø´Ù…Ø§Ù„ Ù…ØºÙ†Ø§Ø·ÛŒØ³ÛŒÂ» Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯).</p>
    </footer>
  </div>

  <!-- Bottom action bar (iOS friendly) -->
  <div class="fixed inset-x-0 bottom-0 z-30 bg-base/80 backdrop-blur border-t border-white/10 p-[max(env(safe-area-inset-bottom),10px)]">
    <div class="max-w-md mx-auto flex items-center justify-between gap-2">
      <button id="calibBtn" class="flex-1 rounded-xl bg-base border border-white/10 py-2 text-sm">ğŸ§­ Ú©Ø§Ù„ÛŒØ¨Ø±Ø§Ø³ÛŒÙˆÙ†</button>
      <button id="helpBtn" class="flex-1 rounded-xl bg-base border border-white/10 py-2 text-sm">â“Ø±Ø§Ù‡Ù†Ù…Ø§</button>
      <button id="lockBtn" class="flex-1 rounded-xl bg-gradient-to-b from-ok/30 to-base border border-white/10 py-2 font-bold">âœ… Ù‚ÙÙ„</button>
    </div>
  </div>

<script>
(function(){
  const d = document;const $=s=>d.querySelector(s);const $$=s=>Array.from(d.querySelectorAll(s));
  const toRad = deg => deg*Math.PI/180, toDeg = rad => rad*180/Math.PI;
  const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));

  // ===== Expanded Satellite List (MENA/Europe focused) =====
  const SATS = [
    {name:'Ù‡Ø§ØªØ¨Ø±Ø¯ 13E (Eutelsat Hotbird)',lon:13},{name:'ØªØ±Ú©â€ŒØ³Øª 42E (Turksat)',lon:42},{name:'ØªØ±Ú©â€ŒØ³Øª 50E',lon:50},{name:'Ø¢Ø°Ø±Ø³Ù¾ÛŒØ³/ØªØ±Ú©â€ŒØ³Øª 46E',lon:46},
    {name:'ÛŒØ§Ù‡â€ŒØ³Øª 52.5E (Al Yah 1)',lon:52.5},{name:'Express AM6 53E',lon:53},{name:'Ø§ÛŒÙ†ØªÙ„â€ŒØ³Øª 62E',lon:62},{name:'Ø§ÛŒÙ†ØªÙ„â€ŒØ³Øª 66E',lon:66},{name:'Ø§ÛŒÙ†ØªÙ„â€ŒØ³Øª 68.5E',lon:68.5},
    {name:'Ø¹Ø±Ø¨â€ŒØ³Øª Ø¨Ø¯Ø± 26E',lon:26},{name:'Ù†Ø§ÛŒÙ„â€ŒØ³Øª 7W',lon:-7},{name:'ÛŒÙˆØªÙ„â€ŒØ³Øª 8W',lon:-8},{name:'ÛŒÙˆØªÙ„â€ŒØ³Øª 5W',lon:-5},{name:'Ø¢Ù…ÙˆØ³ 4W',lon:-4},{name:'ABS 3W',lon:-3},{name:'Thor/Intelsat 1W',lon:-1},
    {name:'Ø³Ø§ÛŒØ±ÛŒØ³/Ø¢Ø³ØªØ±Ø§ 4A 4.8E',lon:4.8},{name:'ÛŒÙˆØªÙ„â€ŒØ³Øª 7E',lon:7},{name:'Ø¢Ø³ØªØ±Ø§ 19.2E',lon:19.2},{name:'Ø¢Ø³ØªØ±Ø§ 23.5E',lon:23.5},{name:'Ø¢Ø³ØªØ±Ø§ 28.2E',lon:28.2},{name:'ÛŒÙˆØªÙ„â€ŒØ³Øª 16E',lon:16},
    {name:'ÛŒÙˆØªÙ„â€ŒØ³Øª 36E / Express AMU1',lon:36},{name:'Ù‡Ù„Ø§Ø³â€ŒØ³Øª 39E',lon:39},{name:'Ù¾Ú©â€ŒØ³Øª 38E',lon:38},{name:'Ú©Ø§Ø²Ø³Øª 48.5E',lon:48.5},
    {name:'Ù‡ÛŒØ³Ù¾Ø§Ø³Ø§Øª 30W',lon:-30},{name:'Galaxy 19 97W (Ø¯ÙˆØ± Ø§Ø² Ø§ÛŒØ±Ø§Ù†)',lon:-97},
    {name:'ChinaSat 12 87.5E',lon:87.5},{name:'Asiasat 7 105.5E',lon:105.5},{name:'Express AMU7 145E',lon:145},
  ];

  // DOM refs
  const satSel=$('#satSel'), satFilter=$('#satFilter');
  const ticks=$('#ticks'), needle=$('#needle'), target=$('#target'), winAz=$('#winAz');
  const azRead=$('#azRead'), azDiff=$('#azDiff'), azTarget=$('#azTarget');
  const elevTarget=$('#elevTarget'), elevDiff=$('#elevDiff'), tiltn=$('#tiltNow');
  const elevDot=$('#elevDot'), elevWindow=$('#elevWindow');
  const myloc=$('#myloc'), satlonEl=$('#satlon');
  const gpsDot=$('#gps-dot'), sensDot=$('#sens-dot');
  const tolRead=$('#tol-read');
  const tolMore=$('#tolMore'), tolBox=$('#tolCustom');
  const tolAz=$('#tolAz'), tolEl=$('#tolEl');
  const soundToggle=$('#soundToggle');
  const declToggle=$('#declToggle'), declBox=$('#declBox'), declInput=$('#declInput');
  const ringGlow=$('#ringGlow');

  // State
  const S={ lat:null, lon:null, satLon:13, target:{az:null,el:null,skew:null}, heading:null, pitch:0, tolAz:2, tolEl:2, lastBuzz:0, decl:0 };

  // Build ticks (every 10Â°, larger every 30Â°)
  for(let i=0;i<360;i+=10){
    const div=d.createElement('div');
    div.className='absolute left-1/2 top-1/2 w-[2px] bg-white/30 '+(i%30===0?'h-5':'h-3');
    div.style.transform='translate(-50%,-50%) rotate('+i+'deg) translateY(-43%)';
    ticks.appendChild(div);
  }

  // Fill satellite list
  function fmtLon(v){return (v>=0? v.toFixed(1)+'Â°E' : Math.abs(v).toFixed(1)+'Â°W');}
  function renderSatList(list){ satSel.innerHTML=''; list.forEach(s=>{ const o=d.createElement('option'); o.value=s.lon; o.textContent=s.name+' Â· '+fmtLon(s.lon); satSel.appendChild(o); }); }
  renderSatList(SATS);

  satFilter.addEventListener('input',()=>{
    const q=satFilter.value.trim();
    const m2=q.match(/^(\d+(?:\.\d+)?)\s*([eEwW])$/); const m=q.match(/^(-?\d+(?:\.\d+)?)/);
    if(m2){ S.satLon=(m2[2].toUpperCase()==='W'?-1:1)*parseFloat(m2[1]); calc(); }
    else if(m){ S.satLon=parseFloat(m[1]); calc(); }
    const list=SATS.filter(s=> s.name.includes(q) || fmtLon(s.lon).toLowerCase().includes(q.toLowerCase()));
    renderSatList(list.length?list:SATS);
  });
  satSel.addEventListener('change',()=>{ S.satLon=parseFloat(satSel.value); calc(); });

  // Geodesy
  function computePointing(lat,lon,satLon){
    const phi=toRad(lat), dlon=toRad(satLon-lon);
    const cospsi=Math.cos(phi)*Math.cos(dlon); const psi=Math.acos(cospsi);
    const Re_Rs=6378.137/42164.0; const el=Math.atan((Math.cos(psi)-Re_Rs)/Math.sin(psi));
    const y=Math.sin(dlon), x=-Math.sin(phi)*Math.cos(dlon);
    let az=toDeg(Math.atan2(y,x)); az=(az+360)%360; // true bearing
    const skew=toDeg(Math.atan(Math.tan(dlon)/Math.sin(phi)));
    return { az, el: toDeg(el), skew };
  }

  function arcXY(el){ const x=50+(el/90)*900; const y=240-(Math.sin(toRad(el))*120); return [x,y]; }
  function arcPath(a,b){ const a1=clamp(a,0,90), b1=clamp(b,0,90); const x1=50+(a1/90)*900, y1=240-(Math.sin(toRad(a1))*120); const x2=50+(b1/90)*900, y2=240-(Math.sin(toRad(b1))*120); const mid=(a1+b1)/2, xm=50+(mid/90)*900, ym=240-(Math.sin(toRad(mid))*120); const c1x=(x1+xm)/2, c1y=y1-0.7*(y1-ym); const c2x=(x2+xm)/2, c2y=y2-0.7*(y2-ym); return 'M '+x1+' '+y1+' C '+c1x+' '+c1y+', '+c2x+' '+c2y+', '+x2+' '+y2; }

  function calc(){ if(S.lat==null||S.lon==null) return; S.target=computePointing(S.lat,S.lon,S.satLon); azTarget.textContent=S.target.az.toFixed(1)+'Â°'; elevTarget.textContent=S.target.el.toFixed(1)+'Â°'; satlonEl.textContent=fmtLon(S.satLon);
    const el0=clamp(S.target.el,0,90); const elA=clamp(el0-S.tolEl,0,90), elB=clamp(el0+S.tolEl,0,90); elevWindow.setAttribute('d',arcPath(elA,elB));
    target.style.transform='translate(-50%,-100%) rotate('+S.target.az+'deg)'; winAz.style.transform='translate(-50%,-100%) rotate('+S.target.az+'deg)'; }

  // GPS
  $('#btnMyLoc').addEventListener('click',()=>{
    if(!('geolocation' in navigator)) return alert('Ø§ÛŒÙ† Ø¯Ø³ØªÚ¯Ø§Ù‡ GPS Ù†Ø¯Ø§Ø±Ø¯.');
    navigator.geolocation.getCurrentPosition(pos=>{ const {latitude,longitude}=pos.coords; S.lat=latitude;S.lon=longitude; myloc.textContent=latitude.toFixed(5)+', '+longitude.toFixed(5); $('#gps-dot').classList.remove('bg-warn'); $('#gps-dot').classList.add('bg-ok'); calc(); }, err=>{ alert('GPS Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª: '+err.message); }, {enableHighAccuracy:true, maximumAge:10000, timeout:10000});
  });

  // Sensors
  $('#btnSensors').addEventListener('click',requestSensors);
  function requestSensors(){
    const onGranted=()=>{ $('#sens-dot').classList.remove('bg-warn'); $('#sens-dot').classList.add('bg-ok'); window.addEventListener('deviceorientation',onDO,true); animate(); };
    if(window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission==='function'){
      DeviceOrientationEvent.requestPermission().then(s=>{ if(s==='granted') onGranted(); else alert('Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø³Ù†Ø³ÙˆØ±Ù‡Ø§ Ø±Ø¯ Ø´Ø¯.'); }).catch(()=>alert('Ø¹Ø¯Ù… Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø³Ù†Ø³ÙˆØ±Ù‡Ø§'));
    } else if('ondeviceorientation' in window){ onGranted(); } else { alert('Ø§ÛŒÙ† Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø§Ø² Ø³Ù†Ø³ÙˆØ± Ø¬Ù‡Øªâ€ŒÙ†Ù…Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.'); }
  }

  let smoothHead=null, smoothPitch=null; const ALPHA=0.18; // smoother
  function lp(prev,next,a){ return prev==null? next : prev*(1-a)+next*a; }

  function onDO(ev){
    let heading=null; if(typeof ev.webkitCompassHeading==='number'&&!isNaN(ev.webkitCompassHeading)){ heading=ev.webkitCompassHeading; }
    else if(typeof ev.alpha==='number'){ heading=360-ev.alpha; if(!ev.absolute) heading += S.decl; }
    let pitch= typeof ev.beta==='number'? ev.beta : 0; pitch=clamp(pitch,-90,90);
    if(heading!=null) smoothHead=lp(smoothHead,(heading+360)%360,ALPHA); smoothPitch=lp(smoothPitch,pitch,ALPHA);
    S.heading=smoothHead; S.pitch=smoothPitch;
  }

  // Render loop via rAF (fast & smooth)
  function animate(){
    if(S.heading!=null){ $('#needle').style.transform='translate(-50%,-100%) rotate('+S.heading.toFixed(1)+'deg)'; azRead.textContent=S.heading.toFixed(1)+'Â°'; }
    if(S.target.az!=null && S.heading!=null){ const diff=shortestDelta(S.target.az, S.heading); azDiff.textContent=(diff>0?'+':'')+diff.toFixed(1)+'Â°'; }
    if(S.pitch!=null){ tiltn.textContent=S.pitch.toFixed(1)+'Â°'; const el=clamp(S.pitch,0,90); const xy=arcXY(el); elevDot.setAttribute('cx',xy[0]); elevDot.setAttribute('cy',xy[1]); }
    checkLock();
    requestAnimationFrame(animate);
  }
  function shortestDelta(a,b){ let d=(a-b+540)%360-180; return d; }

  // Lock feedback
  function checkLock(){ if(S.target.az==null||S.heading==null||S.pitch==null) return; const dAz=Math.abs(shortestDelta(S.target.az,S.heading)); const dEl=Math.abs(clamp(S.pitch,0,90)-clamp(S.target.el,0,90)); const ok = dAz<=S.tolAz && dEl<=S.tolEl; elevDiff.textContent=(ok? 'âœ… ' : '')+ (dEl>0? dEl.toFixed(1)+'Â°':'0Â°'); ringGlow.style.boxShadow = ok? '0 0 0 8px rgba(39,209,124,.18), 0 0 60px 8px rgba(39,209,124,.35)': 'none'; if(ok){ const now=performance.now(); if(now-S.lastBuzz>1200){ S.lastBuzz=now; lockBuzz(); toast('âœ… Ù‡Ø¯Ù Ù¾ÛŒØ¯Ø§ Ø´Ø¯!'); } } }

  // Sound / Vibrate
  let audioCtx=null; function beep(){ try{ audioCtx=audioCtx||new (window.AudioContext||window.webkitAudioContext)(); const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type='sine'; o.frequency.value=880; g.gain.setValueAtTime(0.0001,audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.22,audioCtx.currentTime+0.01); g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+0.2); o.connect(g).connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.22);}catch(e){} }
  function lockBuzz(){ if(soundToggle.checked) beep(); else{ try{ navigator.vibrate && navigator.vibrate([90,40,90]); }catch{} } }

  // UI helpers
  function toast(txt){ let el=d.getElementById('toast'); if(!el){ el=d.createElement('div'); el.id='toast'; el.className='fixed left-1/2 -translate-x-1/2 bottom-20 bg-black/70 border border-white/10 backdrop-blur px-3 py-2 rounded-xl text-sm font-semibold z-50'; d.body.appendChild(el);} el.textContent=txt; el.style.opacity='1'; clearTimeout(window.__t); window.__t=setTimeout(function(){el.style.opacity='0'},1400); }

  // Tolerance chips
  $$('.tol').forEach(function(btn){ btn.addEventListener('click',function(){ const v=parseInt(btn.getAttribute('data-tol'),10); S.tolAz=S.tolEl=v; tolAz.value=v; tolEl.value=v; tolRead.textContent='Â±'+v+'Â°'; $$('.tol').forEach(function(b){ b.classList.remove('ring-1','ring-accent/40') }); btn.classList.add('ring-1','ring-accent/40'); calc(); })});
  tolMore.addEventListener('click',function(){ tolBox.classList.toggle('hidden') });
  tolAz.addEventListener('input',function(){ S.tolAz=parseInt(tolAz.value,10); tolRead.textContent='Â±'+S.tolAz+'Â°'; calc(); });
  tolEl.addEventListener('input',function(){ S.tolEl=parseInt(tolEl.value,10); calc(); });

  // Declination correction
  declToggle.addEventListener('change',function(){ declBox.classList.toggle('hidden', !declToggle.checked); S.decl = declToggle.checked? parseFloat(declInput.value||0): 0; });
  declInput.addEventListener('input',function(){ if(declToggle.checked){ S.decl=parseFloat(declInput.value||0); }});

  // Calib/Help
  $('#calibBtn').addEventListener('click',function(){ toast('Ú¯ÙˆØ´ÛŒ Ø±Ø§ Ø¨Ù‡ Ø´Ú©Ù„ Û¸ Ø¯Ø± Ù‡ÙˆØ§ Ø­Ø±Ú©Øª Ø¯Ù‡ÛŒØ¯. Ø§Ø² ÙÙ„Ø²Ø§Øª Ø¯ÙˆØ± Ø´ÙˆÛŒØ¯.') });
  $('#helpBtn').addEventListener('click',function(){ alert('Ø±Ø§Ù‡Ù†Ù…Ø§:\n1) ğŸ“ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø±Ø§ Ø¨Ú¯ÛŒØ±ÛŒØ¯.\n2) Ù…Ø§Ù‡ÙˆØ§Ø±Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.\n3) ğŸ›ï¸ Ø³Ù†Ø³ÙˆØ±Ù‡Ø§ Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯.\n4) Ú¯ÙˆØ´ÛŒ Ø±Ø§ Ø¨Ú†Ø±Ø®Ø§Ù†ÛŒØ¯/Ú©Ø¬ Ú©Ù†ÛŒØ¯ ØªØ§ Ø³ÙˆØ²Ù†â€ŒÙ‡Ø§ Ù‡Ù…â€ŒØ±Ø§Ø³ØªØ§ Ø´ÙˆÙ†Ø¯.\n5) Ø¨Ø§ Ù‚ÙÙ„ØŒ ÙˆÛŒØ¨Ø±Ù‡/ØµØ¯Ø§ Ùˆ Ø§ÙÚ©Øª Ø³Ø¨Ø² Ù…ÛŒâ€ŒØ¨ÛŒÙ†ÛŒØ¯.') });
  $('#lockBtn').addEventListener('click',function(){ toast('Ø¨Ø±Ø§ÛŒ Ù‚ÙÙ„ØŒ Ù‡Ø± Ø¯Ùˆ Ø²Ø§ÙˆÛŒÙ‡ Ø¯Ø§Ø®Ù„ ØªÙ„Ø±Ø§Ù†Ø³ Ø¨Ø§Ø´Ù†Ø¯.') });

  // Init
  calc();
})();
</script>
</body>
</html>
