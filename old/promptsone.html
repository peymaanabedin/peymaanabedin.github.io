<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PromptVault</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#111827" media="(prefers-color-scheme: dark)">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PromptVault">
    <meta name="application-name" content="PromptVault">
    <link rel="icon" type="image/png" href="https://i.postimg.cc/4ybV6mXC/App-Icon-2x.png">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/4ybV6mXC/App-Icon-2x.png">
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIlByb21wdFZhdWx0IiwKICAic2hvcnRfbmFtZSI6ICJQcm9tcHRWYXVsdCIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMTExODI3IiwKICAidGhlbWVfY29sdCI6ICIjMTExODI3IsCiAgImRlc2NyaXB0aW9uIjogIkEgcGVyc29uYWwgbGlicmFyeSB0byBzYXZlLCBzZWFyY2gsIGFuZCBzaGFyZSB5b3VyIEFJIGltYWdlIGdlbmVyYXRpb24gcHJvbXB0cy4iLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJodHRwczovL2kucG9zdGltZy5jYy80eWJWNm1YQy9BcHAtSWNvbi0yeC5wbmciLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIKICAgIH0sCiAgICB7CiAgICAgICJzcmMiOiAiaHR0cHM6Ly9pLnBvc3RpbWcuY2MvNHliVjZtWEMvQXBwLUljb24tMngucG5nIiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9CiAgXQp9Cg==">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Vazirmatn:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Light Mode Variables (Default) */
            --bg-color: #f3f4f6;
            --text-color: #1f2937;
            --text-muted-color: #52525b; /* zinc-600 */
            --card-bg: rgba(255, 255, 255, 0.75);
            --input-bg: rgba(229, 231, 235, 0.7);
            --border-color: rgba(0, 0, 0, 0.1);
            --primary-accent: #0ea5e9;
            --secondary-accent: #6366f1;
            --modal-bg-color: #ffffff;
            --modal-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.2);
        }
        html.dark {
            /* Dark Mode Variables */
            --bg-color: #111827;
            --text-color: #f3f4f6;
            --text-muted-color: #a1a1aa; /* zinc-400 */
            --card-bg: rgba(31, 41, 55, 0.65);
            --input-bg: rgba(55, 65, 81, 0.7);
            --border-color: rgba(255, 255, 255, 0.1);
            --primary-accent: #38bdf8;
            --secondary-accent: #818cf8;
            --modal-bg-color: #1f2937;
            --modal-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.4);
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--primary-accent); border-radius: 3px; }
        body {
            font-family: 'Vazirmatn', 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            overscroll-behavior-y: contain;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .glassmorphism {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .modal-card {
            background-color: var(--modal-bg-color);
            box-shadow: var(--modal-shadow);
            transition: background-color 0.3s ease;
        }
        /* Animations */
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        .fade-out { animation: fadeOut 0.3s ease-in forwards; }
        .slide-up { animation: slideUp 0.3s cubic-bezier(0.22, 1, 0.36, 1) forwards; }
        .slide-down { animation: slideDown 0.3s cubic-bezier(0.64, 0, 0.78, 0) forwards; }
        .card-pop-in { animation: popIn 0.3s ease-out forwards; opacity: 0; transform: scale(0.95); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0.8; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideDown { from { transform: translateY(0); opacity: 1; } to { transform: translateY(100%); opacity: 0.8; } }
        @keyframes popIn { to { opacity: 1; transform: scale(1); } }
        /* UI Element Styling */
        .form-input {
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            transition: border-color 0.2s, box-shadow 0.2s, background-color 0.3s ease;
        }
        .form-input::placeholder { color: var(--text-muted-color); }
        .form-input:focus {
            outline: none;
            border-color: var(--primary-accent);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-accent) 30%, transparent);
        }
        .tab-btn.active { background-color: var(--primary-accent); color: white; }
        .tab-btn:not(.active) { background-color: var(--input-bg); color: var(--text-color); }
        .tag-filter { transition: background-color 0.2s, color 0.2s; }
        .tag-filter.active { background-color: var(--primary-accent); color: white; }
        .pin-icon.pinned { color: var(--primary-accent); }
        .header-icon { color: var(--primary-accent); }
        .header-text-gradient { background-image: linear-gradient(to right, var(--primary-accent), var(--secondary-accent)); }
        .muted-text { color: var(--text-muted-color); }
        .interactive-scale { transition: transform 0.1s ease-out; touch-action: manipulation; }
        .interactive-scale:active { transform: scale(0.95); }
        * { -webkit-tap-highlight-color: transparent; }
        /* Tag Pill Styles */
        .tag-pill {
            display: inline-flex;
            align-items: center;
            background-color: color-mix(in srgb, var(--primary-accent) 90%, black);
            color: white;
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            animation: popIn 0.2s ease-out;
        }
        .tag-pill-remove {
            margin-left: 6px;
            width: 18px;
            height: 18px;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
            transition: background-color 0.2s;
        }
        .tag-pill-remove:hover {
            background-color: rgba(0, 0, 0, 0.4);
        }
    </style>
</head>
<body class="antialiased">
    <div class="min-h-screen max-w-lg mx-auto p-4 pb-28">
        <header class="flex items-center justify-between py-4">
            <div class="flex items-center gap-2">
                 <i class="fa-solid fa-bolt-lightning h-7 w-7 header-icon"></i>
                <h1 class="text-2xl font-bold header-text-gradient bg-clip-text text-transparent">PromptVault</h1>
            </div>
            <button id="settings-btn" class="p-2 rounded-full hover:bg-black/10 dark:hover:bg-white/10 active:bg-black/20 dark:active:bg-white/20 interactive-scale">
                <i class="fa-solid fa-gear h-6 w-6"></i>
            </button>
        </header>
        <div class="flex items-center gap-2 mt-4 mb-2">
            <div class="relative flex-grow">
                <input id="search-input" type="text" placeholder="Search prompts..." class="w-full form-input pl-10 pr-4 py-3 rounded-full">
                <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 h-5 w-5 muted-text"></i>
            </div>
            <button id="view-toggle-btn" class="p-3 w-12 h-12 rounded-full glassmorphism interactive-scale flex items-center justify-center"></button>
        </div>
        <div id="tag-filters-container" class="py-2 mb-4 whitespace-nowrap overflow-x-auto"></div>
        <main id="prompt-library" class="space-y-4"></main>
        <div id="empty-state" class="hidden text-center py-20">
            <i class="fa-solid fa-cubes mx-auto h-12 w-12 muted-text text-5xl"></i>
            <p class="mt-4 text-lg font-semibold">Your Vault is Empty</p>
            <p class="muted-text mt-1">Tap the '+' button to add your first prompt.</p>
        </div>
    </div>
    <button id="fab-add" class="fixed bottom-6 right-6 h-16 w-16 rounded-full bg-gradient-to-br from-sky-500 to-indigo-600 text-white flex items-center justify-center shadow-lg transform transition-transform hover:scale-110 active:scale-95 interactive-scale">
        <i class="fa-solid fa-plus h-8 w-8 text-3xl"></i>
    </button>
    <div id="prompt-form-modal" class="fixed inset-0 z-40 hidden items-end bg-black bg-opacity-50"><div id="prompt-form-container" class="w-full modal-card rounded-t-2xl p-4 transform translate-y-full"><h2 id="form-title" class="text-xl font-bold mb-4 text-center">Add New Prompt</h2><div class="p-1 bg-gray-700/50 dark:bg-black/20 rounded-lg flex mb-4"><button id="tab-prompt" class="tab-btn flex-1 py-2 rounded-md font-semibold interactive-scale">Prompt</button><button id="tab-details" class="tab-btn flex-1 py-2 rounded-md font-semibold interactive-scale">Details</button></div><form id="prompt-form"><input type="hidden" id="prompt-id"><div id="tab-content-prompt"><textarea id="prompt-text" rows="6" class="w-full form-input rounded-lg p-3 text-base" placeholder="Paste your prompt here..."></textarea><button type="button" id="paste-btn" class="w-full mt-3 py-3 rounded-lg bg-indigo-500 font-semibold text-white flex items-center justify-center gap-2 interactive-scale"><i class="fa-solid fa-paste"></i>Paste from Clipboard</button></div><div id="tab-content-details" class="hidden space-y-4"><input id="prompt-name" type="text" class="w-full form-input rounded-lg p-3 text-base" placeholder="Name (e.g., 'Cyberpunk Cat')"><div class="flex items-center gap-3"><img id="image-preview" src="https://placehold.co/100x100/1f2937/4b5563?text=Image" class="w-16 h-16 rounded-lg object-cover"><label for="prompt-image-upload" class="flex-grow text-center py-3 rounded-lg bg-gray-500 font-semibold cursor-pointer text-white interactive-scale">Upload Image</label><input id="prompt-image-upload" type="file" class="hidden" accept="image/*"><input id="prompt-image-data" type="hidden"></div><div class="space-y-2"><p class="text-sm font-medium muted-text">Tags</p><div id="tag-pills-container" class="flex flex-wrap gap-2 empty:mb-2"></div><input id="prompt-tags-input" type="text" class="w-full form-input rounded-lg p-3 text-base" placeholder="Add a tag and press Enter..."></div></div><div class="grid grid-cols-2 gap-3 pt-4"><button type="button" id="cancel-btn" class="py-3 rounded-lg bg-gray-500 font-semibold text-white interactive-scale">Cancel</button><button type="submit" class="py-3 rounded-lg bg-sky-500 font-semibold text-white interactive-scale">Save Prompt</button></div></form></div></div>
    <div id="details-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-70 p-4"><div id="details-container" class="w-full max-w-md modal-card rounded-2xl overflow-hidden transform scale-95 opacity-0"><div class="relative"><img id="details-image" src="" class="w-full h-64 object-cover" onerror="this.src='https://placehold.co/600x400/111827/38bdf8?text=No+Image'; this.classList.add('object-contain', 'p-4');"><button id="details-pin-btn" class="absolute top-3 right-3 p-2 rounded-full bg-black/40 backdrop-blur-sm interactive-scale"></button><button id="close-details-btn" class="absolute top-3 left-3 p-2 w-8 h-8 flex items-center justify-center rounded-full bg-black/40 backdrop-blur-sm interactive-scale text-white"><i class="fa-solid fa-xmark"></i></button></div><div class="p-4 space-y-4"><h3 id="details-name" class="text-xl font-bold"></h3><div id="details-tags" class="flex flex-wrap gap-2"></div><div class="max-h-32 overflow-y-auto p-3 bg-black/10 dark:bg-black/20 rounded-lg"><p id="details-prompt" class="text-sm whitespace-pre-wrap muted-text"></p></div><div class="grid grid-cols-2 gap-3"><button id="copy-btn" class="flex-1 flex items-center justify-center gap-2 py-3 rounded-lg bg-sky-500 font-semibold text-white interactive-scale"><i class="fa-solid fa-copy"></i>Copy</button><button id="share-btn" class="flex-1 flex items-center justify-center gap-2 py-3 rounded-lg bg-indigo-500 font-semibold text-white interactive-scale"><i class="fa-solid fa-share-nodes"></i>Share</button></div><div class="grid grid-cols-3 gap-3"><button id="edit-btn" class="flex-1 py-2 text-sm text-sky-500 rounded-lg hover:bg-sky-500/10 interactive-scale">Edit</button><button id="duplicate-btn" class="flex-1 py-2 text-sm text-indigo-400 rounded-lg hover:bg-indigo-500/10 interactive-scale">Duplicate</button><button id="delete-btn" class="flex-1 py-2 text-sm text-red-400 rounded-lg hover:bg-red-500/10 interactive-scale">Delete</button></div></div></div></div>
    <div id="generic-modal-overlay" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-70 p-4">
        <div id="settings-modal" class="hidden w-full max-w-sm modal-card rounded-2xl p-4 transform scale-95 opacity-0">
            <h3 class="text-xl font-bold text-center mb-4">Settings</h3>
            <div id="theme-toggle" class="w-full p-2 mb-3 rounded-lg bg-black/5 dark:bg-white/5 flex items-center justify-center gap-3 cursor-pointer interactive-scale"></div>
            <div class="space-y-3">
                <button id="backup-btn" class="w-full py-3 rounded-lg bg-sky-500 font-semibold text-white interactive-scale">Backup Library</button>
                <button id="restore-btn" class="w-full py-3 rounded-lg bg-indigo-500 font-semibold text-white interactive-scale">Restore Library</button>
                <input type="file" id="restore-input" class="hidden" accept=".json">
                <button id="about-btn" class="w-full py-3 rounded-lg bg-gray-600 font-semibold text-white interactive-scale">About</button>
            </div>
            <button id="close-settings-btn" class="w-full mt-4 py-2 text-sm muted-text rounded-lg hover:bg-black/5 dark:hover:bg-white/5 interactive-scale">Close</button>
        </div>
        <div id="about-modal" class="hidden w-full max-w-sm modal-card rounded-2xl p-6 text-center transform scale-95 opacity-0"><h3 class="text-xl font-bold">PromptVault</h3><p class="muted-text mt-2">Created by Peymaan abedinpour| v0.3</p><button id="close-about-btn" class="w-full mt-6 py-3 rounded-lg bg-gray-600 font-semibold text-white interactive-scale">Close</button></div>
        <div id="confirm-modal" class="hidden w-full max-w-sm modal-card rounded-2xl p-6 transform scale-95 opacity-0"><h3 class="text-lg font-bold text-center">Are you sure?</h3><p id="confirm-message" class="muted-text text-center my-3"></p><div class="grid grid-cols-2 gap-3 mt-4"><button id="confirm-cancel-btn" class="py-3 rounded-lg bg-gray-600 font-semibold text-white interactive-scale">Cancel</button><button id="confirm-ok-btn" class="py-3 rounded-lg bg-red-500 font-semibold text-white interactive-scale">Confirm</button></div></div>
    </div>
    <div id="toast" class="fixed bottom-20 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full text-white text-sm opacity-0 transform translate-y-4 pointer-events-none" style="background: #27272a; color: white;"></div>
    <div id="context-menu-modal" class="fixed inset-0 z-50 hidden items-end bg-black/50" >
        <div id="context-menu-container" class="w-full max-w-lg mx-auto modal-card rounded-t-2xl p-2.5">
            <div id="context-menu-header" class="p-2 text-center border-b border-black/10 dark:border-white/10 mb-2">
                <h4 id="context-menu-title" class="font-bold truncate"></h4>
                <p id="context-menu-subtitle" class="text-xs muted-text truncate"></p>
            </div>
            <div id="context-menu-options" class="space-y-1.5">
                </div>
            <button id="context-menu-cancel" class="w-full mt-2 py-3 rounded-lg bg-gray-200 dark:bg-gray-700 font-semibold interactive-scale">Cancel</button>
        </div>
    </div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elements ---
        const library = document.getElementById('prompt-library'), searchInput = document.getElementById('search-input'), emptyState = document.getElementById('empty-state'), fab = document.getElementById('fab-add'), toast = document.getElementById('toast'), toastMessage = document.getElementById('toast').appendChild(document.createElement('span')), viewToggleBtn = document.getElementById('view-toggle-btn'), tagFiltersContainer = document.getElementById('tag-filters-container'), themeToggleBtn = document.getElementById('theme-toggle');
        const formModal = document.getElementById('prompt-form-modal'), formContainer = document.getElementById('prompt-form-container'), promptForm = document.getElementById('prompt-form'), cancelBtn = document.getElementById('cancel-btn'), formTitle = document.getElementById('form-title'), pasteBtn = document.getElementById('paste-btn'), imageUploadInput = document.getElementById('prompt-image-upload'), imagePreview = document.getElementById('image-preview'), imageDataInput = document.getElementById('prompt-image-data');
        const tabPrompt = document.getElementById('tab-prompt'), tabDetails = document.getElementById('tab-details'), tabContentPrompt = document.getElementById('tab-content-prompt'), tabContentDetails = document.getElementById('tab-content-details');
        const detailsModal = document.getElementById('details-modal'), detailsContainer = document.getElementById('details-container'), closeDetailsBtn = document.getElementById('close-details-btn'), copyBtn = document.getElementById('copy-btn'), shareBtn = document.getElementById('share-btn'), deleteBtn = document.getElementById('delete-btn'), editBtn = document.getElementById('edit-btn'), duplicateBtn = document.getElementById('duplicate-btn'), detailsPinBtn = document.getElementById('details-pin-btn');
        const genericModalOverlay = document.getElementById('generic-modal-overlay'), settingsBtn = document.getElementById('settings-btn'), settingsModal = document.getElementById('settings-modal'), closeSettingsBtn = document.getElementById('close-settings-btn'), aboutBtn = document.getElementById('about-btn'), aboutModal = document.getElementById('about-modal'), closeAboutBtn = document.getElementById('close-about-btn'), confirmModal = document.getElementById('confirm-modal'), confirmMessage = document.getElementById('confirm-message'), confirmOkBtn = document.getElementById('confirm-ok-btn'), confirmCancelBtn = document.getElementById('confirm-cancel-btn');
        const backupBtn = document.getElementById('backup-btn'), restoreBtn = document.getElementById('restore-btn'), restoreInput = document.getElementById('restore-input');
        const contextMenuModal = document.getElementById('context-menu-modal'), contextMenuContainer = document.getElementById('context-menu-container'), contextMenuCancel = document.getElementById('context-menu-cancel');
        const promptTagsInput = document.getElementById('prompt-tags-input'), tagPillsContainer = document.getElementById('tag-pills-container');

        // --- STATE MANAGEMENT ---
        let prompts = [], currentEditingId = null, confirmCallback = null, currentView = localStorage.getItem('promptView') || 'grid', activeTagFilter = null, longPressTimer, wasLongPress = false;
        let currentTags = []; // For the new tag input system
        
        const getPrompts = () => JSON.parse(localStorage.getItem('prompts') || '[]');
        const savePrompts = (data) => localStorage.setItem('prompts', JSON.stringify(data));
        const pinIconHTML = `<i class="fa-solid fa-thumbtack"></i>`;

        // --- NEW TAG INPUT SYSTEM ---
        const removeTag = (tagToRemove) => { currentTags = currentTags.filter(tag => tag !== tagToRemove); renderTagPills(); };
        const addTag = (tagToAdd) => { const cleanedTag = tagToAdd.trim(); if (cleanedTag.length > 0 && !currentTags.includes(cleanedTag)) { currentTags.push(cleanedTag); } };
        const renderTagPills = () => {
            tagPillsContainer.innerHTML = '';
            currentTags.forEach(tag => {
                const pill = document.createElement('div');
                pill.className = 'tag-pill';
                pill.innerHTML = `<span>${tag}</span><button type="button" class="tag-pill-remove interactive-scale">&times;</button>`;
                pill.querySelector('.tag-pill-remove').addEventListener('click', () => removeTag(tag));
                tagPillsContainer.appendChild(pill);
            });
        };

        // --- THEME MANAGEMENT ---
        const applyTheme = (theme) => {
            localStorage.setItem('theme', theme);
            themeToggleBtn.innerHTML = theme === 'dark'
                ? `<i class="fa-solid fa-moon"></i><span>Dark Mode</span>`
                : `<i class="fa-solid fa-sun"></i><span>Light Mode</span>`;
            document.documentElement.className = theme;
        };
        const toggleTheme = () => applyTheme(localStorage.getItem('theme') === 'dark' ? 'light' : 'dark');
        
        // --- UI RENDERING ---
        const renderAll = () => { renderPrompts(searchInput.value); renderTags(); };
        const renderPrompts = (textFilter = '') => {
            library.innerHTML = '';
            const lowerTextFilter = textFilter.toLowerCase();
            const filteredPrompts = prompts.filter(p => (p.name.toLowerCase().includes(lowerTextFilter) || p.prompt.toLowerCase().includes(lowerTextFilter)) && (activeTagFilter ? p.tags.includes(activeTagFilter) : true));
            library.className = currentView === 'grid' ? 'grid grid-cols-2 sm:grid-cols-3 gap-4' : 'space-y-3';
            emptyState.classList.toggle('hidden', prompts.length > 0);
            filteredPrompts.sort((a, b) => (b.pinned || 0) - (a.pinned || 0) || b.id - a.id).forEach((prompt, index) => {
                const card = document.createElement('div');
                card.dataset.id = prompt.id;
                card.style.animationDelay = `${index * 40}ms`;
                const pinElement = prompt.pinned ? `<div class="absolute top-2 left-2 text-sky-400">${pinIconHTML}</div>` : '';
                if (currentView === 'grid') {
                    card.className = 'glassmorphism rounded-lg overflow-hidden relative group aspect-square flex flex-col justify-end p-3 text-white cursor-pointer card-pop-in';
                    const imageUrl = prompt.image || `https://placehold.co/400x400/${document.documentElement.classList.contains('dark') ? '111827/818cf8' : 'e5e7eb/6366f1'}?text=${encodeURIComponent(prompt.name.charAt(0))}`;
                    card.innerHTML = `<img src="${imageUrl}" class="absolute inset-0 w-full h-full object-cover transition-transform group-hover:scale-110" loading="lazy" onerror="this.src='https://placehold.co/400x400/111827/38bdf8?text=Error';"><div class="absolute inset-0 bg-gradient-to-t from-black/90 to-transparent"></div>${pinElement}<h3 class="relative z-10 font-bold truncate">${prompt.name}</h3><p class="relative z-10 text-xs text-gray-300 truncate">${prompt.tags.join(', ')}</p>`;
                } else {
                    card.className = 'glassmorphism rounded-lg p-3 flex items-center gap-4 cursor-pointer card-pop-in';
                    const imageUrl = prompt.image || `https://placehold.co/100x100/${document.documentElement.classList.contains('dark') ? '1f2937/818cf8' : 'd1d5db/6366f1'}?text=${encodeURIComponent(prompt.name.charAt(0))}`;
                    const pinElementList = prompt.pinned ? `<div class="text-sky-400 flex-shrink-0">${pinIconHTML}</div>` : '';
                    card.innerHTML = `<img src="${imageUrl}" class="w-16 h-16 rounded-md object-cover flex-shrink-0" loading="lazy" onerror="this.src='https://placehold.co/100x100/111827/38bdf8?text=Error';"><div class="flex-grow overflow-hidden"><h3 class="font-bold truncate">${prompt.name}</h3><p class="text-xs muted-text truncate">${prompt.tags.join(', ')}</p><p class="text-sm truncate mt-1">${prompt.prompt}</p></div>${pinElementList}`;
                }
                card.addEventListener('click', () => { if (!wasLongPress) showDetails(prompt.id); wasLongPress = false; });
                card.addEventListener('touchstart', (e) => handleLongPressStart(e, prompt.id), { passive: true });
                card.addEventListener('touchend', handleLongPressEnd);
                card.addEventListener('contextmenu', (e) => { e.preventDefault(); openContextMenu(prompt.id); });
                library.appendChild(card);
            });
        };
        const renderTags = () => {
            const allTags = [...new Set(prompts.flatMap(p => p.tags))];
            tagFiltersContainer.innerHTML = '';
            allTags.forEach(tag => { const tagEl = document.createElement('button'); tagEl.className = `tag-filter px-3 py-1 rounded-full text-sm font-medium mr-2 whitespace-nowrap interactive-scale ${activeTagFilter === tag ? 'active' : 'bg-black/5 dark:bg-white/5 '}`; tagEl.textContent = tag; tagEl.onclick = () => { activeTagFilter = activeTagFilter === tag ? null : tag; renderAll(); }; tagFiltersContainer.appendChild(tagEl); });
        };
        const setView = (view) => {
            currentView = view; localStorage.setItem('promptView', view);
            viewToggleBtn.innerHTML = view === 'grid' ? `<i class="fa-solid fa-list text-xl"></i>` : `<i class="fa-solid fa-grip text-xl"></i>`;
            renderPrompts(searchInput.value);
        };
        const showToast = (message) => { toastMessage.textContent = message; toast.classList.remove('opacity-0', 'translate-y-4'); setTimeout(() => toast.classList.add('opacity-0', 'translate-y-4'), 2000); };
        const handleLongPressStart = (e, id) => { e.preventDefault(); wasLongPress = false; longPressTimer = setTimeout(() => { wasLongPress = true; openContextMenu(id); if (navigator.vibrate) navigator.vibrate(50); }, 500); };
        const handleLongPressEnd = () => clearTimeout(longPressTimer);
        const showGenericModal = (modal) => { genericModalOverlay.classList.remove('hidden'); genericModalOverlay.classList.add('flex', 'fade-in'); modal.classList.remove('hidden'); setTimeout(() => modal.classList.remove('scale-95', 'opacity-0'), 10); };
        const hideGenericModal = (modal) => { modal.classList.add('scale-95', 'opacity-0'); genericModalOverlay.classList.add('fade-out'); setTimeout(() => { genericModalOverlay.classList.add('hidden'); modal.classList.add('hidden'); genericModalOverlay.classList.remove('fade-out'); }, 250); };
        const openConfirmationModal = (message, onConfirm) => { confirmMessage.textContent = message; confirmCallback = onConfirm; showGenericModal(confirmModal); };
        const setActiveTab = (tabName) => { if (tabName === 'prompt') { tabPrompt.classList.add('active'); tabDetails.classList.remove('active'); tabContentPrompt.classList.remove('hidden'); tabContentDetails.classList.add('hidden'); } else { tabDetails.classList.add('active'); tabPrompt.classList.remove('active'); tabContentDetails.classList.remove('hidden'); tabContentPrompt.classList.add('hidden'); } };
        
        const openFormModal = (promptToEdit = null) => {
            formModal.classList.remove('hidden'); formModal.classList.add('flex', 'fade-in');
            formContainer.classList.remove('slide-down'); formContainer.classList.add('slide-up');
            setActiveTab('prompt'); promptForm.reset(); 
            imagePreview.src = 'https://placehold.co/100x100/1f2937/4b5563?text=Image'; imageDataInput.value = ''; promptTagsInput.value = '';
            if (promptToEdit) { 
                formTitle.textContent = 'Edit Prompt'; 
                document.getElementById('prompt-id').value = promptToEdit.id; 
                document.getElementById('prompt-text').value = promptToEdit.prompt; 
                document.getElementById('prompt-name').value = promptToEdit.name; 
                currentTags = [...promptToEdit.tags];
                if (promptToEdit.image) { imageDataInput.value = promptToEdit.image; imagePreview.src = promptToEdit.image; } 
            } else { 
                formTitle.textContent = 'Add New Prompt'; 
                currentTags = [];
            }
            renderTagPills();
        };
        const closeFormModal = () => {
            formContainer.classList.remove('slide-up'); formContainer.classList.add('slide-down'); 
            formModal.classList.add('fade-out'); 
            setTimeout(() => { 
                formModal.classList.add('hidden'); formModal.classList.remove('flex', 'fade-in', 'fade-out'); 
                formContainer.classList.remove('slide-down'); promptForm.reset(); 
            }, 300);
        };
        const showDetails = (id) => {
            const prompt = prompts.find(p => p.id === id); if (!prompt) return; currentEditingId = id;
            document.getElementById('details-image').src = prompt.image || 'https://placehold.co/600x400/111827/38bdf8?text=No+Image';
            document.getElementById('details-name').textContent = prompt.name; document.getElementById('details-prompt').textContent = prompt.prompt;
            const tagsContainer = document.getElementById('details-tags'); tagsContainer.innerHTML = '';
            prompt.tags.forEach(tag => { if (!tag.trim()) return; const tagEl = document.createElement('span'); tagEl.className = 'px-2 py-1 bg-sky-500/20 text-sky-400 text-xs font-medium rounded'; tagEl.textContent = tag; tagsContainer.appendChild(tagEl); });
            copyBtn.innerHTML = '<i class="fa-solid fa-copy"></i> Copy';
            detailsPinBtn.innerHTML = `<div class="w-6 h-6 text-xl flex items-center justify-center pin-icon ${prompt.pinned ? 'pinned' : 'text-white'}">${pinIconHTML}</div>`;
            detailsModal.classList.remove('hidden'); detailsModal.classList.add('flex', 'fade-in'); detailsContainer.classList.remove('scale-95', 'opacity-0');
        };
        const closeDetailsModal = () => { detailsContainer.classList.add('scale-95', 'opacity-0'); detailsModal.classList.add('fade-out'); setTimeout(() => { detailsModal.classList.add('hidden'); detailsModal.classList.remove('flex', 'fade-in', 'fade-out'); }, 250); };
        
        // --- CONTEXT MENU ---
        const openContextMenu = (id) => {
            const prompt = prompts.find(p => p.id === id); if (!prompt) return;
            document.getElementById('context-menu-title').textContent = prompt.name;
            document.getElementById('context-menu-subtitle').textContent = prompt.prompt;
            const optionsContainer = document.getElementById('context-menu-options');
            optionsContainer.innerHTML = '';
            const actions = [
                { text: 'Copy Prompt', icon: `<i class="fa-solid fa-copy"></i>`, action: () => { navigator.clipboard.writeText(prompt.prompt).then(() => showToast('Prompt copied!')); }},
                { text: prompt.pinned ? 'Unpin' : 'Pin to top', icon: `<i class="fa-solid fa-thumbtack"></i>`, action: () => { const idx = prompts.findIndex(p => p.id === id); if (idx > -1) { prompts[idx].pinned = !prompts[idx].pinned; savePrompts(prompts); renderAll(); showToast(prompts[idx].pinned ? 'Prompt pinned!' : 'Prompt unpinned!'); } }},
                { text: 'Duplicate', icon: `<i class="fa-solid fa-clone"></i>`, action: () => { const newPrompt = {...prompt, id: Date.now(), name: `${prompt.name} (Copy)`, pinned: false}; prompts.push(newPrompt); savePrompts(prompts); renderAll(); showToast('Prompt duplicated!'); }},
                { text: 'Edit', icon: `<i class="fa-solid fa-pencil"></i>`, action: () => openFormModal(prompt)},
                { text: 'Delete', icon: `<i class="fa-solid fa-trash-can"></i>`, action: () => { openConfirmationModal('This prompt will be permanently deleted.', () => { prompts = prompts.filter(p => p.id !== id); savePrompts(prompts); renderAll(); showToast('Prompt deleted.'); }); }, isDestructive: true }
            ];
            actions.forEach(action => {
                const button = document.createElement('button');
                button.className = `w-full text-left p-3 rounded-lg font-semibold flex items-center gap-4 interactive-scale ${action.isDestructive ? 'text-red-500 bg-red-500/10 hover:bg-red-500/20' : 'hover:bg-black/5 dark:hover:bg-white/10'}`;
                button.innerHTML = `<div class="w-5 text-center">${action.icon}</div> <span>${action.text}</span>`;
                button.onclick = () => { action.action(); closeContextMenu(); };
                optionsContainer.appendChild(button);
            });
            contextMenuModal.classList.remove('hidden'); contextMenuModal.classList.add('fade-in');
            contextMenuContainer.classList.remove('slide-down'); contextMenuContainer.classList.add('slide-up');
        };
        const closeContextMenu = () => {
            contextMenuModal.classList.add('fade-out'); contextMenuContainer.classList.add('slide-down');
            setTimeout(() => { contextMenuModal.classList.add('hidden'); contextMenuModal.classList.remove('fade-out'); }, 300);
        };
        const backupData = () => { const dataStr = JSON.stringify(prompts, null, 2); const blob = new Blob([dataStr], {type: "application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `promptvault_backup_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); showToast('Backup downloaded!'); };
        const restoreData = (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const restored = JSON.parse(e.target.result); if (Array.isArray(restored)) { openConfirmationModal('This will overwrite all current prompts. Continue?', () => { prompts = restored; savePrompts(prompts); renderAll(); showToast('Library restored!'); hideGenericModal(confirmModal); }); } else { showToast('Invalid backup file.'); } } catch (error) { showToast('Could not read backup file.'); } finally { restoreInput.value = ''; } }; reader.readAsText(file); };
        
        // --- EVENT LISTENERS ---
        fab.addEventListener('click', () => openFormModal());
        cancelBtn.addEventListener('click', closeFormModal);
        formModal.addEventListener('click', e => e.target === formModal && closeFormModal());
        tabPrompt.addEventListener('click', () => setActiveTab('prompt'));
        tabDetails.addEventListener('click', () => setActiveTab('details'));
        pasteBtn.addEventListener('click', async () => { try { const text = await navigator.clipboard.readText(); document.getElementById('prompt-text').value = text; showToast('Pasted from clipboard!'); setActiveTab('details'); } catch (err) { showToast('Failed to paste. Check permissions.'); } });
        imageUploadInput.addEventListener('change', (e) => { const file = e.target.files[0]; if(file) { const reader = new FileReader(); reader.onload = (event) => { imageDataInput.value = event.target.result; imagePreview.src = event.target.result; }; reader.readAsDataURL(file); } });
        closeDetailsBtn.addEventListener('click', closeDetailsModal);
        detailsModal.addEventListener('click', e => e.target === detailsModal && closeDetailsModal());
        promptForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('prompt-id').value;
            const promptData = { prompt: document.getElementById('prompt-text').value.trim(), name: document.getElementById('prompt-name').value.trim() || 'Untitled Prompt', image: imageDataInput.value.trim(), tags: currentTags, pinned: false };
            if (!promptData.prompt) return showToast('Prompt text cannot be empty!');
            if (id) { const index = prompts.findIndex(p => p.id == id); if (index > -1) { promptData.pinned = prompts[index].pinned || false; prompts[index] = { ...prompts[index], ...promptData }; } showToast('Prompt Updated!'); } else { promptData.id = Date.now(); prompts.push(promptData); showToast('Prompt Saved!'); }
            savePrompts(prompts); renderAll(); closeFormModal();
        });
        searchInput.addEventListener('input', e => renderPrompts(e.target.value));
        copyBtn.addEventListener('click', () => { navigator.clipboard.writeText(document.getElementById('details-prompt').textContent).then(() => { copyBtn.innerHTML = '<i class="fa-solid fa-check"></i> Copied!'; showToast('Prompt copied!'); }, () => showToast('Failed to copy!')); });
        shareBtn.addEventListener('click', async () => { try { if (navigator.share) await navigator.share({ title: `AI Prompt: ${document.getElementById('details-name').textContent}`, text: document.getElementById('details-prompt').textContent }); else showToast('Share API not supported.'); } catch (err) { showToast('Error sharing prompt.'); } });
        deleteBtn.addEventListener('click', () => { openConfirmationModal('This prompt will be permanently deleted.', () => { if (currentEditingId) { prompts = prompts.filter(p => p.id !== currentEditingId); savePrompts(prompts); renderAll(); closeDetailsModal(); showToast('Prompt deleted.'); } hideGenericModal(confirmModal); }); });
        editBtn.addEventListener('click', () => { const promptToEdit = prompts.find(p => p.id === currentEditingId); if(promptToEdit) { closeDetailsModal(); setTimeout(() => openFormModal(promptToEdit), 150); } });
        duplicateBtn.addEventListener('click', () => {
            const promptToDuplicate = prompts.find(p => p.id === currentEditingId);
            if (!promptToDuplicate) return;
            const newPrompt = { ...promptToDuplicate, id: Date.now(), name: `${promptToDuplicate.name} (Copy)`, pinned: false };
            prompts.push(newPrompt);
            savePrompts(prompts);
            renderAll();
            closeDetailsModal();
            showToast('Prompt duplicated!');
        });
        detailsPinBtn.addEventListener('click', () => { const index = prompts.findIndex(p => p.id === currentEditingId); if (index > -1) { prompts[index].pinned = !prompts[index].pinned; savePrompts(prompts); showDetails(currentEditingId); renderAll(); showToast(prompts[index].pinned ? 'Prompt pinned!' : 'Prompt unpinned!'); } });
        settingsBtn.addEventListener('click', () => showGenericModal(settingsModal));
        closeSettingsBtn.addEventListener('click', () => hideGenericModal(settingsModal));
        aboutBtn.addEventListener('click', () => { hideGenericModal(settingsModal); setTimeout(() => showGenericModal(aboutModal), 300); });
        closeAboutBtn.addEventListener('click', () => hideGenericModal(aboutModal));
        genericModalOverlay.addEventListener('click', e => { if (e.target === genericModalOverlay) { hideGenericModal(settingsModal); hideGenericModal(aboutModal); hideGenericModal(confirmModal); } });
        confirmCancelBtn.addEventListener('click', () => hideGenericModal(confirmModal));
        confirmOkBtn.addEventListener('click', () => { if (typeof confirmCallback === 'function') confirmCallback(); });
        backupBtn.addEventListener('click', backupData);
        restoreBtn.addEventListener('click', () => restoreInput.click());
        restoreInput.addEventListener('change', restoreData);
        viewToggleBtn.addEventListener('click', () => setView(currentView === 'grid' ? 'list' : 'grid'));
        themeToggleBtn.addEventListener('click', toggleTheme);
        contextMenuCancel.addEventListener('click', closeContextMenu);
        contextMenuModal.addEventListener('click', (e) => { if(e.target === contextMenuModal) closeContextMenu(); });
        promptTagsInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); addTag(promptTagsInput.value); renderTagPills(); promptTagsInput.value = ''; } });
        promptTagsInput.addEventListener('paste', (e) => { e.preventDefault(); const pastedText = e.clipboardData.getData('text'); const pastedTags = pastedText.split(/[,;\n]/).map(t => t.trim()).filter(Boolean); pastedTags.forEach(tag => addTag(tag)); renderTagPills(); promptTagsInput.value = ''; });

        // --- INITIALIZATION ---
        const initialTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        applyTheme(initialTheme);
        prompts = getPrompts();
        setView(currentView);
        renderAll();
    });
</script>
</body>
</html>