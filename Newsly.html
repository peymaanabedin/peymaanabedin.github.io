<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <!-- جلوگیری از ایندکس شدن در موتورهای جستجو -->
    <meta name="robots" content="noindex, nofollow" />
    <title>آخرین خبر</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <!-- App Icon & PWA -->
    <link rel="icon" type="image/png" sizes="192x192" href="https://i.ibb.co/CpfLvZLq/App-Icon-2x.png" />
    <link rel="apple-touch-icon" href="https://i.ibb.co/CpfLvZLq/App-Icon-2x.png" />
    <meta name="theme-color" content="#2563eb" />
    <link rel="manifest" href="manifest.json" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <style>
      /* ---------- CSS VARIABLES ---------- */
      :root {
        --tweet-font-size-small: 13px;
        --tweet-font-size-medium: 15px;
        --tweet-font-size-large: 18px;
        --tweet-font-size-xlarge: 21px;
        --tweet-font-size: var(--tweet-font-size-medium);
      }
      html {
        scroll-behavior: smooth;
      }
      body {
        font-family: "Inter", "Vazirmatn", sans-serif;
        background: #f6f8fc;
        font-size: var(--tweet-font-size);
      }
      .dark body {
        background: #141925;
        color: #bdbdbd;
      }

      /* فرم لاگین */
      #login-container {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
      }

      /* کارت توییت */
      .tweet-card {
        animation: fadeInUp 0.45s cubic-bezier(0.23, 1.04, 0.36, 1) both;
        opacity: 0;
        border-radius: 1.13rem;
        margin-bottom: 1.02rem;
        box-shadow: 0 2px 18px 0 #0001;
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(10px) saturate(110%) contrast(1.03);
        -webkit-backdrop-filter: blur(10px) saturate(110%) contrast(1.03);
        border: 1.5px solid #f2f2f6;
      }
      .dark .tweet-card .tweet-author {
        color: #fff !important;
      }
      .dark .tweet-card .tweet-text {
        color: #e7edfa !important;
      }
      .dark .app-title {
        color: #fff !important;
      }
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      /* minimal pulse animation for bell */
      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.08);
        }
        100% {
          transform: scale(1);
        }
      }
      .dark .tweet-card {
        background: rgba(27, 33, 54, 0.95) !important;
        border-color: #25293c;
        box-shadow: 0 2px 18px 0 #0004;
      }
      .rtl {
        direction: rtl;
        font-family: Vazirmatn, sans-serif !important;
      }
      .ltr {
        direction: ltr;
        font-family: Inter, sans-serif !important;
      }
      .tweet-media-img {
        width: 100%;
        max-width: 320px;
        aspect-ratio: 1.15/1;
        height: 185px;
        object-fit: cover;
        border-radius: 0.88rem;
        border: 1px solid #e6e6e6;
        background: #f4f7fa;
        margin: 10px auto 2px auto;
        display: block;
        box-shadow: 0 2px 14px 0 #0002;
        transition: filter 0.15s;
      }
      .tweet-media-img:hover {
        filter: brightness(0.96);
      }
      .tweet-media-video {
        width: 100%;
        max-width: 320px;
        aspect-ratio: 1.15/1;
        height: 185px;
        object-fit: cover;
        border-radius: 0.88rem;
        border: 1px solid #e6e6e6;
        display: block;
        margin: 10px auto 0 auto;
        background: #ddd;
      }
      .dark .tweet-media-img,
      .dark .tweet-media-video {
        border-color: #232f41;
        background: #212941;
      }
      #ptr-container {
        transition: height 0.32s;
        overflow: hidden;
      }
      #ptr-icon {
        transition: transform 0.3s;
      }
      .header-glass {
        background: rgba(255, 255, 255, 0.78);
        backdrop-filter: blur(30px) saturate(130%) contrast(1.08);
        -webkit-backdrop-filter: blur(30px) saturate(130%) contrast(1.08);
        box-shadow: 0 3px 36px 0 #0001, 0 1.5px 0 #d3d8e6;
        border-radius: 0 0 2rem 2rem;
      }
      .dark .header-glass {
        background: rgba(22, 27, 44, 0.9);
        backdrop-filter: blur(32px) saturate(140%) contrast(1.1);
        -webkit-backdrop-filter: blur(32px) saturate(140%) contrast(1.1);
        box-shadow: 0 3px 24px 0 #0005, 0 1.5px 0 #242f41;
      }
      .app-title {
        font-weight: 700;
        letter-spacing: 0;
        font-size: 1.11rem;
      }
      .action-btn {
        cursor: pointer;
        font-size: 1.22rem;
        padding: 0.57rem;
        border-radius: 50%;
        border: none;
        background: none;
        transition: background 0.18s, color 0.15s;
        margin-left: 0.13rem;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .action-btn.active,
      .action-btn:hover {
        background: #e6ecf5;
      }
      .dark .action-btn.active,
      .dark .action-btn:hover {
        background: #2c3953;
      }
      .action-btn.selected {
        color: #2563eb !important;
        background: #c7e1ff;
      }
      .dark .action-btn.selected {
        color: #60a5fa !important;
        background: #293b56;
      }
      .tweet-card.compact .tweet-media-img,
      .tweet-card.compact .tweet-media-video {
        display: none !important;
      }
      .tweet-meta-bar {
        font-size: 0.98rem;
      }
      .tweet-card .tweet-author {
        font-size: 14.3px;
      }
      .bookmark-btn {
        color: #a1adc9;
        font-size: 1.1rem;
        border: none;
        background: transparent;
        border-radius: 50%;
        padding: 0.3rem;
        cursor: pointer;
        transition: color 0.16s, background 0.13s;
      }
      .bookmark-btn.active {
        color: #eab308;
      }
      .bookmark-btn:hover {
        background: #eef0f7;
      }
      .dark .bookmark-btn:hover {
        background: #23283b;
      }
      #searchBar {
        border-radius: 1.3rem;
        background: rgba(244, 245, 250, 0.76);
        border: 1.3px solid #e0e4ea;
        margin: 12px auto 3px auto;
        font-size: 15px;
        font-family: Vazirmatn, Inter;
        width: 100%;
        padding: 0.7rem 2.5rem 0.7rem 1.2rem;
        box-shadow: 0 1px 10px #0000;
        outline: 0;
        color: #40495c;
        transition: 0.16s;
        display: block;
      }
      #searchBar:focus {
        background: #fff;
        border-color: #adbeff;
      }
      .dark #searchBar {
        background: rgba(37, 39, 60, 0.93);
        color: #c9d5ff;
        border-color: #29304d;
      }
      #bookmark-section {
        background: rgba(255, 255, 255, 0.97);
        border-radius: 1.3rem;
        padding: 10px 9px 12px 9px;
        margin-top: 18px;
        box-shadow: 0 2px 14px 0 #0001;
        border: 1.5px solid #f1f1f1;
      }
      .dark #bookmark-section {
        background: rgba(31, 37, 53, 0.99);
        border-color: #232942;
      }
      footer {
        direction: rtl;
        padding: 14px 0 12px 0;
        background: rgba(245, 248, 255, 0.86);
        border-top: 1.5px solid #e8eaee;
        text-align: center;
        font-size: 14px;
        color: #8a98b8;
        font-family: Vazirmatn, Inter, sans-serif;
        margin-top: 48px;
      }
      .dark footer {
        background: rgba(27, 34, 54, 0.96);
        color: #b8bed4;
        border-top: 1.5px solid #232a3a;
      }

      /* === برو بالا === */
      #goTopBtn {
        position: fixed;
        bottom: 24px;
      left: 24px;
right: auto;
     z-index:9999;       /* از هر چیزی بالاتر بایستد */

        width: 36px;
        height: 36px;
        font-size: 1rem;

        border-radius: 50%;
        background: #e5edff;
        color: #2563eb;
        border: none;
        box-shadow: 0 4px 18px #0002;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        opacity: 0;
        pointer-events: none;
        transform: scale(0.8);
        transition: opacity 0.25s ease, transform 0.25s ease;
      }
      #goTopBtn.visible {
        opacity: 1;
        pointer-events: auto;
        transform: scale(1);
      }
      #goTopBtn:active {
        transform: scale(0.9);
      }
      .dark #goTopBtn {
        background: #27334d;
        color: #7aa5ff;
      }

      /* === دکمه اخبار تازه (با زنگوله شیشه‌ای) === */
      #newUpdatesBtn {
        position: fixed;
        bottom: 72px;
        right: 20px;
        z-index: 90;
        background: rgba(37, 99, 235, 0.7);
        color: #fff;
        border-radius: 9999px;
        padding: 0.48rem 1rem 0.48rem 1.1rem;
        font-size: 13px;
        line-height: 1;
        box-shadow: 0 3px 16px rgba(0, 0, 0, 0.16);
        backdrop-filter: blur(12px) saturate(140%) contrast(1.1);
        -webkit-backdrop-filter: blur(12px) saturate(140%) contrast(1.1);
        border: 1px solid rgba(255, 255, 255, 0.38);
        display: none;
        white-space: nowrap;
        transition: transform 0.25s ease, opacity 0.25s ease;
        align-items: center;
        gap: 0.35rem;
      }
      #newUpdatesBtn:hover {
        transform: translateY(-2px);
        opacity: 0.95;
      }
    #newUpdatesBtn i {
  font-size: 1.15em;
  margin-left: 0.35em;
  color: #fffde4;
  filter: drop-shadow(0 0 4px #fff4);
  animation: pulse 1.3s infinite;
}
      #newUpdatesBtn.pulse {
        animation: pulse 1.6s infinite ease-in-out;
      }
      .dark #newUpdatesBtn {
        background: rgba(51, 75, 255, 0.75);
        border-color: rgba(255, 255, 255, 0.2);
      }

      #lightbox-overlay {
        display: none;
        position: fixed;
        z-index: 1100;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(22, 24, 35, 0.92);
        align-items: center;
        justify-content: center;
        transition: background 0.28s;
      }
      #lightbox-overlay.active {
        display: flex;
      }
      #lightbox-img {
        max-width: 95vw;
        max-height: 84vh;
        border-radius: 1.4rem;
        box-shadow: 0 12px 52px #000b;
        background: #111;
        object-fit: contain;
      }
      #lightbox-close {
        position: absolute;
        top: 24px;
        right: 24px;
        color: #fff;
        font-size: 1.65rem;
        background: rgba(33, 33, 33, 0.14);
        border-radius: 50%;
        border: none;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: 0.16s;
      }
      #lightbox-close:hover {
        background: rgba(222, 222, 222, 0.22);
      }
      #fontSizeMenu {
        display: none;
        position: absolute;
        left: 0;
        right: 0;
        margin: auto;
        top: 52px;
        z-index: 99;
        background: rgba(255, 255, 255, 0.98);
        border-radius: 1.15rem;
        box-shadow: 0 3px 18px #0002;
        width: 250px;
        text-align: center;
        padding: 11px 0 7px 0;
        border: 1px solid #e7e8ee;
      }
      .dark #fontSizeMenu {
        background: #23283b;
        color: #fff;
        border-color: #232942;
      }
      .font-opt {
        display: inline-block;
        cursor: pointer;
        margin: 0 5px;
        font-size: 15px;
        padding: 7px 15px;
        border-radius: 1rem;
      }
      .font-opt.selected,
      .font-opt:hover {
        background: #2563eb;
        color: #fff;
      }
      .dark .font-opt.selected,
      .dark .font-opt:hover {
        background: #3887ff;
        color: #fff;
      }
    </style>
  </head>
  <body>
    <!-- فرم لاگین -->
    <div id="login-container" class="bg-gray-100 dark:bg-gray-900 px-4">
      <form
        id="login-form"
        class="bg-white dark:bg-[#1b2236] p-8 rounded-2xl shadow-xl max-w-xs w-full relative"
      >
        <!-- لوگو و نام برنامه -->
        <div class="flex flex-col items-center mb-6">
          <img
            src="https://i.ibb.co/CpfLvZLq/App-Icon-2x.png"
            alt="app icon"
            class="w-16 h-16 rounded-2xl shadow-lg mb-3"
          />
          <h1
            class="text-2xl font-extrabold text-gray-800 dark:text-gray-100 tracking-tight"
          >
            آخرین خبر
          </h1>
        </div>
        <h2
          class="text-lg font-bold mb-6 text-gray-700 dark:text-gray-200 text-center"
        >
          ورود به حساب کاربری
        </h2>
        <div class="mb-4">
          <label
            class="block text-gray-700 dark:text-gray-300 mb-1 text-sm"
            for="username"
            >نام کاربری</label
          >
          <input
            id="username"
            type="text"
            class="w-full p-3 rounded-lg border focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-[#232b46] dark:border-[#29304d]"
            autocomplete="username"
            required
          />
        </div>
        <div class="mb-6">
          <label
            class="block text-gray-700 dark:text-gray-300 mb-1 text-sm"
            for="password"
            >رمز عبور</label
          >
          <input
            id="password"
            type="password"
            class="w-full p-3 rounded-lg border focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-[#232b46] dark:border-[#29304d]"
            autocomplete="current-password"
            required
          />
        </div>
        <button
          type="submit"
          class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg transition shadow-md"
        >
          ورود
        </button>
        <p id="login-error" class="text-red-500 text-sm mt-4 hidden text-center">
          نام کاربری یا رمز عبور نادرست است.
        </p>
      </form>
    </div>

    <!-- اپلیکیشن اصلی -->
    <div id="main-app" style="display: none">
      <div class="container mx-auto max-w-xl sm:px-0 px-1">
        <header class="flex justify-between items-center px-3 pt-5 pb-3 sticky top-0 header-glass backdrop-blur-2xl z-30 relative">
          <span class="app-title text-gray-800 dark:text-gray-50 tracking-tight flex items-center gap-2">
            <img src="https://i.ibb.co/CpfLvZLq/App-Icon-2x.png" style="width: 1.7em;height: 1.7em;border-radius: 15%;box-shadow: 0 0 7px #6a95d7;" alt="app icon" />
            آخرین خبر
          </span>
          <div class="flex items-center gap-1">
            <button id="bookmark-btn" class="action-btn" title="مشاهده بوکمارک‌ها"><i class="fa-solid fa-bookmark"></i></button>
            <button id="font-btn" class="action-btn" title="سایز فونت"><i class="fa-solid fa-font"></i></button>
            <button id="mode-btn" class="action-btn" title="تم تیره/روشن"><i class="fa-solid fa-moon" id="mode-dark"></i><i class="fa-solid fa-sun hidden" id="mode-light"></i></button>
            <button id="view-btn" class="action-btn" title="حالت فشرده/کامل"><i class="fa-solid fa-align-left" id="view-full"></i><i class="fa-solid fa-align-justify hidden" id="view-compact"></i></button>
            <button id="refresh-btn" class="action-btn" title="رفرش اخبار"><i class="fa-solid fa-rotate-right"></i></button>
            <button id="logout-btn" class="action-btn" title="خروج"><i class="fa-solid fa-right-from-bracket"></i></button>
          </div>
          <div id="fontSizeMenu">
            <span class="font-opt" data-size="small" style="font-size: 13px">کوچک</span>
            <span class="font-opt" data-size="medium" style="font-size: 15px">متوسط</span>
            <span class="font-opt" data-size="large" style="font-size: 18px">بزرگ</span>
            <span class="font-opt" data-size="xlarge" style="font-size: 21px">خیلی بزرگ</span>
          </div>
        </header>
        <input id="searchBar" placeholder="جستجوی زنده در متن اخبار..." autocomplete="off" />
        <div id="bookmark-section" class="hidden"></div>
        <div id="ptr-container" class="w-full" style="height: 0"><div id="ptr-icon" class="w-8 h-8 border-4 border-dashed rounded-full animate-spin mx-auto mt-2" style="border-top-color: #3b82f6"></div></div>
        <main id="feedContainer" class="mt-3 flex flex-col gap-2"></main>
        <div id="loading-spinner" class="flex flex-col items-center justify-center py-8"><div class="w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div><span class="mt-3 text-gray-500 dark:text-gray-300" style="font-size: 14px">در حال بارگذاری...</span></div>
        <div id="error-message" class="hidden bg-red-50 border border-red-300 text-red-700 px-4 py-3 rounded-lg my-4" role="alert"><span id="error-text"></span></div>
      </div>
      <footer>
        <div style="max-width: 560px;margin: 0 auto;line-height: 2;font-size: 14px;">
          <div class="flex justify-center items-center gap-2 mb-2"><img src="https://i.ibb.co/CpfLvZLq/App-Icon-2x.png" style="width: 2em;height: 2em;border-radius: 16%;box-shadow: 0 0 9px #6a95d7;" /></div>
          <b>سلب مسئولیت:</b><br />این اپلیکیشن هیچ یک از اخبار، مطالب، تصاویر یا نظرات نمایش داده شده را تأیید یا تصدیق نمی‌کند و صرفاً بازنشر اتوماتیک محتوا به منظور اطلاع‌رسانی است.<br />این اپلیکیشن هیچ مسئولیتی در قبال صحت، اعتبار، یا محتوای اخبار، مطالب، تصاویر و اظهارنظرهای ارائه‌شده ندارد و تمامی مسئولیت‌ها بر عهده مراجع اصلی یا منتشرکنندگان اولیه آن مطالب می‌باشد.<br />استفاده از داده‌ها و اطلاعات ارائه‌شده صرفاً با مسئولیت شخصی کاربران بوده و هیچ گونه مسئولیتی متوجه این اپلیکیشن نمی‌باشد. هرگونه استناد یا استفاده از اطلاعات این برنامه، به طور کامل بر عهده کاربر است و هیچ حقی علیه اپلیکیشن قابل پیگیری نمی‌باشد.<br /><span style="font-size: 13px; color: #426bba">Copyright © 2025</span>
        </div>
      </footer>
      <!-- Lightbox Overlay -->
      <div id="lightbox-overlay"><img id="lightbox-img" src="" alt="پیش‌نمایش" /><button id="lightbox-close"><i class="fa fa-times"></i></button></div>
      <button id="goTopBtn" aria-label="برو بالا"><i class="fa fa-arrow-up"></i></button>
      <button id="newUpdatesBtn"></button>
    </div>

    <!-- ***** اسکریپت ورود ***** -->
    <script>
      (function () {
        const decodeStr = (s) => atob(s).split("").reverse().join("");
        const ENC_USER = "bmltZGE="; // admin
        const ENC_PASS = "MzIxZHJvd3NzYXA="; // password123
        const ENC_LIST = "T0RJeE5qQTFNalUwT1RFME5EUTVORE01TVE9PQ==";
        

        const decodeList = (s) => atob(atob(s)).split("").reverse().join("");
        const isLoggedIn = () => localStorage.getItem("logged_in") === "true";
        const showApp = () => {
          document.getElementById("login-container").style.display = "none";
          document.getElementById("main-app").style.display = "block";
        };
        const showLogin = () => {
          document.getElementById("login-container").style.display = "flex";
          document.getElementById("main-app").style.display = "none";
        };
        if (isLoggedIn()) showApp(); else showLogin();
        document.getElementById("login-form").addEventListener("submit", (e) => {
          e.preventDefault();
          const u = document.getElementById("username").value.trim();
          const p = document.getElementById("password").value.trim();
          if (u === decodeStr(ENC_USER) && p === decodeStr(ENC_PASS)) {
            localStorage.setItem("logged_in", "true");
            showApp();
            if (typeof startApp === "function") startApp();
          } else {
            document.getElementById("login-error").classList.remove("hidden");
          }
        });
        const logoutBtn = document.getElementById("logout-btn");
        if (logoutBtn) logoutBtn.addEventListener("click", () => {localStorage.removeItem("logged_in");location.reload();});
        window.getListId = () => decodeList(ENC_LIST);
      })();
    </script>

    <!-- ***** اسکریپت اصلی برنامه ***** -->
    <script>
      /* ------------ CONSTANTS ------------ */
      const NITTER_INSTANCES = [
        "https://nitter.pussthecat.org",
        "https://nitter.net",
        "https://nitter.privacydev.net",
        "https://nitter.cz"
      ];
      const CORS_PROXY = "https://api.allorigins.win/raw?url=";
      const AUTO_REFRESH_INTERVAL = 60000; // 60 s
      const INITIAL_PAGE_DEPTH = 1; // fetch 1 pages on hard refresh
      const defaultTitle = document.title;

      /* ------------ APP STATE ------------ */
      let nitterIndex = 0,
        PROXY_URL = NITTER_INSTANCES[nitterIndex];
      let nextCursor = null,
        isLoading = false,
        compactMode = true;
      let allTweets = [],
        filteredTweets = [],
        newTweets = [];
      let tweetsMap = new Map(); // id -> tweet (deduplication)
      let bookmarks = JSON.parse(localStorage.getItem("bookmarkedTweets") || "[]");
      bookmarks.forEach((b) => tweetsMap.set(b.id, b));

      /* ------------ DOM ------------ */
      const feedContainer = document.getElementById("feedContainer");
      const loadingSpinner = document.getElementById("loading-spinner");
      const errorMessage = document.getElementById("error-message");
      const errorText = document.getElementById("error-text");
      const newUpdatesBtn = document.getElementById("newUpdatesBtn");

      /*go top*/
document.getElementById("goTopBtn").onclick = function() {
  window.scrollTo({ top: 0, behavior: "smooth" });
};


      /*  UTILS  */
      const isFa = (t) => /[\u0600-\u06FF]/.test(t);
      const displayError = (msg) => {
        errorText.innerHTML = msg;
        errorMessage.classList.remove("hidden");
        loadingSpinner.classList.add("hidden");
      };
      const hideError = () => errorMessage.classList.add("hidden");
      const showLoading = () => loadingSpinner.classList.remove("hidden");
      const hideLoading = () => loadingSpinner.classList.add("hidden");
      const timeFormat = (ds) => {
        try {
          if (!ds) return "—";
          const d = new Date(ds);
          if (isNaN(d)) return ds;
          return (
            d.toLocaleDateString("fa-IR") +
            "، " +
            d.toLocaleTimeString("fa-IR", { hour: "2-digit", minute: "2-digit" })
          );
        } catch {
          return ds || "—";
        }
      };
      const parseNumber = (node) => {
        if (!node) return "—";
        const v = node.textContent.replace(/[^\d,]/g, "").replace(/,/g, "");
        return v ? parseInt(v, 10) : "—";
      };
      const fallbackImg = (e) => {
        e.target.src = "https://via.placeholder.com/320x180?text=...";
      };

      /* ------------ MERGE & DEDUPLICATE ------------ */
      function mergeNewTweets(list) {
        const added = [];
        list.forEach((t) => {
          if (!tweetsMap.has(t.id)) {
            tweetsMap.set(t.id, t);
            allTweets.push(t);
            added.push(t);
          }
        });
        // sort by id (numerical) descending if numeric, else by dateFull
          // ← این بخش را جایگزین کنید
  allTweets.sort((a, b) => {
    const numA = /^\d+$/.test(a.id) ? BigInt(a.id) : null;
    const numB = /^\d+$/.test(b.id) ? BigInt(b.id) : null;

    if (numA !== null && numB !== null) {
      return numB > numA ? 1 : numB < numA ? -1 : 0;   // جدیدتر بالاتر
    }
    // fallback: مرتب‌سازی بر اساس تاریخ
    return new Date(b.dateFull).getTime() - new Date(a.dateFull).getTime();
  });
        return added;
      }

      /* ------------ RENDER ------------ */
      function renderTweets(tweets) {
        feedContainer.innerHTML = "";
        if (!tweets.length) {
          feedContainer.innerHTML =
            '<div class="px-6 py-12 text-center text-gray-400 dark:text-gray-400">نتیجه‌ای یافت نشد.</div>';
          return;
        }
        tweets.forEach((t) => {
          const c = createTweetCard(t);
          c.style.fontSize = getComputedStyle(document.documentElement).getPropertyValue(
            "--tweet-font-size"
          );
          feedContainer.appendChild(c);
        });
        Array.from(document.getElementsByClassName("tweet-card")).forEach((c) =>
          c.classList.toggle("compact", compactMode)
        );
      }

      function createTweetCard(tweet) {
        const isPersian = isFa(tweet.text);
        const dirClass = isPersian ? "rtl font-vazir" : "ltr";

        /* media html */
        let mediaHtml = "";
        if (tweet.media.images.length) {
          mediaHtml += '<div class="scroll-imgs mt-2 justify-center flex w-full">';
          tweet.media.images.forEach((img) => {
            mediaHtml += `
              <a href="#" data-img="${img}" class="tweet-img-link">
                <img src="${img}" class="tweet-media-img mx-auto" loading="lazy" onerror="fallbackImg(event)" />
              </a>`;
          });
          mediaHtml += "</div>";
        }
        if (tweet.media.videos.length) {
          mediaHtml += `
            <div class="mt-2 flex justify-center">
              <video controls playsinline muted class="tweet-media-video mx-auto" preload="metadata" onerror="this.poster='https://via.placeholder.com/320x180?text=VIDEO';">
                <source src="${tweet.media.videos[0]}" type="video/mp4" />
                ویدیو پشتیبانی نمی‌شود.
              </video>
            </div>`;
        }

        const isBookmarked = bookmarks.some((b) => b.id === tweet.id);

        const card = document.createElement("article");
        card.className =
          "tweet-card bg-white/80 dark:bg-[#1b2236] px-4 py-4 transition hover:shadow-2xl relative";
        card.innerHTML = `
          <div class="flex items-start gap-3">
            <img src="${tweet.user.avatar}" alt="${tweet.user.name}" class="w-11 h-11 rounded-full border shadow" onerror="fallbackImg(event)">
            <div class="flex-1 min-w-0">
              <div class="flex flex-row items-center justify-between">
                <div class="tweet-author font-semibold text-[14.3px] text-gray-900 dark:text-gray-100">
                  ${tweet.user.name}<span class="mx-1 text-gray-400 text-[12.2px]">@${tweet.user.username}</span>
                </div>
                <span class="text-xs text-gray-400 dark:text-gray-400" title="${tweet.dateFull}">${timeFormat(
          tweet.dateFull
        )}</span>
              </div>
              <div class="tweet-text mt-1.5 text-gray-800 dark:text-gray-100 ${dirClass}">${
          tweet.text
        }</div>
              ${mediaHtml}
              <div class="tweet-meta-bar mt-3 flex items-center gap-5 text-xs text-gray-500 dark:text-gray-400 select-none">
                <span title="ریپلای"><i class="fa-regular fa-comment mr-1"></i> ${tweet.replies}</span>
                <span title="ریتوییت"><i class="fa-solid fa-retweet mr-1"></i> ${tweet.reposts}</span>
                <span title="لایک"><i class="fa-regular fa-heart mr-1"></i> ${tweet.likes}</span>
                <span title="ویو"><i class="fa-regular fa-eye mr-1"></i> ${tweet.views}</span>
                <button class="bookmark-btn${isBookmarked ? " active" : ""}" data-tweetid="${
          tweet.id
        }" title="بوکمارک"><i class="fa-solid fa-bookmark"></i></button>
                <a href="https://x.com/${tweet.user.username}/status/${tweet.id}" target="_blank" class="text-blue-400 hover:underline whitespace-nowrap">مشاهده منبع <i class="fa-brands fa-x-twitter"></i></a>
              </div>
            </div>
          </div>`;

        setTimeout(() => (card.style.opacity = "1"), 45);
        card.querySelectorAll(".tweet-img-link").forEach((l) =>
          l.addEventListener("click", (e) => {
            e.preventDefault();
            showLightbox(l.getAttribute("data-img"));
          })
        );
        card.querySelector(".bookmark-btn").onclick = function () {
          const tid = this.getAttribute("data-tweetid");
          if (this.classList.contains("active")) {
            bookmarks = bookmarks.filter((b) => b.id !== tid);
          } else {
            bookmarks.push(tweet);
          }
          localStorage.setItem("bookmarkedTweets", JSON.stringify(bookmarks));
          this.classList.toggle("active");
        };
        return card;
      }

      /* ------------ LIGHTBOX ------------ */
      function showLightbox(src) {
        const overlay = document.getElementById("lightbox-overlay");
        const img = document.getElementById("lightbox-img");
        img.src = src;
        overlay.classList.add("active");
      }
      document.getElementById("lightbox-overlay").onclick = (e) => {
        if (e.target === e.currentTarget || e.target.id === "lightbox-close")
          e.currentTarget.classList.remove("active");
      };

      /* ------------ FETCH HELPERS ------------ */
      async function fetchHTML(url) {
        const r = await fetch(`${CORS_PROXY}${encodeURIComponent(url)}`);
        if (!r.ok) throw new Error("HTTP " + r.status);
        return r.text();
      }

      async function parseTweets(html) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, "text/html");
        const tweetEls = doc.querySelectorAll(".timeline-item:not(.show-more)");
        if (!tweetEls.length) throw new Error("توییتی پیدا نشد.");
        const tweets = [];
        tweetEls.forEach((el) => {
          const avatarNode = el.querySelector(".avatar");
          let avatarUrl = avatarNode ? avatarNode.getAttribute("src") : "";
          if (avatarUrl && !/^https?:\/\//.test(avatarUrl)) avatarUrl = PROXY_URL + avatarUrl;

          const contentNode = el.querySelector(".tweet-content");
          const dateFull =
            el.querySelector(".tweet-date a")?.getAttribute("title") ||
            el.querySelector(".tweet-date time")?.getAttribute("datetime") ||
            "";
          const replies = parseNumber(el.querySelector(".icon-comment")?.parentElement);
          const reposts = parseNumber(el.querySelector(".icon-retweet")?.parentElement);
          const likes = parseNumber(el.querySelector(".icon-heart")?.parentElement);
          let views = "—";
          const viewsEl = el.querySelector(
            ".icon-chart-bar, .fa-chart-bar, .fa-eye, .icon-eye"
          );
          if (viewsEl) views = parseNumber(viewsEl.parentElement);

          const images = [];
          el.querySelectorAll(".attachment.image a").forEach((a) => {
            let src = a.getAttribute("href");
            if (src && !/^https?:\/\//.test(src)) src = PROXY_URL + src;
            images.push(src);
          });
          const videos = [];
          el.querySelectorAll(".attachment.video-container video source").forEach((s) => {
            let src = s.getAttribute("src");
            if (src && !/^https?:\/\//.test(src)) src = PROXY_URL + src;
            videos.push(src);
          });

          const tweetLink = el.querySelector(".tweet-link")?.getAttribute("href") || "";
          const userLink = el.querySelector(".username")?.parentElement?.getAttribute("href") || "";
          const username = el.querySelector(".username")?.textContent.trim().replace("@", "") || "";

          tweets.push({
            id: tweetLink.split("/").pop(),
            user: {
              name: el.querySelector(".fullname")?.textContent.trim() || "",
              username,
              avatar: avatarUrl,
              url: userLink,
            },
            text: contentNode ? contentNode.innerHTML : "",
            dateFull,
            replies,
            reposts,
            likes,
            views,
            media: { images, videos },
          });
        });

        const loadMoreEl = doc.querySelector(".show-more a");
        const cursor = loadMoreEl
          ? new URLSearchParams(loadMoreEl.getAttribute("href").split("?")[1]).get("cursor")
          : null;
        return { tweets, cursor };
      }

      /* ------------ FETCH & BUILD ------------ */
      async function fetchTweetsPage(cursor = null) {
        const listUrl =
          `${PROXY_URL}/i/lists/${getListId()}` + (cursor ? `?cursor=${cursor}` : "");
        const html = await fetchHTML(listUrl);
        return parseTweets(html);
      }

      async function fetchAndParseTweets(cursor = null, depth = 1, retry = true) {
        if (isLoading) return;
        isLoading = true;
        hideError();
        if (!cursor) {
          // hard refresh – reset state
          showLoading();
          feedContainer.innerHTML = "";
          allTweets = [];
          tweetsMap.clear();
        }
        try {
          let localCursor = cursor;
          for (let i = 0; i < depth; i++) {
            const { tweets, cursor: next } = await fetchTweetsPage(localCursor);
            mergeNewTweets(tweets);
            localCursor = next;
            if (!localCursor) break;
          }
          nextCursor = localCursor;
          applyFilters();
        } catch (err) {
          if (retry && nitterIndex < NITTER_INSTANCES.length - 1) {
            nitterIndex++;
            PROXY_URL = NITTER_INSTANCES[nitterIndex];
            setTimeout(() => fetchAndParseTweets(cursor, depth, false), 900);
          } else {
            displayError(err.message || "بارگذاری ناموفق بود.");
          }
        } finally {
          isLoading = false;
          hideLoading();
          document.getElementById("ptr-container").style.height = "0";
        }
      }

      /* ------------ SEARCH / FILTER ------------ */
      function applyFilters() {
        const q = document.getElementById("searchBar").value.toLowerCase().trim();
        filteredTweets = allTweets.filter((t) => {
          const clean = t.text.replace(/<[^>]+>/g, "").toLowerCase();
          return !q || clean.includes(q);
        });
        renderTweets(filteredTweets);
      }
      document.getElementById("searchBar").oninput = applyFilters;

      /* ------------ UI CONTROLS ------------ */
      // Compact / full view
      const viewBtn = document.getElementById("view-btn");
      const viewFull = document.getElementById("view-full");
      const viewCompactIcon = document.getElementById("view-compact");
      function updateCompactView() {
        compactMode = !compactMode;
        renderTweets(filteredTweets);
        viewCompactIcon.classList.toggle("hidden", !compactMode);
        viewFull.classList.toggle("hidden", compactMode);
        viewBtn.classList.toggle("selected", compactMode);
      }
      viewBtn.onclick = updateCompactView;

      // Manual refresh
      document.getElementById("refresh-btn").onclick = () => {
        nextCursor = null;
        nitterIndex = 0;
        PROXY_URL = NITTER_INSTANCES[0];
        fetchAndParseTweets(null, INITIAL_PAGE_DEPTH);
      };



      // Infinite scroll
// Infinite scroll & show goTopBtn
window.addEventListener("scroll", () => {
  // نمایش دکمه برو بالا همیشه
  document.getElementById("goTopBtn").classList.toggle("visible", window.scrollY > 400);

  // اینفینیت اسکرول فقط اگر لازم بود
  if (isLoading || !nextCursor) return;
  if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 700)
    fetchAndParseTweets(nextCursor, 1);
});


      // Pull-to-refresh (touch)
      const ptrContainer = document.getElementById("ptr-container");
      let startY = 0,
        pullDistance = 0,
        ptrThreshold = 70;
      document.body.addEventListener(
        "touchstart",
        (e) => {
          if (window.scrollY === 0) startY = e.touches[0].pageY;
        },
        { passive: true }
      );
      document.body.addEventListener(
        "touchmove",
        (e) => {
          if (window.scrollY === 0 && startY > 0) {
            const y = e.touches[0].pageY;
            pullDistance = Math.max(0, y - startY);
            if (pullDistance) ptrContainer.style.height = `${Math.min(pullDistance, ptrThreshold)}px`;
          }
        },
        { passive: true }
      );
      document.body.addEventListener("touchend", () => {
        if (pullDistance >= ptrThreshold) {
          ptrContainer.style.height = `${ptrThreshold}px`;
          nextCursor = null;
          nitterIndex = 0;
          PROXY_URL = NITTER_INSTANCES[0];
          fetchAndParseTweets(null, INITIAL_PAGE_DEPTH);
        } else ptrContainer.style.height = "0";
        startY = pullDistance = 0;
      });

      /* ------------ BOOKMARKS ------------ */
      document.getElementById("bookmark-btn").onclick = () => {
        const sec = document.getElementById("bookmark-section");
        if (sec.classList.contains("hidden")) {
          sec.classList.remove("hidden");
          sec.innerHTML =
            "<h3 class='mb-2 font-bold text-sm text-blue-700 dark:text-blue-200'>توییت‌های بوکمارک‌شده:</h3>";
          if (!bookmarks.length)
            sec.innerHTML +=
              "<div class='text-gray-400 dark:text-gray-400 text-center'>هنوز هیچ توییتی بوکمارک نشده.</div>";
          bookmarks.forEach((t) => {
            const c = createTweetCard(t);
            c.style.fontSize = getComputedStyle(document.documentElement).getPropertyValue(
              "--tweet-font-size"
            );
            sec.appendChild(c);
          });
          window.scrollTo({ top: 0, behavior: "smooth" });
        } else {
          sec.classList.add("hidden");
          sec.innerHTML = "";
        }
      };

      /* ------------ FONT SIZE ------------ */
      const fontSizeKey = "newsFontSize";
      const defaultFont = "medium";
      const fontSizes = {
        small: "var(--tweet-font-size-small)",
        medium: "var(--tweet-font-size-medium)",
        large: "var(--tweet-font-size-large)",
        xlarge: "var(--tweet-font-size-xlarge)",
      };
      let fontSize = localStorage.getItem(fontSizeKey) || defaultFont;
      function setFontSize(size) {
        fontSize = size;
        localStorage.setItem(fontSizeKey, size);
        document.body.style.setProperty("--tweet-font-size", fontSizes[size]);
        Array.from(document.getElementsByClassName("tweet-card")).forEach((c) =>
          (c.style.fontSize = fontSizes[size])
        );
        applyFontMenuState();
      }
      function applyFontMenuState() {
        document.querySelectorAll(".font-opt").forEach((o) => {
          o.classList.toggle("selected", o.getAttribute("data-size") === fontSize);
        });
      }
      setFontSize(fontSize);
      const fontBtn = document.getElementById("font-btn"),
        fontSizeMenu = document.getElementById("fontSizeMenu");
      fontBtn.onclick = (e) => {
        fontSizeMenu.style.display = fontSizeMenu.style.display === "block" ? "none" : "block";
        applyFontMenuState();
        e.stopPropagation();
      };
      fontSizeMenu.querySelectorAll(".font-opt").forEach((opt) =>
        (opt.onclick = () => {
          setFontSize(opt.getAttribute("data-size"));
          fontSizeMenu.style.display = "none";
        })
      );
      document.body.addEventListener("click", (e) => {
        if (!fontSizeMenu.contains(e.target) && e.target !== fontBtn)
          fontSizeMenu.style.display = "none";
      });

      /* ------------ THEME ------------ */
      const html = document.documentElement;
      const modeBtn = document.getElementById("mode-btn");
      const modeDark = document.getElementById("mode-dark");
      const modeLight = document.getElementById("mode-light");
      function applyTheme(theme) {
        if (theme === "dark") {
          html.classList.add("dark");
          modeDark.classList.add("hidden");
          modeLight.classList.remove("hidden");
        } else {
          html.classList.remove("dark");
          modeLight.classList.add("hidden");
          modeDark.classList.remove("hidden");
        }
      }
      modeBtn.onclick = () => {
        const t = html.classList.contains("dark") ? "light" : "dark";
        localStorage.setItem("theme", t);
        applyTheme(t);
      };

      /* ------------ AUTO REFRESH ------------ */
      async function checkForUpdates() {
        if (isLoading) return;
        try {
          const { tweets: latest } = await fetchTweetsPage();
          const unseen = latest.filter((t) => !tweetsMap.has(t.id));
          if (unseen.length) {
            newTweets.unshift(...unseen);
            newUpdatesBtn.innerHTML = `<i class="fa fa-bell"></i> ${newTweets.length} خبر جدید`;

            newUpdatesBtn.style.display = "inline-flex";
              document.title = `(${newTweets.length}) خبر جدید - ${defaultTitle}`;

          }
        } catch (e) {
          // silent
        }
      }
      setInterval(checkForUpdates, AUTO_REFRESH_INTERVAL);
newUpdatesBtn.onclick = () => {
  newUpdatesBtn.style.display = "none";
  newTweets = [];
  nextCursor = null;
  nitterIndex = 0;
  PROXY_URL = NITTER_INSTANCES[0];
  fetchAndParseTweets(null, INITIAL_PAGE_DEPTH);  // رفرش کامل فید
  window.scrollTo({ top: 0, behavior: "smooth" });
    document.title = defaultTitle;

};


      /* ------------ START APP AFTER LOGIN ------------ */
      function startApp() {
        // Apply theme immediately
        applyTheme(
          localStorage.getItem("theme") ||
            (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light")
        );
        // Initial fetch
        fetchAndParseTweets(null, INITIAL_PAGE_DEPTH);
      }
      // If already logged in on load
      if (localStorage.getItem("logged_in") === "true") startApp();


      function showLoadingAtEnd() {
  loadingSpinner.style.display = "flex";
}
function hideLoadingAtEnd() {
  loadingSpinner.style.display = "none";
}



    </script>

    <!-- PWA Service Worker -->
    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker.register("sw.js").catch(() => {});
        });
      }
    </script>

  </body>
</html>
