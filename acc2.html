<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />

    <title>Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø§Ù„ÛŒ Ø´Ø®ØµÛŒ Ø¬Ø§Ù…Ø¹</title>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <link
      href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css"
      rel="stylesheet"
      type="text/css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css"
    />

    <style>
      :root {
        /* Color Palette (iOS Inspired) */
        --blue-ios: #007aff;
        --blue-ios-hover: #0056b3;
        --green-ios: #34c759;
        --red-ios: #ff3b30;
        --orange-ios: #ff9500;
        --purple-ios: #af52de;
        --cyan-ios: #32adea;
        --gray-100: #f8f9fa;
        --gray-200: #e9ecef;
        --gray-300: #dee2e6;
        --gray-400: #ced4da;
        --gray-500: #adb5bd;
        --gray-600: #6c757d;
        --gray-700: #495057;
        --gray-800: #343a40;
        --gray-900: #212529;

        --bg-light: #f2f2f7;
        --card-light: #ffffff;
        --text-light: #000000;
        --subtext-light: #6e6e73;
        --border-light: rgba(60, 60, 67, 0.29);
        --bg-dark: #000000;
        --card-dark: #1c1c1e;
        --text-dark: #ffffff;
        --subtext-dark: #8e8e93;
        --border-dark: rgba(84, 84, 88, 0.65);

        --primary: var(--blue-ios);
        --primary-hover: var(--blue-ios-hover);
        --income: var(--green-ios);
        --expense: var(--red-ios);
        --transfer: var(--orange-ios);
        --debt: var(--red-ios);
        --receivable: var(--green-ios);
        --loan: var(--purple-ios);
        --goal: var(--cyan-ios);

        --income-bg-light: rgba(52, 199, 89, 0.15);
        --expense-bg-light: rgba(255, 59, 48, 0.15);
        --income-bg-dark: rgba(52, 199, 89, 0.2);
        --expense-bg-dark: rgba(255, 69, 58, 0.2);

        --font-family: "Vazirmatn", -apple-system, BlinkMacSystemFont,
          "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        --radius: 12px;
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        --transition-fast: all 0.2s ease-out;
        --transition-medium: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);

        /* Safe Area Insets for iPhone X+ */
        --safe-area-top: env(safe-area-inset-top, 0px);
        --safe-area-bottom: env(safe-area-inset-bottom, 0px);
        --header-height: 50px;
        --nav-height: 70px;
      }

      /* FIX: PWA Fullscreen Layout */
      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overscroll-behavior-y: contain; /* Prevents pull-to-refresh in PWA */
      }

      body {
        font-family: var(--font-family);
        background-color: var(--bg-light);
        color: var(--text-light);
        transition: background-color 0.3s, color 0.3s;
      }

      .app-wrapper {
        display: flex;
        flex-direction: column;
        height: 100vh; /* Fallback */
        height: -webkit-fill-available; /* Critical for iOS PWA */
        overflow: hidden; /* Prevent wrapper from scrolling */
      }

      body.dark-mode {
        --bg-light: var(--bg-dark);
        --card-light: var(--card-dark);
        --text-light: var(--text-dark);
        --subtext-light: var(--subtext-dark);
        --border-light: var(--border-dark);
        --income-bg-light: var(--income-bg-dark);
        --expense-bg-light: var(--expense-bg-dark);
      }

      body.modal-open {
        overflow: hidden;
      }

      /* --- APP STRUCTURE --- */
      .app-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: calc(var(--header-height) + var(--safe-area-top));
        padding: var(--safe-area-top) 1rem 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        z-index: 100;
        background-color: rgba(242, 242, 247, 0.8);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-bottom: 1px solid var(--border-light);
        transition: var(--transition-fast);
      }
      body.dark-mode .app-header {
        background-color: rgba(28, 28, 30, 0.75);
      }
      #app-header-title {
        font-size: 1.1rem;
        font-weight: 600;
        padding: 0 1rem;
      }

      .header-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem; /* Adjusted gap */
      }
      .header-controls > .fas,
      .header-controls .theme-switcher {
        color: var(--subtext-light);
        cursor: pointer;
        font-size: 1.2rem; /* Unified icon size */
        width: 44px;
        height: 44px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: color var(--transition-fast);
      }
      .header-controls > .fas:hover,
      .header-controls .theme-switcher:hover {
        color: var(--primary);
      }

      .app-content {
        flex: 1;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding: calc(var(--header-height) + var(--safe-area-top) + 1.25rem)
          1rem calc(var(--nav-height) + var(--safe-area-bottom) + 1.25rem);
      }

      .page {
        display: none;
        animation-duration: 0.4s;
        animation-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
      }
      .page.active {
        display: block;
        animation-name: fadeIn;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: scale(0.98);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      .card-section {
        background-color: var(--card-light);
        padding: 1.25rem;
        border-radius: var(--radius);
        margin-bottom: 1.25rem;
      }
      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.25rem;
      }
      .section-header h3 {
        margin: 0;
        font-size: 1.2rem;
        font-weight: 600;
      }

      .btn {
        padding: 0.75rem 1.25rem;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition-fast);
        font-family: var(--font-family);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }
      .btn-primary {
        background-color: var(--primary);
        color: white;
      }
      .btn-danger {
        background-color: var(--expense);
        color: white;
      }
      .btn-secondary {
        background-color: var(--gray-200);
        color: var(--text-light);
      }
      body.dark-mode .btn-secondary {
        background-color: var(--gray-800);
        color: var(--text-dark);
      }
      .btn-success {
        background-color: var(--income);
        color: white;
      }

      .main-balance {
        background: linear-gradient(135deg, var(--blue-ios), #5856d6);
        color: white;
        padding: 1.5rem;
        text-align: center;
      }
      .main-balance .balance-title {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        margin-bottom: 0.5rem;
      }
      .main-balance h4 {
        margin: 0;
        font-weight: 500;
        opacity: 0.8;
        font-size: 0.9rem;
      }
      .main-balance h1 {
        margin: 0;
        font-size: 2.5rem;
        letter-spacing: -1px;
        min-height: 48px;
      }
      #toggle-balance-visibility {
        cursor: pointer;
        opacity: 0.8;
        transition: var(--transition-fast);
      }

      .summary-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }
      .summary-card {
        background-color: var(--bg-light);
        border-radius: var(--radius);
        padding: 1rem;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }
      body.dark-mode .summary-card {
        background-color: var(--gray-900);
      }
      .summary-card .card-header {
        display: flex;
        align-items: center;
        gap: 0.6rem;
        margin-bottom: 0;
      }
      .summary-card .card-icon {
        font-size: 0.9rem;
        width: 2rem;
        height: 2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius);
      }
      .summary-card .card-title {
        font-weight: 500;
        color: var(--subtext-light);
        font-size: 0.85rem;
      }
      .summary-card .card-amount {
        font-size: 1.3rem;
        font-weight: 600;
        color: var(--text-light);
        text-align: right;
        width: 100%;
      }

      .summary-card.income .card-icon {
        background-color: var(--income-bg-light);
        color: var(--income);
      }
      .summary-card.expense .card-icon {
        background-color: var(--expense-bg-light);
        color: var(--expense);
      }
      .summary-card.debt .card-icon {
        background-color: var(--expense-bg-light);
        color: var(--debt);
      }
      .summary-card.receivable .card-icon {
        background-color: var(--income-bg-light);
        color: var(--receivable);
      }
      .summary-card.loan .card-icon {
        background-color: rgba(175, 82, 222, 0.15);
        color: var(--loan);
      }

      .quick-actions {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
      }
      .action-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        padding: 1rem;
        border-radius: var(--radius);
        cursor: pointer;
        transition: var(--transition-fast);
      }
      .action-card:active {
        background-color: var(--gray-200);
      }
      body.dark-mode .action-card:active {
        background-color: var(--gray-800);
      }
      .action-card i {
        font-size: 1.5rem;
      }
      .action-card span {
        font-size: 0.8rem;
        font-weight: 500;
      }
      .action-card.income i {
        color: var(--income);
      }
      .action-card.expense i {
        color: var(--expense);
      }
      .action-card.debt i {
        color: var(--debt);
      }
      .action-card.receivable i {
        color: var(--receivable);
      }

      .form-control {
        width: 100%;
        padding: 0.8rem;
        border: 1px solid var(--border-light);
        border-radius: 8px;
        background-color: var(--gray-200);
        color: var(--text-light);
        box-sizing: border-box;
        transition: var(--transition-fast);
        font-family: var(--font-family);
        font-size: 16px;
      }
      body.dark-mode .form-control {
        background-color: var(--gray-800);
      }
      .form-control:focus {
        border-color: var(--primary);
        outline: none;
        background-color: var(--card-light);
      }
      .form-group {
        margin-bottom: 1.25rem;
      }
      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--subtext-light);
      }
      .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 0.5rem 1rem;
      }
      .filter-summary {
        background-color: var(--bg-light);
        padding: 1rem;
        border-radius: var(--radius);
      }
      body.dark-mode .filter-summary {
        background-color: var(--card-dark);
      }
      .filter-summary h4 {
        margin: 0 0 1rem;
        font-size: 1rem;
        border-bottom: 1px solid var(--border-light);
        padding-bottom: 0.75rem;
      }
      .filter-summary .summary-details {
        display: flex;
        justify-content: space-around;
        text-align: center;
      }
      .filter-summary .summary-details span {
        font-size: 0.9rem;
        color: var(--subtext-light);
      }
      .filter-summary .summary-details strong {
        display: block;
        font-size: 1.25rem;
        color: var(--text-light);
        margin-top: 0.25rem;
      }

      .list-status {
        text-align: center;
        color: var(--subtext-light);
        padding: 3rem 1rem;
      }
      .list-container {
        list-style: none;
        padding: 0;
        margin: 0 -1.25rem;
      }
      .list-container li {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.8rem 1.25rem;
        transition: background-color var(--transition-fast);
        border-bottom: 1px solid var(--border-light);
        cursor: pointer;
      }
      .list-container li:last-child {
        border-bottom: none;
      }
      .list-container li:active {
        background-color: var(--gray-200);
      }
      body.dark-mode .list-container li:active {
        background-color: var(--gray-800);
      }

      .item-icon {
        font-size: 1rem;
        width: 2.5rem;
        height: 2.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        flex-shrink: 0;
      }
      .item-icon.income {
        background-color: var(--income-bg-light);
        color: var(--income);
      }
      .item-icon.expense,
      .item-icon.debt,
      .item-icon.issuedCheck {
        background-color: var(--expense-bg-light);
        color: var(--expense);
      }
      .item-icon.transfer {
        background-color: rgba(255, 149, 0, 0.15);
        color: var(--transfer);
      }
      .item-icon.receivable,
      .item-icon.receivedCheck {
        background-color: var(--income-bg-light);
        color: var(--income);
      }
      .item-icon.installmentPayment {
        background-color: rgba(175, 82, 222, 0.15);
        color: var(--loan);
      }

      .item-info {
        flex-grow: 1;
        min-width: 0;
      }
      .item-info p {
        margin: 0 0 0.2rem;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .item-info .meta-data {
        font-size: 0.8rem;
        color: var(--subtext-light);
        display: flex;
        flex-wrap: wrap;
        gap: 0.2rem 0.8rem;
      }
      .item-amount {
        font-weight: 600;
        font-size: 1.1rem;
        direction: ltr;
        margin-left: 0.5rem;
      }
      .item-amount.income {
        color: var(--income);
      }
      .item-amount.expense {
        color: var(--expense);
      }

      .item-actions {
        display: flex;
        margin-left: auto;
        align-items: center;
        gap: 0.2rem;
      }
      .action-btn {
        background: none;
        border: none;
        color: var(--subtext-light);
        cursor: pointer;
        font-size: 0.9rem;
        transition: var(--transition-fast);
        padding: 0.5rem;
      }
      .action-btn.edit-btn:hover {
        color: var(--primary);
      }
      .action-btn.delete-btn:hover {
        color: var(--expense);
      }

      .due-date-info.overdue {
        color: var(--expense);
        font-weight: bold;
      }
      .meta-data .meta-status {
        font-weight: 600;
      }
      .meta-data .meta-status.success {
        color: var(--income);
      }
      .meta-data .meta-status.danger {
        color: var(--expense);
      }
      .check-badge {
        font-size: 0.7rem;
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 4px;
        background-color: var(--primary);
        color: white;
        vertical-align: middle;
        margin-right: 5px;
      }

      .progress-item {
        margin-bottom: 1.5rem;
      }
      .progress-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
      }
      .progress-header h4 {
        margin: 0;
        font-size: 1.1rem;
      }
      .progress-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem 1rem;
        margin-bottom: 1rem;
        font-size: 0.9rem;
      }
      .progress-bar-container {
        width: 100%;
        height: 8px;
        background-color: var(--gray-200);
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 0.5rem;
      }
      body.dark-mode .progress-bar-container {
        background-color: var(--gray-800);
      }
      .progress-bar {
        height: 100%;
        border-radius: 4px;
        transition: width 0.5s ease-in-out;
      }
      .progress-bar.loan {
        background-color: var(--loan);
      }
      .progress-bar.goal {
        background-color: var(--goal);
      }
      .progress-text {
        text-align: center;
        color: var(--subtext-light);
        font-size: 0.85rem;
      }

      #daily-reports-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .daily-report-item {
        background: var(--card-light);
        border-radius: var(--radius);
        overflow: hidden;
        border-left: 4px solid;
        transition: var(--transition-medium);
      }
      .daily-report-item[data-net-flow="0"] {
        border-left-color: var(--subtext-light);
      }
      .daily-report-item[data-net-flow^="-"] {
        border-left-color: var(--expense);
      }
      .daily-report-item:not([data-net-flow^="-"]):not([data-net-flow="0"]) {
        border-left-color: var(--income);
      }
      .daily-report-header {
        padding: 0.8rem 1rem;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: var(--transition-fast);
      }
      .daily-report-item.active .daily-report-header {
        background-color: var(--gray-200);
      }
      body.dark-mode .daily-report-item.active .daily-report-header {
        background-color: var(--gray-900);
      }
      .daily-report-item.active .expand-arrow {
        transform: rotate(180deg);
      }
      .date-info .day-of-week {
        font-weight: 600;
        font-size: 1rem;
        color: var(--text-light);
      }
      .date-info .date-full {
        font-size: 0.8rem;
        color: var(--subtext-light);
      }
      .flow-summary {
        display: none;
      }
      .expand-arrow {
        color: var(--subtext-light);
        font-size: 1rem;
        transition: var(--transition-fast);
      }
      .daily-report-body {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s ease-out;
      }
      .daily-report-item.active .daily-report-body {
        max-height: 2000px;
      }
      .daily-report-body .list-container {
        margin: 0;
        background-color: var(--bg-light);
      }
      body.dark-mode .daily-report-body .list-container {
        background-color: var(--bg-dark);
      }

      .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: calc(var(--nav-height) + var(--safe-area-bottom));
        background-color: rgba(249, 249, 249, 0.9);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-top: 1px solid var(--border-light);
        display: flex;
        justify-content: space-around;
        padding: 5px 0 var(--safe-area-bottom);
        z-index: 100;
      }
      body.dark-mode .bottom-nav {
        background-color: rgba(28, 28, 30, 0.85);
      }
      .nav-btn {
        background: none;
        border: none;
        color: var(--subtext-light);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 0.2rem;
        font-family: var(--font-family);
        cursor: pointer;
        transition: var(--transition-fast);
        flex: 1;
        height: 100%;
        padding-top: 5px;
      }
      .nav-btn i {
        font-size: 1.3rem;
      }
      .nav-btn span {
        font-size: 0.65rem;
        font-weight: 500;
      }
      .nav-btn.active {
        color: var(--primary);
      }

      .fab {
        position: fixed;
        bottom: calc(var(--nav-height) + var(--safe-area-bottom) - 30px);
        left: 50%;
        transform: translateX(-50%);
        width: 56px;
        height: 56px;
        background-color: var(--primary);
        color: white;
        border: 4px solid var(--bg-light);
        border-radius: 50%;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 8px 25px rgba(0, 122, 255, 0.4);
        cursor: pointer;
        transition: var(--transition-medium);
        z-index: 101;
      }
      body.dark-mode .fab {
        border-color: var(--bg-dark);
      }
      /* FIX: Add subtle animation to FAB on tap */
      .fab:active {
        transform: translateX(-50%) scale(0.95);
      }

      .modal-overlay {
        position: fixed;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.4);
        opacity: 0;
        visibility: hidden;
        transition: var(--transition-medium);
        z-index: 1000;
        display: flex;
        justify-content: center;
        align-items: flex-end;
      }
      .modal-overlay.active {
        opacity: 1;
        visibility: visible;
      }
      .modal-content {
        background-color: var(--bg-light);
        width: 100%;
        max-width: 100%;
        padding: 1rem 1rem calc(1rem + var(--safe-area-bottom));
        border-radius: 20px 20px 0 0;
        transform: translateY(100%);
        transition: transform var(--transition-medium);
        max-height: 90vh;
        overflow-y: auto;
      }
      .modal-overlay.active .modal-content {
        transform: translateY(0);
      }
      .modal-content .modal-header {
        text-align: center;
        padding: 0.5rem 0 1.5rem;
        position: relative;
      }
      .modal-content .modal-header::before {
        content: "";
        position: absolute;
        top: 8px;
        left: 50%;
        transform: translateX(-50%);
        width: 40px;
        height: 5px;
        background-color: var(--gray-300);
        border-radius: 2.5px;
      }
      body.dark-mode .modal-content .modal-header::before {
        background-color: var(--gray-700);
      }
      .modal-content h3 {
        margin: 0;
        font-size: 1.25rem;
      }
      .form-actions {
        display: flex;
        gap: 0.75rem;
        margin-top: 1.5rem;
      }
      .form-actions .btn {
        flex: 1;
        padding: 1rem;
      }

      #toast {
        position: fixed;
        top: calc(var(--header-height) + var(--safe-area-top) + 1rem);
        left: 50%;
        background-color: var(--gray-800);
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        box-shadow: var(--shadow);
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transform: translate(-50%, -20px);
        transition: var(--transition-medium);
      }
      body.dark-mode #toast {
        background-color: var(--gray-200);
        color: var(--gray-900);
      }
      #toast.show {
        opacity: 1;
        visibility: visible;
        transform: translate(-50%, 0);
      }

      @media (min-width: 641px) {
        .modal-overlay {
          align-items: center;
        }
        .modal-content {
          width: 90%;
          max-width: 480px;
          border-radius: var(--radius);
          transform: scale(0.9);
          padding-bottom: 1.5rem;
        }
        .modal-overlay.active .modal-content {
          transform: scale(1);
        }
        .modal-content .modal-header::before {
          display: none;
        }
        .flow-summary {
          display: flex;
          gap: 1rem;
          align-items: center;
        }
        .flow-item {
          display: flex;
          align-items: center;
          gap: 0.5rem;
          font-weight: 500;
          font-size: 0.9rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-wrapper">
      <header class="app-header">
        <h1 id="app-header-title">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</h1>
        <div class="header-controls">
          <i class="fas fa-cog" id="settings-btn"></i>
          <div class="theme-switcher">
            <i class="fas fa-sun" id="theme-toggle"></i>
          </div>
        </div>
      </header>

      <main class="app-content">
        <section id="dashboard-page" class="page active">
          <div class="card-section main-balance">
            <div class="balance-title">
              <select
                id="account-filter-dashboard"
                class="form-control"
                style="
                  width: auto;
                  font-size: 0.85rem;
                  padding: 0.2rem 0.5rem;
                  background: rgba(255, 255, 255, 0.2);
                  color: white;
                  border: 1px solid rgba(255, 255, 255, 0.3);
                "
              ></select>
              <i class="fas fa-eye" id="toggle-balance-visibility"></i>
            </div>
            <h1 id="balance-amount"></h1>
          </div>
          <div class="card-section">
            <div class="section-header">
              <h3>Ø§Ù‚Ø¯Ø§Ù…Ø§Øª Ø³Ø±ÛŒØ¹</h3>
            </div>
            <div class="quick-actions">
              <div class="action-card income" data-action="quick-add-income">
                <i class="fas fa-plus"></i><span>Ø¯Ø±Ø¢Ù…Ø¯</span>
              </div>
              <div class="action-card expense" data-action="quick-add-expense">
                <i class="fas fa-minus"></i><span>Ù‡Ø²ÛŒÙ†Ù‡</span>
              </div>
              <div class="action-card debt" data-action="quick-add-debt">
                <i class="fas fa-file-invoice-dollar"></i><span>Ø¨Ø¯Ù‡ÛŒ</span>
              </div>
              <div
                class="action-card receivable"
                data-action="quick-add-receivable"
              >
                <i class="fas fa-hand-holding-dollar"></i><span>Ø·Ù„Ø¨</span>
              </div>
            </div>
          </div>
          <div class="card-section" id="reminders-section">
            <div class="section-header">
              <h3>
                <i
                  class="fas fa-bell"
                  style="color: var(--primary); margin-left: 0.5rem"
                ></i
                >ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒâ€ŒÙ‡Ø§ÛŒ Ù†Ø²Ø¯ÛŒÚ©
              </h3>
            </div>
            <ul class="list-container" id="reminders-list">
              <div class="list-status" style="padding: 1rem 0">
                Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø²Ø§Ø±ÛŒ...
              </div>
            </ul>
          </div>
          <div class="card-section">
            <div class="section-header">
              <h3>Ø®Ù„Ø§ØµÙ‡ Ø¹Ù…Ù„Ú©Ø±Ø¯</h3>
              <select
                id="dashboard-period-filter"
                class="form-control"
                style="width: auto; font-size: 0.85rem; padding: 0.5rem"
              >
                <option value="all">Ù‡Ù…ÛŒØ´Ù‡</option>
                <option value="7d">Û· Ø±ÙˆØ² Ø§Ø®ÛŒØ±</option>
                <option value="30d">Û³Û° Ø±ÙˆØ² Ø§Ø®ÛŒØ±</option>
                <option value="month">Ø§ÛŒÙ† Ù…Ø§Ù‡</option>
              </select>
            </div>
            <div class="summary-grid">
              <div class="summary-card income">
                <div class="card-header">
                  <div class="card-icon"><i class="fas fa-arrow-up"></i></div>
                  <span class="card-title">Ø¯Ø±Ø¢Ù…Ø¯</span>
                </div>
                <div class="card-amount">0</div>
              </div>
              <div class="summary-card expense">
                <div class="card-header">
                  <div class="card-icon"><i class="fas fa-arrow-down"></i></div>
                  <span class="card-title">Ù‡Ø²ÛŒÙ†Ù‡</span>
                </div>
                <div class="card-amount">0</div>
              </div>
              <div class="summary-card receivable">
                <div class="card-header">
                  <div class="card-icon">
                    <i class="fas fa-hand-holding-dollar"></i>
                  </div>
                  <span class="card-title">Ø·Ù„Ø¨ (Ù…Ø§Ù†Ø¯Ù‡)</span>
                </div>
                <div class="card-amount">0</div>
              </div>
              <div class="summary-card debt">
                <div class="card-header">
                  <div class="card-icon">
                    <i class="fas fa-file-invoice-dollar"></i>
                  </div>
                  <span class="card-title">Ø¨Ø¯Ù‡ÛŒ (Ù…Ø§Ù†Ø¯Ù‡)</span>
                </div>
                <div class="card-amount">0</div>
              </div>
              <div class="summary-card loan">
                <div class="card-header">
                  <div class="card-icon"><i class="fas fa-landmark"></i></div>
                  <span class="card-title">Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ ÙˆØ§Ù…â€ŒÙ‡Ø§</span>
                </div>
                <div class="card-amount">0</div>
              </div>
            </div>
          </div>
          <div class="card-section" id="dashboard-recents">
            <div class="section-header"><h3>Ø¢Ø®Ø±ÛŒÙ† ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</h3></div>
            <ul class="list-container">
              <div class="list-status" style="padding: 1rem 0">
                Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø²Ø§Ø±ÛŒ...
              </div>
            </ul>
          </div>
        </section>
        <section id="transactions-page" class="page"></section>
        <section id="reports-page" class="page"></section>
        <section id="savings-page" class="page"></section>
        <section id="debts-page" class="page"></section>
        <section id="receivables-page" class="page"></section>
        <section id="loans-page" class="page"></section>
        <section id="accounts-page" class="page"></section>
      </main>

      <button class="fab" data-action="add-transaction">
        <i class="fas fa-plus"></i>
      </button>

      <nav class="bottom-nav">
        <button
          class="nav-btn active"
          data-page="dashboard-page"
          data-title="Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯"
        >
          <i class="fas fa-tachometer-alt"></i><span>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</span>
        </button>
        <button
          class="nav-btn"
          data-page="transactions-page"
          data-title="ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§"
        >
          <i class="fas fa-exchange-alt"></i><span>ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</span>
        </button>
        <button class="nav-btn" data-page="accounts-page" data-title="Ø­Ø³Ø§Ø¨â€ŒÙ‡Ø§">
          <i class="fas fa-wallet"></i><span>Ø­Ø³Ø§Ø¨â€ŒÙ‡Ø§</span>
        </button>
        <button class="nav-btn" data-action="open-more-menu">
          <i class="fas fa-ellipsis-h"></i><span>Ø¨ÛŒØ´ØªØ±</span>
        </button>
      </nav>
    </div>

    <div class="modal-overlay" id="transaction-modal-overlay"></div>
    <div class="modal-overlay" id="account-modal-overlay"></div>
    <div class="modal-overlay" id="loan-modal-overlay"></div>
    <div class="modal-overlay" id="goal-modal-overlay"></div>
    <div class="modal-overlay" id="account-details-modal-overlay"></div>
    <div class="modal-overlay" id="confirm-modal-overlay"></div>
    <div class="modal-overlay" id="settings-modal-overlay"></div>
    <div class="modal-overlay" id="more-menu-modal-overlay"></div>
    <div id="toast"></div>

    <script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment-jalaali@0.9.2/build/moment-jalaali.js"></script>
    <script src="https://unpkg.com/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // --- SELECTORS ---
        const qs = (selector, parent = document) =>
          parent.querySelector(selector);
        const qsa = (selector, parent = document) =>
          parent.querySelectorAll(selector);

        // --- CONSTANTS & CONFIG ---
        moment.locale("fa");
        moment.updateLocale("fa", {
          jMonths:
            "ÙØ±ÙˆØ±Ø¯ÛŒÙ†_Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª_Ø®Ø±Ø¯Ø§Ø¯_ØªÛŒØ±_Ù…Ø±Ø¯Ø§Ø¯_Ø´Ù‡Ø±ÛŒÙˆØ±_Ù…Ù‡Ø±_Ø¢Ø¨Ø§Ù†_Ø¢Ø°Ø±_Ø¯ÛŒ_Ø¨Ù‡Ù…Ù†_Ø§Ø³ÙÙ†Ø¯".split(
              "_"
            ),
          weekdays: "ÛŒÚ©â€ŒØ´Ù†Ø¨Ù‡_Ø¯ÙˆØ´Ù†Ø¨Ù‡_Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡_Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡_Ù¾Ù†Ø¬â€ŒØ´Ù†Ø¨Ù‡_Ø¬Ù…Ø¹Ù‡_Ø´Ù†Ø¨Ù‡".split(
            "_"
          ),
          weekdaysMin: "ÛŒ_Ø¯_s_Ú†_Ù¾_Ø¬_Ø´".split("_"),
        });
        const MOMENT_FORMAT = "YYYY/MM/DD";
        const JALALI_DISPLAY_FORMAT = "jYYYY/jMM/jDD";
        const STORAGE_KEY = "accountingApp_ios_v4_fixed";
        const TRANSACTION_TYPES = {
          income: "âœ… Ø¯Ø±ÛŒØ§ÙØªÛŒ",
          expense: "âŒ Ù‡Ø²ÛŒÙ†Ù‡",
          transfer: "â¤´ï¸ Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ù‡ Ù¾Ø³ Ø§Ù†Ø¯Ø§Ø²",
          receivable: "ðŸ’° Ø·Ù„Ø¨",
          debt: "âž– Ø¨Ø¯Ù‡ÛŒ",
          receivedCheck: "ðŸ“„ Ú†Ú© Ø¯Ø±ÛŒØ§ÙØªÛŒ",
          issuedCheck: "ðŸ“„ Ú†Ú© ØµØ§Ø¯Ø±Ù‡",
          installmentPayment: "ðŸ’³ Ù¾Ø±Ø¯Ø§Ø®Øª Ù‚Ø³Ø·",
        };
        const STATUS_TYPES = {
          debt: {
            paid: "Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯",
            pending: "Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±",
            not_paid: "Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ø´Ø¯",
          },
          receivable: {
            received: "Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯",
            pending: "Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±",
            not_received: "Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯",
          },
          issuedCheck: {
            cleared: "Ù¾Ø§Ø³ Ø´Ø¯Ù‡",
            pending: "Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±",
            bounced: "Ù¾Ø§Ø³ Ù†Ø´Ø¯",
          },
          receivedCheck: {
            cleared: "Ù¾Ø§Ø³ Ø´Ø¯Ù‡",
            pending: "Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±",
            bounced: "Ù¾Ø§Ø³ Ù†Ø´Ø¯",
          },
        };

        // --- STATE ---
        let state = {
          transactions: [],
          accounts: [],
          loans: [],
          savingsGoals: [],
          expenseCategories: [
            "Ø®Ø±ÛŒØ¯ Ø±ÙˆØ²Ù…Ø±Ù‡",
            "Ø­Ù…Ù„ Ùˆ Ù†Ù‚Ù„",
            "ØºØ°Ø§",
            "Ù¾ÙˆØ´Ø§Ú©",
            "Ø³Ø±Ú¯Ø±Ù…ÛŒ",
            "Ø§Ø¬Ø§Ø±Ù‡",
          ],
          incomeSources: ["Ø­Ù‚ÙˆÙ‚", "Ù¾Ø±ÙˆÚ˜Ù‡", "Ø³ÙˆØ¯ Ø³Ù‡Ø§Ù…"],
          isBalanceVisible: true,
          activeAccountId: "all",
          dashboardPeriod: "all",
          filters: {
            transactions: {
              searchTerm: "",
              from: null,
              to: null,
              type: "all",
              accountId: "all",
              category: "all",
            },
            reports: { from: null, to: null, accountId: "all" },
            debts: { from: null, to: null, accountId: "all", status: "all" },
            receivables: {
              from: null,
              to: null,
              accountId: "all",
              status: "all",
            },
          },
        };
        let itemToDelete = { id: null, type: null };
        let preChangeSelectValue = null;
        let currentPageId = "dashboard-page";

        // --- HELPERS ---
        const formatCurrency = (amount) =>
          `${(Number(amount) || 0).toLocaleString("fa-IR")}`;
        const getUnformattedAmount = (value) => {
          if (typeof value !== "string") return "";
          return normalizeDigits(value).replace(/[,Ù¬]/g, "");
        };
        const normalizeDigits = (str) => {
          if (typeof str !== "string") return str;
          return str
            .replace(/[\u0660-\u0669]/g, (c) => c.charCodeAt(0) - 0x0660)
            .replace(/[\u06F0-\u06F9]/g, (c) => c.charCodeAt(0) - 0x06f0);
        };
        const formatInputAsCurrency = (input) => {
          if (!input) return;
          let originalCursor = input.selectionStart;
          let originalLength = input.value.length;
          let rawValue = getUnformattedAmount(input.value);
          if (isNaN(rawValue) || rawValue.trim() === "") {
            input.value = "";
            return;
          }
          let formattedValue = Number(rawValue).toLocaleString("fa-IR");
          input.value = formattedValue;
          let newLength = formattedValue.length;
          if (originalCursor !== null) {
            input.setSelectionRange(
              originalCursor + (newLength - originalLength),
              originalCursor + (newLength - originalLength)
            );
          }
        };
        const showToast = (message) => {
          const t = qs("#toast");
          t.textContent = message;
          t.classList.add("show");
          setTimeout(() => {
            t.classList.remove("show");
          }, 3000);
        };

        const openModal = (modalId) => {
          qs(modalId)?.classList.add("active");
          document.body.classList.add("modal-open");
        };
        const closeModal = (modalId) => {
          qs(modalId)?.classList.remove("active");
          if (qsa(".modal-overlay.active").length === 0) {
            document.body.classList.remove("modal-open");
          }
        };

        // --- NAVIGATION ---
        const switchPage = (pageId, title) => {
          const oldPage = qs(`#${currentPageId}`);
          const newPage = qs(`#${pageId}`);

          if (oldPage && newPage) {
            oldPage.classList.remove("active");
          }

          newPage.classList.add("active");
          currentPageId = pageId;
          qs("#app-header-title").textContent = title;

          qsa(".nav-btn").forEach((b) => {
            b.classList.toggle("active", b.dataset.page === pageId);
          });

          const moreMenuPages = [
            "reports-page",
            "savings-page",
            "debts-page",
            "receivables-page",
            "loans-page",
          ];
          const moreMenuBtn = qs('.nav-btn[data-action="open-more-menu"]');
          if (moreMenuBtn) {
            moreMenuBtn.classList.toggle(
              "active",
              moreMenuPages.includes(pageId)
            );
          }

          const pageRenderers = {
            "dashboard-page": renderDashboardPage,
            "transactions-page": renderTransactionsPage,
            "reports-page": renderReportsPage,
            "savings-page": renderSavingsPage,
            "accounts-page": renderAccountsPage,
            "debts-page": renderDebtsPage,
            "receivables-page": renderReceivablesPage,
            "loans-page": renderLoansPage,
          };
          pageRenderers[pageId]?.();
          qs(".app-content").scrollTo(0, 0);
          initDatepickers(qs(`#${pageId}`));
        };

        // --- DATA PERSISTENCE ---
        const saveData = () => {
          try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            localStorage.setItem(
              STORAGE_KEY + "_theme",
              document.body.classList.contains("dark-mode") ? "dark" : "light"
            );
          } catch (e) {
            console.error("Failed to save data", e);
          }
        };
        const loadData = () => {
          try {
            const data = localStorage.getItem(STORAGE_KEY);
            if (data) {
              const parsedData = JSON.parse(data);
              const defaultFilters = {
                transactions: {
                  searchTerm: "",
                  from: null,
                  to: null,
                  type: "all",
                  accountId: "all",
                  category: "all",
                },
                reports: { from: null, to: null, accountId: "all" },
                debts: {
                  from: null,
                  to: null,
                  accountId: "all",
                  status: "all",
                },
                receivables: {
                  from: null,
                  to: null,
                  accountId: "all",
                  status: "all",
                },
              };
              parsedData.filters = {
                ...defaultFilters,
                ...(parsedData.filters || {}),
              };
              state = { ...state, ...parsedData };
            }
            if (state.accounts.length === 0) {
              state.accounts.push({ id: Date.now(), name: "Ø­Ø³Ø§Ø¨ Ø§ØµÙ„ÛŒ" });
            }
            if (!Array.isArray(state.savingsGoals)) state.savingsGoals = [];
            if (localStorage.getItem(STORAGE_KEY + "_theme") === "dark") {
              document.body.classList.add("dark-mode");
              updateThemeIcon();
            }
          } catch (e) {
            console.error("Failed to load data", e);
          }
        };

        // --- UI RENDERING ---
        const updateAllUI = () => {
          // FIX: This function's logic is now robust. It correctly re-renders the
          // current page, which resolves the bug where modals wouldn't close.
          const currentPageTitle = qs("#app-header-title").textContent;
          if (currentPageId) {
            switchPage(currentPageId, currentPageTitle);
          }
        };

        const calculateBalance = (transactions) => {
          return transactions.reduce((balance, tx) => {
            const amount = tx.amount;
            if (
              tx.type === "income" ||
              (tx.type === "receivable" && tx.status === "received") ||
              (tx.type === "receivedCheck" && tx.status === "cleared")
            )
              return balance + amount;
            if (
              tx.type === "expense" ||
              tx.type === "transfer" ||
              tx.type === "installmentPayment" ||
              (tx.type === "debt" && tx.status === "paid") ||
              (tx.type === "issuedCheck" && tx.status === "cleared")
            )
              return balance - amount;
            return balance;
          }, 0);
        };

        const getTransactionListItemHTML = (tx, options = {}) => {
          const { showAccount = false } = options;
          const sign =
            tx.type === "income" ||
            tx.type.includes("received") ||
            tx.type === "receivable"
              ? "+"
              : "-";
          const icons = {
            income: "fa-arrow-up",
            expense: "fa-arrow-down",
            transfer: "fa-exchange-alt",
            debt: "fa-file-invoice-dollar",
            receivable: "fa-hand-holding-dollar",
            issuedCheck: "fa-money-check-alt",
            receivedCheck: "fa-money-check-alt",
            installmentPayment: "fa-receipt",
          };
          const displayDate =
            tx.date && moment(tx.date, MOMENT_FORMAT).isValid()
              ? moment(tx.date, MOMENT_FORMAT).format("jD jMMMM")
              : "-";
          const displayDueDate =
            tx.dueDate && moment(tx.dueDate, MOMENT_FORMAT).isValid()
              ? moment(tx.dueDate, MOMENT_FORMAT).format(JALALI_DISPLAY_FORMAT)
              : null;
          const isOverdue =
            displayDueDate &&
            tx.status === "pending" &&
            moment(tx.dueDate, MOMENT_FORMAT).isBefore(moment(), "day");
          const account = state.accounts.find((a) => a.id == tx.accountId);
          let descriptionHTML = tx.description;
          if (tx.type === "receivedCheck" || tx.type === "issuedCheck")
            descriptionHTML += ` <span class="check-badge">Ú†Ú©</span>`;
          let meta = `<div class="meta-data"><span><i class="fas fa-calendar-day" style="opacity: 0.7;"></i> ${displayDate}</span>`;
          if (account && showAccount) meta += `<span> â€¢ ${account.name}</span>`;
          if (tx.category) meta += `<span> â€¢ ${tx.category}</span>`;
          if (displayDueDate)
            meta += `<span class="due-date-info ${
              isOverdue ? "overdue" : ""
            }"><i class="fas fa-hourglass-half" style="opacity: 0.7;"></i> ${displayDueDate}</span>`;
          const statusTypes = [
            "debt",
            "receivable",
            "issuedCheck",
            "receivedCheck",
          ];
          if (statusTypes.includes(tx.type) && tx.status) {
            const statuses = STATUS_TYPES[tx.type] || {};
            const statusText = statuses[tx.status] || tx.status;
            let statusClass = "";
            if (["paid", "received", "cleared"].includes(tx.status))
              statusClass = "success";
            else if (
              ["not_paid", "not_received", "bounced"].includes(tx.status)
            )
              statusClass = "danger";
            meta += `<span class="meta-status ${statusClass}">${statusText}</span>`;
          }
          meta += "</div>";
          let actions = `<div class="item-actions"><button class="action-btn edit-btn" data-id="${tx.id}" data-type="transaction"><i class="fas fa-pen-to-square"></i></button><button class="action-btn delete-btn" data-id="${tx.id}" data-type="transaction"><i class="fas fa-trash-alt"></i></button></div>`;
          return `<div class="item-icon ${tx.type}"><i class="fas ${
            icons[tx.type] || "fa-dollar-sign"
          }"></i></div> <div class="item-info"> <p>${descriptionHTML}</p> ${meta} </div> <div class="item-amount ${
            tx.type === "income" ? "income" : "expense"
          }">${tx.type === "transfer" ? "" : sign} ${formatCurrency(
            tx.amount
          )}</div> ${actions}`;
        };

        const getAccountListItemHTML = (item) => {
          const balance = calculateBalance(
            state.transactions.filter((tx) => tx.accountId == item.id)
          );
          return `<div class="item-icon" style="background-color: var(--gray-200); color: var(--gray-600);"><i class="fas fa-wallet"></i></div>
                <div class="item-info">
                    <p>${item.name}</p>
                    <div class="meta-data">Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ù„</div>
                </div>
                <div class="item-amount">${formatCurrency(balance)}</div>
                <i class="fas fa-chevron-left" style="color: var(--subtext-light); margin-right: auto;"></i>`;
        };

        // --- ALL OTHER JAVASCRIPT FUNCTIONS ---
        // (The rest of your original, un-minified JavaScript goes here)
        // ... [Paste the rest of the original JavaScript from the first prompt here] ...
        // NOTE: The following is the rest of your script, with the single fix to updateAllUI applied.

        function renderDashboardPage() {
          const page = qs("#dashboard-page");
          if (!page) return;

          const accountId = state.activeAccountId;
          const baseTxs =
            accountId === "all"
              ? state.transactions
              : state.transactions.filter((tx) => tx.accountId == accountId);
          const period = state.dashboardPeriod;
          let filteredTxs = baseTxs;
          if (period !== "all") {
            let startDate;
            if (period === "7d") startDate = moment().subtract(7, "days");
            else if (period === "30d")
              startDate = moment().subtract(30, "days");
            else if (period === "month") startDate = moment().startOf("jMonth");
            filteredTxs = baseTxs.filter((tx) =>
              moment(tx.date, MOMENT_FORMAT).isAfter(startDate)
            );
          }

          const balance = calculateBalance(baseTxs);
          const income = filteredTxs
            .filter((tx) => tx.type === "income")
            .reduce((acc, tx) => acc + tx.amount, 0);
          const expenses = filteredTxs
            .filter((tx) => tx.type === "expense")
            .reduce((acc, tx) => acc + tx.amount, 0);
          const totalDebt = filteredTxs
            .filter(
              (t) =>
                (t.type === "debt" || t.type === "issuedCheck") &&
                t.status === "pending"
            )
            .reduce((s, t) => s + t.amount, 0);
          const totalReceivable = filteredTxs
            .filter(
              (t) =>
                (t.type === "receivable" || t.type === "receivedCheck") &&
                t.status === "pending"
            )
            .reduce((s, t) => s + t.amount, 0);
          const totalLoanRemaining = state.loans.reduce((s, l) => {
            const paidCount = state.transactions.filter(
              (t) => t.loanId == l.id
            ).length;
            const remaining =
              (l.totalInstallments - paidCount) * l.installmentAmount;
            return s + (remaining > 0 ? remaining : 0);
          }, 0);

          qs("#balance-amount", page).textContent = state.isBalanceVisible
            ? `${formatCurrency(balance)} ØªÙˆÙ…Ø§Ù†`
            : "******";
          qs("#dashboard-period-filter", page).value = period;

          qs(".summary-card.income .card-amount", page).textContent =
            formatCurrency(income);
          qs(".summary-card.expense .card-amount", page).textContent =
            formatCurrency(expenses);
          qs(".summary-card.receivable .card-amount", page).textContent =
            formatCurrency(totalReceivable);
          qs(".summary-card.debt .card-amount", page).textContent =
            formatCurrency(totalDebt);
          qs(".summary-card.loan .card-amount", page).textContent =
            formatCurrency(totalLoanRemaining);

          populateDropdown(
            qs("#account-filter-dashboard", page),
            state.accounts,
            "id",
            "name",
            { value: "all", text: "Ù‡Ù…Ù‡ Ø­Ø³Ø§Ø¨â€ŒÙ‡Ø§" }
          );
          qs("#account-filter-dashboard", page).value = state.activeAccountId;

          const recentsList = qs("#dashboard-recents .list-container", page);
          const recents = [...baseTxs].sort((a, b) => b.id - a.id).slice(0, 5);
          if (recents.length === 0) {
            recentsList.innerHTML =
              '<div class="list-status" style="padding: 1rem 0;">ØªØ±Ø§Ú©Ù†Ø´ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</div>';
          } else {
            recentsList.innerHTML = recents
              .map(
                (tx) =>
                  `<li data-id="${tx.id}">${getTransactionListItemHTML(
                    tx
                  )}</li>`
              )
              .join("");
          }

          const remindersList = qs("#reminders-list", page);
          const today = moment().startOf("day");
          const sevenDaysLater = moment().add(7, "days").endOf("day");
          const reminders = state.transactions
            .filter(
              (tx) =>
                (tx.type === "debt" ||
                  tx.type === "receivable" ||
                  tx.type === "issuedCheck" ||
                  tx.type === "receivedCheck") &&
                tx.status === "pending" &&
                tx.dueDate &&
                moment(tx.dueDate, MOMENT_FORMAT).isValid() &&
                moment(tx.dueDate, MOMENT_FORMAT).isBetween(
                  today,
                  sevenDaysLater,
                  "day",
                  "[]"
                )
            )
            .sort((a, b) =>
              moment(a.dueDate, MOMENT_FORMAT).diff(
                moment(b.dueDate, MOMENT_FORMAT)
              )
            );
          if (reminders.length === 0) {
            remindersList.innerHTML =
              '<div class="list-status" style="padding: 1rem 0;">ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ø¨Ø±Ø§ÛŒ Û· Ø±ÙˆØ² Ø¢ÛŒÙ†Ø¯Ù‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</div>';
          } else {
            remindersList.innerHTML = reminders
              .map(
                (tx) =>
                  `<li data-id="${tx.id}">${getTransactionListItemHTML(
                    tx
                  )}</li>`
              )
              .join("");
          }
        }

        function renderTransactionsPage() {
          const page = qs("#transactions-page");
          if (!page) return;
          page.innerHTML = `
            <div class="card-section">
                <div class="section-header">
                    <h3>Ù„ÛŒØ³Øª ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</h3>
                    <button id="export-csv-btn" class="btn btn-success" style="padding: 0.5rem 0.8rem; gap: 0.5rem;">
                        <i class="fas fa-file-excel"></i>
                        <span>Ø§Ú©Ø³Ù„</span>
                    </button>
                </div>
                <div class="transaction-filters">
                    <div class="form-group"><input type="text" id="search-input" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± ØªÙˆØ¶ÛŒØ­Ø§Øª..." class="form-control"></div>
                    <div class="filter-grid" style="grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <div class="form-group"><input type="text" id="from-date-filter-tx" placeholder="Ø§Ø² ØªØ§Ø±ÛŒØ®" class="form-control pdate"></div>
                        <div class="form-group"><input type="text" id="to-date-filter-tx" placeholder="ØªØ§ ØªØ§Ø±ÛŒØ®" class="form-control pdate"></div>
                    </div>
                    <div class="filter-grid" style="grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                          <div class="form-group"><select id="account-filter" class="form-control account-dropdown"></select></div>
                          <div class="form-group"><select id="type-filter" class="form-control"></select></div>
                    </div>
                    <div class="form-group"><select id="category-filter" disabled class="form-control"><option value="all">Ù‡Ù…Ù‡ Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§</option></select></div>
                    <div class="form-group"><button id="clear-tx-filters-btn" class="btn btn-secondary" style="width:100%;">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙÛŒÙ„ØªØ±Ù‡Ø§</button></div>
                </div>
            </div>
            <div class="card-section">
                <ul id="transaction-list" class="list-container"></ul>
                <div id="transaction-list-status" class="list-status"></div>
            </div>`;
          populateDropdown(
            qs("#account-filter", page),
            state.accounts,
            "id",
            "name",
            { value: "all", text: "Ù‡Ù…Ù‡ Ø­Ø³Ø§Ø¨â€ŒÙ‡Ø§" }
          );
          populateDropdown(
            qs("#type-filter", page),
            Object.entries(TRANSACTION_TYPES).map(([k, v]) => ({
              key: k,
              val: v,
            })),
            "key",
            "val",
            { value: "all", text: "Ù‡Ù…Ù‡ Ø§Ù†ÙˆØ§Ø¹" }
          );

          const filters = state.filters.transactions;
          qs("#search-input").value = filters.searchTerm || "";
          qs("#from-date-filter-tx").value = filters.from
            ? moment(filters.from, MOMENT_FORMAT).format(JALALI_DISPLAY_FORMAT)
            : "";
          qs("#to-date-filter-tx").value = filters.to
            ? moment(filters.to, MOMENT_FORMAT).format(JALALI_DISPLAY_FORMAT)
            : "";
          qs("#account-filter", page).value = filters.accountId;
          qs("#type-filter", page).value = filters.type;

          renderCategoryFilter();
          qs("#category-filter").value = filters.category;
          renderTransactionList();
        }

        function renderTransactionList() {
          const listEl = qs("#transaction-list"),
            statusEl = qs("#transaction-list-status");
          if (!listEl) return;

          const filters = state.filters.transactions;

          const filtered = state.transactions.filter((tx) => {
            const txDate = moment(tx.date, MOMENT_FORMAT);
            if (
              filters.from &&
              txDate.isBefore(moment(filters.from, MOMENT_FORMAT), "day")
            )
              return false;
            if (
              filters.to &&
              txDate.isAfter(moment(filters.to, MOMENT_FORMAT), "day")
            )
              return false;
            if (
              filters.accountId !== "all" &&
              tx.accountId != filters.accountId
            )
              return false;
            if (filters.type !== "all" && tx.type !== filters.type)
              return false;
            if (filters.category !== "all" && tx.category !== filters.category)
              return false;
            if (
              filters.searchTerm &&
              !tx.description.toLowerCase().includes(filters.searchTerm)
            )
              return false;
            return true;
          });

          const sorted = filtered.sort(
            (a, b) =>
              moment(b.date, MOMENT_FORMAT).diff(
                moment(a.date, MOMENT_FORMAT)
              ) || b.id - a.id
          );

          listEl.innerHTML = "";
          statusEl.textContent = "";
          if (sorted.length === 0) {
            statusEl.textContent =
              state.transactions.length === 0
                ? "Ù‡ÛŒÚ† ØªØ±Ø§Ú©Ù†Ø´ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª."
                : "Ù…ÙˆØ±Ø¯ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ù…Ø´Ø®ØµØ§Øª ÛŒØ§ÙØª Ù†Ø´Ø¯.";
          } else {
            listEl.innerHTML = sorted
              .map(
                (tx) =>
                  `<li data-id="${tx.id}">${getTransactionListItemHTML(tx, {
                    showAccount: filters.accountId === "all",
                  })}</li>`
              )
              .join("");
          }
        }

        function renderCategoryFilter() {
          const page = qs("#transactions-page");
          if (!page) return;
          const typeFilterVal = qs("#type-filter", page).value;
          const categoryFilterEl = qs("#category-filter", page);
          let categories = [];
          if (typeFilterVal === "income") categories = state.incomeSources;
          if (typeFilterVal === "expense") categories = state.expenseCategories;
          categoryFilterEl.innerHTML =
            '<option value="all">Ù‡Ù…Ù‡ Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§</option>';
          categories.forEach(
            (cat) =>
              (categoryFilterEl.innerHTML += `<option value="${cat}">${cat}</option>`)
          );
          categoryFilterEl.disabled = !["income", "expense"].includes(
            typeFilterVal
          );
        }

        function renderAccountsPage() {
          const page = qs("#accounts-page");
          if (!page) return;
          page.innerHTML = `
            <div class="card-section">
                <div class="section-header">
                    <h3>Ø­Ø³Ø§Ø¨â€ŒÙ‡Ø§ÛŒ Ù…Ù†</h3>
                    <button class="btn btn-primary" data-action="add-account"><i class="fas fa-plus"></i></button>
                </div>
                <div id="accounts-list" class="list-container" style="margin: 0;"></div>
                <div id="accounts-status" class="list-status"></div>
            </div>`;

          const listEl = qs("#accounts-list", page),
            statusEl = qs("#accounts-status", page);
          if (state.accounts.length === 0) {
            statusEl.textContent = "Ù‡ÛŒÚ† Ø­Ø³Ø§Ø¨ÛŒ ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.";
          } else {
            statusEl.textContent = "";
            listEl.innerHTML = state.accounts
              .map(
                (acc) =>
                  `<li data-id="${
                    acc.id
                  }" data-type="account">${getAccountListItemHTML(acc)}</li>`
              )
              .join("");
          }
        }

        const applyGenericFilters = (transactions, pageKey) => {
          const filters = state.filters[pageKey];
          return transactions.filter((tx) => {
            if (!tx.date || !moment(tx.date, MOMENT_FORMAT, true).isValid())
              return false;
            const date = moment(tx.date, MOMENT_FORMAT);
            if (
              filters.from &&
              date.isBefore(moment(filters.from, MOMENT_FORMAT), "day")
            )
              return false;
            if (
              filters.to &&
              date.isAfter(moment(filters.to, MOMENT_FORMAT), "day")
            )
              return false;
            if (
              filters.accountId !== "all" &&
              tx.accountId != filters.accountId
            )
              return false;
            if (
              filters.status &&
              filters.status !== "all" &&
              tx.status !== filters.status
            )
              return false;
            return true;
          });
        };

        const renderFilteredListPage = (pageId, title, txTypes) => {
          const page = qs(`#${pageId}`);
          if (!page) return;
          const pageKey = pageId.replace("-page", "");

          page.innerHTML = `
            <div class="card-section">
                <div class="section-header"><h3>${title}</h3></div>
                <div class="advanced-filters">
                    <div class="filter-grid">
                        <div class="form-group"><label>Ø§Ø² ØªØ§Ø±ÛŒØ®</label><input type="text" class="form-control pdate from-date-filter"></div>
                        <div class="form-group"><label>ØªØ§ ØªØ§Ø±ÛŒØ®</label><input type="text" class="form-control pdate to-date-filter"></div>
                        <div class="form-group account-filter-group"><label>Ø­Ø³Ø§Ø¨</label><select class="form-control account-filter account-dropdown"></select></div>
                        <div class="form-group status-filter-group"><label>ÙˆØ¶Ø¹ÛŒØª</label><select class="form-control status-filter"></select></div>
                    </div>
                </div>
            </div>
            <div class="filter-summary card-section" style="display: none;"></div>
            <div class="card-section">
                <ul class="list-container" id="${pageKey}-list"></ul>
                <div class="list-status" id="${pageKey}-status"></div>
            </div>
        `;

          const listEl = qs(`#${pageKey}-list`);
          const statusEl = qs(`#${pageKey}-status`);

          populateDropdown(
            qs(".account-filter", page),
            state.accounts,
            "id",
            "name",
            { value: "all", text: "Ù‡Ù…Ù‡ Ø­Ø³Ø§Ø¨â€ŒÙ‡Ø§" }
          );
          qs(".account-filter", page).value = state.filters[pageKey].accountId;

          const statusFilterEl = qs(".status-filter", page);
          let statusesToShow = {};
          if (pageKey === "debts")
            statusesToShow = {
              ...STATUS_TYPES.debt,
              ...STATUS_TYPES.issuedCheck,
            };
          else if (pageKey === "receivables")
            statusesToShow = {
              ...STATUS_TYPES.receivable,
              ...STATUS_TYPES.receivedCheck,
            };
          populateDropdown(
            statusFilterEl,
            Object.entries(statusesToShow).map(([k, v]) => ({
              key: k,
              val: v,
            })),
            "key",
            "val",
            { value: "all", text: "Ù‡Ù…Ù‡ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§" }
          );
          statusFilterEl.value = state.filters[pageKey].status;

          qs(".from-date-filter", page).value = state.filters[pageKey].from
            ? moment(state.filters[pageKey].from, MOMENT_FORMAT).format(
                JALALI_DISPLAY_FORMAT
              )
            : "";
          qs(".to-date-filter", page).value = state.filters[pageKey].to
            ? moment(state.filters[pageKey].to, MOMENT_FORMAT).format(
                JALALI_DISPLAY_FORMAT
              )
            : "";

          const baseTxs = state.transactions.filter((t) =>
            txTypes.includes(t.type)
          );
          const filteredTxs = applyGenericFilters(baseTxs, pageKey);

          const summaryEl = qs(".filter-summary", page);
          const hasActiveFilters =
            state.filters[pageKey].from ||
            state.filters[pageKey].to ||
            state.filters[pageKey].accountId !== "all" ||
            state.filters[pageKey].status !== "all";

          if (filteredTxs.length > 0 && hasActiveFilters) {
            summaryEl.style.display = "block";
            const totalAmount = filteredTxs.reduce(
              (sum, tx) => sum + tx.amount,
              0
            );
            summaryEl.innerHTML = `<h4>Ø®Ù„Ø§ØµÙ‡ ÙÛŒÙ„ØªØ±</h4><div class="summary-details"><div><span>ØªØ¹Ø¯Ø§Ø¯</span><strong>${formatCurrency(
              filteredTxs.length
            )}</strong></div><div><span>Ù…Ø¬Ù…ÙˆØ¹</span><strong>${formatCurrency(
              totalAmount
            )} ØªÙˆÙ…Ø§Ù†</strong></div></div>`;
          } else {
            summaryEl.style.display = "none";
          }

          const sorted = filteredTxs.sort(
            (a, b) =>
              (a.status === "paid" ||
              a.status === "cleared" ||
              a.status === "received"
                ? 1
                : -1) -
                (b.status === "paid" ||
                b.status === "cleared" ||
                b.status === "received"
                  ? 1
                  : -1) ||
              moment(a.dueDate || a.date, MOMENT_FORMAT).diff(
                moment(b.dueDate || b.date, MOMENT_FORMAT)
              )
          );
          listEl.innerHTML = "";
          statusEl.textContent = "";
          if (sorted.length === 0) {
            statusEl.textContent =
              baseTxs.length === 0
                ? `Ù‡ÛŒÚ† Ù…ÙˆØ±Ø¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.`
                : "Ù‡ÛŒÚ† Ù…ÙˆØ±Ø¯ÛŒ Ø¨Ø§ Ø§ÛŒÙ† ÙÛŒÙ„ØªØ± ÛŒØ§ÙØª Ù†Ø´Ø¯.";
          } else {
            listEl.innerHTML = sorted
              .map(
                (tx) =>
                  `<li data-id="${tx.id}">${getTransactionListItemHTML(tx, {
                    showAccount: true,
                  })}</li>`
              )
              .join("");
          }
        };

        const renderDebtsPage = () =>
          renderFilteredListPage("debts-page", "Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§ Ùˆ Ú†Ú©â€ŒÙ‡Ø§ÛŒ ØµØ§Ø¯Ø±Ù‡", [
            "debt",
            "issuedCheck",
          ]);
        const renderReceivablesPage = () =>
          renderFilteredListPage(
            "receivables-page",
            "Ø·Ù„Ø¨â€ŒÙ‡Ø§ Ùˆ Ú†Ú©â€ŒÙ‡Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØªÛŒ",
            ["receivable", "receivedCheck"]
          );

        function renderLoansPage() {
          const page = qs("#loans-page");
          if (!page) return;
          page.innerHTML = `
            <div class="card-section">
                <div class="section-header"><h3>ØªØ³Ù‡ÛŒÙ„Ø§Øª Ùˆ Ø§Ù‚Ø³Ø§Ø·</h3><button class="btn btn-primary" data-action="add-loan"><i class="fas fa-plus"></i> ØªØ¹Ø±ÛŒÙ ØªØ³Ù‡ÛŒÙ„Ø§Øª</button></div>
                <div id="loans-list"></div>
                <div id="loans-status" class="list-status"></div>
            </div>
        `;
          const listEl = qs("#loans-list"),
            statusEl = qs("#loans-status");
          listEl.innerHTML = "";
          if (state.loans.length === 0) {
            statusEl.textContent = "Ù‡ÛŒÚ† ØªØ³Ù‡ÛŒÙ„Ø§ØªÛŒ ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.";
            return;
          }
          statusEl.textContent = "";
          state.loans.forEach((loan) => {
            const paidCount = state.transactions.filter(
              (t) => t.loanId == loan.id
            ).length;
            loan.paidInstallments = paidCount;
            const progress =
              loan.totalInstallments > 0
                ? (paidCount / loan.totalInstallments) * 100
                : 0;
            const remainingAmount =
              (loan.totalInstallments - paidCount) * loan.installmentAmount;
            const div = document.createElement("div");
            div.className = "progress-item";
            div.innerHTML = `<div class="card-section" style="padding: 1rem; margin:0;"><div class="progress-header"><div><h4>${
              loan.bankName
            }</h4><p style="font-size: 0.9rem; color: var(--subtext-light); margin: 0.25rem 0 0;">${
              loan.description
            }</p></div><div class="item-actions"><button class="action-btn delete-btn" data-id="${
              loan.id
            }" data-type="loan"><i class="fas fa-trash-alt"></i></button></div></div><div class="progress-details"><div><span>Ù…Ø¨Ù„Øº Ù‡Ø± Ù‚Ø³Ø·</span><span>${formatCurrency(
              loan.installmentAmount
            )} ØªÙˆÙ…Ø§Ù†</span></div><div><span>Ø§Ù‚Ø³Ø§Ø· Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡</span><span>${paidCount} Ø§Ø² ${
              loan.totalInstallments
            }</span></div><div><span>Ù…Ø¨Ù„Øº Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡</span><span>${formatCurrency(
              remainingAmount
            )} ØªÙˆÙ…Ø§Ù†</span></div></div><div class="progress-bar-container"><div class="progress-bar loan" style="width: ${progress}%"></div></div><div class="progress-text">${Math.round(
              progress
            )}% ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</div></div>`;
            listEl.appendChild(div);
          });
        }

        function renderSavingsPage() {
          const page = qs("#savings-page");
          if (!page) return;
          const savingsBalance = state.transactions
            .filter((tx) => tx.type === "transfer")
            .reduce((acc, tx) => acc + tx.amount, 0);
          page.innerHTML = `
            <div class="card-section" style="border-left: 5px solid var(--primary); text-align: center;">
                <h4>Ù…ÙˆØ¬ÙˆØ¯ÛŒ ØµÙ†Ø¯ÙˆÙ‚ Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø²</h4>
                <h1 id="savings-balance" style="font-size: 2rem; margin: 1rem 0;">${formatCurrency(
                  savingsBalance
                )} ØªÙˆÙ…Ø§Ù†</h1>
                <button class="btn btn-primary" data-action="add-to-fund" style="width: 100%;">+ Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ù‡ ØµÙ†Ø¯ÙˆÙ‚</button>
            </div>
            <div class="card-section">
                <div class="section-header"><h3>Ø§Ù‡Ø¯Ø§Ù Ù…Ø§Ù„ÛŒ</h3><button class="btn btn-primary" data-action="add-goal"><i class="fas fa-plus"></i> Ø§ÙØ²ÙˆØ¯Ù† Ù‡Ø¯Ù</button></div>
                <div id="savings-goals-list"></div>
                <div id="savings-goals-status" class="list-status"></div>
            </div>
        `;

          const listEl = qs("#savings-goals-list"),
            statusEl = qs("#savings-goals-status");
          listEl.innerHTML = "";
          statusEl.textContent = "";
          if (state.savingsGoals.length === 0) {
            statusEl.textContent = "Ù‡Ù†ÙˆØ² Ù‡Ø¯ÙÛŒ ØªØ¹Ø±ÛŒÙ Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.";
            return;
          }
          state.savingsGoals.forEach((goal) => {
            const progress =
              goal.targetAmount > 0
                ? (goal.savedAmount / goal.targetAmount) * 100
                : 0;
            const div = document.createElement("div");
            div.className = "progress-item";
            div.innerHTML = `<div class="card-section" style="padding: 1rem; margin:0;"><div class="progress-header"><div><h4>${
              goal.name
            }</h4></div><div class="item-actions"><button class="action-btn edit-btn" data-id="${
              goal.id
            }" data-type="goal"><i class="fas fa-edit"></i></button><button class="action-btn delete-btn" data-id="${
              goal.id
            }" data-type="goal"><i class="fas fa-trash-alt"></i></button></div></div><div class="progress-details"><div><span>Ù¾Ø³ Ø§Ù†Ø¯Ø§Ø² Ø´Ø¯Ù‡</span><span>${formatCurrency(
              goal.savedAmount
            )} ØªÙˆÙ…Ø§Ù†</span></div><div><span>Ù…Ø¨Ù„Øº Ù‡Ø¯Ù</span><span>${formatCurrency(
              goal.targetAmount
            )} ØªÙˆÙ…Ø§Ù†</span></div></div><div class="progress-bar-container"><div class="progress-bar goal" style="width: ${progress}%"></div></div><div class="progress-text">${Math.round(
              progress
            )}% ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</div></div>`;
            listEl.appendChild(div);
          });
        }

        function renderReportsPage() {
          const page = qs("#reports-page");
          if (!page) return;
          page.innerHTML = `
            <div class="card-section">
                <div class="section-header"><h3>Ú¯Ø²Ø§Ø±Ø´ Ø¬Ø§Ù…Ø¹</h3></div>
                 <div class="advanced-filters">
                    <div class="filter-grid">
                        <div class="form-group"><label>Ø§Ø² ØªØ§Ø±ÛŒØ®</label><input type="text" class="form-control pdate from-date-filter"></div>
                        <div class="form-group"><label>ØªØ§ ØªØ§Ø±ÛŒØ®</label><input type="text" class="form-control pdate to-date-filter"></div>
                        <div class="form-group account-filter-group"><label>Ø­Ø³Ø§Ø¨</label><select class="form-control account-filter account-dropdown"></select></div>
                    </div>
                </div>
            </div>
             <div class="filter-summary card-section" style="display: none;"></div>
            <div id="daily-reports-list"></div>
            <div id="reports-status" class="list-status"></div>
        `;

          populateDropdown(
            qs(".account-filter", page),
            state.accounts,
            "id",
            "name",
            { value: "all", text: "Ù‡Ù…Ù‡ Ø­Ø³Ø§Ø¨â€ŒÙ‡Ø§" }
          );
          qs(".account-filter", page).value = state.filters.reports.accountId;
          qs(".from-date-filter", page).value = state.filters.reports.from
            ? moment(state.filters.reports.from, MOMENT_FORMAT).format(
                JALALI_DISPLAY_FORMAT
              )
            : "";
          qs(".to-date-filter", page).value = state.filters.reports.to
            ? moment(state.filters.reports.to, MOMENT_FORMAT).format(
                JALALI_DISPLAY_FORMAT
              )
            : "";

          const filteredTxs = applyGenericFilters(
            state.transactions,
            "reports"
          );
          const dailyListEl = qs("#daily-reports-list", page),
            statusEl = qs("#reports-status", page);
          dailyListEl.innerHTML = "";
          statusEl.innerHTML = "";
          if (state.transactions.length === 0) {
            statusEl.innerHTML = "Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ú¯Ø²Ø§Ø±Ø´ØŒ Ø§Ø¨ØªØ¯Ø§ ØªØ±Ø§Ú©Ù†Ø´ÛŒ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯.";
            return;
          }

          const groupedByDay = filteredTxs.reduce((acc, tx) => {
            if (tx.date && moment(tx.date, MOMENT_FORMAT, true).isValid()) {
              const day = tx.date;
              if (!acc[day])
                acc[day] = { income: 0, expense: 0, transactions: [] };
              const amount = tx.amount;
              if (
                tx.type === "income" ||
                (tx.type === "receivable" && tx.status === "received") ||
                (tx.type === "receivedCheck" && tx.status === "cleared")
              )
                acc[day].income += amount;
              if (
                tx.type === "expense" ||
                tx.type === "transfer" ||
                tx.type === "installmentPayment" ||
                (tx.type === "debt" && tx.status === "paid") ||
                (tx.type === "issuedCheck" && tx.status === "cleared")
              )
                acc[day].expense += amount;
              acc[day].transactions.push(tx);
            }
            return acc;
          }, {});

          const sortedDays = Object.keys(groupedByDay).sort((a, b) =>
            moment(b, MOMENT_FORMAT).diff(moment(a, MOMENT_FORMAT))
          );
          if (sortedDays.length === 0)
            statusEl.textContent = "Ù‡ÛŒÚ† Ù…ÙˆØ±Ø¯ÛŒ Ø¨Ø§ Ø§ÛŒÙ† ÙÛŒÙ„ØªØ± ÛŒØ§ÙØª Ù†Ø´Ø¯.";
          dailyListEl.innerHTML = sortedDays
            .map((day) => {
              const data = groupedByDay[day];
              const dayNet = data.income - data.expense;
              const m = moment(day, MOMENT_FORMAT);
              return `<div class="daily-report-item" data-net-flow="${dayNet}">
                        <div class="daily-report-header">
                            <div class="date-info">
                                <span class="day-of-week">${m.format(
                                  "dddd"
                                )}</span>
                                <span class="date-full">${m.format(
                                  JALALI_DISPLAY_FORMAT
                                )}</span>
                            </div>
                            <div class="flow-summary">
                                <div class="flow-item income"><i class="fas fa-arrow-up"></i><span>${formatCurrency(
                                  data.income
                                )}</span></div>
                                <div class="flow-item expense"><i class="fas fa-arrow-down"></i><span>${formatCurrency(
                                  data.expense
                                )}</span></div>
                            </div>
                            <i class="fas fa-chevron-down expand-arrow"></i>
                        </div>
                        <div class="daily-report-body">
                            <ul class="list-container">${data.transactions
                              .sort((a, b) => b.id - a.id)
                              .map(
                                (tx) =>
                                  `<li data-id="${
                                    tx.id
                                  }">${getTransactionListItemHTML(tx, {
                                    showAccount: true,
                                  })}</li>`
                              )
                              .join("")}</ul>
                        </div>
                    </div>`;
            })
            .join("");
        }

        const populateDropdown = (
          selectEl,
          data,
          valueField,
          textField,
          addOption
        ) => {
          if (!selectEl) return;
          let currentValue = selectEl.value;
          selectEl.innerHTML = "";
          if (addOption) {
            const opt = document.createElement("option");
            opt.value = addOption.value;
            opt.textContent = addOption.text;
            selectEl.appendChild(opt);
          }
          data.forEach((item) => {
            const option = document.createElement("option");
            option.value = item[valueField];
            option.textContent = item[textField];
            selectEl.appendChild(option);
          });
          if (selectEl.classList.contains("account-dropdown")) {
            selectEl.innerHTML += `<option value="add_new_account" style="font-weight: bold; color: var(--primary);">+ Ø§ÙØ²ÙˆØ¯Ù† Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÛŒØ¯...</option>`;
          }
          selectEl.value = currentValue;
        };

        const renderTransactionModal = (txId = null, type = null) => {
          const modal = qs("#transaction-modal-overlay");
          modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header"><h3 id="transaction-modal-title">ØªØ±Ø§Ú©Ù†Ø´ Ø¬Ø¯ÛŒØ¯</h3></div>
                <form id="transaction-form">
                    <input type="hidden" id="transaction-id">
                    <div class="form-group"><label for="type">Ù†ÙˆØ¹ ØªØ±Ø§Ú©Ù†Ø´</label><select id="type" required class="form-control"></select></div>
                    <div class="form-group"><label for="account-select">Ø§Ø²/Ø¨Ù‡ Ø­Ø³Ø§Ø¨</label><select id="account-select" required class="form-control account-dropdown"></select></div>
                    <div class="form-group" id="loan-payment-group" style="display: none;"><label for="loan-select">Ù¾Ø±Ø¯Ø§Ø®Øª Ù‚Ø³Ø·Ù</label><select id="loan-select" class="form-control"></select><div id="add-loan-prompt" style="display: none; margin-top: 0.5rem;"><small>Ù‡Ù†ÙˆØ² ØªØ³Ù‡ÛŒÙ„Ø§ØªÛŒ ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡. <a href="#" data-action="go-to-loans">Ø¨Ø±Ø§ÛŒ Ø§ÙØ²ÙˆØ¯Ù† Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.</a></small></div></div>
                    <div class="form-group" id="category-group" style="display: none;"><label for="category-select">Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø³ØªÙ‡/Ù…Ù†Ø¨Ø¹</label><select id="category-select" class="form-control"></select></div>
                    <div class="form-group" id="new-category-group" style="display: none;"><label for="new-category-input">Ù†Ø§Ù… Ø¯Ø³ØªÙ‡/Ù…Ù†Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯</label><input type="text" id="new-category-input" placeholder="Ù…Ø«Ø§Ù„: Ø§Ø¬Ø§Ø±Ù‡ Ø®Ø§Ù†Ù‡" class="form-control"></div>
                    <div class="form-group"><label for="description">ØªÙˆØ¶ÛŒØ­Ø§Øª</label><input type="text" id="description" required class="form-control"></div>
                    <div class="form-group"><label for="amount">Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)</label><input type="text" id="amount" required class="form-control currency-input" inputmode="decimal"></div>
                    <div class="form-group"><label for="transaction-date">ØªØ§Ø±ÛŒØ® ØªØ±Ø§Ú©Ù†Ø´</label><input type="text" id="transaction-date" required class="form-control pdate"/></div>
                    <div class="form-group" id="due-date-group" style="display: none;"><label for="due-date">ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯</label><input type="text" id="due-date" class="form-control pdate"/></div>
                    <div class="form-group" id="status-group" style="display: none;"><label for="status-select">ÙˆØ¶Ø¹ÛŒØª</label><select id="status-select" class="form-control"></select></div>
                    <div class="form-actions"><button type="button" class="btn btn-secondary" data-action="close-modal">Ø§Ù†ØµØ±Ø§Ù</button><button type="submit" class="btn btn-primary">Ø«Ø¨Øª</button></div>
                </form>
            </div>`;

          const form = qs("#transaction-form", modal);
          qs("#transaction-modal-title", modal).textContent = txId
            ? "ÙˆÛŒØ±Ø§ÛŒØ´ ØªØ±Ø§Ú©Ù†Ø´"
            : "ØªØ±Ø§Ú©Ù†Ø´ Ø¬Ø¯ÛŒØ¯";
          qs("#transaction-id", form).value = txId || "";

          populateDropdown(
            qs("#type", form),
            Object.entries(TRANSACTION_TYPES).map(([k, v]) => ({
              key: k,
              val: v,
            })),
            "key",
            "val"
          );
          populateDropdown(
            qs("#account-select", form),
            state.accounts,
            "id",
            "name"
          );

          if (type) qs("#type", form).value = type;

          if (txId) {
            const tx = state.transactions.find((t) => t.id == txId);
            qs("#type", form).value = tx.type;
            handleTransactionFormChange(); // Call again to set up form fields based on type
            qs("#account-select", form).value = tx.accountId;
            qs("#description", form).value = tx.description;
            qs("#amount", form).value = formatCurrency(tx.amount);
            qs("#transaction-date", form).value = tx.date
              ? moment(tx.date, MOMENT_FORMAT).format(JALALI_DISPLAY_FORMAT)
              : "";
            if (qs("#due-date-group").style.display !== "none")
              qs("#due-date", form).value = tx.dueDate
                ? moment(tx.dueDate, MOMENT_FORMAT).format(
                    JALALI_DISPLAY_FORMAT
                  )
                : "";
            if (tx.status) qs("#status-select", form).value = tx.status;
            if (tx.category) qs("#category-select", form).value = tx.category;
            if (tx.loanId) qs("#loan-select", form).value = tx.loanId;
          } else {
            qs("#transaction-date", form).value = moment().format(
              JALALI_DISPLAY_FORMAT
            );
            qs("#status-select", form).value = "pending";
          }

          handleTransactionFormChange();
          initDatepickers(modal);
          openModal("#transaction-modal-overlay");
        };

        const handleTransactionFormChange = () => {
          const form = qs("#transaction-form");
          if (!form) return;
          const typeVal = qs("#type", form).value;
          const statusTypes = [
            "debt",
            "receivable",
            "issuedCheck",
            "receivedCheck",
          ];

          qs("#status-group", form).style.display = statusTypes.includes(
            typeVal
          )
            ? "block"
            : "none";
          qs("#due-date-group", form).style.display = statusTypes.includes(
            typeVal
          )
            ? "block"
            : "none";
          qs("#category-group", form).style.display = [
            "income",
            "expense",
          ].includes(typeVal)
            ? "block"
            : "none";
          qs("#loan-payment-group", form).style.display =
            typeVal === "installmentPayment" ? "block" : "none";
          qs("#new-category-group", form).style.display = "none";

          if (statusTypes.includes(typeVal)) {
            populateDropdown(
              qs("#status-select", form),
              Object.entries(STATUS_TYPES[typeVal] || {}).map(([k, v]) => ({
                key: k,
                val: v,
              })),
              "key",
              "val"
            );
          }
          if (["income", "expense"].includes(typeVal)) {
            let categories =
              typeVal === "income"
                ? state.incomeSources
                : state.expenseCategories;
            const categorySelect = qs("#category-select", form);
            categorySelect.innerHTML =
              categories
                .map((c) => `<option value="${c}">${c}</option>`)
                .join("") +
              '<option value="add-new">Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø³ØªÙ‡ Ø¬Ø¯ÛŒØ¯...</option>';
          }
          if (typeVal === "installmentPayment") {
            if (state.loans.length > 0) {
              populateDropdown(
                qs("#loan-select", form),
                state.loans,
                "id",
                "bankName"
              );
              qs("#loan-select", form).style.display = "block";
              qs("#add-loan-prompt", form).style.display = "none";
            } else {
              qs("#loan-select", form).style.display = "none";
              qs("#add-loan-prompt", form).style.display = "block";
            }
          }
        };

        const renderAccountModal = (accId = null) => {
          const modal = qs("#account-modal-overlay");
          modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header"><h3 id="account-modal-title">${
                  accId ? "ÙˆÛŒØ±Ø§ÛŒØ´ Ø­Ø³Ø§Ø¨" : "Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÛŒØ¯"
                }</h3></div>
                <form id="account-form">
                    <input type="hidden" id="account-id" value="${accId || ""}">
                    <div class="form-group"><label for="account-name">Ù†Ø§Ù… Ø­Ø³Ø§Ø¨ (Ù…Ø«Ø§Ù„: Ø¨Ø§Ù†Ú© Ù…Ù„ÛŒØŒ Ú©ÛŒÙ Ù¾ÙˆÙ„)</label><input type="text" id="account-name" required class="form-control"></div>
                    <div class="form-group"><label for="card-number">Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label><input type="text" id="card-number" placeholder="xxxx-xxxx-xxxx-xxxx" class="form-control"></div>
                    <div class="form-group"><label for="account-number">Ø´Ù…Ø§Ø±Ù‡ Ø­Ø³Ø§Ø¨ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label><input type="text" id="account-number" class="form-control"></div>
                    <div class="form-group"><label for="shaba-number">Ø´Ù…Ø§Ø±Ù‡ Ø´Ø¨Ø§ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label><input type="text" id="shaba-number" placeholder="IRxxxxxxxxxxxxxxxxxxxxxxxx" class="form-control"></div>
                    <div class="form-group"><label for="notes">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label><textarea id="notes" rows="2" class="form-control"></textarea></div>
                    <div class="form-actions">
                        ${
                          accId
                            ? `<button type="button" class="btn btn-danger" data-action="delete-item" data-id="${accId}" data-type="account">Ø­Ø°Ù</button>`
                            : ""
                        }
                        <button type="submit" class="btn btn-primary" style="flex-grow: 2;">Ø°Ø®ÛŒØ±Ù‡</button>
                    </div>
                </form>
            </div>`;

          if (accId) {
            const acc = state.accounts.find((a) => a.id == accId);
            if (acc) {
              qs("#account-name", modal).value = acc.name;
              qs("#card-number", modal).value = acc.cardNumber || "";
              qs("#account-number", modal).value = acc.accountNumber || "";
              qs("#shaba-number", modal).value = acc.shabaNumber || "";
              qs("#notes", modal).value = acc.notes || "";
            }
          }
          openModal("#account-modal-overlay");
        };

        const renderMoreMenuModal = () => {
          const modal = qs("#more-menu-modal-overlay");
          modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header"><h3>Ø¨ÛŒØ´ØªØ±</h3></div>
                <ul class="list-container" style="margin:0;">
                    <li class="more-menu-item" data-page="reports-page" data-title="Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§"><div class="item-icon" style="background-color:rgba(255,159,10,0.15); color: #ff9f0a;"><i class="fas fa-chart-pie"></i></div><div class="item-info"><p>Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø¬Ø§Ù…Ø¹</p></div><i class="fas fa-chevron-left"></i></li>
                    <li class="more-menu-item" data-page="debts-page" data-title="Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§"><div class="item-icon debt"><i class="fas fa-file-invoice-dollar"></i></div><div class="item-info"><p>Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§ Ùˆ Ú†Ú©â€ŒÙ‡Ø§ÛŒ ØµØ§Ø¯Ø±Ù‡</p></div><i class="fas fa-chevron-left"></i></li>
                    <li class="more-menu-item" data-page="receivables-page" data-title="Ø·Ù„Ø¨â€ŒÙ‡Ø§"><div class="item-icon receivable"><i class="fas fa-hand-holding-dollar"></i></div><div class="item-info"><p>Ø·Ù„Ø¨â€ŒÙ‡Ø§ Ùˆ Ú†Ú©â€ŒÙ‡Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØªÛŒ</p></div><i class="fas fa-chevron-left"></i></li>
                    <li class="more-menu-item" data-page="loans-page" data-title="Ø§Ù‚Ø³Ø§Ø·"><div class="item-icon loan" style="background-color:rgba(175, 82, 222, 0.15); color:var(--purple-ios);"><i class="fas fa-landmark"></i></div><div class="item-info"><p>ØªØ³Ù‡ÛŒÙ„Ø§Øª Ùˆ Ø§Ù‚Ø³Ø§Ø·</p></div><i class="fas fa-chevron-left"></i></li>
                    <li class="more-menu-item" data-page="savings-page" data-title="Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø²"><div class="item-icon goal" style="background-color:rgba(50, 173, 234, 0.15); color:var(--cyan-ios);"><i class="fas fa-piggy-bank"></i></div><div class="item-info"><p>Ø§Ù‡Ø¯Ø§Ù Ùˆ Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø²</p></div><i class="fas fa-chevron-left"></i></li>
                </ul>
                     <div style="text-align: center; padding: 15px 10px 5px; font-size: 0.75rem; color: var(--subtext-light);">
                       ÙˆØ¨ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ Ù†Ø³Ø®Ù‡ 0.02 | Ø·Ø±Ø§Ø­ÛŒ Ùˆ Ú©Ø¯Ù†ÙˆÛŒØ³ÛŒ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· Ù¾ÛŒÙ…Ø§Ù† Ø¹Ø§Ø¨Ø¯ÛŒÙ† Ù¾ÙˆØ±
                       </div>
            </div>`;
          openModal("#more-menu-modal-overlay");
        };

        const renderConfirmModal = (message) => {
          const modal = qs("#confirm-modal-overlay");
          modal.innerHTML = `
            <div class="modal-content" style="text-align:center;">
                <div class="modal-header" style="padding-bottom: 0.5rem"><h3>ØªØ§ÛŒÛŒØ¯ Ø­Ø°Ù</h3></div>
                <p id="confirm-delete-message" style="margin: 1rem 0 1.5rem;">${message}</p>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" data-action="close-modal">Ø®ÛŒØ±</button>
                    <button type="button" class="btn btn-danger" id="confirm-delete-btn">Ø¨Ù„Ù‡ØŒ Ø­Ø°Ù Ú©Ù†</button>
                </div>
            </div>`;
          openModal("#confirm-modal-overlay");
        };

        const renderSettingsModal = () => {
          qs("#settings-modal-overlay").innerHTML = `
            <div class="modal-content">
                <div class="modal-header"><h3>Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ Ùˆ Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ</h3></div>
                <p style="text-align: center; color: var(--subtext-light); margin-bottom: 2rem;">Ø§Ø² Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø®ÙˆØ¯ ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù† ØªÙ‡ÛŒÙ‡ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‚Ø¨Ù„ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ù†Ù…Ø§ÛŒÛŒØ¯.</p>
                <div class="form-actions" style="flex-direction: column; gap: 1rem;">
                    <button class="btn btn-success" id="backup-btn" style="width: 100%;">
                        <i class="fas fa-download" style="margin-left: 8px;"></i> Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù†
                    </button>
                    <button class="btn btn-primary" id="restore-btn" style="width: 100%;">
                        <i class="fas fa-upload" style="margin-left: 8px;"></i> Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ø§Ø² ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù†
                    </button>
                    <input type="file" id="restore-file-input" accept=".db,.json" style="display: none;">
                </div>
                <div class="form-actions" style="margin-top: 2rem; justify-content: center;">
                    <button type="button" class="btn btn-secondary" data-action="close-modal">Ø¨Ø³ØªÙ†</button>
                </div>
            </div>`;
          openModal("#settings-modal-overlay");
        };

        const renderLoanModal = () => {
          const modal = qs("#loan-modal-overlay");
          modal.innerHTML = `
            <div class="modal-content">
                <form id="loan-form">
                    <div class="modal-header"><h3 id="loan-modal-title">ØªØ¹Ø±ÛŒÙ ØªØ³Ù‡ÛŒÙ„Ø§Øª</h3></div>
                    <input type="hidden" id="loan-id">
                    <div class="form-group"><label for="bank-name">Ù†Ø§Ù… Ø¨Ø§Ù†Ú© ÛŒØ§ Ù…ÙˆØ³Ø³Ù‡</label><input type="text" id="bank-name" required class="form-control"></div>
                    <div class="form-group"><label for="loan-description">ØªÙˆØ¶ÛŒØ­ (Ù…Ø«Ø§Ù„: ÙˆØ§Ù… Ø®Ø±ÛŒØ¯ Ú©Ø§Ù„Ø§)</label><input type="text" id="loan-description" required class="form-control"></div>
                    <div class="form-group"><label for="total-installments">ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ø§Ù‚Ø³Ø§Ø·</label><input type="number" id="total-installments" required min="1" class="form-control"></div>
                    <div class="form-group"><label for="installment-amount">Ù…Ø¨Ù„Øº Ù‡Ø± Ù‚Ø³Ø· (ØªÙˆÙ…Ø§Ù†)</label><input type="text" id="installment-amount" required class="form-control currency-input" inputmode="decimal"></div>
                    <div class="form-actions"><button type="button" class="btn btn-secondary" data-action="close-modal">Ø§Ù†ØµØ±Ø§Ù</button><button type="submit" class="btn btn-primary">Ø°Ø®ÛŒØ±Ù‡</button></div>
                </form>
            </div>`;
          openModal("#loan-modal-overlay");
        };

        const renderGoalModal = (goalId = null) => {
          const modal = qs("#goal-modal-overlay");
          modal.innerHTML = `
            <div class="modal-content">
                <form id="goal-form">
                    <div class="modal-header"><h3 id="goal-modal-title">${
                      goalId ? "ÙˆÛŒØ±Ø§ÛŒØ´ Ù‡Ø¯Ù" : "Ù‡Ø¯Ù Ù…Ø§Ù„ÛŒ Ø¬Ø¯ÛŒØ¯"
                    }</h3></div>
                    <input type="hidden" id="goal-id" value="${goalId || ""}">
                    <div class="form-group"><label for="goal-name">Ø¹Ù†ÙˆØ§Ù† Ù‡Ø¯Ù (Ù…Ø«Ø§Ù„: Ø³ÙØ± Ø¨Ù‡ Ú©ÛŒØ´)</label><input type="text" id="goal-name" required class="form-control"></div>
                    <div class="form-group"><label for="target-amount">Ù…Ø¨Ù„Øº Ù‡Ø¯Ù (ØªÙˆÙ…Ø§Ù†)</label><input type="text" id="target-amount" required class="form-control currency-input" inputmode="decimal"></div>
                    <div class="form-group"><label for="saved-amount">Ù…Ø¨Ù„Øº Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø² Ø´Ø¯Ù‡ Ø§ÙˆÙ„ÛŒÙ‡ (ØªÙˆÙ…Ø§Ù†)</label><input type="text" id="saved-amount" value="0" class="form-control currency-input" inputmode="decimal"></div>
                    <div class="form-actions"><button type="button" class="btn btn-secondary" data-action="close-modal">Ø§Ù†ØµØ±Ø§Ù</button><button type="submit" class="btn btn-primary">Ø°Ø®ÛŒØ±Ù‡</button></div>
                </form>
            </div>`;
          if (goalId) {
            const goal = state.savingsGoals.find((g) => g.id == goalId);
            if (goal) {
              qs("#goal-name", modal).value = goal.name;
              qs("#target-amount", modal).value = formatCurrency(
                goal.targetAmount
              );
              qs("#saved-amount", modal).value = formatCurrency(
                goal.savedAmount
              );
            }
          }
          openModal("#goal-modal-overlay");
        };

        const renderAccountDetailsModal = (accId) => {
          const acc = state.accounts.find((a) => a.id == accId);
          if (!acc) return;
          const modal = qs("#account-details-modal-overlay");
          modal.innerHTML = `
        <div class="modal-content" id="account-details-content">
            <div class="modal-header"><h3>${acc.name}</h3></div>
            <div style="text-align: right; line-height: 2; font-size: 0.9rem; padding: 0 1rem;">
                <p><strong>Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª:</strong> ${acc.cardNumber || "-"}</p>
                <p><strong>Ø´Ù…Ø§Ø±Ù‡ Ø­Ø³Ø§Ø¨:</strong> ${acc.accountNumber || "-"}</p>
                <p><strong>Ø´Ù…Ø§Ø±Ù‡ Ø´Ø¨Ø§:</strong> ${acc.shabaNumber || "-"}</p>
                <p><strong>ÛŒØ§Ø¯Ø¯Ø§Ø´Øª:</strong> ${acc.notes || "-"}</p>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" data-action="close-modal">Ø¨Ø³ØªÙ†</button>
                <button type="button" class="btn btn-primary" data-action="edit-account" data-id="${
                  acc.id
                }">ÙˆÛŒØ±Ø§ÛŒØ´</button>
            </div>
        </div>`;
          openModal("#account-details-modal-overlay");
        };

        const setupEventListeners = () => {
          document.body.addEventListener("click", (e) => {
            const target = e.target;
            const closest = (selector) => target.closest(selector);

            const navBtn = closest(".nav-btn");
            if (navBtn && navBtn.dataset.page) {
              switchPage(navBtn.dataset.page, navBtn.dataset.title);
              return;
            }
            if (closest('[data-action="open-more-menu"]')) {
              renderMoreMenuModal();
              return;
            }
            const moreMenuItem = closest(".more-menu-item");
            if (moreMenuItem) {
              closeModal("#more-menu-modal-overlay");
              setTimeout(() => {
                switchPage(
                  moreMenuItem.dataset.page,
                  moreMenuItem.dataset.title
                );
              }, 150);
              return;
            }

            if (
              target.matches(".modal-overlay") ||
              closest('[data-action="close-modal"]')
            ) {
              closeModal("#" + closest(".modal-overlay").id);
              return;
            }
            if (closest(".fab")) {
              renderTransactionModal();
              return;
            }
            if (closest('[data-action="add-account"]')) {
              renderAccountModal();
              return;
            }
            if (closest("#settings-btn")) {
              renderSettingsModal();
              return;
            }

            const quickAction = closest(".action-card");
            if (quickAction) {
              const action = quickAction.dataset.action;
              if (action === "quick-add-income")
                renderTransactionModal(null, "income");
              if (action === "quick-add-expense")
                renderTransactionModal(null, "expense");
              if (action === "quick-add-debt")
                renderTransactionModal(null, "debt");
              if (action === "quick-add-receivable")
                renderTransactionModal(null, "receivable");
              return;
            }
            if (closest('[data-action="add-to-fund"]')) {
              renderTransactionModal(null, "transfer");
              return;
            }
            if (closest('[data-action="add-loan"]')) {
              renderLoanModal();
              return;
            }
            if (closest('[data-action="add-goal"]')) {
              renderGoalModal();
              return;
            }
            if (closest('[data-action="go-to-loans"]')) {
              e.preventDefault();
              closeModal("#transaction-modal-overlay");
              switchPage("loans-page", "Ø§Ù‚Ø³Ø§Ø·");
              return;
            }
            if (closest('[data-action="edit-account"]')) {
              closeModal("#account-details-modal-overlay");
              renderAccountModal(
                closest('[data-action="edit-account"]').dataset.id
              );
              return;
            }

            const listItem = closest(".list-container li[data-id]");
            if (listItem && !closest(".action-btn")) {
              const id = listItem.dataset.id;
              const type = listItem.dataset.type;
              if (type === "account") renderAccountDetailsModal(id);
              else renderTransactionModal(id);
              return;
            }

            const actionBtn = closest(".action-btn");
            if (actionBtn) {
              e.stopPropagation();
              const id = actionBtn.dataset.id;
              const type = actionBtn.dataset.type;

              if (actionBtn.classList.contains("edit-btn")) {
                if (type === "goal") renderGoalModal(id);
                else if (type === "transaction") renderTransactionModal(id);
              } else if (actionBtn.classList.contains("delete-btn")) {
                itemToDelete = { id: parseInt(id), type: type };
                renderConfirmModal("Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù…ÙˆØ±Ø¯ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ");
              }
              return;
            }

            const deleteBtn = closest('[data-action="delete-item"]');
            if (deleteBtn) {
              itemToDelete = {
                id: parseInt(deleteBtn.dataset.id),
                type: deleteBtn.dataset.type,
              };
              if (itemToDelete.type === "account") {
                renderConfirmModal(
                  "Ù‡Ø´Ø¯Ø§Ø±: ÙÙ‚Ø· Ø¯Ø± ØµÙˆØ±ØªÛŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø­Ø³Ø§Ø¨ Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ Ú©Ù‡ Ù‡ÛŒÚ† ØªØ±Ø§Ú©Ù†Ø´ÛŒ Ù†Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯. Ø¢ÛŒØ§ Ø§Ø¯Ø§Ù…Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒØ¯ØŸ"
                );
                closeModal("#account-modal-overlay");
              } else {
                renderConfirmModal("Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù…ÙˆØ±Ø¯ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ");
              }
              return;
            }

            if (closest("#confirm-delete-btn")) {
              handleDelete();
              return;
            }

            if (closest("#theme-toggle")) {
              document.body.classList.toggle("dark-mode");
              updateThemeIcon();
              saveData();
            }
            if (closest("#toggle-balance-visibility")) {
              state.isBalanceVisible = !state.isBalanceVisible;
              saveData();
              renderDashboardPage();
            }

            if (closest(".daily-report-header")) {
              closest(".daily-report-item").classList.toggle("active");
            }

            if (closest("#backup-btn")) {
              handleBackup();
              return;
            }
            if (closest("#restore-btn")) {
              qs("#restore-file-input").click();
              return;
            }
            if (closest("#export-csv-btn")) {
              exportTransactionsToCSV();
              return;
            }
            if (closest("#clear-tx-filters-btn")) {
              state.filters.transactions = {
                searchTerm: "",
                from: null,
                to: null,
                type: "all",
                accountId: "all",
                category: "all",
              };
              renderTransactionsPage();
              saveData();
              return;
            }
          });

          document.body.addEventListener("submit", (e) => {
            e.preventDefault();
            if (e.target.id === "transaction-form") {
              handleTransactionSubmit(e.target);
            }
            if (e.target.id === "account-form") {
              handleAccountSubmit(e.target);
            }
            if (e.target.id === "loan-form") {
              handleLoanSubmit(e.target);
            }
            if (e.target.id === "goal-form") {
              handleGoalSubmit(e.target);
            }
          });

          document.body.addEventListener("change", (e) => {
            const target = e.target;
            if (target.id === "dashboard-period-filter") {
              state.dashboardPeriod = target.value;
              saveData();
              renderDashboardPage();
            }
            if (target.id === "account-filter-dashboard") {
              if (target.value !== "add_new_account") {
                state.activeAccountId = target.value;
                saveData();
                renderDashboardPage();
              }
            }

            const txFilters = target.closest(
              "#transactions-page .transaction-filters"
            );
            if (txFilters) {
              if (target.id === "type-filter") {
                state.filters.transactions.category = "all";
                renderCategoryFilter();
              }
              state.filters.transactions.accountId = qs(
                "#account-filter",
                txFilters
              ).value;
              state.filters.transactions.type = qs(
                "#type-filter",
                txFilters
              ).value;
              state.filters.transactions.category = qs(
                "#category-filter",
                txFilters
              ).value;
              state.filters.transactions.from = qs(
                "#from-date-filter-tx",
                txFilters
              ).value
                ? moment(
                    normalizeDigits(
                      qs("#from-date-filter-tx", txFilters).value
                    ),
                    JALALI_DISPLAY_FORMAT
                  ).format(MOMENT_FORMAT)
                : null;
              state.filters.transactions.to = qs(
                "#to-date-filter-tx",
                txFilters
              ).value
                ? moment(
                    normalizeDigits(qs("#to-date-filter-tx", txFilters).value),
                    JALALI_DISPLAY_FORMAT
                  ).format(MOMENT_FORMAT)
                : null;
              renderTransactionList();
              saveData();
              return;
            }

            const advancedFilterPage = target.closest(
              '.page[id$="-page"] .advanced-filters'
            );
            if (advancedFilterPage) {
              const pageEl = advancedFilterPage.closest(".page");
              const pageKey = pageEl.id.replace("-page", "");
              state.filters[pageKey] = {
                from: qs(".from-date-filter", pageEl).value
                  ? moment(
                      normalizeDigits(qs(".from-date-filter", pageEl).value),
                      JALALI_DISPLAY_FORMAT
                    ).format(MOMENT_FORMAT)
                  : null,
                to: qs(".to-date-filter", pageEl).value
                  ? moment(
                      normalizeDigits(qs(".to-date-filter", pageEl).value),
                      JALALI_DISPLAY_FORMAT
                    ).format(MOMENT_FORMAT)
                  : null,
                accountId: qs(".account-filter", pageEl)
                  ? qs(".account-filter", pageEl).value
                  : "all",
                status: qs(".status-filter", pageEl)
                  ? qs(".status-filter", pageEl).value
                  : "all",
              };
              saveData();
              switchPage(pageEl.id, qs(`#app-header-title`).textContent);
              return;
            }

            if (target.matches("#transaction-form #type")) {
              handleTransactionFormChange();
            }
            if (target.matches("#transaction-form #category-select")) {
              qs("#new-category-group").style.display =
                target.value === "add-new" ? "block" : "none";
            }
          });
          document.body.addEventListener("input", (e) => {
            const txFilters = e.target.closest(
              "#transactions-page .transaction-filters"
            );
            if (e.target.id === "search-input" && txFilters) {
              state.filters.transactions.searchTerm =
                e.target.value.toLowerCase();
              renderTransactionList();
              saveData();
            }
            if (e.target.classList.contains("currency-input"))
              formatInputAsCurrency(e.target);
          });
          document.body.addEventListener("mousedown", (e) => {
            if (
              e.target.tagName === "SELECT" &&
              e.target.classList.contains("account-dropdown")
            ) {
              preChangeSelectValue = e.target.value;
            }
          });
          document.body.addEventListener("change", (e) => {
            if (
              e.target.tagName === "SELECT" &&
              e.target.classList.contains("account-dropdown")
            ) {
              if (e.target.value === "add_new_account") {
                const selectEl = e.target;
                selectEl.value = preChangeSelectValue;
                let modal = selectEl.closest(".modal-overlay");
                if (modal) closeModal("#" + modal.id);
                switchPage("accounts-page", "Ø­Ø³Ø§Ø¨â€ŒÙ‡Ø§");
                setTimeout(() => renderAccountModal(), 150);
              }
            }
          });
          qs("#restore-file-input").addEventListener("change", handleRestore);
        };

        function handleTransactionSubmit(form) {
          const id = qs("#transaction-id", form).value;
          const type = qs("#type", form).value;
          let category = qs("#category-select", form).value;
          const newCategory = qs("#new-category-input", form).value.trim();
          if (category === "add-new") {
            if (!newCategory) {
              showToast("Ù„Ø·ÙØ§ Ù†Ø§Ù… Ø¯Ø³ØªÙ‡ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
              return;
            }
            category = newCategory;
            if (
              type === "expense" &&
              !state.expenseCategories.includes(newCategory)
            )
              state.expenseCategories.push(newCategory);
            else if (
              type === "income" &&
              !state.incomeSources.includes(newCategory)
            )
              state.incomeSources.push(newCategory);
          }
          const transactionData = {
            type: type,
            accountId: qs("#account-select", form).value,
            description: qs("#description", form).value.trim(),
            amount: parseInt(
              getUnformattedAmount(qs("#amount", form).value || "0")
            ),
            date: moment(
              normalizeDigits(qs("#transaction-date", form).value),
              JALALI_DISPLAY_FORMAT
            ).format(MOMENT_FORMAT),
            category: ["income", "expense"].includes(type) ? category : null,
            dueDate:
              qs("#due-date-group", form).style.display !== "none" &&
              qs("#due-date", form).value
                ? moment(
                    normalizeDigits(qs("#due-date", form).value),
                    JALALI_DISPLAY_FORMAT
                  ).format(MOMENT_FORMAT)
                : null,
            status:
              qs("#status-group", form).style.display !== "none"
                ? qs("#status-select", form).value
                : null,
            loanId:
              type === "installmentPayment"
                ? qs("#loan-select", form).value
                : null,
          };
          if (
            !transactionData.description ||
            !transactionData.amount ||
            !transactionData.date ||
            !transactionData.accountId ||
            !moment(transactionData.date, MOMENT_FORMAT).isValid()
          ) {
            showToast("Ù„Ø·ÙØ§ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ù„Ø§Ø²Ù… Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯.");
            return;
          }
          if (id) {
            const index = state.transactions.findIndex((tx) => tx.id == id);
            state.transactions[index] = {
              ...state.transactions[index],
              ...transactionData,
            };
            showToast("ØªØ±Ø§Ú©Ù†Ø´ ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯.");
          } else {
            state.transactions.push({ id: Date.now(), ...transactionData });
            showToast("ØªØ±Ø§Ú©Ù†Ø´ Ø«Ø¨Øª Ø´Ø¯.");
          }
          saveData();
          updateAllUI();
          closeModal("#transaction-modal-overlay");
        }

        function handleAccountSubmit(form) {
          const id = qs("#account-id", form).value;
          const name = qs("#account-name", form).value.trim();
          if (!name) {
            showToast("Ù†Ø§Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª.");
            return;
          }
          const accountData = {
            name: name,
            cardNumber: qs("#card-number", form).value.trim(),
            accountNumber: qs("#account-number", form).value.trim(),
            shabaNumber: qs("#shaba-number", form).value.trim(),
            notes: qs("#notes", form).value.trim(),
          };
          if (id) {
            const index = state.accounts.findIndex((a) => a.id == id);
            state.accounts[index] = {
              ...state.accounts[index],
              ...accountData,
            };
            showToast("Ø­Ø³Ø§Ø¨ ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯.");
          } else {
            state.accounts.push({ id: Date.now(), ...accountData });
            showToast("Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.");
          }
          saveData();
          updateAllUI();
          closeModal("#account-modal-overlay");
        }

        function handleLoanSubmit(form) {
          const loanData = {
            bankName: qs("#bank-name", form).value.trim(),
            description: qs("#loan-description", form).value.trim(),
            totalInstallments: parseInt(
              normalizeDigits(qs("#total-installments", form).value)
            ),
            installmentAmount: parseInt(
              getUnformattedAmount(qs("#installment-amount", form).value)
            ),
          };
          if (
            !loanData.bankName ||
            !loanData.totalInstallments ||
            !loanData.installmentAmount
          ) {
            showToast("Ù„Ø·ÙØ§ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯.");
            return;
          }
          state.loans.push({
            id: Date.now(),
            ...loanData,
            paidInstallments: 0,
          });
          showToast("ØªØ³Ù‡ÛŒÙ„Ø§Øª Ø¬Ø¯ÛŒØ¯ ØªØ¹Ø±ÛŒÙ Ø´Ø¯.");
          saveData();
          updateAllUI();
          closeModal("#loan-modal-overlay");
        }

        function handleGoalSubmit(form) {
          const id = qs("#goal-id", form).value;
          const goalData = {
            name: qs("#goal-name", form).value.trim(),
            targetAmount: parseInt(
              getUnformattedAmount(qs("#target-amount", form).value)
            ),
            savedAmount: parseInt(
              getUnformattedAmount(qs("#saved-amount", form).value || "0")
            ),
          };
          if (!goalData.name || !goalData.targetAmount) {
            showToast("Ù„Ø·ÙØ§ Ø¹Ù†ÙˆØ§Ù† Ùˆ Ù…Ø¨Ù„Øº Ù‡Ø¯Ù Ø±Ø§ Ù…Ø´Ø®Øµ Ú©Ù†ÛŒØ¯.");
            return;
          }
          if (id) {
            const index = state.savingsGoals.findIndex((g) => g.id == id);
            state.savingsGoals[index] = {
              ...state.savingsGoals[index],
              ...goalData,
            };
            showToast("Ù‡Ø¯Ù ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯.");
          } else {
            state.savingsGoals.push({ id: Date.now(), ...goalData });
            showToast("Ù‡Ø¯Ù Ø¬Ø¯ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.");
          }
          saveData();
          updateAllUI();
          closeModal("#goal-modal-overlay");
        }

        function handleDelete() {
          if (itemToDelete.type === "transaction") {
            state.transactions = state.transactions.filter(
              (i) => i.id !== itemToDelete.id
            );
          } else if (itemToDelete.type === "loan") {
            state.loans = state.loans.filter((i) => i.id !== itemToDelete.id);
            state.transactions = state.transactions.filter(
              (t) => t.loanId != itemToDelete.id
            );
          } else if (itemToDelete.type === "goal") {
            state.savingsGoals = state.savingsGoals.filter(
              (i) => i.id !== itemToDelete.id
            );
          } else if (itemToDelete.type === "account") {
            if (
              state.transactions.some((t) => t.accountId == itemToDelete.id)
            ) {
              showToast("Ø§Ù…Ú©Ø§Ù† Ø­Ø°Ù Ø­Ø³Ø§Ø¨ Ø¯Ø§Ø±Ø§ÛŒ ØªØ±Ø§Ú©Ù†Ø´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.");
              closeModal("#confirm-modal-overlay");
              return;
            }
            state.accounts = state.accounts.filter(
              (i) => i.id !== itemToDelete.id
            );
          }
          showToast("Ù…ÙˆØ±Ø¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯.");
          saveData();
          updateAllUI();
          closeModal("#confirm-modal-overlay");
        }

        const handleBackup = () => {
          try {
            const dataStr = JSON.stringify(state);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "accounting_backup.json";
            a.click();
            URL.revokeObjectURL(url);
            showToast("ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯.");
            closeModal("#settings-modal-overlay");
          } catch (e) {
            showToast("Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù†.");
          }
        };
        const handleRestore = (event) => {
          const file = event.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const restoredState = JSON.parse(e.target.result);
              if (
                restoredState &&
                typeof restoredState === "object" &&
                Array.isArray(restoredState.transactions)
              ) {
                state = { ...state, ...restoredState };
                saveData();
                updateAllUI();
                closeModal("#settings-modal-overlay");
                showToast("Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ø´Ø¯.");
              } else {
                throw new Error("Invalid backup file format.");
              }
            } catch (err) {
              showToast("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ ÙØ§ÛŒÙ„. ÙØ§ÛŒÙ„ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.");
            } finally {
              event.target.value = "";
            }
          };
          reader.readAsText(file);
        };
        const exportTransactionsToCSV = () => {
          const filters = state.filters.transactions;
          const filteredTxs = state.transactions.filter((tx) => {
            const txDate = moment(tx.date, MOMENT_FORMAT);
            if (
              filters.from &&
              txDate.isBefore(moment(filters.from, MOMENT_FORMAT), "day")
            )
              return false;
            if (
              filters.to &&
              txDate.isAfter(moment(filters.to, MOMENT_FORMAT), "day")
            )
              return false;
            if (
              filters.accountId !== "all" &&
              tx.accountId != filters.accountId
            )
              return false;
            if (filters.type !== "all" && tx.type !== filters.type)
              return false;
            if (filters.category !== "all" && tx.category !== filters.category)
              return false;
            if (
              filters.searchTerm &&
              !tx.description.toLowerCase().includes(filters.searchTerm)
            )
              return false;
            return true;
          });

          if (filteredTxs.length === 0) {
            showToast(
              "Ù‡ÛŒÚ† ØªØ±Ø§Ú©Ù†Ø´ÛŒ (Ø¨Ø§ ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ ÙØ¹Ù„ÛŒ) Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ Ú¯Ø±ÙØªÙ† ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯."
            );
            return;
          }
          const escapeCsvField = (field) => {
            const str = String(field ?? "");
            if (str.includes(",") || str.includes('"') || str.includes("\n")) {
              return `"${str.replace(/"/g, '""')}"`;
            }
            return str;
          };
          const headers = [
            "ØªØ§Ø±ÛŒØ®",
            "Ù†ÙˆØ¹",
            "ØªÙˆØ¶ÛŒØ­Ø§Øª",
            "Ù…Ø¨Ù„Øº",
            "Ø­Ø³Ø§Ø¨",
            "Ø¯Ø³ØªÙ‡/Ù…Ù†Ø¨Ø¹",
            "ÙˆØ¶Ø¹ÛŒØª",
            "ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯",
          ];
          const rows = filteredTxs.map((tx) => {
            const account = state.accounts.find((a) => a.id == tx.accountId);
            const statusText = (STATUS_TYPES[tx.type] || {})[tx.status] || "";
            return [
              tx.date
                ? moment(tx.date, MOMENT_FORMAT).format(JALALI_DISPLAY_FORMAT)
                : "",
              TRANSACTION_TYPES[tx.type] || tx.type,
              tx.description,
              tx.amount,
              account ? account.name : "Ù†Ø§Ù…Ø´Ø®Øµ",
              tx.category || "",
              statusText,
              tx.dueDate
                ? moment(tx.dueDate, MOMENT_FORMAT).format(
                    JALALI_DISPLAY_FORMAT
                  )
                : "",
            ]
              .map(escapeCsvField)
              .join(",");
          });
          const csvContent = "\uFEFF" + [headers.join(","), ...rows].join("\n");
          const blob = new Blob([csvContent], {
            type: "text/csv;charset=utf-8;",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `transactions_${moment().format("jYYYY-jMM-jDD")}.csv`;
          a.click();
          URL.revokeObjectURL(url);
        };

        const updateThemeIcon = () => {
          qs("#theme-toggle").className = `fas ${
            document.body.classList.contains("dark-mode") ? "fa-moon" : "fa-sun"
          }`;
        };

        const initDatepickers = (parent = document) => {
          if (!parent) return;
          try {
            $(parent)
              .find(".pdate")
              .each(function () {
                if ($(this).hasClass("pwt-datepicker-input-element")) {
                  $(this).pDatepicker("destroy");
                }
              });
            $(parent)
              .find(".pdate")
              .pDatepicker({
                format: "YYYY/MM/DD",
                calendarType: "persian",
                autoClose: true,
                observer: true,
                initialValue: false,
                persianDigit: true,
                calendar: { persian: { locale: "fa" } },
                toolbox: { calendarSwitch: { enabled: false } },
              });
          } catch (e) {
            console.error("Datepicker init failed", e);
          }
        };

        const init = () => {
          loadData();
          setupEventListeners();
          switchPage("dashboard-page", "Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯");
        };

        init();
      });
    </script>
  </body>
</html>
