<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>Velocity ‚Äî Air Racer</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
<style>
:root{
  --bg-top:#aee1ff; --bg-bot:#eef7ff;
  --ink:#0e1a26; --glass:rgba(13,17,23,.18); --panel:#0d1117;
  --primary:#08a3ff; --ok:#2ed573; --warn:#ffd166; --danger:#ff4757;
  --lane:rgba(0,60,120,.12);
}
:root.neon {
  --bg-top:#080c12; --bg-bot:#0e1622;
  --ink:#e9f4ff; --lane:rgba(0,255,255,.14);
  --primary:#00e5ff; --ok:#00ffa0; --warn:#ffe066; --danger:#ff5c93;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:linear-gradient(var(--bg-top),var(--bg-bot)); color:var(--ink);
  font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  display:flex; align-items:center; justify-content:center; overflow:hidden;
}
.game{
  position:relative; width:100%; max-width:520px; aspect-ratio:9/16;
  background:transparent; border-radius:22px; overflow:hidden;
  border:4px solid #fff; box-shadow:0 20px 54px rgba(0,0,0,.3);
}
canvas{display:block; width:100%; height:100%}

/* HUD (minimal) */
.hud{
  position:absolute; top:10px; left:50%; transform:translateX(-50%);
  display:flex; gap:8px; z-index:30; pointer-events:none;
}
.pill{
  background:rgba(0,0,0,.35); color:#fff; padding:6px 10px; border-radius:999px;
  font:700 12px 'Inter'; min-width:72px; text-align:center; backdrop-filter:blur(6px)
}
.pill .v{font-weight:800}

/* Health */
.health{
  position:absolute; top:10px; left:10px; width:47%; height:8px; border-radius:999px;
  background:rgba(0,0,0,.18); overflow:hidden; backdrop-filter:blur(4px); z-index:30;
}
.health>span{ display:block; height:100%;
  background:linear-gradient(90deg,var(--ok),#ffe66d,#ff9f43,#ff6b6b);
  transform-origin:left center; width:100%;
}

/* Controls + buttons */
.controls{ position:absolute; bottom:10px; left:0; right:0; display:flex; justify-content:space-between; padding:0 10px; z-index:35 }
.btn{
  border:0; border-radius:14px; background:rgba(0,0,0,.35); color:#fff;
  padding:10px 14px; font:700 14px 'Exo 2', system-ui; backdrop-filter:blur(8px);
  box-shadow:0 6px 18px rgba(0,0,0,.25); user-select:none; touch-action:none;
}
.btn:active{transform:scale(.98)}
.icon{ position:absolute; top:10px; right:10px; z-index:35 }

/* Start/Over */
.gate, .over{
  position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center;
  color:#fff; font-family:'Exo 2',system-ui; z-index:40; text-align:center;
}
.gate{ background:rgba(13,17,23,.88); cursor:pointer }
.over{ background:rgba(13,17,23,.92); opacity:0; pointer-events:none; transition:.25s }
.over.show{ opacity:1; pointer-events:auto }
.title{ font-size:36px; letter-spacing:.2em; margin:0 0 8px; }
.small{ font:400 13px 'Inter'; opacity:.8 }

/* Toast */
.badge{
  position:absolute; left:50%; top:16%; transform:translate(-50%,-50%) scale(.9);
  color:#fff; background:rgba(0,0,0,.45); padding:10px 14px; border-radius:12px;
  font:700 14px 'Exo 2'; opacity:0; transition:all .35s cubic-bezier(.2,.9,.2,1);
  backdrop-filter:blur(8px); z-index:50; white-space:nowrap;
}
.badge.show{ top:14%; opacity:1; transform:translate(-50%,-50%) scale(1) }

/* Settings Drawer */
.drawer-toggle{ position:absolute; top:10px; right:58px; z-index:36 }
.drawer{
  position:absolute; right:-320px; top:0; height:100%; width:300px; z-index:39;
  background:var(--panel); color:#eef3ff; box-shadow:-12px 0 28px rgba(0,0,0,.45);
  transition:right .25s ease; border-left:1px solid rgba(255,255,255,.08);
  display:flex; flex-direction:column;
}
.drawer.open{ right:0 }
.drawer header{ padding:14px 16px; font-family:'Exo 2'; font-weight:800; letter-spacing:.08em; border-bottom:1px solid rgba(255,255,255,.08) }
.drawer .sec{ padding:12px 16px; border-bottom:1px solid rgba(255,255,255,.06) }
.drawer label{ display:flex; justify-content:space-between; gap:10px; align-items:center; font:600 13px 'Inter' }
.switch{ appearance:none; width:44px; height:24px; background:#5b6572; border-radius:999px; position:relative; outline:0; cursor:pointer }
.switch:checked{ background:#13cc8b }
.switch::after{ content:''; position:absolute; top:3px; left:3px; width:18px; height:18px; border-radius:999px; background:#fff; transition:left .2s }
.switch:checked::after{ left:23px }
.drawer .hint{ opacity:.75; font:400 12px 'Inter'; margin-top:8px }

/* Missions */
.missions .row{ display:flex; gap:8px; align-items:center; margin:4px 0 }
.missions .done{ color:#9effaa }
.mission-pill{ display:inline-flex; align-items:center; gap:6px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); padding:6px 10px; border-radius:10px; font:600 12px 'Inter' }
.progress{ height:6px; border-radius:999px; background:rgba(255,255,255,.1); overflow:hidden; margin-left:auto; flex:1 }
.progress>span{ display:block; height:100%; background:linear-gradient(90deg,#23d4ff,#4cff9f) }

/* Mission button indicator */
.mission-dot{
  position:absolute; top:6px; right:6px; width:8px; height:8px; border-radius:50%; background:#ff4d8d; box-shadow:0 0 10px #ff4d8d; display:none;
}
.mission-dot.show{ display:block }
</style>
</head>
<body>
  <div class="game" id="game">
    <canvas id="cv"></canvas>

    <!-- HUD -->
    <div class="health"><span id="hpFill"></span></div>
    <div class="hud">
      <div class="pill">Score <span class="v" id="score">0</span></div>
      <div class="pill">Speed <span class="v" id="spd">0</span></div>
      <div class="pill">Ammo <span class="v" id="ammo">120</span></div>
    </div>

    <!-- Buttons -->
    <button class="btn icon" id="muteBtn">üîä</button>
    <button class="btn drawer-toggle" id="drawerBtn">‚öôÔ∏è</button>
    <div class="controls">
      <button class="btn" id="fireBtn">üî´ Hold</button>
      <button class="btn" id="helpBtn">‚ÑπÔ∏è</button>
    </div>

    <!-- Settings Drawer -->
    <div class="drawer" id="drawer">
      <header>Settings</header>
      <div class="sec">
        <label>Rival Shooting <input type="checkbox" class="switch" id="optRivalFire"></label>
        <label>Cloud Lightning <input type="checkbox" class="switch" id="optLightning"></label>
        <label>Neon Colorway <input type="checkbox" class="switch" id="optNeon"></label>
        <label>Use Sprites (PNG) <input type="checkbox" class="switch" id="optSprites"></label>
        <div class="hint">Toggle visual & gameplay features. (Stored locally)</div>
      </div>
      <div class="sec missions">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
          <div style="font-family:'Exo 2';font-weight:800">Missions</div>
          <div class="mission-dot" id="missionDot"></div>
        </div>
        <div id="missionList"></div>
        <div class="hint">Complete missions for score bonuses.</div>
      </div>
      <div class="sec">
        <div style="font:600 12px 'Inter';opacity:.9;margin-bottom:6px">Sprites (optional):</div>
        <label style="flex-direction:column;align-items:stretch">
          Plane PNG URL
          <input id="planeURL" placeholder="https://‚Ä¶/plane.png" style="margin-top:6px;padding:6px;border-radius:8px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);color:#fff">
        </label>
        <label style="margin-top:8px;flex-direction:column;align-items:stretch">
          Cloud PNG URL
          <input id="cloudURL" placeholder="https://‚Ä¶/cloud.png" style="margin-top:6px;padding:6px;border-radius:8px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);color:#fff">
        </label>
        <button class="btn" id="loadSprites" style="margin-top:10px">Load Sprites</button>
      </div>
    </div>

    <!-- Start / Over / Toast -->
    <div class="gate" id="gate">
      <div>
        <div class="title">VELOCITY</div>
        <div class="small">Tap to Start ‚Ä¢ Swipe ‚óÄ ‚ñ∂ lanes ‚Ä¢ ‚ñ≤ accel ‚Ä¢ ‚ñº brake ‚Ä¢ Hold üî´ / Space to fire</div>
      </div>
    </div>
    <div class="over" id="over">
      <div class="title" style="letter-spacing:.1em">GAME OVER</div>
      <div class="small">Score: <b id="final">0</b> ‚Ä¢ Best: <b id="best">0</b></div>
      <button class="btn" id="again">Restart</button>
    </div>
    <div class="badge" id="toast">+100</div>
  </div>

<script>
(() => {
  /* ---------- Elements ---------- */
  const cv = document.getElementById('cv'), ctx = cv.getContext('2d', { alpha:true });
  const hud = { score:$('#score'), spd:$('#spd'), ammo:$('#ammo'), hp:$('#hpFill') };
  const gate = $('#gate'), over = $('#over'), finalEl = $('#final'), bestEl = $('#best');
  const btnAgain = $('#again'), btnMute = $('#muteBtn'), btnHelp = $('#helpBtn'), fireBtn = $('#fireBtn');
  const drawer = $('#drawer'), drawerBtn = $('#drawerBtn');
  const toast = $('#toast'), missionDot = $('#missionDot'), missionList = $('#missionList');
  const planeURL = $('#planeURL'), cloudURL = $('#cloudURL'), loadSpritesBtn = $('#loadSprites');
  const opt = {
    rivalFire: $('#optRivalFire'),
    lightning: $('#optLightning'),
    neon: $('#optNeon'),
    sprites: $('#optSprites'),
  };

  /* ---------- Utils ---------- */
  function $(s){ return document.querySelector(s) }
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const R = Math.random, TAU = Math.PI*2;
  const now = ()=>performance.now();

  /* ---------- Settings (persist) ---------- */
  const store = {
    get(k, d){ try{ return JSON.parse(localStorage.getItem(k) ?? JSON.stringify(d)) }catch{ return d } },
    set(k, v){ localStorage.setItem(k, JSON.stringify(v)) }
  };
  const SETTINGS_KEY = 'velocity-settings-v2';
  let settings = store.get(SETTINGS_KEY, { rivalFire:true, lightning:true, neon:false, sprites:false, plane:'', cloud:'' });

  function applySettingsUI(){
    opt.rivalFire.checked = settings.rivalFire;
    opt.lightning.checked = settings.lightning;
    opt.neon.checked = settings.neon;
    opt.sprites.checked = settings.sprites;
    planeURL.value = settings.plane || '';
    cloudURL.value = settings.cloud || '';
    document.documentElement.classList.toggle('neon', !!settings.neon);
  }
  function saveSettings(){
    settings.rivalFire = opt.rivalFire.checked;
    settings.lightning = opt.lightning.checked;
    settings.neon = opt.neon.checked;
    settings.sprites = opt.sprites.checked;
    settings.plane = planeURL.value.trim();
    settings.cloud = cloudURL.value.trim();
    store.set(SETTINGS_KEY, settings);
    document.documentElement.classList.toggle('neon', !!settings.neon);
  }
  Object.values(opt).forEach(el=> el.addEventListener('change', saveSettings));
  drawerBtn.addEventListener('click', ()=> drawer.classList.toggle('open'));
  loadSpritesBtn.addEventListener('click', ()=>{ saveSettings(); loadSprites(); });

  /* ---------- Audio ---------- */
  const master = new Tone.Gain(0.9).toDestination();
  const lowpass = new Tone.Filter(20000, "lowpass").connect(master);
  const sCollision = new Tone.NoiseSynth({ noise:{type:"pink"}, envelope:{attack:.001,decay:.22,sustain:0,release:.05} }).connect(lowpass);
  const sScore = new Tone.Synth({ oscillator:{type:"sine"}, envelope:{attack:.001,decay:.08,sustain:0,release:.08} }).connect(lowpass);
  const sPower = new Tone.FMSynth({ harmonicity:1.35, modulationIndex:14, envelope:{attack:.01,decay:.2,release:.35} }).connect(lowpass);
  const sPass = new Tone.MonoSynth({ oscillator:{type:"square"}, envelope:{attack:.001,decay:.05,sustain:0,release:.05} }).connect(lowpass);
  // NEW: crisp ‚Äúpew‚Äù laser with fast filter envelope (improves bullet sound)
  const shootSynth = new Tone.MonoSynth({
    oscillator:{ type:"triangle" },
    envelope:{ attack:0.001, decay:0.06, sustain:0, release:0.05 },
    filter:{ type:"bandpass", Q:8, frequency:1600 },
    filterEnvelope:{ attack:0.001, decay:0.06, sustain:0, release:0.05, baseFrequency:1200, octaves:2 }
  }).connect(lowpass);
  function SFX(type){ if(Tone.context.state!=='running' || Tone.Destination.mute) return;
    if(type==='coll') sCollision.triggerAttackRelease('8n');
    else if(type==='score') sScore.triggerAttackRelease('E5','16n');
    else if(type==='power') sPower.triggerAttackRelease('A4','8n');
    else if(type==='pass') sPass.triggerAttackRelease('G4','16n');
    else if(type==='shoot') shootSynth.triggerAttackRelease('A6','32n');
  }

  /* ---------- Sprites (optional) ---------- */
  const SPR = { plane:null, cloud:null, loaded:false };
  function loadSprites(){
    SPR.plane = settings.plane ? new Image() : null;
    SPR.cloud = settings.cloud ? new Image() : null;
    let toLoad = 0, loaded = 0;
    function done(){ SPR.loaded = (settings.sprites && ( (SPR.plane?SPR.plane.complete:true) && (SPR.cloud?SPR.cloud.complete:true) )); }
    if(SPR.plane){ toLoad++; SPR.plane.onload = ()=>{ loaded++; done() }; SPR.plane.onerror=done; SPR.plane.src = settings.plane; }
    if(SPR.cloud){ toLoad++; SPR.cloud.onload = ()=>{ loaded++; done() }; SPR.cloud.onerror=done; SPR.cloud.src = settings.cloud; }
    if(!toLoad) done();
  }
  loadSprites();

  /* ---------- Game constants ---------- */
  const LANES = 4;
  const BASE_SPEED = 2.6, MIN_SPEED = 1.4, MAX_SPEED = 16.0; // raise cap for 800 km/h mission
  const ACCEL = 0.006, BRAKE = 0.011;
  const PLAYER_W = 40, PLAYER_H = 48;

  const AMMO_MAX = 120, RECHARGE_MS = 8000, FIRE_INTERVAL = 90;
  const HEALTH_MAX = 100, REGEN_DELAY = 1200, REGEN_PER_SEC = 16, INVULN_MS = 650;

  const NEAR_MISS_DIST = 54, COMBO_WINDOW = 1500;
  const BOOST_TIME = 2200, BOOST_GAIN = 2.1;

  /* ---------- State ---------- */
  let W=0, H=0, lanesX=[];
  let raf=0, tPrev=0;
  let running=false, dead=false;

  let score=0, best= +localStorage.getItem('velBest') || 0;
  let speed=BASE_SPEED, accel=false, brake=false, holdingFire=false;

  let ammo=AMMO_MAX, lastAmmo=0, lastShot=0;
  let health=HEALTH_MAX, lastHit=-1e9, invulnTill=0;

  let sonicActive=false, sonicT=0;

  const ents=[], bullets=[], eBullets=[], parts=[], clouds=[], lines=[];
  let player, spawnT=0, difficulty=0;
  let weaveCombo=0, lastLaneSwap=-1e9, comboT=-1e9, scoreMult=1;

  const cam = { x:0, y:0, shake:0 };

  /* ---------- Missions ---------- */
  // id, label, progress, goal, done, reward
  const MISSIONS_KEY='velocity-missions-v2';
  let missions = store.get(MISSIONS_KEY, [
    { id:'weave5', label:'Weave 5 near-misses in a row', p:0, goal:5, done:false, reward:500 },
    { id:'speed800', label:'Reach 800 km/h', p:0, goal:1, done:false, reward:600 },
    { id:'stars5', label:'Collect 5 ‚≠ê', p:0, goal:5, done:false, reward:400 },
    { id:'sonic3', label:'Trigger 3 sonic booms', p:0, goal:3, done:false, reward:800 }
  ]);
  let sonicCount=0, starCount=0;

  function renderMissions(){
    missionList.innerHTML = '';
    let anyPending=false;
    missions.forEach(m=>{
      const row = document.createElement('div'); row.className='row';
      const pill = document.createElement('div'); pill.className='mission-pill'; pill.textContent = m.label;
      const prog = document.createElement('div'); prog.className='progress';
      const bar = document.createElement('span'); bar.style.width = (100*Math.min(1,m.p/m.goal))+'%';
      prog.appendChild(bar);
      const done = document.createElement('div'); done.textContent = m.done ? '‚úì' : `${m.p}/${m.goal}`;
      done.className = m.done ? 'done' : '';
      row.appendChild(pill); row.appendChild(prog); row.appendChild(done);
      missionList.appendChild(row);
      if(!m.done) anyPending=true;
    });
    missionDot.classList.toggle('show', anyPending);
  }
  function saveMissions(){ store.set(MISSIONS_KEY, missions); renderMissions(); }
  function missionHit(id, inc=1){
    const m = missions.find(x=>x.id===id); if(!m || m.done) return;
    m.p = Math.min(m.goal, m.p+inc);
    if(m.p>=m.goal){ m.done=true; score += m.reward; toastMsg(`Mission complete! +${m.reward}`); }
    saveMissions();
  }

  /* ---------- Elements helpers ---------- */
  function resize(){
    const r = cv.parentElement.getBoundingClientRect();
    cv.width = W = r.width|0; cv.height = H = r.height|0;
    lanesX = Array.from({length:LANES}, (_,i)=> (i+0.5)*(W/LANES));
    if(player){ player.y = H - PLAYER_H - 56; player.x = lanesX[player.lane]-player.w/2; player.targetX=player.x; }
  }
  function toastMsg(txt){ toast.textContent=txt; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),1200); }
  function shake(a){ cam.shake = Math.max(cam.shake, a||8); }

  /* ---------- Player ---------- */
  function makePlayer(){ return { lane:(LANES/2)|0, x:0, y:0, w:PLAYER_W, h:PLAYER_H, bank:0, targetX:0, smokeT:0 } }

  /* ---------- Spawning ---------- */
  const TYPE = { RIVAL:'rival', OBST:'obst', CLOUD:'cloudHaz', LIGHT:'light', BOOST:'boost', REPAIR:'repair', STAR:'star' };
  function spawnRival(lane,y){
    const w=36,h=44, sp=2+R()*2 + speed*.15;
    ents.push({ kind:TYPE.RIVAL, lane, x:lanesX[lane]-w/2, y, w,h, sp, color: randPick(['#ff3b3b','#ff9f1a','#5b8cff','#1abc9c','#c56cf0']), aiT:0, shootT:R()*1200+800, passed:false });
  }
  function spawnObstacle(lane,y){
    const w=38,h=36, sp=1.8+R()*1.8 + speed*.12;
    // high-contrast pylons with stripes
    ents.push({ kind:TYPE.OBST, lane, x:lanesX[lane]-w/2, y, w,h, sp, t:0 });
  }
  function spawnCloudHaz(lane,y){
    const w=54,h=46, sp = 1.2+R()*1.2 + speed*.09;
    ents.push({ kind:TYPE.CLOUD, lane, x:lanesX[lane]-w/2, y, w,h, sp, lt:R()*1800+1400 });
  }
  function spawnLightning(lane,y){
    ents.push({ kind:TYPE.LIGHT, lane, x:lanesX[lane]-2, y, w:4, h:100, sp:3+speed*.4, t:0 });
  }
  function spawnCollect(kind,lane,y){
    const w=28,h=28, sp = 1.6+R()*1.2 + speed*.08;
    ents.push({ kind, lane, x:lanesX[lane]-w/2, y, w,h, sp, t:0 });
  }
  function randPick(a){ return a[(Math.random()*a.length)|0] }

  function spawnLoop(dt){
    spawnT += dt;
    difficulty = Math.min(1, score/2200);
    const base = 900 - speed*40 - score*0.08;
    if(spawnT > Math.max(240, base)){
      spawnT = 0;
      const lanes = [0,1,2,3];
      const count = 2 + (R()<difficulty?1:0);
      for(let k=0;k<count;k++){
        const lane = lanes.splice((Math.random()*lanes.length)|0,1)[0];
        const y = -80 - k*60;
        const r = R();
        if(r<.35) spawnRival(lane,y);
        else if(r<.6) spawnObstacle(lane,y);
        else spawnCloudHaz(lane,y);
        if(score>400 && R()<.28) spawnCollect(randPick([TYPE.BOOST,TYPE.REPAIR,TYPE.STAR]), lane, y-60);
      }
    }
    // clouds background drift
    clouds.forEach((c,i)=>{ c.y += (c.v + speed*.12); c.x += Math.sin((now()+i*1000)/2800)*.1; if(c.y>H+40){ c.y -= H+80; c.x = (c.x+W)%W; } });
  }

  /* ---------- Bullets ---------- */
  function fire(){
    const t=now(); if(ammo<=0 || t-lastShot<FIRE_INTERVAL) return;
    lastShot=t; ammo--; hud.ammo.textContent=ammo; SFX('shoot');
    // brighter, bigger bullet with trail for visibility
    bullets.push({ x:player.x+player.w/2-3, y:player.y-12, w:6, h:18, sp:18+speed*1.2, trail:6, glow:1 });
  }

  /* ---------- Collisions ---------- */
  const aabb = (a,b)=> a.x<b.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y;
  function damage(d){ const t=now(); if(t<invulnTill) return;
    health = Math.max(0, health-d); hud.hp.style.transform = `scaleX(${health/HEALTH_MAX})`;
    lastHit=t; invulnTill=t+INVULN_MS; shake(14); SFX('coll');
  }

  /* ---------- Cloud bg ---------- */
  function seedClouds(){
    clouds.length=0;
    for(let i=0;i<22;i++) clouds.push({ x:R()*W, y:R()*H, r: 20+R()*28, v:.22, alpha:.8 });
  }

  /* ---------- Gameplay loop ---------- */
  function reset(){
    running=true; dead=false;
    score=0; speed=BASE_SPEED; accel=brake=false; holdingFire=false;
    ammo=AMMO_MAX; lastAmmo=now(); hud.ammo.textContent=AMMO_MAX;
    health=HEALTH_MAX; hud.hp.style.transform='scaleX(1)';
    lastHit=-1e9; invulnTill=0; sonicActive=false; sonicT=0; sonicCount=0; starCount=0;

    bullets.length=0; eBullets.length=0; ents.length=0; parts.length=0; lines.length=0;
    weaveCombo=0; scoreMult=1; comboT=-1e9;

    player = makePlayer(); resize(); seedClouds();
    over.classList.remove('show');
  }

  function update(dt){
    // speed
    if(accel) speed = Math.min(MAX_SPEED, speed + ACCEL*dt);
    if(brake) speed = Math.max(MIN_SPEED, speed - BRAKE*dt);
    if(!accel && !brake) speed = Math.max(BASE_SPEED, speed - 0.0009*dt);

    // sonic boom at cap
    if(speed>=MAX_SPEED && !sonicActive){
      sonicActive=true; sonicT=900; lowpass.frequency.rampTo(3200,.08);
      shake(20); toastMsg('SONIC BOOM!'); sonicCount++; if(sonicCount<=3) missionHit('sonic3',1);
    }
    if(sonicActive){ sonicT-=dt; if(sonicT<=0){ sonicActive=false; lowpass.frequency.rampTo(20000,.25); } }

    // ammo recharge
    const t=now();
    if(ammo<AMMO_MAX && t-lastAmmo>RECHARGE_MS){ ammo=AMMO_MAX; hud.ammo.textContent=ammo; lastAmmo=t; toastMsg('Ammo Recharged'); }

    // health regen
    if(t-lastHit>REGEN_DELAY && health<HEALTH_MAX){
      health = Math.min(HEALTH_MAX, health + REGEN_PER_SEC*dt/1000);
      hud.hp.style.transform = `scaleX(${health/HEALTH_MAX})`;
    }

    // move player to lane center
    player.targetX = lanesX[player.lane]-player.w/2;
    player.x += (player.targetX - player.x)*.22;
    player.y = H - PLAYER_H - 56;

    // spawns
    spawnLoop(dt);

    // entities & hazards
    for(let i=ents.length-1;i>=0;i--){
      const e=ents[i]; e.y += (e.sp + speed*.4);
      if(e.kind==='rival'){
        if(settings.rivalFire){
          e.shootT -= dt;
          if(e.shootT<=0 && e.y>0 && e.y<H){
            e.shootT = 900 + R()*900;
            eBullets.push({ x:e.x+e.w/2-3, y:e.y+e.h-2, w:6, h:16, sp:7+speed*.9 });
          }
        }
        // simple lane ‚Äúaim‚Äù
        if(R()<0.003 + difficulty*0.006 && e.y>H*.2 && e.y<H*.72){
          const dir = Math.sign(player.lane - e.lane); e.lane = clamp(e.lane+dir,0,LANES-1);
          e.x = lanesX[e.lane] - e.w/2;
        }
      } else if(e.kind==='cloudHaz' || e.kind==='CLOUD'){
        if(settings.lightning){
          e.lt -= dt;
          if(e.lt<=0){ spawnLightning(e.lane, e.y+e.h); e.lt = 1600 + R()*1400; }
        }
      }

      // collisions with player
      if(aabb(e, player)){
        if(e.kind==='BOOST'){ speed = Math.min(MAX_SPEED, speed + BOOST_GAIN); score += 120*scoreMult; SFX('power'); toastMsg('Boost +120'); ents.splice(i,1); continue; }
        if(e.kind==='REPAIR'){ health = clamp(health+30,0,HEALTH_MAX); hud.hp.style.transform=`scaleX(${health/HEALTH_MAX})`; score += 60*scoreMult; SFX('power'); toastMsg('Repair +60'); ents.splice(i,1); continue; }
        if(e.kind==='STAR'){ score += 100*scoreMult; starCount++; missionHit('stars5',1); SFX('score'); toastMsg(`+${100*scoreMult}`); ents.splice(i,1); continue; }
        // hazards
        damage(e.kind==='LIGHT'? 34:22); explode(e); ents.splice(i,1); continue;
      }

      // near-miss reward
      if(!e.passed && e.y>player.y-NEAR_MISS_DIST && e.y<player.y+player.h && e.lane===player.lane){
        e.passed=true; const add=50*scoreMult; score+=add; SFX('pass'); toastMsg(`Near Miss +${add}`);
        if(now()-lastLaneSwap<COMBO_WINDOW){
          weaveCombo++; scoreMult = Math.min(4, 1 + weaveCombo*0.15);
          comboT = now();
          if(weaveCombo>=5) missionHit('weave5',1);
        }
      }

      if(e.y>H+80) ents.splice(i,1);
    }

    // bullets up
    for(let i=bullets.length-1;i>=0;i--){
      const b=bullets[i]; b.y -= b.sp; b.trail = Math.max(0, b.trail-0.5);
      let hit=false;
      for(let j=ents.length-1;j>=0;j--){
        const e=ents[j]; if(e.kind==='rival'||e.kind==='obst'||e.kind==='OBST'||e.kind==='CLOUD'||e.kind==='cloudHaz'||e.kind==='LIGHT'){
          if(aabb(b,e)){ score += (e.kind==='rival'?120:90)*scoreMult; explode(e); ents.splice(j,1); hit=true; break; }
        }
      }
      if(hit || b.y<-20) bullets.splice(i,1);
    }
    // bullets down
    for(let i=eBullets.length-1;i>=0;i--){
      const b=eBullets[i]; b.y += b.sp;
      if(aabb(b,player)){ damage(18); eBullets.splice(i,1); continue; }
      if(b.y>H+20) eBullets.splice(i,1);
    }

    // score tick + combo decay
    score += (dt/100) * (0.7 + speed*.06) * scoreMult;
    if(scoreMult>1 && now()-comboT>COMBO_WINDOW){ weaveCombo=0; scoreMult=1; }

    // missions: speed target
    if(!missions.find(m=>m.id==='speed800').done && speed*50>=800) missionHit('speed800',1);

    // game over
    if(health<=0){ gameOver(); }
  }

  /* ---------- Particles / FX ---------- */
  function explode(e){
    const col = (e.kind==='rival'? e.color : e.kind==='CLOUD' || e.kind==='cloudHaz' ? '#d0f0ff' : '#ff7a5a');
    for(let k=0;k<22;k++) parts.push({type:'expl',x:e.x+e.w/2,y:e.y+e.h/2, r: 3+R()*6, a:.9, vx:(R()-.5)*4, vy:(R()-.5)*4, col});
    for(let k=0;k<10;k++) parts.push({type:'frag',x:e.x+e.w/2,y:e.y+e.h/2, s: 3+R()*5, a:.8, vx:(R()-.5)*6, vy:(R()-.5)*6, col});
    if(parts.length>1200) parts.splice(0, parts.length-900); // anti-crash guard
  }
  function heatShimmer(){
    const cx = player.x+player.w/2, cy = player.y+player.h*0.9;
    ctx.save(); ctx.globalAlpha=.18;
    for(let i=0;i<7;i++){
      const off=i*8;
      ctx.beginPath();
      ctx.ellipse(cx + Math.sin((now()+off)/140)*(3+speed*.8), cy+off, 14, 6, 0, 0, TAU);
      ctx.fillStyle="rgba(255,255,255,.55)"; ctx.fill();
    }
    ctx.restore();
  }
  function speedLines(dt){
    if(accel || speed>BASE_SPEED+1){ for(let i=0;i<2;i++) lines.push({ x:(R()*W)|0, y:-20, len:10+R()*60, a:.22+R()*.22, sp:4+speed*1.6 }); }
    for(let i=lines.length-1;i>=0;i--){ const s=lines[i]; s.y+=s.sp; ctx.globalAlpha=s.a; ctx.fillStyle="#ffffff"; ctx.fillRect(s.x, s.y, 2, s.len); if(s.y>H+40) lines.splice(i,1); }
    ctx.globalAlpha=1;
  }

  /* ---------- Drawing ---------- */
  function drawSky(){
    // background gradient is CSS; add cloud ellipses
    clouds.forEach(cl=>{ ctx.globalAlpha=cl.alpha; if(settings.sprites && SPR.cloud) ctx.drawImage(SPR.cloud, cl.x-32, cl.y-24, 64, 48);
      else { ctx.fillStyle='rgba(255,255,255,.9)'; ctx.beginPath(); ctx.ellipse(cl.x,cl.y, cl.r*1.3, cl.r, 0, 0, TAU); ctx.fill(); }
    }); ctx.globalAlpha=1;
  }
  function drawLanes(){
    ctx.globalAlpha = .18;
    for(let i=1;i<LANES;i++){ const x=i*W/LANES; ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--lane'); ctx.fillRect(x-1,0,2,H); }
    ctx.globalAlpha = 1;
  }
  function drawPylon(e){
    const x=e.x, y=e.y, w=e.w, h=e.h;
    ctx.fillStyle = '#ff7a00'; // vivid orange
    ctx.fillRect(x,y,w,h);
    // black stripes
    ctx.fillStyle = '#111';
    ctx.fillRect(x, y+8, w, 5);
    ctx.fillRect(x, y+18, w, 5);
    ctx.fillRect(x, y+28, w, 5);
    // border
    ctx.strokeStyle='#2a1200'; ctx.lineWidth=2; ctx.strokeRect(x+0.5,y+0.5,w-1,h-1);
  }
  function drawRival(e){
    const x=e.x, y=e.y, w=e.w, h=e.h;
    if(settings.sprites && SPR.plane){ ctx.drawImage(SPR.plane, x-2, y-2, w+4, h+4); return; }
    ctx.fillStyle = e.color;
    ctx.beginPath();
    ctx.moveTo(x+w/2, y);
    ctx.lineTo(x+w, y+h*.75); ctx.lineTo(x+w*0.7, y+h);
    ctx.lineTo(x+w*0.3, y+h); ctx.lineTo(x, y+h*.75);
    ctx.closePath(); ctx.fill();
    const g = ctx.createRadialGradient(x+w/2,y+h,1,x+w/2,y+h,w*.7);
    g.addColorStop(0,'rgba(255,255,255,.85)'); g.addColorStop(1, e.color+'00');
    ctx.fillStyle=g; ctx.fillRect(x-w/2,y+h*.6,w*2,h*.6);
  }
  function drawCloudHaz(e){
    if(settings.sprites && SPR.cloud){ ctx.drawImage(SPR.cloud, e.x, e.y, e.w, e.h); return; }
    ctx.fillStyle = "rgba(255,255,255,.92)";
    const cx=e.x+e.w/2, cy=e.y+e.h/2, r=e.w*.45;
    ctx.beginPath(); ctx.ellipse(cx,cy,r, r*.7, 0, 0, TAU); ctx.fill();
    ctx.beginPath(); ctx.ellipse(cx-r*.7,cy+4,r*.7, r*.55, 0, 0, TAU); ctx.fill();
    ctx.beginPath(); ctx.ellipse(cx+r*.7,cy+2,r*.65, r*.52, 0, 0, TAU); ctx.fill();
  }
  function drawLightning(e){
    ctx.strokeStyle = "#fff2a8"; ctx.lineWidth=3; ctx.shadowColor="#fff2a8"; ctx.shadowBlur=18;
    const x = lanesX[e.lane];
    ctx.beginPath(); ctx.moveTo(x, e.y);
    for(let yy=0; yy<e.h; yy+=10) ctx.lineTo(x + (R()-.5)*10, e.y+yy);
    ctx.stroke(); ctx.shadowBlur=0;
  }
  function drawPlayer(){
    const tilt = (player.targetX - player.x)*.04; player.bank += (tilt - player.bank)*.18;
    ctx.save(); ctx.translate(player.x+player.w/2, player.y+player.h/2); ctx.rotate(player.bank);
    if(settings.sprites && SPR.plane){ ctx.drawImage(SPR.plane, -player.w/2-2, -player.h/2-2, player.w+4, player.h+4); }
    else{
      // fuselage
      ctx.fillStyle="#e9f6ff";
      ctx.beginPath(); ctx.moveTo(0,-player.h*.58);
      ctx.quadraticCurveTo(player.w*.24,-player.h*.15,0,player.h*.62);
      ctx.quadraticCurveTo(-player.w*.24,-player.h*.15,0,-player.h*.58);
      ctx.fill();
      // canopy
      ctx.fillStyle="#4fa6ff"; ctx.beginPath(); ctx.ellipse(0,-player.h*.18,player.w*.18,player.h*.22,0,0,TAU); ctx.fill();
      // wings
      ctx.fillStyle="#c6e8ff"; ctx.beginPath();
      ctx.moveTo(-player.w*.62, -player.h*.1);
      ctx.lineTo(player.w*.62, -player.h*.1);
      ctx.lineTo(player.w*.32, player.h*.18);
      ctx.lineTo(-player.w*.32, player.h*.18);
      ctx.closePath(); ctx.fill();
    }
    ctx.restore();
    // braking smoke
    if(brake){ player.smokeT++; if(player.smokeT%2===0){ for(let i=0;i<2;i++) parts.push({type:'smoke',x:player.x+player.w/2+(R()-.5)*10,y:player.y+player.h*.95,r:6+R()*8,a:.5,vx:(R()-.5)*.6,vy:1.2+R()*1.2}); } }
    heatShimmer();
  }
  function drawBullets(){
    // player bullets on TOP with glow & trail for visibility
    bullets.forEach(b=>{
      ctx.save();
      const trailLen = b.trail;
      if(trailLen>0){
        const grad = ctx.createLinearGradient(b.x+3, b.y, b.x+3, b.y+trailLen*3);
        grad.addColorStop(0,'#ffffff'); grad.addColorStop(1,'#ffffff00');
        ctx.fillStyle = grad; ctx.fillRect(b.x+1, b.y, 4, trailLen*3);
      }
      ctx.shadowColor="#fff"; ctx.shadowBlur=16; ctx.fillStyle="#fff";
      ctx.fillRect(b.x, b.y, b.w, b.h);
      ctx.shadowBlur=0; ctx.restore();
    });
    // enemy bullets
    ctx.fillStyle="#ffd166"; eBullets.forEach(b=>{ ctx.shadowColor="#ffd166"; ctx.shadowBlur=10; ctx.fillRect(b.x,b.y,b.w,b.h); ctx.shadowBlur=0; });
  }

  function drawParts(){
    for(let i=parts.length-1;i>=0;i--){
      const p=parts[i];
      if(p.type==='expl'){ ctx.globalAlpha=p.a; ctx.fillStyle=p.col||"#fff"; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,TAU); ctx.fill(); p.x+=p.vx; p.y+=p.vy; p.vx*=.98; p.vy*=.98; p.a-=.02; p.r*=.995; }
      else if(p.type==='frag'){ ctx.globalAlpha=p.a; ctx.fillStyle=p.col||"#fff"; ctx.fillRect(p.x,p.y,p.s,p.s); p.x+=p.vx; p.y+=p.vy; p.vy+=.1; p.a-=.018; }
      else if(p.type==='smoke'){ ctx.globalAlpha=p.a; ctx.fillStyle="rgba(255,255,255,.85)"; ctx.beginPath(); ctx.ellipse(p.x,p.y,p.r*1.1,p.r*.8,0,0,TAU); ctx.fill(); p.x+=p.vx; p.y+=p.vy; p.r*=1.01; p.a-=.012; }
      if(p.a<=0) parts.splice(i,1);
    }
    ctx.globalAlpha=1;
  }

  /* ---------- Render ---------- */
  function render(dt){
    ctx.clearRect(0,0,W,H);
    drawSky();
    drawLanes();
    speedLines(dt);
    // tiny camera shake
    if(cam.shake>0){ ctx.save(); ctx.translate((R()-.5)*cam.shake,(R()-.5)*cam.shake); cam.shake*=.88; }

    // entities under bullets
    ents.forEach(e=>{
      if(e.kind==='rival') drawRival(e);
      else if(e.kind==='OBST'||e.kind==='obst') drawPylon(e);
      else if(e.kind==='CLOUD'||e.kind==='cloudHaz') drawCloudHaz(e);
      else if(e.kind==='LIGHT') drawLightning(e);
    });

    // player on top of ents
    drawPlayer();

    // bullets top layer
    drawBullets();

    if(cam.shake>0) ctx.restore();

    // particles top-most
    drawParts();

    // sonic ring overlay
    if(sonicActive){
      const k = 1 - (sonicT/900); const r = (1-k)*Math.hypot(W,H);
      ctx.save(); ctx.globalAlpha=.26*k; ctx.strokeStyle="#fff"; ctx.lineWidth=8*k+2; ctx.beginPath(); ctx.arc(W/2,H*.62,r,0,TAU); ctx.stroke(); ctx.restore();
    }

    // HUD
    hud.score.textContent = Math.floor(score);
    hud.spd.textContent = Math.round(speed*50);
  }

  /* ---------- Loop ---------- */
  function loop(t){
    const dt = Math.min(32, t - tPrev || 16); tPrev = t;
    if(holdingFire) fire();
    // subtle shake when accelerating
    if(accel) cam.shake = Math.max(cam.shake, 1 + speed*.12);
    update(dt);
    render(dt);
    raf = requestAnimationFrame(loop);
  }

  /* ---------- Controls ---------- */
  const keys = {};
  document.addEventListener('keydown', e=>{
    if(e.repeat) return;
    if(!running && e.code==='Space'){ start(); return; }
    keys[e.code]=true;
    if(e.key==='ArrowLeft' && player.lane>0){ player.lane--; lastLaneSwap=now(); }
    if(e.key==='ArrowRight' && player.lane<LANES-1){ player.lane++; lastLaneSwap=now(); }
    if(e.key==='ArrowUp') accel=true;
    if(e.key==='ArrowDown') brake=true;
    if(e.code==='Space'){ holdingFire=true; fire(); }
  });
  document.addEventListener('keyup', e=>{
    keys[e.code]=false;
    if(e.key==='ArrowUp') accel=false;
    if(e.key==='ArrowDown') brake=false;
    if(e.code==='Space') holdingFire=false;
  });

  // Touch gestures
  let tStart=null, moved=false;
  function onStart(ev){
    const t=ev.changedTouches?ev.changedTouches[0]:ev;
    tStart={x:t.clientX,y:t.clientY}; moved=false;
    // Start firing if pressed Fire button region
    const r=fireBtn.getBoundingClientRect();
    if(t.clientX>r.left && t.clientX<r.right && t.clientY>r.top && t.clientY<r.bottom){ holdingFire=true; fire(); }
  }
  function onMove(ev){
    if(!tStart) return;
    const t=ev.changedTouches?ev.changedTouches[0]:ev;
    const dx=t.clientX-tStart.x, dy=t.clientY-tStart.y;
    const ax=Math.abs(dx), ay=Math.abs(dy);
    if(!moved && (ax>24 || ay>24)){
      moved=true;
      if(ax>ay){
        if(dx<0 && player.lane>0) { player.lane--; lastLaneSwap=now(); }
        if(dx>0 && player.lane<LANES-1) { player.lane++; lastLaneSwap=now(); }
      }else{
        if(dy<-12){ accel=true; brake=false; }
        if(dy> 12){ brake=true; accel=false; }
      }
    }
  }
  function onEnd(){ accel=false; brake=false; holdingFire=false; tStart=null }
  cv.addEventListener('touchstart', onStart, {passive:true});
  cv.addEventListener('touchmove', onMove, {passive:true});
  cv.addEventListener('touchend', onEnd, {passive:true});
  fireBtn.addEventListener('pointerdown', ()=>{ holdingFire=true; fire(); });
  fireBtn.addEventListener('pointerup', ()=>{ holdingFire=false; });

  btnMute.addEventListener('click', ()=>{ Tone.Destination.mute = !Tone.Destination.mute; btnMute.textContent = Tone.Destination.mute?'üîà':'üîä'; });
  btnHelp.addEventListener('click', ()=> toastMsg('Weave near rivals for combos ‚Ä¢ Collect ‚≠ê ‚úö ‚ö° ‚Ä¢ Toggle options in ‚öôÔ∏è'));

  /* ---------- Start / Over ---------- */
  function start(){
    gate.style.display='none';
    Tone.start().then(()=>{
      reset(); cancelAnimationFrame(raf); raf=requestAnimationFrame(loop);
    });
  }
  function gameOver(){
    running=false; cancelAnimationFrame(raf);
    finalEl.textContent = Math.floor(score);
    best = Math.max(best, Math.floor(score)); localStorage.setItem('velBest', best); bestEl.textContent = best;
    over.classList.add('show');
  }
  btnAgain.addEventListener('click', ()=>{ over.classList.remove('show'); start(); });
  gate.addEventListener('click', start);
  addEventListener('resize', resize);
  addEventListener('visibilitychange', ()=>{ if(document.hidden){ accel=false; brake=false; holdingFire=false; } });

  /* ---------- Boot ---------- */
  applySettingsUI(); renderMissions(); resize();
  // reflect settings on theme immediately
  document.documentElement.classList.toggle('neon', !!settings.neon);
})();
</script>
</body>
</html>
