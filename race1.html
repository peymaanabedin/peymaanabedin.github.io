<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no"/>
<title>Velocity ‚Äî Aurora Edition</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
<style>
:root{
  --bg1:#08121f; --bg2:#0b1f33; /* elegant dark base */
  --ink:#eaf4ff; --lane:rgba(0,255,255,.22);
  --primary:#00d0ff; --ok:#16d07e; --warn:#ffd166; --danger:#ff5c93; --panel:#0d1117;
}
:root.hc{ --lane:rgba(200,240,255,.32) }
:root.cb-deu{ --danger:#5465ff; --ok:#2ed573; --warn:#ffd166 }
:root.cb-pro{ --danger:#00a0ff; --ok:#2ed573; --warn:#ffd166 }
:root.cb-tri{ --danger:#ff5c93; --ok:#00c07a; --warn:#ffcc66 }
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--ink);
  font-family:'Inter',system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;display:flex;align-items:center;justify-content:center;overflow:hidden}
.game{position:relative;width:100%;max-width:540px;aspect-ratio:9/16;border-radius:22px;overflow:hidden;border:4px solid #0a2a40;box-shadow:0 22px 60px rgba(0,0,0,.45)}
canvas{display:block;width:100%;height:100%}

/* HUD (minimal) */
.hud{position:absolute;top:10px;left:50%;transform:translateX(-50%);display:flex;gap:8px;z-index:30;pointer-events:none}
.pill{background:rgba(0,0,0,.48);color:#fff;padding:6px 10px;border-radius:999px;font:700 12px 'Inter';min-width:72px;text-align:center;backdrop-filter:blur(6px)}
.pill .v{font-weight:800}
.health{position:absolute;top:10px;left:10px;width:48%;height:8px;border-radius:999px;background:rgba(255,255,255,.16);overflow:hidden;backdrop-filter:blur(4px);z-index:30}
.health>span{display:block;height:100%;background:linear-gradient(90deg,var(--ok),#7bffcb,#ffe66d,#ff9f43,#ff6b6b);transform-origin:left center;width:100%}
.mini{position:absolute;top:10px;right:10px;display:flex;gap:6px;z-index:31}
.tag{background:rgba(0,0,0,.45);color:#fff;font:700 11px 'Inter';padding:6px 8px;border-radius:10px;backdrop-filter:blur(6px)}

/* Buttons / Drawer */
.btn{border:0;border-radius:14px;background:rgba(0,0,0,.48);color:#fff;padding:10px 14px;font:700 14px 'Exo 2',system-ui;backdrop-filter:blur(8px);box-shadow:0 6px 18px rgba(0,0,0,.35);user-select:none}
.btn:active{transform:scale(.98)}
.controls{position:absolute;left:0;right:0;bottom:10px;display:flex;justify-content:space-between;padding:0 10px;z-index:35}
.icon{position:absolute;top:10px;right:64px;z-index:35}
.icon2{position:absolute;top:10px;right:10px;z-index:35}
.drawer{position:absolute;right:-330px;top:0;height:100%;width:330px;background:var(--panel);color:#eef3ff;z-index:39;box-shadow:-12px 0 28px rgba(0,0,0,.45);transition:right .25s ease;border-left:1px solid rgba(255,255,255,.08);display:flex;flex-direction:column}
.drawer.open{right:0}
.drawer header{padding:14px 16px;font-family:'Exo 2';font-weight:800;letter-spacing:.08em;border-bottom:1px solid rgba(255,255,255,.08)}
.drawer .sec{padding:12px 16px;border-bottom:1px solid rgba(255,255,255,.06)}
.drawer label{display:flex;justify-content:space-between;gap:10px;align-items:center;font:600 13px 'Inter';margin:6px 0}
.switch{appearance:none;width:48px;height:24px;background:#5b6572;border-radius:999px;position:relative;outline:0;cursor:pointer}
.switch:checked{background:#13cc8b}
.switch::after{content:'';position:absolute;top:3px;left:3px;width:18px;height:18px;border-radius:999px;background:#fff;transition:left .2s}
.switch:checked::after{left:27px}
.sel{width:100%;margin-top:6px;padding:6px;border-radius:8px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);color:#fff}
.input{width:100%;padding:6px;margin-top:6px;border-radius:8px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);color:#fff}

/* Missions */
.missions .row{display:flex;gap:8px;align-items:center;margin:6px 0}
.mission-pill{display:inline-flex;gap:6px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);padding:6px 10px;border-radius:10px;font:600 12px 'Inter'}
.progress{height:6px;border-radius:999px;background:rgba(255,255,255,.12);overflow:hidden;margin-left:auto;flex:1}
.progress>span{display:block;height:100%;background:linear-gradient(90deg,#23d4ff,#4cff9f)}
.mission-dot{position:absolute;top:6px;right:6px;width:8px;height:8px;border-radius:50%;background:#ff4d8d;box-shadow:0 0 10px #ff4d8d;display:none}
.mission-dot.show{display:block}

/* Overlays */
.gate,.over{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;font-family:'Exo 2',system-ui;z-index:40;text-align:center}
.gate{background:rgba(0,0,0,.7);cursor:pointer}
.over{background:rgba(0,0,0,.82);opacity:0;pointer-events:none;transition:.25s}
.over.show{opacity:1;pointer-events:auto}
.title{font-size:36px;letter-spacing:.2em;margin:0 0 8px}
.small{font:400 13px 'Inter';opacity:.85}
.badge{position:absolute;left:50%;top:16%;transform:translate(-50%,-50%) scale(.9);color:#fff;background:rgba(0,0,0,.55);padding:10px 14px;border-radius:12px;font:700 14px 'Exo 2';opacity:0;transition:all .35s cubic-bezier(.2,.9,.2,1);backdrop-filter:blur(8px);z-index:50;white-space:nowrap}
.badge.show{top:14%;opacity:1;transform:translate(-50%,-50%) scale(1)}
</style>
</head>
<body>
  <div class="game" id="game">
    <canvas id="cv"></canvas>

    <!-- HUD -->
    <div class="health"><span id="hpFill"></span></div>
    <div class="hud">
      <div class="pill">Score <span class="v" id="score">0</span></div>
      <div class="pill">Speed <span class="v" id="spd">0</span></div>
      <div class="pill">Ammo <span class="v" id="ammo">120</span></div>
      <div class="pill" id="timerPill" style="display:none">Time <span class="v" id="timer">180</span></div>
    </div>
    <div class="mini">
      <div class="tag" id="focusTag">Focus: 0%</div>
      <div class="tag" id="empTag">EMP: 0%</div>
    </div>

    <!-- Buttons -->
    <button class="btn icon" id="drawerBtn">‚öôÔ∏è</button>
    <button class="btn icon2" id="muteBtn">üîä</button>
    <div class="controls">
      <button class="btn" id="fireBtn">üî´ Hold</button>
      <button class="btn" id="helpBtn">‚ÑπÔ∏è</button>
    </div>

    <!-- Settings Drawer -->
    <div class="drawer" id="drawer">
      <header>Settings</header>
      <div class="sec">
        <label>Rival Shooting <input type="checkbox" class="switch" id="optRival" checked></label>
        <label>Cloud Lightning <input type="checkbox" class="switch" id="optLightning" checked></label>
        <label>High Contrast Lanes <input type="checkbox" class="switch" id="optHC" checked></label>
        <label>Zen Mode (chill) <input type="checkbox" class="switch" id="optZen"></label>
        <label>Time Attack (3m) <input type="checkbox" class="switch" id="optTA"></label>
        <label>Ghost Replay <input type="checkbox" class="switch" id="optGhost"></label>
        <label>Low-Spec Mode <input type="checkbox" class="switch" id="optLow"></label>
        <label>Audio Preset
          <select class="sel" id="selAudio">
            <option value="off">Off</option>
            <option value="soft" selected>Soft</option>
            <option value="arcade">Arcade</option>
          </select>
        </label>
        <label>Color-Blind Palette
          <select class="sel" id="selCB">
            <option value="none" selected>None</option>
            <option value="deu">Deuteranopia</option>
            <option value="pro">Protanopia</option>
            <option value="tri">Tritanopia</option>
          </select>
        </label>
      </div>
      <div class="sec">
        <div style="font:700 13px 'Inter';margin:4px 0">Daily & Codes</div>
        <label>Daily Seed Mode <input type="checkbox" class="switch" id="optDaily" checked></label>
        <label>Challenge Code</label>
        <input class="input" id="codeIn" placeholder="Paste or generate‚Ä¶">
        <div style="display:flex;gap:8px;margin-top:6px">
          <button class="btn" id="btnApply">Apply</button>
          <button class="btn" id="btnGen">Generate</button>
        </div>
      </div>
      <div class="sec">
        <div style="font:700 13px 'Inter';margin:4px 0">Pilot Perks</div>
        <div style="font:600 12px 'Inter';opacity:.85;margin-bottom:6px">XP: <span id="xp">0</span> ‚Ä¢ Points: <span id="pt">0</span></div>
        <label>+10 Ammo Cap <input type="checkbox" class="switch" id="perkAmmo"></label>
        <label>Faster Regen (+30%) <input type="checkbox" class="switch" id="perkRegen"></label>
        <label>Longer Boost (+40%) <input type="checkbox" class="switch" id="perkBoost"></label>
        <div class="hint" style="opacity:.75;font:400 12px 'Inter';margin-top:8px">Earn XP by score: 1 XP per 500 pts.</div>
      </div>
      <div class="sec missions">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
          <div style="font-family:'Exo 2';font-weight:800">Missions</div>
          <div class="mission-dot" id="missionDot"></div>
        </div>
        <div id="missionList"></div>
      </div>
    </div>

    <!-- Start / Over / Toast -->
    <div class="gate" id="gate">
      <div>
        <div class="title">VELOCITY</div>
        <div class="small">Tap to Start ‚Ä¢ Swipe ‚óÄ ‚ñ∂ ‚Ä¢ ‚ñ≤ accel ‚Ä¢ ‚ñº brake ‚Ä¢ Hold üî´ / Space=fire ‚Ä¢ Q=Focus ‚Ä¢ E=EMP</div>
      </div>
    </div>
    <div class="over" id="over">
      <div class="title" style="letter-spacing:.1em">GAME OVER</div>
      <div class="small">Score: <b id="final">0</b> ‚Ä¢ Best: <b id="best">0</b></div>
      <button class="btn" id="again">Restart</button>
    </div>
    <div class="badge" id="toast">+100</div>
  </div>

<script>
(() => {
"use strict";

/* --------- Shortcuts --------- */
const $=s=>document.querySelector(s);
const cv=$("#cv"), ctx=cv.getContext("2d",{alpha:true});
const el={score:$("#score"), spd:$("#spd"), ammo:$("#ammo"), hp:$("#hpFill"),
          gate:$("#gate"), over:$("#over"), final:$("#final"), best:$("#best"),
          toast:$("#toast"), drawer:$("#drawer"), missionList:$("#missionList"),
          missionDot:$("#missionDot"), timerPill:$("#timerPill"), timer:$("#timer"),
          focusTag:$("#focusTag"), empTag:$("#empTag"), xp:$("#xp"), pt:$("#pt")};
const btn={again:$("#again"), mute:$("#muteBtn"), fire:$("#fireBtn"), help:$("#helpBtn"), drawer:$("#drawerBtn"),
           apply:$("#btnApply"), gen:$("#btnGen")};
const sw={rival:$("#optRival"), lightning:$("#optLightning"), hc:$("#optHC"), zen:$("#optZen"),
          ta:$("#optTA"), ghost:$("#optGhost"), low:$("#optLow"), daily:$("#optDaily")};
const sel={audio:$("#selAudio"), cb:$("#selCB")};
const codeIn=$("#codeIn");
const TAU=Math.PI*2;

/* --------- Seeded RNG / Daily / Codes --------- */
function lcg(seed){let s=seed|0;return ()=>((s=(s*1664525+1013904223)|0)>>>0)/4294967296;}
function daySeed(){return +new Date().toISOString().slice(0,10).replace(/-/g,'');}
let mode={daily:true, code:null};
let R=Math.random;
function applySeed(){
  if(mode.code){ const s=parseInt(mode.code.slice(0,6),36)||daySeed(); R=lcg(s); }
  else if(mode.daily){ R=lcg(daySeed()); } else R=Math.random;
}
function encodeCode(){
  const s=(daySeed() ^ ((sw.rival.checked?1:0)<<1) ^ ((sw.lightning.checked?1:0)<<2) ^ ((sw.zen.checked?1:0)<<3))>>>0;
  return (s>>>0).toString(36).slice(0,6).toUpperCase();
}

/* --------- Settings persist --------- */
const SETTINGS='velocity-aurora-settings';
let set = JSON.parse(localStorage.getItem(SETTINGS)||'{"rival":true,"lightning":true,"hc":true,"zen":false,"ta":false,"ghost":false,"low":false,"audio":"soft","cb":"none","daily":true}');
function applySettingsUI(){
  Object.assign(sw,{});
  sw.rival.checked=set.rival; sw.lightning.checked=set.lightning; sw.hc.checked=set.hc;
  sw.zen.checked=set.zen; sw.ta.checked=set.ta; sw.ghost.checked=set.ghost; sw.low.checked=set.low; sw.daily.checked=set.daily;
  sel.audio.value=set.audio; sel.cb.value=set.cb;
  document.documentElement.classList.toggle('hc', !!set.hc);
  document.documentElement.classList.toggle('cb-deu', set.cb==='deu');
  document.documentElement.classList.toggle('cb-pro', set.cb==='pro');
  document.documentElement.classList.toggle('cb-tri', set.cb==='tri');
  mode.daily=set.daily; applySeed();
}
function saveSettings(){ set={rival:sw.rival.checked, lightning:sw.lightning.checked, hc:sw.hc.checked, zen:sw.zen.checked, ta:sw.ta.checked, ghost:sw.ghost.checked, low:sw.low.checked, audio:sel.audio.value, cb:sel.cb.value, daily:sw.daily.checked}; localStorage.setItem(SETTINGS, JSON.stringify(set)); applySettingsUI(); }
[sw.rival,sw.lightning,sw.hc,sw.zen,sw.ta,sw.ghost,sw.low,sw.daily].forEach(x=>x.addEventListener('change', saveSettings));
[sel.audio, sel.cb].forEach(x=>x.addEventListener('change', saveSettings));

/* --------- Audio (arm on gesture, presets, throttled) --------- */
let audioArmed=false;
const limiter=new Tone.Limiter(-6).toDestination();
const master = new Tone.Gain(0.7).connect(limiter);
const lowpass= new Tone.Filter(20000,"lowpass").connect(master);
const quiet=()=> sel.audio.value==='off';
function armAudio(){ if(audioArmed || quiet()) return Promise.resolve(); return Tone.start().then(()=> audioArmed=true).catch(()=>{}); }
const lastPlay={coll:0,score:0,power:0,pass:0,shoot:0,focus:0,emp:0}; const minGap={coll:.06,score:.05,power:.08,pass:.06,shoot:.03,focus:.2,emp:.3};
function throttled(kind, fn){ if(quiet() || !audioArmed) return; const t=Tone.now(); if(t-lastPlay[kind]<(minGap[kind]||.05)) return; lastPlay[kind]=t+1e-4; fn(t+1e-4); }

const sShoot=()=>throttled('shoot',at=> shootSynth.triggerAttackRelease('A6','32n',at));
const sColl =()=>throttled('coll',at=> noiseColl.triggerAttackRelease('8n',at));
const sScore=()=>throttled('score',at=> toneScore.triggerAttackRelease('E5','16n',at));
const sPower=()=>throttled('power',at=> fmPower.triggerAttackRelease('A4','8n',at));
const sPass =()=>throttled('pass', at=> tonePass.triggerAttackRelease('G4','16n',at));
const sFocus=()=>throttled('focus',at=> toneFocus.triggerAttackRelease('C5','8n',at));
const sEMP  =()=>throttled('emp',  at=> toneEMP.triggerAttackRelease('E4','8n',at));

/* synth nodes by preset */
let noiseColl,toneScore,fmPower,tonePass,shootSynth,toneFocus,toneEMP;
function configureSynths(){
  // disconnect previous (Tone handles GC)
  const mode=sel.audio.value;
  if(mode==='off'){ return; }
  const soft = mode==='soft';
  noiseColl = new Tone.NoiseSynth({noise:{type:"pink"}, envelope:{attack:.001,decay:.16,sustain:0,release:.05}}).connect(lowpass);
  toneScore = new Tone.Synth({oscillator:{type:soft?'sine':'square'}, envelope:{attack:.001,decay:.07,sustain:0,release:.07}}).connect(lowpass);
  fmPower   = new Tone.FMSynth({harmonicity:1.3, modulationIndex:soft?10:16, envelope:{attack:.01,decay:.18,release:.3}}).connect(lowpass);
  tonePass  = new Tone.MonoSynth({oscillator:{type:soft?'triangle':'square'}, envelope:{attack:.001,decay:.04,sustain:0,release:.04}}).connect(lowpass);
  shootSynth= new Tone.MonoSynth({oscillator:{type:soft?'triangle':'sawtooth'}, envelope:{attack:.001,decay:.05,sustain:0,release:.04},
                                  filter:{type:"bandpass",Q:soft?6:10,frequency:soft?1200:1600},
                                  filterEnvelope:{attack:.001,decay:.05,sustain:0,release:.04,baseFrequency:soft?900:1100,octaves:2}}).connect(lowpass);
  toneFocus = new Tone.Synth({oscillator:{type:'sine'}, envelope:{attack:.001,decay:.12,sustain:0,release:.12}}).connect(lowpass);
  toneEMP   = new Tone.MonoSynth({oscillator:{type:'square'}, envelope:{attack:.001,decay:.1,sustain:0,release:.08}}).connect(lowpass);
}

/* --------- Gameplay constants --------- */
const LANES=4, PLAYER_W=42, PLAYER_H=50;
const BASE_SPEED=2.6, MIN_SPEED=1.4, MAX_SPEED=16.0, ACCEL=0.006, BRAKE=0.011;
let AMMO_MAX=120, RECHARGE_MS=8000, FIRE_MS=90;
let HP_MAX=100, REGEN_DELAY=1200, REGEN_PER_S=16, INV_MS=650;
const NEAR=54, COMBO_MS=1500;

/* Perks (simple tree) */
const PERKS_KEY='velocity-aurora-perks';
let perks = JSON.parse(localStorage.getItem(PERKS_KEY)||'{"ammo":false,"regen":false,"boost":false,"xp":0,"pts":0}');
const pk={ammo:$("#perkAmmo"), regen:$("#perkRegen"), boost:$("#perkBoost")};
function applyPerks(){
  AMMO_MAX = 120 + (perks.ammo?10:0);
  REGEN_PER_S = (16)*(perks.regen?1.3:1.0);
  BOOST_BONUS = 2.1*(perks.boost?1.4:1.0);
  el.xp.textContent=perks.xp|0; el.pt.textContent=perks.pts|0;
  pk.ammo.checked=perks.ammo; pk.regen.checked=perks.regen; pk.boost.checked=perks.boost;
}
function buyPerk(name){ if(perks[name] || perks.pts<=0) return; perks[name]=true; perks.pts--; savePerks(); applyPerks(); }
function savePerks(){ localStorage.setItem(PERKS_KEY, JSON.stringify(perks)); }
[pk.ammo,pk.regen,pk.boost].forEach((el,i)=> el.addEventListener('change', ()=>{ const key=['ammo','regen','boost'][i]; if(!perks[key]) buyPerk(key); else { el.checked=true; }}));

/* --------- Missions (rotating) --------- */
const MISS='velocity-aurora-missions';
let missions = JSON.parse(localStorage.getItem(MISS)||'[]');
function seedMissions(){
  const pool=[
    {id:'weave5', label:'Weave 5 near-misses', goal:5, reward:500},
    {id:'speed800', label:'Reach 800 km/h', goal:1, reward:600},
    {id:'stars5', label:'Collect 5 ‚≠ê', goal:5, reward:400},
    {id:'sonic3', label:'Trigger 3 sonic booms', goal:3, reward:800},
    {id:'draft6', label:'Draft 6 times', goal:6, reward:450},
    {id:'emp2', label:'Use EMP 2 times', goal:2, reward:350},
    {id:'focus8', label:'Use Focus for 8s total', goal:8, reward:500}
  ];
  // daily rotate
  const rng=lcg(daySeed());
  missions = []; for(let i=0;i<4;i++){ const m = pool.splice((rng()*pool.length)|0,1)[0]; missions.push({id:m.id,label:m.label,p:0,goal:m.goal,done:false,reward:m.reward}); }
  saveMissions();
}
function renderMissions(){
  el.missionList.innerHTML=''; let pending=false;
  missions.forEach(m=>{
    const row=document.createElement('div'); row.className='row';
    const pill=document.createElement('div'); pill.className='mission-pill'; pill.textContent=m.label;
    const prog=document.createElement('div'); prog.className='progress';
    const bar=document.createElement('span'); bar.style.width=(100*Math.min(1,m.p/m.goal))+'%'; prog.appendChild(bar);
    const stat=document.createElement('div'); stat.textContent=m.done?'‚úì':`${m.p}/${m.goal}`; stat.style.marginLeft='8px'; if(m.done) stat.style.color='#9effaa';
    row.appendChild(pill); row.appendChild(prog); row.appendChild(stat); el.missionList.appendChild(row); if(!m.done) pending=true;
  });
  el.missionDot.classList.toggle('show', pending);
}
function saveMissions(){ renderMissions(); localStorage.setItem(MISS, JSON.stringify(missions)); }
function missionHit(id,inc=1){ const m=missions.find(x=>x.id===id); if(!m||m.done) return; m.p=Math.min(m.goal,(m.p||0)+inc); if(m.p>=m.goal){ m.done=true; score+=m.reward; toast(`Mission complete! +${m.reward}`);} saveMissions(); }

/* --------- State --------- */
let W=0,H=0, lanesX=[];
let raf=0, running=false;
let speed=BASE_SPEED, accel=false, brake=false, firing=false;
let score=0, best=+localStorage.getItem('velBestAurora')||0;
let ammo=AMMO_MAX, lastAmmo=0, lastShot=0;
let hp=HP_MAX, lastHit=-1e9, invTil=0;
let sonic=false, sonicT=0, sonicCount=0, stars=0;
let weave=0, lastSwap=-1e9, comboT=-1e9, mult=1;
let timer=180000; // ms for Time Attack
let dtCarry=0;

const TYPE={RIVAL:'rival', OBST:'obst', CLOUD:'cloud', LIGHT:'light', BOOST:'boost', REPAIR:'repair', STAR:'star', WEATHER:'weather', ACE:'ace'};
const ents=[], bullets=[], eBullets=[], parts=[], clouds=[], lines=[];
let player, ghost=[], ghostPlaying=[], ghostOn=false;

/* Drafting / Focus / EMP */
let draftT=0, focusEnergy=0, focusOn=false, empEnergy=0;

/* Boost tuning (perk aware) */
let BOOST_BONUS=2.1;

/* Camera / effect */
const cam={shake:0, zoom:1};

/* Haptics */
const buzz=(ms=12)=>{ if(navigator.vibrate) try{ navigator.vibrate(ms); }catch{} };

/* --------- UI helpers --------- */
function toast(txt){ el.toast.textContent=txt; el.toast.classList.add('show'); setTimeout(()=>el.toast.classList.remove('show'),1100); }
function resize(){ const r=cv.parentElement.getBoundingClientRect(); cv.width=W=r.width|0; cv.height=H=r.height|0; lanesX=Array.from({length:LANES},(_,i)=>(i+.5)*(W/LANES)); if(player){ player.y=H-PLAYER_H-56; player.x=lanesX[player.lane]-player.w/2; player.tx=player.x; } }

/* --------- Player --------- */
function makePlayer(){ return {lane:(LANES/2)|0, x:0,y:0,w:PLAYER_W,h:PLAYER_H, bank:0, tx:0, smoke:0} }

/* --------- Spawning --------- */
const pick=a=>a[(R()*a.length)|0];
function spawnRival(l,y){ const w=38,h=46, sp=2+R()*2+speed*.15;
  ents.push({kind:TYPE.RIVAL,lane:l,x:lanesX[l]-w/2,y,w,h,sp,color:pick(['#ff3b3b','#ff9f1a','#4ca3ff','#19c997','#c56cf0']), shot:800+R()*900, passed:false}); }
function spawnObst(l,y){ const w=40,h=38, sp=1.8+R()*1.8+speed*.12; ents.push({kind:TYPE.OBST,lane:l,x:lanesX[l]-w/2,y,w,h,sp}); }
function spawnCloud(l,y){ const w=58,h=48, sp=1.2+R()*1.2+speed*.09; ents.push({kind:TYPE.CLOUD,lane:l,x:lanesX[l]-w/2,y,w,h,sp,t:1400+R()*1600}); }
function spawnLight(l,y){ ents.push({kind:TYPE.LIGHT,lane:l,x:lanesX[l]-2,y,w:4,h:110,sp:3+speed*.4}); }
function spawnPick(k,l,y){ const w=28,h=28, sp=1.6+R()*1.2+speed*.08; ents.push({kind:k,lane:l,x:lanesX[l]-w/2,y,w,h,sp}); }
function spawnWeather(){
  const l= (R()*LANES)|0, y = -H*1.5; // long band
  const t = pick(['rain','cross','clear']);
  ents.push({kind:TYPE.WEATHER,lane:l,x:0,y,w:W,h:H*2.2,sp:1, type:t});
}
function spawnAce(){
  // mini-boss
  const l=(R()*LANES)|0, y=-120, w=52,h=58, hp=5;
  ents.push({kind:TYPE.ACE,lane:l,x:lanesX[l]-w/2,y,w,h,sp:2+R()*1.5+speed*.12,hp,color:'#ffd166', shot:500, phase:0, dir: (R()<.5?-1:1) });
}

let spawnAcc=0, weatherAcc=0, aceAcc=0;
function spawnStep(dt){
  spawnAcc+=dt; weatherAcc+=dt; aceAcc+=dt;
  const base= (set.zen?1100:900) - speed*40 - score*0.08;
  if(spawnAcc>Math.max(260,base)){ spawnAcc=0;
    const lanes=[0,1,2,3]; const count= (set.zen?2:2+(R()<Math.min(1,score/2200)?1:0));
    for(let k=0;k<count;k++){
      const l=lanes.splice((R()*lanes.length)|0,1)[0]; const y=-80-k*60; const r=R();
      if(r<.35) spawnRival(l,y); else if(r<.6) spawnObst(l,y); else spawnCloud(l,y);
      if(score>400 && R()<.28 && !set.zen) spawnPick(pick([TYPE.BOOST,TYPE.REPAIR,TYPE.STAR]), l, y-60);
    }
  }
  if(weatherAcc>8000){ weatherAcc=0; spawnWeather(); }
  if(!set.zen && aceAcc>(45000 - Math.min(30000, score*5))){ aceAcc=0; spawnAce(); }

  clouds.forEach((c,i)=>{ c.y+=(c.v + speed*.1); c.x+=Math.sin((performance.now()+i*900)/2600)*.12; if(c.y>H+40){ c.y-=H+80; c.x=(c.x+W)%W; } });
}

/* --------- Bullets --------- */
function fire(){
  const t = performance.now();
  if(ammo<=0 || t-lastShot<FIRE_MS) return;
  lastShot=t; ammo--; el.ammo.textContent=ammo; sShoot();
  bullets.push({x:player.x+player.w/2-3, y:player.y-12, w:7,h:22, sp:18+speed*1.2, trail:10});
}

/* --------- Damage / Collisions --------- */
function aabb(a,b){ return a.x<b.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y; }
function damage(d){ const t=performance.now(); if(t<invTil) return; hp=Math.max(0,hp-d); el.hp.style.transform=`scaleX(${hp/HP_MAX})`; lastHit=t; invTil=t+INV_MS; cam.shake=Math.max(cam.shake,14); sColl(); buzz(12); }

/* --------- Background (Aurora + Parallax Clouds) --------- */
function seedClouds(){ clouds.length=0; for(let i=0;i<(set.low?14:26);i++) clouds.push({x:R()*W,y:R()*H,r:18+R()*30,v:.20+.05*R(),a:.9}); }
function drawAurora(t){
  // multi-ribbon aurora
  const g = ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'#0a1020'); g.addColorStop(1,'#0e1b2e'); ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
  const bands = set.low?2:3;
  for(let b=0;b<bands;b++){
    const amp=18+12*b, y0=H*.25+.12*b*H, spd=0.00018*(b+1);
    ctx.beginPath(); ctx.moveTo(0,y0);
    for(let x=0;x<=W;x+=16){
      const y=y0 + Math.sin(x*0.01 + t*spd + b)*amp + Math.sin(x*0.004 - t*spd*1.3 + b)*amp*.6;
      ctx.lineTo(x,y);
    }
    ctx.lineTo(W,H); ctx.lineTo(0,H); ctx.closePath();
    ctx.fillStyle = ['rgba(0,220,255,.14)','rgba(0,255,160,.12)','rgba(255,80,180,.10)'][b];
    ctx.fill();
  }
  // parallax clouds
  clouds.forEach(cl=>{ ctx.globalAlpha = 0.9; ctx.fillStyle='rgba(255,255,255,.95)'; ctx.beginPath(); ctx.ellipse(cl.x,cl.y, cl.r*1.3, cl.r, 0, 0, TAU); ctx.fill(); });
  ctx.globalAlpha=1;
}
function drawLanes(){ ctx.globalAlpha=set.hc?.28:.18; ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--lane'); for(let i=1;i<LANES;i++){ const x=i*W/LANES; ctx.fillRect(x-1,0,2,H);} ctx.globalAlpha=1; }

/* --------- Rendering helpers --------- */
function drawPylon(e){ const x=e.x,y=e.y,w=e.w,h=e.h; ctx.fillStyle='#ff8a00'; ctx.fillRect(x,y,w,h); ctx.fillStyle='#0b0b0b'; ctx.fillRect(x,y+8,w,5); ctx.fillRect(x,y+18,w,5); ctx.fillRect(x,y+28,w,5); ctx.strokeStyle='#2a1200'; ctx.lineWidth=2; ctx.strokeRect(x+.5,y+.5,w-1,h-1); }
function drawRival(e){ const x=e.x,y=e.y,w=e.w,h=e.h; ctx.fillStyle=e.color; ctx.beginPath(); ctx.moveTo(x+w/2,y); ctx.lineTo(x+w,y+h*.75); ctx.lineTo(x+w*.7,y+h); ctx.lineTo(x+w*.3,y+h); ctx.lineTo(x,y+h*.75); ctx.closePath(); ctx.fill(); const rg=ctx.createRadialGradient(x+w/2,y+h,1,x+w/2,y+h,w*.7); rg.addColorStop(0,'rgba(255,255,255,.85)'); rg.addColorStop(1,'rgba(255,255,255,0)'); ctx.fillStyle=rg; ctx.fillRect(x-w/2,y+h*.6,w*2,h*.6); }
function drawCloudHaz(e){ ctx.fillStyle='rgba(255,255,255,.96)'; const cx=e.x+e.w/2, cy=e.y+e.h/2, r=e.w*.45; ctx.beginPath(); ctx.ellipse(cx,cy,r,r*.7,0,0,TAU); ctx.fill(); ctx.beginPath(); ctx.ellipse(cx-r*.7,cy+3,r*.7,r*.55,0,0,TAU); ctx.fill(); ctx.beginPath(); ctx.ellipse(cx+r*.7,cy+2,r*.65,r*.52,0,0,TAU); ctx.fill(); }
function drawLightning(e){ const x=lanesX[e.lane]; ctx.strokeStyle='#fff2a8'; ctx.lineWidth=3; ctx.shadowColor='#fff2a8'; ctx.shadowBlur=14; ctx.beginPath(); ctx.moveTo(x,e.y); for(let yy=0; yy<e.h; yy+=10) ctx.lineTo(x+(R()-.5)*10, e.y+yy); ctx.stroke(); ctx.shadowBlur=0; }
function drawWeather(e){
  ctx.save();
  if(e.type==='rain'){ ctx.fillStyle='rgba(20,60,120,.20)'; ctx.fillRect(0,e.y,W,e.h); }
  if(e.type==='cross'){ ctx.fillStyle='rgba(255,255,255,.10)'; ctx.fillRect(0,e.y,W,e.h); }
  if(e.type==='clear'){ ctx.fillStyle='rgba(0,240,200,.08)'; ctx.fillRect(0,e.y,W,e.h); }
  ctx.restore();
}
function drawAce(e){
  const x=e.x,y=e.y,w=e.w,h=e.h;
  ctx.fillStyle='#ffd166'; ctx.beginPath(); ctx.moveTo(x+w/2,y); ctx.lineTo(x+w*0.95,y+h*.6); ctx.lineTo(x+w*.7,y+h); ctx.lineTo(x+w*.3,y+h); ctx.lineTo(x+w*0.05,y+h*.6); ctx.closePath(); ctx.fill();
  // HP pips
  for(let i=0;i<e.hp;i++){ ctx.fillStyle='#ff5c93'; ctx.fillRect(x+4+i*9, y-8, 7,4); }
}

/* player + fx */
function heat(){ const cx=player.x+player.w/2, cy=player.y+player.h*0.9; ctx.save(); ctx.globalAlpha=.18; const n=set.low?4:7; for(let i=0;i<n;i++){ const off=i*8; ctx.beginPath(); ctx.ellipse(cx + Math.sin((performance.now()+off)/140)*(3+speed*.8), cy+off, 14,6,0,0,TAU); ctx.fillStyle="rgba(255,255,255,.55)"; ctx.fill(); } ctx.restore(); }
function drawPlayer(){
  const tilt=(player.tx-player.x)*.04; player.bank+=(tilt-player.bank)*.18;
  ctx.save();
  // camera zoom for accel/focus
  const cx=W/2, cy=H*.6; ctx.translate(cx,cy); ctx.scale(cam.zoom, cam.zoom); ctx.translate(-cx,-cy);
  ctx.translate(player.x+player.w/2, player.y+player.h/2); ctx.rotate(player.bank);
  ctx.fillStyle="#d9f1ff"; ctx.beginPath(); ctx.moveTo(0,-player.h*.58); ctx.quadraticCurveTo(player.w*.24,-player.h*.15,0,player.h*.62); ctx.quadraticCurveTo(-player.w*.24,-player.h*.15,0,-player.h*.58); ctx.fill();
  ctx.fillStyle="#4fa6ff"; ctx.beginPath(); ctx.ellipse(0,-player.h*.18,player.w*.18,player.h*.22,0,0,TAU); ctx.fill();
  ctx.fillStyle="#bfe6ff"; ctx.beginPath(); ctx.moveTo(-player.w*.62,-player.h*.1); ctx.lineTo(player.w*.62,-player.h*.1); ctx.lineTo(player.w*.32,player.h*.18); ctx.lineTo(-player.w*.32,player.h*.18); ctx.closePath(); ctx.fill();
  ctx.restore();
  if(brake){ player.smoke++; if(player.smoke%2===0){ for(let i=0;i<2;i++) parts.push({type:'smoke',x:player.x+player.w/2+(R()-.5)*10, y:player.y+player.h*.95, r:6+R()*8, a:.55, vx:(R()-.5)*.6, vy:1.2+R()*1.2}); } }
  heat();
}
function drawBullets(){
  bullets.forEach(b=>{
    if(b.trail>0){ const grad=ctx.createLinearGradient(b.x+3,b.y,b.x+3,b.y+b.trail*3); grad.addColorStop(0,'#ffffff'); grad.addColorStop(1,'rgba(255,255,255,0)'); ctx.fillStyle=grad; ctx.fillRect(b.x+1,b.y,5,b.trail*3); }
    ctx.save(); ctx.shadowColor="#fff"; ctx.shadowBlur=16; ctx.fillStyle="#fff"; ctx.fillRect(b.x,b.y,b.w,b.h); ctx.shadowBlur=0; ctx.restore();
    ctx.strokeStyle="#003a6a"; ctx.lineWidth=1; ctx.strokeRect(b.x+0.5,b.y+0.5,b.w-1,b.h-1);
  });
  ctx.fillStyle="#ffd166"; eBullets.forEach(b=>{ ctx.save(); ctx.shadowColor="#ffd166"; ctx.shadowBlur=10; ctx.fillRect(b.x,b.y,b.w,b.h); ctx.restore(); });
}
function drawParts(){
  for(let i=parts.length-1;i>=0;i--){
    const p=parts[i];
    if(p.type==='expl'){ ctx.globalAlpha=p.a; ctx.fillStyle=p.col||"#fff"; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,TAU); ctx.fill(); p.x+=p.vx; p.y+=p.vy; p.vx*=.98; p.vy*=.98; p.a-=.02; p.r*=.995; }
    else if(p.type==='frag'){ ctx.globalAlpha=p.a; ctx.fillStyle=p.col||"#fff"; ctx.fillRect(p.x,p.y,p.s,p.s); p.x+=p.vx; p.y+=p.vy; p.vy+=.1; p.a-=.018; }
    else if(p.type==='smoke'){ ctx.globalAlpha=p.a; ctx.fillStyle="rgba(255,255,255,.9)"; ctx.beginPath(); ctx.ellipse(p.x,p.y,p.r*1.1,p.r*.8,0,0,TAU); ctx.fill(); p.x+=p.vx; p.y+=p.vy; p.r*=1.01; p.a-=.012; }
    if(p.a<=0) parts.splice(i,1);
  }
  ctx.globalAlpha=1;
}

/* --------- Explosions --------- */
function explode(e){
  const col=(e.kind===TYPE.RIVAL||e.kind===TYPE.ACE? '#ffd4a6' : e.kind===TYPE.CLOUD?'#d0f0ff':'#ff7a5a');
  const n=set.low?14:22, n2=set.low?6:10;
  for(let k=0;k<n;k++) parts.push({type:'expl',x:e.x+e.w/2,y:e.y+e.h/2,r:3+R()*6,a:.9,vx:(R()-.5)*4,vy:(R()-.5)*4,col});
  for(let k=0;k<n2;k++) parts.push({type:'frag',x:e.x+e.w/2,y:e.y+e.h/2,s:3+R()*5,a:.8,vx:(R()-.5)*6,vy:(R()-.5)*6,col});
  if(parts.length>(set.low?600:900)) parts.splice(0, parts.length-(set.low?500:700));
}

/* --------- Ghost Replay --------- */
function recordGhost(t){ if(!set.ghost) return; if(ghost.length===0 || t-ghost[ghost.length-1].t>100) ghost.push({t,lane:player.lane, speed}); }
function drawGhost(t){
  if(!ghostOn || ghostPlaying.length===0) return;
  const rec = ghostPlaying.find(g=> Math.abs(g.t - t) < 60 );
  if(!rec) return;
  const x=lanesX[rec.lane]-PLAYER_W/2, y=H-PLAYER_H-100;
  ctx.save(); ctx.globalAlpha=.35; ctx.fillStyle="#a0d8ff"; ctx.fillRect(x+PLAYER_W*.19,y+PLAYER_H*.2,PLAYER_W*.62,PLAYER_H*.62); ctx.restore();
}

/* --------- Focus (time-dilation) & EMP --------- */
function tickFocus(dt){ if(focusOn){ focusEnergy=Math.max(0, focusEnergy - dt/1000); if(focusEnergy<=0){ focusOn=false; sFocus(); } } else focusEnergy=Math.min(1, focusEnergy + dt/12000); el.focusTag.textContent=`Focus: ${Math.round(focusEnergy*100)}%`; }
function tickEMP(dt){ empEnergy=Math.min(1, empEnergy + dt/9000); el.empTag.textContent=`EMP: ${Math.round(empEnergy*100)}%`; }
function useFocus(){ if(focusEnergy<0.2) return; focusOn=!focusOn; sFocus(); }
function useEMP(){ if(empEnergy<1) return; empEnergy=0; eBullets.length=0; // stun rivals
  ents.forEach(e=>{ if(e.kind===TYPE.RIVAL||e.kind===TYPE.ACE) e.stun=1500; }); sEMP(); toast('EMP!'); missionHit('emp2',1); }

/* --------- Update --------- */
function update(dtRaw){
  // Low-spec FPS cap (~45fps) by skipping work
  if(set.low){ dtCarry+=dtRaw; if(dtCarry<22) return; dtRaw=dtCarry; dtCarry=0; }
  const dt = focusOn ? dtRaw*0.75 : dtRaw; // time dilation (player bullets not scaled separately for simplicity)

  // speed
  if(accel) speed=Math.min(MAX_SPEED, speed+ACCEL*dt);
  if(brake) speed=Math.max(MIN_SPEED, speed-BRAKE*dt);
  if(!accel && !brake) speed=Math.max(BASE_SPEED, speed-0.0009*dt);

  // camera zoom/shake
  const targetZoom = accel? 1.03 : (focusOn? 1.02 : 1.0);
  cam.zoom += (targetZoom - cam.zoom)*0.05;
  if(accel) cam.shake=Math.max(cam.shake, 1 + speed*.1);
  if(cam.shake>0) cam.shake*=.88;

  // sonic
  if(speed>=MAX_SPEED && !sonic){ sonic=true; sonicT=900; lowpass.frequency.rampTo(3200,.08); cam.shake=18; toast('SONIC BOOM!'); sPower(); sonicCount++; missionHit('sonic3',1); }
  if(sonic){ sonicT-=dt; if(sonicT<=0){ sonic=false; lowpass.frequency.rampTo(20000,.25); } }

  // ammo / health
  const t=performance.now();
  if(ammo<AMMO_MAX && t-lastAmmo>RECHARGE_MS){ ammo=AMMO_MAX; el.ammo.textContent=ammo; lastAmmo=t; toast('Ammo Recharged'); }
  if(t-lastHit>REGEN_DELAY && hp<HP_MAX){ hp=Math.min(HP_MAX, hp+REGEN_PER_S*dt/1000); el.hp.style.transform=`scaleX(${hp/HP_MAX})`; }

  // player move
  player.tx=lanesX[player.lane]-player.w/2; player.x+=(player.tx-player.x)*.22; player.y=H-PLAYER_H-56;

  // spawns
  spawnStep(dt);

  // entities
  for(let i=ents.length-1;i>=0;i--){
    const e=ents[i]; e.y += (e.sp + speed*.35);
    if(e.stun){ e.stun-=dt; }

    if(e.kind===TYPE.RIVAL){
      if(set.rival && !e.stun){ e.shot -= dt; if(e.shot<=0 && e.y>0 && e.y<H){ e.shot=800+R()*900; eBullets.push({x:e.x+e.w/2-3,y:e.y+e.h-2,w:6,h:16,sp:7+speed*.9}); } }
      if(R()<0.003 && e.y>H*.2 && e.y<H*.72){ const dir=Math.sign(player.lane-e.lane); e.lane=Math.max(0,Math.min(LANES-1,e.lane+dir)); e.x=lanesX[e.lane]-e.w/2; }
    }
    if(e.kind===TYPE.CLOUD){ if(set.lightning){ e.t-=dt; if(e.t<=0){ spawnLight(e.lane, e.y+e.h); e.t=1400+R()*1600; } } }
    if(e.kind===TYPE.WEATHER){
      // effects while inside band
      if(e.y<H && e.y+e.h>0){
        if(e.type==='rain') speed=Math.max(MIN_SPEED, speed - 0.002*dt);
        if(e.type==='cross') { player.tx += Math.sin(performance.now()/300)*0.6; }
        if(e.type==='clear') speed=Math.min(MAX_SPEED, speed + 0.0015*dt);
      }
    }
    if(e.kind===TYPE.ACE){
      if(!e.stun){ e.phase += dt*0.002; if(R()<0.008){ const dir = Math.sign(player.lane - e.lane); e.lane = Math.max(0,Math.min(LANES-1,e.lane+dir)); e.x=lanesX[e.lane]-e.w/2; }
        e.shot -= dt; if(e.shot<=0 && e.y>0){ e.shot=500; // spread
          eBullets.push({x:e.x+e.w/2-9,y:e.y+e.h-2,w:6,h:16,sp:7+speed*.9});
          eBullets.push({x:e.x+e.w/2+3,y:e.y+e.h-2,w:6,h:16,sp:7+speed*.9});
        }
      }
    }

    // drafting (tailing rivals)
    if((e.kind===TYPE.RIVAL||e.kind===TYPE.ACE) && e.y+e.h - player.y > 60 && e.y+e.h - player.y < 140 && e.lane===player.lane){
      speed=Math.min(MAX_SPEED, speed + 0.003*dt); draftT=500; if(R()<0.02) sPass(); missionHit('draft6',1);
    }

    // collide player
    if(aabb(e,player)){
      if(e.kind===TYPE.BOOST){ speed=Math.min(MAX_SPEED, speed + BOOST_BONUS); score+=120*mult; sPower(); toast('Boost +120'); ents.splice(i,1); continue; }
      if(e.kind===TYPE.REPAIR){ hp=Math.min(HP_MAX,hp+30); el.hp.style.transform=`scaleX(${hp/HP_MAX})`; score+=60*mult; sPower(); toast('Repair +60'); ents.splice(i,1); continue; }
      if(e.kind===TYPE.STAR){ score+=100*mult; stars++; sScore(); toast(`+${100*mult}`); missionHit('stars5',1); ents.splice(i,1); continue; }
      if(e.kind===TYPE.WEATHER){ /* no harm */ }
      else { damage(e.kind===TYPE.LIGHT?34: (e.kind===TYPE.ACE?30:22)); explode(e); if(e.kind!==TYPE.ACE) ents.splice(i,1); }
    }

    // near miss
    if(!e.passed && e.y>player.y-NEAR && e.y<player.y+player.h && e.lane===player.lane){
      e.passed=true; const add=50*mult; score+=add; sPass(); toast(`Near Miss +${add}`); if(performance.now()-lastSwap<COMBO_MS){ weave++; mult=Math.min(4,1+weave*0.15); comboT=performance.now(); if(weave>=5) missionHit('weave5',1); }
    }

    if(e.y>H+120) ents.splice(i,1);
  }

  // bullets (player)
  for(let i=bullets.length-1;i>=0;i--){
    const b=bullets[i]; b.y-=b.sp; b.trail=Math.max(0,b.trail-0.6);
    let hit=false;
    for(let j=ents.length-1;j>=0;j--){
      const e=ents[j];
      if(e.kind===TYPE.RIVAL || e.kind===TYPE.OBST || e.kind===TYPE.CLOUD || e.kind===TYPE.LIGHT || e.kind===TYPE.ACE){
        if(aabb(b,e)){
          let gain=(e.kind===TYPE.RIVAL?120: e.kind===TYPE.ACE?150:90)*mult;
          if(e.kind===TYPE.ACE){ e.hp--; if(e.hp<=0){ explode(e); ents.splice(j,1);} else { explode({x:b.x,y:b.y,w:8,h:8}); } }
          else { explode(e); ents.splice(j,1); }
          score+=gain; sColl(); hit=true; break;
        }
      }
    }
    if(hit || b.y<-20) bullets.splice(i,1);
  }
  // enemy bullets
  for(let i=eBullets.length-1;i>=0;i--){
    const b=eBullets[i]; b.y+=b.sp;
    if(aabb(b,player)){ damage(18); eBullets.splice(i,1); continue; }
    if(b.y>H+20) eBullets.splice(i,1);
  }

  // particles cap
  if(parts.length>(set.low?600:900)) parts.splice(0, parts.length-(set.low?500:700));

  // score tick + combo decay
  score += (dt/100)*(0.7 + speed*.06)*mult;
  if(mult>1 && performance.now()-comboT>COMBO_MS){ weave=0; mult=1; }

  // missions
  if(!missions.find(m=>m.id==='speed800')?.done && speed*50>=800) missionHit('speed800',1);
  tickFocus(dt); tickEMP(dt);

  // Time Attack
  if(set.ta){ timer -= dt; el.timer.textContent = Math.max(0,Math.ceil(timer/1000)); if(timer<=0){ gameOver(); } }

  // Ghost record
  recordGhost(performance.now());
}

/* --------- Render --------- */
function render(dt){
  drawAurora(performance.now());
  drawLanes();

  // motion lines
  if(accel||speed>BASE_SPEED+1){ for(let i=0;i<(set.low?1:2);i++) lines.push({x:(R()*W)|0,y:-20,len:10+R()*60,a:.22+R()*.22,sp:4+speed*1.6}); }
  ctx.save();
  if(cam.shake>0){ ctx.translate((R()-.5)*cam.shake,(R()-.5)*cam.shake); }

  // draw weather under things
  for(const e of ents) if(e.kind===TYPE.WEATHER) drawWeather(e);
  // entities
  for(const e of ents){
    if(e.kind===TYPE.RIVAL) drawRival(e);
    else if(e.kind===TYPE.OBST) drawPylon(e);
    else if(e.kind===TYPE.CLOUD) drawCloudHaz(e);
    else if(e.kind===TYPE.LIGHT) drawLightning(e);
    else if(e.kind===TYPE.ACE) drawAce(e);
  }
  drawPlayer();
  drawGhost(performance.now());
  drawBullets();
  ctx.restore();

  // lines
  for(let i=lines.length-1;i>=0;i--){ const s=lines[i]; s.y+=s.sp; ctx.globalAlpha=s.a; ctx.fillStyle="#fff"; ctx.fillRect(s.x,s.y,2,s.len); if(s.y>H+40) lines.splice(i,1); } ctx.globalAlpha=1;
  drawParts();

  // sonic ring
  if(sonic){ const k=1-(sonicT/900); const r=(1-k)*Math.hypot(W,H); ctx.save(); ctx.globalAlpha=.22*k; ctx.strokeStyle="#fff"; ctx.lineWidth=8*k+2; ctx.beginPath(); ctx.arc(W/2,H*.62,r,0,TAU); ctx.stroke(); ctx.restore(); }

  // HUD
  el.score.textContent = Math.floor(score); el.spd.textContent = Math.round(speed*50);
  el.focusTag.textContent=`Focus: ${Math.round(focusEnergy*100)}%`;
  el.empTag.textContent=`EMP: ${Math.round(empEnergy*100)}%`;
}

/* --------- Loop --------- */
let tPrev=0;
function loop(t){
  if(!running) return;
  const dt = Math.min(32, t-(tPrev||t)); tPrev=t;
  if(firing) fire();
  update(dt);
  render(dt);
  raf=requestAnimationFrame(loop);
}

/* --------- Controls --------- */
document.addEventListener('keydown', e=>{
  if(e.repeat) return;
  if(!running && e.code==='Space'){ start(); return; }
  if(e.key==='ArrowLeft' && player.lane>0){ player.lane--; lastSwap=performance.now(); }
  if(e.key==='ArrowRight' && player.lane<LANES-1){ player.lane++; lastSwap=performance.now(); }
  if(e.key==='ArrowUp') accel=true;
  if(e.key==='ArrowDown') brake=true;
  if(e.code==='Space'){ firing=true; fire(); }
  if(e.key==='q' || e.key==='Q') useFocus();
  if(e.key==='e' || e.key==='E') useEMP();
});
document.addEventListener('keyup', e=>{
  if(e.key==='ArrowUp') accel=false;
  if(e.key==='ArrowDown') brake=false;
  if(e.code==='Space') firing=false;
});

// touch
let t0=null, moved=false;
function ts(ev){ const t=ev.changedTouches?ev.changedTouches[0]:ev; t0={x:t.clientX,y:t.clientY}; moved=false; }
function tm(ev){ if(!t0) return; const t=ev.changedTouches[0]; const dx=t.clientX-t0.x, dy=t.clientY-t0.y; const ax=Math.abs(dx), ay=Math.abs(dy);
  if(!moved && (ax>24 || ay>24)){ moved=true; if(ax>ay){ if(dx<0&&player.lane>0){player.lane--; lastSwap=performance.now();} if(dx>0&&player.lane<LANES-1){player.lane++; lastSwap=performance.now();} } else { if(dy<-12){accel=true;brake=false;} if(dy>12){brake=true;accel=false;} } } }
function te(){ accel=false;brake=false;t0=null; }
cv.addEventListener('touchstart', ts, {passive:true});
cv.addEventListener('touchmove', tm, {passive:true});
cv.addEventListener('touchend', te, {passive:true});
btn.fire.addEventListener('pointerdown', ()=>{ firing=true; fire(); });
btn.fire.addEventListener('pointerup', ()=>{ firing=false; });

// drawer, help, mute
$("#drawerBtn").addEventListener('click', ()=> el.drawer.classList.toggle('open'));
btn.help.addEventListener('click', ()=> toast('Hold üî´ to fire ‚Ä¢ Q=Focus ‚Ä¢ E=EMP ‚Ä¢ Try Time Attack + Daily in ‚öôÔ∏è'));
btn.mute.addEventListener('click', ()=>{ Tone.Destination.mute=!Tone.Destination.mute; btn.mute.textContent=Tone.Destination.mute?'üîà':'üîä'; });

/* Challenge codes */
btn.apply.addEventListener('click', ()=>{ const code=codeIn.value.trim().toUpperCase(); if(code){ mode.code=code; mode.daily=false; sw.daily.checked=false; saveSettings(); applySeed(); toast('Challenge code applied'); } });
btn.gen.addEventListener('click', ()=>{ codeIn.value=encodeCode(); navigator.clipboard?.writeText(codeIn.value).catch(()=>{}); toast('Code generated'); });

/* --------- Gamepad --------- */
let padIdx=null;
function pollPad(){
  const pads=navigator.getGamepads?.()||[]; const p=padIdx!=null?pads[padIdx]:pads.find(x=>x);
  if(!p) return;
  padIdx=p.index;
  const lx = (p.axes[0]||0);
  if(lx<-0.4 && player.lane>0){ player.lane--; lastSwap=performance.now(); }
  if(lx> 0.4 && player.lane<LANES-1){ player.lane++; lastSwap=performance.now(); }
  const A = p.buttons[0]?.pressed, RB=p.buttons[5]?.pressed, LB=p.buttons[4]?.pressed;
  if(A){ firing=true; fire(); } else { firing=false; }
  if(RB) accel=true; else if(LB) brake=true; else { /* noop */ }
}
setInterval(pollPad, 120);

/* --------- Start / Over --------- */
function start(){
  el.gate.style.display='none';
  if(!quiet()){ armAudio().then(configureSynths); } // SES-safe
  reset();
  cancelAnimationFrame(raf); running=true; tPrev=0; raf=requestAnimationFrame(loop);
}
function reset(){
  score=0; speed=BASE_SPEED; accel=brake=false; firing=false; mult=1; weave=0; comboT=-1e9;
  AMMO_MAX = 120 + (perks.ammo?10:0); ammo=AMMO_MAX; el.ammo.textContent=ammo; lastAmmo=performance.now();
  HP_MAX=100; hp=HP_MAX; el.hp.style.transform='scaleX(1)'; lastHit=-1e9; invTil=0; sonic=false; sonicT=0; sonicCount=0; stars=0; focusEnergy=0; empEnergy=0; cam.zoom=1;
  ents.length=0; bullets.length=0; eBullets.length=0; parts.length=0; lines.length=0; clouds.length=0; ghost.length=0; ghostPlaying.length=0;
  player=makePlayer(); resize(); seedClouds(); el.over.classList.remove('show');
  mode.code = mode.code; ghostOn = set.ghost;
  if(set.ta){ timer=180000; el.timerPill.style.display='inline-flex'; } else { el.timerPill.style.display='none'; }
  if(ghostOn){ const saved = JSON.parse(localStorage.getItem('velGhostAurora')||'[]'); ghostPlaying = saved; }
}
function gameOver(){
  running=false; cancelAnimationFrame(raf);
  el.final.textContent=Math.floor(score); best=Math.max(best,Math.floor(score)); localStorage.setItem('velBestAurora',best); el.best.textContent=best;
  // XP & perks points
  const gained = Math.floor(score/500); perks.xp += gained; if(gained>0){ const newPts=Math.floor(perks.xp/20); if(newPts>perks.pts) perks.pts=newPts; savePerks(); applyPerks(); }
  // save ghost if best
  if(set.ghost && Math.floor(score)>=best){ localStorage.setItem('velGhostAurora', JSON.stringify(ghost)); }
  el.over.classList.add('show');
}
btn.again.addEventListener('click', ()=>{ el.over.classList.remove('show'); start(); });
el.gate.addEventListener('click', ()=>{ start(); });

/* --------- Boot --------- */
applySettingsUI(); configureSynths(); applyPerks();
if(missions.length===0) seedMissions(); else renderMissions();
resize(); el.best.textContent=best;
window.addEventListener('resize', resize);
document.addEventListener('visibilitychange', ()=>{ if(document.hidden){ accel=false;brake=false;firing=false; } });

})();
</script>
</body>
</html>
