<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Ù…Ø¨Ø¯Ù„ ØªØµÙˆÛŒØ± â‡„ Ø§ÛŒÙ…ÙˆØ¬ÛŒ | Image â‡„ Emoji</title>

<!-- iOS PWA hints -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="EmojiCoder">
<link rel="apple-touch-icon" href="data:image/svg+xml;utf8,
<svg xmlns='http://www.w3.org/2000/svg' width='180' height='180'>
  <rect width='100%%' height='100%%' rx='32' fill='white'/>
  <text x='50%%' y='54%%' font-size='92' text-anchor='middle'>ğŸ”</text>
</svg>">

<!-- Theme color updates via JS when user toggles -->
<meta name="theme-color" content="#0b0b0f" media="(prefers-color-scheme: dark)">
<meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">

<style>
  :root{
    --bg: #0b0b0f;
    --panel:#141419;
    --text:#f3f4f6;
    --muted:#a1a1aa;
    --brand:#3b82f6;
    --ok:#10b981;
    --warn:#f59e0b;
    --border:#23232b;
    --inp:#0f0f14;
    --shadow: 0 10px 30px rgba(0,0,0,.35);
  }
  :root.light{
    --bg:#fafafa; --panel:#ffffff; --text:#0b0b0f; --muted:#52525b;
    --brand:#2563eb; --ok:#059669; --warn:#b45309; --border:#e5e7eb; --inp:#f3f4f6;
    --shadow: 0 10px 24px rgba(0,0,0,.08);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family: ui-rounded, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
    background:var(--bg); color:var(--text);
  }
  .wrap{max-width:860px; margin:0 auto; padding:16px; display:flex; flex-direction:column; gap:16px}
  header{
    display:flex; align-items:center; justify-content:space-between; gap:10px; position:sticky; top:0; padding:6px 0 6px;
    background:linear-gradient(180deg, var(--bg) 70%%, transparent);
    z-index:3;
  }
  .brand{display:flex; align-items:center; gap:10px}
  .logo{font-size:28px}
  .title{font-weight:700; letter-spacing:.2px}
  .muted{color:var(--muted); font-size:.92rem}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .chip{
    display:inline-flex; align-items:center; gap:8px; border:1px solid var(--border);
    background:var(--panel); padding:10px 12px; border-radius:14px; box-shadow:var(--shadow)
  }
  .chip select,.chip button,.chip input[type="checkbox"]{background:transparent; color:var(--text); border:none; font:inherit}
  .seg{
    display:flex; padding:4px; border-radius:12px; background:var(--panel); border:1px solid var(--border); box-shadow:var(--shadow)
  }
  .seg button{
    appearance:none; border:none; background:transparent; color:var(--muted); padding:10px 14px; border-radius:10px; font-weight:600;
  }
  .seg button.active{background:var(--brand); color:white}
  main{display:grid; gap:12px}
  .card{
    background:var(--panel); border:1px solid var(--border); border-radius:18px; padding:14px; box-shadow:var(--shadow)
  }
  .grid{display:grid; gap:12px}
  @media(min-width:720px){ .grid{grid-template-columns:1fr 1fr} }
  .drop{
    display:grid; place-items:center; text-align:center; padding:26px; border:2px dashed var(--border);
    border-radius:16px; background:var(--inp); cursor:pointer; min-height:140px
  }
  .drop.drag{border-color:var(--brand)}
  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    padding:12px 14px; border-radius:12px; border:1px solid var(--border); background:var(--brand); color:white;
    font-weight:700; text-decoration:none; cursor:pointer
  }
  .btn.secondary{background:transparent; color:var(--text)}
  .btn.ghost{background:transparent; color:var(--muted); border-color:transparent}
  .row .btn{flex:1}
  textarea,.mono{
    width:100%%; min-height:140px; padding:12px; border-radius:12px; border:1px solid var(--border);
    background:var(--inp); color:var(--text); font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:15px
  }
  input[type="password"], input[type="text"]{
    width:100%%; padding:11px 12px; border-radius:12px; border:1px solid var(--border); background:var(--inp); color:var(--text)
  }
  label{font-weight:600}
  .hint{font-size:.92rem; color:var(--muted)}
  .kbd{font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:.9rem}
  footer{opacity:.8; font-size:.92rem; text-align:center; padding:22px 0}
  .ok{color:var(--ok)} .warn{color:var(--warn)}
  .hidden{display:none !important}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo">ğŸ§©</div>
      <div>
        <div class="title" data-i="appTitle">Ù…Ø¨Ø¯Ù„ ØªØµÙˆÛŒØ± â‡„ Ø§ÛŒÙ…ÙˆØ¬ÛŒ</div>
        <div class="muted" data-i="appSubtitle">Ø³Ø±ÛŒØ¹ØŒ Ø³Ø§Ø¯Ù‡ØŒ Ø¨Ø§ Ø±Ù…Ø² Ø§Ø®ØªÛŒØ§Ø±ÛŒ</div>
      </div>
    </div>

    <div class="row">
      <div class="chip">
        <span aria-hidden="true">ğŸŒ“</span>
        <button id="themeToggle" aria-label="Toggle theme">Ø±ÙˆØ´Ù†/ØªØ§Ø±ÛŒÚ©</button>
      </div>
      <div class="chip">
        <span aria-hidden="true">ğŸŒ</span>
        <select id="langSel" aria-label="Language">
          <option value="fa" selected>ÙØ§Ø±Ø³ÛŒ</option>
          <option value="en">English</option>
        </select>
      </div>
      <div class="chip">
        <button id="installBtn" class="ghost">â• <span data-i="install">Ù†ØµØ¨</span></button>
      </div>
    </div>
  </header>

  <div class="seg" role="tablist" aria-label="Mode">
    <button class="active" id="tabEncode" role="tab" aria-selected="true"><span data-i="encode">Ø±Ù…Ø²Ú¯Ø°Ø§Ø±ÛŒ (ØªØµÙˆÛŒØ± â†’ Ø§ÛŒÙ…ÙˆØ¬ÛŒ)</span></button>
    <button id="tabDecode" role="tab" aria-selected="false"><span data-i="decode">Ø±Ù…Ø²Ú¯Ø´Ø§ÛŒÛŒ (Ø§ÛŒÙ…ÙˆØ¬ÛŒ â†’ ØªØµÙˆÛŒØ±)</span></button>
  </div>

  <main>
    <section id="encodePanel" class="grid" role="tabpanel" aria-labelledby="tabEncode">
      <div class="card">
        <label class="hint" data-i="dragDrop">ØªØµÙˆÛŒØ± Ø±Ø§ Ø¨Ú©Ø´ÛŒØ¯ Ùˆ Ø±Ù‡Ø§ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø¶Ø±Ø¨Ù‡ Ø¨Ø²Ù†ÛŒØ¯:</label>
        <div id="drop" class="drop" tabindex="0">
          <div>
            <div style="font-size:42px">ğŸ–¼ï¸</div>
            <div class="muted"><span data-i="dropHint">JPG/PNG/WebP â€¢ ØªØ§ 5MB</span></div>
          </div>
          <input id="file" type="file" accept="image/*" class="hidden">
        </div>
        <div class="row" style="margin-top:10px">
          <input id="password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" aria-label="Password (optional)">
          <button id="togglePass" class="btn secondary" type="button">ğŸ‘ï¸</button>
        </div>
        <div class="hint" data-i="passHint">Ø±Ù…Ø² Ø§Ø®ØªÛŒØ§Ø±ÛŒ Ø§Ø³Øª. Ø¨Ø§ AESâ€‘GCM Ù…Ø­Ø§ÙØ¸Øª Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
        <div class="row" style="margin-top:10px">
          <button id="encodeBtn" class="btn">ğŸ” <span data-i="encodeBtn">ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø§ÛŒÙ…ÙˆØ¬ÛŒ</span></button>
          <button id="clearIn" class="btn secondary">ğŸ§¹ <span data-i="clear">Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ</span></button>
        </div>
      </div>

      <div class="card">
        <label for="emojiOut"><span data-i="emojiResult">Ø®Ø±ÙˆØ¬ÛŒ Ø§ÛŒÙ…ÙˆØ¬ÛŒ</span></label>
        <textarea id="emojiOut" class="mono" placeholder="â€¦" readonly></textarea>
        <div class="row">
          <button id="copyEmoji" class="btn">ğŸ“‹ <span data-i="copy">Ú©Ù¾ÛŒ</span></button>
          <button id="shareEmoji" class="btn secondary">ğŸ”— <span data-i="share">Ø§Ø´ØªØ±Ø§Ú©</span></button>
        </div>
        <div class="hint"><span data-i="size">Ø§Ù†Ø¯Ø§Ø²Ù‡:</span> <span id="sizeInfo">0B</span></div>
      </div>
    </section>

    <section id="decodePanel" class="grid hidden" role="tabpanel" aria-labelledby="tabDecode">
      <div class="card">
        <label for="emojiIn"><span data-i="pasteEmoji">Ù…ØªÙ† Ø§ÛŒÙ…ÙˆØ¬ÛŒ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ú†Ø³Ø¨Ø§Ù†ÛŒØ¯</span></label>
        <textarea id="emojiIn" class="mono" placeholder="â€¦"></textarea>
        <div class="row">
          <button id="pasteEmoji" class="btn secondary">ğŸ“¥ <span data-i="paste">Ú†Ø³Ø¨Ø§Ù†Ø¯Ù†</span></button>
          <input id="password2" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" aria-label="Password (if used)">
          <button id="togglePass2" class="btn secondary" type="button">ğŸ‘ï¸</button>
        </div>
        <div class="hint" data-i="passUsed">Ø§Ú¯Ø± Ø±Ù…Ø² Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡ØŒ Ù‡Ù…Ø§Ù† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.</div>
        <div class="row" style="margin-top:10px">
          <button id="decodeBtn" class="btn">ğŸ”“ <span data-i="decodeBtn">ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ ØªØµÙˆÛŒØ±</span></button>
          <button id="clearOut" class="btn secondary">ğŸ§¹ <span data-i="clear">Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ</span></button>
        </div>
      </div>

      <div class="card" id="previewCard">
        <div class="muted" data-i="preview">Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø®Ø±ÙˆØ¬ÛŒ:</div>
        <div id="imgWrap" style="display:grid; place-items:center; min-height:160px; border:1px dashed var(--border); border-radius:12px; background:var(--inp); margin-top:8px; padding:12px">
          <span class="muted">â€”</span>
        </div>
        <div class="row" style="margin-top:10px">
          <a id="dlLink" class="btn secondary hidden" download>â¬‡ï¸ <span data-i="download">Ø¯Ø§Ù†Ù„ÙˆØ¯ ØªØµÙˆÛŒØ±</span></a>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <span class="muted">EmojiCoder Created By Peyman Abe 2025</span>
  </footer>
</div>

<script>
/* ===== i18n (FA default, RTL) ===== */
const i18n = {
  fa: {
    appTitle:"Ù…Ø¨Ø¯Ù„ ØªØµÙˆÛŒØ± â‡„ Ø§ÛŒÙ…ÙˆØ¬ÛŒ", appSubtitle:"Ø³Ø±ÛŒØ¹ØŒ Ø³Ø§Ø¯Ù‡ØŒ Ø¨Ø§ Ø±Ù…Ø² Ø§Ø®ØªÛŒØ§Ø±ÛŒ",
    install:"Ù†ØµØ¨",
    encode:"Ø±Ù…Ø²Ú¯Ø°Ø§Ø±ÛŒ (ØªØµÙˆÛŒØ± â†’ Ø§ÛŒÙ…ÙˆØ¬ÛŒ)", decode:"Ø±Ù…Ø²Ú¯Ø´Ø§ÛŒÛŒ (Ø§ÛŒÙ…ÙˆØ¬ÛŒ â†’ ØªØµÙˆÛŒØ±)",
    dragDrop:"ØªØµÙˆÛŒØ± Ø±Ø§ Ø¨Ú©Ø´ÛŒØ¯ Ùˆ Ø±Ù‡Ø§ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø¶Ø±Ø¨Ù‡ Ø¨Ø²Ù†ÛŒØ¯:",
    dropHint:"JPG/PNG/WebP â€¢ ØªØ§ 5MB",
    passHint:"Ø±Ù…Ø² Ø§Ø®ØªÛŒØ§Ø±ÛŒ Ø§Ø³Øª. Ø¨Ø§ AESâ€‘GCM Ù…Ø­Ø§ÙØ¸Øª Ù…ÛŒâ€ŒØ´ÙˆØ¯.",
    encodeBtn:"ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø§ÛŒÙ…ÙˆØ¬ÛŒ", clear:"Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ", copy:"Ú©Ù¾ÛŒ", share:"Ø§Ø´ØªØ±Ø§Ú©", size:"Ø§Ù†Ø¯Ø§Ø²Ù‡:",
    emojiResult:"Ø®Ø±ÙˆØ¬ÛŒ Ø§ÛŒÙ…ÙˆØ¬ÛŒ", pasteEmoji:"Ù…ØªÙ† Ø§ÛŒÙ…ÙˆØ¬ÛŒ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ú†Ø³Ø¨Ø§Ù†ÛŒØ¯", paste:"Ú†Ø³Ø¨Ø§Ù†Ø¯Ù†",
    passUsed:"Ø§Ú¯Ø± Ø±Ù…Ø² Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡ØŒ Ù‡Ù…Ø§Ù† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.", decodeBtn:"ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ ØªØµÙˆÛŒØ±",
    preview:"Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø®Ø±ÙˆØ¬ÛŒ:", download:"Ø¯Ø§Ù†Ù„ÙˆØ¯ ØªØµÙˆÛŒØ±"
  },
  en: {
    appTitle:"Image â‡„ Emoji Encoder", appSubtitle:"Fast, simple, optional password",
    install:"Install",
    encode:"Encode (Image â†’ Emoji)", decode:"Decode (Emoji â†’ Image)",
    dragDrop:"Drag & drop or tap to select an image:",
    dropHint:"JPG/PNG/WebP â€¢ up to 5MB",
    passHint:"Password is optional. Protected with AESâ€‘GCM.",
    encodeBtn:"Encode to Emoji", clear:"Clear", copy:"Copy", share:"Share", size:"Size:",
    emojiResult:"Emoji output", pasteEmoji:"Paste emoji text here", paste:"Paste",
    passUsed:"Enter the same password if used.", decodeBtn:"Decode to Image",
    preview:"Output preview:", download:"Download image"
  }
};
const el = q => document.querySelector(q);
const qAll = q => Array.from(document.querySelectorAll(q));
function applyLang(lang){
  for(const node of qAll("[data-i]")){
    const key = node.getAttribute("data-i");
    node.textContent = i18n[lang][key] ?? key;
  }
  document.documentElement.lang = lang;
  document.documentElement.dir = (lang==='fa')?'rtl':'ltr';
  localStorage.setItem('lang', lang);
}
const savedLang = localStorage.getItem('lang') || 'fa';
applyLang(savedLang);
el('#langSel').value = savedLang;
el('#langSel').addEventListener('change', e=> applyLang(e.target.value));

/* ===== Theme (pref + toggle) ===== */
function setTheme(mode){
  if(mode==='light'){
    document.documentElement.classList.add('light');
  } else {
    document.documentElement.classList.remove('light');
  }
  localStorage.setItem('theme', mode);
  // update theme-color meta dynamically (for Android status bar)
  const isLight = mode==='light';
  qAll('meta[name="theme-color"]').forEach(m=>{
    const media = m.getAttribute('media')||'';
    if(media.includes('prefers-color-scheme')) return; // leave system ones
    m.setAttribute('content', isLight ? '#ffffff' : '#0b0b0f');
  });
}
const pref = window.matchMedia('(prefers-color-scheme: light)').matches?'light':'dark';
setTheme(localStorage.getItem('theme') || pref);
el('#themeToggle').addEventListener('click', ()=>{
  const cur = document.documentElement.classList.contains('light')?'light':'dark';
  setTheme(cur==='light'?'dark':'light');
});

/* ===== Tabs ===== */
function showPanel(which){
  const enc = which==='enc';
  el('#tabEncode').classList.toggle('active', enc);
  el('#tabDecode').classList.toggle('active', !enc);
  el('#encodePanel').classList.toggle('hidden', !enc);
  el('#decodePanel').classList.toggle('hidden', enc);
}
el('#tabEncode').onclick = ()=>showPanel('enc');
el('#tabDecode').onclick = ()=>showPanel('dec');

/* ===== Emoji alphabet (64 symbols) =====
   All are single code points, widely supported.
   No padding emoji needed (we produce unpadded base64 and restore on decode).
*/
const EMO = [
  "ğŸ˜€","ğŸ˜","ğŸ˜‚","ğŸ¤£","ğŸ˜ƒ","ğŸ˜„","ğŸ˜…","ğŸ˜†",
  "ğŸ˜‰","ğŸ˜Š","ğŸ˜","ğŸ˜˜","ğŸ˜œ","ğŸ¤ª","ğŸ˜","ğŸ¤“",
  "ğŸ§","ğŸ¥³","ğŸ¤©","ğŸ˜‡","ğŸ™‚","ğŸ¤—","ğŸ¤ ","ğŸ˜º",
  "ğŸ™ˆ","ğŸ™‰","ğŸ™Š","ğŸµ","ğŸ¶","ğŸ±","ğŸ¦Š","ğŸ¼",
  "ğŸ¯","ğŸ¦","ğŸ¸","ğŸ¦„","ğŸ·","ğŸ®","ğŸ°","ğŸ»",
  "ğŸ","ğŸ","ğŸ","ğŸŠ","ğŸ‹","ğŸŒ","ğŸ‰","ğŸ‡",
  "ğŸ“","ğŸ’","ğŸ‘","ğŸ","ğŸ¥","ğŸ¥¥","ğŸ¥‘","ğŸŒ¶ï¸",
  "ğŸŒ½","ğŸ¥•","ğŸ¥”","ğŸ¥¦","ğŸ","ğŸ§€","ğŸª","ğŸ°"
];
// 64-char base64 index set (A-Z a-z 0-9 + /)
const B64 = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";

/* ===== Utilities ===== */
const enc = new TextEncoder(); const dec = new TextDecoder();
function bytesToBase64(u8){
  // Convert Uint8Array â†’ base64 (no padding removal yet)
  let bin = '';
  const CHUNK = 0x8000;
  for(let i=0;i<u8.length;i+=CHUNK){
    bin += String.fromCharCode.apply(null, u8.subarray(i,i+CHUNK));
  }
  return btoa(bin);
}
function base64ToBytes(b64){
  // normalize padding
  const pad = b64.length % 4;
  const normalized = b64 + (pad? '='.repeat(4-pad):'');
  const bin = atob(normalized);
  const u8 = new Uint8Array(bin.length);
  for(let i=0;i<bin.length;i++) u8[i] = bin.charCodeAt(i);
  return u8;
}
function mapB64ToEmoji(b64){
  // remove '=' padding
  b64 = b64.replace(/=+$/,'');
  return [...b64].map(ch=>{
    const idx = B64.indexOf(ch);
    if(idx<0) throw new Error('Invalid base64');
    return EMO[idx];
  }).join('');
}
function mapEmojiToB64(emostr){
  // Map each emoji back to its index and to base64 char
  // Some emojis could have variation selector (like ğŸŒ¶ï¸), normalize via grapheme split by regex
  const graphemes = Array.from(emostr.matchAll(/(\p{Extended_Pictographic}\uFE0F?)/gu), m=>m[0]);
  // If regex fails (different platforms), fallback to Array.from
  const arr = graphemes.length ? graphemes : Array.from(emostr);
  const out = [];
  for(const g of arr){
    const idx = EMO.indexOf(g);
    if(idx<0) continue; // ignore non-alphabet chars/spaces/newlines
    out.push(B64[idx]);
  }
  return out.join('');
}
function fmtBytes(n){
  if(!n) return "0B";
  const k=1024; const sizes=['B','KB','MB','GB']; const i=Math.floor(Math.log(n)/Math.log(k));
  return (n/Math.pow(k,i)).toFixed(i?1:0)+sizes[i];
}

/* ===== Crypto Envelope =====
   [0]  : version (u8 = 1)
   [1]  : flags  (bit0: encrypted)
   [2:18]  : salt (16 bytes)   (if encrypted)
   [18:30] : iv   (12 bytes)   (if encrypted)
   [x:x+2] : mimeLen (u16)
   [..]    : mime utf8 bytes
   [..]    : data (ciphertext or plaintext)
*/
const V=1;
async function deriveKey(password, salt){
  const baseKey = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']);
  return crypto.subtle.deriveKey(
    {name:'PBKDF2', hash:'SHA-256', salt, iterations: 120000},
    baseKey, {name:'AES-GCM', length:256}, false, ['encrypt','decrypt']
  );
}
async function packAndMaybeEncrypt(bytes, mime, password){
  const isEnc = !!password;
  const mimeBytes = enc.encode(mime);
  const mimeLen = mimeBytes.length;
  const salt = isEnc ? crypto.getRandomValues(new Uint8Array(16)) : new Uint8Array();
  const iv   = isEnc ? crypto.getRandomValues(new Uint8Array(12)) : new Uint8Array();
  let data = bytes;
  if(isEnc){
    const key = await deriveKey(password, salt);
    data = new Uint8Array(await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, bytes));
  }
  const headerLen = 2 + (isEnc? (16+12):0) + 2 + mimeLen;
  const out = new Uint8Array(headerLen + data.length);
  let o=0;
  out[o++]=V; out[o++]= (isEnc?1:0);
  if(isEnc){ out.set(salt,o); o+=16; out.set(iv,o); o+=12; }
  out[o++]= (mimeLen>>8)&255; out[o++]= mimeLen&255;
  out.set(mimeBytes,o); o+=mimeLen;
  out.set(data,o);
  return out;
}
async function unpackAndMaybeDecrypt(u8, password){
  let p=0;
  const ver = u8[p++]; if(ver!==V) throw new Error('Unsupported version');
  const flags = u8[p++]; const isEnc = (flags&1)===1;
  let salt=new Uint8Array(), iv=new Uint8Array();
  if(isEnc){ salt=u8.slice(p,p+16); p+=16; iv=u8.slice(p,p+12); p+=12; }
  const mimeLen = (u8[p++]<<8) | u8[p++];
  const mime = dec.decode(u8.slice(p,p+mimeLen)); p+=mimeLen;
  let data = u8.slice(p);
  if(isEnc){
    if(!password) throw new Error('Password required');
    const key = await deriveKey(password, salt);
    data = new Uint8Array(await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, data));
  }
  return {mime, data};
}

/* ===== Encode flow ===== */
const drop = el('#drop'), fileInput = el('#file'), pass = el('#password');
['click','keydown'].forEach(evt=>{
  drop.addEventListener(evt, e=>{
    if(evt==='keydown' && e.key!=='Enter' && e.key!==' ') return;
    fileInput.click();
  });
});
drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('drag'); });
drop.addEventListener('dragleave', ()=> drop.classList.remove('drag'));
drop.addEventListener('drop', e=>{
  e.preventDefault(); drop.classList.remove('drag');
  const f = e.dataTransfer.files?.[0]; if(f) handleFile(f);
});
fileInput.addEventListener('change', e=>{
  const f=e.target.files?.[0]; if(f) handleFile(f);
});
let picked = null;
function handleFile(f){
  if(!/^image\//.test(f.type)) return alert('Image only');
  if(f.size>5*1024*1024) return alert('Max 5MB');
  picked = f;
  drop.innerHTML = `<div>
    <div style="font-size:42px">âœ…</div>
    <div class="muted">${f.name} â€¢ ${fmtBytes(f.size)}</div>
  </div>`;
}
el('#togglePass').onclick = ()=>{
  pass.type = pass.type==='password' ? 'text' : 'password';
};
el('#encodeBtn').onclick = async ()=>{
  try{
    if(!picked) return alert('ØªØµÙˆÛŒØ± Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ / No image selected');
    const buf = await picked.arrayBuffer();
    const bytes = new Uint8Array(buf);
    const packed = await packAndMaybeEncrypt(bytes, picked.type || 'image/png', pass.value.trim());
    const b64 = bytesToBase64(packed).replace(/=+$/,'');
    const em = mapB64ToEmoji(b64);
    el('#emojiOut').value = em;
    el('#sizeInfo').textContent = fmtBytes(em.length*2); // rough UTF-16 size
  }catch(err){ alert(err.message || err); }
};
el('#clearIn').onclick = ()=>{
  picked=null; fileInput.value='';
  drop.innerHTML = `<div>
    <div style="font-size:42px">ğŸ–¼ï¸</div>
    <div class="muted">${i18n[el('#langSel').value].dropHint}</div>
  </div>`;
  pass.value='';
  el('#emojiOut').value='';
  el('#sizeInfo').textContent='0B';
};
el('#copyEmoji').onclick = async ()=>{
  try{
    await navigator.clipboard.writeText(el('#emojiOut').value);
    toast('ğŸ“‹','Copied!');
  }catch{ alert('Clipboard blocked'); }
};
el('#shareEmoji').onclick = async ()=>{
  const text = el('#emojiOut').value;
  if(navigator.share){
    try{ await navigator.share({text}); }catch(_){}
  }else{
    await navigator.clipboard.writeText(text);
    toast('ğŸ”—','Copied to share');
  }
};

/* ===== Decode flow ===== */
el('#togglePass2').onclick = ()=>{ const p2=el('#password2'); p2.type=p2.type==='password'?'text':'password'; };
el('#pasteEmoji').onclick = async ()=>{
  try{
    const t = await navigator.clipboard.readText();
    if(t) el('#emojiIn').value = t;
  }catch{ alert('Clipboard blocked'); }
};
el('#decodeBtn').onclick = async ()=>{
  try{
    const em = el('#emojiIn').value;
    if(!em.trim()) return;
    const b64 = mapEmojiToB64(em);
    const bytes = base64ToBytes(b64);
    const {mime, data} = await unpackAndMaybeDecrypt(bytes, el('#password2').value.trim());
    const blob = new Blob([data], {type:mime || 'image/png'});
    const url = URL.createObjectURL(blob);
    el('#imgWrap').innerHTML = `<img src="${url}" alt="preview" style="max-width:100%; border-radius:12px">`;
    const dl = el('#dlLink'); dl.classList.remove('hidden');
    const ext = (mime.split('/')[1]||'png').replace('jpeg','jpg');
    dl.href = url; dl.download = `decoded.${ext}`;
  }catch(err){ alert(err.message || err); }
};
el('#clearOut').onclick = ()=>{
  el('#emojiIn').value=''; el('#password2').value='';
  el('#imgWrap').innerHTML = `<span class="muted">â€”</span>`;
  el('#dlLink').classList.add('hidden');
};

/* ===== Toast (simple) ===== */
function toast(icon, msg){
  const t = document.createElement('div');
  t.textContent = `${icon}  ${msg}`;
  t.style.cssText = `
    position:fixed; inset-inline:0; left:0; right:0; bottom:20px; margin:auto; width:max-content; max-width:90vw;
    padding:10px 14px; border-radius:12px; background:var(--panel); color:var(--text);
    border:1px solid var(--border); box-shadow:var(--shadow); z-index:9999; font-weight:600;
  `;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(), 1600);
}

/* ===== Install (PWA) =====
   Single-file trick: we generate a manifest and a service worker dynamically.
   Note: For install prompts, serve over HTTPS and same-origin. Some browsers may
   not accept blob: URLs for the manifest; if that happens, host this file and it
   will still work as an app, just without the "install" banner.
*/
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt = e; el('#installBtn').classList.remove('hidden'); });
el('#installBtn').onclick = async ()=>{
  if(deferredPrompt){ deferredPrompt.prompt(); deferredPrompt=null; }
  else alert('Use browser menu: Add to Home Screen');
};

// Create manifest (as a blob URL)
const manifest = {
  name:"EmojiCoder",
  short_name:"EmojiCoder",
  start_url:"./",
  display:"standalone",
  background_color:"#0b0b0f",
  theme_color: document.documentElement.classList.contains('light') ? "#ffffff" : "#0b0b0f",
  icons:[
    {"src":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAACXBIWXMAAAsSAAALEgHS3X78AAABGUlEQVR4nO3YsQ2CQBiF4f+oYh2s3Hk2hQ0mC0x1i7QH1Ewq3o8b0QvQxZ7n6F4bWcJt3cEwK5gHk7mJ4Jr8a3EwS+3f0lVcz3b0cB3Q4W0cRrXwQb0i2M1S3S8mM8A6v3Xl7u1WQACAAAgAACAABfa4v6oZ3sF2Xx4c1yqE0wF4M3z8H8q5qf0yqV7qfKx6G3XfQkQfYqfA2r2wpu0nWQ3sHk0qk0mJ8f5XQj0q7R7U2K0cA1m3b0F8J8qzqf0zY7f0fZJ2x8G1m0wqk4n0lF8Hf3mCwYAAIAAAAgAAECPAJv9b1GJkG4t9QAAAABJRU5ErkJggg==","sizes":"128x128","type":"image/png"},
    {"src":"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='512' height='512'><rect rx='96' width='512' height='512' fill='%230b0b0f'/><text x='50%%' y='56%%' font-size='260' text-anchor='middle' fill='white'>ğŸ”</text></svg>","sizes":"512x512","type":"image/svg+xml"}
  ]
};
const manifestBlob = new Blob([JSON.stringify(manifest)], {type:'application/manifest+json'});
const manifestURL = URL.createObjectURL(manifestBlob);
const link = document.createElement('link'); link.rel='manifest'; link.href = manifestURL; document.head.appendChild(link);

// Create and register a minimal service worker that caches this page for offline
const swCode = `
  self.addEventListener('install', e=>{
    e.waitUntil(
      caches.open('emoji-v1').then(c=>c.addAll(['./']))
    );
    self.skipWaiting();
  });
  self.addEventListener('activate', e=> self.clients.claim());
  self.addEventListener('fetch', e=>{
    const url = new URL(e.request.url);
    if(url.origin===location.origin){
      e.respondWith(
        caches.match(e.request).then(r=> r || fetch(e.request).then(res=>{
          const copy = res.clone();
          caches.open('emoji-v1').then(c=>c.put(e.request, copy));
          return res;
        }).catch(()=>caches.match('./')))
      );
    }
  });
`;
if('serviceWorker' in navigator){
  const blob = new Blob([swCode], {type:'text/javascript'});
  const swUrl = URL.createObjectURL(blob);
  navigator.serviceWorker.register(swUrl).catch(()=>{ /* ignore */ });
}
</script>
</body>
</html>
