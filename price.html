<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>داشبورد قیمت فلزات — نسخه مینیمال</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Vazirmatn', 'ui-sans-serif', 'system-ui'] },
          colors: {
            base: {
              900: '#0b0f14',
              800: '#0f141b',
              700: '#121925',
              600: '#141c26',
              500: '#1b2430',
            },
            ink: {
              100: '#cfd6e0',
              200: '#aab4c4',
              300: '#97a5b8',
            },
            brand: {
              DEFAULT: '#7c3aed',
              500: '#7c3aed',
              400: '#9f67ff',
              300: '#c5a5ff'
            }
          },
          boxShadow: {
            soft: '0 6px 24px rgba(0,0,0,0.28)',
            inner: 'inset 0 0 0 1px rgba(255,255,255,0.04)'
          },
          keyframes: {
            pulseGlow: {
              '0%, 100%': { boxShadow: '0 0 0 0 rgba(124,58,237,0.35)' },
              '50%': { boxShadow: '0 0 0 12px rgba(124,58,237,0)' }
            },
            shimmer: {
              '0%': { backgroundPosition: '200% 0' },
              '100%': { backgroundPosition: '-200% 0' }
            }
          },
          animation: {
            pulseGlow: 'pulseGlow 2.2s ease-in-out infinite',
            shimmer: 'shimmer 1.25s linear infinite'
          }
        }
      }
    };
  </script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    :root { color-scheme: dark; }
    html, body { height: 100%; }
    body { background: radial-gradient(1200px 700px at 110% -10%, rgba(124,58,237,.12), transparent 60%),
                     radial-gradient(900px 600px at -10% 120%, rgba(37,99,235,.10), transparent 60%),
                     #0b0f14; }
    .glass { background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
             backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,.06); }
    .neon-ring { position: relative; }
    .neon-ring::before { content: ""; position:absolute; inset:-1px; border-radius: 14px;
      background:
        conic-gradient(from 180deg at 50% 50%, rgba(124,58,237,.25), rgba(59,130,246,.18), rgba(16,185,129,.18), rgba(124,58,237,.25));
      filter: blur(12px); opacity:.35; z-index:-1; }
    .skeleton { background: linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,.12), rgba(255,255,255,.06));
                background-size: 300% 100%; }
    .tap { -webkit-tap-highlight-color: transparent; }
  </style>
</head>
<body class="dark text-ink-100 font-sans selection:bg-brand/20 selection:text-white tap">
  <!-- Page Wrapper -->
  <div class="min-h-dvh flex items-center justify-center px-3 py-6">
    <div class="w-full max-w-5xl">
      <!-- Top Bar -->
      <header class="glass rounded-2xl shadow-soft shadow-inner px-4 sm:px-6 py-3 sm:py-4 flex items-center justify-between gap-3">
        <div class="flex items-center gap-2">
          <span class="relative block w-2.5 h-2.5 rounded-full bg-emerald-400/80 animate-pulseGlow"></span>
          <div class="text-xs sm:text-sm text-ink-200">بروزرسانی: <span id="updatedAt" class="font-semibold text-white">—</span></div>
        </div>
        <div class="flex items-center gap-3 sm:gap-4">
          <button id="btnAuto" class="glass hover:bg-white/5 transition rounded-xl px-3 py-1.5 text-xs sm:text-sm text-ink-200">خودکار</button>
          <button id="btnRefresh" class="neon-ring bg-brand/15 hover:bg-brand/25 active:bg-brand/30 transition rounded-xl px-3 sm:px-4 py-1.5 text-white text-xs sm:text-sm flex items-center gap-1.5">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" class="rotate-0" id="refreshIcon"><path d="M21 12a9 9 0 1 1-2.64-6.36" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><path d="M21 3v7h-7" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <span>بروزرسانی</span>
          </button>
        </div>
        <div class="flex items-center gap-3">
          <div class="text-right leading-tight">
            <div class="text-xs sm:text-sm font-semibold text-white">قیمت جهانی فلزات</div>
            <div class="text-[10px] sm:text-xs text-ink-300">Hypermodern · Minimal</div>
          </div>
          <div class="w-8 h-8 sm:w-9 sm:h-9 rounded-xl bg-gradient-to-br from-brand/40 to-white/5 flex items-center justify-center text-white/90">
            <span class="font-bold">EMK</span>
          </div>
        </div>
      </header>

      <!-- Grid Cards (One card per metal, compact and information-dense) -->
      <main class="mt-5 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
        <!-- Card Template: duplicated for Al, Cu, Zn -->
        <section id="cardAl" class="glass rounded-2xl shadow-soft p-4 sm:p-5">
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
              <div class="w-8 h-8 rounded-lg bg-white/10 flex items-center justify-center text-white text-sm font-bold">Al</div>
              <h3 class="text-sm sm:text-base font-semibold text-white">آلومینیوم</h3>
            </div>
            <small class="text-[11px] text-ink-300" id="alDate">—</small>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div class="rounded-xl bg-white/5 border border-white/5 p-3">
              <div class="text-[11px] text-ink-300">پایانی</div>
              <div id="alClose" class="mt-1 text-xl sm:text-2xl font-bold tracking-tight">—</div>
            </div>
            <div class="rounded-xl bg-white/5 border border-white/5 p-3">
              <div class="text-[11px] text-ink-300">لحظه‌ای</div>
              <div id="alSpot" class="mt-1 text-xl sm:text-2xl font-bold tracking-tight">—</div>
            </div>
          </div>
        </section>

        <section id="cardCu" class="glass rounded-2xl shadow-soft p-4 sm:p-5">
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
              <div class="w-8 h-8 rounded-lg bg-white/10 flex items-center justify-center text-white text-sm font-bold">Cu</div>
              <h3 class="text-sm sm:text-base font-semibold text-white">مس</h3>
            </div>
            <small class="text-[11px] text-ink-300" id="cuDate">—</small>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div class="rounded-xl bg-white/5 border border-white/5 p-3">
              <div class="text-[11px] text-ink-300">پایانی</div>
              <div id="cuClose" class="mt-1 text-xl sm:text-2xl font-bold tracking-tight">—</div>
            </div>
            <div class="rounded-xl bg-white/5 border border-white/5 p-3">
              <div class="text-[11px] text-ink-300">لحظه‌ای</div>
              <div id="cuSpot" class="mt-1 text-xl sm:text-2xl font-bold tracking-tight">—</div>
            </div>
          </div>
        </section>

        <section id="cardZn" class="glass rounded-2xl shadow-soft p-4 sm:p-5">
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
              <div class="w-8 h-8 rounded-lg bg-white/10 flex items-center justify-center text-white text-sm font-bold">Zn</div>
              <h3 class="text-sm sm:text-base font-semibold text-white">روی</h3>
            </div>
            <small class="text-[11px] text-ink-300" id="znDate">—</small>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div class="rounded-xl bg-white/5 border border-white/5 p-3">
              <div class="text-[11px] text-ink-300">پایانی</div>
              <div id="znClose" class="mt-1 text-xl sm:text-2xl font-bold tracking-tight">—</div>
            </div>
            <div class="rounded-xl bg-white/5 border border-white/5 p-3">
              <div class="text-[11px] text-ink-300">لحظه‌ای</div>
              <div id="znSpot" class="mt-1 text-xl sm:text-2xl font-bold tracking-tight">—</div>
            </div>
          </div>
        </section>
      </main>

      <!-- Bottom Meta / Timestamps -->
      <footer class="mt-4 sm:mt-6 grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4">
        <div class="glass rounded-2xl p-3 sm:p-4 flex items-center justify-between">
          <div class="text-[11px] text-ink-300">UTC</div>
          <div id="utcTime" class="text-xs sm:text-sm font-semibold text-white">—</div>
        </div>
        <div class="glass rounded-2xl p-3 sm:p-4 flex items-center justify-between">
          <div class="text-[11px] text-ink-300">تاریخ شمسی</div>
          <div id="jalali" class="text-xs sm:text-sm font-semibold text-white">—</div>
        </div>
        <div class="glass rounded-2xl p-3 sm:p-4 flex items-center justify-between">
          <div class="text-[11px] text-ink-300">منبع</div>
          <a class="text-xs sm:text-sm font-semibold text-white/90 hover:text-white underline underline-offset-4 decoration-white/20" href="#" aria-label="metalsmarket.net">metalsmarket.net</a>
        </div>
      </footer>
    </div>
  </div>

  <!-- Minimal Loader Overlay (shown only during first load) -->
  <div id="loader" class="fixed inset-0 pointer-events-none transition-opacity duration-500 opacity-0 hidden">
    <div class="absolute inset-0 bg-base-900/80 backdrop-blur-sm"></div>
    <div class="absolute inset-0 flex items-center justify-center">
      <div class="w-10 h-10 rounded-full border-2 border-white/20 border-t-brand animate-spin"></div>
    </div>
  </div>

  <script>
    const apiUrl = 'https://aluminium.chbk.app/api/all-prices';
    const proxied = (u) => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`;

    const els = {
      updatedAt: document.getElementById('updatedAt'),
      utcTime: document.getElementById('utcTime'),
      jalali: document.getElementById('jalali'),
      alClose: document.getElementById('alClose'),
      alSpot: document.getElementById('alSpot'),
      cuClose: document.getElementById('cuClose'),
      cuSpot: document.getElementById('cuSpot'),
      znClose: document.getElementById('znClose'),
      znSpot: document.getElementById('znSpot'),
      alDate: document.getElementById('alDate'),
      cuDate: document.getElementById('cuDate'),
      znDate: document.getElementById('znDate'),
      btnRefresh: document.getElementById('btnRefresh'),
      btnAuto: document.getElementById('btnAuto'),
      loader: document.getElementById('loader'),
      refreshIcon: document.getElementById('refreshIcon'),
    };

    const fmt = (n) => {
      if (n === undefined || n === null || Number.isNaN(Number(n))) return '—';
      return Number(n).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' $';
    };

    const setText = (el, value) => { if (el) el.textContent = value ?? '—'; };

    const paint = (data) => {
      try {
        const { closing_latest, latest_spot } = data;
        // Prices
        setText(els.alClose, fmt(closing_latest.values.alum_close));
        setText(els.cuClose, fmt(closing_latest.values.copper_close));
        setText(els.znClose, fmt(closing_latest.values.zinc_close));

        setText(els.alSpot, fmt(latest_spot.al_spot_ask));
        setText(els.cuSpot, fmt(latest_spot.cu_spot_ask));
        setText(els.znSpot, fmt(latest_spot.zn_spot_ask));

        // Dates
        setText(els.alDate, closing_latest.values.alum_close_date || '—');
        setText(els.cuDate, closing_latest.values.copper_close_date || '—');
        setText(els.znDate, closing_latest.values.zinc_close_date || '—');

        // Meta
        const utcStr = new Date(latest_spot.timestamp_utc).toLocaleString('en-GB', {
          year: 'numeric', month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', timeZone: 'UTC'
        });
        setText(els.utcTime, utcStr);
        setText(els.jalali, latest_spot.jalali || '—');
        setText(els.updatedAt, new Date().toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' }));
      } catch (e) {
        console.error('Paint error', e);
      }
    };

    const saveCache = (data) => {
      try { localStorage.setItem('emkPrices', JSON.stringify({ t: Date.now(), v: data })); } catch (_) {}
    };
    const readCache = () => {
      try {
        const raw = localStorage.getItem('emkPrices');
        if (!raw) return null;
        const { v } = JSON.parse(raw);
        return v || null;
      } catch (_) { return null; }
    };

    const showLoader = (on) => {
      if (!els.loader) return;
      if (on) { els.loader.classList.remove('hidden'); requestAnimationFrame(() => els.loader.classList.remove('opacity-0')); }
      else { els.loader.classList.add('opacity-0'); setTimeout(() => els.loader.classList.add('hidden'), 450); }
    };

    async function fetchWithRetry(url, tries = 3, delay = 900) {
      let lastErr;
      for (let i = 0; i < tries; i++) {
        try {
          const r = await fetch(url, { cache: 'no-store' });
          if (!r.ok) throw new Error('HTTP ' + r.status);
          return await r.json();
        } catch (e) {
          lastErr = e; await new Promise(res => setTimeout(res, delay)); delay *= 1.75;
        }
      }
      throw lastErr;
    }

    async function loadData(first = false) {
      try {
        if (first) showLoader(true);
        els.btnRefresh.disabled = true;
        els.refreshIcon.classList.add('animate-spin');
        const data = await fetchWithRetry(proxied(apiUrl));
        paint(data);
        saveCache(data);
      } catch (e) {
        console.error(e);
        // Fallback: show cached data if available
        const cached = readCache();
        if (cached) paint(cached);
        else alert('خطا در دریافت داده‌ها. لطفاً بعداً تلاش کنید.');
      } finally {
        els.btnRefresh.disabled = false;
        els.refreshIcon.classList.remove('animate-spin');
        showLoader(false);
      }
    }

    // Auto refresh toggle
    let autoTimer = null;
    function toggleAuto() {
      const on = !!autoTimer;
      if (on) {
        clearInterval(autoTimer); autoTimer = null; els.btnAuto.classList.remove('bg-white/10'); els.btnAuto.textContent = 'خودکار';
      } else {
        autoTimer = setInterval(() => loadData(false), 60_000); // every 60s
        els.btnAuto.classList.add('bg-white/10'); els.btnAuto.textContent = 'فعال';
      }
    }

    // Wire events
    els.btnRefresh.addEventListener('click', () => loadData(false));
    els.btnAuto.addEventListener('click', toggleAuto);

    // First paint from cache → then fetch fresh
    (function init() {
      const cached = readCache();
      if (cached) paint(cached);
      loadData(true);
    })();
  </script>
</body>
</html>
