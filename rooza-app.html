<!DOCTYPE html>
<html lang="fa" dir="ltr" class="">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Rooza | Habit Tracker App</title>
    <meta name="description" content="Rooza (روزا) Personal Habit and Goal Tracker Application">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Rooza">
    <meta name="application-name" content="Rooza">
    <link rel="icon" type="image/png" href="https://i.postimg.cc/4xvMK8zQ/rooza-app-logo-final.png">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/4xvMK8zQ/rooza-app-logo-final.png">
    <link rel="apple-touch-icon" sizes="152x152" href="https://i.postimg.cc/4xvMK8zQ/rooza-app-logo-final.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://i.postimg.cc/4xvMK8zQ/rooza-app-logo-final.png">
    <link rel="apple-touch-icon" sizes="167x167" href="https://i.postimg.cc/4xvMK8zQ/rooza-app-logo-final.png">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style id="dynamic-theme-style"></style>
    <style>
           html, body {
            overscroll-behavior-y: contain;
        }
        body { font-family: 'Vazirmatn', sans-serif; background-color: var(--color-bg); color: var(--color-text);
     .sortable-ghost { opacity: 0.4; background-color: #cce7ff; }
    }

        .sortable-ghost { opacity: 0.4; background-color: #cce7ff; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .goal-anim-in { animation: goal-fade-in 0.4s ease-out forwards; }
        .goal-anim-out { animation: goal-fade-out 0.3s ease-in forwards; }
        @keyframes goal-fade-in { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes goal-fade-out { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        .cell-swipe-up { animation: cell-pop 0.2s ease-out forwards; }
        .cell-swipe-down { animation: cell-shrink 0.2s ease-out forwards; }
        @keyframes cell-pop { 0% { transform: scale(1); } 50% { transform: scale(1.15); background-color: hsla(120, 73%, 75%, 0.5); } 100% { transform: scale(1); } }
        @keyframes cell-shrink { 0% { transform: scale(1); } 50% { transform: scale(0.85); background-color: hsla(0, 100%, 80%, 0.5); } 100% { transform: scale(1); } }
        .stat-card { background-color: var(--color-card); padding: 1rem; border-radius: 0.75rem; text-align: center; box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); transition: all 0.2s; }
        .stat-card:hover { transform: scale(1.05); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--color-primary); margin-bottom: 0.25rem; }
        .stat-label { font-size: 0.75rem; color: var(--color-text-muted); font-weight: 600; }
        .report-tab-btn { background-color: var(--color-cell-inactive); color: var(--color-text); }
        .report-tab-btn.active { background-color: var(--color-primary); color: var(--color-primary-text); box-shadow: 0 4px 14px 0 var(--color-primary-shadow); }
        .heatmap-day { transition: background-color 0.2s; }
        .heatmap-count { background-color: #0ea5e9; color: white; }
        .glass-modal-content { background-color: var(--color-header); backdrop-filter: blur(16px); border: 1px solid var(--color-border); }
        #settingsMenu, #categoryMenu { display: none; }
        #settingsMenu.visible, #categoryMenu.visible { display: block; }
        /* .emoji-container { background-color: var(--color-cell-inactive); } */

        .shadow-sky-500\/30 {
  --tw-shadow-color: rgba(193, 193, 193, 0.72) !important;
  --tw-shadow: var(--tw-shadow-colored) !important;
}
.ring-2 {
  --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color) !important;
  --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color) !important;
  box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000) !important;
}
.ring-sky-500 {
  --tw-ring-opacity: 0.2 !important;
  --tw-ring-color: rgba(208, 208, 208, 0.32) !important
}
.emoji-in-cell-wrapper {
    position: relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}
.emoji-counter-badge {
    position: absolute;
    bottom: -2px;
    right: -4px;
    background-color: var(--color-primary);
    color: var(--color-primary-text);
    border-radius: 9999px;
    font-size: 9px;
    font-weight: 700;
    line-height: 1;
    min-width: 16px;
    height: 16px;
    padding: 0 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--color-card);
    transform-origin: bottom right;
    animation: badge-pop-in 0.3s ease-out forwards;
}
@keyframes badge-pop-in {
    0% { transform: scale(0.5); opacity: 0; }
    70% { transform: scale(1.15); opacity: 1; }
    100% { transform: scale(1); opacity: 1; }
}

/* --- Mobile Menu Redesign --- */
#mobileMenu {
    background-color: var(--color-header);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-left: 1px solid var(--color-border);
    box-shadow: -10px 0px 30px rgba(0, 0, 0, 0.1);
}

.mobile-menu-open #mainContent,
.mobile-menu-open #navbar,
.mobile-menu-open #fab {
    filter: blur(4px) brightness(0.8);
    transform: scale(0.98);
    transition: transform 0.4s ease, filter 0.4s ease;
}

body.mobile-menu-open {
    overflow: hidden;
}

.menu-item-fade-in {
    animation: menuItemFadeIn 0.5s ease-out forwards;
    opacity: 0;
}

@keyframes menuItemFadeIn {
    from {
        opacity: 0;
        transform: translateX(20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.menu-section-title {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-muted);
    padding: 0 1rem;
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
}

.mobile-menu-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    border-radius: 0.75rem;
    font-weight: 600;
    transition: background-color 0.2s, color 0.2s;
}
.mobile-menu-item:hover {
    background-color: var(--color-hover);
}
.mobile-menu-item.active {
    background-color: var(--color-primary);
    color: var(--color-primary-text);
    box-shadow: 0 4px 14px 0 var(--color-primary-shadow);
}
.mobile-menu-item .icon {
    width: 1.25rem;
    height: 1.25rem;
}

    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: 'var(--color-primary)',
                        'primary-text': 'var(--color-primary-text)',
                        'app-bg': 'var(--color-bg)',
                        'app-text': 'var(--color-text)',
                        'app-text-muted': 'var(--color-text-muted)',
                        'app-card': 'var(--color-card)',
                        'app-header': 'var(--color-header)',
                        'app-border': 'var(--color-border)',
                        'app-hover': 'var(--color-hover)',
                        'app-cell-inactive': 'var(--color-cell-inactive)',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-app-bg text-app-text antialiased">
    <div class="min-h-screen pt-[env(safe-area-inset-top)]">
       <header id="navbar" class="sticky top-0 z-50 bg-app-header backdrop-blur-lg flex items-center justify-between p-4 border-b border-app-border">
<div class="md:hidden flex items-center justify-between w-full">

    <button id="mobileReportsBtn" aria-label="گزارش‌ها" class="text-app-text-muted hover:bg-app-hover rounded-full p-2 transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
    </button>

    <div id="weekTitleMobile" class="text-base font-bold text-primary text-center truncate"></div>

    <button id="hamburgerBtn" aria-label="Open menu" class="text-app-text-muted hover:bg-app-hover rounded-full p-2 transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>

</div>

    <div class="hidden md:flex flex-1">
        <button id="todayBtn" class="text-sm text-app-text-muted font-semibold hover:text-primary transition-colors"></button>
    </div>
    <div class="hidden md:flex items-center gap-2">
        <button id="prevWeekBtn" aria-label="Previous Week" class="flex items-center gap-x-2 text-app-text-muted hover:bg-app-hover rounded-full px-3 py-2 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
            <span class="text-sm font-medium hidden sm:inline">هفته قبلی</span>
        </button>
        <div id="weekTitle" class="text-base md:text-lg font-bold text-primary w-40 text-center"></div>
        <button id="nextWeekBtn" aria-label="Next Week" class="flex items-center gap-x-2 text-app-text-muted hover:bg-app-hover rounded-full px-3 py-2 transition-colors">
            <span class="text-sm font-medium hidden sm:inline">هفته بعدی</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
        </button>
    </div>
    <div class="hidden md:flex flex-1 flex justify-end items-center">
        <div class="relative">
            <button id="categoryMenuBtn" aria-label="Categories" class="text-app-text-muted hover:bg-app-hover rounded-full p-2 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-5.414 5.414a1 1 0 00-.293.707V19l-4 2v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                </svg>
            </button>
            <div id="categoryMenu" class="absolute right-0 mt-2 w-56 origin-top-right bg-app-header backdrop-blur-lg shadow-2xl rounded-xl border border-app-border p-2 text-base z-[1001]"></div>
        </div>
        <div class="relative">
            <button id="settingsMenuBtn" aria-label="Settings" class="text-app-text-muted hover:bg-app-hover rounded-full p-2 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </button>
            <div id="settingsMenu" class="absolute right-0 mt-2 w-56 origin-top-right bg-app-header backdrop-blur-lg shadow-2xl rounded-xl border border-app-border p-2 text-base z-[1001]">
                </div>
        </div>
    </div>
    
</header>

<div id="mobileMenu" dir="rtl" class="fixed inset-0 transform translate-x-full transition-transform duration-300 ease-in-out z-[100] pt-[env(safe-area-inset-top)]">
    <div id="mobileMenuContent" class="h-full flex flex-col"></div>
</div>


        <main id="mainContent" class="max-w-4xl mx-auto p-4 pb-32">
            <div id="weekdayRow" class="grid grid-cols-7 gap-2 text-center my-6"></div>
            <div id="goalList" class="flex flex-col gap-4"></div>
            <div id="archivedGoalList" class="hidden">
                <h3 class="text-lg font-bold text-app-text-muted my-4 p-2 border-b-2 border-app-border">آرشیو شده‌ها</h3>
                <div class="flex flex-col gap-4"></div>
            </div>
        </main>
        <button id="fab" aria-label="افزودن هدف" class="fixed right-6 bottom-[calc(env(safe-area-inset-bottom)+1.5rem)] z-50 w-16 h-16 bg-primary text-primary-text rounded-full flex items-center justify-center text-3xl shadow-lg hover:opacity-90 active:scale-90 transition-all">＋</button>
    </div>
    <div id="modalArea"></div>
    <div id="contextMenu" class="fixed z-[1000] min-w-[180px] bg-app-header backdrop-blur-lg shadow-2xl rounded-xl border border-app-border p-2 text-base" style="display:none"></div>
    <script src="themes.js"></script>
<script>
    const checkmarkSVG = `<svg width="24" height="24" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"> <circle cx="16" cy="16" r="15" fill="url(#paint0_radial)" stroke="#4CAF50" stroke-width="2"></circle> <path d="M9 17.5L14 22L23 12.5" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"></path> <defs> <radialGradient id="paint0_radial" cx="0" cy="0" r="1" gradientTransform="translate(16 16) scale(16)"> <stop stop-color="#A5D6A7"></stop> <stop offset="1" stop-color="#4CAF50"></stop> </radialGradient> </defs></svg>`;
    // --- CONSTANTS & CONFIG ---
    const EMOJIS = [checkmarkSVG,'🎉','🔥','💪','🎯','👍','👎','❌','🤔','😴','🍔','💻','🧘','📖'];
    const CATEGORIES = {
        'ورزش': 'bg-sky-100 text-sky-800 dark:bg-sky-900/50 dark:text-sky-300',
        'کار': 'bg-amber-100 text-amber-800 dark:bg-amber-900/50 dark:text-amber-300',
        'شخصی': 'bg-violet-100 text-violet-800 dark:bg-violet-900/50 dark:text-violet-300',
        'سلامتی': 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300',
    };
 

    const STORAGE_KEY = 'goal_tracker_data_v13_ltr';
    const STORAGE_ORDER = 'goal_tracker_order_v13_ltr';
    const STORAGE_ACTIVE_THEME = 'goal_tracker_active_theme_v5';
    const STORAGE_FAVORITE_THEMES = 'goal_tracker_favorite_themes_v1';
const STORAGE_RANDOM_THEME = 'goal_tracker_random_theme_v1';

const WEEKDAY_NAMES_SHORT = ['ش', 'ی', 'د', 'س', 'چ', 'پ', 'ج'];    const JALALI_MONTH_NAMES = ["فروردین", "اردیبهشت", "خرداد", "تیر", "مرداد", "شهریور", "مهر", "آبان", "آذر", "دی", "بهمن", "اسفند"];
        
let appState = {
    currentWeek: getStartOfWeek(new Date()),
    goals: [], 
    order: [], 
    activeThemeId: 'theme-paper', // تغییر به تم کاغذی به عنوان تم اولیه
    editing: null, 
    showArchived: false,
    activeCategory: 'all',
    contextMenuGoalId: null,
    userLight: 'theme-paper', // تم پیش‌فرض برای حالت روشن
    userDark: 'theme-synthwave-84', // تم پیش‌فرض برای حالت تیره
    favoriteThemes: [],
    randomThemeMode: false
};
    function toJalali(gy, gm, gd) { let g_d_m=[0,31,59,90,120,151,181,212,243,273,304,334];let jy=(gy<=1600)?0:979;gy-=(gy<=1600)?621:1600;let gy2=(gm>2)?(gy+1):gy;let days=(365*gy)+(parseInt((gy2+3)/4))-(parseInt((gy2+99)/100))+(parseInt((gy2+399)/400))-80+gd+g_d_m[gm-1];jy+=33*(parseInt(days/12053));days%=12053;jy+=4*(parseInt(days/1461));days%=1461;jy+=parseInt((days-1)/365);if(days>365)days=(days-1)%365;let jm=(days<186)?1+parseInt(days/31):7+parseInt((days-186)/30);let jd=1+((days<186)?(days%31):((days-186)%30));return[jy,jm,jd];}
    function toGregorian(jy, jm, jd) { let gy=(jy<=979)?621:1600;jy-=(jy<=979)?0:979;let days=(365*jy)+(parseInt(jy/33)*8)+(parseInt(((jy%33)+3)/4)) + 78 + jd + ((jm<7)?(jm-1)*31:((jm-7)*30)+186);gy+=400*(parseInt(days/146097));days%=146097;if(days>36524){gy+=100*(parseInt(--days/36524));days%=36524;if(days>=365)days++;}gy+=4*(parseInt(days/1461));days%=1461;gy+=parseInt((days-1)/365);if(days>365)days=(days-1)%365;let gd=days+1;let sal_a=[0,31,((gy%4===0&&gy%100!==0)||(gy%400===0))?29:28,31,30,31,30,31,31,30,31,30,31];let gm;for(gm=0;gm<13&&gd>sal_a[gm];gm++)gd-=sal_a[gm];return new Date(gy,gm-1,gd);}
    function isJalaliLeap(year) { return (((((year-474)%2820)+512)*682)%2816)<682; }
    function jalaliMonthLength(year, month) { if (month<=6) return 31; if (month<=11) return 30; if (isJalaliLeap(year)) return 30; return 29; }
    function toFa(num) { return (''+num).replace(/\d/g, d => '۰۱۲۳۴۵۶۷۸۹'[+d]); }
    function getStartOfWeek(date) { const d = new Date(date); d.setHours(0,0,0,0); const day = d.getDay(); const diff = (day + 1) % 7; d.setDate(d.getDate() - diff); return d; }
    function getWeekDates(base) { return Array.from({length:7}, (_,i) => { const d = new Date(base); d.setDate(base.getDate()+i); return d; }); }
    function formatWeekRange(base) { const week=getWeekDates(base); const startDate=week[0]; const endDate=week[6]; const [startJy, startJm, startJd]=toJalali(startDate.getFullYear(), startDate.getMonth()+1, startDate.getDate()); const [endJy, endJm, endJd]=toJalali(endDate.getFullYear(), endDate.getMonth()+1, endDate.getDate()); if (startJm === endJm) { const startDay=toFa(startJd); const endDay=toFa(endJd); const monthName=JALALI_MONTH_NAMES[startJm - 1]; return `${startDay} – ${endDay} ${monthName}`; } else { const fmt=(d) => d.toLocaleDateString('fa-IR', { month: 'short', day: 'numeric' }); return `${fmt(startDate)} – ${fmt(endDate)}`; }}
    function isToday(date) { const now = new Date(); return date.toDateString() === now.toDateString(); }
   function weekIdForDate(date) {
    const d = getStartOfWeek(date);
    // This creates a reliable YYYY-MM-DD format
    const month = (d.getMonth() + 1).toString().padStart(2, '0');
    const day = d.getDate().toString().padStart(2, '0');
    return `${d.getFullYear()}-${month}-${day}`;
}
    function escapeHtml(txt) { return (''+txt).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g, '&quot;'); }

    function generateDayCellContent(dayData) {
    if (!dayData || !dayData.entries || dayData.entries.length === 0) {
        return '';
    }

    // Count occurrences of each unique emoji
    const emojiCounts = dayData.entries.reduce((acc, emoji) => {
        acc[emoji] = (acc[emoji] || 0) + 1;
        return acc;
    }, {});

    let content = '';
    for (const emoji in emojiCounts) {
        const count = emojiCounts[emoji];
        const isSvg = emoji.startsWith('<svg');
        const emojiDisplay = isSvg 
            ? `<span class="inline-flex items-center justify-center w-8 h-8">${emoji}</span>` 
            : `<span class="text-sm md:text-base">${escapeHtml(emoji)}</span>`;

        // Create a wrapper for each emoji to position the badge correctly
        content += `<div class="emoji-in-cell-wrapper">
                        ${emojiDisplay}
                        ${count > 1 ? `<span class="emoji-counter-badge">${toFa(count)}</span>` : ''}
                    </div>`;
    }
    return `<div class="w-full h-full flex flex-wrap items-center justify-center gap-1.5 leading-none">${content}</div>`;
}

function getDefaultGoals() {
        const creationDate = "2025-07-03T17:13:33.798Z";
        const goals = [
            { id: "default_2", name: "خواندن کتاب", emoji: "📖", days: [true, true, true, true, true, true, true], history: { "2025-6-29": [ { entries:[], note:"" }, { entries:[], note:"" }, { entries:[], note:"" }, { entries:[], note:"" }, { entries:[], note:"" }, { entries:[], note:"" }, { entries:[], note:"" } ] }, type: "binary", archived: false, category: "شخصی", creationDate },
            { id: "1751566854259", name: "رفتن به باشگاه", emoji: "💪", days: [true, true, true, true, true, true, true], history: {}, type: "binary", archived: false, category: "ورزش", creationDate },
            { id: "1751566870084", name: "تمرین موسیقی", emoji: "🎸", days: [true, true, true, true, true, true, true], history: {}, type: "binary", archived: false, category: "شخصی", creationDate },
            { id: "1751566912252", name: "پیاده روی", emoji: "🚶", days: [true, true, true, true, true, true, true], history: {}, type: "binary", archived: false, category: "سلامتی", creationDate },
            { id: "1751566952796", name: "یادگیری آشپزی", emoji: "🍳", days: [true, true, true, true, true, true, true], history: {}, type: "binary", archived: false, category: "کار", creationDate }
        ];
        const order = ["default_2", "1751566854259", "1751566870084", "1751566912252", "1751566952796"];
        return { goals, order };
    }
    // REPLACE THIS FUNCTION
function loadStateFromStorage() {
    const data = localStorage.getItem(STORAGE_KEY);
    const order = localStorage.getItem(STORAGE_ORDER);
    const activeThemeId = localStorage.getItem(STORAGE_ACTIVE_THEME) || 'theme-paper'; // پیش‌فرض اولیه
    const favoriteThemes = localStorage.getItem(STORAGE_FAVORITE_THEMES);
    const randomThemeMode = localStorage.getItem(STORAGE_RANDOM_THEME);

    let goals, orderArr;
    if (data && order) {
        try {
            goals = JSON.parse(data);
            orderArr = JSON.parse(order);
        } catch (e) {
            console.error("Failed to parse localStorage data, resetting to default.", e);
            const defaults = getDefaultGoals();
            goals = defaults.goals;
            orderArr = defaults.order;
        }
    } else {
        const defaults = getDefaultGoals();
        goals = defaults.goals;
        orderArr = defaults.order;
    }
    goals.forEach(g => {
        g.type = g.type || 'binary';
        if (typeof g.archived === 'undefined') g.archived = false;
        if (typeof g.category === 'undefined') g.category = 'شخصی';
        if (typeof g.creationDate === 'undefined') g.creationDate = new Date().toISOString();
        if (g.history) {
            Object.values(g.history).forEach(week => {
                if (Array.isArray(week)) {
                    week.forEach((day, i) => {
                        if (day && typeof day !== 'object') { week[i] = { entries: [day === 1 ? checkmarkSVG : '❌'], note: '' }; }
                        else if (day && !day.entries) { week[i] = { entries: [], note: ''}; }
                    });
                }
            });
        }
    });
    appState.goals = goals;
    appState.order = orderArr.filter(id => goals.some(g => g.id === id));
    appState.activeThemeId = activeThemeId;
    appState.userLight = localStorage.getItem('goal_tracker_user_light_theme') || 'theme-paper'; // پیش‌فرض حالت روشن
    appState.userDark = localStorage.getItem('goal_tracker_user_dark_theme') || 'theme-synthwave-84'; // پیش‌فرض حالت تیره
    
    if (favoriteThemes) {
        appState.favoriteThemes = JSON.parse(favoriteThemes);
    }
    if (randomThemeMode) {
        appState.randomThemeMode = JSON.parse(randomThemeMode);
    }

    if (appState.randomThemeMode) {
        const allThemes = [].concat(...Object.values(themesData));
        if (allThemes.length > 0) {
            const randomTheme = allThemes[Math.floor(Math.random() * allThemes.length)];
            setActiveTheme(randomTheme.id, true);
        }
    }
}

// ADD THESE NEW FUNCTIONS
function addFavoriteTheme(themeId) {
    if (!appState.favoriteThemes.includes(themeId)) {
        appState.favoriteThemes.push(themeId);
        persistState();
    }
}

function removeFavoriteTheme(themeId) {
    appState.favoriteThemes = appState.favoriteThemes.filter(id => id !== themeId);
    persistState();
}

// REPLACE THIS FUNCTION
function persistState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(appState.goals));
    localStorage.setItem(STORAGE_ORDER, JSON.stringify(appState.order));
    localStorage.setItem('goal_tracker_user_light_theme', appState.userLight);
    localStorage.setItem('goal_tracker_user_dark_theme', appState.userDark);
    localStorage.setItem(STORAGE_FAVORITE_THEMES, JSON.stringify(appState.favoriteThemes));
    localStorage.setItem(STORAGE_RANDOM_THEME, JSON.stringify(appState.randomThemeMode));
}
    function setActiveTheme(themeId, fromToggle = false) {
        const theme = findThemeById(themeId);
        if (!theme) return;

        appState.activeThemeId = themeId;
        localStorage.setItem(STORAGE_ACTIVE_THEME, themeId);
        
        if (!fromToggle) {
             if(theme.isDark) {
                appState.userDark = themeId;
            } else {
                appState.userLight = themeId;
            }
        }
        
        applyActiveTheme();
        updateDarkModeToggleState();
    }
    function findThemeById(themeId) {
        for (const category in themesData) {
            const found = themesData[category].find(t => t.id === themeId);
            if (found) return found;
        }
        return themesData.classicDark.find(t => t.id === 'theme-ios-dark'); // Fallback
    }
 // REPLACE the old applyActiveTheme function with this one:
function applyActiveTheme() {
    const theme = findThemeById(appState.activeThemeId);
    const styleEl = document.getElementById('dynamic-theme-style');
    document.documentElement.classList.toggle('dark', theme.isDark);
    const primaryColor = theme.primary.replace('#', '');
    const r = parseInt(primaryColor.substr(0, 2), 16);
    const g = parseInt(primaryColor.substr(2, 2), 16);
    const b = parseInt(primaryColor.substr(4, 2), 16);
    const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
    const primaryTextColor = (yiq >= 128) ? '#000000' : '#ffffff';

    const cardColor = theme.card || (theme.isDark ? `rgba(255, 255, 255, 0.07)` : `#ffffff`);
    const headerColor = theme.header || (theme.isDark ? `${theme.bg}cc` : `#ffffffcc`);
    const cellInactiveColor = theme.cellInactive || (theme.isDark ? 'rgba(255, 255, 255, 0.08)' : '#e5e7eb');
    
    // Logic to handle custom completed cell color
    const completedColor = theme.completedBg ? theme.completedBg : `${theme.primary}20`;
    const darkCompletedColor = theme.completedBg ? theme.completedBg : `${theme.primary}30`;

    styleEl.innerHTML = `
      :root {
        --color-primary: ${theme.primary};
        --color-primary-text: ${primaryTextColor};
        --color-primary-shadow: ${theme.primary}50;
        --color-bg: ${theme.bg};
        --color-text: ${theme.text};
        --color-text-muted: ${theme.isDark ? '#a0a0a0' : '#6b7280'};
        --color-card: ${cardColor};
        --color-header: ${headerColor};
        --color-border: ${theme.isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'};
        --color-hover: ${theme.isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)'};
        --color-cell-inactive: ${cellInactiveColor};
      }
      .day-completed { background-color: ${completedColor} !important; }
      .dark .day-completed { background-color: ${darkCompletedColor} !important; }
    `;
}
    // --- RENDER FUNCTIONS ---
// REPLACE your existing fullRender function
function fullRender() {
    applyActiveTheme();
    renderHeader();
    renderSettingsMenu(); // This call is added
    renderCategoryMenu();
    renderMobileMenu();
    renderGoals();
    initSortable();
    setupCellListeners();
    updateDarkModeToggleState();
    if (appState.editing) {
        setTimeout(() => initEditInput(appState.editing), 30);
    }
}
    function renderHeader() {
        const weekTitleText = formatWeekRange(appState.currentWeek);
        document.getElementById('weekTitle').innerText = weekTitleText;
        document.getElementById('weekTitleMobile').innerText = weekTitleText;

        const today = new Date();
        const formattedDate = today.toLocaleDateString('fa-IR', { weekday: 'long', month: 'long', day: 'numeric' });
        document.getElementById('todayBtn').innerText = `امروز: ${formattedDate}`;
        
        const weekDates = getWeekDates(appState.currentWeek);
        document.getElementById('weekdayRow').innerHTML = weekDates.map((d, i) => {
            const dayNumber = toFa(new Date(d).toLocaleDateString('fa-IR-u-nu-latn', { day: 'numeric' }));
            const dayName = WEEKDAY_NAMES_SHORT[i];
            let classes = "flex flex-col items-center justify-center p-2 rounded-lg transition-colors text-app-text-muted";
            if (isToday(d)) {
                classes = "flex flex-col items-center justify-center p-2 rounded-lg transition-colors bg-primary text-primary-text font-bold shadow-lg";
            }
            return `<div class="${classes}" data-day="${i}"><span class="text-sm font-semibold">${dayName}</span><span class="text-xs mt-1">${dayNumber}</span></div>`;
        }).join('');
    }
    function renderCategoryMenu() {
        const menu = document.getElementById('categoryMenu');
        const filters = ['all', ...Object.keys(CATEGORIES)];
        const catButton = document.getElementById('categoryMenuBtn');
        if(appState.activeCategory !== 'all') { catButton.classList.add('text-primary'); }
        else { catButton.classList.remove('text-primary'); }
                
        let html = filters.map(cat => {
            const isActive = appState.activeCategory === cat;
            const activeClass = 'bg-app-hover font-bold text-primary';
            return `<button data-category="${cat}" class="w-full text-left flex items-center gap-3 p-3 hover:bg-app-hover rounded-lg transition-colors ${isActive ? activeClass : ''}">${cat === 'all' ? 'همه دسته‌بندی‌ها' : cat}</button>`;
        }).join('');
        menu.innerHTML = html;
    }
function renderMobileMenu() {
    const content = document.getElementById('mobileMenuContent');
    const today = new Date();
    const formattedDate = today.toLocaleDateString('fa-IR', { weekday: 'long', month: 'long', day: 'numeric' });
    const weekTitleText = formatWeekRange(appState.currentWeek);

    const filters = ['all', ...Object.keys(CATEGORIES)];
    const catHtml = filters.map(cat => {
        const isActive = appState.activeCategory === cat;
        return `<a href="#" data-category="${cat}" class="mobile-menu-item menu-item-fade-in ${isActive ? 'active' : ''}">
                    <span class="w-2.5 h-2.5 rounded-full ${cat === 'all' ? 'bg-primary' : CATEGORIES[cat]?.split(' ')[0]}"></span>
                    <span>${cat === 'all' ? 'همه دسته‌بندی‌ها' : cat}</span>
                </a>`;
    }).join('');

    const showArchived = appState.showArchived;
    const isDark = findThemeById(appState.activeThemeId).isDark;
    const isRandom = appState.randomThemeMode;

    content.innerHTML = `
        <div class="flex-shrink-0 flex justify-between items-center p-4">
            <div class="flex items-center gap-3">
                <img src="https://i.postimg.cc/4xvMK8zQ/rooza-app-logo-final.png" alt="Rooza Logo" class="w-10 h-10 flex-shrink-0"/>
                <div>
                    <h2 class="text-xl font-bold text-primary">روزا : مدیریت هدف و عادت</h2>
                    <p class="text-sm font-semibold text-app-text-muted mt-1">${formattedDate}</p>
                </div>
            </div>
            <button id="closeMobileMenuBtn" class="p-2 hover:bg-app-hover rounded-full transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <div class="flex-grow overflow-y-auto p-4 space-y-5">
            
            <div class="menu-item-fade-in">
                <div class="menu-section-title" style="margin-top: 0; padding-left: 0.25rem;">ناوبری</div>
                <div class="bg-app-card/50 p-3 rounded-xl">
                    <div class="text-center font-bold text-base text-primary mb-3">${weekTitleText}</div>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="mobile-nextWeekBtn" class="flex items-center justify-center gap-2 p-2 bg-app-hover rounded-lg transition-colors font-semibold text-sm">
                            <span>هفته بعد</span>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                        </button>
                        <button id="mobile-prevWeekBtn" class="flex items-center justify-center gap-2 p-2 bg-app-hover rounded-lg transition-colors font-semibold text-sm">
                             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                             <span>هفته قبل</span>
                        </button>
                    </div>
                </div>
                <a href="#" id="mobile-todayBtn" class="mobile-menu-item w-full mt-2 bg-app-card/50">
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                    <span>رفتن به امروز</span>
                </a>
            </div>
            
            <div class="menu-item-fade-in">
                <div class="menu-section-title" style="padding-left: 0.25rem;">گزارش‌ها</div>
                <div class="bg-app-card/50 rounded-xl">
                    <a href="#" id="mobile-report-day" class="mobile-menu-item">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        <span>گزارش روزانه</span>
                    </a>
                    <a href="#" id="mobile-report-week" class="mobile-menu-item">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2m8-10v10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2z" /></svg>
                        <span>گزارش هفتگی</span>
                    </a>
                    <a href="#" id="mobile-report-month" class="mobile-menu-item">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6z" /></svg>
                        <span>گزارش ماهانه</span>
                    </a>
                    <a href="#" id="mobile-report-year" class="mobile-menu-item">
                         <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                        <span>گزارش سالانه</span>
                    </a>
                </div>
            </div>

            <div class="menu-item-fade-in">
                <div class="menu-section-title" style="padding-left: 0.25rem;">دسته‌بندی‌ها</div>
                <div class="bg-app-card/50 rounded-xl">
                    ${catHtml}
                </div>
            </div>

            <div class="menu-item-fade-in">
                <div class="menu-section-title" style="padding-left: 0.25rem;">تنظیمات و برنامه</div>
                <div class="bg-app-card/50 rounded-xl">
                    <a href="#" id="mobile-archiveToggleBtn" class="mobile-menu-item ${showArchived ? 'text-primary' : ''}">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                        <span>نمایش آرشیو</span>
                    </a>
                    <a href="#" id="mobile-themeSelectorBtn" class="mobile-menu-item">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" /></svg>
                        <span>انتخاب تم</span>
                    </a>
                    <div class="mobile-menu-item">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.783-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>
                        <span>تم تصادفی</span>
                        <label for="randomThemeToggleMobile" class="relative inline-flex items-center cursor-pointer mr-auto">
                            <input type="checkbox" value="" id="randomThemeToggleMobile" class="sr-only peer" ${isRandom ? 'checked' : ''}>
                            <div class="w-11 h-6 bg-app-cell-inactive rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                        </label>
                    </div>
                    <div class="mobile-menu-item">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                        <span>حالت تیره</span>
                        <label for="darkModeToggleMobile" class="relative inline-flex items-center cursor-pointer mr-auto">
                            <input type="checkbox" value="" id="darkModeToggleMobile" class="sr-only peer" ${isDark ? 'checked' : ''}>
                            <div class="w-11 h-6 bg-app-cell-inactive rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                        </label>
                    </div>
                    <a href="#" id="mobile-backupBtn" class="mobile-menu-item">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                        <span>پشتیبان‌گیری و بازیابی</span>
                    </a>
                    <a href="#" id="mobile-aboutBtn" class="mobile-menu-item">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <span>درباره</span>
                    </a>
                </div>
            </div>
        </div>
    `;
}
    function renderGoals() {
        const filteredGoals = appState.order
            .map(id => appState.goals.find(g => g.id === id))
            .filter(Boolean)
            .filter(g => !g.archived && (appState.activeCategory === 'all' || g.category === appState.activeCategory));
        const archivedGoals = appState.goals.filter(g => g && g.archived);
        document.getElementById('goalList').innerHTML = filteredGoals.map(renderSingleGoalCard).join('');
        const archivedContainer = document.getElementById('archivedGoalList');
        if (appState.showArchived && archivedGoals.length > 0) {
            archivedContainer.classList.remove('hidden');
            archivedContainer.querySelector('.flex').innerHTML = archivedGoals.map(renderSingleGoalCard).join('');
        } else {
            archivedContainer.classList.add('hidden');
        }
    }
  function renderSingleGoalCard(goal) {
    const weekDates = getWeekDates(appState.currentWeek);
    const currentWeekId = weekIdForDate(appState.currentWeek);
    const { weekly, allTime } = calculateScores(goal);
    const streak = calculateStreak(goal);

    const dayCellsHtml = weekDates.map((date, i) => {
        const weekDayIndexForData = (i + 6) % 7;
        const isActive = !!goal.days[weekDayIndexForData];
        const dayData = goal.history?.[currentWeekId]?.[weekDayIndexForData] || { entries: [], note: '' };
        const dayCompleted = dayData.entries.length > 0;
        const baseClasses = "goal-day group aspect-square rounded-full flex items-center justify-center relative transition-colors cursor-pointer";
        const activeClasses = "active bg-app-cell-inactive hover:opacity-80";
        const disabledClasses = "bg-app-bg opacity-60 !cursor-not-allowed";
        let classes = `${baseClasses} ${isActive ? activeClasses : disabledClasses}`;
        if(dayCompleted) classes += ' day-completed';
        if (isActive && isToday(date)) classes += ` ring-2 ring-sky-500 shadow-md shadow-sky-500/30`;

        let cellContent = generateDayCellContent(dayData);

        return `<div class="${classes}" data-goal-id="${goal.id}" data-day-index="${weekDayIndexForData}" tabindex="0">${cellContent}${dayData.note ? `<div class="absolute top-0 right-0 w-2 h-2 bg-amber-400 rounded-full" title="${escapeHtml(dayData.note)}"></div>` : ''}</div>`;
    }).join('');

    const statsHtml = `
        <div class="goal-stats-container flex items-center gap-x-2 md:gap-x-3 text-xs font-medium text-app-text-muted whitespace-nowrap">
            <span class="flex items-center gap-1" title="کل"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg><span>${toFa(allTime)}</span></span>
            <span class="flex items-center gap-1" title="استریک"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg><span>${toFa(streak)}</span></span>
            <span class="flex items-center gap-1" title="هفته"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg><span>${toFa(weekly)}</span></span>
        </div>
    `;

    return `<div class="goal-card bg-app-card shadow-md rounded-2xl p-4 goal-anim-in ${goal.archived ? 'opacity-60' : ''}" data-id="${goal.id}">
        <div class="flex items-center gap-3 mb-4">
            <div class="emoji-container text-2xl md:text-3xl">${goal.emoji || '🎯'}</div>
            <div class="flex-grow min-w-0">
                ${appState.editing === goal.id
                    // **** CHANGE MADE ON THIS LINE ****
                    ? `<input class="w-full bg-app-cell-inactive text-base md:text-lg font-bold p-2 rounded-lg outline-none focus:ring-2 focus:ring-primary" id="edit-${goal.id}" name="goal_name_${goal.id}" autocomplete="one-time-code" value="${escapeHtml(goal.name)}" />`
                    : `<h3 class="text-base md:text-lg font-bold truncate cursor-pointer hover:text-primary" onclick="showGoalHeatmapModal('${goal.id}')">${escapeHtml(goal.name || 'بی‌نام')}</h3>`
                }
            </div>
            <div class="flex-shrink-0 flex items-center gap-2 md:gap-3 ml-auto">
                ${statsHtml}
                <button onclick="showContextMenu(event, '${goal.id}')" class="text-app-text-muted hover:bg-app-hover rounded-full p-2 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" /></svg>
                </button>
                ${!goal.archived ? `<div class="goal-handle text-app-text-muted cursor-grab p-2 text-xl">&#x2630;</div>`: ''}
            </div>
        </div>
        <div class="grid grid-cols-7 gap-2">${dayCellsHtml}</div>
    </div>`;
}
    // --- CALCULATIONS ---
   function getHistoricalDayInfo(goal, targetDate) {
    const d = new Date(targetDate);
    d.setHours(0, 0, 0, 0);
    const dayIndex = d.getDay();

    const startOfWeekDate = getStartOfWeek(d);
    // Use the exact same reliable YYYY-MM-DD format for reading
    const month = (startOfWeekDate.getMonth() + 1).toString().padStart(2, '0');
    const day = startOfWeekDate.getDate().toString().padStart(2, '0');
    const weekId = `${startOfWeekDate.getFullYear()}-${month}-${day}`;

    const dayData = goal.history?.[weekId]?.[dayIndex];
    const entryCount = dayData?.entries?.length || 0;
    
    return { dayIndex, entryCount };
}
    function getEntryCountOnDate(goal, date) { return getHistoricalDayInfo(goal, date).entryCount; }
function calculateStreak(goal) {
    let streak = 0;
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const isScheduledToday = goal.days[today.getDay()];
    const isCompleteToday = getEntryCountOnDate(goal, today) > 0;

    let dateToCheck = new Date(today);

    if (isScheduledToday && !isCompleteToday) {
        // If scheduled for today but not done, the current streak is 0.
        return 0;
    }
    
    if (!isScheduledToday) {
        // If not scheduled for today, start counting from yesterday.
        dateToCheck.setDate(dateToCheck.getDate() - 1);
    }
    // If it was scheduled and completed today, the count will start from today.
//بخق 5 غثشقس :for (let i = 0; i < 365 * 5; i++) 
    for (let i = 0; i < 366; i++) {
        const dayOfWeek = dateToCheck.getDay();
        const isScheduled = goal.days[dayOfWeek];
        
        if (isScheduled) {
            const isComplete = getEntryCountOnDate(goal, dateToCheck) > 0;
            if (isComplete) {
                streak++;
            } else {
                // If it was scheduled but not complete, the streak is broken.
                break;
            }
        }
        // If not scheduled for a given day, we ignore it and continue the streak.
        
        dateToCheck.setDate(dateToCheck.getDate() - 1);
    }
    
    return streak;
}
function calculateScores(goal) {
    let weekly = 0;
    let allTime = 0;
    const currentWeekId = weekIdForDate(appState.currentWeek);

    if (goal.history) {
        for (const weekId in goal.history) {
            const weekData = goal.history[weekId];
            if (!weekData) continue;

            weekData.forEach((dayData) => {
                if (dayData && dayData.entries) {
                    const entryCount = dayData.entries.length;
                    // اضافه کردن به شمارشگر کل
                    allTime += entryCount;
                    // محاسبه آمار هفتگی فقط برای هفته جاری
                    if (weekId === currentWeekId) {
                        weekly += entryCount;
                    }
                }
            });
        }
    }
    return { weekly, allTime };
}
    // --- MODALS & MENUS ---
    function closeModal() { const modalArea=document.getElementById('modalArea'); if (modalArea.lastElementChild) { modalArea.removeChild(modalArea.lastElementChild); } }
    function closeContextMenu() { const menu=document.getElementById('contextMenu'); menu.style.display='none'; appState.contextMenuGoalId=null; }
    function toggleSettingsMenu(visible) { const menu=document.getElementById('settingsMenu'); menu.classList.toggle('visible',visible); if(visible){setTimeout(()=>document.addEventListener('click',closeSettingsMenuOnClickOutside,{once:true}),10);} }
    function closeSettingsMenuOnClickOutside(e) { if (!e.target.closest('#settingsMenu') && !e.target.closest('#settingsMenuBtn') && !e.target.closest('#settingsMenuBtnMobile')) { toggleSettingsMenu(false); } else { document.addEventListener('click', closeSettingsMenuOnClickOutside, { once: true }); } }
    function toggleCategoryMenu(visible) { const menu=document.getElementById('categoryMenu'); menu.classList.toggle('visible',visible); if(visible){setTimeout(()=>document.addEventListener('click',closeCategoryMenuOnClickOutside,{once:true}),10);} }
    function closeCategoryMenuOnClickOutside(e) { if (!e.target.closest('#categoryMenu') && !e.target.closest('#categoryMenuBtn')) { toggleCategoryMenu(false); } else { document.addEventListener('click', closeCategoryMenuOnClickOutside, { once: true }); } }
    
// REPLACE THIS FUNCTION
const themeCategoryMap = {
    'new': 'جدید',
    'modernDark': 'مدرن تیره',
    'classicDark': 'کلاسیک تیره',
    'modernLight': 'مدرن روشن',
    'classicLight': 'کلاسیک روشن',
    'favorites': 'مورد علاقه ها'
};

function findThemeCategoryInfo(themeId) {
    // This function now cleanly finds the original category of a theme.
    for (const categoryKey in themesData) {
        if (categoryKey === 'favorites') continue; // Skip the virtual 'favorites' category

        if (themesData[categoryKey].some(t => t.id === themeId)) {
            return { key: categoryKey, title: themeCategoryMap[categoryKey] || categoryKey };
        }
    }
    return null; // Return null if not found in any real category
}


function showThemeSelectorModal(options = {}) {
    const { scrollPosition = 0, activeTab: initialActiveTab } = options;
    closeModal();
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4';

    const themeCategories = [
        { key: 'favorites', title: 'مورد علاقه ها' },
        { key: 'new', title: 'جدید' },
        { key: 'modernDark', title: 'مدرن تیره' },
        { key: 'classicDark', title: 'کلاسیک تیره' },
        { key: 'modernLight', title: 'مدرن روشن' },
        { key: 'classicLight', title: 'کلاسیک روشن' }
    ];
    
    const activeTheme = findThemeById(appState.activeThemeId);
    const activeThemeCatInfo = findThemeCategoryInfo(appState.activeThemeId);
    const categoryDisplay = activeThemeCatInfo ? `<span class="text-sm font-normal text-app-text-muted ml-2">(${activeThemeCatInfo.title})</span>` : '';
    const isCurrentThemeFavorite = appState.favoriteThemes.includes(appState.activeThemeId);
    let activeTabKey = initialActiveTab || (findThemeCategoryInfo(appState.activeThemeId)?.key) || 'favorites';


    const renderThemes = (themes) => {
        if (!themes || themes.length === 0) {
            return `<div class="col-span-1 sm:col-span-2 text-center text-app-text-muted p-8">برای افزودن، ستاره ⭐ کنار هر تم را لمس کنید.</div>`;
        }
        return themes.map(theme => {
            const isActive = theme.id === appState.activeThemeId;
            const isFavorite = appState.favoriteThemes.includes(theme.id);
            return `
                <div class="theme-btn-wrapper flex items-center rounded-lg transition-colors ${isActive ? 'bg-primary/20 ring-2 ring-primary' : 'hover:bg-app-hover'}">
                    <button data-theme-id="${theme.id}" class="theme-select-btn flex-grow text-right p-3 flex items-center gap-4">
                        <div class="flex-shrink-0 h-10 w-10 rounded-full flex items-center justify-center" style="background-color:${theme.bg}; border: 2px solid ${theme.primary};">
                            <div class="w-4 h-4 rounded-full" style="background-color: ${theme.text}"></div>
                        </div>
                        <span class="font-semibold">${theme.name}</span>
                        ${isActive ? '<span class="selected-checkmark ml-auto text-primary font-bold">✓</span>' : ''}
                    </button>
                    <button class="favorite-star-btn p-3 text-2xl text-amber-400 hover:opacity-75 transition-opacity" data-theme-id="${theme.id}">
                        ${isFavorite ? '★' : '☆'}
                    </button>
                </div>
            `;
        }).join('');
    }

    const favoriteThemesData = appState.favoriteThemes.map(id => findThemeById(id)).filter(Boolean);

    const tabContentsHtml = themeCategories.map((cat) => {
        const themes = cat.key === 'favorites' ? favoriteThemesData : (themesData[cat.key] || []);
        return `<div id="tab-content-${cat.key}" class="tab-content grid grid-cols-1 sm:grid-cols-2 gap-2 ${cat.key !== activeTabKey ? 'hidden' : ''}">${renderThemes(themes)}</div>`;
    }).join('');

    modal.innerHTML = `
        <div class="modal-content glass-modal-content rounded-2xl p-4 sm:p-6 w-full max-w-4xl max-h-[90vh] flex flex-col shadow-2xl" dir="rtl">
      <div class="flex-shrink-0 flex justify-between items-center mb-4">
    <h2 class="text-xl sm:text-2xl font-bold text-app-text flex items-baseline gap-2" id="theme-modal-title">
        <span class="text-primary">${escapeHtml(activeTheme.name)}</span> ${categoryDisplay}
    </h2>
    <div class="flex items-center gap-4">
        ${!isCurrentThemeFavorite ? `
            <button id="addCurrentThemeToFavoritesBtn" class="flex items-center gap-2 text-amber-400 hover:opacity-80 transition-opacity font-semibold p-2 rounded-lg hover:bg-app-hover">
                <span class="text-sm hidden sm:inline">افزودن به علاقه‌مندی‌ها</span>
                <span class="text-2xl leading-none">★</span>
            </button>
        ` : ''}
        <button class="close-modal-btn text-app-text-muted hover:bg-app-hover rounded-full p-2 transition-colors">&times;</button>
    </div>
</div>
             <div class="flex-shrink-0 mb-4">
                 <input type="search" id="themeSearchInput" placeholder="جستجوی ترکیبی (مثال: کلاسیک روشن)" class="w-full p-3 bg-app-card rounded-lg border border-app-border focus:ring-2 focus:ring-primary outline-none transition text-right">
            </div>
            <div id="theme-modal-tabs" class="flex-shrink-0 flex flex-wrap items-center gap-2 p-1 mb-4 bg-app-card rounded-xl">
                ${themeCategories.map(c => `<button data-tab="${c.key}" class="tab-btn flex-1 p-3 font-semibold text-sm rounded-lg transition-colors ${c.key === activeTabKey ? 'bg-primary text-primary-text' : 'text-app-text-muted hover:bg-app-hover'}">${c.title}</button>`).join('')}
            </div>
            <div id="theme-scroll-container" class="flex-grow overflow-y-auto space-y-3 p-1 -mr-2 pr-2">
                ${tabContentsHtml}
            </div>
        </div>`;

    document.getElementById('modalArea').appendChild(modal);
    
    const scrollContainer = document.getElementById('theme-scroll-container');
    if (scrollContainer) scrollContainer.scrollTop = scrollPosition;
    


    modal.querySelectorAll('.tab-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            const tabId = e.currentTarget.dataset.tab;
            modal.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-primary', 'text-primary-text');
                btn.classList.add('text-app-text-muted', 'hover:bg-app-hover');
            });
            e.currentTarget.classList.add('bg-primary', 'text-primary-text');
            e.currentTarget.classList.remove('text-app-text-muted', 'hover:bg-app-hover');
            modal.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            modal.querySelector(`#tab-content-${tabId}`).classList.remove('hidden');

            const searchInput = document.getElementById('themeSearchInput');
            if(searchInput) {
                 searchInput.value = '';
                 searchInput.dispatchEvent(new Event('input'));
            }
        });
    });

   const searchInput = document.getElementById('themeSearchInput');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase().trim();
            const keywords = searchTerm.split(' ').filter(k => k);
            const scrollContainer = document.getElementById('theme-scroll-container');
            const allTabContents = scrollContainer.querySelectorAll('.tab-content');
            const activeTabButton = document.querySelector('#theme-modal-tabs .tab-btn.bg-primary');
            
            // If there is a search term, perform a global search
            if (searchTerm) {
                allTabContents.forEach(tab => tab.classList.add('hidden'));

                // Get all themes from all categories, excluding favorites as it's a derived list
                const allThemes = Object.keys(themesData)
                    .filter(key => key !== 'favorites') // Avoid duplication
                    .flatMap(key => themesData[key]);
                
                const filteredThemes = allThemes.filter(theme => {
                    const categoryInfo = findThemeCategoryInfo(theme.id);
                    const searchableString = `
                        ${theme.name.toLowerCase()} 
                        ${theme.isDark ? 'تیره' : 'روشن'} 
                        ${categoryInfo ? categoryInfo.title.toLowerCase() : ''}
                    `.replace(/\s+/g, ' ');
                    return keywords.every(keyword => searchableString.includes(keyword));
                });
                
                let searchResultsContainer = document.getElementById('search-results-content');
                if (!searchResultsContainer) {
                    searchResultsContainer = document.createElement('div');
                    searchResultsContainer.id = 'search-results-content';
                    searchResultsContainer.className = 'grid grid-cols-1 sm:grid-cols-2 gap-2';
                    scrollContainer.appendChild(searchResultsContainer);
                }
                
                searchResultsContainer.innerHTML = renderThemes(filteredThemes);
                if (filteredThemes.length === 0) {
                    searchResultsContainer.innerHTML = `<div class="col-span-1 sm:col-span-2 text-center text-app-text-muted p-8">هیچ تمی با عبارت «${escapeHtml(searchTerm)}» یافت نشد.</div>`;
                }
                searchResultsContainer.classList.remove('hidden');

            } else {
                // If search is cleared, hide search results and show the active tab
                let searchResultsContainer = document.getElementById('search-results-content');
                if (searchResultsContainer) {
                    searchResultsContainer.classList.add('hidden');
                }
                const activeTabKey = activeTabButton ? activeTabButton.dataset.tab : 'favorites';
                const activeTabContent = document.getElementById(`tab-content-${activeTabKey}`);
                if (activeTabContent) {
                    activeTabContent.classList.remove('hidden');
                }
            }
        });
    }

 // =================== PASTE THIS NEW CODE BLOCK ===================
    // Add a single delegated event listener to the modal
    modal.addEventListener('click', (e) => {
        const scrollContainer = document.getElementById('theme-scroll-container');
        const currentScroll = scrollContainer ? scrollContainer.scrollTop : 0;
        const currentTab = modal.querySelector('.tab-btn.bg-primary')?.dataset.tab;

        // 1. Handle Theme Selection (checks if a theme button was clicked)
        const themeSelectBtn = e.target.closest('.theme-select-btn');
        if (themeSelectBtn) {
            const newThemeId = themeSelectBtn.dataset.themeId;
            if (newThemeId !== appState.activeThemeId) {
                setActiveTheme(newThemeId);
                // Re-open the modal to reflect the change everywhere
                showThemeSelectorModal({ scrollPosition: currentScroll, activeTab: currentTab });
            }
            return; // Action handled, no need to continue
        }

        // 2. Handle Favorite Toggling (checks if a star button was clicked)
        const favoriteStarBtn = e.target.closest('.favorite-star-btn');
        if (favoriteStarBtn) {
            e.stopPropagation(); // Prevents the theme selection from also firing
            const themeId = favoriteStarBtn.dataset.themeId;
            const isFavorite = appState.favoriteThemes.includes(themeId);

            if (isFavorite) {
                removeFavoriteTheme(themeId);
            } else {
                addFavoriteTheme(themeId);
            }
            
            // Re-open the modal to show the star's change and update favorites tab
            showThemeSelectorModal({ scrollPosition: currentScroll, activeTab: currentTab });
            return; // Action handled, no need to continue
        }
        
        // 3. Handle Modal Close (checks if the background or close button was clicked)
        if (e.target === modal || e.target.closest('.close-modal-btn')) {
            closeModal();
        }
    });
// =================== END OF NEW CODE BLOCK ===================

  
// این بلوک کد را به انتهای تابع اضافه کنید
    const addToFavoritesBtn = modal.querySelector('#addCurrentThemeToFavoritesBtn');
    if (addToFavoritesBtn) {
        addToFavoritesBtn.addEventListener('click', () => {
            // تم فعلی را به لیست علاقه‌مندی‌ها اضافه می‌کند
            addFavoriteTheme(appState.activeThemeId);
            
            // مودال را برای نمایش تغییرات (مخفی شدن دکمه) مجدداً باز می‌کند
            const currentScroll = scrollContainer ? scrollContainer.scrollTop : 0;
            const currentTab = modal.querySelector('.tab-btn.bg-primary')?.dataset.tab;
            showThemeSelectorModal({ scrollPosition: currentScroll, activeTab: currentTab });
        });
    }


}
    function showAboutModal() { const modal=document.createElement('div');modal.className='fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4';modal.innerHTML=`<div class="modal-content glass-modal-content rounded-2xl p-6 w-full max-w-md shadow-2xl"><div class="flex flex-col items-center text-center"><div class="w-24 h-24 bg-app-card rounded-3xl flex items-center justify-center mb-5 border border-app-border shadow-md"><img src="https://i.postimg.cc/4xvMK8zQ/rooza-app-logo-final.png" alt="Rooza Logo" class="w-16 h-16"/></div><h2 class="text-2xl font-bold mb-2 text-app-text">روزا (Rooza)</h2><p class="text-base text-app-text-muted mb-6">اپلیکیشن مدیریت عادت و هدف شخصی</p><div class="text-sm text-app-text-muted space-y-2"><p>نسخه 0.14-ltr</p><p>ساخته شده برای کمک به شما در ساختن عادات بهتر.</p><p>کپی رایت 1404 © کدنویسی شده توسط پیمان عابدین پور ${new Date().getFullYear()} - Rooza</p></div><button class="close-modal-btn w-full mt-8 p-3 rounded-lg font-bold bg-primary text-primary-text hover:opacity-90 transition-all">بستن</button></div></div>`;document.getElementById('modalArea').appendChild(modal);modal.onclick=e=>{if(e.target===modal||e.target.closest('.close-modal-btn'))closeModal();};}
    function showBackupModal() { const modal=document.createElement('div');modal.className='fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4';modal.innerHTML=`<div class="modal-content glass-modal-content rounded-2xl p-6 w-full max-w-lg shadow-2xl max-h-[90vh] overflow-y-auto no-scrollbar"><div class="flex justify-between items-center mb-5"><h2 class="text-2xl font-bold text-app-text">پشتیبان‌گیری و بازیابی</h2><button class="close-modal-btn text-app-text-muted hover:bg-app-hover rounded-full p-2 transition-colors">&times;</button></div><div class="space-y-6"><div class="bg-app-card/50 p-5 rounded-xl border border-app-border"><div class="flex items-start gap-4"><div class="flex-shrink-0 w-12 h-12 rounded-full bg-green-500/10 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg></div><div><h3 class="font-bold text-lg text-app-text">خروجی گرفتن اطلاعات</h3><p class="text-sm text-app-text-muted mt-1 mb-4">یک فایل JSON از تمام اهداف و تاریخچه خود دانلود کنید.</p><button id="exportBtn" class="w-full sm:w-auto px-5 py-2.5 rounded-lg font-bold bg-green-600 text-white hover:bg-green-700 transition-colors">دانلود فایل پشتیبان</button></div></div></div><div class="bg-app-card/50 p-5 rounded-xl border border-app-border"><div class="flex items-start gap-4"><div class="flex-shrink-0 w-12 h-12 rounded-full bg-sky-500/10 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-sky-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg></div><div><h3 class="font-bold text-lg text-app-text">ورودی گرفتن اطلاعات</h3><p class="text-sm text-app-text-muted mt-1 mb-4">یک فایل پشتیبان JSON را برای بازیابی اطلاعات خود انتخاب کنید.</p><div class="p-3 mb-4 rounded-lg bg-amber-500/10 border border-amber-500/20 text-amber-600 dark:text-amber-400 text-sm"><strong>هشدار:</strong> این عمل تمام اطلاعات فعلی شما را بازنویسی خواهد کرد.</div><button id="importBtn" class="w-full sm:w-auto px-5 py-2.5 rounded-lg font-bold bg-sky-600 text-white hover:bg-sky-700 transition-colors">انتخاب فایل و بازیابی</button></div></div></div></div><input type="file" id="importFile" class="hidden" accept=".json"></div>`;document.getElementById('modalArea').appendChild(modal);modal.onclick=e=>{if(e.target===modal||e.target.closest('.close-modal-btn'))closeModal();};modal.querySelector('#exportBtn').onclick=exportData;modal.querySelector('#importBtn').onclick=()=>document.getElementById('importFile').click();modal.querySelector('#importFile').onchange=importData;}
    function exportData(){try{const dataToExport={goals:appState.goals,order:appState.order,userLight:appState.userLight,userDark:appState.userDark};const dataStr=JSON.stringify(dataToExport,null,2);const dataBlob=new Blob([dataStr],{type:"application/json"});const url=URL.createObjectURL(dataBlob);const link=document.createElement('a');const today=new Date().toISOString().slice(0,10);link.download=`rooza-backup-${today}.json`;link.href=url;link.click();URL.revokeObjectURL(url);closeModal();}catch(error){console.error("Error exporting data:",error);alert("خطا در خروجی گرفتن اطلاعات.");}}
    function importData(event){const file=event.target.files[0];if(!file)return;if(!confirm("آیا مطمئن هستید؟ با وارد کردن اطلاعات جدید، تمام اطلاعات فعلی شما بازنویسی خواهد شد. این عمل غیرقابل بازگشت است.")){return;}const reader=new FileReader();reader.onload=(e)=>{try{const importedData=JSON.parse(e.target.result);if(importedData&&Array.isArray(importedData.goals)&&Array.isArray(importedData.order)){appState.goals=importedData.goals;appState.order=importedData.order;if(importedData.userLight) appState.userLight = importedData.userLight;if(importedData.userDark) appState.userDark = importedData.userDark;persistState();loadStateFromStorage();fullRender();closeModal();alert("اطلاعات با موفقیت وارد شد.");}else{throw new Error("Invalid file format.");}}catch(error){console.error("Error importing data:",error);alert("خطا در وارد کردن اطلاعات. فایل انتخاب شده معتبر نیست.");}};reader.readAsText(file);}
    // --- ACTIONS & LISTENERS ---
    window.editGoal = (goalId) => { const goal = appState.goals.find(g => g.id === goalId); if(goal) showGoalModal(goal); };
    window.startEdit = (goalId) => { appState.editing = goalId; fullRender(); };
    function handleDarkModeToggle() {
        const currentTheme = findThemeById(appState.activeThemeId);
        if (currentTheme.isDark) {
            setActiveTheme(appState.userLight, true);
        } else {
            setActiveTheme(appState.userDark, true);
        }
        fullRender();
    }
    function updateDarkModeToggleState() {
        const isDark = findThemeById(appState.activeThemeId).isDark;
        const desktopToggle = document.getElementById('darkModeToggle');
        const mobileToggle = document.getElementById('darkModeToggleMobile');
        if (desktopToggle) desktopToggle.checked = isDark;
        if (mobileToggle) mobileToggle.checked = isDark;
    }
   // REPLACE your existing setupGlobalListeners function
function setupGlobalListeners() {
    const mobileMenu = document.getElementById('mobileMenu');

    // --- Menu Opening/Closing Logic ---
    const openMenu = () => {
        document.body.classList.add('mobile-menu-open');
        mobileMenu.classList.remove('translate-x-full');
        
        // Staggering animation for menu items
        const items = mobileMenu.querySelectorAll('.menu-item-fade-in');
        items.forEach((item, index) => {
            item.style.animationDelay = `${index * 0.04}s`;
        });
    };

    const closeMenu = () => {
        document.body.classList.remove('mobile-menu-open');
        mobileMenu.classList.add('translate-x-full');
    };

    document.getElementById('hamburgerBtn').onclick = openMenu;

    // --- Listeners for Desktop Navbar ---
    document.getElementById('navbar').onclick = e => {
        const target = e.target.closest('button');
        if (!target) return;
        switch (target.id) {
            case 'prevWeekBtn': appState.currentWeek.setDate(appState.currentWeek.getDate() - 7); fullRender(); break;
            case 'nextWeekBtn': appState.currentWeek.setDate(appState.currentWeek.getDate() + 7); fullRender(); break;
            case 'settingsMenuBtn': toggleSettingsMenu(!document.getElementById('settingsMenu').classList.contains('visible')); break;
            case 'categoryMenuBtn': toggleCategoryMenu(!document.getElementById('categoryMenu').classList.contains('visible')); break;
            case 'todayBtn': appState.currentWeek = getStartOfWeek(new Date()); fullRender(); break;
            case 'mobileReportsBtn': showReportModal(); break;
        }
    };

    // --- Listeners for Desktop Settings Dropdown ---
    document.getElementById('settingsMenu').addEventListener('click', e => {
        const button = e.target.closest('button');
        if (!button) return;
        switch (button.id) {
            case 'reportBtn': showReportModal(); break;
            case 'archiveToggleBtn': appState.showArchived = !appState.showArchived; button.classList.toggle('text-primary', appState.showArchived); fullRender(); break;
            case 'themeSelectorBtn': showThemeSelectorModal(); break;
            case 'aboutBtn': showAboutModal(); break;
            case 'backupBtn': showBackupModal(); break;
        }
        if (button.id !== 'archiveToggleBtn') toggleSettingsMenu(false);
    });
    
    // --- FAB Listener ---
    document.getElementById('fab').onclick = () => showGoalModal(null);

    // --- Desktop Category Menu Listener ---
    document.getElementById('categoryMenu').addEventListener('click', e => {
        const button = e.target.closest('button[data-category]');
        if (button) {
            appState.activeCategory = button.dataset.category;
            toggleCategoryMenu(false);
            fullRender();
        }
    });

    // --- Mobile Menu Click Handler ---
    mobileMenu.addEventListener('click', e => {
        const target = e.target.closest('a, button');
        if (!target) return;
        
        e.preventDefault(); // Prevent default link behavior
        let shouldClose = true;

        switch (target.id) {
            case 'closeMobileMenuBtn': break;
            case 'mobile-todayBtn': appState.currentWeek = getStartOfWeek(new Date()); fullRender(); break;
            case 'mobile-prevWeekBtn': appState.currentWeek.setDate(appState.currentWeek.getDate() - 7); fullRender(); shouldClose = false; break;
            case 'mobile-nextWeekBtn': appState.currentWeek.setDate(appState.currentWeek.getDate() + 7); fullRender(); shouldClose = false; break;
            case 'mobile-report-day': showReportModal('day'); break;
            case 'mobile-report-week': showReportModal('week'); break;
            case 'mobile-report-month': showReportModal('month'); break;
            case 'mobile-report-year': showReportModal('overall'); break;
            case 'mobile-archiveToggleBtn': appState.showArchived = !appState.showArchived; fullRender(); shouldClose = false; break;
            case 'mobile-themeSelectorBtn': showThemeSelectorModal(); break;
            case 'mobile-backupBtn': showBackupModal(); break;
            case 'mobile-aboutBtn': showAboutModal(); break;
            default: if (!target.dataset.category) shouldClose = false; break;
        }

        if (target.dataset.category) {
            appState.activeCategory = target.dataset.category;
            fullRender();
        }

        if (shouldClose) {
            closeMenu();
        }
    });

    // --- Global Toggles Listener ---
    document.body.addEventListener('change', e => {
        if (e.target.id === 'darkModeToggle' || e.target.id === 'darkModeToggleMobile') {
            handleDarkModeToggle();
        }
        if (e.target.id === 'randomThemeToggle' || e.target.id === 'randomThemeToggleMobile') {
            appState.randomThemeMode = e.target.checked;
            persistState();
            renderSettingsMenu();
            renderMobileMenu();
        }
    });
}
    let sortable = null;
    loadStateFromStorage();
    fullRender();
    setupGlobalListeners();
    setupHeaderSwipe(); // <-- این خط را اضافه کنید
    // --- All other functions (deleteGoal, addCheckmark, showGoalModal etc.) are assumed to be here ---
    function initEditInput(goalId) { const el=document.getElementById('edit-'+goalId);if(!el)return;el.focus();el.select();const saveAndExit=()=>{if(appState.editing!==goalId)return;const goal=appState.goals.find(g=>g.id===goalId);if(goal)goal.name=el.value.trim()||'بی‌نام';persistState();appState.editing=null;fullRender();};el.onblur=saveAndExit;el.onkeydown=(e)=>{if(e.key==="Enter")el.blur();if(e.key==="Escape"){appState.editing=null;fullRender();}};}
    window.duplicateGoal=(goalId)=>{const originalGoal=appState.goals.find(g=>g.id===goalId);if(originalGoal){const newGoal=JSON.parse(JSON.stringify(originalGoal));newGoal.id=''+Date.now();newGoal.name=`${originalGoal.name} (کپی)`;newGoal.history={};newGoal.archived=false;appState.goals.push(newGoal);const originalIndex=appState.order.indexOf(goalId);appState.order.splice(originalIndex+1,0,newGoal.id);persistState();fullRender();}};
    window.toggleArchiveGoal=(goalId)=>{const goal=appState.goals.find(g=>g.id===goalId);if(goal){goal.archived=!goal.archived;persistState();fullRender();}};
    window.deleteGoal=(goalId)=>{const modal=document.createElement('div');modal.className='fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4';modal.innerHTML=`<div class="modal-content bg-app-card rounded-2xl p-5 w-full max-w-sm shadow-2xl text-center"><h3 class="font-bold text-lg mb-2">تایید حذف</h3><p class="text-sm text-app-text-muted mb-6">آیا از حذف این هدف مطمئن هستید؟ این عمل غیرقابل بازگشت است.</p><div class="grid grid-cols-2 gap-4"><button id="cancel-delete" class="p-3 rounded-lg font-bold bg-app-cell-inactive hover:opacity-80 transition">لغو</button><button id="confirm-delete" class="p-3 rounded-lg font-bold bg-red-500 text-white hover:bg-red-600 transition">حذف</button></div></div>`;document.getElementById('modalArea').appendChild(modal);modal.querySelector('#cancel-delete').onclick=closeModal;modal.querySelector('#confirm-delete').onclick=()=>{closeModal();const card=document.querySelector(`.goal-card[data-id="${goalId}"]`);if(card){card.classList.add('goal-anim-out');setTimeout(()=>{appState.goals=appState.goals.filter(g=>g.id!==goalId);appState.order=appState.order.filter(id=>id!==goalId);persistState();fullRender();},300);}else{appState.goals=appState.goals.filter(g=>g.id!==goalId);appState.order=appState.order.filter(id=>id!==goalId);persistState();fullRender();}};};
    function addCheckmark(goalId, dayIndex, cellElement) {
    const goal = appState.goals.find(g => g.id === goalId);
    if (!goal || !goal.days[dayIndex]) return;
    const weekId = weekIdForDate(appState.currentWeek);
    if (!goal.history) goal.history = {};
    if (!goal.history[weekId]) goal.history[weekId] = Array(7).fill(null).map(() => ({ entries: [], note: '' }));
    if (!goal.history[weekId][dayIndex]) goal.history[weekId][dayIndex] = { entries: [], note: '' };
    goal.history[weekId][dayIndex].entries.push(checkmarkSVG);
    persistState();
    const dayData = goal.history[weekId][dayIndex];
    
    // Re-render cell content using the new function
    const noteIndicatorHtml = dayData.note ? `<div class="absolute top-0 right-0 w-2 h-2 bg-amber-400 rounded-full" title="${escapeHtml(dayData.note)}"></div>` : '';
    cellElement.innerHTML = generateDayCellContent(dayData) + noteIndicatorHtml;

    cellElement.classList.add('day-completed');
    cellElement.classList.add('cell-swipe-up');
    cellElement.addEventListener('animationend', () => cellElement.classList.remove('cell-swipe-up'), { once: true });
    updateGoalCardStats(goalId);
}

function removeLastEmoji(goalId, dayIndex, cellElement) {
    const goal = appState.goals.find(g => g.id === goalId);
    if (!goal || !goal.days[dayIndex]) return;
    const weekId = weekIdForDate(appState.currentWeek);
    if (!goal.history?.[weekId]?.[dayIndex]?.entries.length > 0) return;
    goal.history[weekId][dayIndex].entries.pop();
    persistState();
    const dayData = goal.history[weekId][dayIndex];

    // Re-render cell content using the new function
    const noteIndicatorHtml = dayData.note ? `<div class="absolute top-0 right-0 w-2 h-2 bg-amber-400 rounded-full" title="${escapeHtml(dayData.note)}"></div>` : '';
    cellElement.innerHTML = generateDayCellContent(dayData) + noteIndicatorHtml;
    
    if (dayData.entries.length === 0) {
        cellElement.classList.remove('day-completed');
    }
    cellElement.classList.add('cell-shrink');
    cellElement.addEventListener('animationend', () => cellElement.classList.remove('cell-shrink'), { once: true });
    updateGoalCardStats(goalId);
}
    function removeLastEmoji(goalId, dayIndex, cellElement) {
    const goal = appState.goals.find(g => g.id === goalId);
    if (!goal || !goal.days[dayIndex]) return;
    const weekId = weekIdForDate(appState.currentWeek);
    if (!goal.history?.[weekId]?.[dayIndex]?.entries.length > 0) return;

    // Remove the last emoji from the data
    goal.history[weekId][dayIndex].entries.pop();
    persistState();

    const dayData = goal.history[weekId][dayIndex];

    // Re-render the cell's content using the NEW counting logic
    const noteIndicatorHtml = dayData.note ? `<div class="absolute top-0 right-0 w-2 h-2 bg-amber-400 rounded-full" title="${escapeHtml(dayData.note)}"></div>` : '';
    cellElement.innerHTML = generateDayCellContent(dayData) + noteIndicatorHtml;
    
    // If no entries are left, remove the completed background
    if (dayData.entries.length === 0) {
        cellElement.classList.remove('day-completed');
    }
    
    // Trigger the "shrink" animation
    cellElement.classList.add('cell-swipe-down');
    cellElement.addEventListener('animationend', () => cellElement.classList.remove('cell-swipe-down'), { once: true });
    
    // Update the total scores in the header
    updateGoalCardStats(goalId);
}

function setupCellListeners() {
    document.querySelectorAll('.goal-day').forEach(cell => {
        let pressTimer = null;
        let longPressTriggered = false;
        let startY = 0,
            startX = 0;
        let isDragging = false;
        let swipeTriggered = false;
        let hasMoved = false;

        const handlePressStart = (e) => {
            if (cell.classList.contains('!cursor-not-allowed')) return;
            startY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
            startX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
            isDragging = true;
            swipeTriggered = false;
            longPressTriggered = false;
            hasMoved = false;

            pressTimer = setTimeout(() => {
                longPressTriggered = true;
                isDragging = false;
                const {
                    goalId,
                    dayIndex
                } = cell.dataset;
                showDayDetailModal(goalId, parseInt(dayIndex));
                cleanupListeners();
            }, 500);

            document.addEventListener('mousemove', handlePressMove);
            document.addEventListener('touchmove', handlePressMove, {
                passive: false
            });
            document.addEventListener('mouseup', handlePressEnd, {
                once: true
            });
            document.addEventListener('touchend', handlePressEnd, {
                once: true
            });
        };

        const handlePressMove = (e) => {
            if (!isDragging || longPressTriggered || swipeTriggered) return;

            const currentY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
            const currentX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
            const deltaY = currentY - startY;
            const deltaX = currentX - startX;
            const SWIPE_THRESHOLD = 30;

            if (Math.abs(deltaY) > 10 || Math.abs(deltaX) > 10) {
                hasMoved = true;
                clearTimeout(pressTimer);
                if (Math.abs(deltaY) > Math.abs(deltaX)) {
                    e.preventDefault();
                }
            }

            if (Math.abs(deltaY) > SWIPE_THRESHOLD && Math.abs(deltaY) > Math.abs(deltaX)) {
                swipeTriggered = true;
                const {
                    goalId,
                    dayIndex
                } = cell.dataset;
                // Swipe down to add, swipe up to remove.
                if (deltaY > 0) {
                    addCheckmark(goalId, parseInt(dayIndex), cell);
                } else {
                    removeLastEmoji(goalId, parseInt(dayIndex), cell);
                }
                cleanupListeners();
            }
        };

        const handlePressEnd = () => {
            clearTimeout(pressTimer);
            if (isDragging && !longPressTriggered && !swipeTriggered && !hasMoved) {
                const {
                    goalId,
                    dayIndex
                } = cell.dataset;
                showLogModal(goalId, parseInt(dayIndex));
            }
            cleanupListeners();
        };

        const cleanupListeners = () => {
            isDragging = false;
            clearTimeout(pressTimer);
            document.removeEventListener('mousemove', handlePressMove);
            document.removeEventListener('touchmove', handlePressMove);
            document.removeEventListener('mouseup', handlePressEnd);
            document.removeEventListener('touchend', handlePressEnd);
        }

        cell.removeEventListener('mousedown', handlePressStart);
        cell.removeEventListener('touchstart', handlePressStart);
        cell.addEventListener('mousedown', handlePressStart);
        cell.addEventListener('touchstart', handlePressStart, {
            passive: false
        });
    });
}


    function initSortable(){if(sortable)sortable.destroy();const list=document.getElementById('goalList');if(!list)return;sortable=Sortable.create(list,{handle:'.goal-handle',animation:200,ghostClass:'sortable-ghost',onEnd:(evt)=>{appState.order=Array.from(evt.to.children).map(card=>card.dataset.id);persistState();}});}

    showGoalModal = (goal) => {
    const isEdit = !!goal;
    const draft = isEdit ? JSON.parse(JSON.stringify(goal)) : { id: '' + Date.now(), name: '', emoji: '🎯', days: Array(7).fill(true), history: {}, type: 'binary', archived: false, category: 'شخصی', creationDate: new Date().toISOString() };
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/30 backdrop-blur-sm z-[100] flex items-end justify-center';
    // **** CHANGES MADE ON THE NEXT TWO LINES ****
    modal.innerHTML = `<div class="modal-content bg-app-bg rounded-t-2xl p-4 w-full max-w-lg pb-[calc(env(safe-area-inset-bottom)+1rem)] shadow-2xl"><h2 class="text-xl font-bold text-center mb-6 text-primary">${isEdit?'ویرایش هدف':'هدف جدید'}</h2><div class="space-y-4"><div class="flex gap-4"><div class="flex-grow"><label for="goalName" class="font-semibold mb-2 block text-sm">نام هدف</label><input type="text" id="goalName" value="${escapeHtml(draft.name)}" placeholder="مثلا: ورزش روزانه" class="w-full p-3 bg-app-card rounded-lg border border-app-border focus:ring-2 focus:ring-primary outline-none transition" autocomplete="one-time-code"></div><div><label for="goalEmoji" class="font-semibold mb-2 block text-sm">ایموجی</label><input type="text" id="goalEmoji" value="${draft.emoji}" maxlength="2" class="w-20 text-center p-3 bg-app-card rounded-lg border border-app-border focus:ring-2 focus:ring-primary outline-none transition" autocomplete="one-time-code"></div></div><div><label class="font-semibold mb-2 block text-sm">دسته‌بندی</label><select id="goalCategory" class="w-full p-3 bg-app-card rounded-lg border border-app-border focus:ring-2 focus:ring-primary outline-none transition">${Object.keys(CATEGORIES).map(cat=>`<option value="${cat}" ${draft.category===cat?'selected':''}>${cat}</option>`).join('')}</select></div><div><label class="font-semibold mb-2 block text-sm">روزهای فعال</label><div class="grid grid-cols-7 gap-2 rounded-lg bg-app-cell-inactive p-1 weekday-toggle-row">${WEEKDAY_NAMES_SHORT.map((d, i) => {
        const dataIndex = (i + 6) % 7; // Convert visual index (Sat=0) to data index (Sun=0)
        return `<div class="weekday-toggle text-center font-bold p-2 rounded-md cursor-pointer transition-colors ${draft.days[dataIndex] ? 'bg-primary text-primary-text' : 'hover:bg-app-hover'}" data-day="${dataIndex}">${d}</div>`;
    }).join('')}</div></div></div><div class="grid grid-cols-2 gap-4 mt-8"><button class="action-btn-cancel w-full p-4 rounded-lg font-bold bg-app-cell-inactive hover:opacity-80 transition">لغو</button><button id="saveGoalBtn" class="w-full p-4 rounded-lg font-bold bg-primary text-primary-text hover:opacity-90 transition">${isEdit ? 'ذخیره' : 'افزودن'}</button></div></div>`;
    document.getElementById('modalArea').appendChild(modal);
    document.getElementById('goalName').focus();
    modal.onclick = e => { if (e.target === modal) closeModal(); };
    modal.querySelector('.action-btn-cancel').onclick = closeModal;
    modal.querySelectorAll('.weekday-toggle').forEach(toggle => {
        toggle.onclick = () => {
            const day = parseInt(toggle.dataset.day); // This is already the correct data index (Sun=0)
            draft.days[day] = !draft.days[day];
            toggle.classList.toggle('bg-primary');
            toggle.classList.toggle('text-primary-text');
        };
    });
    modal.querySelector('#saveGoalBtn').onclick = () => {
        draft.name = modal.querySelector('#goalName').value.trim();
        draft.emoji = modal.querySelector('#goalEmoji').value;
        draft.category = modal.querySelector('#goalCategory').value;
        draft.type = 'binary';
        if (isEdit) {
            const index = appState.goals.findIndex(g => g.id === goal.id);
            if (index > -1) appState.goals[index] = draft;
        } else {
            appState.goals.push(draft);
            appState.order.push(draft.id);
        }
        persistState();
        closeModal();
        fullRender();
    };
};

    showLogModal = (goalId,dayIndex)=>{const goal=appState.goals.find(g=>g.id===goalId);if(!goal||!goal.days[dayIndex])return;const weekId=weekIdForDate(appState.currentWeek);if(!goal.history)goal.history={};if(!goal.history[weekId])goal.history[weekId]=Array(7).fill(null).map(()=>({entries:[],note:''}));if(!goal.history[weekId][dayIndex])goal.history[weekId][dayIndex]={entries:[],note:''};const dayData=goal.history[weekId][dayIndex];const modal=document.createElement('div');modal.className='fixed inset-0 bg-black/30 backdrop-blur-sm z-[100] flex items-end justify-center';const renderEntriesInModal=(container)=>{const listHtml=dayData.entries.map((entry,i)=>{const content=entry.startsWith('<svg')?`<span class="w-6 h-6 inline-block">${entry}</span>`:escapeHtml(entry);return`<div class="flex items-center justify-between gap-1 bg-app-cell-inactive rounded-lg px-2 py-1 text-sm"><span>${content}</span><button data-index="${i}" class="delete-entry-btn text-red-500 hover:text-red-700 font-bold text-lg">&times;</button></div>`;}).join('');container.innerHTML=listHtml||`<span class="text-app-text-muted text-sm p-2">موردی ثبت نشده</span>`;};modal.innerHTML=`<div class="modal-content bg-app-bg rounded-t-2xl p-4 w-full max-w-lg pb-[calc(env(safe-area-inset-bottom)+1rem)] shadow-2xl"><h2 class="text-xl font-bold text-center mb-4 truncate">${goal.name}</h2><div class="space-y-4"><div><label class="font-semibold mb-2 block text-sm">موارد ثبت شده امروز</label><div id="entries-list" class="flex flex-wrap gap-2 min-h-[40px] bg-app-card p-2 rounded-lg border border-app-border"></div></div><div><label class="font-semibold mb-2 block text-sm">ثبت ایموجی</label><div class="emoji-grid grid grid-cols-7 gap-2 text-3xl">${EMOJIS.map(em=>{const content=em.startsWith('<svg')?`<span class="w-8 h-8 inline-block">${em}</span>`:escapeHtml(em);return`<button class="emoji-btn text-center rounded-lg p-2 hover:bg-app-hover transition-transform active:scale-125 focus:outline-none focus:ring-2 focus:ring-primary">${content}</button>`;}).join('')}</div></div><div><label for="note-input" class="font-semibold mb-2 block text-sm">یادداشت</label><textarea id="note-input" class="w-full p-3 bg-app-card rounded-lg border border-app-border focus:ring-2 focus:ring-primary outline-none transition" rows="2" placeholder="یادداشت امروز...">${escapeHtml(dayData.note)}</textarea></div></div><div class="mt-8"><button class="action-btn-done w-full p-4 rounded-lg font-bold bg-primary text-primary-text hover:opacity-90 transition">انجام شد</button></div></div>`;document.getElementById('modalArea').appendChild(modal);const entriesList=modal.querySelector('#entries-list');renderEntriesInModal(entriesList);const saveAndClose=()=>{goal.history[weekId][dayIndex].note=modal.querySelector('#note-input').value;persistState();fullRender();closeModal();};modal.onclick=e=>{if(e.target===modal)saveAndClose();};modal.querySelector('.action-btn-done').onclick=saveAndClose;const updateData=()=>{persistState();renderEntriesInModal(entriesList);updateGoalCardStats(goalId);};entriesList.addEventListener('click',e=>{if(e.target.classList.contains('delete-entry-btn')){const index=parseInt(e.target.dataset.index);dayData.entries.splice(index,1);updateData();}});modal.querySelectorAll('.emoji-btn').forEach((btn,index)=>{btn.onclick=()=>{dayData.entries.push(EMOJIS[index]);updateData();};});}
    showDayDetailModal = (goalId,dayIndex)=>{const goal=appState.goals.find(g=>g.id===goalId);if(!goal)return;const weekDates=getWeekDates(appState.currentWeek);const date=weekDates[dayIndex];const weekId=weekIdForDate(appState.currentWeek);const dayData=goal.history?.[weekId]?.[dayIndex]||{entries:[],note:''};const modal=document.createElement('div');modal.className='fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4';const formattedDate=date.toLocaleDateString('fa-IR',{weekday:'long',month:'long',day:'numeric'});const entriesHtml=dayData.entries.length>0?dayData.entries.map(entry=>{if(entry.startsWith('<svg')){return`<span class="inline-block align-middle w-8 h-8">${entry}</span>`;}return`<span class="text-2xl">${escapeHtml(entry)}</span>`;}).join(''):'<span class="text-sm text-app-text-muted">موردی ثبت نشده</span>';const noteHtml=dayData.note?`<p class="text-sm bg-amber-500/10 p-3 rounded-lg">${escapeHtml(dayData.note)}</p>`:'<span class="text-sm text-app-text-muted">یادداشتی وجود ندارد</span>';modal.innerHTML=`<div class="modal-content bg-app-card rounded-2xl p-5 w-full max-w-sm shadow-2xl"><h3 class="font-bold text-lg text-primary mb-2">${escapeHtml(goal.name)}</h3><p class="text-sm text-app-text-muted font-semibold mb-4">${formattedDate}</p><div class="space-y-4"><div><h4 class="font-semibold text-sm mb-2">موارد ثبت شده</h4><div class="flex flex-wrap gap-3 items-center min-h-[40px] bg-app-bg p-3 rounded-lg">${entriesHtml}</div></div><div><h4 class="font-semibold text-sm mb-2">یادداشت</h4><div class="min-h-[40px]">${noteHtml}</div></div></div><button class="close-modal-btn w-full mt-6 p-3 rounded-lg font-bold bg-app-cell-inactive hover:opacity-80 transition">بستن</button></div>`;document.getElementById('modalArea').appendChild(modal);modal.onclick=e=>{if(e.target===modal||e.target.classList.contains('close-modal-btn'))closeModal();};}
    showContextMenu=(e,goalId)=>{e.preventDefault();e.stopPropagation();if(appState.contextMenuGoalId===goalId){closeContextMenu();return;}closeContextMenu();const goal=appState.goals.find(g=>g.id===goalId);if(!goal)return;const menu=document.getElementById('contextMenu');menu.innerHTML=`<button onclick="editGoal('${goalId}')" class="w-full text-left flex items-center gap-3 p-3 hover:bg-app-hover rounded-lg">✏️ <span>ویرایش</span></button><button onclick="duplicateGoal('${goalId}')" class="w-full text-left flex items-center gap-3 p-3 hover:bg-app-hover rounded-lg">🗂️ <span>کپی</span></button><button onclick="toggleArchiveGoal('${goalId}')" class="w-full text-left flex items-center gap-3 p-3 hover:bg-app-hover rounded-lg">${goal.archived?'📂 <span>لغو آرشیو</span>':'🗄️ <span>آرشیو</span>'}</button><div class="my-1 h-px bg-app-border"></div><button onclick="deleteGoal('${goalId}')" class="w-full text-left flex items-center gap-3 p-3 text-red-500 hover:bg-red-500/10 rounded-lg">🗑️ <span>حذف</span></button>`;menu.style.display='block';const rect=menu.getBoundingClientRect();let left=e.clientX;let top=e.clientY;if(left+rect.width>window.innerWidth-10){left=window.innerWidth-rect.width-10;}if(top+rect.height>window.innerHeight-10){top=window.innerHeight-rect.height-10;}menu.style.left=`${left}px`;menu.style.top=`${top}px`;appState.contextMenuGoalId=goalId;setTimeout(()=>document.addEventListener('click',closeContextMenu,{once:true}),10);};
function updateGoalCardStats(goalId) {
    const goal = appState.goals.find(g => g.id === goalId);
    if (!goal) return;
    const card = document.querySelector(`.goal-card[data-id="${goalId}"]`);
    if (!card) return;

    // محاسبه مجدد تمام آمار
    const { weekly, allTime } = calculateScores(goal);
    const streak = calculateStreak(goal);

    // ساختار HTML داخلی آمار
    const statsInnerHtml = `
        <span class="flex items-center gap-1" title="کل"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg><span>${toFa(allTime)}</span></span>
        <span class="flex items-center gap-1" title="استریک"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg><span>${toFa(streak)}</span></span>
        <span class="flex items-center gap-1" title="هفته"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg><span>${toFa(weekly)}</span></span>
    `;

    // پیدا کردن و به‌روزرسانی بخش آمار
    const statsContainer = card.querySelector('.goal-stats-container');
    if (statsContainer) {
        statsContainer.innerHTML = statsInnerHtml;
    }
}
    //report
    

// ADD THESE THREE NEW FUNCTIONS TO YOUR SCRIPT

/**
 * Calculates the total number of completions for each day of the week for a specific goal.
 * @param {string} goalId The ID of the goal.
 * @returns {number[]} An array of 7 numbers representing total completions from Sunday to Saturday.
 */
function calculateWeekdayTotals(goalId) {
    const goal = appState.goals.find(g => g.id === goalId);
    if (!goal || !goal.history) return Array(7).fill(0);

    const totals = Array(7).fill(0); // [Sun, Mon, Tue, Wed, Thu, Fri, Sat]

    for (const weekId in goal.history) {
        const weekData = goal.history[weekId];
        if (weekData) {
            weekData.forEach((dayData, dayIndex) => {
                if (dayData && dayData.entries.length > 0) {
                    // dayIndex is 0 for Sunday, 1 for Monday, etc.
                    totals[dayIndex] += dayData.entries.length;
                }
            });
        }
    }
    return totals;
}

/**
 * Renders a yearly heatmap for a single goal inside a container.
 * @param {HTMLElement} container The element to render the heatmap into.
 * @param {object} goal The goal object.
 * @param {number} jYear The Jalali year to display.
 * @param {number[]} weekdayTotals Pre-calculated totals for each day of the week.
 */
function renderGoalHeatmap(container, goal, jYear, weekdayTotals) {
    const completionsByJalaliDate = {};
    if (goal.history) {
        for (const weekId in goal.history) {
            const weekStartDate = new Date(weekId.replace(/-/g, '/'));
            goal.history[weekId].forEach((dayData, dayIndex) => {
                if (dayData && dayData.entries.length > 0) {
                    const date = new Date(weekStartDate);
                    date.setDate(date.getDate() + dayIndex);
                    const [jy, jm, jd] = toJalali(date.getFullYear(), date.getMonth() + 1, date.getDate());
                    if (jy === jYear) {
                        const jDateStr = `${jy}-${jm}-${jd}`;
                        completionsByJalaliDate[jDateStr] = (completionsByJalaliDate[jDateStr] || 0) + dayData.entries.length;
                    }
                }
            });
        }
    }

    const maxCompletions = Math.max(1, ...Object.values(completionsByJalaliDate));
    const theme = findThemeById(appState.activeThemeId);
    
    const getDayStyle = (count) => {
        if (!count || count === 0) {
            return { bg: 'bg-app-cell-inactive opacity-75', text: '' };
        }
        const intensity = Math.min(count / maxCompletions, 1.0);
        if (theme.isDark) {
            if (intensity < 0.25) return { bg: 'bg-emerald-900', text: 'text-emerald-200' };
            if (intensity < 0.5) return { bg: 'bg-emerald-700', text: 'text-emerald-100' };
            if (intensity < 0.75) return { bg: 'bg-emerald-500', text: 'text-black' };
            return { bg: 'bg-emerald-300', text: 'text-black font-bold' };
        } else {
            if (intensity < 0.25) return { bg: 'bg-green-200', text: 'text-green-900' };
            if (intensity < 0.5) return { bg: 'bg-green-400', text: 'text-green-900' };
            if (intensity < 0.75) return { bg: 'bg-green-600', text: 'text-white' };
            return { bg: 'bg-green-800', text: 'text-white font-bold' };
        }
    };

    const weekdayHeaders = WEEKDAY_NAMES_SHORT.map((dayName, index) => {
        const dataIndex = (index + 6) % 7; // Map visual index (Sat=0) to data index (Sun=0)
        const count = weekdayTotals[dataIndex];
        if (count > 0) {
            return `<div class="relative flex items-center justify-center">
                        ${dayName}
                        <span class="absolute -top-1.5 -right-1.5 text-[9px] font-bold bg-primary/80 text-primary-text rounded-full w-4 h-4 flex items-center justify-center leading-none">${toFa(count)}</span>
                    </div>`;
        }
        return `<div>${dayName}</div>`;
    }).join('');

    let html = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-6">`;
    for (let jm = 1; jm <= 12; jm++) {
        const monthLength = jalaliMonthLength(jYear, jm);
        const firstGregorianDate = toGregorian(jYear, jm, 1);
        const startOffset = (firstGregorianDate.getDay() + 1) % 7; // Adjusted for Sat start
        
        let monthHtml = `<div class="p-3 bg-app-bg rounded-lg">
            <h4 class="font-semibold text-center text-sm mb-2">${JALALI_MONTH_NAMES[jm-1]}</h4>
            <div class="grid grid-cols-7 gap-1 text-center text-[10px] text-app-text-muted mb-1.5">
               ${weekdayHeaders}
            </div>
            <div class="grid grid-cols-7 gap-1.5 text-xs">`;
        
        for (let i = 0; i < startOffset; i++) { monthHtml += '<div></div>'; }
        for (let jd = 1; jd <= monthLength; jd++) {
            const jDateStr = `${jYear}-${jm}-${jd}`;
            const count = completionsByJalaliDate[jDateStr] || 0;
            const gDate = toGregorian(jYear, jm, jd);
            
            const style = getDayStyle(count);
            const todayClass = isToday(gDate) ? 'ring-2 ring-primary' : '';
            const title = `${toFa(jd)} ${JALALI_MONTH_NAMES[jm-1]} ${toFa(jYear)}: ${toFa(count)} مورد`;

            monthHtml += `<div onclick="showDailySummaryModal(${jYear}, ${jm}, ${jd})" class="heatmap-day aspect-square rounded-sm flex items-center justify-center cursor-pointer transition-colors ${style.bg} ${style.text} ${todayClass}" title="${title}">${toFa(jd)}</div>`;
        }
        monthHtml += `</div></div>`;
        html += monthHtml;
    }
    html += `</div>`;
    container.innerHTML = html;
}
/**
 * Creates and displays the goal-specific heatmap modal.
 * @param {string} goalId The ID of the goal to display.
 */
function showGoalHeatmapModal(goalId) {
    const goal = appState.goals.find(g => g.id === goalId);
    if (!goal) return;

    let currentYearDate = new Date();
    const weekdayTotals = calculateWeekdayTotals(goalId);

    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4';
    
    modal.innerHTML = `
        <div class="modal-content glass-modal-content rounded-2xl p-4 sm:p-6 w-full max-w-4xl max-h-[90vh] flex flex-col shadow-2xl">
            <div class="flex-shrink-0 flex justify-between items-center mb-4">
                <div class="flex items-center gap-3">
                    <span class="text-3xl">${goal.emoji}</span>
                    <h2 class="text-xl sm:text-2xl font-bold text-app-text">${escapeHtml(goal.name)}</h2>
                </div>
                <button class="close-modal-btn text-app-text-muted hover:bg-app-hover rounded-full p-2 transition-colors">&times;</button>
            </div>
            <div class="flex-shrink-0 flex items-center justify-center gap-2 mb-4">
                 <button id="heatmap-prev-btn" aria-label="Previous Year" class="p-2 rounded-full hover:bg-app-hover transition-colors">
                     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <div id="heatmap-date-display" class="w-36 text-center font-bold text-primary"></div>
                <button id="heatmap-next-btn" aria-label="Next Year" class="p-2 rounded-full hover:bg-app-hover transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>
            <div id="goal-heatmap-content" class="flex-grow overflow-y-auto p-1 -ml-2 pl-2 no-scrollbar"></div>
        </div>
    `;

    document.getElementById('modalArea').appendChild(modal);
    modal.onclick = e => { if (e.target === modal || e.target.closest('.close-modal-btn')) closeModal(); };

    const contentArea = modal.querySelector('#goal-heatmap-content');
    const dateDisplay = modal.querySelector('#heatmap-date-display');
    
    function updateView() {
        const [jYear] = toJalali(currentYearDate.getFullYear(), currentYearDate.getMonth() + 1, currentYearDate.getDate());
        dateDisplay.innerText = `سال ${toFa(jYear)}`;
        renderGoalHeatmap(contentArea, goal, jYear, weekdayTotals);
    }

    modal.querySelector('#heatmap-prev-btn').onclick = () => {
        currentYearDate.setFullYear(currentYearDate.getFullYear() - 1);
        updateView();
    };
    modal.querySelector('#heatmap-next-btn').onclick = () => {
        currentYearDate.setFullYear(currentYearDate.getFullYear() + 1);
        updateView();
    };

    updateView(); // Initial render
}




    //end
   //report
 function showReportModal(initialView = 'month') {
    let currentReportDate = new Date();
    let currentReportView = initialView; // 'day', 'week', 'month', 'overall'
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4';
    modal.innerHTML = `
        <div class="modal-content glass-modal-content rounded-2xl p-4 sm:p-6 w-full max-w-4xl max-h-[90vh] flex flex-col shadow-2xl">
            <div class="flex-shrink-0 flex justify-between items-center mb-4">
                <h2 class="text-xl sm:text-2xl font-bold text-app-text">گزارش پیشرفت</h2>
                <button class="close-modal-btn text-app-text-muted hover:bg-app-hover rounded-full p-2 transition-colors">&times;</button>
            </div>
            <div class="flex-shrink-0 flex flex-col sm:flex-row items-center justify-between gap-4 mb-4">
                <div id="report-tabs" class="w-full sm:w-auto flex flex-wrap items-center justify-center gap-2 bg-app-card/50 p-1 rounded-xl">
                    <button data-view="day" class="report-tab-btn px-4 py-2 text-sm font-semibold rounded-lg">روزانه</button>
                    <button data-view="week" class="report-tab-btn px-4 py-2 text-sm font-semibold rounded-lg">هفتگی</button>
                    <button data-view="month" class="report-tab-btn px-4 py-2 text-sm font-semibold rounded-lg">ماهانه</button>
                    <button data-view="overall" class="report-tab-btn px-4 py-2 text-sm font-semibold rounded-lg">سالیانه</button>
                </div>
                <div class="flex items-center gap-2">
                    <button id="report-prev-btn" aria-label="Previous" class="p-2 rounded-full hover:bg-app-hover transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <div id="report-date-display" class="w-36 text-center font-bold text-primary"></div>
                    <button id="report-next-btn" aria-label="Next" class="p-2 rounded-full hover:bg-app-hover transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                </div>
            </div>
            <div id="report-content" class="flex-grow overflow-y-auto space-y-3 p-1 -ml-2 pl-2 no-scrollbar"></div>
        </div>`;
    document.getElementById('modalArea').appendChild(modal);
    modal.onclick = e => { if (e.target === modal || e.target.closest('.close-modal-btn')) closeModal(); };
    const tabs = modal.querySelector('#report-tabs');
    const contentArea = modal.querySelector('#report-content');
    const dateDisplay = modal.querySelector('#report-date-display');
    const prevBtn = modal.querySelector('#report-prev-btn');
    const nextBtn = modal.querySelector('#report-next-btn');
    function updateReportView() {
        renderReportContent(contentArea, dateDisplay, currentReportView, currentReportDate);
        tabs.querySelectorAll('.report-tab-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.view === currentReportView);
        });
    }
    tabs.addEventListener('click', e => {
        const button = e.target.closest('.report-tab-btn');
        if (button) {
            currentReportView = button.dataset.view;
            currentReportDate = new Date();
            updateReportView();
        }
    });
    const navigate = (direction) => {
        if (currentReportView === 'day') currentReportDate.setDate(currentReportDate.getDate() + direction);
        else if (currentReportView === 'week') currentReportDate.setDate(currentReportDate.getDate() + (7 * direction));
        else if (currentReportView === 'month') currentReportDate.setMonth(currentReportDate.getMonth() + direction);
        else if (currentReportView === 'overall') currentReportDate.setFullYear(currentReportDate.getFullYear() + direction);
        updateReportView();
    };
    prevBtn.addEventListener('click', () => navigate(-1));
    nextBtn.addEventListener('click', () => navigate(1));
    updateReportView(); // Initial render
}
    function renderReportContent(container, dateDisplay, view, date) {
        const goals = appState.goals.filter(g => !g.archived);
        if (goals.length === 0) {
            container.innerHTML = `<div class="text-center text-slate-500 p-8">هیچ عادت فعالی برای گزارش وجود ندارد.</div>`;
            dateDisplay.innerText = '-';
            return;
        }
        if (view === 'overall') {
            const [jYear] = toJalali(date.getFullYear(), date.getMonth() + 1, date.getDate());
            dateDisplay.innerText = `سال ${toFa(jYear)}`;
            renderOverallReport(container, jYear);
            return;
        }
        let startDate, endDate, dateLabel = '';
        if (view === 'day') {
            startDate = new Date(date); startDate.setHours(0,0,0,0);
            endDate = new Date(date); endDate.setHours(23,59,59,999);
            dateLabel = date.toLocaleDateString('fa-IR', { year: 'numeric', month: 'long', day: 'numeric' });
        } else if (view === 'week') {
            startDate = getStartOfWeek(date);
            endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
            endDate.setHours(23,59,59,999);
            dateLabel = formatWeekRange(startDate);
        } else { // month
            const [jYear, jMonth] = toJalali(date.getFullYear(), date.getMonth() + 1, date.getDate());
            startDate = toGregorian(jYear, jMonth, 1);
            const monthLen = jalaliMonthLength(jYear, jMonth);
            endDate = toGregorian(jYear, jMonth, monthLen);
            endDate.setHours(23,59,59,999);
            dateLabel = startDate.toLocaleDateString('fa-IR', { year: 'numeric', month: 'long' });
        }
        dateDisplay.innerText = dateLabel;
        let reportHtml = '';
        goals.forEach(goal => {
            let totalCompletions = 0;
            let totalTarget = 0;
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dayIndex = d.getDay(); // Sunday is 0
                if (goal.days[dayIndex]) {
                    totalTarget++;
                    totalCompletions += getEntryCountOnDate(goal, d);
                }
            }
            const percentage = totalTarget > 0 ? Math.round((totalCompletions / totalTarget) * 100) : 0;
            const streak = calculateStreak(goal);
            reportHtml += `
                <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${goal.emoji}</span>
                            <span class="font-bold text-slate-700 dark:text-slate-200">${escapeHtml(goal.name)}</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center flex-wrap gap-x-4 gap-y-2 text-sm font-semibold text-slate-500 dark:text-slate-400 mb-2">
                        <span>تکمیل دوره: ${toFa(totalCompletions)} / ${toFa(totalTarget)}</span>
                        <div class="flex items-center gap-1 text-amber-500" title="استریک فعلی">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" /></svg>
                            <span class="font-bold">${toFa(streak)}</span>
                        </div>
                        <span class="font-bold text-indigo-500">${toFa(percentage)}٪</span>
                    </div>
                    <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5">
                        <div class="bg-indigo-600 h-2.5 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                </div>
            `;
        });
        container.innerHTML = reportHtml;
    }
    function renderOverallReport(container, jYear) {
        const { totalCompletions, busiestDay } = calculateOverallStats();
        const statsHtml = `
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                <div class="stat-card">
                    <div class="stat-value">${toFa(totalCompletions)}</div>
                    <div class="stat-label">مجموع عملکرد</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${busiestDay}</div>
                    <div class="stat-label">فعال‌ترین روز</div>
                </div>
            </div>`;
        const heatmapContainerId = `yearly-heatmap-${jYear}`;
        container.innerHTML = statsHtml + `<div id="${heatmapContainerId}" class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm"></div>`;
        renderYearlyHeatmap(document.getElementById(heatmapContainerId), jYear);
    }
    function calculateOverallStats() {
        let totalCompletions = 0;
        const dayCounts = [0, 0, 0, 0, 0, 0, 0]; // Sun, Mon, Tue, Wed, Thu, Fri, Sat
        const goals = appState.goals.filter(g => !g.archived);
        goals.forEach(goal => {
            if (goal.history) {
                 Object.values(goal.history).forEach(weekData => {
                     if (weekData) {
                         weekData.forEach((dayData, dayIndex) => {
                            if (dayData && dayData.entries.length > 0) {
                                 totalCompletions += dayData.entries.length;
                                 dayCounts[dayIndex] += dayData.entries.length;
                            }
                         });
                     }
                 });
            }
        });
        const busiestDayIndex = dayCounts.indexOf(Math.max(...dayCounts));
        const dayNames = ['یکشنبه', 'دوشنبه', 'سه‌شنبه', 'چهارشنبه', 'پنجشنبه', 'جمعه', 'شنبه'];
        const busiestDay = totalCompletions > 0 ? dayNames[busiestDayIndex] : '-';
        return { totalCompletions, busiestDay };
    }
   function renderYearlyHeatmap(container, jYear) {
    const completionsByJalaliDate = {};
    appState.goals.filter(g => !g.archived).forEach(goal => {
        if(goal.history) {
            for(const weekId in goal.history) {
                const weekStartDate = new Date(weekId.replace(/-/g, '/'));
                goal.history[weekId].forEach((dayData, dayIndex) => {
                    if (dayData && dayData.entries.length > 0) {
                        const date = new Date(weekStartDate);
                        date.setDate(date.getDate() + dayIndex);
                        const [jy, jm, jd] = toJalali(date.getFullYear(), date.getMonth() + 1, date.getDate());
                        if (jy === jYear) {
                            const jDateStr = `${jy}-${jm}-${jd}`;
                            completionsByJalaliDate[jDateStr] = (completionsByJalaliDate[jDateStr] || 0) + dayData.entries.length;
                        }
                    }
                });
            }
        }
    });
    const maxCompletions = Math.max(1, ...Object.values(completionsByJalaliDate));
    const getColor = (count) => {
        if (!count || count === 0) return 'bg-slate-200 dark:bg-slate-700/80';
        const intensity = Math.min(count / (maxCompletions * 0.6 + 1), 1);
        if (intensity < 0.25) return 'bg-emerald-200 dark:bg-emerald-900';
        if (intensity < 0.5) return 'bg-emerald-400 dark:bg-emerald-700';
        if (intensity < 0.75) return 'bg-emerald-600 dark:bg-emerald-500';
        return 'bg-emerald-800 dark:bg-emerald-300';
    };
    let html = `<h3 class="font-bold mb-4 text-center">نقشه فعالیت سال ${toFa(jYear)}</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-6">`;
    for (let jm = 1; jm <= 12; jm++) {
        const monthLength = jalaliMonthLength(jYear, jm);
        const firstGregorianDate = toGregorian(jYear, jm, 1);
        const startOffset = (firstGregorianDate.getDay() + 1) % 7; // Adjusted for Sat start
        let monthHtml = `<div class="p-3 bg-slate-100 dark:bg-slate-900/50 rounded-lg">
            <h4 class="font-semibold text-center text-sm mb-2">${JALALI_MONTH_NAMES[jm-1]}</h4>
            <div class="grid grid-cols-7 gap-1 text-center text-[10px] text-slate-400 mb-1.5">
               ${WEEKDAY_NAMES_SHORT.map(d => `<div>${d}</div>`).join('')}
            </div>
            <div class="grid grid-cols-7 gap-1.5">`;
        for (let i = 0; i < startOffset; i++) { monthHtml += '<div></div>'; }
        for (let jd = 1; jd <= monthLength; jd++) {
            const jDateStr = `${jYear}-${jm}-${jd}`;
            const count = completionsByJalaliDate[jDateStr] || 0;
            const gDate = toGregorian(jYear, jm, jd);
            const colorClass = getColor(count);
            const todayClass = isToday(gDate) ? 'ring-2 ring-sky-500' : '';
            const title = `${toFa(jd)} ${JALALI_MONTH_NAMES[jm-1]} ${toFa(jYear)}: ${toFa(count)} مورد`;
            monthHtml += `<div onclick="showDailySummaryModal(${jYear}, ${jm}, ${jd})" class="${colorClass} ${todayClass} heatmap-day text-slate-800 dark:text-slate-200 font-bold" title="${title}">${toFa(jd)}</div>`;
        }
        monthHtml += `</div></div>`;
        html += monthHtml;
    }
    html += `</div>`;
    container.innerHTML = html;
}
    function showDailySummaryModal(jYear, jMonth, jDay) {
        const gDate = toGregorian(jYear, jMonth, jDay);
        const formattedDate = gDate.toLocaleDateString('fa-IR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-[101] flex items-center justify-center p-4';
        let completedGoalsHtml = '';
        let totalPlanned = 0;
        let totalCompletedCount = 0;
        const activeGoals = appState.goals.filter(g => !g.archived);
        const dayIndexForCheck = gDate.getDay(); // Sunday is 0
        activeGoals.forEach(goal => {
            if (goal.days[dayIndexForCheck]) {
                totalPlanned++;
                const entryCount = getEntryCountOnDate(goal, gDate);
                if (entryCount > 0) {
                    totalCompletedCount++;
                    completedGoalsHtml += `
                        <div class="flex items-center justify-between p-3 bg-white dark:bg-slate-700/50 rounded-lg">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">${goal.emoji}</span>
                                <span class="font-semibold">${escapeHtml(goal.name)}</span>
                            </div>
                            <span class="font-bold text-indigo-500">${toFa(entryCount)} بار</span>
                        </div>`;
                }
            }
        });
        const successRate = totalPlanned > 0 ? Math.round((totalCompletedCount / totalPlanned) * 100) : 0;
        const statsHtml = `
            <div class="mb-4">
                <h4 class="font-semibold text-sm mb-2 text-slate-600 dark:text-slate-300">آمار روز</h4>
                <div class="grid grid-cols-3 gap-2 text-center">
                    <div class="bg-slate-200 dark:bg-slate-700 p-2 rounded-lg">
                        <div class="text-xl font-bold text-green-600 dark:text-green-400">${toFa(totalCompletedCount)}</div>
                        <div class="text-xs text-slate-500 dark:text-slate-400">انجام‌شده</div>
                    </div>
                    <div class="bg-slate-200 dark:bg-slate-700 p-2 rounded-lg">
                        <div class="text-xl font-bold text-slate-700 dark:text-slate-200">${toFa(totalPlanned)}</div>
                        <div class="text-xs text-slate-500 dark:text-slate-400">برنامه‌ریزی</div>
                    </div>
                    <div class="bg-slate-200 dark:bg-slate-700 p-2 rounded-lg">
                        <div class="text-xl font-bold text-indigo-600 dark:text-indigo-400">${toFa(successRate)}٪</div>
                        <div class="text-xs text-slate-500 dark:text-slate-400">موفقیت</div>
                    </div>
                </div>
            </div>`;
        if (completedGoalsHtml === '') {
            completedGoalsHtml = '<p class="text-center text-slate-500 dark:text-slate-400 py-4">هیچ فعالیتی در این روز ثبت نشده است.</p>';
        }
        modal.innerHTML = `
            <div class="modal-content glass-modal-content rounded-2xl p-5 w-full max-w-md shadow-2xl">
                <h3 class="font-bold text-lg text-indigo-600 dark:text-indigo-400 mb-1">خلاصه روز</h3>
                <p class="text-sm text-slate-500 dark:text-slate-400 font-semibold mb-4">${formattedDate}</p>
                ${statsHtml}
                <h4 class="font-semibold text-sm mb-2 mt-4 text-slate-600 dark:text-slate-300">عادت‌های انجام‌شده</h4>
                <div class="space-y-2 max-h-52 overflow-y-auto no-scrollbar">${completedGoalsHtml}</div>
                <button class="close-modal-btn w-full mt-6 p-3 rounded-lg font-bold bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 transition">بستن</button>
            </div>`;
        document.getElementById('modalArea').appendChild(modal);
        modal.onclick = e => { if (e.target === modal || e.target.closest('.close-modal-btn')) closeModal(); };
    }
// ADD THIS NEW FUNCTION TO YOUR SCRIPT
// REPLACE THIS FUNCTION
// REPLACE THIS FUNCTION
function renderSettingsMenu() {
    const menu = document.getElementById('settingsMenu');
    if (!menu) return;

    const showArchived = appState.showArchived;
    const isDark = findThemeById(appState.activeThemeId).isDark;

    menu.innerHTML = `
        <div class="space-y-1">
            <button id="reportBtn" class="w-full text-left flex items-center gap-3 p-3 hover:bg-app-hover rounded-lg transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                <span>گزارش‌ها</span>
            </button>
            <button id="archiveToggleBtn" class="w-full text-left flex items-center gap-3 p-3 hover:bg-app-hover rounded-lg transition-colors ${showArchived ? 'text-primary' : ''}">
               <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                <span>${showArchived ? 'پنهان کردن آرشیو' : 'نمایش آرشیو'}</span>
            </button>
            <button id="themeSelectorBtn" class="w-full text-left flex items-center gap-3 p-3 hover:bg-app-hover rounded-lg transition-colors">
                <span class="text-xl w-5 text-center">🎨</span>
                <span>انتخاب تم</span>
            </button>
            <div class="my-1 h-px bg-app-border"></div>
            <div class="w-full text-left flex items-center justify-between gap-3 p-3">
                <div class="flex items-center gap-3">
                    <span class="text-xl w-5 text-center">🎲</span>
                    <span>تم تصادفی</span>
                </div>
                <label for="randomThemeToggle" class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" value="" id="randomThemeToggle" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                </label>
            </div>
            <div class="w-full text-left flex items-center justify-between gap-3 p-3">
                <div class="flex items-center gap-3">
                    <span class="text-xl w-5 text-center">🌗</span>
                    <span>حالت تیره</span>
                </div>
                <label for="darkModeToggle" class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" value="" id="darkModeToggle" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                </label>
            </div>
            <div class="my-1 h-px bg-app-border"></div>
            <button id="backupBtn" class="w-full text-left flex items-center gap-3 p-3 hover:bg-app-hover rounded-lg transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M12 15l-3-3m0 0l3-3m-3 3h12" /> </svg>
                <span>پشتیبان‌گیری</span>
            </button>
             <button id="aboutBtn" class="w-full text-left flex items-center gap-3 p-3 hover:bg-app-hover rounded-lg transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">  <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /> </svg>
                <span>درباره</span>
            </button>
        </div>
    `;
    const desktopToggle = menu.querySelector('#darkModeToggle');
    if (desktopToggle) desktopToggle.checked = isDark;
    
    const randomThemeToggle = menu.querySelector('#randomThemeToggle');
    if (randomThemeToggle) {
        randomThemeToggle.checked = appState.randomThemeMode;
    }
}
// You should also add the "Random Theme" toggle to renderMobileMenu if you wish.
function setupHeaderSwipe() {
    const navbar = document.getElementById('navbar');
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    let touchStartX = 0;
    let touchEndX = 0;

    navbar.addEventListener('touchstart', function(event) {
        // فقط در حالت موبایل اجرا شود
        if (hamburgerBtn.offsetParent === null) return;
        touchStartX = event.changedTouches[0].screenX;
    }, { passive: true });

    navbar.addEventListener('touchend', function(event) {
        // فقط در حالت موبایل اجرا شود
        if (hamburgerBtn.offsetParent === null) return;
        touchEndX = event.changedTouches[0].screenX;
        handleHeaderSwipe();
    });

    function handleHeaderSwipe() {
        const swipeThreshold = 50; // حداقل فاصله برای تشخیص اسلاید

        // اسلاید به راست -> هفته بعدی
        if (touchEndX > touchStartX + swipeThreshold) {
            appState.currentWeek.setDate(appState.currentWeek.getDate() + 7);
            fullRender();
        }
        // اسلاید به چپ -> هفته قبلی
        else if (touchStartX > touchEndX + swipeThreshold) {
            appState.currentWeek.setDate(appState.currentWeek.getDate() - 7);
            fullRender();
        }
    }
}

</script>
</body>
</html>