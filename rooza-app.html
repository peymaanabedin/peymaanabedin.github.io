<!DOCTYPE html>
<html lang="fa" dir="ltr" class="">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Rooza | Habit Tracker App</title>
    <meta name="description" content="Rooza (Ø±ÙˆØ²Ø§) Personal Habit and Goal Tracker Application">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Rooza">
    <meta name="application-name" content="Rooza">
    <link rel="icon" type="image/png" href="https://i.ibb.co/kV0P6jz5/rooza-app.png">
    <link rel="apple-touch-icon" href="https://i.ibb.co/kV0P6jz5/rooza-app.png">
    <link rel="apple-touch-icon" sizes="152x152" href="https://i.ibb.co/kV0P6jz5/rooza-app.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://i.ibb.co/kV0P6jz5/rooza-app.png">
    <link rel="apple-touch-icon" sizes="167x167" href="https://i.ibb.co/kV0P6jz5/rooza-app.png">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style id="dynamic-theme-style"></style>
    <style>
        body { font-family: 'Vazirmatn', sans-serif; background-color: var(--color-bg); color: var(--color-text); }
        .sortable-ghost { opacity: 0.4; background-color: #cce7ff; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .goal-anim-in { animation: goal-fade-in 0.4s ease-out forwards; }
        .goal-anim-out { animation: goal-fade-out 0.3s ease-in forwards; }
        @keyframes goal-fade-in { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes goal-fade-out { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        .cell-swipe-up { animation: cell-pop 0.2s ease-out forwards; }
        .cell-swipe-down { animation: cell-shrink 0.2s ease-out forwards; }
        @keyframes cell-pop { 0% { transform: scale(1); } 50% { transform: scale(1.15); background-color: hsla(120, 73%, 75%, 0.5); } 100% { transform: scale(1); } }
        @keyframes cell-shrink { 0% { transform: scale(1); } 50% { transform: scale(0.85); background-color: hsla(0, 100%, 80%, 0.5); } 100% { transform: scale(1); } }
        .stat-card { background-color: var(--color-card); padding: 1rem; border-radius: 0.75rem; text-align: center; box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); transition: all 0.2s; }
        .stat-card:hover { transform: scale(1.05); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--color-primary); margin-bottom: 0.25rem; }
        .stat-label { font-size: 0.75rem; color: var(--color-text-muted); font-weight: 600; }
        .report-tab-btn { background-color: var(--color-cell-inactive); color: var(--color-text); }
        .report-tab-btn.active { background-color: var(--color-primary); color: var(--color-primary-text); box-shadow: 0 4px 14px 0 var(--color-primary-shadow); }
        .heatmap-day { transition: background-color 0.2s; }
        .heatmap-count { background-color: #0ea5e9; color: white; }
        .glass-modal-content { background-color: var(--color-header); backdrop-filter: blur(16px); border: 1px solid var(--color-border); }
        #settingsMenu, #categoryMenu { display: none; }
        #settingsMenu.visible, #categoryMenu.visible { display: block; }
        /* .emoji-container { background-color: var(--color-cell-inactive); } */

        .shadow-sky-500\/30 {
  --tw-shadow-color: rgba(193, 193, 193, 0.72) !important;
  --tw-shadow: var(--tw-shadow-colored) !important;
}
.ring-2 {
  --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color) !important;
  --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color) !important;
  box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000) !important;
}
.ring-sky-500 {
  --tw-ring-opacity: 0.2 !important;
  --tw-ring-color: rgba(208, 208, 208, 0.32) !important
}

    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: 'var(--color-primary)',
                        'primary-text': 'var(--color-primary-text)',
                        'app-bg': 'var(--color-bg)',
                        'app-text': 'var(--color-text)',
                        'app-text-muted': 'var(--color-text-muted)',
                        'app-card': 'var(--color-card)',
                        'app-header': 'var(--color-header)',
                        'app-border': 'var(--color-border)',
                        'app-hover': 'var(--color-hover)',
                        'app-cell-inactive': 'var(--color-cell-inactive)',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-app-bg text-app-text antialiased">
    <div class="min-h-screen pt-[env(safe-area-inset-top)]">
       <header id="navbar" class="sticky top-0 z-50 bg-app-header backdrop-blur-lg flex items-center justify-between p-4 border-b border-app-border">
    <div class="md:hidden flex items-center justify-between w-full">
        <div class="w-8"></div> 
        
        <div id="weekTitleMobile" class="text-base font-bold text-primary text-center truncate"></div>

        <button id="hamburgerBtn" aria-label="Open menu" class="text-app-text-muted hover:bg-app-hover rounded-full p-2 transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
        </button>
    </div>

    <div class="hidden md:flex flex-1">
        <button id="todayBtn" class="text-sm text-app-text-muted font-semibold hover:text-primary transition-colors"></button>
    </div>
    <div class="hidden md:flex items-center gap-2">
        <button id="prevWeekBtn" aria-label="Previous Week" class="flex items-center gap-x-2 text-app-text-muted hover:bg-app-hover rounded-full px-3 py-2 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
            <span class="text-sm font-medium hidden sm:inline">Ù‡ÙØªÙ‡ Ù‚Ø¨Ù„ÛŒ</span>
        </button>
        <div id="weekTitle" class="text-base md:text-lg font-bold text-primary w-40 text-center"></div>
        <button id="nextWeekBtn" aria-label="Next Week" class="flex items-center gap-x-2 text-app-text-muted hover:bg-app-hover rounded-full px-3 py-2 transition-colors">
            <span class="text-sm font-medium hidden sm:inline">Ù‡ÙØªÙ‡ Ø¨Ø¹Ø¯ÛŒ</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
        </button>
    </div>
    <div class="hidden md:flex flex-1 flex justify-end items-center">
        <div class="relative">
            <button id="categoryMenuBtn" aria-label="Categories" class="text-app-text-muted hover:bg-app-hover rounded-full p-2 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-5.414 5.414a1 1 0 00-.293.707V19l-4 2v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                </svg>
            </button>
            <div id="categoryMenu" class="absolute right-0 mt-2 w-56 origin-top-right bg-app-header backdrop-blur-lg shadow-2xl rounded-xl border border-app-border p-2 text-base z-[1001]"></div>
        </div>
        <div class="relative">
            <button id="settingsMenuBtn" aria-label="Settings" class="text-app-text-muted hover:bg-app-hover rounded-full p-2 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </button>
            <div id="settingsMenu" class="absolute right-0 mt-2 w-56 origin-top-right bg-app-header backdrop-blur-lg shadow-2xl rounded-xl border border-app-border p-2 text-base z-[1001]">
                </div>
        </div>
    </div>
    
</header>

<div id="mobileMenu" dir="rtl" class="fixed inset-0 bg-app-bg z-[100] p-4 pt-[calc(env(safe-area-inset-top)+1rem)] transform translate-x-full transition-transform duration-300 ease-in-out">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-primary">Ù…Ù†Ùˆ</h2>
        <button id="closeMobileMenuBtn" class="p-2 text-3xl hover:text-primary">&times;</button>
    </div>
    <div id="mobileMenuContent" class="space-y-4 overflow-y-auto h-[calc(100%-80px)] no-scrollbar">
        </div>
</div>


        <main id="mainContent" class="max-w-4xl mx-auto p-4 pb-32">
            <div id="weekdayRow" class="grid grid-cols-7 gap-2 text-center my-6"></div>
            <div id="goalList" class="flex flex-col gap-4"></div>
            <div id="archivedGoalList" class="hidden">
                <h3 class="text-lg font-bold text-app-text-muted my-4 p-2 border-b-2 border-app-border">Ø¢Ø±Ø´ÛŒÙˆ Ø´Ø¯Ù‡â€ŒÙ‡Ø§</h3>
                <div class="flex flex-col gap-4"></div>
            </div>
        </main>
        <button id="fab" aria-label="Ø§ÙØ²ÙˆØ¯Ù† Ù‡Ø¯Ù" class="fixed right-6 bottom-[calc(env(safe-area-inset-bottom)+1.5rem)] z-50 w-16 h-16 bg-primary text-primary-text rounded-full flex items-center justify-center text-3xl shadow-lg hover:opacity-90 active:scale-90 transition-all">ï¼‹</button>
    </div>
    <div id="modalArea"></div>
    <div id="contextMenu" class="fixed z-[1000] min-w-[180px] bg-app-header backdrop-blur-lg shadow-2xl rounded-xl border border-app-border p-2 text-base" style="display:none"></div>
<script>
    const checkmarkSVG = `<svg width="24" height="24" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"> <circle cx="16" cy="16" r="15" fill="url(#paint0_radial)" stroke="#4CAF50" stroke-width="2"></circle> <path d="M9 17.5L14 22L23 12.5" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"></path> <defs> <radialGradient id="paint0_radial" cx="0" cy="0" r="1" gradientTransform="translate(16 16) scale(16)"> <stop stop-color="#A5D6A7"></stop> <stop offset="1" stop-color="#4CAF50"></stop> </radialGradient> </defs></svg>`;
    // --- CONSTANTS & CONFIG ---
    const EMOJIS = [checkmarkSVG,'ğŸ‰','ğŸ”¥','ğŸ’ª','ğŸ¯','ğŸ‘','ğŸ‘','âŒ','ğŸ¤”','ğŸ˜´','ğŸ”','ğŸ’»','ğŸ§˜','ğŸ“–'];
    const CATEGORIES = {
        'ÙˆØ±Ø²Ø´': 'bg-sky-100 text-sky-800 dark:bg-sky-900/50 dark:text-sky-300',
        'Ú©Ø§Ø±': 'bg-amber-100 text-amber-800 dark:bg-amber-900/50 dark:text-amber-300',
        'Ø´Ø®ØµÛŒ': 'bg-violet-100 text-violet-800 dark:bg-violet-900/50 dark:text-violet-300',
        'Ø³Ù„Ø§Ù…ØªÛŒ': 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300',
    };
    const themesData = {
        modernDark: [ { id: 'theme-cyberpunk', name: 'Ø³Ø§ÛŒØ¨Ø±Ù¾Ø§Ù†Ú©', primary: '#f9f871', bg: '#0c0c27', text: '#a6fffa', isDark: true }, { id: 'theme-vaporwave', name: 'ÙˆÛŒÙ¾ÙˆØ±ÙˆÛŒÙˆ', primary: '#ff77cc', bg: '#200c38', text: '#00e5e5', isDark: true }, { id: 'theme-twilight', name: 'Ú¯Ø±Ú¯ Ùˆ Ù…ÛŒØ´', primary: '#ffc880', bg: '#1e1e3f', text: '#d4d4ff', isDark: true }, { id: 'theme-matrix', name: 'Ù…Ø§ØªØ±ÛŒÚ©Ø³', primary: '#00ff41', bg: '#0d0208', text: '#008f11', isDark: true }, { id: 'theme-deep-space', name: 'Ø§Ø¹Ù…Ø§Ù‚ ÙØ¶Ø§', primary: '#9d80ff', bg: '#00001a', text: '#f0f0ff', isDark: true }, { id: 'theme-oled', name: 'OLED', primary: '#ff3385', bg: '#000000', text: '#e5e5e5', isDark: true }, { id: 'theme-8bit-sunset', name: 'ØºØ±ÙˆØ¨ Û¸ Ø¨ÛŒØªÛŒ', primary: '#f9d868', bg: '#34294b', text: '#f0e5ff', isDark: true }, { id: 'theme-arcade', name: 'Ø¢Ø±Ú©ÛŒØ¯', primary: '#ffcc00', bg: '#1d1a33', text: '#eeebff', isDark: true }, { id: 'theme-midnight-city', name: 'Ø´Ù‡Ø± Ù†ÛŒÙ…Ù‡â€ŒØ´Ø¨', primary: '#f1fa8c', bg: '#191a21', text: '#e1e1e6', isDark: true }, { id: 'theme-snes-dark', name: 'SNES', primary: '#aca8dd', bg: '#212121', text: '#e0e0e0', isDark: true }, { id: 'theme-playstation-dark', name: 'Ù¾Ù„ÛŒâ€ŒØ§Ø³ØªÛŒØ´Ù†', primary: '#006fcd', bg: '#1f1f2e', text: '#f0f0f5', isDark: true }, { id: 'theme-blade-runner-dark', name: 'Ø¨Ù„ÛŒØ¯Ø±Ø§Ù†Ø±', primary: '#f05a28', bg: '#0a1128', text: '#00f6ff', isDark: true }, { id: 'theme-dune-dark', name: 'ØªÙ„â€ŒÙ…Ø§Ø³Ù‡', primary: '#e89f48', bg: '#2c221c', text: '#d5c8b8', isDark: true }, { id: 'theme-ocean-dark', name: 'Ø§Ù‚ÛŒØ§Ù†ÙˆØ³', primary: '#5efff5', bg: '#0b192f', text: '#ccd6f6', isDark: true }, { id: 'theme-blood-moon', name: 'Ù…Ø§Ù‡ Ø®ÙˆÙ†ÛŒÙ†', primary: '#ff4d4d', bg: '#1a0000', text: '#ffcccc', isDark: true }, { id: 'theme-nebula', name: 'Ø³Ø­Ø§Ø¨ÛŒ', primary: '#d67ae9', bg: '#1d0f2b', text: '#e1d8f5', isDark: true }, { id: 'theme-volcano', name: 'Ø¢ØªØ´ÙØ´Ø§Ù†', primary: '#ff7a00', bg: '#1f120c', text: '#ffd8c9', isDark: true }, { id: 'theme-aurora', name: 'Ø´ÙÙ‚ Ù‚Ø·Ø¨ÛŒ', primary: '#45fcd1', bg: '#011627', text: '#d6deeb', isDark: true }, { id: 'theme-synthwave-84', name: 'Ù…ÙˆØ¬ Ø³ÛŒÙ†ØªÛŒ', primary: '#ff8b42', bg: '#2b213a', text: '#f9f7f2', isDark: true }, { id: 'theme-atlantis', name: 'Ø¢ØªÙ„Ø§Ù†ØªÛŒØ³', primary: '#96e072', bg: '#262a33', text: '#f8f8f2', isDark: true }],
        classicDark: [ { id: 'theme-dracula', name: 'Ø¯Ø±Ø§Ú©ÙˆÙ„Ø§', primary: '#ff79c6', bg: '#282a36', text: '#f8f8f2', isDark: true }, { id: 'theme-monokai', name: 'Ù…ÙˆÙ†ÙˆÚ©Ø§ÛŒ', primary: '#f92672', bg: '#272822', text: '#f8f8f2', isDark: true }, { id: 'theme-nord', name: 'Ù†ÙˆØ±Ø¯', primary: '#88c0d0', bg: '#2e3440', text: '#d8dee9', isDark: true }, { id: 'theme-gruvbox-dark', name: 'Ú¯Ø±Ø§ÙˆØ¨Ø§Ú©Ø³', primary: '#fe8019', bg: '#282828', text: '#ebdbb2', isDark: true }, { id: 'theme-solarized-dark', name: 'Ø³ÙˆÙ„Ø§Ø±Ø§ÛŒØ²Ø¯', primary: '#268bd2', bg: '#002b36', text: '#eee8d5', isDark: true }, { id: 'theme-old-terminal', name: 'ØªØ±Ù…ÛŒÙ†Ø§Ù„', primary: '#33ff33', bg: '#000000', text: '#33ff33', isDark: true }, { id: 'theme-forest', name: 'Ø¬Ù†Ú¯Ù„', primary: '#b4e982', bg: '#1a2b23', text: '#d3e5d7', isDark: true }, { id: 'theme-noir', name: 'Ù†ÙˆØ¢Ø±', primary: '#f4a261', bg: '#1c1c1c', text: '#e0e0e0', isDark: true }, { id: 'theme-velvet', name: 'Ù…Ø®Ù…Ù„ÛŒ', primary: '#ffd700', bg: '#4a0404', text: '#fff0f0', isDark: true }, { id: 'theme-sublime', name: 'Ú©Ø¯Ù†ÙˆÛŒØ³ÛŒ', primary: '#fd971f', bg: '#232323', text: '#f8f8f2', isDark: true }, { id: 'theme-evergreen', name: 'Ù‡Ù…ÛŒØ´Ù‡â€ŒØ³Ø¨Ø²', primary: '#f4a261', bg: '#2a3d34', text: '#e8e4d1', isDark: true }, { id: 'theme-gameboy-dark', name: 'Ú¯ÛŒÙ…â€ŒØ¨ÙˆÛŒ', primary: '#3f6946', bg: '#0f380f', text: '#9bbc0f', isDark: true }, { id: 'theme-gold-dark', name: 'Ø·Ù„Ø§ÛŒ ØªÛŒØ±Ù‡', primary: '#ffd700', bg: '#141414', text: '#e8e8e8', isDark: true }, { id: 'theme-rose-gold-dark', name: 'Ø±Ø²Ú¯Ù„Ø¯ ØªÛŒØ±Ù‡', primary: '#b76e79', bg: '#2c2426', text: '#f5f1f2', isDark: true }, { id: 'theme-silver-dark', name: 'Ù†Ù‚Ø±Ù‡â€ŒØ§ÛŒ ØªÛŒØ±Ù‡', primary: '#c0c0c0', bg: '#25282a', text: '#f0f0f0', isDark: true }, { id: 'theme-ios-dark', name: 'iOS ØªÛŒØ±Ù‡', primary: '#0a84ff', bg: '#000000', text: '#ffffff', isDark: true }, { id: 'theme-gothic', name: 'Ú¯ÙˆØªÛŒÚ©', primary: '#9400d3', bg: '#121212', text: '#c8c8c8', isDark: true }, { id: 'theme-retro-orange', name: 'Ù†Ø§Ø±Ù†Ø¬ÛŒ Ø±ØªØ±Ùˆ', primary: '#e27d60', bg: '#27211e', text: '#e4d7d0', isDark: true }, { id: 'theme-emerald', name: 'Ø²Ù…Ø±Ø¯', primary: '#50c878', bg: '#1f2e2a', text: '#d4e9e2', isDark: true }, { id: 'theme-coffee', name: 'Ù‚Ù‡ÙˆÙ‡', primary: '#c4a68a', bg: '#2a211c', text: '#d1c7b7', isDark: true }],
        modernLight: [ // NEW LINE
{ id: 'theme-joes', name: 'Joes', isDark: false, primary: '#004080', bg: '#F5F5DC', text: '#3A3A3A', card: '#BBDDFF', cellInactive: '#F5F5DC', completedBg: '#F5F5DC' }, { id: 'theme-sakura', name: 'Ø³Ø§Ú©ÙˆØ±Ø§', primary: '#db88b5', bg: '#fff6f9', text: '#5b4d53', isDark: false }, { id: 'theme-seaside', name: 'Ø³Ø§Ø­Ù„ÛŒ', primary: '#1d74c4', bg: '#eef7ff', text: '#0b3954', isDark: false }, { id: 'theme-matcha', name: 'Ù…Ø§Ú†Ø§', primary: '#75a99c', bg: '#f5f5e8', text: '#4a4a42', isDark: false }, { id: 'theme-peaches', name: 'Ù‡Ù„Ùˆ', primary: '#ff6b6b', bg: '#fff2f2', text: '#5e3b3b', isDark: false }, { id: 'theme-lavender', name: 'Ø§Ø³Ø·ÙˆØ®ÙˆØ¯ÙˆØ³', primary: '#8a63d2', bg: '#f7f4ff', text: '#4b3d60', isDark: false }, { id: 'theme-cotton-candy', name: 'Ù¾Ø´Ù…Ú©', primary: '#ff9dcb', bg: '#f0f8ff', text: '#5b6a78', isDark: false }, { id: 'theme-gummybear', name: 'Ù¾Ø§Ø³ØªÛŒÙ„ÛŒ', primary: '#ef476f', bg: '#ffffff', text: '#073b4c', isDark: false }, { id: 'theme-snes-light', name: 'SNES Ø±ÙˆØ´Ù†', primary: '#e60012', bg: '#e8e8e8', text: '#2c2c2c', isDark: false }, { id: 'theme-playstation-light', name: 'Ù¾Ù„ÛŒâ€ŒØ§Ø³ØªÛŒØ´Ù† Ø±ÙˆØ´Ù†', primary: '#006fcd', bg: '#eef2f7', text: '#333333', isDark: false }, { id: 'theme-gold-light', name: 'Ø·Ù„Ø§ÛŒ Ø±ÙˆØ´Ù†', primary: '#b59410', bg: '#fdfaf0', text: '#3d3419', isDark: false }, { id: 'theme-rose-gold-light', name: 'Ø±Ø²Ú¯Ù„Ø¯ Ø±ÙˆØ´Ù†', primary: '#b76e79', bg: '#fcf6f7', text: '#5c373d', isDark: false }, { id: 'theme-silver-light', name: 'Ù†Ù‚Ø±Ù‡â€ŒØ§ÛŒ Ø±ÙˆØ´Ù†', primary: '#8c8c8c', bg: '#f7f7f7', text: '#333333', isDark: false }, { id: 'theme-ios-light', name: 'iOS Ø±ÙˆØ´Ù†', primary: '#007aff', bg: '#f2f2f7', text: '#000000', isDark: false }, { id: 'theme-pastel-dream', name: 'Ø±ÙˆÛŒØ§ÛŒ Ù¾Ø§Ø³ØªÙ„ÛŒ', primary: '#ffc0cb', bg: '#fdf5f6', text: '#6d5458', isDark: false }, { id: 'theme-floral', name: 'Ú¯Ù„â€ŒÚ¯Ù„ÛŒ', primary: '#de5b83', bg: '#f9f2f5', text: '#573a45', isDark: false }, { id: 'theme-strawberry', name: 'ØªÙˆØªâ€ŒÙØ±Ù†Ú¯ÛŒ', primary: '#e53935', bg: '#fff2f2', text: '#5e3b3b', isDark: false }, { id: 'theme-blueberry', name: 'Ø¨Ù„ÙˆØ¨Ø±ÛŒ', primary: '#3f51b5', bg: '#f2f3ff', text: '#39405f', isDark: false }, { id: 'theme-apricot', name: 'Ø²Ø±Ø¯Ø¢Ù„Ùˆ', primary: '#fb8c00', bg: '#fff8f0', text: '#613800', isDark: false }, { id: 'theme-sky', name: 'Ø¢Ø³Ù…Ø§Ù†', primary: '#03a9f4', bg: '#f0f9ff', text: '#014361', isDark: false }, { id: 'theme-lilac', name: 'ÛŒØ§Ø³ÛŒ', primary: '#b39ddb', bg: '#f9f7fd', text: '#512da8', isDark: false }],
        classicLight: [ { id: 'theme-solarized-light', name: 'Ø³ÙˆÙ„Ø§Ø±Ø§ÛŒØ²Ø¯', primary: '#d33682', bg: '#fdf6e3', text: '#586e75', isDark: false }, { id: 'theme-gruvbox-light', name: 'Ú¯Ø±Ø§ÙˆØ¨Ø§Ú©Ø³', primary: '#d65d0e', bg: '#fbf1c7', text: '#3c3836', isDark: false }, { id: 'theme-daylight', name: 'Ø±ÙˆØ² Ø±ÙˆØ´Ù†', primary: '#007bff', bg: '#f0f8ff', text: '#212529', isDark: false }, { id: 'theme-paper', name: 'Ú©Ø§ØºØ°ÛŒ', primary: '#d94d41', bg: '#f7f6f1', text: '#3a3a3a', isDark: false }, { id: 'theme-classic-mac', name: 'Ù…Ú© Ú©Ù„Ø§Ø³ÛŒÚ©', primary: '#000000', bg: '#e0e0e0', text: '#000000', isDark: false }, { id: 'theme-blueprint', name: 'Ø¨Ù„ÙˆÙ¾Ø±ÛŒÙ†Øª', primary: '#295ddc', bg: '#eff3f9', text: '#333a56', isDark: false }, { id: 'theme-sepia', name: 'Ø³Ù¾ÛŒØ§', primary: '#704214', bg: '#fbf0d9', text: '#4a2d0b', isDark: false }, { id: 'theme-mint-choco', name: 'Ù†Ø¹Ù†Ø§ Ø´Ú©Ù„Ø§ØªÛŒ', primary: '#3d2b24', bg: '#f0fff0', text: '#513e36', isDark: false }, { id: 'theme-desert-oasis', name: 'ÙˆØ§Ø­Ù‡', primary: '#00bcd4', bg: '#faf3e0', text: '#7a6a53', isDark: false }, { id: 'theme-botanical', name: 'Ú¯ÛŒØ§Ù‡â€ŒØ´Ù†Ø§Ø³ÛŒ', primary: '#4caf50', bg: '#f5fcf5', text: '#3e503f', isDark: false }, { id: 'theme-e-ink', name: 'Ø¬ÙˆÙ‡Ø± Ø§Ù„Ú©ØªØ±ÙˆÙ†ÛŒÚ©', primary: '#000000', bg: '#f5f5f5', text: '#333333', isDark: false }, { id: 'theme-minimal-white', name: 'Ù…ÛŒÙ†ÛŒÙ…Ø§Ù„', primary: '#888888', bg: '#ffffff', text: '#222222', isDark: false }, { id: 'theme-newspaper', name: 'Ø±ÙˆØ²Ù†Ø§Ù…Ù‡', primary: '#d11c11', bg: '#f8f8f2', text: '#1c1c1a', isDark: false }, { id: 'theme-gameboy-light', name: 'Ú¯ÛŒÙ…â€ŒØ¨ÙˆÛŒ Ø±ÙˆØ´Ù†', primary: '#0f380f', bg: '#9bbc0f', text: '#0f380f', isDark: false }, { id: 'theme-dune-light', name: 'ØªÙ„â€ŒÙ…Ø§Ø³Ù‡ Ø±ÙˆØ´Ù†', primary: '#a0522d', bg: '#f4e8d8', text: '#5d4037', isDark: false }, { id: 'theme-vanilla', name: 'ÙˆØ§Ù†ÛŒÙ„ÛŒ', primary: '#8d6e63', bg: '#fdfcf7', text: '#4e342e', isDark: false }, { id: 'theme-pistachio', name: 'Ù¾Ø³ØªÙ‡â€ŒØ§ÛŒ', primary: '#7cb342', bg: '#f7fff2', text: '#33491c', isDark: false }, { id: 'theme-sand', name: 'Ø´Ù†ÛŒ', primary: '#c2b280', bg: '#fbf9f4', text: '#5a523c', isDark: false }, { id: 'theme-rose-quartz', name: 'Ø±Ø² Ú©ÙˆØ§Ø±ØªØ²', primary: '#f0a1b8', bg: '#fdf6f8', text: '#6b404c', isDark: false }, { id: 'theme-serenity', name: 'Ø¢Ø±Ø§Ù…Ø´', primary: '#92a8d1', bg: '#f6f8fd', text: '#444e60', isDark: false }]
    };
    const STORAGE_KEY = 'goal_tracker_data_v13_ltr';
    const STORAGE_ORDER = 'goal_tracker_order_v13_ltr';
    const STORAGE_ACTIVE_THEME = 'goal_tracker_active_theme_v5';
const WEEKDAY_NAMES_SHORT = ['Ø´', 'ÛŒ', 'Ø¯', 'Ø³', 'Ú†', 'Ù¾', 'Ø¬'];    const JALALI_MONTH_NAMES = ["ÙØ±ÙˆØ±Ø¯ÛŒÙ†", "Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª", "Ø®Ø±Ø¯Ø§Ø¯", "ØªÛŒØ±", "Ù…Ø±Ø¯Ø§Ø¯", "Ø´Ù‡Ø±ÛŒÙˆØ±", "Ù…Ù‡Ø±", "Ø¢Ø¨Ø§Ù†", "Ø¢Ø°Ø±", "Ø¯ÛŒ", "Ø¨Ù‡Ù…Ù†", "Ø§Ø³ÙÙ†Ø¯"];
        
    let appState = {
        currentWeek: getStartOfWeek(new Date()),
        goals: [], order: [], activeThemeId: 'theme-ios-dark', editing: null, showArchived: false,
        activeCategory: 'all',
        contextMenuGoalId: null,
        userLight: 'theme-ios-light',
        userDark: 'theme-ios-dark'
    };
    function toJalali(gy, gm, gd) { let g_d_m=[0,31,59,90,120,151,181,212,243,273,304,334];let jy=(gy<=1600)?0:979;gy-=(gy<=1600)?621:1600;let gy2=(gm>2)?(gy+1):gy;let days=(365*gy)+(parseInt((gy2+3)/4))-(parseInt((gy2+99)/100))+(parseInt((gy2+399)/400))-80+gd+g_d_m[gm-1];jy+=33*(parseInt(days/12053));days%=12053;jy+=4*(parseInt(days/1461));days%=1461;jy+=parseInt((days-1)/365);if(days>365)days=(days-1)%365;let jm=(days<186)?1+parseInt(days/31):7+parseInt((days-186)/30);let jd=1+((days<186)?(days%31):((days-186)%30));return[jy,jm,jd];}
    function toGregorian(jy, jm, jd) { let gy=(jy<=979)?621:1600;jy-=(jy<=979)?0:979;let days=(365*jy)+(parseInt(jy/33)*8)+(parseInt(((jy%33)+3)/4)) + 78 + jd + ((jm<7)?(jm-1)*31:((jm-7)*30)+186);gy+=400*(parseInt(days/146097));days%=146097;if(days>36524){gy+=100*(parseInt(--days/36524));days%=36524;if(days>=365)days++;}gy+=4*(parseInt(days/1461));days%=1461;gy+=parseInt((days-1)/365);if(days>365)days=(days-1)%365;let gd=days+1;let sal_a=[0,31,((gy%4===0&&gy%100!==0)||(gy%400===0))?29:28,31,30,31,30,31,31,30,31,30,31];let gm;for(gm=0;gm<13&&gd>sal_a[gm];gm++)gd-=sal_a[gm];return new Date(gy,gm-1,gd);}
    function isJalaliLeap(year) { return (((((year-474)%2820)+512)*682)%2816)<682; }
    function jalaliMonthLength(year, month) { if (month<=6) return 31; if (month<=11) return 30; if (isJalaliLeap(year)) return 30; return 29; }
    function toFa(num) { return (''+num).replace(/\d/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'[+d]); }
    function getStartOfWeek(date) { const d = new Date(date); d.setHours(0,0,0,0); const day = d.getDay(); const diff = (day + 1) % 7; d.setDate(d.getDate() - diff); return d; }
    function getWeekDates(base) { return Array.from({length:7}, (_,i) => { const d = new Date(base); d.setDate(base.getDate()+i); return d; }); }
    function formatWeekRange(base) { const week=getWeekDates(base); const startDate=week[0]; const endDate=week[6]; const [startJy, startJm, startJd]=toJalali(startDate.getFullYear(), startDate.getMonth()+1, startDate.getDate()); const [endJy, endJm, endJd]=toJalali(endDate.getFullYear(), endDate.getMonth()+1, endDate.getDate()); if (startJm === endJm) { const startDay=toFa(startJd); const endDay=toFa(endJd); const monthName=JALALI_MONTH_NAMES[startJm - 1]; return `${startDay} â€“ ${endDay} ${monthName}`; } else { const fmt=(d) => d.toLocaleDateString('fa-IR', { month: 'short', day: 'numeric' }); return `${fmt(startDate)} â€“ ${fmt(endDate)}`; }}
    function isToday(date) { const now = new Date(); return date.toDateString() === now.toDateString(); }
   function weekIdForDate(date) {
    const d = getStartOfWeek(date);
    // This creates a reliable YYYY-MM-DD format
    const month = (d.getMonth() + 1).toString().padStart(2, '0');
    const day = d.getDate().toString().padStart(2, '0');
    return `${d.getFullYear()}-${month}-${day}`;
}
    function escapeHtml(txt) { return (''+txt).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g, '&quot;'); }
function getDefaultGoals() {
        const creationDate = "2025-07-03T17:13:33.798Z";
        const goals = [
            { id: "default_2", name: "Ø®ÙˆØ§Ù†Ø¯Ù† Ú©ØªØ§Ø¨", emoji: "ğŸ“–", days: [true, true, true, true, true, true, true], history: { "2025-6-29": [ { entries:[], note:"" }, { entries:[], note:"" }, { entries:[], note:"" }, { entries:[], note:"" }, { entries:[], note:"" }, { entries:[], note:"" }, { entries:[], note:"" } ] }, type: "binary", archived: false, category: "Ø´Ø®ØµÛŒ", creationDate },
            { id: "1751566854259", name: "Ø±ÙØªÙ† Ø¨Ù‡ Ø¨Ø§Ø´Ú¯Ø§Ù‡", emoji: "ğŸ’ª", days: [true, true, true, true, true, true, true], history: {}, type: "binary", archived: false, category: "ÙˆØ±Ø²Ø´", creationDate },
            { id: "1751566870084", name: "ØªÙ…Ø±ÛŒÙ† Ù…ÙˆØ³ÛŒÙ‚ÛŒ", emoji: "ğŸ¸", days: [true, true, true, true, true, true, true], history: {}, type: "binary", archived: false, category: "Ø´Ø®ØµÛŒ", creationDate },
            { id: "1751566912252", name: "Ù¾ÛŒØ§Ø¯Ù‡ Ø±ÙˆÛŒ", emoji: "ğŸš¶", days: [true, true, true, true, true, true, true], history: {}, type: "binary", archived: false, category: "Ø³Ù„Ø§Ù…ØªÛŒ", creationDate },
            { id: "1751566952796", name: "Ø·Ø±Ø§Ø­ÛŒ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†", emoji: "ğŸ’»", days: [true, true, true, true, true, true, true], history: {}, type: "binary", archived: false, category: "Ú©Ø§Ø±", creationDate }
        ];
        const order = ["default_2", "1751566854259", "1751566870084", "1751566912252", "1751566952796"];
        return { goals, order };
    }
    function loadStateFromStorage() {
        const data = localStorage.getItem(STORAGE_KEY);
        const order = localStorage.getItem(STORAGE_ORDER);
        const activeThemeId = localStorage.getItem(STORAGE_ACTIVE_THEME) || 'theme-ios-dark';
        let goals, orderArr;
        if (data && order) {
            try {
                goals = JSON.parse(data);
                orderArr = JSON.parse(order);
            } catch (e) {
                console.error("Failed to parse localStorage data, resetting to default.", e);
                const defaults = getDefaultGoals();
                goals = defaults.goals;
                orderArr = defaults.order;
            }
        } else {
            const defaults = getDefaultGoals();
            goals = defaults.goals;
            orderArr = defaults.order;
        }
        goals.forEach(g => {
            g.type = g.type || 'binary';
            if (typeof g.archived === 'undefined') g.archived = false;
            if (typeof g.category === 'undefined') g.category = 'Ø´Ø®ØµÛŒ';
            if (typeof g.creationDate === 'undefined') g.creationDate = new Date().toISOString();
            if (g.history) {
                Object.values(g.history).forEach(week => {
                    if (Array.isArray(week)) {
                        week.forEach((day, i) => {
                            if (day && typeof day !== 'object') { week[i] = { entries: [day === 1 ? checkmarkSVG : 'âŒ'], note: '' }; }
                            else if (day && !day.entries) { week[i] = { entries: [], note: ''}; }
                        });
                    }
                });
            }
        });
        appState.goals = goals;
        appState.order = orderArr.filter(id => goals.some(g => g.id === id));
        appState.activeThemeId = activeThemeId;
        appState.userLight = localStorage.getItem('goal_tracker_user_light_theme') || 'theme-ios-light';
        appState.userDark = localStorage.getItem('goal_tracker_user_dark_theme') || 'theme-ios-dark';
    }
    function persistState() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(appState.goals));
        localStorage.setItem(STORAGE_ORDER, JSON.stringify(appState.order));
        localStorage.setItem('goal_tracker_user_light_theme', appState.userLight);
        localStorage.setItem('goal_tracker_user_dark_theme', appState.userDark);
    }
    function setActiveTheme(themeId, fromToggle = false) {
        const theme = findThemeById(themeId);
        if (!theme) return;

        appState.activeThemeId = themeId;
        localStorage.setItem(STORAGE_ACTIVE_THEME, themeId);
        
        if (!fromToggle) {
             if(theme.isDark) {
                appState.userDark = themeId;
            } else {
                appState.userLight = themeId;
            }
        }
        
        applyActiveTheme();
        updateDarkModeToggleState();
    }
    function findThemeById(themeId) {
        for (const category in themesData) {
            const found = themesData[category].find(t => t.id === themeId);
            if (found) return found;
        }
        return themesData.classicDark.find(t => t.id === 'theme-ios-dark'); // Fallback
    }
 // REPLACE the old applyActiveTheme function with this one:
function applyActiveTheme() {
    const theme = findThemeById(appState.activeThemeId);
    const styleEl = document.getElementById('dynamic-theme-style');
    document.documentElement.classList.toggle('dark', theme.isDark);
    const primaryColor = theme.primary.replace('#', '');
    const r = parseInt(primaryColor.substr(0, 2), 16);
    const g = parseInt(primaryColor.substr(2, 2), 16);
    const b = parseInt(primaryColor.substr(4, 2), 16);
    const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
    const primaryTextColor = (yiq >= 128) ? '#000000' : '#ffffff';

    const cardColor = theme.card || (theme.isDark ? `rgba(255, 255, 255, 0.07)` : `#ffffff`);
    const headerColor = theme.header || (theme.isDark ? `${theme.bg}cc` : `#ffffffcc`);
    const cellInactiveColor = theme.cellInactive || (theme.isDark ? 'rgba(255, 255, 255, 0.08)' : '#e5e7eb');
    
    // Logic to handle custom completed cell color
    const completedColor = theme.completedBg ? theme.completedBg : `${theme.primary}20`;
    const darkCompletedColor = theme.completedBg ? theme.completedBg : `${theme.primary}30`;

    styleEl.innerHTML = `
      :root {
        --color-primary: ${theme.primary};
        --color-primary-text: ${primaryTextColor};
        --color-primary-shadow: ${theme.primary}50;
        --color-bg: ${theme.bg};
        --color-text: ${theme.text};
        --color-text-muted: ${theme.isDark ? '#a0a0a0' : '#6b7280'};
        --color-card: ${cardColor};
        --color-header: ${headerColor};
        --color-border: ${theme.isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'};
        --color-hover: ${theme.isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)'};
        --color-cell-inactive: ${cellInactiveColor};
      }
      .day-completed { background-color: ${completedColor} !important; }
      .dark .day-completed { background-color: ${darkCompletedColor} !important; }
    `;
}
    // --- RENDER FUNCTIONS ---
// REPLACE your existing fullRender function
function fullRender() {
    applyActiveTheme();
    renderHeader();
    renderSettingsMenu(); // This call is added
    renderCategoryMenu();
    renderMobileMenu();
    renderGoals();
    initSortable();
    setupCellListeners();
    updateDarkModeToggleState();
    if (appState.editing) {
        setTimeout(() => initEditInput(appState.editing), 30);
    }
}
    function renderHeader() {
        const weekTitleText = formatWeekRange(appState.currentWeek);
        document.getElementById('weekTitle').innerText = weekTitleText;
        document.getElementById('weekTitleMobile').innerText = weekTitleText;

        const today = new Date();
        const formattedDate = today.toLocaleDateString('fa-IR', { weekday: 'long', month: 'long', day: 'numeric' });
        document.getElementById('todayBtn').innerText = `Ø§Ù…Ø±ÙˆØ²: ${formattedDate}`;
        
        const weekDates = getWeekDates(appState.currentWeek);
        document.getElementById('weekdayRow').innerHTML = weekDates.map((d, i) => {
            const dayNumber = toFa(new Date(d).toLocaleDateString('fa-IR-u-nu-latn', { day: 'numeric' }));
            const dayName = WEEKDAY_NAMES_SHORT[i];
            let classes = "flex flex-col items-center justify-center p-2 rounded-lg transition-colors text-app-text-muted";
            if (isToday(d)) {
                classes = "flex flex-col items-center justify-center p-2 rounded-lg transition-colors bg-primary text-primary-text font-bold shadow-lg";
            }
            return `<div class="${classes}" data-day="${i}"><span class="text-sm font-semibold">${dayName}</span><span class="text-xs mt-1">${dayNumber}</span></div>`;
        }).join('');
    }
    function renderCategoryMenu() {
        const menu = document.getElementById('categoryMenu');
        const filters = ['all', ...Object.keys(CATEGORIES)];
        const catButton = document.getElementById('categoryMenuBtn');
        if(appState.activeCategory !== 'all') { catButton.classList.add('text-primary'); }
        else { catButton.classList.remove('text-primary'); }
                
        let html = filters.map(cat => {
            const isActive = appState.activeCategory === cat;
            const activeClass = 'bg-app-hover font-bold text-primary';
            return `<button data-category="${cat}" class="w-full text-left flex items-center gap-3 p-3 hover:bg-app-hover rounded-lg transition-colors ${isActive ? activeClass : ''}">${cat === 'all' ? 'Ù‡Ù…Ù‡ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§' : cat}</button>`;
        }).join('');
        menu.innerHTML = html;
    }
    function renderMobileMenu() {
        const content = document.getElementById('mobileMenuContent');
        const today = new Date();
        const formattedDate = today.toLocaleDateString('fa-IR', { weekday: 'long', month: 'long', day: 'numeric' });
        const weekTitleText = formatWeekRange(appState.currentWeek);

        const filters = ['all', ...Object.keys(CATEGORIES)];
        const catHtml = filters.map(cat => {
            const isActive = appState.activeCategory === cat;
            const activeClass = 'bg-primary/20 text-primary font-bold';
            return `<button data-category="${cat}" class="w-full text-right flex items-center gap-3 p-3 hover:bg-app-hover rounded-lg transition-colors ${isActive ? activeClass : ''}">${cat === 'all' ? 'Ù‡Ù…Ù‡ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§' : cat}</button>`;
        }).join('');

        const showArchived = appState.showArchived;
        const isDark = findThemeById(appState.activeThemeId).isDark;

        content.innerHTML = `
            <button id="mobile-todayBtn" class="w-full text-center text-lg p-3 rounded-lg font-semibold hover:bg-app-hover transition-colors">${formattedDate}</button>
            <div class="flex items-center justify-center gap-2 bg-app-card p-2 rounded-xl">
                 <button id="mobile-prevWeekBtn" aria-label="Previous Week" class="flex-1 flex items-center justify-center gap-x-2 text-app-text-muted hover:bg-app-hover rounded-full px-3 py-2 transition-colors">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                    <span class="text-sm font-medium">Ù‚Ø¨Ù„ÛŒ</span>
                </button>
                 <div class="text-base font-bold text-primary w-40 text-center">${weekTitleText}</div>
                <button id="mobile-nextWeekBtn" aria-label="Next Week" class="flex-1 flex items-center justify-center gap-x-2 text-app-text-muted hover:bg-app-hover rounded-full px-3 py-2 transition-colors">
                    <span class="text-sm font-medium">Ø¨Ø¹Ø¯ÛŒ</span>
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </button>
            </div>
            <div class="my-4 h-px bg-app-border"></div>
            <h3 class="font-bold text-lg text-app-text-muted px-2">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§</h3>
            <div class="space-y-1">${catHtml}</div>
            <div class="my-4 h-px bg-app-border"></div>
            <h3 class="font-bold text-lg text-app-text-muted px-2">ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h3>
            <div class="space-y-1">
                 <button id="mobile-reportBtn" class="w-full text-left flex items-center gap-3 p-3 hover:bg-app-hover rounded-lg transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                    <span>Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§</span>
                </button>
                <button id="mobile-archiveToggleBtn" class="w-full text-left flex items-center gap-3 p-3 hover:bg-app-hover rounded-lg transition-colors ${showArchived ? 'text-primary font-bold' : ''}">
                   <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                    <span>Ù†Ù…Ø§ÛŒØ´ Ø¢Ø±Ø´ÛŒÙˆ</span>
                </button>
                 <button id="mobile-themeSelectorBtn" class="w-full text-left flex items-center gap-3 p-3 hover:bg-app-hover rounded-lg transition-colors">
                    <span class="text-xl w-5 text-center">ğŸ¨</span>
                    <span>Ø§Ù†ØªØ®Ø§Ø¨ ØªÙ…</span>
                </button>
                <div class="my-1 h-px bg-app-border"></div>
                <div class="w-full text-left flex items-center justify-between gap-3 p-3">
                    <div class="flex items-center gap-3">
                        <span class="text-xl w-5 text-center">ğŸŒ—</span>
                        <span>Ø­Ø§Ù„Øª ØªÛŒØ±Ù‡</span>
                    </div>
                    <label for="darkModeToggleMobile" class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" value="" id="darkModeToggleMobile" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                    </label>
                </div>
                <div class="my-1 h-px bg-app-border"></div>
                <button id="mobile-backupBtn" class="w-full text-left flex items-center gap-3 p-3 hover:bg-app-hover rounded-lg transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M12 15l-3-3m0 0l3-3m-3 3h12" /> </svg>
                    <span>Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ</span>
                </button>
                 <button id="mobile-aboutBtn" class="w-full text-left flex items-center gap-3 p-3 hover:bg-app-hover rounded-lg transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">  <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /> </svg>
                    <span>Ø¯Ø±Ø¨Ø§Ø±Ù‡</span>
                </button>
            </div>
        `;
    }
    function renderGoals() {
        const filteredGoals = appState.order
            .map(id => appState.goals.find(g => g.id === id))
            .filter(Boolean)
            .filter(g => !g.archived && (appState.activeCategory === 'all' || g.category === appState.activeCategory));
        const archivedGoals = appState.goals.filter(g => g && g.archived);
        document.getElementById('goalList').innerHTML = filteredGoals.map(renderSingleGoalCard).join('');
        const archivedContainer = document.getElementById('archivedGoalList');
        if (appState.showArchived && archivedGoals.length > 0) {
            archivedContainer.classList.remove('hidden');
            archivedContainer.querySelector('.flex').innerHTML = archivedGoals.map(renderSingleGoalCard).join('');
        } else {
            archivedContainer.classList.add('hidden');
        }
    }
   function renderSingleGoalCard(goal) {
    const weekDates = getWeekDates(appState.currentWeek);
    const currentWeekId = weekIdForDate(appState.currentWeek);
    const { weekly, allTime } = calculateScores(goal); // Ø¯Ø±ÛŒØ§ÙØª Ø´Ù…Ø§Ø±Ø´Ú¯Ø± Ú©Ù„
    const streak = calculateStreak(goal);
    const dayCellsHtml = weekDates.map((date, i) => {
        const weekDayIndexForData = (i + 6) % 7;
        const isActive = !!goal.days[weekDayIndexForData];
        const dayData = goal.history?.[currentWeekId]?.[weekDayIndexForData] || { entries: [], note: '' };
        const dayCompleted = dayData.entries.length > 0;
        const baseClasses = "goal-day group aspect-square rounded-full flex items-center justify-center relative transition-colors cursor-pointer";
        const activeClasses = "active bg-app-cell-inactive hover:opacity-80";
        const disabledClasses = "bg-app-bg opacity-60 !cursor-not-allowed";
        let classes = `${baseClasses} ${isActive ? activeClasses : disabledClasses}`;
        if(dayCompleted) classes += ' day-completed';
        if (isActive && isToday(date)) classes += ` ring-2 ring-sky-500 shadow-md shadow-sky-500/30`;
        let cellContent = `<div class="w-full h-full flex flex-wrap items-center justify-center gap-px leading-none">${dayData.entries.map(em => {
            if (!em) return '';
            if (em.startsWith('<svg')) return `<span class="inline-flex items-center justify-center w-8 h-8">${em}</span>`;
            return `<span class="text-sm md:text-base">${escapeHtml(em)}</span>`;
        }).join('')}</div>`;
        return `<div class="${classes}" data-goal-id="${goal.id}" data-day-index="${weekDayIndexForData}" tabindex="0">${cellContent}${dayData.note ? `<div class="absolute top-0 right-0 w-2 h-2 bg-amber-400 rounded-full" title="${escapeHtml(dayData.note)}"></div>` : ''}</div>`;
    }).join('');

    // Ø¨Ø®Ø´ Ø¢Ù…Ø§Ø± Ø¨Ø§ Ø¢ÛŒÚ©ÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ø´Ø¯
    const statsHtml = `<div class="goal-stats-desktop hidden md:flex items-center gap-x-4 text-xs font-medium text-app-text-muted whitespace-nowrap">
        <span class="flex items-center gap-1" title="Ú©Ù„"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg><span>${toFa(allTime)}</span></span>
        <span class="flex items-center gap-1" title="Ø§Ø³ØªØ±ÛŒÚ©"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg><span>${toFa(streak)}</span></span>
        <span class="flex items-center gap-1" title="Ù‡ÙØªÙ‡"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg><span>${toFa(weekly)}</span></span>
    </div>`;

    return `<div class="goal-card bg-app-card shadow-md rounded-2xl p-4 goal-anim-in ${goal.archived ? 'opacity-60' : ''}" data-id="${goal.id}">
        <div class="flex items-center gap-3 mb-4">
            <div class="emoji-container text-2xl md:text-3xl">${goal.emoji || 'ğŸ¯'}</div>
            <div class="flex-grow min-w-0">
                ${appState.editing === goal.id
                    ? `<input class="w-full bg-app-cell-inactive text-base md:text-lg font-bold p-2 rounded-lg outline-none focus:ring-2 focus:ring-primary" id="edit-${goal.id}" value="${escapeHtml(goal.name)}" />`
                    : `<h3 class="text-base md:text-lg font-bold truncate cursor-pointer hover:text-primary" onclick="showGoalHeatmapModal('${goal.id}')">${escapeHtml(goal.name || 'Ø¨ÛŒâ€ŒÙ†Ø§Ù…')}</h3>`
                }
            </div>
            <div class="flex-shrink-0 flex items-center gap-3 ml-auto">
                ${statsHtml} <button onclick="showContextMenu(event, '${goal.id}')" class="text-app-text-muted hover:bg-app-hover rounded-full p-2 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" /></svg>
                </button>
                ${!goal.archived ? `<div class="goal-handle text-app-text-muted cursor-grab p-2 text-xl">&#x2630;</div>`: ''}
            </div>
        </div>
        <div class="grid grid-cols-7 gap-2">${dayCellsHtml}</div>
    </div>`;
}
    // --- CALCULATIONS ---
   function getHistoricalDayInfo(goal, targetDate) {
    const d = new Date(targetDate);
    d.setHours(0, 0, 0, 0);
    const dayIndex = d.getDay();

    const startOfWeekDate = getStartOfWeek(d);
    // Use the exact same reliable YYYY-MM-DD format for reading
    const month = (startOfWeekDate.getMonth() + 1).toString().padStart(2, '0');
    const day = startOfWeekDate.getDate().toString().padStart(2, '0');
    const weekId = `${startOfWeekDate.getFullYear()}-${month}-${day}`;

    const dayData = goal.history?.[weekId]?.[dayIndex];
    const entryCount = dayData?.entries?.length || 0;
    
    return { dayIndex, entryCount };
}
    function getEntryCountOnDate(goal, date) { return getHistoricalDayInfo(goal, date).entryCount; }
function calculateStreak(goal) {
    let streak = 0;
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const isScheduledToday = goal.days[today.getDay()];
    const isCompleteToday = getEntryCountOnDate(goal, today) > 0;

    let dateToCheck = new Date(today);

    if (isScheduledToday && !isCompleteToday) {
        // If scheduled for today but not done, the current streak is 0.
        return 0;
    }
    
    if (!isScheduledToday) {
        // If not scheduled for today, start counting from yesterday.
        dateToCheck.setDate(dateToCheck.getDate() - 1);
    }
    // If it was scheduled and completed today, the count will start from today.

    for (let i = 0; i < 365 * 5; i++) {
        const dayOfWeek = dateToCheck.getDay();
        const isScheduled = goal.days[dayOfWeek];
        
        if (isScheduled) {
            const isComplete = getEntryCountOnDate(goal, dateToCheck) > 0;
            if (isComplete) {
                streak++;
            } else {
                // If it was scheduled but not complete, the streak is broken.
                break;
            }
        }
        // If not scheduled for a given day, we ignore it and continue the streak.
        
        dateToCheck.setDate(dateToCheck.getDate() - 1);
    }
    
    return streak;
}
function calculateScores(goal) {
    let weekly = 0;
    let allTime = 0;
    const currentWeekId = weekIdForDate(appState.currentWeek);

    if (goal.history) {
        for (const weekId in goal.history) {
            const weekData = goal.history[weekId];
            if (!weekData) continue;

            weekData.forEach((dayData) => {
                if (dayData && dayData.entries) {
                    const entryCount = dayData.entries.length;
                    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ Ø´Ù…Ø§Ø±Ø´Ú¯Ø± Ú©Ù„
                    allTime += entryCount;
                    // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¢Ù…Ø§Ø± Ù‡ÙØªÚ¯ÛŒ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù‡ÙØªÙ‡ Ø¬Ø§Ø±ÛŒ
                    if (weekId === currentWeekId) {
                        weekly += entryCount;
                    }
                }
            });
        }
    }
    return { weekly, allTime };
}
    // --- MODALS & MENUS ---
    function closeModal() { const modalArea=document.getElementById('modalArea'); if (modalArea.lastElementChild) { modalArea.removeChild(modalArea.lastElementChild); } }
    function closeContextMenu() { const menu=document.getElementById('contextMenu'); menu.style.display='none'; appState.contextMenuGoalId=null; }
    function toggleSettingsMenu(visible) { const menu=document.getElementById('settingsMenu'); menu.classList.toggle('visible',visible); if(visible){setTimeout(()=>document.addEventListener('click',closeSettingsMenuOnClickOutside,{once:true}),10);} }
    function closeSettingsMenuOnClickOutside(e) { if (!e.target.closest('#settingsMenu') && !e.target.closest('#settingsMenuBtn') && !e.target.closest('#settingsMenuBtnMobile')) { toggleSettingsMenu(false); } else { document.addEventListener('click', closeSettingsMenuOnClickOutside, { once: true }); } }
    function toggleCategoryMenu(visible) { const menu=document.getElementById('categoryMenu'); menu.classList.toggle('visible',visible); if(visible){setTimeout(()=>document.addEventListener('click',closeCategoryMenuOnClickOutside,{once:true}),10);} }
    function closeCategoryMenuOnClickOutside(e) { if (!e.target.closest('#categoryMenu') && !e.target.closest('#categoryMenuBtn')) { toggleCategoryMenu(false); } else { document.addEventListener('click', closeCategoryMenuOnClickOutside, { once: true }); } }
    
    function showThemeSelectorModal() {
        closeModal();
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4';
        
        const themeCategories = [
            { key: 'modernDark', title: 'Ù…Ø¯Ø±Ù† ØªÛŒØ±Ù‡' },
            { key: 'classicDark', title: 'Ú©Ù„Ø§Ø³ÛŒÚ© ØªÛŒØ±Ù‡' },
            { key: 'modernLight', title: 'Ù…Ø¯Ø±Ù† Ø±ÙˆØ´Ù†' },
            { key: 'classicLight', title: 'Ú©Ù„Ø§Ø³ÛŒÚ© Ø±ÙˆØ´Ù†' }
        ];

        let activeTabKey = findThemeById(appState.activeThemeId).isDark ? 'modernDark' : 'modernLight';
        for (const cat of themeCategories) {
            if (themesData[cat.key].some(t => t.id === appState.activeThemeId)) {
                activeTabKey = cat.key;
                break;
            }
        }
    
        const tabButtonsHtml = themeCategories.map((cat) =>
            `<button data-tab="${cat.key}" class="tab-btn flex-1 p-3 font-semibold text-sm rounded-lg transition-colors ${cat.key === activeTabKey ? 'bg-primary text-primary-text' : 'text-app-text-muted hover:bg-app-hover'}">${cat.title}</button>`
        ).join('');
    
        const tabContentsHtml = themeCategories.map((cat) => {
            let themesHtml = themesData[cat.key].map(theme => {
                const isActive = theme.id === appState.activeThemeId;
                return `
                    <button data-theme-id="${theme.id}" class="theme-btn w-full text-right p-3 rounded-lg flex items-center gap-4 transition-colors ${isActive ? 'bg-primary/20 ring-2 ring-primary' : 'hover:bg-app-hover'}">
                        <div class="flex-shrink-0 h-10 w-10 rounded-full flex items-center justify-center" style="background-color:${theme.bg}; border: 2px solid ${theme.primary};">
                             <div class="w-4 h-4 rounded-full" style="background-color: ${theme.text}"></div>
                        </div>
                        <span class="font-semibold">${theme.name}</span>
                        ${isActive ? '<span class="ml-auto text-primary font-bold">âœ“</span>' : ''}
                    </button>
                `;
            }).join('');
            return `<div id="tab-content-${cat.key}" class="tab-content grid grid-cols-1 sm:grid-cols-2 gap-2 ${cat.key !== activeTabKey ? 'hidden' : ''}">${themesHtml}</div>`;
        }).join('');
    
        modal.innerHTML = `
            <div class="modal-content glass-modal-content rounded-2xl p-4 sm:p-6 w-full max-w-4xl max-h-[90vh] flex flex-col shadow-2xl">
                <div class="flex-shrink-0 flex justify-between items-center mb-4">
                    <h2 class="text-xl sm:text-2xl font-bold text-app-text">Ø§Ù†ØªØ®Ø§Ø¨ ØªÙ…</h2>
                    <button class="close-modal-btn text-app-text-muted hover:bg-app-hover rounded-full p-2 transition-colors">&times;</button>
                </div>
                <div class="flex-shrink-0 flex flex-wrap items-center gap-2 p-1 mb-4 bg-app-card rounded-xl">
                    ${tabButtonsHtml}
                </div>
                <div class="flex-grow overflow-y-auto space-y-3 p-1 -ml-2 pl-2 no-scrollbar">
                    ${tabContentsHtml}
                </div>
            </div>`;
    
        document.getElementById('modalArea').appendChild(modal);
        modal.onclick = e => { if (e.target === modal || e.target.closest('.close-modal-btn')) closeModal(); };
    
        modal.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.dataset.tab;
                modal.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('bg-primary', 'text-primary-text');
                    btn.classList.add('text-app-text-muted', 'hover:bg-app-hover');
                });
                button.classList.add('bg-primary', 'text-primary-text');
                button.classList.remove('text-app-text-muted', 'hover:bg-app-hover');
    
                modal.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                modal.querySelector(`#tab-content-${tabId}`).classList.remove('hidden');
            });
        });
        
        modal.querySelectorAll('.theme-btn').forEach(button => {
            button.addEventListener('click', () => {
                setActiveTheme(button.dataset.themeId);
                showThemeSelectorModal(); // Re-render modal to update checkmark
            });
        });
    }
    function showAboutModal() { const modal=document.createElement('div');modal.className='fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4';modal.innerHTML=`<div class="modal-content glass-modal-content rounded-2xl p-6 w-full max-w-md shadow-2xl"><div class="flex flex-col items-center text-center"><div class="w-24 h-24 bg-app-card rounded-3xl flex items-center justify-center mb-5 border border-app-border shadow-md"><img src="https://i.ibb.co/kV0P6jz5/rooza-app.png" alt="Rooza Logo" class="w-16 h-16"/></div><h2 class="text-2xl font-bold mb-2 text-app-text">Ø±ÙˆØ²Ø§ (Rooza)</h2><p class="text-base text-app-text-muted mb-6">Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ù…Ø¯ÛŒØ±ÛŒØª Ø¹Ø§Ø¯Øª Ùˆ Ù‡Ø¯Ù Ø´Ø®ØµÛŒ</p><div class="text-sm text-app-text-muted space-y-2"><p>Ù†Ø³Ø®Ù‡ 0.01-ltr</p><p>Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ú©Ù…Ú© Ø¨Ù‡ Ø´Ù…Ø§ Ø¯Ø± Ø³Ø§Ø®ØªÙ† Ø¹Ø§Ø¯Ø§Øª Ø¨Ù‡ØªØ±.</p><p>Ú©Ù¾ÛŒ Ø±Ø§ÛŒØª Â© ${new Date().getFullYear()} - Rooza</p></div><button class="close-modal-btn w-full mt-8 p-3 rounded-lg font-bold bg-primary text-primary-text hover:opacity-90 transition-all">Ø¨Ø³ØªÙ†</button></div></div>`;document.getElementById('modalArea').appendChild(modal);modal.onclick=e=>{if(e.target===modal||e.target.closest('.close-modal-btn'))closeModal();};}
    function showBackupModal() { const modal=document.createElement('div');modal.className='fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4';modal.innerHTML=`<div class="modal-content glass-modal-content rounded-2xl p-6 w-full max-w-lg shadow-2xl max-h-[90vh] overflow-y-auto no-scrollbar"><div class="flex justify-between items-center mb-5"><h2 class="text-2xl font-bold text-app-text">Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ Ùˆ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ</h2><button class="close-modal-btn text-app-text-muted hover:bg-app-hover rounded-full p-2 transition-colors">&times;</button></div><div class="space-y-6"><div class="bg-app-card/50 p-5 rounded-xl border border-app-border"><div class="flex items-start gap-4"><div class="flex-shrink-0 w-12 h-12 rounded-full bg-green-500/10 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg></div><div><h3 class="font-bold text-lg text-app-text">Ø®Ø±ÙˆØ¬ÛŒ Ú¯Ø±ÙØªÙ† Ø§Ø·Ù„Ø§Ø¹Ø§Øª</h3><p class="text-sm text-app-text-muted mt-1 mb-4">ÛŒÚ© ÙØ§ÛŒÙ„ JSON Ø§Ø² ØªÙ…Ø§Ù… Ø§Ù‡Ø¯Ø§Ù Ùˆ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø®ÙˆØ¯ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯.</p><button id="exportBtn" class="w-full sm:w-auto px-5 py-2.5 rounded-lg font-bold bg-green-600 text-white hover:bg-green-700 transition-colors">Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù†</button></div></div></div><div class="bg-app-card/50 p-5 rounded-xl border border-app-border"><div class="flex items-start gap-4"><div class="flex-shrink-0 w-12 h-12 rounded-full bg-sky-500/10 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-sky-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg></div><div><h3 class="font-bold text-lg text-app-text">ÙˆØ±ÙˆØ¯ÛŒ Ú¯Ø±ÙØªÙ† Ø§Ø·Ù„Ø§Ø¹Ø§Øª</h3><p class="text-sm text-app-text-muted mt-1 mb-4">ÛŒÚ© ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù† JSON Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø®ÙˆØ¯ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</p><div class="p-3 mb-4 rounded-lg bg-amber-500/10 border border-amber-500/20 text-amber-600 dark:text-amber-400 text-sm"><strong>Ù‡Ø´Ø¯Ø§Ø±:</strong> Ø§ÛŒÙ† Ø¹Ù…Ù„ ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ¹Ù„ÛŒ Ø´Ù…Ø§ Ø±Ø§ Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ø®ÙˆØ§Ù‡Ø¯ Ú©Ø±Ø¯.</div><button id="importBtn" class="w-full sm:w-auto px-5 py-2.5 rounded-lg font-bold bg-sky-600 text-white hover:bg-sky-700 transition-colors">Ø§Ù†ØªØ®Ø§Ø¨ ÙØ§ÛŒÙ„ Ùˆ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ</button></div></div></div></div><input type="file" id="importFile" class="hidden" accept=".json"></div>`;document.getElementById('modalArea').appendChild(modal);modal.onclick=e=>{if(e.target===modal||e.target.closest('.close-modal-btn'))closeModal();};modal.querySelector('#exportBtn').onclick=exportData;modal.querySelector('#importBtn').onclick=()=>document.getElementById('importFile').click();modal.querySelector('#importFile').onchange=importData;}
    function exportData(){try{const dataToExport={goals:appState.goals,order:appState.order,userLight:appState.userLight,userDark:appState.userDark};const dataStr=JSON.stringify(dataToExport,null,2);const dataBlob=new Blob([dataStr],{type:"application/json"});const url=URL.createObjectURL(dataBlob);const link=document.createElement('a');const today=new Date().toISOString().slice(0,10);link.download=`rooza-backup-${today}.json`;link.href=url;link.click();URL.revokeObjectURL(url);closeModal();}catch(error){console.error("Error exporting data:",error);alert("Ø®Ø·Ø§ Ø¯Ø± Ø®Ø±ÙˆØ¬ÛŒ Ú¯Ø±ÙØªÙ† Ø§Ø·Ù„Ø§Ø¹Ø§Øª.");}}
    function importData(event){const file=event.target.files[0];if(!file)return;if(!confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ Ø¨Ø§ ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¬Ø¯ÛŒØ¯ØŒ ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ¹Ù„ÛŒ Ø´Ù…Ø§ Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯. Ø§ÛŒÙ† Ø¹Ù…Ù„ ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø³Øª.")){return;}const reader=new FileReader();reader.onload=(e)=>{try{const importedData=JSON.parse(e.target.result);if(importedData&&Array.isArray(importedData.goals)&&Array.isArray(importedData.order)){appState.goals=importedData.goals;appState.order=importedData.order;if(importedData.userLight) appState.userLight = importedData.userLight;if(importedData.userDark) appState.userDark = importedData.userDark;persistState();loadStateFromStorage();fullRender();closeModal();alert("Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙˆØ§Ø±Ø¯ Ø´Ø¯.");}else{throw new Error("Invalid file format.");}}catch(error){console.error("Error importing data:",error);alert("Ø®Ø·Ø§ Ø¯Ø± ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª. ÙØ§ÛŒÙ„ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.");}};reader.readAsText(file);}
    // --- ACTIONS & LISTENERS ---
    window.editGoal = (goalId) => { const goal = appState.goals.find(g => g.id === goalId); if(goal) showGoalModal(goal); };
    window.startEdit = (goalId) => { appState.editing = goalId; fullRender(); };
    function handleDarkModeToggle() {
        const currentTheme = findThemeById(appState.activeThemeId);
        if (currentTheme.isDark) {
            setActiveTheme(appState.userLight, true);
        } else {
            setActiveTheme(appState.userDark, true);
        }
        fullRender();
    }
    function updateDarkModeToggleState() {
        const isDark = findThemeById(appState.activeThemeId).isDark;
        const desktopToggle = document.getElementById('darkModeToggle');
        const mobileToggle = document.getElementById('darkModeToggleMobile');
        if (desktopToggle) desktopToggle.checked = isDark;
        if (mobileToggle) mobileToggle.checked = isDark;
    }
   // REPLACE your existing setupGlobalListeners function
function setupGlobalListeners() {
    document.getElementById('navbar').onclick = e => {
        const target = e.target.closest('button');
        if(!target) return;
        switch(target.id) {
            case 'prevWeekBtn': appState.currentWeek.setDate(appState.currentWeek.getDate() - 7); fullRender(); break;
            case 'nextWeekBtn': appState.currentWeek.setDate(appState.currentWeek.getDate() + 7); fullRender(); break;
            case 'settingsMenuBtn':
            case 'settingsMenuBtnMobile':
                 toggleSettingsMenu(!document.getElementById('settingsMenu').classList.contains('visible')); break;
            case 'categoryMenuBtn': toggleCategoryMenu(!document.getElementById('categoryMenu').classList.contains('visible')); break;
            case 'todayBtn': appState.currentWeek = getStartOfWeek(new Date()); fullRender(); break;
            // This line is changed for RTL
            case 'hamburgerBtn': document.getElementById('mobileMenu').classList.remove('translate-x-full'); break;
        }
    };
    document.getElementById('settingsMenu').addEventListener('click', e => {
        const button = e.target.closest('button');
        if (!button) return;
        switch (button.id) {
            case 'reportBtn': showReportModal(); break;
            case 'archiveToggleBtn': appState.showArchived = !appState.showArchived; button.classList.toggle('text-primary', appState.showArchived); fullRender(); break;
            case 'themeSelectorBtn': showThemeSelectorModal(); break;
            case 'aboutBtn': showAboutModal(); break;
            case 'backupBtn': showBackupModal(); break;
        }
        if(button.id !== 'archiveToggleBtn') toggleSettingsMenu(false);
    });
    document.getElementById('fab').onclick = () => showGoalModal(null);
    document.getElementById('categoryMenu').addEventListener('click', e => {
        const button = e.target.closest('button[data-category]');
        if (button) {
            appState.activeCategory = button.dataset.category;
            toggleCategoryMenu(false);
            fullRender();
        }
    });
    document.getElementById('mobileMenu').addEventListener('click', e => {
        const button = e.target.closest('button');
        if(!button) return;
        let shouldClose = true;
        switch(button.id) {
            case 'closeMobileMenuBtn': break;
            case 'mobile-todayBtn': appState.currentWeek = getStartOfWeek(new Date()); fullRender(); break;
            case 'mobile-prevWeekBtn': appState.currentWeek.setDate(appState.currentWeek.getDate() - 7); fullRender(); shouldClose = false; break;
            case 'mobile-nextWeekBtn': appState.currentWeek.setDate(appState.currentWeek.getDate() + 7); fullRender(); shouldClose = false; break;
            case 'mobile-reportBtn': showReportModal(); break;
            case 'mobile-archiveToggleBtn': appState.showArchived = !appState.showArchived; fullRender(); shouldClose = false; break;
            case 'mobile-themeSelectorBtn': showThemeSelectorModal(); break;
            case 'mobile-backupBtn': showBackupModal(); break;
            case 'mobile-aboutBtn': showAboutModal(); break;
            default: shouldClose = false; break;
        }
        if (button.dataset.category) {
            appState.activeCategory = button.dataset.category;
            fullRender();
            shouldClose = true;
        }
        if (shouldClose) {
            // This line is changed for RTL
            document.getElementById('mobileMenu').classList.add('translate-x-full');
        }
    });
    document.body.addEventListener('change', e => {
        if (e.target.id === 'darkModeToggle' || e.target.id === 'darkModeToggleMobile') {
            handleDarkModeToggle();
        }
    });
}
    let sortable = null;
    loadStateFromStorage();
    fullRender();
    setupGlobalListeners();
    // --- All other functions (deleteGoal, addCheckmark, showGoalModal etc.) are assumed to be here ---
    function initEditInput(goalId) { const el=document.getElementById('edit-'+goalId);if(!el)return;el.focus();el.select();const saveAndExit=()=>{if(appState.editing!==goalId)return;const goal=appState.goals.find(g=>g.id===goalId);if(goal)goal.name=el.value.trim()||'Ø¨ÛŒâ€ŒÙ†Ø§Ù…';persistState();appState.editing=null;fullRender();};el.onblur=saveAndExit;el.onkeydown=(e)=>{if(e.key==="Enter")el.blur();if(e.key==="Escape"){appState.editing=null;fullRender();}};}
    window.duplicateGoal=(goalId)=>{const originalGoal=appState.goals.find(g=>g.id===goalId);if(originalGoal){const newGoal=JSON.parse(JSON.stringify(originalGoal));newGoal.id=''+Date.now();newGoal.name=`${originalGoal.name} (Ú©Ù¾ÛŒ)`;newGoal.history={};newGoal.archived=false;appState.goals.push(newGoal);const originalIndex=appState.order.indexOf(goalId);appState.order.splice(originalIndex+1,0,newGoal.id);persistState();fullRender();}};
    window.toggleArchiveGoal=(goalId)=>{const goal=appState.goals.find(g=>g.id===goalId);if(goal){goal.archived=!goal.archived;persistState();fullRender();}};
    window.deleteGoal=(goalId)=>{const modal=document.createElement('div');modal.className='fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4';modal.innerHTML=`<div class="modal-content bg-app-card rounded-2xl p-5 w-full max-w-sm shadow-2xl text-center"><h3 class="font-bold text-lg mb-2">ØªØ§ÛŒÛŒØ¯ Ø­Ø°Ù</h3><p class="text-sm text-app-text-muted mb-6">Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù‡Ø¯Ù Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ Ø§ÛŒÙ† Ø¹Ù…Ù„ ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø³Øª.</p><div class="grid grid-cols-2 gap-4"><button id="cancel-delete" class="p-3 rounded-lg font-bold bg-app-cell-inactive hover:opacity-80 transition">Ù„ØºÙˆ</button><button id="confirm-delete" class="p-3 rounded-lg font-bold bg-red-500 text-white hover:bg-red-600 transition">Ø­Ø°Ù</button></div></div>`;document.getElementById('modalArea').appendChild(modal);modal.querySelector('#cancel-delete').onclick=closeModal;modal.querySelector('#confirm-delete').onclick=()=>{closeModal();const card=document.querySelector(`.goal-card[data-id="${goalId}"]`);if(card){card.classList.add('goal-anim-out');setTimeout(()=>{appState.goals=appState.goals.filter(g=>g.id!==goalId);appState.order=appState.order.filter(id=>id!==goalId);persistState();fullRender();},300);}else{appState.goals=appState.goals.filter(g=>g.id!==goalId);appState.order=appState.order.filter(id=>id!==goalId);persistState();fullRender();}};};
    function addCheckmark(goalId,dayIndex,cellElement){const goal=appState.goals.find(g=>g.id===goalId);if(!goal||!goal.days[dayIndex])return;const weekId=weekIdForDate(appState.currentWeek);if(!goal.history)goal.history={};if(!goal.history[weekId])goal.history[weekId]=Array(7).fill(null).map(()=>({entries:[],note:''}));if(!goal.history[weekId][dayIndex])goal.history[weekId][dayIndex]={entries:[],note:''};goal.history[weekId][dayIndex].entries.push(checkmarkSVG);persistState();const dayData=goal.history[weekId][dayIndex];cellElement.querySelector('div').innerHTML=dayData.entries.map(em=>{if(!em)return'';if(em.startsWith('<svg')){return`<span class="inline-flex items-center justify-center w-8 h-8">${em}</span>`;}return`<span class="text-sm md:text-base">${escapeHtml(em)}</span>`;}).join('');cellElement.classList.add('day-completed');cellElement.classList.add('cell-swipe-up');cellElement.addEventListener('animationend',()=>cellElement.classList.remove('cell-swipe-up'),{once:true});updateGoalCardStats(goalId);}
    function removeLastEmoji(goalId,dayIndex,cellElement){const goal=appState.goals.find(g=>g.id===goalId);if(!goal||!goal.days[dayIndex])return;const weekId=weekIdForDate(appState.currentWeek);if(!goal.history?.[weekId]?.[dayIndex]?.entries.length>0)return;goal.history[weekId][dayIndex].entries.pop();persistState();const dayData=goal.history[weekId][dayIndex];cellElement.querySelector('div').innerHTML=dayData.entries.map(em=>{if(!em)return'';if(em.startsWith('<svg')){return`<span class="inline-flex items-center justify-center w-8 h-8">${em}</span>`;}return`<span class="text-sm md:text-base">${escapeHtml(em)}</span>`;}).join('');if(dayData.entries.length===0){cellElement.classList.remove('day-completed');}cellElement.classList.add('cell-swipe-down');cellElement.addEventListener('animationend',()=>cellElement.classList.remove('cell-swipe-down'),{once:true});updateGoalCardStats(goalId);}
    function setupCellListeners(){document.querySelectorAll('.goal-day').forEach(cell=>{let pressTimer=null;let longPressTriggered=false;let startY=0,startX=0;let isDragging=false;let swipeTriggered=false;let hasMoved=false;const handlePressStart=(e)=>{if(cell.classList.contains('!cursor-not-allowed'))return;startY=e.type==='touchstart'?e.touches[0].clientY:e.clientY;startX=e.type==='touchstart'?e.touches[0].clientX:e.clientX;isDragging=true;swipeTriggered=false;longPressTriggered=false;hasMoved=false;pressTimer=setTimeout(()=>{longPressTriggered=true;isDragging=false;const{goalId,dayIndex}=cell.dataset;showDayDetailModal(goalId,parseInt(dayIndex));cleanupListeners();},500);document.addEventListener('mousemove',handlePressMove);document.addEventListener('touchmove',handlePressMove,{passive:false});document.addEventListener('mouseup',handlePressEnd,{once:true});document.addEventListener('touchend',handlePressEnd,{once:true});};const handlePressMove=(e)=>{if(!isDragging||longPressTriggered||swipeTriggered)return;const currentY=e.type==='touchmove'?e.touches[0].clientY:e.clientY;const currentX=e.type==='touchmove'?e.touches[0].clientX:e.clientX;const deltaY=currentY-startY;const deltaX=currentX-startX;const SWIPE_THRESHOLD=30;if(Math.abs(deltaY)>10||Math.abs(deltaX)>10){hasMoved=true;clearTimeout(pressTimer);if(Math.abs(deltaY)>Math.abs(deltaX)){e.preventDefault();}}if(Math.abs(deltaY)>SWIPE_THRESHOLD&&Math.abs(deltaY)>Math.abs(deltaX)){swipeTriggered=true;const{goalId,dayIndex}=cell.dataset;if(deltaY<0){addCheckmark(goalId,parseInt(dayIndex),cell);}else{removeLastEmoji(goalId,parseInt(dayIndex),cell);}cleanupListeners();}};const handlePressEnd=()=>{clearTimeout(pressTimer);if(isDragging&&!longPressTriggered&&!swipeTriggered&&!hasMoved){const{goalId,dayIndex}=cell.dataset;showLogModal(goalId,parseInt(dayIndex));}cleanupListeners();};const cleanupListeners=()=>{isDragging=false;clearTimeout(pressTimer);document.removeEventListener('mousemove',handlePressMove);document.removeEventListener('touchmove',handlePressMove);document.removeEventListener('mouseup',handlePressEnd);document.removeEventListener('touchend',handlePressEnd);}
    cell.removeEventListener('mousedown',handlePressStart);cell.removeEventListener('touchstart',handlePressStart);cell.addEventListener('mousedown',handlePressStart);cell.addEventListener('touchstart',handlePressStart,{passive:false});});}
    function initSortable(){if(sortable)sortable.destroy();const list=document.getElementById('goalList');if(!list)return;sortable=Sortable.create(list,{handle:'.goal-handle',animation:200,ghostClass:'sortable-ghost',onEnd:(evt)=>{appState.order=Array.from(evt.to.children).map(card=>card.dataset.id);persistState();}});}

    showGoalModal = (goal) => {
    const isEdit = !!goal;
    const draft = isEdit ? JSON.parse(JSON.stringify(goal)) : { id: '' + Date.now(), name: '', emoji: 'ğŸ¯', days: Array(7).fill(true), history: {}, type: 'binary', archived: false, category: 'Ø´Ø®ØµÛŒ', creationDate: new Date().toISOString() };
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/30 backdrop-blur-sm z-[100] flex items-end justify-center';
    modal.innerHTML = `<div class="modal-content bg-app-bg rounded-t-2xl p-4 w-full max-w-lg pb-[calc(env(safe-area-inset-bottom)+1rem)] shadow-2xl"><h2 class="text-xl font-bold text-center mb-6 text-primary">${isEdit?'ÙˆÛŒØ±Ø§ÛŒØ´ Ù‡Ø¯Ù':'Ù‡Ø¯Ù Ø¬Ø¯ÛŒØ¯'}</h2><div class="space-y-4"><div class="flex gap-4"><div class="flex-grow"><label for="goalName" class="font-semibold mb-2 block text-sm">Ù†Ø§Ù… Ù‡Ø¯Ù</label><input type="text" id="goalName" value="${escapeHtml(draft.name)}" placeholder="Ù…Ø«Ù„Ø§: ÙˆØ±Ø²Ø´ Ø±ÙˆØ²Ø§Ù†Ù‡" class="w-full p-3 bg-app-card rounded-lg border border-app-border focus:ring-2 focus:ring-primary outline-none transition"></div><div><label for="goalEmoji" class="font-semibold mb-2 block text-sm">Ø§ÛŒÙ…ÙˆØ¬ÛŒ</label><input type="text" id="goalEmoji" value="${draft.emoji}" maxlength="2" class="w-20 text-center p-3 bg-app-card rounded-lg border border-app-border focus:ring-2 focus:ring-primary outline-none transition"></div></div><div><label class="font-semibold mb-2 block text-sm">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</label><select id="goalCategory" class="w-full p-3 bg-app-card rounded-lg border border-app-border focus:ring-2 focus:ring-primary outline-none transition">${Object.keys(CATEGORIES).map(cat=>`<option value="${cat}" ${draft.category===cat?'selected':''}>${cat}</option>`).join('')}</select></div><div><label class="font-semibold mb-2 block text-sm">Ø±ÙˆØ²Ù‡Ø§ÛŒ ÙØ¹Ø§Ù„</label><div class="grid grid-cols-7 gap-2 rounded-lg bg-app-cell-inactive p-1 weekday-toggle-row">${WEEKDAY_NAMES_SHORT.map((d, i) => {
        const dataIndex = (i + 6) % 7; // Convert visual index (Sat=0) to data index (Sun=0)
        return `<div class="weekday-toggle text-center font-bold p-2 rounded-md cursor-pointer transition-colors ${draft.days[dataIndex] ? 'bg-primary text-primary-text' : 'hover:bg-app-hover'}" data-day="${dataIndex}">${d}</div>`;
    }).join('')}</div></div></div><div class="grid grid-cols-2 gap-4 mt-8"><button class="action-btn-cancel w-full p-4 rounded-lg font-bold bg-app-cell-inactive hover:opacity-80 transition">Ù„ØºÙˆ</button><button id="saveGoalBtn" class="w-full p-4 rounded-lg font-bold bg-primary text-primary-text hover:opacity-90 transition">${isEdit ? 'Ø°Ø®ÛŒØ±Ù‡' : 'Ø§ÙØ²ÙˆØ¯Ù†'}</button></div></div>`;
    document.getElementById('modalArea').appendChild(modal);
    document.getElementById('goalName').focus();
    modal.onclick = e => { if (e.target === modal) closeModal(); };
    modal.querySelector('.action-btn-cancel').onclick = closeModal;
    modal.querySelectorAll('.weekday-toggle').forEach(toggle => {
        toggle.onclick = () => {
            const day = parseInt(toggle.dataset.day); // This is already the correct data index (Sun=0)
            draft.days[day] = !draft.days[day];
            toggle.classList.toggle('bg-primary');
            toggle.classList.toggle('text-primary-text');
        };
    });
    modal.querySelector('#saveGoalBtn').onclick = () => {
        draft.name = modal.querySelector('#goalName').value.trim();
        draft.emoji = modal.querySelector('#goalEmoji').value;
        draft.category = modal.querySelector('#goalCategory').value;
        draft.type = 'binary';
        if (isEdit) {
            const index = appState.goals.findIndex(g => g.id === goal.id);
            if (index > -1) appState.goals[index] = draft;
        } else {
            appState.goals.push(draft);
            appState.order.push(draft.id);
        }
        persistState();
        closeModal();
        fullRender();
    };
};

    showLogModal = (goalId,dayIndex)=>{const goal=appState.goals.find(g=>g.id===goalId);if(!goal||!goal.days[dayIndex])return;const weekId=weekIdForDate(appState.currentWeek);if(!goal.history)goal.history={};if(!goal.history[weekId])goal.history[weekId]=Array(7).fill(null).map(()=>({entries:[],note:''}));if(!goal.history[weekId][dayIndex])goal.history[weekId][dayIndex]={entries:[],note:''};const dayData=goal.history[weekId][dayIndex];const modal=document.createElement('div');modal.className='fixed inset-0 bg-black/30 backdrop-blur-sm z-[100] flex items-end justify-center';const renderEntriesInModal=(container)=>{const listHtml=dayData.entries.map((entry,i)=>{const content=entry.startsWith('<svg')?`<span class="w-6 h-6 inline-block">${entry}</span>`:escapeHtml(entry);return`<div class="flex items-center justify-between gap-1 bg-app-cell-inactive rounded-lg px-2 py-1 text-sm"><span>${content}</span><button data-index="${i}" class="delete-entry-btn text-red-500 hover:text-red-700 font-bold text-lg">&times;</button></div>`;}).join('');container.innerHTML=listHtml||`<span class="text-app-text-muted text-sm p-2">Ù…ÙˆØ±Ø¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</span>`;};modal.innerHTML=`<div class="modal-content bg-app-bg rounded-t-2xl p-4 w-full max-w-lg pb-[calc(env(safe-area-inset-bottom)+1rem)] shadow-2xl"><h2 class="text-xl font-bold text-center mb-4 truncate">${goal.name}</h2><div class="space-y-4"><div><label class="font-semibold mb-2 block text-sm">Ù…ÙˆØ§Ø±Ø¯ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ù…Ø±ÙˆØ²</label><div id="entries-list" class="flex flex-wrap gap-2 min-h-[40px] bg-app-card p-2 rounded-lg border border-app-border"></div></div><div><label class="font-semibold mb-2 block text-sm">Ø«Ø¨Øª Ø§ÛŒÙ…ÙˆØ¬ÛŒ</label><div class="emoji-grid grid grid-cols-7 gap-2 text-3xl">${EMOJIS.map(em=>{const content=em.startsWith('<svg')?`<span class="w-8 h-8 inline-block">${em}</span>`:escapeHtml(em);return`<button class="emoji-btn text-center rounded-lg p-2 hover:bg-app-hover transition-transform active:scale-125 focus:outline-none focus:ring-2 focus:ring-primary">${content}</button>`;}).join('')}</div></div><div><label for="note-input" class="font-semibold mb-2 block text-sm">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</label><textarea id="note-input" class="w-full p-3 bg-app-card rounded-lg border border-app-border focus:ring-2 focus:ring-primary outline-none transition" rows="2" placeholder="ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø§Ù…Ø±ÙˆØ²...">${escapeHtml(dayData.note)}</textarea></div></div><div class="mt-8"><button class="action-btn-done w-full p-4 rounded-lg font-bold bg-primary text-primary-text hover:opacity-90 transition">Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯</button></div></div>`;document.getElementById('modalArea').appendChild(modal);const entriesList=modal.querySelector('#entries-list');renderEntriesInModal(entriesList);const saveAndClose=()=>{goal.history[weekId][dayIndex].note=modal.querySelector('#note-input').value;persistState();fullRender();closeModal();};modal.onclick=e=>{if(e.target===modal)saveAndClose();};modal.querySelector('.action-btn-done').onclick=saveAndClose;const updateData=()=>{persistState();renderEntriesInModal(entriesList);updateGoalCardStats(goalId);};entriesList.addEventListener('click',e=>{if(e.target.classList.contains('delete-entry-btn')){const index=parseInt(e.target.dataset.index);dayData.entries.splice(index,1);updateData();}});modal.querySelectorAll('.emoji-btn').forEach((btn,index)=>{btn.onclick=()=>{dayData.entries.push(EMOJIS[index]);updateData();};});}
    showDayDetailModal = (goalId,dayIndex)=>{const goal=appState.goals.find(g=>g.id===goalId);if(!goal)return;const weekDates=getWeekDates(appState.currentWeek);const date=weekDates[dayIndex];const weekId=weekIdForDate(appState.currentWeek);const dayData=goal.history?.[weekId]?.[dayIndex]||{entries:[],note:''};const modal=document.createElement('div');modal.className='fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4';const formattedDate=date.toLocaleDateString('fa-IR',{weekday:'long',month:'long',day:'numeric'});const entriesHtml=dayData.entries.length>0?dayData.entries.map(entry=>{if(entry.startsWith('<svg')){return`<span class="inline-block align-middle w-8 h-8">${entry}</span>`;}return`<span class="text-2xl">${escapeHtml(entry)}</span>`;}).join(''):'<span class="text-sm text-app-text-muted">Ù…ÙˆØ±Ø¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</span>';const noteHtml=dayData.note?`<p class="text-sm bg-amber-500/10 p-3 rounded-lg">${escapeHtml(dayData.note)}</p>`:'<span class="text-sm text-app-text-muted">ÛŒØ§Ø¯Ø¯Ø§Ø´ØªÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</span>';modal.innerHTML=`<div class="modal-content bg-app-card rounded-2xl p-5 w-full max-w-sm shadow-2xl"><h3 class="font-bold text-lg text-primary mb-2">${escapeHtml(goal.name)}</h3><p class="text-sm text-app-text-muted font-semibold mb-4">${formattedDate}</p><div class="space-y-4"><div><h4 class="font-semibold text-sm mb-2">Ù…ÙˆØ§Ø±Ø¯ Ø«Ø¨Øª Ø´Ø¯Ù‡</h4><div class="flex flex-wrap gap-3 items-center min-h-[40px] bg-app-bg p-3 rounded-lg">${entriesHtml}</div></div><div><h4 class="font-semibold text-sm mb-2">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</h4><div class="min-h-[40px]">${noteHtml}</div></div></div><button class="close-modal-btn w-full mt-6 p-3 rounded-lg font-bold bg-app-cell-inactive hover:opacity-80 transition">Ø¨Ø³ØªÙ†</button></div>`;document.getElementById('modalArea').appendChild(modal);modal.onclick=e=>{if(e.target===modal||e.target.classList.contains('close-modal-btn'))closeModal();};}
    showContextMenu=(e,goalId)=>{e.preventDefault();e.stopPropagation();if(appState.contextMenuGoalId===goalId){closeContextMenu();return;}closeContextMenu();const goal=appState.goals.find(g=>g.id===goalId);if(!goal)return;const menu=document.getElementById('contextMenu');menu.innerHTML=`<button onclick="editGoal('${goalId}')" class="w-full text-left flex items-center gap-3 p-3 hover:bg-app-hover rounded-lg">âœï¸ <span>ÙˆÛŒØ±Ø§ÛŒØ´</span></button><button onclick="duplicateGoal('${goalId}')" class="w-full text-left flex items-center gap-3 p-3 hover:bg-app-hover rounded-lg">ğŸ—‚ï¸ <span>Ú©Ù¾ÛŒ</span></button><button onclick="toggleArchiveGoal('${goalId}')" class="w-full text-left flex items-center gap-3 p-3 hover:bg-app-hover rounded-lg">${goal.archived?'ğŸ“‚ <span>Ù„ØºÙˆ Ø¢Ø±Ø´ÛŒÙˆ</span>':'ğŸ—„ï¸ <span>Ø¢Ø±Ø´ÛŒÙˆ</span>'}</button><div class="my-1 h-px bg-app-border"></div><button onclick="deleteGoal('${goalId}')" class="w-full text-left flex items-center gap-3 p-3 text-red-500 hover:bg-red-500/10 rounded-lg">ğŸ—‘ï¸ <span>Ø­Ø°Ù</span></button>`;menu.style.display='block';const rect=menu.getBoundingClientRect();let left=e.clientX;let top=e.clientY;if(left+rect.width>window.innerWidth-10){left=window.innerWidth-rect.width-10;}if(top+rect.height>window.innerHeight-10){top=window.innerHeight-rect.height-10;}menu.style.left=`${left}px`;menu.style.top=`${top}px`;appState.contextMenuGoalId=goalId;setTimeout(()=>document.addEventListener('click',closeContextMenu,{once:true}),10);};
function updateGoalCardStats(goalId) {
    const goal = appState.goals.find(g => g.id === goalId);
    if (!goal) return;
    const card = document.querySelector(`.goal-card[data-id="${goalId}"]`);
    if (!card) return;
    const statsContainer = card.querySelector('.goal-stats-desktop');
    if (statsContainer) {
        // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¬Ø¯Ø¯ ØªÙ…Ø§Ù… Ø¢Ù…Ø§Ø±
        const { weekly, allTime } = calculateScores(goal);
        const streak = calculateStreak(goal);
        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¨Ø®Ø´ Ø¢Ù…Ø§Ø± Ø¨Ø§ Ø³Ø§Ø®ØªØ§Ø± Ø¬Ø¯ÛŒØ¯
        statsContainer.innerHTML = `
            <span class="flex items-center gap-1" title="Ú©Ù„"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg><span>${toFa(allTime)}</span></span>
            <span class="flex items-center gap-1" title="Ø§Ø³ØªØ±ÛŒÚ©"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg><span>${toFa(streak)}</span></span>
            <span class="flex items-center gap-1" title="Ù‡ÙØªÙ‡"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg><span>${toFa(weekly)}</span></span>`;
    }
}
    //report
    

// ADD THESE THREE NEW FUNCTIONS TO YOUR SCRIPT

/**
 * Calculates the total number of completions for each day of the week for a specific goal.
 * @param {string} goalId The ID of the goal.
 * @returns {number[]} An array of 7 numbers representing total completions from Sunday to Saturday.
 */
function calculateWeekdayTotals(goalId) {
    const goal = appState.goals.find(g => g.id === goalId);
    if (!goal || !goal.history) return Array(7).fill(0);

    const totals = Array(7).fill(0); // [Sun, Mon, Tue, Wed, Thu, Fri, Sat]

    for (const weekId in goal.history) {
        const weekData = goal.history[weekId];
        if (weekData) {
            weekData.forEach((dayData, dayIndex) => {
                if (dayData && dayData.entries.length > 0) {
                    // dayIndex is 0 for Sunday, 1 for Monday, etc.
                    totals[dayIndex] += dayData.entries.length;
                }
            });
        }
    }
    return totals;
}

/**
 * Renders a yearly heatmap for a single goal inside a container.
 * @param {HTMLElement} container The element to render the heatmap into.
 * @param {object} goal The goal object.
 * @param {number} jYear The Jalali year to display.
 * @param {number[]} weekdayTotals Pre-calculated totals for each day of the week.
 */
function renderGoalHeatmap(container, goal, jYear, weekdayTotals) {
    const completionsByJalaliDate = {};
    if (goal.history) {
        for (const weekId in goal.history) {
            const weekStartDate = new Date(weekId.replace(/-/g, '/'));
            goal.history[weekId].forEach((dayData, dayIndex) => {
                if (dayData && dayData.entries.length > 0) {
                    const date = new Date(weekStartDate);
                    date.setDate(date.getDate() + dayIndex);
                    const [jy, jm, jd] = toJalali(date.getFullYear(), date.getMonth() + 1, date.getDate());
                    if (jy === jYear) {
                        const jDateStr = `${jy}-${jm}-${jd}`;
                        completionsByJalaliDate[jDateStr] = (completionsByJalaliDate[jDateStr] || 0) + dayData.entries.length;
                    }
                }
            });
        }
    }

    const maxCompletions = Math.max(1, ...Object.values(completionsByJalaliDate));
    const theme = findThemeById(appState.activeThemeId);
    
    const getDayStyle = (count) => {
        if (!count || count === 0) {
            return { bg: 'bg-app-cell-inactive opacity-75', text: '' };
        }
        const intensity = Math.min(count / maxCompletions, 1.0);
        if (theme.isDark) {
            if (intensity < 0.25) return { bg: 'bg-emerald-900', text: 'text-emerald-200' };
            if (intensity < 0.5) return { bg: 'bg-emerald-700', text: 'text-emerald-100' };
            if (intensity < 0.75) return { bg: 'bg-emerald-500', text: 'text-black' };
            return { bg: 'bg-emerald-300', text: 'text-black font-bold' };
        } else {
            if (intensity < 0.25) return { bg: 'bg-green-200', text: 'text-green-900' };
            if (intensity < 0.5) return { bg: 'bg-green-400', text: 'text-green-900' };
            if (intensity < 0.75) return { bg: 'bg-green-600', text: 'text-white' };
            return { bg: 'bg-green-800', text: 'text-white font-bold' };
        }
    };

    const weekdayHeaders = WEEKDAY_NAMES_SHORT.map((dayName, index) => {
        const dataIndex = (index + 6) % 7; // Map visual index (Sat=0) to data index (Sun=0)
        const count = weekdayTotals[dataIndex];
        if (count > 0) {
            return `<div class="relative flex items-center justify-center">
                        ${dayName}
                        <span class="absolute -top-1.5 -right-1.5 text-[9px] font-bold bg-primary/80 text-primary-text rounded-full w-4 h-4 flex items-center justify-center leading-none">${toFa(count)}</span>
                    </div>`;
        }
        return `<div>${dayName}</div>`;
    }).join('');

    let html = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-6">`;
    for (let jm = 1; jm <= 12; jm++) {
        const monthLength = jalaliMonthLength(jYear, jm);
        const firstGregorianDate = toGregorian(jYear, jm, 1);
        const startOffset = (firstGregorianDate.getDay() + 1) % 7; // Adjusted for Sat start
        
        let monthHtml = `<div class="p-3 bg-app-bg rounded-lg">
            <h4 class="font-semibold text-center text-sm mb-2">${JALALI_MONTH_NAMES[jm-1]}</h4>
            <div class="grid grid-cols-7 gap-1 text-center text-[10px] text-app-text-muted mb-1.5">
               ${weekdayHeaders}
            </div>
            <div class="grid grid-cols-7 gap-1.5 text-xs">`;
        
        for (let i = 0; i < startOffset; i++) { monthHtml += '<div></div>'; }
        for (let jd = 1; jd <= monthLength; jd++) {
            const jDateStr = `${jYear}-${jm}-${jd}`;
            const count = completionsByJalaliDate[jDateStr] || 0;
            const gDate = toGregorian(jYear, jm, jd);
            
            const style = getDayStyle(count);
            const todayClass = isToday(gDate) ? 'ring-2 ring-primary' : '';
            const title = `${toFa(jd)} ${JALALI_MONTH_NAMES[jm-1]} ${toFa(jYear)}: ${toFa(count)} Ù…ÙˆØ±Ø¯`;

            monthHtml += `<div onclick="showDailySummaryModal(${jYear}, ${jm}, ${jd})" class="heatmap-day aspect-square rounded-sm flex items-center justify-center cursor-pointer transition-colors ${style.bg} ${style.text} ${todayClass}" title="${title}">${toFa(jd)}</div>`;
        }
        monthHtml += `</div></div>`;
        html += monthHtml;
    }
    html += `</div>`;
    container.innerHTML = html;
}
/**
 * Creates and displays the goal-specific heatmap modal.
 * @param {string} goalId The ID of the goal to display.
 */
function showGoalHeatmapModal(goalId) {
    const goal = appState.goals.find(g => g.id === goalId);
    if (!goal) return;

    let currentYearDate = new Date();
    const weekdayTotals = calculateWeekdayTotals(goalId);

    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4';
    
    modal.innerHTML = `
        <div class="modal-content glass-modal-content rounded-2xl p-4 sm:p-6 w-full max-w-4xl max-h-[90vh] flex flex-col shadow-2xl">
            <div class="flex-shrink-0 flex justify-between items-center mb-4">
                <div class="flex items-center gap-3">
                    <span class="text-3xl">${goal.emoji}</span>
                    <h2 class="text-xl sm:text-2xl font-bold text-app-text">${escapeHtml(goal.name)}</h2>
                </div>
                <button class="close-modal-btn text-app-text-muted hover:bg-app-hover rounded-full p-2 transition-colors">&times;</button>
            </div>
            <div class="flex-shrink-0 flex items-center justify-center gap-2 mb-4">
                 <button id="heatmap-prev-btn" aria-label="Previous Year" class="p-2 rounded-full hover:bg-app-hover transition-colors">
                     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <div id="heatmap-date-display" class="w-36 text-center font-bold text-primary"></div>
                <button id="heatmap-next-btn" aria-label="Next Year" class="p-2 rounded-full hover:bg-app-hover transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>
            <div id="goal-heatmap-content" class="flex-grow overflow-y-auto p-1 -ml-2 pl-2 no-scrollbar"></div>
        </div>
    `;

    document.getElementById('modalArea').appendChild(modal);
    modal.onclick = e => { if (e.target === modal || e.target.closest('.close-modal-btn')) closeModal(); };

    const contentArea = modal.querySelector('#goal-heatmap-content');
    const dateDisplay = modal.querySelector('#heatmap-date-display');
    
    function updateView() {
        const [jYear] = toJalali(currentYearDate.getFullYear(), currentYearDate.getMonth() + 1, currentYearDate.getDate());
        dateDisplay.innerText = `Ø³Ø§Ù„ ${toFa(jYear)}`;
        renderGoalHeatmap(contentArea, goal, jYear, weekdayTotals);
    }

    modal.querySelector('#heatmap-prev-btn').onclick = () => {
        currentYearDate.setFullYear(currentYearDate.getFullYear() - 1);
        updateView();
    };
    modal.querySelector('#heatmap-next-btn').onclick = () => {
        currentYearDate.setFullYear(currentYearDate.getFullYear() + 1);
        updateView();
    };

    updateView(); // Initial render
}




    //end
   //report
    function showReportModal() {
        let currentReportDate = new Date();
        let currentReportView = 'month'; // 'day', 'week', 'month', 'overall'
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4';
        modal.innerHTML = `
            <div class="modal-content glass-modal-content rounded-2xl p-4 sm:p-6 w-full max-w-4xl max-h-[90vh] flex flex-col shadow-2xl">
                <div class="flex-shrink-0 flex justify-between items-center mb-4">
                    <h2 class="text-xl sm:text-2xl font-bold text-slate-900 dark:text-white">Ú¯Ø²Ø§Ø±Ø´ Ù¾ÛŒØ´Ø±ÙØª</h2>
                    <button class="close-modal-btn text-slate-500 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-full p-2 transition-colors">&times;</button>
                </div>
                <div class="flex-shrink-0 flex flex-col sm:flex-row items-center justify-between gap-4 mb-4">
                     <div id="report-tabs" class="w-full sm:w-auto flex flex-wrap items-center justify-center gap-2">
                         <button data-view="day" class="report-tab-btn">Ø±ÙˆØ²Ø§Ù†Ù‡</button>
                         <button data-view="week" class="report-tab-btn">Ù‡ÙØªÚ¯ÛŒ</button>
                         <button data-view="month" class="report-tab-btn active">Ù…Ø§Ù‡Ø§Ù†Ù‡</button>
                         <button data-view="overall" class="report-tab-btn">Ø³Ø§Ù„Ø§Ù†Ù‡</button>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="report-prev-btn" aria-label="Previous" class="p-2 rounded-full hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors">
                             <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        </button>
                        <div id="report-date-display" class="w-36 text-center font-bold text-indigo-600 dark:text-indigo-400"></div>
                        <button id="report-next-btn" aria-label="Next" class="p-2 rounded-full hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                    </div>
                </div>
                <div id="report-content" class="flex-grow overflow-y-auto space-y-3 p-1 -ml-2 pl-2 no-scrollbar"></div>
            </div>`;
        document.getElementById('modalArea').appendChild(modal);
        modal.onclick = e => { if (e.target === modal || e.target.closest('.close-modal-btn')) closeModal(); };
        const tabs = modal.querySelector('#report-tabs');
        const contentArea = modal.querySelector('#report-content');
        const dateDisplay = modal.querySelector('#report-date-display');
        const prevBtn = modal.querySelector('#report-prev-btn');
        const nextBtn = modal.querySelector('#report-next-btn');
        function updateReportView() {
            renderReportContent(contentArea, dateDisplay, currentReportView, currentReportDate);
            tabs.querySelectorAll('.report-tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === currentReportView);
            });
        }
        tabs.addEventListener('click', e => {
            const button = e.target.closest('.report-tab-btn');
            if (button) {
                currentReportView = button.dataset.view;
                currentReportDate = new Date();
                updateReportView();
            }
        });
        const navigate = (direction) => {
            if (currentReportView === 'day') currentReportDate.setDate(currentReportDate.getDate() + direction);
            else if (currentReportView === 'week') currentReportDate.setDate(currentReportDate.getDate() + (7 * direction));
            else if (currentReportView === 'month') currentReportDate.setMonth(currentReportDate.getMonth() + direction);
            else if (currentReportView === 'overall') currentReportDate.setFullYear(currentReportDate.getFullYear() + direction);
            updateReportView();
        };
        prevBtn.addEventListener('click', () => navigate(-1));
        nextBtn.addEventListener('click', () => navigate(1));
        updateReportView(); // Initial render
    }
    function renderReportContent(container, dateDisplay, view, date) {
        const goals = appState.goals.filter(g => !g.archived);
        if (goals.length === 0) {
            container.innerHTML = `<div class="text-center text-slate-500 p-8">Ù‡ÛŒÚ† Ø¹Ø§Ø¯Øª ÙØ¹Ø§Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ú¯Ø²Ø§Ø±Ø´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</div>`;
            dateDisplay.innerText = '-';
            return;
        }
        if (view === 'overall') {
            const [jYear] = toJalali(date.getFullYear(), date.getMonth() + 1, date.getDate());
            dateDisplay.innerText = `Ø³Ø§Ù„ ${toFa(jYear)}`;
            renderOverallReport(container, jYear);
            return;
        }
        let startDate, endDate, dateLabel = '';
        if (view === 'day') {
            startDate = new Date(date); startDate.setHours(0,0,0,0);
            endDate = new Date(date); endDate.setHours(23,59,59,999);
            dateLabel = date.toLocaleDateString('fa-IR', { year: 'numeric', month: 'long', day: 'numeric' });
        } else if (view === 'week') {
            startDate = getStartOfWeek(date);
            endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
            endDate.setHours(23,59,59,999);
            dateLabel = formatWeekRange(startDate);
        } else { // month
            const [jYear, jMonth] = toJalali(date.getFullYear(), date.getMonth() + 1, date.getDate());
            startDate = toGregorian(jYear, jMonth, 1);
            const monthLen = jalaliMonthLength(jYear, jMonth);
            endDate = toGregorian(jYear, jMonth, monthLen);
            endDate.setHours(23,59,59,999);
            dateLabel = startDate.toLocaleDateString('fa-IR', { year: 'numeric', month: 'long' });
        }
        dateDisplay.innerText = dateLabel;
        let reportHtml = '';
        goals.forEach(goal => {
            let totalCompletions = 0;
            let totalTarget = 0;
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dayIndex = d.getDay(); // Sunday is 0
                if (goal.days[dayIndex]) {
                    totalTarget++;
                    totalCompletions += getEntryCountOnDate(goal, d);
                }
            }
            const percentage = totalTarget > 0 ? Math.round((totalCompletions / totalTarget) * 100) : 0;
            const streak = calculateStreak(goal);
            reportHtml += `
                <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${goal.emoji}</span>
                            <span class="font-bold text-slate-700 dark:text-slate-200">${escapeHtml(goal.name)}</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center flex-wrap gap-x-4 gap-y-2 text-sm font-semibold text-slate-500 dark:text-slate-400 mb-2">
                        <span>ØªÚ©Ù…ÛŒÙ„ Ø¯ÙˆØ±Ù‡: ${toFa(totalCompletions)} / ${toFa(totalTarget)}</span>
                        <div class="flex items-center gap-1 text-amber-500" title="Ø§Ø³ØªØ±ÛŒÚ© ÙØ¹Ù„ÛŒ">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" /></svg>
                            <span class="font-bold">${toFa(streak)}</span>
                        </div>
                        <span class="font-bold text-indigo-500">${toFa(percentage)}Ùª</span>
                    </div>
                    <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5">
                        <div class="bg-indigo-600 h-2.5 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                </div>
            `;
        });
        container.innerHTML = reportHtml;
    }
    function renderOverallReport(container, jYear) {
        const { totalCompletions, busiestDay } = calculateOverallStats();
        const statsHtml = `
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                <div class="stat-card">
                    <div class="stat-value">${toFa(totalCompletions)}</div>
                    <div class="stat-label">Ù…Ø¬Ù…ÙˆØ¹ Ø¹Ù…Ù„Ú©Ø±Ø¯</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${busiestDay}</div>
                    <div class="stat-label">ÙØ¹Ø§Ù„â€ŒØªØ±ÛŒÙ† Ø±ÙˆØ²</div>
                </div>
            </div>`;
        const heatmapContainerId = `yearly-heatmap-${jYear}`;
        container.innerHTML = statsHtml + `<div id="${heatmapContainerId}" class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm"></div>`;
        renderYearlyHeatmap(document.getElementById(heatmapContainerId), jYear);
    }
    function calculateOverallStats() {
        let totalCompletions = 0;
        const dayCounts = [0, 0, 0, 0, 0, 0, 0]; // Sun, Mon, Tue, Wed, Thu, Fri, Sat
        const goals = appState.goals.filter(g => !g.archived);
        goals.forEach(goal => {
            if (goal.history) {
                 Object.values(goal.history).forEach(weekData => {
                     if (weekData) {
                         weekData.forEach((dayData, dayIndex) => {
                            if (dayData && dayData.entries.length > 0) {
                                 totalCompletions += dayData.entries.length;
                                 dayCounts[dayIndex] += dayData.entries.length;
                            }
                         });
                     }
                 });
            }
        });
        const busiestDayIndex = dayCounts.indexOf(Math.max(...dayCounts));
        const dayNames = ['ÛŒÚ©Ø´Ù†Ø¨Ù‡', 'Ø¯ÙˆØ´Ù†Ø¨Ù‡', 'Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡', 'Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡', 'Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡', 'Ø¬Ù…Ø¹Ù‡', 'Ø´Ù†Ø¨Ù‡'];
        const busiestDay = totalCompletions > 0 ? dayNames[busiestDayIndex] : '-';
        return { totalCompletions, busiestDay };
    }
   function renderYearlyHeatmap(container, jYear) {
    const completionsByJalaliDate = {};
    appState.goals.filter(g => !g.archived).forEach(goal => {
        if(goal.history) {
            for(const weekId in goal.history) {
                const weekStartDate = new Date(weekId.replace(/-/g, '/'));
                goal.history[weekId].forEach((dayData, dayIndex) => {
                    if (dayData && dayData.entries.length > 0) {
                        const date = new Date(weekStartDate);
                        date.setDate(date.getDate() + dayIndex);
                        const [jy, jm, jd] = toJalali(date.getFullYear(), date.getMonth() + 1, date.getDate());
                        if (jy === jYear) {
                            const jDateStr = `${jy}-${jm}-${jd}`;
                            completionsByJalaliDate[jDateStr] = (completionsByJalaliDate[jDateStr] || 0) + dayData.entries.length;
                        }
                    }
                });
            }
        }
    });
    const maxCompletions = Math.max(1, ...Object.values(completionsByJalaliDate));
    const getColor = (count) => {
        if (!count || count === 0) return 'bg-slate-200 dark:bg-slate-700/80';
        const intensity = Math.min(count / (maxCompletions * 0.6 + 1), 1);
        if (intensity < 0.25) return 'bg-emerald-200 dark:bg-emerald-900';
        if (intensity < 0.5) return 'bg-emerald-400 dark:bg-emerald-700';
        if (intensity < 0.75) return 'bg-emerald-600 dark:bg-emerald-500';
        return 'bg-emerald-800 dark:bg-emerald-300';
    };
    let html = `<h3 class="font-bold mb-4 text-center">Ù†Ù‚Ø´Ù‡ ÙØ¹Ø§Ù„ÛŒØª Ø³Ø§Ù„ ${toFa(jYear)}</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-6">`;
    for (let jm = 1; jm <= 12; jm++) {
        const monthLength = jalaliMonthLength(jYear, jm);
        const firstGregorianDate = toGregorian(jYear, jm, 1);
        const startOffset = (firstGregorianDate.getDay() + 1) % 7; // Adjusted for Sat start
        let monthHtml = `<div class="p-3 bg-slate-100 dark:bg-slate-900/50 rounded-lg">
            <h4 class="font-semibold text-center text-sm mb-2">${JALALI_MONTH_NAMES[jm-1]}</h4>
            <div class="grid grid-cols-7 gap-1 text-center text-[10px] text-slate-400 mb-1.5">
               ${WEEKDAY_NAMES_SHORT.map(d => `<div>${d}</div>`).join('')}
            </div>
            <div class="grid grid-cols-7 gap-1.5">`;
        for (let i = 0; i < startOffset; i++) { monthHtml += '<div></div>'; }
        for (let jd = 1; jd <= monthLength; jd++) {
            const jDateStr = `${jYear}-${jm}-${jd}`;
            const count = completionsByJalaliDate[jDateStr] || 0;
            const gDate = toGregorian(jYear, jm, jd);
            const colorClass = getColor(count);
            const todayClass = isToday(gDate) ? 'ring-2 ring-sky-500' : '';
            const title = `${toFa(jd)} ${JALALI_MONTH_NAMES[jm-1]} ${toFa(jYear)}: ${toFa(count)} Ù…ÙˆØ±Ø¯`;
            monthHtml += `<div onclick="showDailySummaryModal(${jYear}, ${jm}, ${jd})" class="${colorClass} ${todayClass} heatmap-day text-slate-800 dark:text-slate-200 font-bold" title="${title}">${toFa(jd)}</div>`;
        }
        monthHtml += `</div></div>`;
        html += monthHtml;
    }
    html += `</div>`;
    container.innerHTML = html;
}
    function showDailySummaryModal(jYear, jMonth, jDay) {
        const gDate = toGregorian(jYear, jMonth, jDay);
        const formattedDate = gDate.toLocaleDateString('fa-IR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-[101] flex items-center justify-center p-4';
        let completedGoalsHtml = '';
        let totalPlanned = 0;
        let totalCompletedCount = 0;
        const activeGoals = appState.goals.filter(g => !g.archived);
        const dayIndexForCheck = gDate.getDay(); // Sunday is 0
        activeGoals.forEach(goal => {
            if (goal.days[dayIndexForCheck]) {
                totalPlanned++;
                const entryCount = getEntryCountOnDate(goal, gDate);
                if (entryCount > 0) {
                    totalCompletedCount++;
                    completedGoalsHtml += `
                        <div class="flex items-center justify-between p-3 bg-white dark:bg-slate-700/50 rounded-lg">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">${goal.emoji}</span>
                                <span class="font-semibold">${escapeHtml(goal.name)}</span>
                            </div>
                            <span class="font-bold text-indigo-500">${toFa(entryCount)} Ø¨Ø§Ø±</span>
                        </div>`;
                }
            }
        });
        const successRate = totalPlanned > 0 ? Math.round((totalCompletedCount / totalPlanned) * 100) : 0;
        const statsHtml = `
            <div class="mb-4">
                <h4 class="font-semibold text-sm mb-2 text-slate-600 dark:text-slate-300">Ø¢Ù…Ø§Ø± Ø±ÙˆØ²</h4>
                <div class="grid grid-cols-3 gap-2 text-center">
                    <div class="bg-slate-200 dark:bg-slate-700 p-2 rounded-lg">
                        <div class="text-xl font-bold text-green-600 dark:text-green-400">${toFa(totalCompletedCount)}</div>
                        <div class="text-xs text-slate-500 dark:text-slate-400">Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù‡</div>
                    </div>
                    <div class="bg-slate-200 dark:bg-slate-700 p-2 rounded-lg">
                        <div class="text-xl font-bold text-slate-700 dark:text-slate-200">${toFa(totalPlanned)}</div>
                        <div class="text-xs text-slate-500 dark:text-slate-400">Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ</div>
                    </div>
                    <div class="bg-slate-200 dark:bg-slate-700 p-2 rounded-lg">
                        <div class="text-xl font-bold text-indigo-600 dark:text-indigo-400">${toFa(successRate)}Ùª</div>
                        <div class="text-xs text-slate-500 dark:text-slate-400">Ù…ÙˆÙÙ‚ÛŒØª</div>
                    </div>
                </div>
            </div>`;
        if (completedGoalsHtml === '') {
            completedGoalsHtml = '<p class="text-center text-slate-500 dark:text-slate-400 py-4">Ù‡ÛŒÚ† ÙØ¹Ø§Ù„ÛŒØªÛŒ Ø¯Ø± Ø§ÛŒÙ† Ø±ÙˆØ² Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>';
        }
        modal.innerHTML = `
            <div class="modal-content glass-modal-content rounded-2xl p-5 w-full max-w-md shadow-2xl">
                <h3 class="font-bold text-lg text-indigo-600 dark:text-indigo-400 mb-1">Ø®Ù„Ø§ØµÙ‡ Ø±ÙˆØ²</h3>
                <p class="text-sm text-slate-500 dark:text-slate-400 font-semibold mb-4">${formattedDate}</p>
                ${statsHtml}
                <h4 class="font-semibold text-sm mb-2 mt-4 text-slate-600 dark:text-slate-300">Ø¹Ø§Ø¯Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù‡</h4>
                <div class="space-y-2 max-h-52 overflow-y-auto no-scrollbar">${completedGoalsHtml}</div>
                <button class="close-modal-btn w-full mt-6 p-3 rounded-lg font-bold bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 transition">Ø¨Ø³ØªÙ†</button>
            </div>`;
        document.getElementById('modalArea').appendChild(modal);
        modal.onclick = e => { if (e.target === modal || e.target.closest('.close-modal-btn')) closeModal(); };
    }
// ADD THIS NEW FUNCTION TO YOUR SCRIPT
function renderSettingsMenu() {
    const menu = document.getElementById('settingsMenu');
    if (!menu) return;

    const showArchived = appState.showArchived;
    const isDark = findThemeById(appState.activeThemeId).isDark;

    menu.innerHTML = `
        <div class="space-y-1">
            <button id="reportBtn" class="w-full text-left flex items-center gap-3 p-3 hover:bg-app-hover rounded-lg transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                <span>Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§</span>
            </button>
            <button id="archiveToggleBtn" class="w-full text-left flex items-center gap-3 p-3 hover:bg-app-hover rounded-lg transition-colors ${showArchived ? 'text-primary' : ''}">
               <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                <span>${showArchived ? 'Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† Ø¢Ø±Ø´ÛŒÙˆ' : 'Ù†Ù…Ø§ÛŒØ´ Ø¢Ø±Ø´ÛŒÙˆ'}</span>
            </button>
            <button id="themeSelectorBtn" class="w-full text-left flex items-center gap-3 p-3 hover:bg-app-hover rounded-lg transition-colors">
                <span class="text-xl w-5 text-center">ğŸ¨</span>
                <span>Ø§Ù†ØªØ®Ø§Ø¨ ØªÙ…</span>
            </button>
            <div class="my-1 h-px bg-app-border"></div>
            <div class="w-full text-left flex items-center justify-between gap-3 p-3">
                <div class="flex items-center gap-3">
                    <span class="text-xl w-5 text-center">ğŸŒ—</span>
                    <span>Ø­Ø§Ù„Øª ØªÛŒØ±Ù‡</span>
                </div>
                <label for="darkModeToggle" class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" value="" id="darkModeToggle" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                </label>
            </div>
            <div class="my-1 h-px bg-app-border"></div>
            <button id="backupBtn" class="w-full text-left flex items-center gap-3 p-3 hover:bg-app-hover rounded-lg transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M12 15l-3-3m0 0l3-3m-3 3h12" /> </svg>
                <span>Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ</span>
            </button>
             <button id="aboutBtn" class="w-full text-left flex items-center gap-3 p-3 hover:bg-app-hover rounded-lg transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">  <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /> </svg>
                <span>Ø¯Ø±Ø¨Ø§Ø±Ù‡</span>
            </button>
        </div>
    `;
    const desktopToggle = menu.querySelector('#darkModeToggle');
    if (desktopToggle) desktopToggle.checked = isDark;
}
</script>
</body>
</html>