<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>آخرین خبر</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />

    <meta name="robots" content="noindex, nofollow" />

    <link
      rel="icon"
      type="image/png"
      sizes="192x192"
      href="https://i.ibb.co/CpfLvZLq/App-Icon-2x.png"
    />
    <link
      rel="apple-touch-icon"
      href="https://i.ibb.co/CpfLvZLq/App-Icon-2x.png"
    />
    <meta name="theme-color" content="#2563eb" />
    <link rel="manifest" href="manifest.json" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />

    <style>
      /* --- استایل‌های لایه لاگین --- */
      .login-layer {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f6f8fc;
        z-index: 9999;
        transition: opacity 0.5s ease-in-out;
      }
      .dark .login-layer {
        background-color: #141925;
      }
      .login-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border: 1.5px solid #f2f2f6;
        box-shadow: 0 4px 20px 0 rgba(0, 0, 0, 0.08);
      }
      .dark .login-card {
        background: rgba(27, 33, 54, 0.95);
        border-color: #25293c;
      }
      .hidden-layer {
        opacity: 0;
        pointer-events: none;
      }

      /* --- استایل‌های اصلی برنامه (بدون تغییر) --- */
      :root {
        --tweet-font-size-small: 13px;
        --tweet-font-size-medium: 15px;
        --tweet-font-size-large: 18px;
        --tweet-font-size-xlarge: 21px;
        --tweet-font-size: var(--tweet-font-size-medium);
      }
      html {
        scroll-behavior: smooth;
      }
      body {
        font-family: "Inter", "Vazirmatn", sans-serif;
        background: #f6f8fc;
        font-size: var(--tweet-font-size);
      }
      .dark body {
        background: #141925;
        color: #bdbdbd;
      }
      .tweet-card {
        animation: fadeInUp 0.45s cubic-bezier(0.23, 1.04, 0.36, 1) both;
        opacity: 0;
        border-radius: 1.13rem;
        margin-bottom: 1.02rem;
        box-shadow: 0 2px 18px 0 #0001;
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(10px) saturate(110%) contrast(1.03);
        -webkit-backdrop-filter: blur(10px) saturate(110%) contrast(1.03);
        border: 1.5px solid #f2f2f6;
      }
      .dark .tweet-card .tweet-author {
        color: #fff !important;
      }
      .dark .tweet-card .tweet-text {
        color: #e7edfa !important;
      }
      .dark .app-title {
        color: #fff !important;
      }
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .dark .tweet-card {
        background: rgba(27, 33, 54, 0.95) !important;
        border-color: #25293c;
        box-shadow: 0 2px 18px 0 #0004;
      }
      .rtl {
        direction: rtl;
        font-family: Vazirmatn, sans-serif !important;
      }
      .ltr {
        direction: ltr;
        font-family: Inter, sans-serif !important;
      }
      .tweet-media-img {
        width: 100%;
        max-width: 320px;
        aspect-ratio: 1.15/1;
        height: 185px;
        object-fit: cover;
        border-radius: 0.88rem;
        border: 1px solid #e6e6e6;
        background: #f4f7fa;
        margin: 10px auto 2px auto;
        display: block;
        box-shadow: 0 2px 14px 0 #0002;
        transition: filter 0.15s;
      }
      .tweet-media-img:hover {
        filter: brightness(0.96);
      }
      .tweet-media-video {
        width: 100%;
        max-width: 320px;
        aspect-ratio: 1.15/1;
        height: 185px;
        object-fit: cover;
        border-radius: 0.88rem;
        border: 1px solid #e6e6e6;
        display: block;
        margin: 10px auto 0 auto;
        background: #ddd;
      }
      .dark .tweet-media-img,
      .dark .tweet-media-video {
        border-color: #232f41;
        background: #212941;
      }
      #ptr-container {
        transition: height 0.32s;
        overflow: hidden;
      }
      #ptr-icon {
        transition: transform 0.3s;
      }
      .header-glass {
        background: rgba(255, 255, 255, 0.78);
        backdrop-filter: blur(30px) saturate(130%) contrast(1.08);
        -webkit-backdrop-filter: blur(30px) saturate(130%) contrast(1.08);
        box-shadow: 0 3px 36px 0 #0001, 0 1.5px 0 #d3d8e6;
        border-radius: 0 0 2rem 2rem;
      }
      .dark .header-glass {
        background: rgba(22, 27, 44, 0.9);
        backdrop-filter: blur(32px) saturate(140%) contrast(1.1);
        -webkit-backdrop-filter: blur(32px) saturate(140%) contrast(1.1);
        box-shadow: 0 3px 24px 0 #0005, 0 1.5px 0 #242f41;
      }
      .app-title {
        font-weight: 700;
        letter-spacing: 0;
        font-size: 1.11rem;
      }
      .action-btn {
        cursor: pointer;
        font-size: 1.22rem;
        padding: 0.57rem;
        border-radius: 50%;
        border: none;
        background: none;
        transition: background 0.18s, color 0.15s;
        margin-left: 0.13rem;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .action-btn.active,
      .action-btn:hover {
        background: #e6ecf5;
      }
      .dark .action-btn.active,
      .dark .action-btn:hover {
        background: #2c3953;
      }
      .action-btn.selected {
        color: #2563eb !important;
        background: #c7e1ff;
      }
      .dark .action-btn.selected {
        color: #60a5fa !important;
        background: #293b56;
      }
      #logout-btn {
        color: #ef4444;
      }
      #logout-btn:hover {
        background: #fee2e2;
      }
      .dark #logout-btn {
        color: #f87171;
      }
      .dark #logout-btn:hover {
        background: #3f2727;
      }
      .tweet-card.compact .tweet-media-img,
      .tweet-card.compact .tweet-media-video {
        display: none !important;
      }
      .tweet-meta-bar {
        font-size: 0.98rem;
      }
      .tweet-card .tweet-author {
        font-size: 14.3px;
      }
      .bookmark-btn {
        color: #a1adc9;
        font-size: 1.1rem;
        border: none;
        background: transparent;
        border-radius: 50%;
        padding: 0.3rem;
        cursor: pointer;
        transition: color 0.16s, background 0.13s;
      }
      .bookmark-btn.active {
        color: #eab308;
      }
      .bookmark-btn:hover {
        background: #eef0f7;
      }
      .dark .bookmark-btn:hover {
        background: #23283b;
      }
      #searchBar {
        border-radius: 1.3rem;
        background: rgba(244, 245, 250, 0.76);
        border: 1.3px solid #e0e4ea;
        margin: 12px auto 3px auto;
        font-size: 15px;
        font-family: Vazirmatn, Inter;
        width: 100%;
        padding: 0.7rem 2.5rem 0.7rem 1.2rem;
        box-shadow: 0 1px 10px #0000;
        outline: 0;
        color: #40495c;
        transition: 0.16s;
        display: block;
      }
      #searchBar:focus {
        background: #fff;
        border-color: #adbeff;
      }
      .dark #searchBar {
        background: rgba(37, 39, 60, 0.93);
        color: #c9d5ff;
        border-color: #29304d;
      }
      #bookmark-section {
        background: rgba(255, 255, 255, 0.97);
        border-radius: 1.3rem;
        padding: 10px 9px 12px 9px;
        margin-top: 18px;
        box-shadow: 0 2px 14px 0 #0001;
        border: 1.5px solid #f1f1f1;
      }
      .dark #bookmark-section {
        background: rgba(31, 37, 53, 0.99);
        border-color: #232942;
      }
      footer {
        direction: rtl;
        padding: 14px 0 12px 0;
        background: rgba(245, 248, 255, 0.86);
        border-top: 1.5px solid #e8eaee;
        text-align: center;
        font-size: 14px;
        color: #8a98b8;
        font-family: Vazirmatn, Inter, sans-serif;
        margin-top: 48px;
      }
      .dark footer {
        background: rgba(27, 34, 54, 0.96);
        color: #b8bed4;
        border-top: 1.5px solid #232a3a;
      }
      #goTopBtn {
        position: fixed;
        bottom: 24px;
        left: 24px;
        z-index: 70;
        display: none;
        width: 39px;
        height: 39px;
        border-radius: 50%;
        background: rgba(243, 244, 250, 0.94);
        color: #338cfb;
        border: none;
        box-shadow: 0 4px 14px 0 #0001;
        align-items: center;
        justify-content: center;
        font-size: 1.18rem;
        transition: 0.18s;
      }
      #goTopBtn:active {
        transform: scale(0.92);
      }
      .dark #goTopBtn {
        background: rgba(36, 41, 57, 0.92);
        color: #82aaff;
      }
      #goTopBtn.visible {
        display: flex;
      }
      #lightbox-overlay {
        display: none;
        position: fixed;
        z-index: 1100;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(22, 24, 35, 0.92);
        align-items: center;
        justify-content: center;
        transition: background 0.28s;
      }
      #lightbox-overlay.active {
        display: flex;
      }
      #lightbox-img {
        max-width: 95vw;
        max-height: 84vh;
        border-radius: 1.4rem;
        box-shadow: 0 12px 52px #000b;
        background: #111;
        object-fit: contain;
      }
      #lightbox-close {
        position: absolute;
        top: 24px;
        right: 24px;
        color: #fff;
        font-size: 1.65rem;
        background: rgba(33, 33, 33, 0.14);
        border-radius: 50%;
        border: none;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: 0.16s;
      }
      #lightbox-close:hover {
        background: rgba(222, 222, 222, 0.22);
      }
      #fontSizeMenu {
        display: none;
        position: absolute;
        left: 0;
        right: 0;
        margin: auto;
        top: 52px;
        z-index: 99;
        background: rgba(255, 255, 255, 0.98);
        border-radius: 1.15rem;
        box-shadow: 0 3px 18px #0002;
        width: 250px;
        text-align: center;
        padding: 11px 0 7px 0;
        border: 1px solid #e7e8ee;
      }
      .dark #fontSizeMenu {
        background: #23283b;
        color: #fff;
        border-color: #232942;
      }
      .font-opt {
        display: inline-block;
        cursor: pointer;
        margin: 0 5px;
        font-size: 15px;
        padding: 7px 15px;
        border-radius: 1rem;
      }
      .font-opt.selected,
      .font-opt:hover {
        background: #2563eb;
        color: #fff;
      }
      .dark .font-opt.selected,
      .dark .font-opt:hover {
        background: #3887ff;
        color: #fff;
      }
    </style>
  </head>
  <body>
    <div id="login-layer" class="login-layer">
      <div class="w-full max-w-sm p-8 space-y-6 rounded-2xl login-card">
        <div class="text-center">
          <img
            src="https://i.ibb.co/CpfLvZLq/App-Icon-2x.png"
            class="mx-auto"
            style="
              width: 4rem;
              height: 4rem;
              border-radius: 20%;
              box-shadow: 0 0 12px #6a95d7;
            "
          />
          <h1 class="mt-4 text-2xl font-bold text-gray-800 dark:text-gray-100">
            آخرین خبر
          </h1>
          <p class="text-gray-500 dark:text-gray-400">
            برای مشاهده اخبار، لطفا وارد شوید
          </p>
        </div>
        <form id="loginForm" class="space-y-4">
          <div>
            <input
              type="text"
              id="username"
              placeholder="نام کاربری"
              required
              class="w-full px-4 py-2.5 text-sm border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
            />
          </div>
          <div>
            <input
              type="password"
              id="password"
              placeholder="رمز عبور"
              required
              class="w-full px-4 py-2.5 text-sm border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
            />
          </div>
          <button
            type="submit"
            class="w-full py-2.5 text-sm font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition"
          >
            ورود
          </button>
        </form>
        <div
          id="login-error-message"
          class="hidden p-3 text-sm text-center text-red-700 bg-red-100 border border-red-300 rounded-lg"
        >
          نام کاربری یا رمز عبور اشتباه است.
        </div>
      </div>
    </div>

    <div class="container mx-auto max-w-xl sm:px-0 px-1">
      <header
        class="flex justify-between items-center px-3 pt-5 pb-3 sticky top-0 header-glass backdrop-blur-2xl z-30 relative"
      >
        <span
          class="app-title text-gray-800 dark:text-gray-50 tracking-tight flex items-center gap-2"
        >
          <img
            src="https://i.ibb.co/CpfLvZLq/App-Icon-2x.png"
            style="
              width: 1.7em;
              height: 1.7em;
              border-radius: 15%;
              box-shadow: 0 0 7px #6a95d7;
            "
            alt="app icon"
          />
          آخرین خبر
        </span>
        <div class="flex items-center gap-1">
          <button id="logout-btn" class="action-btn" title="خروج از حساب">
            <i class="fa-solid fa-right-from-bracket"></i>
          </button>
          <button
            id="bookmark-btn"
            class="action-btn"
            title="مشاهده بوکمارک‌ها"
          >
            <i class="fa-solid fa-bookmark"></i>
          </button>
          <button id="font-btn" class="action-btn" title="سایز فونت">
            <i class="fa-solid fa-font"></i>
          </button>
          <button id="mode-btn" class="action-btn" title="تم تیره/روشن">
            <i class="fa-solid fa-moon" id="mode-dark"></i>
            <i class="fa-solid fa-sun hidden" id="mode-light"></i>
          </button>
          <button id="view-btn" class="action-btn" title="حالت فشرده/کامل">
            <i class="fa-solid fa-align-left" id="view-full"></i>
            <i class="fa-solid fa-align-justify hidden" id="view-compact"></i>
          </button>
          <button id="refresh-btn" class="action-btn" title="رفرش اخبار">
            <i class="fa-solid fa-rotate-right"></i>
          </button>
        </div>
        <div id="fontSizeMenu">
          <span class="font-opt" data-size="small" style="font-size: 13px"
            >کوچک</span
          >
          <span class="font-opt" data-size="medium" style="font-size: 15px"
            >متوسط</span
          >
          <span class="font-opt" data-size="large" style="font-size: 18px"
            >بزرگ</span
          >
          <span class="font-opt" data-size="xlarge" style="font-size: 21px"
            >خیلی بزرگ</span
          >
        </div>
      </header>
      <input
        id="searchBar"
        placeholder="جستجوی زنده در متن اخبار..."
        autocomplete="off"
      />
      <div id="bookmark-section" class="hidden"></div>
      <div id="ptr-container" class="w-full" style="height: 0">
        <div
          id="ptr-icon"
          class="w-8 h-8 border-4 border-dashed rounded-full animate-spin mx-auto mt-2"
          style="border-top-color: #3b82f6"
        ></div>
      </div>
      <main id="feedContainer" class="mt-3 flex flex-col gap-2"></main>
      <div
        id="loading-spinner"
        class="flex flex-col items-center justify-center py-8"
      >
        <div
          class="w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"
        ></div>
        <span
          class="mt-3 text-gray-500 dark:text-gray-300"
          style="font-size: 14px"
          >در حال بارگذاری...</span
        >
      </div>
      <div
        id="error-message"
        class="hidden bg-red-50 border border-red-300 text-red-700 px-4 py-3 rounded-lg my-4"
        role="alert"
      >
        <span id="error-text"></span>
      </div>
    </div>
    <footer>
      <div
        style="
          max-width: 560px;
          margin: 0 auto;
          line-height: 2;
          font-size: 14px;
        "
      >
        <div class="flex justify-center items-center gap-2 mb-2">
          <img
            src="https://i.ibb.co/CpfLvZLq/App-Icon-2x.png"
            style="
              width: 2em;
              height: 2em;
              border-radius: 16%;
              box-shadow: 0 0 9px #6a95d7;
            "
          />
        </div>
        <b>سلب مسئولیت:</b><br />
        این اپلیکیشن هیچ یک از اخبار، مطالب، تصاویر یا نظرات نمایش داده شده را
        تأیید یا تصدیق نمی‌کند و صرفاً بازنشر اتوماتیک محتوا به منظور
        اطلاع‌رسانی است.<br />
        این اپلیکیشن هیچ مسئولیتی در قبال صحت، اعتبار، یا محتوای اخبار، مطالب،
        تصاویر و اظهارنظرهای ارائه‌شده ندارد و تمامی مسئولیت‌ها بر عهده مراجع
        اصلی یا منتشرکنندگان اولیه آن مطالب می‌باشد.<br />
        استفاده از داده‌ها و اطلاعات ارائه‌شده صرفاً با مسئولیت شخصی کاربران
        بوده و هیچ گونه مسئولیتی متوجه این اپلیکیشن نمی‌باشد. هرگونه استناد یا
        استفاده از اطلاعات این برنامه، به طور کامل بر عهده کاربر است و هیچ حقی
        علیه اپلیکیشن قابل پیگیری نمی‌باشد.<br />
        <span style="font-size: 13px; color: #426bba">Copyright © 2025</span>
      </div>
    </footer>
    <div id="lightbox-overlay">
      <img id="lightbox-img" src="" alt="پیش‌نمایش" />
      <button id="lightbox-close"><i class="fa fa-times"></i></button>
    </div>
    <button id="goTopBtn" aria-label="برو بالا">
      <i class="fa fa-arrow-up"></i>
    </button>

    <script>
      // --- بخش مدیریت لاگین ---
      const loginLayer = document.getElementById("login-layer");
      const loginForm = document.getElementById("loginForm");
      const loginErrorMessage = document.getElementById("login-error-message");
      const logoutBtn = document.getElementById("logout-btn");

      async function sha256(message) {
        const msgBuffer = new TextEncoder().encode(message);
        const hashBuffer = await crypto.subtle.digest("SHA-256", msgBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map((b) => b.toString(16).padStart(2, "0")).join("");
      }

      const correctUsernameHash =
        "8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918"; // admin
      const correctPasswordHash =
        "ef92b778bafe771e89245b89ec5b8c55ba25af363cd46c0298a5e84062a74c35"; // password123
      const listId = "1934944419452506128";

      function hideLogin() {
        loginLayer.classList.add("hidden-layer");
      }

      function showLogin() {
        loginLayer.classList.remove("hidden-layer");
        document.getElementById("username").value = "";
        document.getElementById("password").value = "";
      }

      loginForm.addEventListener("submit", async function (event) {
        event.preventDefault();
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;

        const enteredUsernameHash = await sha256(username);
        const enteredPasswordHash = await sha256(password);

        if (
          enteredUsernameHash === correctUsernameHash &&
          enteredPasswordHash === correctPasswordHash
        ) {
          localStorage.setItem("isAuthenticated", "true");
          localStorage.setItem("encodedListId", btoa(listId));
          loginErrorMessage.classList.add("hidden");
          hideLogin();
          // اجرای اسکریپت اصلی برای اولین بار
          if (!window.mainAppInitialized) {
            initializeMainApp();
          }
        } else {
          loginErrorMessage.classList.remove("hidden");
        }
      });

      logoutBtn.addEventListener("click", function () {
        localStorage.removeItem("isAuthenticated");
        localStorage.removeItem("encodedListId");
        showLogin();
      });

      // بررسی وضعیت لاگین هنگام بارگذاری اولیه صفحه
      document.addEventListener("DOMContentLoaded", () => {
        if (localStorage.getItem("isAuthenticated") === "true") {
          hideLogin();
          if (!window.mainAppInitialized) {
            initializeMainApp();
          }
        } else {
          showLogin();
        }
      });
    </script>

    <script>
      function initializeMainApp() {
        // این فلگ جلوی اجرای مجدد را می‌گیرد
        window.mainAppInitialized = true;

        // --- تابع getListId اصلاح شده برای خواندن از localStorage ---
        function getListId() {
          const encodedListId = localStorage.getItem("encodedListId");
          if (encodedListId) {
            try {
              return atob(encodedListId);
            } catch (e) {
              console.error("Failed to decode List ID:", e);
              showLogin(); // تابع showLogin از اسکریپت قبلی
              return null;
            }
          }
          showLogin();
          return null;
        }

        // --- بقیه کد اصلی شما بدون هیچ تغییری از اینجا شروع می‌شود ---
        const NITTER_INSTANCES = [
          "https://nitter.pussthecat.org",
          "https://nitter.net",
          "https://nitter.privacydev.net",
          "https://nitter.cz",
        ];
        const CORS_PROXY = "https://api.allorigins.win/raw?url=";
        let nitterIndex = 0,
          PROXY_URL = NITTER_INSTANCES[nitterIndex];
        let nextCursor = null,
          isLoading = false;
        let compactMode = true;
        let allTweets = [],
          filteredTweets = [],
          bookmarks = JSON.parse(
            localStorage.getItem("bookmarkedTweets") || "[]"
          );

        const fontSizeKey = "newsFontSize",
          defaultFont = "medium";
        const fontSizes = {
          small: "var(--tweet-font-size-small)",
          medium: "var(--tweet-font-size-medium)",
          large: "var(--tweet-font-size-large)",
          xlarge: "var(--tweet-font-size-xlarge)",
        };
        let fontSize = localStorage.getItem(fontSizeKey) || defaultFont;
        function setFontSize(size) {
          fontSize = size;
          localStorage.setItem(fontSizeKey, size);
          document.body.style.setProperty("--tweet-font-size", fontSizes[size]);
          Array.from(document.getElementsByClassName("tweet-card")).forEach(
            (card) => {
              card.style.fontSize = fontSizes[size];
            }
          );
          applyFontMenuState();
        }
        function applyFontMenuState() {
          document.querySelectorAll(".font-opt").forEach((opt) => {
            opt.classList.remove("selected");
            if (opt.getAttribute("data-size") === fontSize)
              opt.classList.add("selected");
          });
        }
        setFontSize(fontSize);

        const fontBtn = document.getElementById("font-btn");
        const fontSizeMenu = document.getElementById("fontSizeMenu");
        fontBtn.onclick = function (e) {
          fontSizeMenu.style.display =
            fontSizeMenu.style.display === "block" ? "none" : "block";
          applyFontMenuState();
          e.stopPropagation();
        };
        fontSizeMenu.querySelectorAll(".font-opt").forEach((opt) => {
          opt.onclick = function () {
            setFontSize(opt.getAttribute("data-size"));
            fontSizeMenu.style.display = "none";
          };
        });
        document.body.addEventListener("click", function (e) {
          if (!fontSizeMenu.contains(e.target) && e.target !== fontBtn)
            fontSizeMenu.style.display = "none";
        });

        const html = document.documentElement;
        const modeBtn = document.getElementById("mode-btn");
        const modeDark = document.getElementById("mode-dark");
        const modeLight = document.getElementById("mode-light");
        function applyTheme(theme) {
          if (theme === "dark") {
            html.classList.add("dark");
            modeDark.classList.add("hidden");
            modeLight.classList.remove("hidden");
            modeBtn.classList.add("active");
            modeLight.classList.add("selected");
            modeDark.classList.remove("selected");
          } else {
            html.classList.remove("dark");
            modeLight.classList.add("hidden");
            modeDark.classList.remove("hidden");
            modeBtn.classList.add("active");
            modeDark.classList.add("selected");
            modeLight.classList.remove("selected");
          }
        }
        modeBtn.onclick = () => {
          const newTheme = html.classList.contains("dark") ? "light" : "dark";
          localStorage.setItem("theme", newTheme);
          applyTheme(newTheme);
        };

        // اینجا دیگر DOMContentLoaded نداریم چون تابع initializeMainApp خودش توسط DOMContentLoaded در اسکریپت اول فراخوانی می‌شود
        const savedTheme =
          localStorage.getItem("theme") ||
          (window.matchMedia("(prefers-color-scheme: dark)").matches
            ? "dark"
            : "light");
        applyTheme(savedTheme);
        fetchAndParseTweets(); // اولین فراخوانی

        const viewBtn = document.getElementById("view-btn");
        const viewFull = document.getElementById("view-full");
        const viewCompact = document.getElementById("view-compact");
        function updateCompactView() {
          compactMode = !compactMode;
          renderTweets(filteredTweets);
          if (compactMode) {
            viewCompact.classList.remove("hidden");
            viewFull.classList.add("hidden");
            viewBtn.classList.add("selected");
          } else {
            viewFull.classList.remove("hidden");
            viewCompact.classList.add("hidden");
            viewBtn.classList.remove("selected");
          }
        }
        viewBtn.onclick = updateCompactView;

        document.getElementById("refresh-btn").onclick = function () {
          nextCursor = null;
          nitterIndex = 0;
          PROXY_URL = NITTER_INSTANCES[0];
          fetchAndParseTweets();
        };

        const feedContainer = document.getElementById("feedContainer");
        const loadingSpinner = document.getElementById("loading-spinner");
        const errorMessage = document.getElementById("error-message");
        const errorText = document.getElementById("error-text");
        function isFa(text) {
          return /[\u0600-\u06FF]/.test(text);
        }
        function displayError(msg) {
          errorText.innerHTML = msg;
          errorMessage.classList.remove("hidden");
          loadingSpinner.classList.add("hidden");
        }
        function hideError() {
          errorMessage.classList.add("hidden");
        }
        function showLoading() {
          loadingSpinner.classList.remove("hidden");
        }
        function hideLoading() {
          loadingSpinner.classList.add("hidden");
        }
        function timeFormat(dateString) {
          try {
            if (!dateString) return "—";
            let d = new Date(dateString);
            if (isNaN(d)) return dateString;
            return (
              d.toLocaleDateString("fa-IR") +
              "، " +
              d.toLocaleTimeString("fa-IR", {
                hour: "2-digit",
                minute: "2-digit",
              })
            );
          } catch {
            return dateString || "—";
          }
        }
        function parseNumber(node) {
          if (!node) return "—";
          const val = node.textContent.replace(/[^\d,]/g, "").replace(/,/g, "");
          return val ? parseInt(val, 10) : "—";
        }
        function fallbackImg(ev) {
          ev.target.src = "https://via.placeholder.com/320x180?text=...";
        }

        function renderTweets(tweets) {
          feedContainer.innerHTML = "";
          if (!tweets.length) {
            feedContainer.innerHTML =
              '<div class="px-6 py-12 text-center text-gray-400 dark:text-gray-400">نتیجه‌ای یافت نشد.</div>';
            return;
          }
          tweets.forEach((tweet) => {
            const card = createTweetCard(tweet);
            card.style.fontSize = fontSizes[fontSize];
            feedContainer.appendChild(card);
          });
          Array.from(document.getElementsByClassName("tweet-card")).forEach(
            (card) => {
              if (compactMode) card.classList.add("compact");
              else card.classList.remove("compact");
            }
          );
        }

        function createTweetCard(tweet) {
          const isPersian = isFa(tweet.text);
          const dirClass = isPersian ? "rtl font-vazir" : "ltr";
          let mediaHtml = "";
          if (tweet.media.images.length > 0) {
            mediaHtml += `<div class="scroll-imgs mt-2 justify-center flex w-full">`;
            tweet.media.images.forEach((imgSrc, idx) => {
              mediaHtml += `<a href="#" data-img="${imgSrc}" class="tweet-img-link"><img src="${imgSrc}" class="tweet-media-img mx-auto" loading="lazy" onerror="fallbackImg(event)"></a>`;
            });
            mediaHtml += `</div>`;
          }
          if (tweet.media.videos.length > 0) {
            mediaHtml += `<div class="mt-2 flex justify-center"><video controls playsinline muted class="tweet-media-video mx-auto" preload="metadata" onerror="this.poster='https://via.placeholder.com/320x180?text=VIDEO';"><source src="${tweet.media.videos[0]}" type="video/mp4">ویدیو پشتیبانی نمی‌شود.</video></div>`;
          }
          const isBookmarked = bookmarks.some((b) => b.id === tweet.id);
          const card = document.createElement("article");
          card.className =
            "tweet-card bg-white/80 dark:bg-[#1b2236] px-4 py-4 transition hover:shadow-2xl relative";
          card.innerHTML = `<div class="flex items-start gap-3"><img src="${
            tweet.user.avatar
          }" alt="${
            tweet.user.name
          }" class="w-11 h-11 rounded-full border shadow" onerror="fallbackImg(event)"><div class="flex-1 min-w-0"><div class="flex flex-row items-center justify-between"><div class="tweet-author font-semibold text-[14.3px] text-gray-900 dark:text-gray-100">${
            tweet.user.name
          }<span class="mx-1 text-gray-400 text-[12.2px]">@${
            tweet.user.username
          }</span></div><span class="text-xs text-gray-400 dark:text-gray-400" title="${
            tweet.dateFull
          }">${timeFormat(
            tweet.dateFull
          )}</span></div><div class="tweet-text mt-1.5 text-gray-800 dark:text-gray-100 ${dirClass}">${
            tweet.text
          }</div>${mediaHtml}<div class="tweet-meta-bar mt-3 flex items-center gap-5 text-xs text-gray-500 dark:text-gray-400 select-none"><span title="ریپلای"><i class="fa-regular fa-comment mr-1"></i> ${
            tweet.replies
          }</span><span title="ریتوییت"><i class="fa-solid fa-retweet mr-1"></i> ${
            tweet.reposts
          }</span><span title="لایک"><i class="fa-regular fa-heart mr-1"></i> ${
            tweet.likes
          }</span><span title="ویو"><i class="fa-regular fa-eye mr-1"></i> ${
            tweet.views
          }</span><button class="bookmark-btn${
            isBookmarked ? " active" : ""
          }" title="بوکمارک" data-tweetid="${
            tweet.id
          }"><i class="fa-solid fa-bookmark"></i></button><a href="https://x.com/${
            tweet.user.username
          }/status/${
            tweet.id
          }" target="_blank" class="text-blue-400 hover:underline whitespace-nowrap">مشاهده منبع<i class="fa-brands fa-x-twitter"></i></a></div></div></div>`;
          setTimeout(() => {
            card.style.opacity = "1";
          }, 45);
          card.querySelectorAll(".tweet-img-link").forEach((link) => {
            link.onclick = (e) => {
              e.preventDefault();
              showLightbox(link.getAttribute("data-img"));
            };
          });
          card.querySelector(".bookmark-btn").onclick = function () {
            let tweetid = this.getAttribute("data-tweetid");
            const existingBookmarkIndex = bookmarks.findIndex(
              (b) => b.id === tweetid
            );
            if (existingBookmarkIndex > -1) {
              bookmarks.splice(existingBookmarkIndex, 1);
            } else {
              const tweetToAdd = allTweets.find((t) => t.id === tweetid);
              if (tweetToAdd) bookmarks.push(tweetToAdd);
            }
            localStorage.setItem("bookmarkedTweets", JSON.stringify(bookmarks));
            this.classList.toggle("active");
          };
          return card;
        }

        function showLightbox(src) {
          const overlay = document.getElementById("lightbox-overlay");
          const img = document.getElementById("lightbox-img");
          img.src = src;
          overlay.classList.add("active");
        }
        document.getElementById("lightbox-overlay").onclick = function (e) {
          if (e.target === this || e.target.id === "lightbox-close")
            this.classList.remove("active");
        };

        async function fetchAndParseTweets(cursor = null, retry = true) {
          if (isLoading) return;
          isLoading = true;
          hideError();
          if (!cursor) {
            showLoading();
            feedContainer.innerHTML = "";
            allTweets = [];
          }
          const currentListId = getListId();
          if (!currentListId) {
            isLoading = false;
            hideLoading();
            return;
          }
          let listUrl = `${PROXY_URL}/i/lists/${currentListId}${
            cursor ? `?cursor=${cursor}` : ""
          }`;
          let fetchUrl = `${CORS_PROXY}${encodeURIComponent(listUrl)}`;
          try {
            const response = await fetch(fetchUrl);
            if (!response.ok)
              throw new Error(`HTTP error! Status: ${response.status}`);
            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, "text/html");
            const tweetEls = doc.querySelectorAll(
              ".timeline-item:not(.show-more)"
            );
            if (!tweetEls.length) {
              if (allTweets.length === 0)
                throw new Error(
                  "توییتی پیدا نشد. لیست خصوصی یا سرور Nitter قطع است."
                );
            }
            tweetEls.forEach((tweetEl) => {
              const avatarNode = tweetEl.querySelector(".avatar");
              let avatarUrl = avatarNode ? avatarNode.getAttribute("src") : "";
              if (avatarUrl && !/^https?:\/\//.test(avatarUrl))
                avatarUrl = PROXY_URL + avatarUrl;
              const contentNode = tweetEl.querySelector(".tweet-content");
              let dateFull =
                tweetEl.querySelector(".tweet-date a")?.getAttribute("title") ||
                tweetEl
                  .querySelector(".tweet-date time")
                  ?.getAttribute("datetime") ||
                "";
              const replies = parseNumber(
                tweetEl.querySelector(".icon-comment")?.parentElement
              );
              const reposts = parseNumber(
                tweetEl.querySelector(".icon-retweet")?.parentElement
              );
              const likes = parseNumber(
                tweetEl.querySelector(".icon-heart")?.parentElement
              );
              let views = null;
              let viewsEl = tweetEl.querySelector(
                ".icon-chart-bar, .fa-chart-bar, .fa-eye, .icon-eye"
              );
              if (viewsEl) views = parseNumber(viewsEl.parentElement);
              else views = "—";
              let images = [];
              tweetEl.querySelectorAll(".attachment.image a").forEach((a) => {
                let src = a.getAttribute("href");
                if (src && !/^https?:\/\//.test(src)) src = PROXY_URL + src;
                images.push(src);
              });
              let videos = [];
              tweetEl
                .querySelectorAll(".attachment.video-container video source")
                .forEach((srcNode) => {
                  let src = srcNode.getAttribute("src");
                  if (src && !/^https?:\/\//.test(src)) src = PROXY_URL + src;
                  videos.push(src);
                });
              const tweetLink =
                tweetEl.querySelector(".tweet-link")?.getAttribute("href") ||
                "";
              const userLink =
                tweetEl
                  .querySelector(".username")
                  ?.parentElement?.getAttribute("href") || "";
              const username =
                tweetEl
                  .querySelector(".username")
                  ?.textContent.trim()
                  .replace("@", "") || "";
              allTweets.push({
                id: tweetLink.split("/").pop(),
                user: {
                  name:
                    tweetEl.querySelector(".fullname")?.textContent.trim() ||
                    "",
                  username: username,
                  avatar: avatarUrl,
                  url: userLink,
                },
                text: contentNode ? contentNode.innerHTML : "",
                dateFull,
                replies,
                reposts,
                likes,
                views,
                media: { images, videos },
              });
            });
            const loadMoreEl = doc.querySelector(".show-more a");
            nextCursor = loadMoreEl
              ? new URLSearchParams(
                  loadMoreEl.getAttribute("href").split("?")[1]
                ).get("cursor")
              : null;
            applyFilters();
          } catch (error) {
            if (retry && nitterIndex < NITTER_INSTANCES.length - 1) {
              nitterIndex++;
              PROXY_URL = NITTER_INSTANCES[nitterIndex];
              setTimeout(() => fetchAndParseTweets(cursor, false), 900);
            } else {
              displayError(error.message || "بارگذاری ناموفق بود.");
            }
          } finally {
            isLoading = false;
            hideLoading();
            ptrContainer.style.height = "0";
          }
        }

        function applyFilters() {
          const searchTerm = document
            .getElementById("searchBar")
            .value.toLowerCase()
            .trim();
          filteredTweets = allTweets.filter((tw) => {
            let matchesSearch =
              !searchTerm ||
              tw.text
                .replace(/<[^>]+>/g, "")
                .toLowerCase()
                .includes(searchTerm);
            return matchesSearch;
          });
          renderTweets(filteredTweets);
        }
        document.getElementById("searchBar").oninput = applyFilters;

        window.addEventListener("scroll", () => {
          if (isLoading || !nextCursor) return;
          if (
            window.innerHeight + window.scrollY >=
            document.body.offsetHeight - 700
          ) {
            fetchAndParseTweets(nextCursor);
          }
          if (window.scrollY > 400)
            document.getElementById("goTopBtn").classList.add("visible");
          else document.getElementById("goTopBtn").classList.remove("visible");
        });
        document.getElementById("goTopBtn").onclick = () => {
          window.scrollTo({ top: 0, behavior: "smooth" });
        };

        const ptrContainer = document.getElementById("ptr-container");
        let startY = 0,
          pullDistance = 0,
          ptrThreshold = 70;
        document.body.addEventListener(
          "touchstart",
          (e) => {
            if (window.scrollY === 0) startY = e.touches[0].pageY;
          },
          { passive: true }
        );
        document.body.addEventListener(
          "touchmove",
          (e) => {
            if (window.scrollY === 0 && startY > 0) {
              const currentY = e.touches[0].pageY;
              pullDistance = Math.max(0, currentY - startY);
              if (pullDistance > 0)
                ptrContainer.style.height = `${Math.min(
                  pullDistance,
                  ptrThreshold
                )}px`;
            }
          },
          { passive: true }
        );
        document.body.addEventListener("touchend", () => {
          if (pullDistance >= ptrThreshold) {
            ptrContainer.style.height = `${ptrThreshold}px`;
            nextCursor = null;
            nitterIndex = 0;
            PROXY_URL = NITTER_INSTANCES[0];
            fetchAndParseTweets();
          } else {
            ptrContainer.style.height = "0";
          }
          startY = 0;
          pullDistance = 0;
        });

        document.getElementById("bookmark-btn").onclick = function () {
          const sec = document.getElementById("bookmark-section");
          if (sec.classList.contains("hidden")) {
            sec.classList.remove("hidden");
            sec.innerHTML =
              "<h3 class='mb-2 font-bold text-sm text-blue-700 dark:text-blue-200'>توییت‌های بوکمارک‌شده:</h3>";
            if (!bookmarks.length)
              sec.innerHTML +=
                "<div class='text-gray-400 dark:text-gray-400 text-center'>هنوز هیچ توییتی بوکمارک نشده.</div>";
            bookmarks.forEach((tw) => {
              const card = createTweetCard(tw);
              card.style.fontSize = fontSizes[fontSize];
              sec.appendChild(card);
            });
            window.scrollTo({ top: 0, behavior: "smooth" });
          } else {
            sec.classList.add("hidden");
            sec.innerHTML = "";
          }
        };
      }
    </script>
    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", function () {
          navigator.serviceWorker.register("sw.js").catch(() => {});
        });
      }
    </script>
  </body>
</html>
