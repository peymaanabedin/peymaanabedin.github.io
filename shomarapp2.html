<!DOCTYPE html><html lang="fa" dir="rtl"><head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>شمار</title>
    <meta name="description" content="حسابداری شخصی شمار">
    <meta name="application-name" content="شمار">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="شمار">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/pdc7Ksxc/App-Icon-2x.png">
    <link rel="icon" type="image/png" href="https://i.postimg.cc/pdc7Ksxc/App-Icon-2x.png">
    <link rel="manifest" href="data:application/manifest+json;charset=utf-8,{
        &quot;name&quot;: &quot;شمار&quot;,
        &quot;short_name&quot;: &quot;شمار&quot;,
        &quot;description&quot;: &quot;حسابداری شخصی شمار&quot;,
        &quot;start_url&quot;: &quot;.&quot;,
        &quot;display&quot;: &quot;standalone&quot;,
        &quot;background_color&quot;: &quot;#f2f2f7&quot;,
        &quot;theme_color&quot;: &quot;#007AFF&quot;,
        &quot;icons&quot;: [
            { &quot;src&quot;: &quot;https://i.postimg.cc/pdc7Ksxc/App-Icon-2x.png&quot;, &quot;sizes&quot;: &quot;192x192&quot;, &quot;type&quot;: &quot;image/png&quot;, &quot;purpose&quot;: &quot;any&quot; },
            { &quot;src&quot;: &quot;https://i.postimg.cc/pdc7Ksxc/App-Icon-2x.png&quot;, &quot;sizes&quot;: &quot;512x512&quot;, &quot;type&quot;: &quot;image/png&quot;, &quot;purpose&quot;: &quot;any&quot; },
            { &quot;src&quot;: &quot;https://i.postimg.cc/pdc7Ksxc/App-Icon-2x.png&quot;, &quot;sizes&quot;: &quot;192x192&quot;, &quot;type&quot;: &quot;image/png&quot;, &quot;purpose&quot;: &quot;maskable&quot; },
            { &quot;src&quot;: &quot;https://i.postimg.cc/pdc7Ksxc/App-Icon-2x.png&quot;, &quot;sizes&quot;: &quot;512x512&quot;, &quot;type&quot;: &quot;image/png&quot;, &quot;purpose&quot;: &quot;maskable&quot; }
        ]
    }">
    <link rel="apple-touch-startup-image" href="https://i.postimg.cc/pdc7Ksxc/App-Icon-2x.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet"
        type="text/css" />
    <link rel="stylesheet" href="https://unpkg.com/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css" />
    <style>
        :root {
            /* Color Palette (iOS Inspired) */
            --blue-ios: #007AFF;
            --blue-ios-hover: #0056b3;
            --green-ios: #34C759;
            --red-ios: #FF3B30;
            --orange-ios: #FF9500;
            --purple-ios: #AF52DE;
            --cyan-ios: #32ADEA;
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-400: #ced4da;
            --gray-500: #adb5bd;
            --gray-600: #6c757d;
            --gray-700: #495057;
            --gray-800: #343a40;
            --gray-900: #212529;
            --bg-light: #f2f2f7;
            --card-light: #ffffff;
            --text-light: #000000;
            --subtext-light: #6e6e73;
            --border-light: rgba(60, 60, 67, 0.29);
            --bg-dark: #000000;
            --card-dark: #1c1c1e;
            --text-dark: #ffffff;
            --subtext-dark: #8e8e93;
            --border-dark: rgba(84, 84, 88, 0.65);
            --primary: var(--blue-ios);
            --primary-hover: var(--blue-ios-hover);
            --income: var(--green-ios);
            --expense: var(--red-ios);
            --transfer: var(--orange-ios);
            --debt: var(--red-ios);
            --receivable: var(--green-ios);
            --loan: var(--purple-ios);
            --goal: var(--cyan-ios);
            --income-bg-light: rgba(52, 199, 89, 0.15);
            --expense-bg-light: rgba(255, 59, 48, 0.15);
            --income-bg-dark: rgba(52, 199, 89, 0.2);
            --expense-bg-dark: rgba(255, 69, 58, 0.2);
            --font-family: 'Vazirmatn', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --radius: 12px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --transition-fast: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-medium: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            /* Safe Area Insets for iPhone X+ */
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
            --header-height: 48px;
            --nav-height: 60px;
        }

        /* === UI/UX ENHANCEMENTS START === */
        html {
            scroll-behavior: smooth;
        }

        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overscroll-behavior-y: contain;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-light);
            color: var(--text-light);
            transition: background-color 0.3s, color 0.3s;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Active/Press states for better feedback */
        .btn:active,
        .action-card:active,
        .nav-btn:active,
        .list-container li:active,
        .summary-card:active {
            transform: scale(0.97);
            filter: brightness(0.95);
            transition: transform 0.1s, filter 0.1s;
        }

        /* === UI/UX ENHANCEMENTS END === */
        .app-wrapper {
            display: flex;
            flex-direction: column;
            height: 100vh;
            /* Fallback */
            height: -webkit-fill-available;
            /* Critical for iOS PWA */
            overflow: hidden;
            /* Prevent wrapper from scrolling */
        }

        body.dark-mode {
            --bg-light: var(--bg-dark);
            --card-light: var(--card-dark);
            --text-light: var(--text-dark);
            --subtext-light: var(--subtext-dark);
            --border-light: var(--border-dark);
            --income-bg-light: var(--income-bg-dark);
            --expense-bg-light: var(--expense-bg-dark);
        }

        body.modal-open {
            overflow: hidden;
        }

        /* --- APP STRUCTURE --- */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            /* === FIX START === */
            /* The height is now just the bar's height. Padding handles the safe area. */
            height: var(--header-height);
            padding: var(--safe-area-top) 1rem 0;
            /* === FIX END === */
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 100;
            background-color: rgba(242, 242, 247, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-light);
            transition: var(--transition-fast);
            box-sizing: content-box;
            /* Explicitly set for clarity */
        }

        body.dark-mode .app-header {
            background-color: rgba(28, 28, 30, 0.7);
        }

        #app-header-title {
            font-size: 1.1rem;
            font-weight: 600;
            padding: 0 1rem;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-controls>.fas,
        .header-controls .theme-switcher,
        .header-controls .header-icon-btn {
            color: var(--subtext-light);
            cursor: pointer;
            font-size: 1.2rem;
            width: 44px;
            height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: color var(--transition-fast);
        }

        .header-controls>.fas:hover,
        .header-controls .theme-switcher:hover,
        .header-controls .header-icon-btn:hover {
            color: var(--primary);
        }

        .app-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            /* This padding calculation correctly pushes content below the full header/nav height */
            padding: calc(var(--header-height) + var(--safe-area-top) + 1.25rem) 1rem calc(var(--nav-height) + var(--safe-area-bottom) + 1.25rem);
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.4s var(--transition-medium);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card-section {
            background-color: var(--card-light);
            padding: 1.25rem;
            border-radius: var(--radius);
            margin-bottom: 1.25rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
        }

        .section-header h3 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .section-header .header-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .btn {
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-fast);
            font-family: var(--font-family);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            position: relative;
        }

        /* NEW: Active Filter Indicator */
        .btn[data-action="toggle-filters"].filter-active::after {
            content: '';
            position: absolute;
            top: 6px;
            right: 6px;
            width: 8px;
            height: 8px;
            background-color: var(--red-ios);
            border-radius: 50%;
            border: 1px solid var(--card-light);
        }

        body.dark-mode .btn[data-action="toggle-filters"].filter-active::after {
            border-color: var(--card-dark);
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-danger {
            background-color: var(--expense);
            color: white;
        }

        .btn-secondary {
            background-color: var(--gray-200);
            color: var(--text-light);
        }

        body.dark-mode .btn-secondary {
            background-color: var(--gray-800);
            color: var(--text-dark);
        }

        .btn-success {
            background-color: var(--income);
            color: white;
        }

        .main-balance {
            background: linear-gradient(135deg, var(--blue-ios), #5856d6);
            color: white;
            padding: 1.5rem;
            text-align: center;
        }

        .main-balance .balance-title {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .main-balance h4 {
            margin: 0;
            font-weight: 500;
            opacity: 0.8;
            font-size: 0.9rem;
        }

        .main-balance h1 {
            margin: 0;
            font-size: 2.5rem;
            letter-spacing: -1px;
            min-height: 48px;
        }

        #toggle-balance-visibility {
            cursor: pointer;
            opacity: 0.8;
            transition: var(--transition-fast);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .summary-card {
            background-color: var(--bg-light);
            border-radius: var(--radius);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .summary-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow);
        }

        body.dark-mode .summary-card {
            background-color: var(--gray-900);
        }

        .summary-card .card-header {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            margin-bottom: 0;
        }

        .summary-card .card-icon {
            font-size: 0.9rem;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius);
        }

        .summary-card .card-title {
            font-weight: 500;
            color: var(--subtext-light);
            font-size: 0.85rem;
        }

        .summary-card .card-amount {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-light);
            text-align: right;
            width: 100%;
        }

        .summary-card.income .card-icon {
            background-color: var(--income-bg-light);
            color: var(--income);
        }

        .summary-card.expense .card-icon {
            background-color: var(--expense-bg-light);
            color: var(--expense);
        }

        .summary-card.debt .card-icon {
            background-color: var(--expense-bg-light);
            color: var(--debt);
        }

        .summary-card.receivable .card-icon {
            background-color: var(--income-bg-light);
            color: var(--receivable);
        }

        .summary-card.loan .card-icon {
            background-color: rgba(175, 82, 222, 0.15);
            color: var(--loan);
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        .action-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            border-radius: var(--radius);
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s, filter 0.2s;
        }

        .action-card i {
            font-size: 1.5rem;
        }

        .action-card span {
            font-size: 0.8rem;
            font-weight: 500;
        }

        .action-card.income i {
            color: var(--income);
        }

        .action-card.expense i {
            color: var(--expense);
        }

        .action-card.debt i {
            color: var(--debt);
        }

        .action-card.receivable i {
            color: var(--receivable);
        }

        .form-control {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            background-color: var(--gray-200);
            color: var(--text-light);
            box-sizing: border-box;
            transition: var(--transition-fast);
            font-family: var(--font-family);
            font-size: 16px;
        }

        .form-control::placeholder {
            color: var(--subtext-light);
            opacity: 0.9;
        }

        body.dark-mode .form-control {
            background-color: var(--gray-800);
        }

        .form-control:focus {
            border-color: var(--primary);
            outline: none;
            background-color: var(--card-light);
        }

        select.form-control {
            direction: rtl;
            text-align-last: right;
            -moz-text-align-last: right;
        }

        select.form-control option {
            direction: rtl;
            text-align: right;
        }

        .form-group {
            margin-bottom: 1.25rem;
            position: relative;
        }

        .form-group:not(:has(label)) {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--subtext-light);
        }

        /* === NEW: Collapsible Filters Container === */
        .filters-collapsible-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out;
            border-radius: var(--radius);
            margin-top: 1rem;
            padding: 0 1rem;
        }

        .filters-collapsible-container.visible {
            max-height: 1000px;
            /* Should be larger than content height */
            padding: 1rem;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        body.dark-mode .filters-collapsible-container.visible {
            background: rgba(28, 28, 30, 0.6);
            border-color: rgba(84, 84, 88, 0.5);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.5rem 1rem;
        }

        .filter-summary {
            background-color: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 1rem;
            border-radius: var(--radius);
            margin-bottom: 1.25rem;
            border: 1px solid rgba(255, 255, 255, 0.25);
        }

        body.dark-mode .filter-summary {
            background-color: rgba(28, 28, 30, 0.6);
            border: 1px solid rgba(84, 84, 88, 0.65);
        }

        .filter-summary h4 {
            margin: 0 0 1rem;
            font-size: 1rem;
            border-bottom: 1px solid var(--border-light);
            padding-bottom: 0.75rem;
        }

        .filter-summary .summary-details {
            display: flex;
            justify-content: space-around;
            text-align: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .filter-summary .summary-details>div {
            display: flex;
            flex-direction: column;
        }

        .filter-summary .summary-details span {
            font-size: 0.9rem;
            color: var(--subtext-light);
            margin-bottom: 0.25rem;
        }

        .filter-summary .summary-details strong {
            display: block;
            font-size: 1.25rem;
            color: var(--text-light);
            font-weight: 600;
        }

        .list-status {
            text-align: center;
            color: var(--subtext-light);
            padding: 3rem 1rem;
        }

        .list-container {
            list-style: none;
            padding: 0;
            margin: 0 -1.25rem;
        }

        .list-container li {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.8rem 1.25rem;
            transition: background-color 0.2s, transform 0.2s, filter 0.2s;
            border-bottom: 1px solid var(--border-light);
            cursor: pointer;
        }

        .list-container li:last-child {
            border-bottom: none;
        }

        .item-icon {
            font-size: 1rem;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .item-icon.income {
            background-color: var(--income-bg-light);
            color: var(--income);
        }

        .item-icon.expense,
        .item-icon.debt,
        .item-icon.issuedCheck {
            background-color: var(--expense-bg-light);
            color: var(--expense);
        }

        .item-icon.transfer {
            background-color: rgba(255, 149, 0, 0.15);
            color: var(--transfer);
        }

        .item-icon.receivable,
        .item-icon.receivedCheck {
            background-color: var(--income-bg-light);
            color: var(--income);
        }

        .item-icon.installmentPayment,
        .item-icon.loan {
            background-color: rgba(175, 82, 222, 0.15);
            color: var(--loan);
        }

        .item-icon.goal {
            background-color: rgba(50, 173, 234, 0.15);
            color: var(--goal);
        }

        .item-info {
            flex-grow: 1;
            min-width: 0;
        }

        .item-info p {
            margin: 0 0 0.2rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .item-info .meta-data {
            font-size: 0.8rem;
            color: var(--subtext-light);
            display: flex;
            flex-wrap: wrap;
            gap: 0.2rem 0.8rem;
        }

        .item-amount {
            font-weight: 600;
            font-size: 1.1rem;
            direction: ltr;
            margin-left: 0.5rem;
        }

        .item-amount.income {
            color: var(--income);
        }

        .item-amount.expense {
            color: var(--expense);
        }

        .item-actions {
            display: flex;
            margin-left: auto;
            align-items: center;
            gap: 0.2rem;
        }

        .action-btn {
            background: none;
            border: none;
            color: var(--subtext-light);
            cursor: pointer;
            font-size: 0.9rem;
            transition: var(--transition-fast);
            padding: 0.5rem;
        }

        .action-btn.edit-btn:hover {
            color: var(--primary);
        }

        .action-btn.delete-btn:hover {
            color: var(--expense);
        }

        .due-date-info.overdue {
            color: var(--expense);
            font-weight: bold;
        }

        .meta-data .meta-status {
            font-weight: 600;
        }

        .meta-data .meta-status.success {
            color: var(--income);
        }

        .meta-data .meta-status.danger {
            color: var(--expense);
        }

        .check-badge {
            font-size: 0.7rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
            background-color: var(--primary);
            color: white;
            vertical-align: middle;
            margin-right: 5px;
        }

        /* IMPROVED: Financial Goal Item */
        .goal-item {
            background: var(--card-light);
            border-radius: var(--radius);
            padding: 1.25rem;
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .goal-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .goal-title h4 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .goal-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem 1.5rem;
            font-size: 0.9rem;
        }

        .goal-details span {
            color: var(--subtext-light);
        }

        .goal-details strong {
            color: var(--text-light);
            font-weight: 600;
        }

        .progress-bar-container {
            width: 100%;
            height: 8px;
            background-color: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        body.dark-mode .progress-bar-container {
            background-color: var(--gray-800);
        }

        .progress-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease-in-out;
        }

        .progress-bar.loan {
            background-color: var(--loan);
        }

        .progress-bar.goal {
            background-color: var(--goal);
        }

        .progress-text {
            text-align: center;
            color: var(--subtext-light);
            font-size: 0.85rem;
        }

        /* NEW: Improved Savings Hero Card */
        .savings-hero-card {
            background: linear-gradient(135deg, var(--goal), var(--purple-ios));
            color: white;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
            padding: 2rem 1.5rem;
        }

        .savings-hero-card .hero-icon {
            font-size: 2rem;
            width: 4rem;
            height: 4rem;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.5rem;
        }

        .savings-hero-card h4 {
            margin: 0;
            font-weight: 500;
            opacity: 0.9;
            font-size: 1rem;
        }

        .savings-hero-card h1 {
            margin: 0;
            font-size: 2.5rem;
            letter-spacing: -1px;
        }

        .savings-hero-card h1 span {
            font-size: 1.2rem;
            font-weight: 400;
            opacity: 0.8;
            margin-right: 0.25rem;
        }

        .savings-hero-card .btn {
            background: rgba(255, 255, 255, 0.25);
            color: white;
            width: 100%;
            margin-top: 1rem;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        #daily-reports-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .daily-report-item {
            background: var(--card-light);
            border-radius: var(--radius);
            overflow: hidden;
            border-left: 4px solid;
            transition: var(--transition-medium);
        }

        .daily-report-item[data-net-flow='0'] {
            border-left-color: var(--subtext-light);
        }

        .daily-report-item[data-net-flow^="-"] {
            border-left-color: var(--expense);
        }

        .daily-report-item:not([data-net-flow^="-"]):not([data-net-flow='0']) {
            border-left-color: var(--income);
        }

        .daily-report-header {
            padding: 0.8rem 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition-fast);
        }

        .daily-report-item.active .daily-report-header {
            background-color: var(--gray-200);
        }

        body.dark-mode .daily-report-item.active .daily-report-header {
            background-color: var(--gray-900);
        }

        .daily-report-item.active .expand-arrow {
            transform: rotate(180deg);
        }

        .date-info .day-of-week {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-light);
        }

        .date-info .date-full {
            font-size: 0.8rem;
            color: var(--subtext-light);
        }

        .flow-summary {
            display: none;
        }

        .expand-arrow {
            color: var(--subtext-light);
            font-size: 1rem;
            transition: transform 0.3s;
        }

        .daily-report-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
        }

        .daily-report-item.active .daily-report-body {
            max-height: 2000px;
        }

        .daily-report-body .list-container {
            margin: 0;
            background-color: var(--bg-light);
        }

        body.dark-mode .daily-report-body .list-container {
            background-color: var(--bg-dark);
        }

        /* === START: NEW EXPENSE REPORT STYLES === */
        #expense-reports-page .card-section {
            padding: 1rem;
            margin-bottom: 1rem;
        }

        #expense-reports-page .report-controls {
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }

        #expense-reports-page .control-group {
            display: flex;
            gap: 0.5rem;
            background-color: var(--gray-200);
            border-radius: 8px;
            padding: 4px;
        }

        body.dark-mode #expense-reports-page .control-group {
            background-color: var(--gray-800);
        }

        #expense-reports-page .header-actions .btn {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        #expense-reports-page .report-controls .header-icon-btn {
            color: var(--subtext-light);
            width: 36px;
            height: 36px;
            font-size: 1rem;
            background-color: transparent;
            border-radius: 6px;
        }

        #expense-reports-page .report-controls .header-icon-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        body.dark-mode #expense-reports-page .report-controls .header-icon-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        #expense-reports-page .category-report-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        #expense-reports-page .category-report-card-new {
            display: grid;
            grid-template-columns: auto 1fr auto auto;
            /* Icon, Info, Amount, Actions */
            gap: 1rem;
            align-items: center;
            background-color: var(--card-light);
            border-radius: var(--radius);
            padding: 1rem;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        #expense-reports-page .category-report-card-new:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        #expense-reports-page .category-report-card-new .item-icon {
            width: 44px;
            height: 44px;
            font-size: 1.2rem;
            border-radius: var(--radius);
            flex-shrink: 0;
        }

        #expense-reports-page .category-report-card-new .category-info {
            min-width: 0;
            /* Prevent overflow */
        }

        #expense-reports-page .category-report-card-new .category-title {
            font-size: 1.05rem;
            font-weight: 600;
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #expense-reports-page .category-report-card-new .category-stats {
            margin-top: 0.25rem;
        }

        #expense-reports-page .category-report-card-new .tx-count {
            font-size: 0.8rem;
            color: var(--subtext-light);
        }

        #expense-reports-page .category-report-card-new .category-amount-progress {
            text-align: right;
        }

        #expense-reports-page .category-report-card-new .total-amount {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.3rem;
            display: block;
        }

        #expense-reports-page .category-report-card-new .progress-bar-wrapper {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 100px;
            /* Give it some space */
        }

        #expense-reports-page .category-report-card-new .percentage-text {
            font-size: 0.75rem;
            color: var(--subtext-light);
            font-weight: 500;
        }

        #expense-reports-page .category-report-card-new .progress-bar-container {
            flex-grow: 1;
            height: 6px;
            border-radius: 3px;
            background-color: var(--gray-200);
            overflow: hidden;
        }

        body.dark-mode #expense-reports-page .category-report-card-new .progress-bar-container {
            background-color: var(--gray-800);
        }

        #expense-reports-page .category-report-card-new .progress-bar {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease-in-out;
            /* Added Animation */
        }

        #expense-reports-page .category-report-card-new .item-actions {
            margin-left: -0.5rem;
            /* Pull it closer to the edge */
        }

        #expense-reports-page .category-report-card-new .action-btn {
            font-size: 1rem;
        }

        /* === END: NEW EXPENSE REPORT STYLES === */


        /* CHANGE: New icon picker in modal */
        .icon-picker {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(44px, 1fr));
            gap: 0.5rem;
            margin-top: 1rem;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-light);
            padding: 0.5rem;
            border-radius: var(--radius);
        }

        .icon-picker-item {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color var(--transition-fast);
            color: var(--subtext-light);
        }

        .icon-picker-item:hover {
            background-color: var(--gray-200);
        }

        body.dark-mode .icon-picker-item:hover {
            background-color: var(--gray-800);
        }

        .icon-picker-item.selected {
            background-color: var(--primary);
            color: white;
        }

        /* ========================================= */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            /* === FIX START === */
            /* The height is now just the bar's height. Padding handles the safe area. */
            height: var(--nav-height);
            padding: 5px 0 var(--safe-area-bottom);
            /* === FIX END === */
            background-color: rgba(249, 249, 249, 0.75);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-light);
            display: flex;
            justify-content: space-around;
            z-index: 100;
            box-sizing: content-box;
            /* Explicitly set for clarity */
        }

        body.dark-mode .bottom-nav {
            background-color: rgba(28, 28, 30, 0.75);
        }

        .nav-btn {
            background: none;
            border: none;
            color: var(--subtext-light);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.2rem;
            font-family: var(--font-family);
            cursor: pointer;
            transition: color 0.2s, transform 0.2s, filter 0.2s;
            flex: 1;
            height: 100%;
            padding-top: 5px;
        }

        .nav-btn i {
            font-size: 1.3rem;
        }

        .nav-btn span {
            font-size: 0.65rem;
            font-weight: 500;
        }

        .nav-btn.active {
            color: var(--primary);
        }

        .fab {
            position: fixed;
            bottom: calc(var(--nav-height) + var(--safe-area-bottom) - 30px);
            left: 50%;
            transform: translateX(-50%);
            width: 56px;
            height: 56px;
            background-color: var(--primary);
            color: white;
            border: 4px solid var(--bg-light);
            border-radius: 50%;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 25px rgba(0, 122, 255, 0.4);
            cursor: pointer;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), border-color 0.3s;
            z-index: 101;
        }

        body.dark-mode .fab {
            border-color: var(--bg-dark);
        }

        .fab:active {
            transform: translateX(-50%) scale(0.95);
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(5px);
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-medium), visibility var(--transition-medium);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: flex-end;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--bg-light);
            width: 100%;
            max-width: 100%;
            padding: 1rem 1rem calc(1rem + var(--safe-area-bottom));
            border-radius: 20px 20px 0 0;
            transform: translateY(100%);
            transition: transform var(--transition-medium);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        .modal-content .modal-header {
            text-align: center;
            padding: 0.5rem 0 1.5rem;
            position: relative;
        }

        .modal-content .modal-header::before {
            content: '';
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 5px;
            background-color: var(--gray-300);
            border-radius: 2.5px;
        }

        body.dark-mode .modal-content .modal-header::before {
            background-color: var(--gray-700);
        }

        .modal-content h3 {
            margin: 0;
            font-size: 1.25rem;
        }

        .form-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .form-actions .btn {
            flex: 1;
            padding: 1rem;
        }

        #toast {
            position: fixed;
            top: calc(var(--header-height) + var(--safe-area-top) + 1rem);
            left: 50%;
            background-color: var(--gray-800);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            box-shadow: var(--shadow);
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transform: translate(-50%, -20px);
            transition: var(--transition-medium);
        }

        body.dark-mode #toast {
            background-color: var(--gray-200);
            color: var(--gray-900);
        }

        #toast.show {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, 0);
        }

        @media (min-width: 641px) {
            .modal-overlay {
                align-items: center;
            }

            .modal-content {
                width: 90%;
                max-width: 480px;
                border-radius: var(--radius);
                transform: translateY(20px) scale(0.95);
                padding-bottom: 1.5rem;
            }

            .modal-overlay.active .modal-content {
                transform: translateY(0) scale(1);
            }

            .modal-content .modal-header::before {
                display: none;
            }

            .flow-summary {
                display: flex;
                gap: 1rem;
                align-items: center;
            }

            .flow-item {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                font-weight: 500;
                font-size: 0.9rem;
            }
        }
    </style>
</head>

<body>
    <div class="app-wrapper">
        <header class="app-header">
            <h1 id="app-header-title">حسابداری شخصی شمار</h1>
            <div class="header-controls">
                <i class="fas fa-cog" id="settings-btn"></i>
                <div class="theme-switcher"><i class="fas fa-sun" id="theme-toggle"></i></div>
            </div>
        </header>

        <main class="app-content">
            <section id="dashboard-page" class="page active">
                <div class="card-section main-balance">
                    <div class="balance-title">
                        <select id="account-filter-dashboard" class="form-control"
                            style="width: auto; font-size: 0.85rem; padding: 0.2rem 0.5rem; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);"></select>
                        <i class="fas fa-eye" id="toggle-balance-visibility"></i>
                    </div>
                    <h1 id="balance-amount"></h1>
                </div>

                <div class="card-section">
                    <div class="section-header">
                        <h3>اقدامات سریع</h3>
                    </div>
                    <div class="quick-actions">
                        <div class="action-card income" data-action="quick-add-income"><i
                                class="fas fa-plus"></i><span>درآمد</span></div>
                        <div class="action-card expense" data-action="quick-add-expense"><i
                                class="fas fa-minus"></i><span>هزینه</span></div>
                        <div class="action-card debt" data-action="quick-add-debt"><i
                                class="fas fa-file-invoice-dollar"></i><span>بدهی</span></div>
                        <div class="action-card receivable" data-action="quick-add-receivable"><i
                                class="fas fa-hand-holding-dollar"></i><span>طلب</span></div>
                    </div>
                </div>

                <div class="card-section" id="reminders-section">
                    <div class="section-header">
                        <h3><i class="fas fa-bell" style="color: var(--primary); margin-left: 0.5rem;"></i>یادآوری‌های
                            نزدیک</h3>
                    </div>
                    <ul class="list-container" id="reminders-list">
                        <div class="list-status" style="padding: 1rem 0;">در حال بارگزاری...</div>
                    </ul>
                </div>

                <div class="card-section">
                    <div class="section-header">
                        <h3>خلاصه عملکرد</h3>
                        <select id="dashboard-period-filter" class="form-control"
                            style="width: auto; font-size: 0.85rem; padding: 0.5rem;">
                            <option value="all">همیشه</option>
                            <option value="7d">۷ روز اخیر</option>
                            <option value="30d">۳۰ روز اخیر</option>
                            <option value="month">این ماه</option>
                        </select>
                    </div>
                    <div class="summary-grid" id="dashboard-summary-grid">
                    </div>
                </div>

                <div class="card-section" id="dashboard-recents">
                    <div class="section-header">
                        <h3>آخرین تراکنش‌ها</h3>
                    </div>
                    <ul class="list-container">
                        <div class="list-status" style="padding: 1rem 0;">در حال بارگزاری...</div>
                    </ul>
                </div>
            </section>

            <section id="transactions-page" class="page"></section>
            <section id="reports-page" class="page"></section>
            <section id="expense-reports-page" class="page"></section>
            <section id="savings-page" class="page"></section>
            <section id="debts-page" class="page"></section>
            <section id="receivables-page" class="page"></section>
            <section id="loans-page" class="page"></section>
            <section id="accounts-page" class="page"></section>

        </main>

        <button class="fab" data-action="add-transaction"><i class="fas fa-plus"></i></button>

        <nav class="bottom-nav">
            <button class="nav-btn active" data-page="dashboard-page" data-title="حسابداری شخصی شمار"><i
                    class="fas fa-tachometer-alt"></i><span>داشبورد</span></button>
            <button class="nav-btn" data-page="transactions-page" data-title="تراکنش‌ها"><i
                    class="fas fa-exchange-alt"></i><span>تراکنش‌ها</span></button>
            <button class="nav-btn" data-page="accounts-page" data-title="حساب‌ها"><i
                    class="fas fa-wallet"></i><span>حساب‌ها</span></button>
            <button class="nav-btn" data-action="open-more-menu"><i
                    class="fas fa-ellipsis-h"></i><span>بیشتر</span></button>
        </nav>
    </div>

    <div class="modal-overlay" id="transaction-modal-overlay"></div>
    <div class="modal-overlay" id="account-modal-overlay"></div>
    <div class="modal-overlay" id="loan-modal-overlay"></div>
    <div class="modal-overlay" id="goal-modal-overlay"></div>
    <div class="modal-overlay" id="account-details-modal-overlay"></div>
    <div class="modal-overlay" id="confirm-modal-overlay"></div>
    <div class="modal-overlay" id="settings-modal-overlay"></div>
    <div class="modal-overlay" id="more-menu-modal-overlay"></div>
    <div class="modal-overlay" id="expense-category-modal-overlay"></div>

    <div id="toast"></div>

    <script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment-jalaali@0.9.2/build/moment-jalaali.js"></script>
    <script src="https://unpkg.com/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>
    <script>
        // === PWA Service Worker Registration (for install prompt) ===
        if ('serviceWorker' in navigator) {
            const swCode = `self.addEventListener('fetch', () => {});`;
            const swBlob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(swBlob);
            navigator.serviceWorker.register(swUrl)
                .then(registration => {
                    console.log('Service Worker registered successfully:', registration);
                })
                .catch(error => {
                    console.error('Service Worker registration failed:', error);
                });
        }
        // === End of PWA script ===

        // === PWA Install Prompt Handling ===
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log('`beforeinstallprompt` event was fired.');
        });
        window.addEventListener('appinstalled', () => {
            deferredPrompt = null;
            console.log('PWA was installed');
        });
        // === End of PWA Install Handling ===


        document.addEventListener('DOMContentLoaded', () => {

            // --- SELECTORS ---
            const qs = (selector, parent = document) => parent.querySelector(selector);
            const qsa = (selector, parent = document) => parent.querySelectorAll(selector);

            // --- CONSTANTS & CONFIG ---
            moment.locale('fa');
            moment.updateLocale('fa', { jMonths: "فروردین_اردیبهشت_خرداد_تیر_مرداد_شهریور_مهر_آبان_آذر_دی_بهمن_اسفند".split("_"), weekdays: "یک‌شنبه_دوشنبه_سه‌شنبه_چهارشنبه_پنج‌شنبه_جمعه_شنبه".split("_"), weekdaysMin: "ی_د_s_چ_پ_ج_ش".split("_"), });
            const MOMENT_FORMAT = 'YYYY/MM/DD';
            const JALALI_DISPLAY_FORMAT = 'jYYYY/jMM/jDD';
            const STORAGE_KEY = 'accountingApp_ios_v6_redesign'; // CHANGE: Updated storage key for new state
            const TRANSACTION_TYPES = { income: '✅ دریافتی', expense: '❌ هزینه', transfer: '⤴️ انتقال به پس انداز', receivable: '💰 طلب', debt: '➖ بدهی', receivedCheck: '📄 چک دریافتی', issuedCheck: '📄 چک صادره', installmentPayment: '💳 پرداخت قسط' };
            const STATUS_TYPES = { debt: { paid: 'پرداخت شد', pending: 'در انتظار', not_paid: 'پرداخت نشد' }, receivable: { received: 'دریافت شد', pending: 'در انتظار', not_received: 'دریافت نشد' }, issuedCheck: { cleared: 'پاس شده', pending: 'در انتظار', bounced: 'پاس نشد' }, receivedCheck: { cleared: 'پاس شده', pending: 'در انتظار', bounced: 'پاس نشد' } };

            // CHANGE: Icons for categories are now part of state, but we need a master list for the picker.
            const AVAILABLE_ICONS = [
                'fa-shopping-basket', 'fa-bus-alt', 'fa-utensils', 'fa-tshirt', 'fa-gamepad', 'fa-file-signature', 'fa-pills',
                'fa-car', 'fa-gas-pump', 'fa-home', 'fa-couch', 'fa-wifi', 'fa-mobile-alt', 'fa-book-open', 'fa-graduation-cap',
                'fa-film', 'fa-plane', 'fa-coffee', 'fa-heart', 'fa-dumbbell', 'fa-paw', 'fa-tools', 'fa-cut', 'fa-money-bill-wave',
                'fa-briefcase', 'fa-chart-line', 'fa-gift', 'fa-tag'
            ];

            const CATEGORY_EMOJI_MAP = {
                'خرید روزمره': '🛒', 'حمل و نقل': '🚌', 'غذا': '🍔', 'پوشاک': '👕', 'سرگرمی': '🎮', 'اجاره': '📄', 'درمان': '💊',
                'حقوق': '💵', 'پروژه': '💼', 'سود سهام': '📈', 'هدیه': '🎁'
            };


            // --- STATE ---
            let state = {
                transactions: [],
                accounts: [],
                loans: [],
                savingsGoals: [],
                // CHANGE: expenseCategories is now an array of objects
                expenseCategories: [
                    { name: 'خرید روزمره', icon: 'fa-shopping-basket' },
                    { name: 'حمل و نقل', icon: 'fa-bus-alt' },
                    { name: 'غذا', icon: 'fa-utensils' },
                    { name: 'پوشاک', icon: 'fa-tshirt' },
                    { name: 'سرگرمی', icon: 'fa-gamepad' },
                    { name: 'اجاره', icon: 'fa-file-signature' }
                ],
                // CHANGE: incomeSources also converted for consistency, though not strictly required by prompt
                incomeSources: [
                    { name: 'حقوق', icon: 'fa-money-bill-wave' },
                    { name: 'پروژه', icon: 'fa-briefcase' },
                    { name: 'سود سهام', icon: 'fa-chart-line' },
                    { name: 'هدیه', icon: 'fa-gift' }
                ],
                isBalanceVisible: true,
                activeAccountId: 'all',
                dashboardPeriod: 'all',
                filters: { transactions: { searchTerm: '', from: null, to: null, type: 'all', accountId: 'all', category: 'all' }, reports: { from: null, to: null, accountId: 'all' }, expenseReports: { from: null, to: null, accountId: 'all', sortBy: 'total' }, debts: { from: null, to: null, accountId: 'all', status: 'all' }, receivables: { from: null, to: null, accountId: 'all', status: 'all' } }
            };
            let itemToDelete = { id: null, type: null };
            let preChangeSelectValue = null;
            let currentPageId = 'dashboard-page';

            // --- HELPERS ---
            const formatCurrency = (amount) => `${(Number(amount) || 0).toLocaleString('fa-IR')}`;
            const getUnformattedAmount = (value) => { if (typeof value !== 'string') return ''; return normalizeDigits(value).replace(/[,٬]/g, ''); };
            const normalizeDigits = (str) => { if (typeof str !== 'string') return str; return str.replace(/[\u0660-\u0669]/g, c => c.charCodeAt(0) - 0x0660).replace(/[\u06F0-\u06F9]/g, c => c.charCodeAt(0) - 0x06F0); };
            const formatInputAsCurrency = (input) => {
                if (!input) return;
                let originalCursor = input.selectionStart;
                let originalLength = input.value.length;
                let rawValue = getUnformattedAmount(input.value);
                if (isNaN(rawValue) || rawValue.trim() === '') { input.value = ''; return; }
                let formattedValue = Number(rawValue).toLocaleString('fa-IR');
                input.value = formattedValue;
                let newLength = formattedValue.length;
                if (originalCursor !== null) { input.setSelectionRange(originalCursor + (newLength - originalLength), originalCursor + (newLength - originalLength)); }
            };
            const showToast = (message) => { const t = qs('#toast'); t.textContent = message; t.classList.add('show'); setTimeout(() => { t.classList.remove('show'); }, 3000); };
            const triggerHapticFeedback = (duration = 1) => { if (navigator.vibrate) { try { navigator.vibrate(duration); } catch (e) { /* Fail silently */ } } };
            const openModal = (modalId) => {
                qs(modalId)?.classList.add('active');
                document.body.classList.add('modal-open');
            };
            const closeModal = (modalId) => {
                qs(modalId)?.classList.remove('active');
                if (qsa('.modal-overlay.active').length === 0) {
                    document.body.classList.remove('modal-open');
                }
            };
            const isFilterActive = (pageKey) => {
                const f = state.filters[pageKey];
                if (!f) return false;
                if (f.from || f.to) return true;
                if (f.accountId && f.accountId !== 'all') return true;
                // Page-specific checks
                if (pageKey === 'transactions') {
                    if (f.searchTerm) return true;
                    if (f.type && f.type !== 'all') return true;
                    if (f.category && f.category !== 'all') return true;
                }
                if (pageKey === 'debts' || pageKey === 'receivables') {
                    if (f.status && f.status !== 'all') return true;
                }
                return false;
            };

            // --- NAVIGATION ---
            const switchPage = (pageId, title) => {
                const oldPage = qs(`#${currentPageId}`);
                const newPage = qs(`#${pageId}`);
                if (oldPage && newPage) {
                    oldPage.classList.remove('active');
                }
                newPage.classList.add('active');
                currentPageId = pageId;
                qs('#app-header-title').textContent = title;
                qsa('.nav-btn').forEach(b => {
                    b.classList.toggle('active', b.dataset.page === pageId);
                });
                const moreMenuPages = ['reports-page', 'expense-reports-page', 'savings-page', 'debts-page', 'receivables-page', 'loans-page'];
                const moreMenuBtn = qs('.nav-btn[data-action="open-more-menu"]');
                if (moreMenuBtn) {
                    moreMenuBtn.classList.toggle('active', moreMenuPages.includes(pageId));
                }
                const pageRenderers = { 'dashboard-page': renderDashboardPage, 'transactions-page': renderTransactionsPage, 'reports-page': renderReportsPage, 'expense-reports-page': renderExpenseReportsPage, 'savings-page': renderSavingsPage, 'accounts-page': renderAccountsPage, 'debts-page': renderDebtsPage, 'receivables-page': renderReceivablesPage, 'loans-page': renderLoansPage };
                pageRenderers[pageId]?.();
                qs('.app-content').scrollTo(0, 0);
                initDatepickers(qs(`#${pageId}`));
            };

            // --- DATA PERSISTENCE ---
            const saveData = () => { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); localStorage.setItem(STORAGE_KEY + '_theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light'); } catch (e) { console.error("Failed to save data", e); } };
            const loadData = () => {
                try {
                    const data = localStorage.getItem(STORAGE_KEY);
                    if (data) {
                        const parsedData = JSON.parse(data);
                        const defaultFilters = { transactions: { searchTerm: '', from: null, to: null, type: 'all', accountId: 'all', category: 'all' }, reports: { from: null, to: null, accountId: 'all' }, expenseReports: { from: null, to: null, accountId: 'all', sortBy: 'total' }, debts: { from: null, to: null, accountId: 'all', status: 'all' }, receivables: { from: null, to: null, accountId: 'all', status: 'all' } };
                        parsedData.filters = { ...defaultFilters, ...(parsedData.filters || {}) };
                        state = { ...state, ...parsedData };
                    }
                    if (state.accounts.length === 0) { state.accounts.push({ id: Date.now(), name: 'حساب اصلی' }); }
                    if (!Array.isArray(state.savingsGoals)) state.savingsGoals = [];

                    // CHANGE: Migration logic for old category string array format
                    const defaultIcons = { 'خرید روزمره': 'fa-shopping-basket', 'حمل و نقل': 'fa-bus-alt', 'غذا': 'fa-utensils', 'پوشاک': 'fa-tshirt', 'سرگرمی': 'fa-gamepad', 'اجاره': 'fa-file-signature', 'درمان': 'fa-pills', 'حقوق': 'fa-money-bill-wave', 'پروژه': 'fa-briefcase', 'سود سهام': 'fa-chart-line', 'هدیه': 'fa-gift', 'default': 'fa-tag' };
                    if (state.expenseCategories.length > 0 && typeof state.expenseCategories[0] === 'string') {
                        console.log("Migrating expense categories to new object format...");
                        state.expenseCategories = state.expenseCategories.map(catName => ({ name: catName, icon: defaultIcons[catName] || defaultIcons.default }));
                    }
                    if (state.incomeSources.length > 0 && typeof state.incomeSources[0] === 'string') {
                        console.log("Migrating income sources to new object format...");
                        state.incomeSources = state.incomeSources.map(catName => ({ name: catName, icon: defaultIcons[catName] || defaultIcons.default }));
                    }


                    if (localStorage.getItem(STORAGE_KEY + '_theme') === 'dark') { document.body.classList.add('dark-mode'); updateThemeIcon(); }
                } catch (e) { console.error("Failed to load data", e); }
            };

            // --- UI RENDERING ---
            const updateAllUI = () => {
                const currentPageNavBtn = qs(`.nav-btn[data-page="${currentPageId}"]`) || qs('.nav-btn.active');
                const currentPageTitle = currentPageNavBtn ? currentPageNavBtn.dataset.title : "حسابداری شخصی شمار";
                if (currentPageId) {
                    switchPage(currentPageId, currentPageTitle);
                }
            };
            const calculateBalance = (transactions) => {
                return transactions.reduce((balance, tx) => {
                    const amount = tx.amount;
                    if (tx.type === 'income' || (tx.type === 'receivable' && tx.status === 'received') || (tx.type === 'receivedCheck' && tx.status === 'cleared')) return balance + amount;
                    if (tx.type === 'expense' || tx.type === 'transfer' || tx.type === 'installmentPayment' || (tx.type === 'debt' && tx.status === 'paid') || (tx.type === 'issuedCheck' && tx.status === 'cleared')) return balance - amount;
                    return balance;
                }, 0);
            };
            const getTransactionListItemHTML = (tx, options = {}) => {
                const { showAccount = false } = options;
                const sign = tx.type === 'income' || tx.type.includes('received') || tx.type === 'receivable' ? '+' : '-';
                const icons = { income: 'fa-arrow-up', expense: 'fa-arrow-down', transfer: 'fa-exchange-alt', debt: 'fa-file-invoice-dollar', receivable: 'fa-hand-holding-dollar', issuedCheck: 'fa-money-check-alt', receivedCheck: 'fa-money-check-alt', installmentPayment: 'fa-receipt' };
                const displayDate = tx.date && moment(tx.date, MOMENT_FORMAT).isValid() ? moment(tx.date, MOMENT_FORMAT).format('jD jMMMM') : '-';
                const displayDueDate = (tx.dueDate && moment(tx.dueDate, MOMENT_FORMAT).isValid()) ? moment(tx.dueDate, MOMENT_FORMAT).format(JALALI_DISPLAY_FORMAT) : null;
                const isOverdue = displayDueDate && tx.status === 'pending' && moment(tx.dueDate, MOMENT_FORMAT).isBefore(moment(), 'day');
                const account = state.accounts.find(a => a.id == tx.accountId);
                let descriptionHTML = tx.description || TRANSACTION_TYPES[tx.type] || "تراکنش";
                if (tx.type === 'receivedCheck' || tx.type === 'issuedCheck') descriptionHTML += ` <span class="check-badge">چک</span>`;

                let meta = `<div class="meta-data"><span><i class="fas fa-calendar-day" style="opacity: 0.7;"></i> ${displayDate}</span>`;

                if (account && showAccount) meta += `<span> • ${account.name}</span>`;

                if (tx.category) {
                    // CHANGE: Get icon from state object
                    const categoryObj = (tx.type === 'expense' ? state.expenseCategories : state.incomeSources).find(c => c.name === tx.category);
                    const iconClass = categoryObj ? categoryObj.icon : 'fa-tag';
                    meta += `<span> • <i class="fas ${iconClass}" style="opacity: 0.8; width: 1.2em;"></i> ${tx.category}</span>`;
                }

                if (displayDueDate) meta += `<span class="due-date-info ${isOverdue ? 'overdue' : ''}"><i class="fas fa-hourglass-half" style="opacity: 0.7;"></i> ${displayDueDate}</span>`;

                const statusTypes = ['debt', 'receivable', 'issuedCheck', 'receivedCheck'];
                if (statusTypes.includes(tx.type) && tx.status) {
                    const statuses = STATUS_TYPES[tx.type] || {};
                    const statusText = statuses[tx.status] || tx.status;
                    let statusClass = '';
                    if (['paid', 'received', 'cleared'].includes(tx.status)) statusClass = 'success';
                    else if (['not_paid', 'not_received', 'bounced'].includes(tx.status)) statusClass = 'danger';
                    meta += `<span class="meta-status ${statusClass}">${statusText}</span>`;
                }
                meta += '</div>';

                let actions = `<div class="item-actions"><button class="action-btn edit-btn" data-id="${tx.id}" data-type="transaction"><i class="fas fa-pen-to-square"></i></button><button class="action-btn delete-btn" data-id="${tx.id}" data-type="transaction"><i class="fas fa-trash-alt"></i></button></div>`;
                return `<div class="item-icon ${tx.type}"><i class="fas ${icons[tx.type] || 'fa-dollar-sign'}"></i></div> <div class="item-info"> <p>${descriptionHTML}</p> ${meta} </div> <div class="item-amount ${tx.type === 'income' ? 'income' : 'expense'}">${tx.type === 'transfer' ? '' : sign} ${formatCurrency(tx.amount)}</div> ${actions}`;
            };
            const getAccountListItemHTML = (item) => {
                const balance = calculateBalance(state.transactions.filter(tx => tx.accountId == item.id));
                return `<div class="item-icon" style="background-color: var(--gray-200); color: var(--gray-600);"><i class="fas fa-wallet"></i></div>
                        <div class="item-info">
                            <p>${item.name}</p>
                            <div class="meta-data">موجودی کل</div>
                        </div>
                        <div class="item-amount">${formatCurrency(balance)}</div>
                        <i class="fas fa-chevron-left" style="color: var(--subtext-light); margin-right: auto;"></i>`;
            };
            function renderDashboardPage() {
                const page = qs('#dashboard-page');
                if (!page) return;

                const accountId = state.activeAccountId;
                const baseTxs = accountId === 'all' ? state.transactions : state.transactions.filter(tx => tx.accountId == accountId);
                const period = state.dashboardPeriod;
                let filteredTxs = baseTxs;
                if (period !== 'all') {
                    let startDate;
                    if (period === '7d') startDate = moment().subtract(7, 'days');
                    else if (period === '30d') startDate = moment().subtract(30, 'days');
                    else if (period === 'month') startDate = moment().startOf('jMonth');
                    filteredTxs = baseTxs.filter(tx => moment(tx.date, MOMENT_FORMAT).isAfter(startDate));
                }

                const balance = calculateBalance(baseTxs);
                const income = filteredTxs.filter(tx => tx.type === 'income').reduce((acc, tx) => acc + tx.amount, 0);
                const expenses = filteredTxs.filter(tx => tx.type === 'expense').reduce((acc, tx) => acc + tx.amount, 0);
                const totalDebt = state.transactions.filter(t => (t.type === 'debt' || t.type === 'issuedCheck') && t.status === 'pending' && (accountId === 'all' || t.accountId == accountId)).reduce((s, t) => s + t.amount, 0);
                const totalReceivable = state.transactions.filter(t => (t.type === 'receivable' || t.type === 'receivedCheck') && t.status === 'pending' && (accountId === 'all' || t.accountId == accountId)).reduce((s, t) => s + t.amount, 0);
                const totalLoanRemaining = state.loans.reduce((s, l) => { const paidCount = state.transactions.filter(t => t.loanId == l.id).length; const remaining = (l.totalInstallments - paidCount) * l.installmentAmount; return s + (remaining > 0 ? remaining : 0); }, 0);

                qs('#balance-amount', page).textContent = state.isBalanceVisible ? `${formatCurrency(balance)} تومان` : '******';
                qs('#dashboard-period-filter', page).value = period;

                const summaryGrid = qs('#dashboard-summary-grid', page);
                summaryGrid.innerHTML = `
                    <div class="summary-card income" data-page="transactions-page" data-title="تراکنش‌ها" data-filter-type="income">
                        <div class="card-header"><div class="card-icon"><i class="fas fa-arrow-up"></i></div><span class="card-title">درآمد</span></div>
                        <div class="card-amount">${formatCurrency(income)}</div>
                    </div>
                    <div class="summary-card expense" data-page="transactions-page" data-title="تراکنش‌ها" data-filter-type="expense">
                        <div class="card-header"><div class="card-icon"><i class="fas fa-arrow-down"></i></div><span class="card-title">هزینه</span></div>
                        <div class="card-amount">${formatCurrency(expenses)}</div>
                    </div>
                    <div class="summary-card receivable" data-page="receivables-page" data-title="طلب‌ها">
                        <div class="card-header"><div class="card-icon"><i class="fas fa-hand-holding-dollar"></i></div><span class="card-title">طلب (مانده)</span></div>
                        <div class="card-amount">${formatCurrency(totalReceivable)}</div>
                    </div>
                    <div class="summary-card debt" data-page="debts-page" data-title="بدهی‌ها">
                        <div class="card-header"><div class="card-icon"><i class="fas fa-file-invoice-dollar"></i></div><span class="card-title">بدهی (مانده)</span></div>
                        <div class="card-amount">${formatCurrency(totalDebt)}</div>
                    </div>
                    <div class="summary-card loan" data-page="loans-page" data-title="تسهیلات">
                        <div class="card-header"><div class="card-icon"><i class="fas fa-landmark"></i></div><span class="card-title">باقی‌مانده وام‌ها</span></div>
                        <div class="card-amount">${formatCurrency(totalLoanRemaining)}</div>
                    </div>
                `;

                populateDropdown(qs('#account-filter-dashboard', page), state.accounts, 'id', 'name', { value: 'all', text: 'همه حساب‌ها' });
                qs('#account-filter-dashboard', page).value = state.activeAccountId;

                const recentsList = qs('#dashboard-recents .list-container', page);
                const recents = [...baseTxs].sort((a, b) => b.id - a.id).slice(0, 5);
                if (recents.length === 0) {
                    recentsList.innerHTML = '<div class="list-status" style="padding: 1rem 0;">تراکنشی یافت نشد.</div>';
                } else {
                    recentsList.innerHTML = recents.map(tx => `<li data-id="${tx.id}" data-type="transaction">${getTransactionListItemHTML(tx)}</li>`).join('');
                }

                const remindersList = qs('#reminders-list', page);
                const today = moment().startOf('day');
                const sevenDaysLater = moment().add(7, 'days').endOf('day');
                const reminders = state.transactions.filter(tx => (tx.type === 'debt' || tx.type === 'receivable' || tx.type === 'issuedCheck' || tx.type === 'receivedCheck') && tx.status === 'pending' && tx.dueDate && moment(tx.dueDate, MOMENT_FORMAT).isValid() && moment(tx.dueDate, MOMENT_FORMAT).isBetween(today, sevenDaysLater, 'day', '[]')).sort((a, b) => moment(a.dueDate, MOMENT_FORMAT).diff(moment(b.dueDate, MOMENT_FORMAT)));
                if (reminders.length === 0) {
                    remindersList.innerHTML = '<div class="list-status" style="padding: 1rem 0;">یادآوری برای ۷ روز آینده وجود ندارد.</div>';
                } else {
                    remindersList.innerHTML = reminders.map(tx => `<li data-id="${tx.id}" data-type="transaction">${getTransactionListItemHTML(tx)}</li>`).join('');
                }
            }
            function renderTransactionsPage() {
                const page = qs('#transactions-page');
                if (!page) return;
                page.innerHTML = `
                    <div class="card-section">
                        <div class="section-header">
                            <h3>لیست تراکنش‌ها</h3>
                            <div class="header-actions">
                                <button class="btn btn-secondary ${isFilterActive('transactions') ? 'filter-active' : ''}" data-action="toggle-filters">
                                    <i class="fas fa-filter"></i> <span>فیلتر</span>
                                </button>
                                <button id="export-csv-btn" class="btn btn-success">
                                    <i class="fas fa-file-excel"></i>
                                </button>
                            </div>
                        </div>
                        <div class="filters-collapsible-container">
                            <div class="transaction-filters">
                                <div class="form-group"><input type="text" id="search-input" placeholder="جستجو در توضیحات..." class="form-control"></div>
                                <div class="filter-grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div class="form-group"><input type="text" id="from-date-filter-tx" placeholder="از تاریخ" class="form-control pdate"></div>
                                    <div class="form-group"><input type="text" id="to-date-filter-tx" placeholder="تا تاریخ" class="form-control pdate"></div>
                                </div>
                                <div class="filter-grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                                     <div class="form-group"><select id="account-filter" class="form-control account-dropdown"></select></div>
                                     <div class="form-group"><select id="type-filter" class="form-control"></select></div>
                                </div>
                                <div class="form-group"><select id="category-filter" disabled class="form-control"><option value="all">همه دسته‌ها</option></select></div>
                                <div class="form-group"><button id="clear-tx-filters-btn" class="btn btn-secondary" style="width:100%;">پاک کردن فیلترها</button></div>
                            </div>
                        </div>
                    </div>
                    <div id="transaction-summary" class="filter-summary" style="display: none;"></div>
                    <div class="card-section">
                        <ul id="transaction-list" class="list-container"></ul>
                        <div id="transaction-list-status" class="list-status"></div>
                    </div>`;
                populateDropdown(qs('#account-filter', page), state.accounts, 'id', 'name', { value: 'all', text: 'همه حساب‌ها' });
                populateDropdown(qs('#type-filter', page), Object.entries(TRANSACTION_TYPES).map(([k, v]) => ({ key: k, val: v })), 'key', 'val', { value: 'all', text: 'همه انواع' });
                const filters = state.filters.transactions;
                qs('#search-input').value = filters.searchTerm || '';
                qs('#from-date-filter-tx').value = filters.from ? moment(filters.from, MOMENT_FORMAT).format(JALALI_DISPLAY_FORMAT) : '';
                qs('#to-date-filter-tx').value = filters.to ? moment(filters.to, MOMENT_FORMAT).format(JALALI_DISPLAY_FORMAT) : '';
                qs('#account-filter', page).value = filters.accountId;
                qs('#type-filter', page).value = filters.type;
                renderCategoryFilter();
                qs('#category-filter').value = filters.category;
                renderTransactionList();
            }
            function renderTransactionSummary(filteredTxs = []) {
                const summaryEl = qs('#transaction-summary');
                if (!summaryEl) return;
                if (filteredTxs.length === 0) {
                    summaryEl.style.display = 'none';
                    return;
                }
                let totalIncome = 0;
                let totalExpense = 0;
                filteredTxs.forEach(tx => {
                    if (tx.type === 'income') totalIncome += tx.amount;
                    if (tx.type === 'expense') totalExpense += tx.amount;
                });
                const netFlow = totalIncome - totalExpense;
                summaryEl.innerHTML = `<h4>خلاصه فیلتر</h4>
                    <div class="summary-details" style="gap: 0.5rem 1rem; justify-content: space-between;">
                        <div><span>تعداد</span><strong>${formatCurrency(filteredTxs.length)}</strong></div>
                        <div><span>دریافتی</span><strong style="color:var(--income);">${formatCurrency(totalIncome)}</strong></div>
                        <div><span>پرداختی</span><strong style="color:var(--expense);">${formatCurrency(totalExpense)}</strong></div>
                        <div><span>برآیند</span><strong style="direction: ltr; color:${netFlow >= 0 ? 'var(--income)' : 'var(--expense)'};">${netFlow >= 0 ? '+' : ''}${formatCurrency(netFlow)}</strong></div>
                    </div>`;
                summaryEl.style.display = 'block';
            }
            function renderTransactionList() {
                const listEl = qs('#transaction-list'), statusEl = qs('#transaction-list-status');
                if (!listEl) return;
                const filters = state.filters.transactions;
                const filtered = state.transactions.filter(tx => {
                    const txDate = moment(tx.date, MOMENT_FORMAT);
                    if (filters.from && txDate.isBefore(moment(filters.from, MOMENT_FORMAT), 'day')) return false;
                    if (filters.to && txDate.isAfter(moment(filters.to, MOMENT_FORMAT), 'day')) return false;
                    if (filters.accountId !== 'all' && tx.accountId != filters.accountId) return false;
                    if (filters.type !== 'all' && tx.type !== filters.type) return false;
                    if (filters.category !== 'all' && tx.category !== filters.category) return false;
                    if (filters.searchTerm && !(tx.description || '').toLowerCase().includes(filters.searchTerm)) return false;
                    return true;
                });
                const sorted = filtered.sort((a, b) => moment(b.date, MOMENT_FORMAT).diff(moment(a.date, MOMENT_FORMAT)) || b.id - a.id);
                listEl.innerHTML = ''; statusEl.textContent = '';
                renderTransactionSummary(sorted);
                if (sorted.length === 0) {
                    statusEl.textContent = state.transactions.length === 0 ? 'هیچ تراکنشی ثبت نشده است.' : 'موردی با این مشخصات یافت نشد.';
                } else {
                    listEl.innerHTML = sorted.map(tx => `<li data-id="${tx.id}" data-type="transaction">${getTransactionListItemHTML(tx, { showAccount: filters.accountId === 'all' })}</li>`).join('');
                }
            }
            function renderCategoryFilter() {
                const page = qs('#transactions-page');
                if (!page) return;
                const typeFilterVal = qs('#type-filter', page).value;
                const categoryFilterEl = qs('#category-filter', page);
                let categories = [];
                if (typeFilterVal === 'income') categories = state.incomeSources;
                if (typeFilterVal === 'expense') categories = state.expenseCategories;
                // CHANGE: Populate from array of objects
                categoryFilterEl.innerHTML = '<option value="all">همه دسته‌ها</option>';
                categories.forEach(cat => categoryFilterEl.innerHTML += `<option value="${cat.name}">${cat.name}</option>`);
                categoryFilterEl.disabled = !['income', 'expense'].includes(typeFilterVal);
            };
            function renderAccountsPage() {
                const page = qs('#accounts-page');
                if (!page) return;
                page.innerHTML = `
                    <div class="card-section">
                        <div class="section-header">
                            <h3>حساب‌های من</h3>
                            <button class="btn btn-primary" data-action="add-account"><i class="fas fa-plus"></i></button>
                        </div>
                        <div id="accounts-list" class="list-container" style="margin: 0;"></div>
                        <div id="accounts-status" class="list-status"></div>
                    </div>`;
                const listEl = qs('#accounts-list', page), statusEl = qs('#accounts-status', page);
                if (state.accounts.length === 0) {
                    statusEl.textContent = 'هیچ حسابی تعریف نشده است.';
                } else {
                    statusEl.textContent = '';
                    listEl.innerHTML = state.accounts.map(acc => `<li data-id="${acc.id}" data-type="account">${getAccountListItemHTML(acc)}</li>`).join('');
                }
            }
            const applyGenericFilters = (transactions, pageKey) => {
                const filters = state.filters[pageKey];
                if (!filters) return transactions;
                return transactions.filter(tx => {
                    if (!tx.date || !moment(tx.date, MOMENT_FORMAT, true).isValid()) return false;
                    const date = moment(tx.date, MOMENT_FORMAT);
                    if (filters.from && date.isBefore(moment(filters.from, MOMENT_FORMAT), 'day')) return false;
                    if (filters.to && date.isAfter(moment(filters.to, MOMENT_FORMAT), 'day')) return false;
                    if (filters.accountId !== 'all' && tx.accountId != filters.accountId) return false;
                    if (filters.status && filters.status !== 'all' && tx.status !== filters.status) return false;
                    return true;
                });
            };
            const renderFilteredListPage = (pageId, title, txTypes) => {
                const page = qs(`#${pageId}`);
                if (!page) return;
                const pageKey = pageId.replace('-page', '');
                page.innerHTML = `
                             <div class="card-section">
                                     <div class="section-header">
                                         <h3>${title}</h3>
                                         <button class="btn btn-secondary ${isFilterActive(pageKey) ? 'filter-active' : ''}" data-action="toggle-filters">
                                             <i class="fas fa-filter"></i> <span>فیلتر</span>
                                         </button>
                                     </div>
                                     <div class="filters-collapsible-container">
                                         <div class="filter-grid">
                                             <div class="form-group"><input type="text" placeholder="از تاریخ" class="form-control pdate from-date-filter"></div>
                                             <div class="form-group"><input type="text" placeholder="تا تاریخ" class="form-control pdate to-date-filter"></div>
                                             <div class="form-group account-filter-group"><label>حساب</label><select class="form-control account-filter account-dropdown"></select></div>
                                             <div class="form-group status-filter-group"><label>وضعیت</label><select class="form-control status-filter"></select></div>
                                         </div>
                                         <div class="form-group" style="margin-top: 1rem;"><button class="btn btn-secondary clear-generic-filters-btn" data-pagekey="${pageKey}" style="width:100%;">پاک کردن فیلترها</button></div>
                                     </div>
                               </div>
                               <div class="filter-summary" style="display: none;"></div>
                               <div class="card-section">
                                    <ul class="list-container" id="${pageKey}-list"></ul>
                                    <div class="list-status" id="${pageKey}-status"></div>
                               </div>
                        `;
                const listEl = qs(`#${pageKey}-list`);
                const statusEl = qs(`#${pageKey}-status`);
                populateDropdown(qs('.account-filter', page), state.accounts, 'id', 'name', { value: 'all', text: 'همه حساب‌ها' });
                qs('.account-filter', page).value = state.filters[pageKey].accountId;
                const statusFilterEl = qs('.status-filter', page);
                let statusesToShow = {};
                if (pageKey === 'debts') statusesToShow = { ...STATUS_TYPES.debt, ...STATUS_TYPES.issuedCheck };
                else if (pageKey === 'receivables') statusesToShow = { ...STATUS_TYPES.receivable, ...STATUS_TYPES.receivedCheck };
                populateDropdown(statusFilterEl, Object.entries(statusesToShow).map(([k, v]) => ({ key: k, val: v })), 'key', 'val', { value: 'all', text: 'همه وضعیت‌ها' });
                statusFilterEl.value = state.filters[pageKey].status;
                qs('.from-date-filter', page).value = state.filters[pageKey].from ? moment(state.filters[pageKey].from, MOMENT_FORMAT).format(JALALI_DISPLAY_FORMAT) : '';
                qs('.to-date-filter', page).value = state.filters[pageKey].to ? moment(state.filters[pageKey].to, MOMENT_FORMAT).format(JALALI_DISPLAY_FORMAT) : '';
                const baseTxs = state.transactions.filter(t => txTypes.includes(t.type));
                const filteredTxs = applyGenericFilters(baseTxs, pageKey);
                const summaryEl = qs('.filter-summary', page);
                const filters = state.filters[pageKey];
                const hasActiveFilters = filters.from || filters.to || filters.accountId !== 'all' || filters.status !== 'all';

                if (filteredTxs.length > 0 && hasActiveFilters) {
                    summaryEl.style.display = 'block';
                    const totalAmount = filteredTxs.reduce((sum, tx) => sum + tx.amount, 0);
                    summaryEl.innerHTML = `<h4>خلاصه فیلتر</h4><div class="summary-details"><div><span>تعداد</span><strong>${formatCurrency(filteredTxs.length)}</strong></div><div><span>مجموع</span><strong>${formatCurrency(totalAmount)} تومان</strong></div></div>`;
                } else {
                    summaryEl.style.display = 'none';
                }
                const sorted = filteredTxs.sort((a, b) => (a.status === 'paid' || a.status === 'cleared' || a.status === 'received' ? 1 : -1) - (b.status === 'paid' || b.status === 'cleared' || b.status === 'received' ? 1 : -1) || moment(a.dueDate || a.date, MOMENT_FORMAT).diff(moment(b.dueDate || b.date, MOMENT_FORMAT)));
                listEl.innerHTML = ''; statusEl.textContent = '';
                if (sorted.length === 0) {
                    statusEl.textContent = baseTxs.length === 0 ? `هیچ موردی ثبت نشده است.` : 'هیچ موردی با این فیلتر یافت نشد.';
                } else {
                    listEl.innerHTML = sorted.map(tx => `<li data-id="${tx.id}" data-type="transaction">${getTransactionListItemHTML(tx, { showAccount: true })}</li>`).join('');
                }
            };
            const renderDebtsPage = () => renderFilteredListPage('debts-page', 'بدهی‌ها و چک‌های صادره', ['debt', 'issuedCheck']);
            const renderReceivablesPage = () => renderFilteredListPage('receivables-page', 'طلب‌ها و چک‌های دریافتی', ['receivable', 'receivedCheck']);
            function renderLoansPage() {
                const page = qs('#loans-page');
                if (!page) return;
                page.innerHTML = `
                    <div class="card-section">
                        <div class="section-header"><h3>تسهیلات و اقساط</h3><button class="btn btn-primary" data-action="add-loan"><i class="fas fa-plus"></i> تعریف تسهیلات</button></div>
                        <ul id="loans-list" class="list-container" style="margin: 0 -1.25rem;"></ul>
                        <div id="loans-status" class="list-status"></div>
                    </div>
                `;
                const listEl = qs('#loans-list'), statusEl = qs('#loans-status');
                listEl.innerHTML = '';
                if (state.loans.length === 0) {
                    statusEl.textContent = 'هیچ تسهیلاتی تعریف نشده است.'; return;
                }
                statusEl.textContent = '';
                listEl.innerHTML = state.loans.map(loan => {
                    const paidCount = state.transactions.filter(t => t.loanId == loan.id).length;
                    const progress = (loan.totalInstallments > 0) ? (paidCount / loan.totalInstallments) * 100 : 0;
                    const remainingAmount = (loan.totalInstallments - paidCount) * loan.installmentAmount;
                    return `<li data-id="${loan.id}" data-type="loan">
                                <div class="item-icon loan"><i class="fas fa-landmark"></i></div>
                                <div class="item-info">
                                    <p>${loan.bankName} - ${loan.description}</p>
                                    <div class="meta-data">
                                        <span>اقساط: ${paidCount} از ${loan.totalInstallments}</span>
                                        <span>مانده: ${formatCurrency(remainingAmount)}</span>
                                    </div>
                                    <div class="progress-bar-container" style="margin-top: 0.5rem; height: 6px;">
                                        <div class="progress-bar loan" style="width: ${progress}%"></div>
                                    </div>
                                </div>
                                <div class="item-actions">
                                     <button class="action-btn edit-btn" data-id="${loan.id}" data-type="loan"><i class="fas fa-pen-to-square"></i></button>
                                     <button class="action-btn delete-btn" data-id="${loan.id}" data-type="loan"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            </li>`;
                }).join('');
            }
            function renderSavingsPage() {
                const page = qs('#savings-page');
                if (!page) return;
                const savingsBalance = state.transactions.filter(tx => tx.type === 'transfer').reduce((acc, tx) => acc + tx.amount, 0);
                page.innerHTML = `
                                    <div class="card-section savings-hero-card">
                                        <div class="hero-icon"><i class="fas fa-piggy-bank"></i></div>
                                        <h4>موجودی صندوق پس‌انداز</h4>
                                        <h1>${formatCurrency(savingsBalance)}<span>تومان</span></h1>
                                        <button class="btn" data-action="add-to-fund">
                                            <i class="fas fa-donate"></i>
                                            <span>انتقال به صندوق</span>
                                        </button>
                                    </div>
                                    <div class="card-section">
                                        <div class="section-header"><h3>اهداف مالی</h3><button class="btn btn-primary" data-action="add-goal"><i class="fas fa-plus"></i> افزودن هدف</button></div>
                                        <div id="savings-goals-list"></div>
                                        <div id="savings-goals-status" class="list-status"></div>
                                    </div>
                `;
                const listEl = qs('#savings-goals-list'), statusEl = qs('#savings-goals-status');
                listEl.innerHTML = ''; statusEl.textContent = '';
                if (state.savingsGoals.length === 0) {
                    statusEl.textContent = 'هنوز هدفی تعریف نکرده‌اید.'; return;
                }
                state.savingsGoals.forEach(goal => {
                    const progress = (goal.targetAmount > 0) ? (goal.savedAmount / goal.targetAmount) * 100 : 0;
                    const div = document.createElement('div');
                    div.className = 'goal-item';
                    div.innerHTML = `
                        <div class="goal-header">
                            <div class="goal-title">
                                <div class="item-icon goal"><i class="fas fa-bullseye"></i></div>
                                <h4>${goal.name}</h4>
                            </div>
                            <div class="item-actions">
                                <button class="action-btn edit-btn" data-id="${goal.id}" data-type="goal"><i class="fas fa-edit"></i></button>
                                <button class="action-btn delete-btn" data-id="${goal.id}" data-type="goal"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </div>
                        <div class="goal-details">
                            <div><span>پس انداز شده</span><strong>${formatCurrency(goal.savedAmount)} تومان</strong></div>
                            <div><span>مبلغ هدف</span><strong>${formatCurrency(goal.targetAmount)} تومان</strong></div>
                        </div>
                        <div>
                            <div class="progress-bar-container"><div class="progress-bar goal" style="width: ${progress}%"></div></div>
                            <div class="progress-text">${Math.round(progress)}% تکمیل شده</div>
                        </div>`;
                    listEl.appendChild(div);
                });
            }
            function renderReportsPage() {
                const page = qs('#reports-page');
                if (!page) return;
                const pageKey = 'reports';
                page.innerHTML = `
                                    <div class="card-section">
                                        <div class="section-header">
                                            <h3>گزارش جامع</h3>
                                            <button class="btn btn-secondary ${isFilterActive(pageKey) ? 'filter-active' : ''}" data-action="toggle-filters">
                                                <i class="fas fa-filter"></i> <span>فیلتر</span>
                                            </button>
                                        </div>
                                        <div class="filters-collapsible-container">
                                            <div class="filter-grid">
                                                <div class="form-group"><input type="text" placeholder="از تاریخ" class="form-control pdate from-date-filter"></div>
                                                <div class="form-group"><input type="text" placeholder="تا تاریخ" class="form-control pdate to-date-filter"></div>
                                                <div class="form-group"><label>حساب</label><select class="form-control account-filter account-dropdown"></select></div>
                                            </div>
                                            <div class="form-group" style="margin-top: 1rem;"><button class="btn btn-secondary clear-generic-filters-btn" data-pagekey="${pageKey}" style="width:100%;">پاک کردن فیلترها</button></div>
                                        </div>
                                    </div>
                                    <div class="filter-summary" style="display: none;"></div>
                                    <div id="daily-reports-list"></div>
                                    <div id="reports-status" class="list-status"></div>
                `;
                populateDropdown(qs('.account-filter', page), state.accounts, 'id', 'name', { value: 'all', text: 'همه حساب‌ها' });
                qs('.account-filter', page).value = state.filters.reports.accountId;
                qs('.from-date-filter', page).value = state.filters.reports.from ? moment(state.filters.reports.from, MOMENT_FORMAT).format(JALALI_DISPLAY_FORMAT) : '';
                qs('.to-date-filter', page).value = state.filters.reports.to ? moment(state.filters.reports.to, MOMENT_FORMAT).format(JALALI_DISPLAY_FORMAT) : '';

                const filteredTxs = applyGenericFilters(state.transactions, 'reports');

                const dailyListEl = qs('#daily-reports-list', page), statusEl = qs('#reports-status', page);
                dailyListEl.innerHTML = '';
                statusEl.innerHTML = '';

                const summaryEl = qs('.filter-summary', page);
                if (filteredTxs.length > 0) {
                    summaryEl.style.display = 'block';
                    let totalIncome = 0, totalExpense = 0;
                    filteredTxs.forEach(tx => {
                        const amount = tx.amount;
                        if (tx.type === 'income' || (tx.type === 'receivable' && tx.status === 'received') || (tx.type === 'receivedCheck' && tx.status === 'cleared')) totalIncome += amount;
                        if (tx.type === 'expense' || tx.type === 'transfer' || tx.type === 'installmentPayment' || (tx.type === 'debt' && tx.status === 'paid') || (tx.type === 'issuedCheck' && tx.status === 'cleared')) totalExpense += amount;
                    });
                    const netFlow = totalIncome - totalExpense;
                    summaryEl.innerHTML = `<h4>خلاصه فیلتر</h4>
                                        <div class="summary-details">
                                            <div><span>مجموع دریافتی</span><strong style="color:var(--income);">${formatCurrency(totalIncome)}</strong></div>
                                            <div><span>مجموع پرداختی</span><strong style="color:var(--expense);">${formatCurrency(totalExpense)}</strong></div>
                                            <div><span>جریان خالص</span><strong style="color:${netFlow >= 0 ? 'var(--income)' : 'var(--expense)'};">${formatCurrency(netFlow)}</strong></div>
                                        </div>`;
                } else {
                    summaryEl.style.display = 'none';
                }

                if (state.transactions.length === 0) {
                    statusEl.innerHTML = 'برای نمایش گزارش، ابتدا تراکنشی ثبت کنید.'; return;
                }

                const groupedByDay = filteredTxs.reduce((acc, tx) => {
                    if (tx.date && moment(tx.date, MOMENT_FORMAT, true).isValid()) {
                        const day = tx.date;
                        if (!acc[day]) acc[day] = { income: 0, expense: 0, transactions: [] };
                        const amount = tx.amount;
                        if (tx.type === 'income' || (tx.type === 'receivable' && tx.status === 'received') || (tx.type === 'receivedCheck' && tx.status === 'cleared')) acc[day].income += amount;
                        if (tx.type === 'expense' || tx.type === 'transfer' || tx.type === 'installmentPayment' || (tx.type === 'debt' && tx.status === 'paid') || (tx.type === 'issuedCheck' && tx.status === 'cleared')) acc[day].expense += amount;
                        acc[day].transactions.push(tx);
                    }
                    return acc;
                }, {});

                const sortedDays = Object.keys(groupedByDay).sort((a, b) => moment(b, MOMENT_FORMAT).diff(moment(a, MOMENT_FORMAT)));
                if (sortedDays.length === 0) statusEl.textContent = 'هیچ موردی با این فیلتر یافت نشد.';

                dailyListEl.innerHTML = sortedDays.map(day => {
                    const data = groupedByDay[day];
                    const dayNet = data.income - data.expense;
                    const m = moment(day, MOMENT_FORMAT);
                    return `<div class="daily-report-item" data-net-flow="${dayNet}">
                                    <div class="daily-report-header">
                                        <div class="date-info">
                                            <span class="day-of-week">${m.format('dddd')}</span>
                                            <span class="date-full">${m.format(JALALI_DISPLAY_FORMAT)}</span>
                                        </div>
                                        <div class="flow-summary">
                                            <div class="flow-item income"><i class="fas fa-arrow-up"></i><span>${formatCurrency(data.income)}</span></div>
                                            <div class="flow-item expense"><i class="fas fa-arrow-down"></i><span>${formatCurrency(data.expense)}</span></div>
                                        </div>
                                        <i class="fas fa-chevron-down expand-arrow"></i>
                                    </div>
                                    <div class="daily-report-body">
                                        <ul class="list-container">${data.transactions.sort((a, b) => b.id - a.id).map(tx => `<li data-id="${tx.id}" data-type="transaction">${getTransactionListItemHTML(tx, { showAccount: true })}</li>`).join('')}</ul>
                                    </div>
                                </div>`;
                }).join('');
            }
            // CHANGE: Whole function rewritten for new design and logic
            function renderExpenseReportsPage() {
                const page = qs('#expense-reports-page');
                if (!page) return;

                page.innerHTML = `
                    <div class="section-header" style="margin-bottom: 1rem;">
                        <h3>گزارش هزینه ها بر اساس دسته بندی</h3>
                        <div class="header-actions">
                            <button class="btn btn-primary" data-action="add-expense-category">
                                <i class="fas fa-plus"></i> دسته جدید
                            </button>
                        </div>
                    </div>

                    <div class="category-report-list" id="expense-categories-list"></div>
                    <div id="expense-reports-status" class="list-status"></div>`;


                const expenseTxs = state.transactions.filter(tx => tx.type === 'expense');
                // Note: Filters were removed from this page per user request. All expenses are considered.
                const filteredTxs = expenseTxs;

                const listEl = qs('#expense-categories-list');
                const statusEl = qs('#expense-reports-status');
                listEl.innerHTML = '';
                statusEl.innerHTML = '';

                if (state.expenseCategories.length === 0) {
                    statusEl.innerHTML = 'هنوز دسته‌بندی هزینه‌ای تعریف نشده است.';
                    return;
                }

                const totalOverallExpense = filteredTxs.reduce((sum, tx) => sum + tx.amount, 0);

                let categoryData = state.expenseCategories.map(category => {
                    const txs = filteredTxs.filter(tx => tx.category === category.name);
                    return {
                        name: category.name,
                        icon: category.icon || 'fa-tag',
                        count: txs.length,
                        total: txs.reduce((sum, tx) => sum + tx.amount, 0)
                    };
                });

                // Default sort by total expense
                categoryData.sort((a, b) => b.total - a.total);

                const categoryColors = ['#007AFF', '#34C759', '#FF9500', '#FF3B30', '#AF52DE', '#5856D6', '#FF2D55', '#5AC8FA', '#FFCC00', '#64D2FF'];

                if (categoryData.length === 0 && filteredTxs.length > 0) {
                         statusEl.innerHTML = 'موردی با فیلترهای مشخص شده یافت نشد.';
                } else if (state.transactions.filter(tx => tx.type === 'expense').length === 0) {
                    statusEl.innerHTML = 'برای مشاهده گزارش، ابتدا یک تراکنش هزینه ثبت کنید.';
                }
                
                listEl.innerHTML = categoryData.map((cat, index) => {
                    const percentage = totalOverallExpense > 0 ? (cat.total / totalOverallExpense) * 100 : 0;
                    const bgColor = categoryColors[index % categoryColors.length];
                    return `
                    <div class="category-report-card-new" data-action="view-category-transactions" data-category-name="${cat.name}">
                        <div class="item-icon expense" style="background-color: ${bgColor}; color: #FFF;"><i class="fas ${cat.icon}"></i></div>
                        <div class="category-info">
                            <h4 class="category-title">${cat.name}</h4>
                            <div class="category-stats">
                                <span class="tx-count">${cat.count} تراکنش</span>
                            </div>
                        </div>
                        <div class="category-amount-progress">
                            <span class="total-amount">${formatCurrency(cat.total)} تومان</span>
                            <div class="progress-bar-wrapper">
                                <div class="percentage-text">${percentage.toFixed(0)}%</div>
                                <div class="progress-bar-container">
                                    <div class="progress-bar expense" style="width: ${percentage.toFixed(1)}%; background-color: ${bgColor};"></div>
                                </div>
                            </div>
                        </div>
                        <div class="item-actions">
                            <button class="action-btn edit-btn" data-type="expense-category" data-id="${cat.name}"><i class="fas fa-pen"></i></button>
                        </div>
                    </div>`;
                }).join('');
            }


            const populateDropdown = (selectEl, data, valueField, textField, addOption) => {
                if (!selectEl) return;
                let currentValue = selectEl.value;
                selectEl.innerHTML = '';
                if (addOption) { const opt = document.createElement('option'); opt.value = addOption.value; opt.textContent = addOption.text; selectEl.appendChild(opt); }
                data.forEach(item => { const option = document.createElement('option'); option.value = item[valueField]; option.textContent = item[textField]; selectEl.appendChild(option); });
                if (selectEl.classList.contains('account-dropdown')) { selectEl.innerHTML += `<option value="add_new_account" style="font-weight: bold; color: var(--primary);">+ افزودن حساب جدید...</option>`; }
                selectEl.value = currentValue;
            };
            const renderTransactionModal = (txId = null, type = null) => {
                const modal = qs('#transaction-modal-overlay');
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header"><h3 id="transaction-modal-title">تراکنش جدید</h3></div>
                        <form id="transaction-form">
                            <input type="hidden" id="transaction-id">
                            <div class="form-group"><label for="type">نوع تراکنش</label><select id="type" required class="form-control"></select></div>
                            <div class="form-group"><label for="account-select">از/به حساب</label><select id="account-select" required class="form-control account-dropdown"></select></div>
                            <div class="form-group" id="loan-payment-group" style="display: none;"><label for="loan-select">پرداخت قسطِ</label><select id="loan-select" class="form-control"></select><div id="add-loan-prompt" style="display: none; margin-top: 0.5rem;"><small>هنوز تسهیلاتی تعریف نشده. <a href="#" data-action="go-to-loans">برای افزودن کلیک کنید.</a></small></div></div>
                            <div class="form-group" id="category-group" style="display: none;"><label for="category-select">انتخاب دسته/منبع</label><select id="category-select" class="form-control"></select></div>
                            <div class="form-group" id="new-category-group" style="display: none;"><input type="text" id="new-category-input" placeholder="نام دسته/منبع جدید (مثال: اجاره خانه)" class="form-control"></div>
                            <div class="form-group"><input type="text" id="description" class="form-control" placeholder="توضیحات (اختیاری)"></div>
                            <div class="form-group"><input type="text" id="amount" required class="form-control currency-input" inputmode="decimal" placeholder="مبلغ (تومان)"></div>
                            <div class="form-group"><input type="text" id="transaction-date" required class="form-control pdate" placeholder="تاریخ تراکنش"/></div>
                            <div class="form-group" id="due-date-group" style="display: none;"><input type="text" id="due-date" class="form-control pdate" placeholder="تاریخ سررسید"/></div>
                            <div class="form-group" id="status-group" style="display: none;"><label for="status-select">وضعیت</label><select id="status-select" class="form-control"></select></div>
                            <div class="form-actions"><button type="button" class="btn btn-secondary" data-action="close-modal">انصراف</button><button type="submit" class="btn btn-primary">ثبت</button></div>
                        </form>
                    </div>`;
                const form = qs('#transaction-form', modal);
                qs('#transaction-modal-title', modal).textContent = txId ? 'ویرایش تراکنش' : 'تراکنش جدید';
                qs('#transaction-id', form).value = txId || '';
                populateDropdown(qs('#type', form), Object.entries(TRANSACTION_TYPES).map(([k, v]) => ({ key: k, val: v })), 'key', 'val');
                populateDropdown(qs('#account-select', form), state.accounts, 'id', 'name');
                if (type) qs('#type', form).value = type;
                if (txId) {
                    const tx = state.transactions.find(t => t.id == txId);
                    qs('#type', form).value = tx.type;
                    handleTransactionFormChange();
                    qs('#account-select', form).value = tx.accountId;
                    qs('#description', form).value = tx.description;
                    qs('#amount', form).value = formatCurrency(tx.amount);
                    qs('#transaction-date', form).value = tx.date ? moment(tx.date, MOMENT_FORMAT).format(JALALI_DISPLAY_FORMAT) : '';
                    if (qs('#due-date-group').style.display !== 'none') qs('#due-date', form).value = tx.dueDate ? moment(tx.dueDate, MOMENT_FORMAT).format(JALALI_DISPLAY_FORMAT) : '';
                    if (tx.status) qs('#status-select', form).value = tx.status;
                    if (tx.category) qs('#category-select', form).value = tx.category;
                    if (tx.loanId) qs('#loan-select', form).value = tx.loanId;
                } else {
                    qs('#transaction-date', form).value = moment().format(JALALI_DISPLAY_FORMAT);
                    qs('#status-select', form).value = 'pending';
                }
                handleTransactionFormChange();
                initDatepickers(modal);
                openModal('#transaction-modal-overlay');
            };
            const handleTransactionFormChange = () => {
                const form = qs('#transaction-form');
                if (!form) return;
                const typeVal = qs('#type', form).value;
                const statusTypes = ['debt', 'receivable', 'issuedCheck', 'receivedCheck'];
                qs('#status-group', form).style.display = statusTypes.includes(typeVal) ? 'block' : 'none';
                qs('#due-date-group', form).style.display = statusTypes.includes(typeVal) ? 'block' : 'none';
                qs('#category-group', form).style.display = ['income', 'expense'].includes(typeVal) ? 'block' : 'none';
                qs('#loan-payment-group', form).style.display = typeVal === 'installmentPayment' ? 'block' : 'none';
                qs('#new-category-group', form).style.display = 'none';

                if (statusTypes.includes(typeVal)) {
                    populateDropdown(qs('#status-select', form), Object.entries(STATUS_TYPES[typeVal] || {}).map(([k, v]) => ({ key: k, val: v })), 'key', 'val');
                }

                if (['income', 'expense'].includes(typeVal)) {
                    // CHANGE: Populate from array of objects
                    let categories = (typeVal === 'income') ? state.incomeSources : state.expenseCategories;
                    const categorySelect = qs('#category-select', form);
                    const optionsHTML = categories.map(c => {
                        const emoji = CATEGORY_EMOJI_MAP[c.name] || '▫️';
                        return `<option value="${c.name}">${emoji} ${c.name}</option>`;
                    }).join('');
                    categorySelect.innerHTML = optionsHTML + '<option value="add-new" style="font-weight:bold;">+ افزودن دسته جدید...</option>';
                }
                if (typeVal === 'installmentPayment') {
                    if (state.loans.length > 0) {
                        populateDropdown(qs('#loan-select', form), state.loans, 'id', 'bankName');
                        qs('#loan-select', form).style.display = 'block';
                        qs('#add-loan-prompt', form).style.display = 'none';
                    } else {
                        qs('#loan-select', form).style.display = 'none';
                        qs('#add-loan-prompt', form).style.display = 'block';
                    }
                }
            };
            const renderAccountModal = (accId = null) => {
                const modal = qs('#account-modal-overlay');
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header"><h3 id="account-modal-title">${accId ? 'ویرایش حساب' : 'حساب جدید'}</h3></div>
                        <form id="account-form">
                            <input type="hidden" id="account-id" value="${accId || ''}">
                            <div class="form-group"><input type="text" id="account-name" required class="form-control" placeholder="نام حساب (مثال: بانک ملی، کیف پول)"></div>
                            <div class="form-group"><input type="text" id="card-number" placeholder="شماره کارت (اختیاری): xxxx-xxxx-xxxx-xxxx" inputmode="numeric" class="form-control"></div>
                            <div class="filter-grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                                <div class="form-group"><input type="text" id="exp-month" placeholder="ماه انقضا" inputmode="numeric" class="form-control"></div>
                                <div class="form-group"><input type="text" id="exp-year" placeholder="سال انقضا" inputmode="numeric" class="form-control"></div>
                                <div class="form-group"><input type="text" id="cvv2" placeholder="CVV2" inputmode="numeric" class="form-control"></div>
                            </div>
                            <div class="form-group"><input type="text" id="account-number" placeholder="شماره حساب (اختیاری)" inputmode="numeric" class="form-control"></div>
                            <div class="form-group"><input type="text" id="shaba-number" placeholder="شماره شبا (اختیاری): IR..." inputmode="text" class="form-control"></div>
                            <div class="form-group"><textarea id="notes" rows="2" class="form-control" placeholder="یادداشت (اختیاری)"></textarea></div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" data-action="close-modal">انصراف</button>
                                ${accId ? `<button type="button" class="btn btn-danger" data-action="delete-item" data-id="${accId}" data-type="account">حذف</button>` : ''}
                                <button type="submit" class="btn btn-primary" style="flex-grow: 2;">ذخیره</button>
                            </div>
                        </form>
                    </div>`;
                if (accId) {
                    const acc = state.accounts.find(a => a.id == accId);
                    if (acc) {
                        qs('#account-name', modal).value = acc.name;
                        qs('#card-number', modal).value = acc.cardNumber || '';
                        qs('#exp-month', modal).value = acc.expMonth || '';
                        qs('#exp-year', modal).value = acc.expYear || '';
                        qs('#cvv2', modal).value = acc.cvv2 || '';
                        qs('#account-number', modal).value = acc.accountNumber || '';
                        qs('#shaba-number', modal).value = acc.shabaNumber || '';
                        qs('#notes', modal).value = acc.notes || '';
                    }
                }
                openModal('#account-modal-overlay');
            };
            const renderMoreMenuModal = () => {
                const modal = qs('#more-menu-modal-overlay');
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header"><h3>بیشتر</h3></div>
                        <ul class="list-container" style="margin:0;">
                            <li class="more-menu-item" data-page="reports-page" data-title="گزارش‌های جامع"><div class="item-icon" style="background-color:rgba(255,159,10,0.15); color: #ff9f0a;"><i class="fas fa-chart-pie"></i></div><div class="item-info"><p>گزارش‌ جامع روزانه</p></div><i class="fas fa-chevron-left"></i></li>
                            <li class="more-menu-item" data-page="expense-reports-page" data-title="گزارش هزینه ها بر اساس دسته بندی"><div class="item-icon expense"><i class="fas fa-chart-bar"></i></div><div class="item-info"><p>گزارش هزینه ها بر اساس دسته بندی</p></div><i class="fas fa-chevron-left"></i></li>
                            <li class="more-menu-item" data-page="debts-page" data-title="بدهی‌ها"><div class="item-icon debt"><i class="fas fa-file-invoice-dollar"></i></div><div class="item-info"><p>بدهی‌ها و چک‌های صادره</p></div><i class="fas fa-chevron-left"></i></li>
                            <li class="more-menu-item" data-page="receivables-page" data-title="طلب‌ها"><div class="item-icon receivable"><i class="fas fa-hand-holding-dollar"></i></div><div class="item-info"><p>طلب‌ها و چک‌های دریافتی</p></div><i class="fas fa-chevron-left"></i></li>
                            <li class="more-menu-item" data-page="loans-page" data-title="تسهیلات"><div class="item-icon loan"><i class="fas fa-landmark"></i></div><div class="item-info"><p>تسهیلات و اقساط</p></div><i class="fas fa-chevron-left"></i></li>
                            <li class="more-menu-item" data-page="savings-page" data-title="پس‌انداز"><div class="item-icon goal"><i class="fas fa-piggy-bank"></i></div><div class="item-info"><p>اهداف و پس‌انداز</p></div><i class="fas fa-chevron-left"></i></li>
                        </ul>
                               <div style="text-align: center; padding: 15px 10px 5px; font-size: 0.75rem; color: var(--subtext-light);">
                                     وب اپلیکیشن حسابداری شخصی شمار نسخه 0.9 | طراحی و کدنویسی شده توسط پیمان عابدین پور
                                     </div>
                    </div>`;
                openModal('#more-menu-modal-overlay');
            };
            const renderConfirmModal = (message) => {
                const modal = qs('#confirm-modal-overlay');
                modal.innerHTML = `
                    <div class="modal-content" style="text-align:center;">
                        <div class="modal-header" style="padding-bottom: 0.5rem"><h3>تایید حذف</h3></div>
                        <p id="confirm-delete-message" style="margin: 1rem 0 1.5rem;">${message}</p>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" data-action="close-modal">خیر</button>
                            <button type="button" class="btn btn-danger" id="confirm-delete-btn">بله، حذف کن</button>
                        </div>
                    </div>`;
                openModal('#confirm-modal-overlay');
            };
            const renderSettingsModal = () => {
                qs('#settings-modal-overlay').innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header"><h3>تنظیمات و پشتیبان‌گیری</h3></div>
                        <p style="text-align: center; color: var(--subtext-light); margin-bottom: 2rem;">از اطلاعات خود فایل پشتیبان تهیه کنید یا اطلاعات قبلی خود را بازیابی نمایید.</p>
                        <div class="form-actions" style="flex-direction: column; gap: 1rem;">
                            <button class="btn btn-success" id="backup-btn" style="width: 100%;">
                                <i class="fas fa-download" style="margin-left: 8px;"></i> ایجاد فایل پشتیبان
                            </button>
                            <button class="btn btn-primary" id="restore-btn" style="width: 100%;">
                                <i class="fas fa-upload" style="margin-left: 8px;"></i> بازگردانی از فایل پشتیبان
                            </button>
                            <input type="file" id="restore-file-input" accept=".db,.json" style="display: none;">
                        </div>
                       <div class="form-actions" style="margin-top: 1.5rem; flex-direction: column; gap: 1rem;">
                               <button class="btn btn-primary" id="install-pwa-btn" style="width:100%; display: none; background-color: var(--purple-ios);">
                                   <i class="fas fa-cloud-download-alt" style="margin-left: 8px;"></i> نصب برنامه
                                   </button>
                       </div>
                        <div class="form-actions" style="margin-top: 2rem; justify-content: center;">
                            <button type="button" class="btn btn-secondary" data-action="close-modal">بستن</button>
                        </div>
                    </div>`;
                if (deferredPrompt) {
                    const installBtn = qs('#install-pwa-btn');
                    if (installBtn) installBtn.style.display = 'flex';
                }
                openModal('#settings-modal-overlay');
            };
            const renderLoanModal = (loanId = null) => {
                const modal = qs('#loan-modal-overlay');
                modal.innerHTML = `
                    <div class="modal-content">
                        <form id="loan-form">
                            <div class="modal-header"><h3 id="loan-modal-title">${loanId ? 'ویرایش تسهیلات' : 'تعریف تسهیلات'}</h3></div>
                            <input type="hidden" id="loan-id" value="${loanId || ''}">
                            <div class="form-group"><input type="text" id="bank-name" required class="form-control" placeholder="نام بانک یا موسسه"></div>
                            <div class="form-group"><input type="text" id="loan-description" required class="form-control" placeholder="توضیح (مثال: وام خرید کالا)"></div>
                            <div class="form-group"><input type="number" id="total-installments" required min="1" class="form-control" inputmode="numeric" placeholder="تعداد کل اقساط"></div>
                            <div class="form-group"><input type="text" id="installment-amount" required class="form-control currency-input" inputmode="decimal" placeholder="مبلغ هر قسط (تومان)"></div>
                            <div class="form-actions"><button type="button" class="btn btn-secondary" data-action="close-modal">انصراف</button><button type="submit" class="btn btn-primary">ذخیره</button></div>
                        </form>
                    </div>`;
                if (loanId) {
                    const loan = state.loans.find(l => l.id == loanId);
                    if (loan) {
                        qs('#bank-name', modal).value = loan.bankName;
                        qs('#loan-description', modal).value = loan.description;
                        qs('#total-installments', modal).value = loan.totalInstallments;
                        qs('#installment-amount', modal).value = formatCurrency(loan.installmentAmount);
                    }
                }
                openModal('#loan-modal-overlay');
            };
            const renderGoalModal = (goalId = null) => {
                const modal = qs('#goal-modal-overlay');
                modal.innerHTML = `
                    <div class="modal-content">
                        <form id="goal-form">
                            <div class="modal-header"><h3 id="goal-modal-title">${goalId ? 'ویرایش هدف' : 'هدف مالی جدید'}</h3></div>
                            <input type="hidden" id="goal-id" value="${goalId || ''}">
                            <div class="form-group"><input type="text" id="goal-name" required class="form-control" placeholder="عنوان هدف (مثال: سفر به کیش)"></div>
                            <div class="form-group"><input type="text" id="target-amount" required class="form-control currency-input" inputmode="decimal" placeholder="مبلغ هدف (تومان)"></div>
                            <div class="form-group"><input type="text" id="saved-amount" value="0" class="form-control currency-input" inputmode="decimal" placeholder="مبلغ پس‌انداز شده اولیه (تومان)"></div>
                            <div class="form-actions"><button type="button" class="btn btn-secondary" data-action="close-modal">انصراف</button><button type="submit" class="btn btn-primary">ذخیره</button></div>
                        </form>
                    </div>`;
                if (goalId) {
                    const goal = state.savingsGoals.find(g => g.id == goalId);
                    if (goal) {
                        qs('#goal-name', modal).value = goal.name;
                        qs('#target-amount', modal).value = formatCurrency(goal.targetAmount);
                        qs('#saved-amount', modal).value = formatCurrency(goal.savedAmount);
                    }
                }
                openModal('#goal-modal-overlay');
            };
            const renderAccountDetailsModal = (accId) => {
                const acc = state.accounts.find(a => a.id == accId);
                if (!acc) return;
                const modal = qs('#account-details-modal-overlay');
                modal.innerHTML = `
                <div class="modal-content" id="account-details-content">
                    <div class="modal-header"><h3>${acc.name}</h3></div>
                    <div style="text-align: right; line-height: 2; font-size: 0.9rem; padding: 0 1rem;">
                        <p><strong>شماره کارت:</strong> ${acc.cardNumber || '-'}</p>
                        <p><strong>تاریخ انقضا:</strong> ${(acc.expMonth && acc.expYear) ? `${acc.expMonth}/${acc.expYear}` : '-'}</p>
                        <p><strong>CVV2:</strong> ${acc.cvv2 || '-'}</p>
                        <p><strong>شماره حساب:</strong> ${acc.accountNumber || '-'}</p>
                        <p><strong>شماره شبا:</strong> ${acc.shabaNumber || '-'}</p>
                        <p><strong>یادداشت:</strong> ${acc.notes || '-'}</p>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" data-action="close-modal">بستن</button>
                        <button type="button" class="btn btn-primary" data-action="edit-account" data-id="${acc.id}">ویرایش</button>
                    </div>
                </div>`;
                openModal('#account-details-modal-overlay');
            };
            // CHANGE: Updated modal to include an icon picker
            const renderExpenseCategoryModal = (categoryName = null) => {
                const modal = qs('#expense-category-modal-overlay');
                const isEdit = categoryName !== null;
                const category = isEdit ? state.expenseCategories.find(c => c.name === categoryName) : null;
                const currentIcon = category ? category.icon : 'fa-tag';

                const iconPickerHTML = AVAILABLE_ICONS.map(icon =>
                    `<i class="fas ${icon} icon-picker-item ${currentIcon === icon ? 'selected' : ''}" data-icon="${icon}"></i>`
                ).join('');

                modal.innerHTML = `
                    <div class="modal-content">
                        <form id="expense-category-form">
                            <div class="modal-header"><h3>${isEdit ? 'ویرایش دسته‌بندی' : 'دسته‌بندی هزینه جدید'}</h3></div>
                            <input type="hidden" id="original-category-name" value="${categoryName || ''}">
                            <div class="form-group">
                                <label for="category-name-input">نام دسته‌بندی</label>
                                <input type="text" id="category-name-input" required class="form-control" value="${categoryName || ''}" placeholder="مثال: آموزش">
                            </div>
                             <div class="form-group">
                                 <label for="category-icon-picker">آیکون</label>
                                 <div class="icon-picker" id="category-icon-picker">${iconPickerHTML}</div>
                                 <input type="hidden" id="selected-category-icon" value="${currentIcon}">
                             </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" data-action="close-modal">انصراف</button>
                                <button type="submit" class="btn btn-primary">ذخیره</button>
                            </div>
                        </form>
                    </div>`;

                qs('.icon-picker', modal).addEventListener('click', e => {
                    if (e.target.classList.contains('icon-picker-item')) {
                        qs('.icon-picker-item.selected', modal)?.classList.remove('selected');
                        e.target.classList.add('selected');
                        qs('#selected-category-icon', modal).value = e.target.dataset.icon;
                    }
                });

                openModal('#expense-category-modal-overlay');
            };

            const setupEventListeners = () => {
                document.body.addEventListener('click', (e) => {
                    const target = e.target;
                    const closest = (selector) => target.closest(selector);

                    if (closest('.nav-btn, .fab, .action-card, .btn, .more-menu-item, #theme-toggle, #toggle-balance-visibility, .summary-card')) {
                        triggerHapticFeedback();
                    }
                    // CHANGE: New click handlers for expense report page actions
                    const expenseCategoryCard = closest('#expense-reports-page .category-report-card-new');
                    if (expenseCategoryCard && !closest('.action-btn')) {
                        e.preventDefault();
                        const categoryName = expenseCategoryCard.dataset.categoryName;
                        state.filters.transactions = {
                            searchTerm: '',
                            from: state.filters.expenseReports.from,
                            to: state.filters.expenseReports.to,
                            type: 'expense',
                            accountId: state.filters.expenseReports.accountId,
                            category: categoryName
                        };
                        saveData();
                        switchPage('transactions-page', `تراکنش‌ها: ${categoryName}`);
                        return;
                    }
                    if (closest('[data-action="sort-expense-reports"]')) {
                        const currentSort = state.filters.expenseReports.sortBy;
                        const sortOptions = ['total', 'name', 'count'];
                        const nextIndex = (sortOptions.indexOf(currentSort) + 1) % sortOptions.length;
                        state.filters.expenseReports.sortBy = sortOptions[nextIndex];
                        saveData();
                        renderExpenseReportsPage();
                        return;
                    }


                    const navBtn = closest('.nav-btn');
                    if (navBtn && navBtn.dataset.page) { switchPage(navBtn.dataset.page, navBtn.dataset.title); return; }

                    if (closest('[data-action="open-more-menu"]')) { renderMoreMenuModal(); return; }
                    const moreMenuItem = closest('.more-menu-item');
                    if (moreMenuItem) {
                        closeModal('#more-menu-modal-overlay');
                        setTimeout(() => {
                            switchPage(moreMenuItem.dataset.page, moreMenuItem.dataset.title);
                        }, 150);
                        return;
                    }

                    if (target.matches('.modal-overlay') || closest('[data-action="close-modal"]')) { closeModal('#' + closest('.modal-overlay').id); return; }
                    if (closest('.fab')) { renderTransactionModal(); return; }
                    if (closest('[data-action="add-account"]')) { renderAccountModal(); return; }
                    if (closest('#settings-btn')) { renderSettingsModal(); return; }
                    if (closest('[data-action="toggle-filters"]')) {
                        const container = closest('.page').querySelector('.filters-collapsible-container');
                        container?.classList.toggle('visible');
                        return;
                    }

                    const summaryCard = closest('.summary-card[data-page]');
                    if (summaryCard) {
                        const pageId = summaryCard.dataset.page;
                        const title = summaryCard.dataset.title;
                        const filterType = summaryCard.dataset.filterType;
                        if (pageId === 'transactions-page') {
                            state.filters.transactions = { searchTerm: '', from: null, to: null, type: filterType || 'all', accountId: state.activeAccountId, category: 'all' };
                        } else if (pageId === 'debts-page') {
                            state.filters.debts = { from: null, to: null, accountId: 'all', status: 'all' };
                        } else if (pageId === 'receivables-page') {
                            state.filters.receivables = { from: null, to: null, accountId: 'all', status: 'all' };
                        }
                        saveData();
                        switchPage(pageId, title);
                        return;
                    }

                    const quickAction = closest('.action-card');
                    if (quickAction) {
                        const action = quickAction.dataset.action;
                        if (action === 'quick-add-income') renderTransactionModal(null, 'income');
                        if (action === 'quick-add-expense') renderTransactionModal(null, 'expense');
                        if (action === 'quick-add-debt') renderTransactionModal(null, 'debt');
                        if (action === 'quick-add-receivable') renderTransactionModal(null, 'receivable');
                        return;
                    }

                    if (closest('[data-action="add-to-fund"]')) { renderTransactionModal(null, 'transfer'); return; }
                    if (closest('[data-action="add-loan"]')) { renderLoanModal(); return; }
                    if (closest('[data-action="add-goal"]')) { renderGoalModal(); return; }
                    if (closest('[data-action="add-expense-category"]')) { renderExpenseCategoryModal(); return; }
                    if (closest('[data-action="go-to-loans"]')) { e.preventDefault(); closeModal('#transaction-modal-overlay'); switchPage('loans-page', 'تسهیلات'); return; }
                    if (closest('[data-action="edit-account"]')) { closeModal('#account-details-modal-overlay'); renderAccountModal(closest('[data-action="edit-account"]').dataset.id); return; }


                    const listItem = closest('.list-container li[data-id]');
                    if (listItem && !closest('.action-btn')) {
                        const id = listItem.dataset.id;
                        const type = listItem.dataset.type;
                        if (type === 'account') renderAccountDetailsModal(id);
                        else if (type === 'loan') renderLoanModal(id);
                        else if (type === 'transaction') renderTransactionModal(id);
                        return;
                    }

                    const actionBtn = closest('.action-btn');
                    if (actionBtn) {
                        e.stopPropagation();
                        e.preventDefault(); // Prevent navigation on card click when button is pressed
                        const id = actionBtn.dataset.id;
                        const type = actionBtn.dataset.type;
                        if (actionBtn.classList.contains('edit-btn')) {
                            if (type === 'goal') renderGoalModal(id);
                            else if (type === 'transaction') renderTransactionModal(id);
                            else if (type === 'loan') renderLoanModal(id);
                            else if (type === 'expense-category') renderExpenseCategoryModal(id);
                        } else if (actionBtn.classList.contains('delete-btn')) {
                            itemToDelete = { id: (type === 'expense-category') ? id : parseInt(id), type: type };
                            let message = 'آیا از حذف این مورد مطمئن هستید؟';
                            if (type === 'expense-category') {
                                message = `با حذف دسته‌بندی «${id}»، این دسته از تمام تراکنش‌های مرتبط نیز حذف خواهد شد. آیا مطمئن هستید؟`
                            }
                            renderConfirmModal(message);
                        }
                        return;
                    }

                    const deleteBtn = closest('[data-action="delete-item"]');
                    if (deleteBtn) {
                        itemToDelete = { id: parseInt(deleteBtn.dataset.id), type: deleteBtn.dataset.type };
                        if (itemToDelete.type === 'account') {
                            renderConfirmModal('هشدار: فقط در صورتی می‌توانید حساب را حذف کنید که هیچ تراکنشی نداشته باشد. آیا ادامه می‌دهید؟');
                            closeModal('#account-modal-overlay');
                        } else {
                            renderConfirmModal('آیا از حذف این مورد مطمئن هستید؟');
                        }
                        return;
                    }

                    if (closest('#confirm-delete-btn')) { handleDelete(); return; }
                    if (closest('#theme-toggle')) { document.body.classList.toggle('dark-mode'); updateThemeIcon(); saveData(); }
                    if (closest('#toggle-balance-visibility')) { state.isBalanceVisible = !state.isBalanceVisible; saveData(); renderDashboardPage(); }
                    if (closest('.daily-report-header')) { closest('.daily-report-item').classList.toggle('active'); }
                    if (closest('#backup-btn')) { handleBackup(); return; }
                    if (closest('#restore-btn')) { qs('#restore-file-input').click(); return; }
                    if (closest('#export-csv-btn')) { exportTransactionsToCSV(); return; }
                    if (closest('#clear-tx-filters-btn')) { state.filters.transactions = { searchTerm: '', from: null, to: null, type: 'all', accountId: 'all', category: 'all' }; renderTransactionsPage(); saveData(); return; }

                    if (closest('.clear-generic-filters-btn')) {
                        const pageKey = target.dataset.pagekey;
                        if (pageKey && state.filters[pageKey]) {
                            state.filters[pageKey] = { from: null, to: null, accountId: 'all', status: 'all', sortBy: 'total' }; // Reset sortBy for expense reports
                            saveData();
                            const title = qs('#app-header-title').textContent;
                            switchPage(`${pageKey}-page`, title);
                        }
                        return;
                    }
                    if (closest('#install-pwa-btn')) {
                        if (deferredPrompt) {
                            deferredPrompt.prompt();
                            deferredPrompt.userChoice.then((choiceResult) => {
                                if (choiceResult.outcome === 'accepted') {
                                    showToast('برنامه با موفقیت نصب شد.');
                                } else {
                                    showToast('نصب برنامه لغو شد.');
                                }
                                deferredPrompt = null;
                                closeModal('#settings-modal-overlay');
                            });
                        }
                        return;
                    }
                });

                document.body.addEventListener('submit', (e) => {
                    e.preventDefault();
                    triggerHapticFeedback(5);
                    if (e.target.id === 'transaction-form') { handleTransactionSubmit(e.target); }
                    if (e.target.id === 'account-form') { handleAccountSubmit(e.target); }
                    if (e.target.id === 'loan-form') { handleLoanSubmit(e.target); }
                    if (e.target.id === 'goal-form') { handleGoalSubmit(e.target); }
                    if (e.target.id === 'expense-category-form') { handleExpenseCategorySubmit(e.target); }
                });

                document.body.addEventListener('change', (e) => {
                    const target = e.target;
                    if (target.id === 'dashboard-period-filter') { state.dashboardPeriod = target.value; saveData(); renderDashboardPage(); }
                    if (target.id === 'account-filter-dashboard') { if (target.value !== 'add_new_account') { state.activeAccountId = target.value; saveData(); renderDashboardPage(); } }

                    if (target.closest('#transactions-page')) {
                        const txFilters = target.closest('.filters-collapsible-container');
                        if (txFilters) {
                            if (target.id === 'type-filter') {
                                state.filters.transactions.category = 'all';
                                renderCategoryFilter();
                            }
                            state.filters.transactions.accountId = qs('#account-filter', txFilters.parentElement).value;
                            state.filters.transactions.type = qs('#type-filter', txFilters.parentElement).value;
                            state.filters.transactions.category = qs('#category-filter', txFilters.parentElement).value;
                            state.filters.transactions.from = qs('#from-date-filter-tx', txFilters.parentElement).value ? moment(normalizeDigits(qs('#from-date-filter-tx').value), JALALI_DISPLAY_FORMAT).format(MOMENT_FORMAT) : null;
                            state.filters.transactions.to = qs('#to-date-filter-tx', txFilters.parentElement).value ? moment(normalizeDigits(qs('#to-date-filter-tx').value), JALALI_DISPLAY_FORMAT).format(MOMENT_FORMAT) : null;
                            renderTransactionList();
                            saveData();
                            return;
                        }
                    }
                    // CHANGE: Updated generic filter handler
                    if (target.closest('.page[id$="-page"] .filters-collapsible-container')) {
                        const pageEl = target.closest('.page');
                        const pageKey = pageEl.id.replace('-page', '');
                        if (state.filters[pageKey]) {
                            state.filters[pageKey] = {
                                ...state.filters[pageKey],
                                from: qs('.from-date-filter', pageEl)?.value ? moment(normalizeDigits(qs('.from-date-filter', pageEl).value), JALALI_DISPLAY_FORMAT).format(MOMENT_FORMAT) : null,
                                to: qs('.to-date-filter', pageEl)?.value ? moment(normalizeDigits(qs('.to-date-filter', pageEl).value), JALALI_DISPLAY_FORMAT).format(MOMENT_FORMAT) : null,
                                accountId: qs('.account-filter', pageEl) ? qs('.account-filter', pageEl).value : 'all',
                                status: qs('.status-filter', pageEl) ? qs('.status-filter', pageEl).value : 'all',
                            };
                            saveData();
                            switchPage(pageEl.id, qs(`#app-header-title`).textContent);
                        }
                        return;
                    }

                    if (target.matches('#transaction-form #type')) { handleTransactionFormChange(); }
                    if (target.matches('#transaction-form #category-select')) { qs('#new-category-group').style.display = target.value === 'add-new' ? 'block' : 'none'; }
                });

                document.body.addEventListener('input', (e) => {
                    if (e.target.id === 'search-input' && e.target.closest('#transactions-page')) {
                        state.filters.transactions.searchTerm = e.target.value.toLowerCase();
                        renderTransactionList();
                        saveData();
                    }
                    if (e.target.classList.contains('currency-input')) formatInputAsCurrency(e.target);
                });

                document.body.addEventListener('mousedown', e => { if (e.target.tagName === 'SELECT' && e.target.classList.contains('account-dropdown')) { preChangeSelectValue = e.target.value; } });
                document.body.addEventListener('change', e => { if (e.target.tagName === 'SELECT' && e.target.classList.contains('account-dropdown')) { if (e.target.value === 'add_new_account') { const selectEl = e.target; selectEl.value = preChangeSelectValue; let modal = selectEl.closest('.modal-overlay'); if (modal) closeModal('#' + modal.id); switchPage('accounts-page', 'حساب‌ها'); setTimeout(() => renderAccountModal(), 150); } } });

                qs('#restore-file-input').addEventListener('change', handleRestore);
            };

            function handleTransactionSubmit(form) {
                const id = qs('#transaction-id', form).value;
                const type = qs('#type', form).value;
                let category = qs('#category-select', form).value;
                const newCategory = qs('#new-category-input', form).value.trim();

                if (category === 'add-new') {
                    if (!newCategory) { showToast('لطفا نام دسته جدید را وارد کنید.'); return; }
                    category = newCategory;
                    // CHANGE: Add new category as an object
                    if (type === 'expense' && !state.expenseCategories.some(c => c.name === newCategory)) {
                        state.expenseCategories.push({ name: newCategory, icon: 'fa-tag' });
                    }
                    else if (type === 'income' && !state.incomeSources.some(c => c.name === newCategory)) {
                        state.incomeSources.push({ name: newCategory, icon: 'fa-tag' });
                    }
                }

                const transactionData = {
                    type: type,
                    accountId: qs('#account-select', form).value,
                    description: qs('#description', form).value.trim(),
                    amount: parseInt(getUnformattedAmount(qs('#amount', form).value || '0')),
                    date: moment(normalizeDigits(qs('#transaction-date', form).value), JALALI_DISPLAY_FORMAT).format(MOMENT_FORMAT),
                    category: ['income', 'expense'].includes(type) ? category : null,
                    dueDate: qs('#due-date-group', form).style.display !== 'none' && qs('#due-date', form).value ? moment(normalizeDigits(qs('#due-date', form).value), JALALI_DISPLAY_FORMAT).format(MOMENT_FORMAT) : null,
                    status: qs('#status-group', form).style.display !== 'none' ? qs('#status-select', form).value : null,
                    loanId: type === 'installmentPayment' ? qs('#loan-select', form).value : null,
                };
                if (!transactionData.amount || !transactionData.date || !transactionData.accountId || !moment(transactionData.date, MOMENT_FORMAT).isValid()) { showToast('لطفا مبلغ، تاریخ و حساب را به درستی وارد کنید.'); return; }

                if (id) { const index = state.transactions.findIndex(tx => tx.id == id); state.transactions[index] = { ...state.transactions[index], ...transactionData }; showToast('تراکنش ویرایش شد.'); }
                else { state.transactions.push({ id: Date.now(), ...transactionData }); showToast('تراکنش ثبت شد.'); }
                saveData(); updateAllUI(); closeModal('#transaction-modal-overlay');
            }
            function handleAccountSubmit(form) {
                const id = qs('#account-id', form).value;
                const name = qs('#account-name', form).value.trim();
                if (!name) { showToast('نام حساب الزامی است.'); return; }
                const accountData = { name: name, cardNumber: qs('#card-number', form).value.trim(), expMonth: qs('#exp-month', form).value.trim(), expYear: qs('#exp-year', form).value.trim(), cvv2: qs('#cvv2', form).value.trim(), accountNumber: qs('#account-number', form).value.trim(), shabaNumber: qs('#shaba-number', form).value.trim(), notes: qs('#notes', form).value.trim(), };
                if (id) { const index = state.accounts.findIndex(a => a.id == id); state.accounts[index] = { ...state.accounts[index], ...accountData }; showToast('حساب ویرایش شد.'); }
                else { state.accounts.push({ id: Date.now(), ...accountData }); showToast('حساب جدید اضافه شد.'); }
                saveData(); updateAllUI(); closeModal('#account-modal-overlay');
            }
            function handleLoanSubmit(form) {
                const id = qs('#loan-id', form).value;
                const loanData = { bankName: qs('#bank-name', form).value.trim(), description: qs('#loan-description', form).value.trim(), totalInstallments: parseInt(normalizeDigits(qs('#total-installments', form).value)), installmentAmount: parseInt(getUnformattedAmount(qs('#installment-amount', form).value)), };
                if (!loanData.bankName || !loanData.totalInstallments || !loanData.installmentAmount) { showToast('لطفا تمام فیلدها را پر کنید.'); return; }
                if (id) {
                    const index = state.loans.findIndex(l => l.id == id);
                    if (index > -1) { state.loans[index] = { ...state.loans[index], ...loanData }; showToast('تسهیلات ویرایش شد.'); }
                } else {
                    state.loans.push({ id: Date.now(), ...loanData });
                    showToast('تسهیلات جدید تعریف شد.');
                }
                saveData(); updateAllUI(); closeModal('#loan-modal-overlay');
            }
            function handleGoalSubmit(form) {
                const id = qs('#goal-id', form).value;
                const goalData = { name: qs('#goal-name', form).value.trim(), targetAmount: parseInt(getUnformattedAmount(qs('#target-amount', form).value)), savedAmount: parseInt(getUnformattedAmount(qs('#saved-amount', form).value || '0')), };
                if (!goalData.name || !goalData.targetAmount) { showToast('لطفا عنوان و مبلغ هدف را مشخص کنید.'); return; }
                if (id) { const index = state.savingsGoals.findIndex(g => g.id == id); state.savingsGoals[index] = { ...state.savingsGoals[index], ...goalData }; showToast('هدف ویرایش شد.'); }
                else { state.savingsGoals.push({ id: Date.now(), ...goalData }); showToast('هدف جدید اضافه شد.'); }
                saveData(); updateAllUI(); closeModal('#goal-modal-overlay');
            }
            // CHANGE: Updated to handle object-based category with icon
            function handleExpenseCategorySubmit(form) {
                const originalName = qs('#original-category-name', form).value;
                const newName = qs('#category-name-input', form).value.trim();
                const newIcon = qs('#selected-category-icon', form).value;

                if (!newName) { showToast('نام دسته‌بندی نمی‌تواند خالی باشد.'); return; }

                const isEditing = originalName !== '';
                const categoryExists = state.expenseCategories.some(c => c.name === newName);

                if (isEditing) {
                    if (newName !== originalName && categoryExists) {
                        showToast('این نام دسته‌بندی از قبل وجود دارد.'); return;
                    }
                    const index = state.expenseCategories.findIndex(c => c.name === originalName);
                    if (index > -1) {
                        state.expenseCategories[index].name = newName;
                        state.expenseCategories[index].icon = newIcon;
                    }
                    if (newName !== originalName) {
                        state.transactions.forEach(tx => {
                            if (tx.category === originalName) { tx.category = newName; }
                        });
                    }
                    showToast('دسته‌بندی با موفقیت ویرایش شد.');
                } else {
                    if (categoryExists) { showToast('این نام دسته‌بندی از قبل وجود دارد.'); return; }
                    state.expenseCategories.push({ name: newName, icon: newIcon });
                    showToast('دسته‌بندی جدید اضافه شد.');
                }

                saveData();
                renderExpenseReportsPage();
                closeModal('#expense-category-modal-overlay');
            }
            function handleDelete() {
                if (itemToDelete.type === 'transaction') { state.transactions = state.transactions.filter(i => i.id !== itemToDelete.id); }
                else if (itemToDelete.type === 'loan') { state.loans = state.loans.filter(i => i.id !== itemToDelete.id); state.transactions = state.transactions.filter(t => t.loanId != itemToDelete.id); }
                else if (itemToDelete.type === 'goal') { state.savingsGoals = state.savingsGoals.filter(i => i.id !== itemToDelete.id); }
                else if (itemToDelete.type === 'account') { if (state.transactions.some(t => t.accountId == itemToDelete.id)) { showToast('امکان حذف حساب دارای تراکنش وجود ندارد.'); closeModal('#confirm-modal-overlay'); return; } state.accounts = state.accounts.filter(i => i.id !== itemToDelete.id); }
                else if (itemToDelete.type === 'expense-category') {
                    // CHANGE: Delete based on object name
                    state.expenseCategories = state.expenseCategories.filter(cat => cat.name !== itemToDelete.id);
                    state.transactions.forEach(tx => {
                        if (tx.category === itemToDelete.id) { tx.category = null; }
                    });
                }
                showToast('مورد با موفقیت حذف شد.');
                saveData(); updateAllUI(); closeModal('#confirm-modal-overlay');
            }
            const handleBackup = () => {
                try {
                    const dataStr = JSON.stringify(state);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.href = url; a.download = 'shomar_backup.json'; a.click(); URL.revokeObjectURL(url);
                    showToast('فایل پشتیبان با موفقیت ایجاد شد.');
                    closeModal('#settings-modal-overlay');
                } catch (e) { showToast('خطا در ایجاد فایل پشتیبان.'); }
            };
            const handleRestore = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const restoredState = JSON.parse(e.target.result);
                        if (restoredState && typeof restoredState === 'object' && Array.isArray(restoredState.transactions)) {
                            state = { ...state, ...restoredState };
                            saveData();
                            updateAllUI();
                            closeModal('#settings-modal-overlay');
                            showToast('اطلاعات با موفقیت بازگردانی شد.');
                        } else { throw new Error('Invalid backup file format.'); }
                    } catch (err) { showToast('خطا در بازگردانی فایل. فایل معتبر نیست.'); }
                    finally { event.target.value = ''; }
                };
                reader.readAsText(file);
            };
            const exportTransactionsToCSV = () => {
                const filters = state.filters.transactions;
                const filteredTxs = state.transactions.filter(tx => {
                    const txDate = moment(tx.date, MOMENT_FORMAT);
                    if (filters.from && txDate.isBefore(moment(filters.from, MOMENT_FORMAT), 'day')) return false;
                    if (filters.to && txDate.isAfter(moment(filters.to, MOMENT_FORMAT), 'day')) return false;
                    if (filters.accountId !== 'all' && tx.accountId != filters.accountId) return false;
                    if (filters.type !== 'all' && tx.type !== filters.type) return false;
                    if (filters.category !== 'all' && tx.category !== filters.category) return false;
                    if (filters.searchTerm && !(tx.description || '').toLowerCase().includes(filters.searchTerm)) return false;
                    return true;
                });
                if (filteredTxs.length === 0) { showToast('هیچ تراکنشی (با فیلترهای فعلی) برای خروجی گرفتن وجود ندارد.'); return; }
                const escapeCsvField = (field) => { const str = String(field ?? ''); if (str.includes(',') || str.includes('"') || str.includes('\n')) { return `"${str.replace(/"/g, '""')}"`; } return str; };
                const headers = ['تاریخ', 'نوع', 'توضیحات', 'مبلغ', 'حساب', 'دسته/منبع', 'وضعیت', 'تاریخ سررسید'];
                const rows = filteredTxs.map(tx => {
                    const account = state.accounts.find(a => a.id == tx.accountId);
                    const statusText = (STATUS_TYPES[tx.type] || {})[tx.status] || '';
                    return [tx.date ? moment(tx.date, MOMENT_FORMAT).format(JALALI_DISPLAY_FORMAT) : '', TRANSACTION_TYPES[tx.type] || tx.type, tx.description, tx.amount, account ? account.name : 'نامشخص', tx.category || '', statusText, tx.dueDate ? moment(tx.dueDate, MOMENT_FORMAT).format(JALALI_DISPLAY_FORMAT) : ''].map(escapeCsvField).join(',');
                });
                const csvContent = '\uFEFF' + [headers.join(','), ...rows].join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `transactions_${moment().format('jYYYY-jMM-jDD')}.csv`; a.click(); URL.revokeObjectURL(url);
            };
            const updateThemeIcon = () => {
                qs('#theme-toggle').className = `fas ${document.body.classList.contains('dark-mode') ? 'fa-moon' : 'fa-sun'}`;
            };
            const initDatepickers = (parent = document) => {
                if (!parent) return;
                try {
                    $(parent).find(".pdate").each(function () {
                        if ($(this).hasClass('pwt-datepicker-input-element')) { $(this).pDatepicker('destroy'); }
                    });
                    $(parent).find(".pdate").pDatepicker({ format: 'YYYY/MM/DD', calendarType: 'persian', autoClose: true, observer: true, initialValue: false, persianDigit: true, calendar: { persian: { locale: 'fa' } }, toolbox: { calendarSwitch: { enabled: false } } });
                } catch (e) { console.error("Datepicker init failed", e); }
            };

            const init = () => {
                loadData();
                setupEventListeners();
                setTimeout(() => {
                    const initialTitle = qs('.nav-btn.active')?.dataset?.title || "حسابداری شخصی شمار";
                    switchPage('dashboard-page', initialTitle);
                }, 50);
            };

            init();
        });
        document.addEventListener("DOMContentLoaded", function () {
            setTimeout(function () {
                var dashBtn = document.querySelector('.nav-btn[data-page="dashboard-page"]');
                if (dashBtn) {
                    dashBtn.click();
                }
            }, 600);
        });

    </script>
</body>

</html>


