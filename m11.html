<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>ماهینا | Mahina </title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#D98BAA">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ماهینا">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/WbCF8vNk/luna-app.png">
    <link rel="icon" type="image/png" href="https://i.postimg.cc/WbCF8vNk/luna-app.png">
    <link href="https://cdn.jsdelivr.net/npm/vazirmatn@33.0.3/Vazirmatn-font-face.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --font-family: 'Vazirmatn', sans-serif; --ease-out-quart: cubic-bezier(0.25, 1, 0.5, 1);
            --bg-main-light: #FEFBFB; --card-bg-light: #ffffff; --text-main-light: #332C33; --text-subtle-light: #7E787E; --border-color-light: #F3EAEB; --shadow-light: 0 10px 30px rgba(180,150,160,0.1); --selector-highlight-light: rgba(217, 139, 170, 0.1);
            --bg-main-dark: #2A2428; --card-bg-dark: #3D3539; --text-main-dark: #F5F1F2; --text-subtle-dark: #A8A1A4; --border-color-dark: #524A4E; --shadow-dark: 0 10px 30px rgba(0,0,0,0.2); --selector-highlight-dark: rgba(217, 139, 170, 0.15);
            --c-menstrual: #EAA2A2; --c-follicular: #F8C8A8; --c-ovulation: #C5B0E0; --c-luteal: #F3B396; --c-pms: #B4A0C2; --c-theme-main: #D98BAA;
            --phase-theme-color: var(--c-theme-main);
        }
        html { --bg-main: var(--bg-main-light); --card-bg: var(--card-bg-light); --text-main: var(--text-main-light); --text-subtle: var(--text-subtle-light); --border-color: var(--border-color-light); --shadow: var(--shadow-light); --selector-highlight-bg: var(--selector-highlight-light); background-color: var(--bg-main); color: var(--text-main); transition: background-color 0.4s, color 0.4s; scroll-behavior: smooth; }
        html.dark-mode { --bg-main: var(--bg-main-dark); --card-bg: var(--card-bg-dark); --text-main: var(--text-main-dark); --text-subtle: var(--text-subtle-dark); --border-color: var(--border-color-dark); --shadow: var(--shadow-dark); --selector-highlight-bg: var(--selector-highlight-dark); }
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: var(--font-family); margin: 0; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        
        /* --- Page & App Containers --- */
        .app-container, .page-view { max-width: 480px; margin: 0 auto; padding: 15px; min-height: 100vh; }
        .page-view { display: none; } /* Pages are hidden by default */

        /* --- Common Elements --- */
        .app-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 10px; }
        .app-title { font-size: 1.8rem; font-weight: 800; color: var(--phase-theme-color); transition: color 0.5s var(--ease-out-quart); }
        .header-actions { display: flex; align-items: center; gap: 20px; }
        .settings-btn { background: none; border: none; font-size: 1.5rem; color: var(--phase-theme-color); cursor: pointer; opacity: 0.8; transition: opacity 0.2s, color 0.5s var(--ease-out-quart); }
        .settings-btn:hover { opacity: 1; }
        .card-base { background: var(--card-bg); padding: 25px; border-radius: 24px; box-shadow: var(--shadow); transition: background-color 0.4s, box-shadow 0.4s; }
        .main-btn { width: 100%; padding: 18px; font-size: 1.1rem; font-weight: 700; color: white; border: none; border-radius: 16px; cursor: pointer; transition: all 0.2s ease; font-family: var(--font-family); }
        .input-group { margin-bottom: 25px; text-align: right; }
        .input-group label { font-size: 1rem; font-weight: 500; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .input-field { width: 100%; padding: 16px; font-size: 1rem; border-radius: 14px; font-family: var(--font-family); background: var(--bg-main); border: 1px solid var(--border-color); color: var(--text-main); transition: all 0.4s; }
        .input-field[readonly] { cursor: pointer; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Launch Screen --- */
        #launch-screen { position: fixed; inset: 0; z-index: 10000; background-color: #FEFBFB; display: flex; align-items: center; justify-content: center; transition: opacity 0.5s ease-out, visibility 0.5s; visibility: visible; opacity: 1; }
        #launch-screen.hidden { opacity: 0; visibility: hidden; }
        .launch-content { text-align: center; }
        .launch-logo { width: 100px; height: 100px; border-radius: 22px; }
        .launch-title { color: #B4A0C2; font-weight: 500; font-size: 1rem; margin-top: 15px; }
        .loader { position: absolute; bottom: 50px; left: 50%; width: 40px; height: 40px; border: 3px solid #F3EAEB; border-bottom-color: #D98BAA; border-radius: 50%; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: translateX(-50%) rotate(0deg); } 100% { transform: translateX(-50%) rotate(360deg); } }
        html.dark-mode #launch-screen { background-color: #2A2428; }
        html.dark-mode .launch-title { color: #A8A1A4; }
        html.dark-mode .loader { border: 3px solid #524A4E; border-bottom-color: #D98BAA; }

        /* --- Theme Switch --- */
        .theme-switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .theme-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: var(--border-color); transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked+.slider { background-color: var(--c-ovulation); }
        input:checked+.slider:before { transform: translateX(22px); }

        /* --- Setup View --- */
        .setup-view { padding: 20px; text-align: center; animation: fadeIn 0.5s; }
        .setup-view h1 { font-size: 1.8rem; margin-bottom: 15px; color: var(--c-theme-main); }
        .setup-view p { font-size: 1.1rem; color: var(--text-subtle); margin-bottom: 40px; }
        .about-logo { width: 80px; height: 80px; border-radius: 20px; margin-bottom: 15px; box-shadow: var(--shadow); }
        #startTrackingBtn { background: linear-gradient(135deg, var(--c-theme-main), #EAA2A2); }

        /* --- Tracker View --- */
        .tracker-view { display: flex; flex-direction: column; gap: 20px; animation: fadeIn 0.5s; }
        .special-banner, .period-alert-card { padding: 15px 20px; border-radius: 18px; font-weight: 600; animation: fadeIn 0.5s; display: flex; align-items: center; gap: 12px; color: white; }
        .special-banner.ovulation { background-color: var(--c-ovulation); }
        .special-banner.pms { background-color: var(--c-pms); }
        .period-alert-card { background-color: var(--c-menstrual); }
        .progress-card { display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .progress-display { position: relative; width: 220px; height: 220px; }
        .progress-svg { transform: rotate(-90deg); }
        .progress-circle { transition: stroke 0.5s var(--ease-out-quart), stroke-dashoffset 0.8s var(--ease-out-quart); }
        .progress-text { position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .day-number { font-size: 4.5rem; font-weight: 800; line-height: 1; }
        .day-label { font-size: 1.1rem; font-weight: 500; color: var(--text-subtle); }
        .phase-info { display: flex; flex-direction: column; align-items: center; gap: 8px; }
        #phaseIcon { font-size: 1.8rem; transition: color 0.5s var(--ease-out-quart); }
        .phase-title { font-size: 1.4rem; font-weight: 600; }
        .day-navigation { width: 100%; display: flex; flex-direction: column; align-items: center; gap: 15px; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); }
        .day-nav-buttons { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .center-nav-group { display: flex; align-items: center; gap: 10px; }
        .nav-btn { background: none; border: none; font-size: 1.5rem; color: var(--text-subtle); cursor: pointer; padding: 10px; }
        .displayed-date { font-weight: 500; color: var(--text-subtle); font-size: 0.9rem; }
        .secondary-nav-btn { font-size: 0.9rem; font-weight: 600; border-radius: 12px; padding: 8px 16px; cursor: pointer; transition: all 0.2s ease; background-color: var(--bg-main); border: 1px solid var(--border-color); color: var(--text-subtle); font-family: var(--font-family); }
        .secondary-nav-btn:hover { transform: scale(1.05); color: var(--text-main); border-color: var(--text-subtle); }
        #logPeriodBtn { background-color: var(--c-menstrual); color: white; border-color: var(--c-menstrual); }
        #logPeriodBtn:hover { background-color: #d18a8a; color: white; border-color: #d18a8a; }
        .details-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .detail-card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 15px; }
        .detail-card-icon { font-size: 1rem; width: 32px; height: 32px; border-radius: 8px; display: grid; place-items: center; color: var(--phase-theme-color); background-color: var(--bg-main); border: 1px solid var(--border-color); transition: color 0.5s, background-color 0.4s, border-color 0.4s; }
        .detail-card-title { font-size: 1.1rem; font-weight: 600; margin: 0; color: var(--phase-theme-color); transition: color 0.5s var(--ease-out-quart); }
        .detail-card-content p { margin: 0; color: var(--text-subtle); line-height: 1.7; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px 20px; }
        .stat-item .progress-bar-container { width: 100%; height: 8px; background-color: var(--border-color); border-radius: 4px; overflow: hidden; margin-top: 8px; }
        .stat-item .progress-bar { height: 100%; background: var(--text-subtle); border-radius: 4px; transition: width 0.5s ease-out; }
        .stat-item .stat-label { display: flex; justify-content: space-between; align-items: center; font-weight: 500; font-size: 0.9rem; }
        
        /* --- Modals & Overlays --- */
        .settings-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); opacity: 0; visibility: hidden; transition: opacity 0.3s ease; z-index: 999; }
        .settings-overlay.active { opacity: 1; visibility: visible; }
        .settings-panel { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-main); padding: 20px; border-radius: 28px 28px 0 0; box-shadow: 0 -10px 40px rgba(0,0,0,0.15); transform: translateY(100%); transition: transform 0.4s var(--ease-out-quart), background-color 0.4s; z-index: 1000; text-align: center; }
        .settings-panel.active { transform: translateY(0); }
        .settings-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        #cancelSettingsBtn { background-color: var(--border-color); color: var(--text-main); }
        #closeAboutBtn { background-color: var(--phase-theme-color); transition: background-color 0.5s var(--ease-out-quart); }
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity .3s, visibility .3s; z-index: 1001; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--card-bg); color: var(--text-main); border: 1px solid var(--border-color); max-width: 480px; text-align: center; transition: all .3s ease-out; }
        #datePickerModal .modal-content, #cycleLengthPickerModal .modal-content { border-radius: 16px 16px 0 0; width: 100%; box-shadow: 0 -5px 25px rgba(0, 0, 0, 0.1); transform: translateY(100%); align-self: flex-end; }
        .modal-overlay.visible #datePickerModal .modal-content, .modal-overlay.visible #cycleLengthPickerModal .modal-content { transform: translateY(0); }
        .modal-header { padding: 12px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        #warningModal .modal-content, #confirmPeriodModal .modal-content { border-radius: 24px; width: 90%; transform: translateY(20px) scale(0.95); opacity: 0; }
        .modal-overlay.visible #warningModal .modal-content, .modal-overlay.visible #confirmPeriodModal .modal-content { transform: translateY(0) scale(1); opacity: 1; }
        #warningModal .modal-header, #confirmPeriodModal .modal-header { justify-content: center; border-bottom: none; padding-top: 20px; }
        #confirmPeriodModal #confirmNewPeriodBtn { background-color: var(--c-menstrual); }
        #confirmPeriodModal #cancelNewPeriodBtn { background-color: var(--border-color); color: var(--text-main); }
        
        /* --- NEW & IMPROVED DATE PICKER STYLES --- */
        .selectors-container { display: flex; justify-content: center; gap: 0; padding: 20px; direction: ltr; }
        .selector-column { flex: 1; height: 220px; overflow: hidden; position: relative; }
        .selector-list { position: absolute; width: 100%; list-style: none; padding: 0; margin: 0; text-align: center; }
        .selector-item { font-size: 1.25rem; line-height: 44px; height: 44px; color: var(--text-subtle); user-select: none; transition: color .3s, font-weight .3s; }
        .selector-item.selected { color: var(--text-main); font-weight: 600; }
        .selector-highlight { position: absolute; top: 50%; left: 10px; right: 10px; height: 44px; transform: translateY(-50%); background-color: var(--selector-highlight-bg); border-radius: 8px; pointer-events: none; }

        .btn { background: none; border: none; padding: 12px 20px; cursor: pointer; font-family: var(--font-family); font-size: 1rem; font-weight: 500; border-radius: 8px; }
        .btn-confirm { color: var(--c-theme-main); font-weight: 600; }
        .btn-close { color: var(--text-subtle); }

        /* --- History Page --- */
        #historyListContainer { padding-top: 10px; }
        .history-item { display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); margin-bottom: 15px; padding: 15px 20px; border-radius: 18px; box-shadow: var(--shadow); animation: fadeIn 0.4s; }
        .item-info { display: flex; flex-direction: column; align-items: flex-start; gap: 5px; }
        .item-date { font-weight: 600; font-size: 1.1rem; color: var(--text-main); }
        .item-duration { color: var(--text-subtle); font-size: 0.9rem; }
        .item-actions button { background: none; border: none; color: var(--text-subtle); cursor: pointer; font-size: 1rem; padding: 5px 8px; }
        .item-actions button:hover { color: var(--text-main); }
        .history-placeholder { text-align: center; color: var(--text-subtle); padding: 50px 20px; }
    </style>
</head>
<body>
    <div id="launch-screen">
        <div class="launch-content">
            <img src="https://i.postimg.cc/WbCF8vNk/luna-app.png" alt="لوگوی ماهینا" class="launch-logo">
            <p class="launch-title">مدیریت سلامت زنان ماهینا</p>
        </div>
        <span class="loader"></span>
    </div>

    <div class="app-container" id="appContainer">
        <header class="app-header">
            <h1 class="app-title">ماهینا</h1>
            <div class="header-actions">
                <button class="settings-btn" id="aboutBtn" title="درباره"><i class="fa-solid fa-circle-info"></i></button>
                <label class="theme-switch"><input type="checkbox" id="themeToggle"><span class="slider"></span></label>
                <button class="settings-btn" id="openSettingsBtn" title="تنظیمات"><i class="fa-solid fa-gear"></i></button>
            </div>
        </header>

        <main id="mainContent">
            </main>
    </div>

    <div class="page-view" id="historyView">
        <header class="app-header">
            <div class="header-actions">
                <button class="settings-btn" id="addHistoryEntryBtn" title="افزودن چرخه"><i class="fa-solid fa-plus"></i></button>
            </div>
            <h1 class="app-title" style="color: var(--text-main);">تاریخچه</h1>
            <div class="header-actions">
                <button class="settings-btn" id="backToTrackerBtn" title="بازگشت"><i class="fa-solid fa-chevron-left"></i></button>
            </div>
        </header>
        <main id="historyListContainer">
            </main>
    </div>

    <div class="settings-overlay" id="settingsOverlay"></div>
    <div class="settings-panel" id="settingsPanel">
        <h2>تنظیمات</h2>
        <div class="input-group"><label for="settingsPeriodDate"><i class="fa-solid fa-calendar-day"></i> تاریخ شروع آخرین پریود</label><input type="text" id="settingsPeriodDate" class="input-field" readonly/></div>
        <div class="input-group"><label for="settingsCycleLength"><i class="fa-solid fa-arrows-rotate"></i> طول معمول چرخه</label><input type="text" id="settingsCycleLength" class="input-field" readonly /></div>
        <div class="settings-buttons" style="grid-template-columns: 1fr; margin: 0 0 15px 0;">
            <button id="viewHistoryBtn" class="main-btn" style="background-color: var(--text-subtle);">تاریخچه چرخه‌ها</button>
        </div>
        <div class="settings-buttons"><button id="cancelSettingsBtn" class="main-btn">انصراف</button><button id="saveSettingsBtn" class="main-btn">ذخیره</button></div>
    </div>

    <div class="settings-overlay" id="aboutOverlay"></div>
    <div class="settings-panel" id="aboutPanel">
        <img src="https://i.postimg.cc/WbCF8vNk/luna-app.png" alt="لوگوی ماهینا" class="about-logo">
        <h2>درباره ماهینا</h2>
        <div style="text-align: right; line-height: 1.8; padding: 0 15px; color: var(--text-subtle);">
            <p>اپلیکیشن **ماهینا**، همراه هوشمند شما برای درک و پیگیری چرخه قاعدگی است.</p>
            <p style="color: var(--text-main);"><strong>ویژگی‌ها:</strong></p>
            <ul style="padding-right: 35px; margin-top: -10px;">
                <li>نمایش روز و فاز فعلی چرخه</li>
                <li>توضیحات روزانه درباره وضعیت جسمی و روحی</li>
                <li>نمودارهای انرژی، میل جنسی و باروری</li>
                <li>پشتیبانی از حالت تاریک و روشن</li>
            </ul>
            <p style="color: var(--text-main);"><strong>توسعه: پیمان عابدین پور © 1404</strong></p>
        </div>
        <div class="settings-buttons" style="grid-template-columns: 1fr;"><button id="closeAboutBtn" class="main-btn">بستن</button></div>
    </div>

    <div id="datePickerModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><button class="btn btn-close" id="closeDateModal">انصراف</button><button class="btn btn-confirm" id="confirmDate">تایید</button></div>
            <div class="selectors-container"><div id="pdp-year" class="selector-column"></div><div id="pdp-month" class="selector-column"></div><div id="pdp-day" class="selector-column"></div></div>
        </div>
    </div>
    
    <div id="cycleLengthPickerModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><button class="btn btn-close" id="closeCycleModal">انصراف</button><button class="btn btn-confirm" id="confirmCycle">تایید</button></div>
            <div class="selectors-container"><div id="cycle-length-column" class="selector-column"></div></div>
        </div>
    </div>

    <div id="warningModal" class="modal-overlay">
        <div class="modal-content"><div class="modal-header"><h3>توجه</h3></div><p>شما در روز اول چرخه قرار دارید و نمی‌توانید به عقب‌تر بروید.</p><div style="padding: 0 20px 20px;"><button class="main-btn" id="closeWarningModalBtn">متوجه شدم</button></div></div>
    </div>

    <div id="confirmPeriodModal" class="modal-overlay">
        <div class="modal-content"><div class="modal-header"><h3>شروع چرخه جدید</h3></div><p style="padding: 15px 20px;">آیا مطمئن هستید که می‌خواهید یک چرخه جدید را از تاریخ <b id="confirmPeriodDateText"></b> شروع کنید؟</p><div class="settings-buttons" style="padding: 0 20px 20px;"><button class="main-btn" id="cancelNewPeriodBtn">انصراف</button><button class="main-btn" id="confirmNewPeriodBtn">تایید</button></div></div>
    </div>

    <div class="settings-overlay" id="editHistoryModalOverlay">
         <div class="settings-panel" id="editHistoryPanel">
            <h2 id="editHistoryTitle">افزودن چرخه</h2>
            <input type="hidden" id="editHistoryIndex">
            <div class="input-group"><label for="historyPeriodDate"><i class="fa-solid fa-calendar-day"></i> تاریخ شروع پریود</label><input type="text" id="historyPeriodDate" class="input-field" readonly placeholder="انتخاب تاریخ"/></div>
            <div class="input-group"><label for="historyCycleLength"><i class="fa-solid fa-arrows-rotate"></i> طول چرخه (روز)</label><input type="number" id="historyCycleLength" class="input-field" style="direction: ltr; text-align:right;" placeholder="مثلا ۲۸" /></div>
            <div class="settings-buttons"><button id="cancelHistoryEditBtn" class="main-btn">انصراف</button><button id="saveHistoryEditBtn" class="main-btn">ذخیره</button></div>
         </div>
    </div>

    <script>
    // --- TEMPLATES ---
    const setupViewHTML = `
        <div id="setupView" class="setup-view card-base">
            <img src="https://i.postimg.cc/WbCF8vNk/luna-app.png" alt="لوگوی ماهینا" class="about-logo">
            <h1>به ماهینا خوش آمدید!</h1>
            <p>برای شروع، تاریخ آخرین پریود و طول معمول دوره خود را وارد کنید.</p>
            <div class="input-group">
                <label for="lastPeriodDate"><i class="fa-solid fa-calendar-day"></i> تاریخ شروع آخرین پریود</label>
                <input type="text" id="lastPeriodDate" class="input-field" placeholder="انتخاب تاریخ" readonly/>
            </div>
            <div class="input-group">
                <label for="cycleLength"><i class="fa-solid fa-arrows-rotate"></i> طول معمول چرخه</label>
                <input type="text" id="cycleLength" class="input-field" value="۲۸ روز" readonly />
            </div>
            <button id="startTrackingBtn" class="main-btn">شروع ردیابی</button>
        </div>`;
    
    const trackerViewHTML = `
        <div id="trackerView" class="tracker-view">
            <div id="periodAlertCard" class="period-alert-card" style="display:none;"></div>
            <div id="specialDayBanner" class="special-banner" style="display:none;"></div>
            <div class="progress-card card-base">
                <div class="progress-display">
                    <svg class="progress-svg" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="45" fill="none" stroke="var(--border-color)" stroke-width="8"></circle>
                        <circle id="progress-circle-fg" class="progress-circle" cx="50" cy="50" r="45" fill="none" stroke="var(--c-follicular)" stroke-width="8" stroke-linecap="round"></circle>
                    </svg>
                    <div class="progress-text"><span id="progressDayNumber" class="day-number"></span><span class="day-label">روز از چرخه</span></div>
                </div>
                <div class="phase-info"><i id="phaseIcon" class="fa-solid fa-leaf"></i><h2 id="cyclePhaseTitle" class="phase-title"></h2></div>
                <div class="day-navigation">
                    <div class="day-nav-buttons">
                        <button class="nav-btn" id="nextDayBtn" title="روز بعد"><i class="fa-solid fa-chevron-right"></i></button>
                        <div class="center-nav-group">
                            <button id="startOfCycleBtn" class="secondary-nav-btn">ابتدای چرخه</button>
                            <button id="todayBtn" class="secondary-nav-btn">امروز</button>
                            <button id="logPeriodBtn" class="secondary-nav-btn">من پریود شدم</button>
                        </div>
                        <button class="nav-btn" id="prevDayBtn" title="روز قبل"><i class="fa-solid fa-chevron-left"></i></button>
                    </div>
                    <div id="displayedJalaliDate" class="displayed-date"></div>
                </div>
            </div>
            <div id="detailsGrid" class="details-grid"></div>
        </div>`;

    const launchScreen = document.getElementById('launch-screen');
    window.onload = () => {
        setTimeout(() => launchScreen.classList.add('hidden'), 500);
    };

    document.addEventListener('DOMContentLoaded', () => {
        const cycleData=[{},{day:1,phase:"قاعدگی",icon:"fa-droplet",color:"var(--c-menstrual)",description:"سلام به روز اول و شروع یک چرخه جدید! امروز بدن با ریزش دیواره رحم، خانه‌تکانی می‌کند و خودش را برای یک ماه جدید و سالم پاکسازی می‌کند. به این تولد دوباره خوشامد بگو.",bleeding:10,hormones:"استروژن (هورمون انرژی و شادی) و پروژسترون (هورمون آرامش و مادرانگی) هر دو در پایین‌ترین سطح خود هستند. انگار به یک تعطیلات حسابی رفته‌اند!",mood:"ممکن است حس کنی دلت می‌خواهد در غار تنهایی خودت باشی و حوصله کمتری داشته باشی. این فرصتی برای بازنگری و استراحت است، به این حس احترام بگذار.",energy:2,libido:2,partner:"حمایت، صبوری و درک متقابل در این روز کلیدی است. یک کیسه آب گرم، یک فنجان چای، و یک آغوش آرام بهترین هدیه است. از او بپرس چه چیزی آرامش می‌کند.",pregnancy:0},{day:2,phase:"قاعدگی",icon:"fa-droplet",color:"var(--c-menstrual)",description:"خونریزی ادامه دارد و بدن همچنان در فاز استراحت و بازیابی است. اگر احساس خستگی می‌کنی طبیعی است، پس به خودت سخت نگیر و به بدنت گوش کن.",bleeding:8,hormones:"هورمون‌ها همچنان در سطح پایینی قرار دارند و بدن در حال بازیابی انرژی برای روزهای پربار آینده است. صبور باش.",mood:"خلق پایین و تحریک‌پذیری ممکن است ادامه داشته باشد. اگر حساسی و زود از کوره در می‌روی، این بخشی از روند طبیعی بدنت است و تقصیر تو نیست.",energy:3,libido:2,partner:"همچنان حمایت و صبوری بهترین کاری است که می‌توانی انجام دهی. حضور آرام تو و کمک در کارهای روزمره، بزرگترین محبت است.",pregnancy:0},{day:3,phase:"قاعدگی",icon:"fa-droplet",color:"var(--c-menstrual)",description:"خبر خوب! خونریزی در حال سبک شدن است و انرژی‌ات کم‌کم رو به افزایش می‌رود. این آخرین روزهای فصل زمستان بدن توست و بهار در راه است.",bleeding:5,hormones:"استروژن (هورمون انرژی) موتورش را روشن کرده و آماده بازگشت است، هرچند هنوز سطحش پایین است، اما نویدبخش روزهای بهتر است.",mood:"احتمالاً خلق و خویت بهبود پیدا می‌کند، اما ممکن است همچنان کمی حساس باشی. کم‌کم داری از پیله خود بیرون می‌آیی و دنیا رنگی‌تر می‌شود.",energy:4,libido:3,partner:"حمایت و درک تو همچنان مؤثر است. یک تعریف کوچک یا یک «دوستت دارم» ساده می‌تواند روز او را بسازد و به او انرژی بدهد.",pregnancy:0},{day:4,phase:"قاعدگی",icon:"fa-droplet",color:"var(--c-menstrual)",description:"خونریزی تقریباً تمام شده و به صورت لکه‌بینی خیلی کم درآمده. فصل بهار بدن کم‌کم در حال آغاز شدن است و تو احساس سبکی و تازگی می‌کنی.",bleeding:2,hormones:"افزایش تدریجی استروژن حال تو را بهتر می‌کند و به آرامی به تو انرژی می‌دهد. مثل طلوع خورشید بعد از یک شب طولانی است.",mood:"خلق و انگیزه‌ات بهتر می‌شود. احساس می‌کنی دنیا دوباره رنگی شده و آماده‌ای تا از خانه بیرون بزنی و با دیگران ارتباط برقرار کنی.",energy:5,libido:4,partner:"او را به یک فعالیت سبک و تجربه مشترک، مثل قدم زدن در پارک یا دیدن یک فیلم کمدی، تشویق کن.",pregnancy:1},{day:5,phase:"فولیکولی",icon:"fa-leaf",color:"var(--c-follicular)",description:"بهار رسماً شروع شد! خونریزی تمام شده و بدنت با جدیت در حال پرورش فولیکول‌ها (کیسه‌های کوچکی که تخمک در آنها رشد می‌کند) در تخمدان است.",bleeding:0,hormones:"افزایش تدریجی استروژن (هورمون خوش‌بینی و انرژی) به تو حس خوبی می‌دهد و تو را برای روزهای آینده آماده می‌کند. این هورمون مثل یک مربی مشوق عمل می‌کند.",mood:"خلق و انگیزه بهتر می‌شود. احساس سبکی و طراوت می‌کنی و برای شروع هفته‌ای نو، برنامه‌ریزی و هدف‌گذاری آماده‌ای.",energy:6,libido:5,partner:"بهترین زمان برای برنامه‌ریزی‌های مشترک و صحبت در مورد اهداف آینده است. از انرژی مثبت او برای پیشبرد کارهای دونفره استفاده کن.",pregnancy:1},{day:6,phase:"فولیکولی",icon:"fa-leaf",color:"var(--c-follicular)",description:"امروز افزایش انرژی و میل جنسی را به شکل محسوس‌تری حس می‌کنی. دنیا جای زیباتری به نظر می‌رسد و تو آماده‌ای تا از این زیبایی لذت ببری.",bleeding:0,hormones:"مهمانی استروژن در بدن تو هر روز شلوغ‌تر می‌شود و سطح انرژی‌ات را بالاتر می‌برد! این هورمون به تو احساس قدرت و جذابیت می‌دهد.",mood:"روحیه مثبت‌تر و انگیزه بالاتر. آماده‌ای تا کارهای جدید را امتحان کنی و از چالش‌ها نترسی. خوش‌بینی در تو موج می‌زند.",energy:6,libido:6,partner:"او را به تجربه‌های مشترک و فعالیت‌های دونفره تشویق کن. انرژی او برای این کارها زیاد است، پس با هم خاطره بسازید.",pregnancy:2},{day:7,phase:"فولیکولی",icon:"fa-leaf",color:"var(--c-follicular)",description:"سطح انرژی و میل جنسی‌ات بیشتر شده و احساس سرزندگی می‌کنی. این روند صعودی ادامه خواهد داشت! از این حس خوب نهایت استفاده را ببر.",bleeding:0,hormones:"استروژن رو به افزایش است و تو را هر روز اجتماعی‌تر و پرانرژی‌تر می‌کند. این هورمون مسئول درخشش پوست و موی تو نیز هست.",mood:"خلق خوب و انگیزه بیشتر. تمایل بیشتری به معاشرت با دوستان و عزیزان داری و از ارتباطات اجتماعی لذت می‌بری.",energy:7,libido:6,partner:"از انرژی خوب او برای ساختن خاطرات شاد و مشترک استفاده کن. یک پیک‌نیک یا یک شام دوستانه ایده خوبی است.",pregnancy:2},{day:8,phase:"فولیکولی",icon:"fa-leaf",color:"var(--c-follicular)",description:"انرژی بالا، روحیه مثبت و میل جنسی رو به رشد! روز خوبی برای انجام کارهای خلاقانه یا ارائه ایده‌های جدید در محل کار است.",bleeding:0,hormones:"استروژن بالا می‌رود و مغز تو را برای یادگیری، حل مسئله و تفکر خلاق تیزتر و آماده‌تر می‌کند.",mood:"خلق عالی و انگیزه زیاد. احساس می‌کنی هیچ کاری نیست که از پس آن برنیایی و اعتماد به نفست بالاست.",energy:7,libido:7,partner:"او را در اهداف و پروژه‌هایش تشویق کن. حمایت تو به او انگیزه مضاعف می‌دهد و باعث می‌شود بیشتر بدرخشد.",pregnancy:3},{day:9,phase:"فولیکولی",icon:"fa-leaf",color:"var(--c-follicular)",description:"به روزهای اوج انرژی نزدیک می‌شویم و بدن در حال آماده شدن برای تخمک‌گذاری است. احساس جذابیت و اعتماد به نفس بیشتری می‌کنی.",bleeding:0,hormones:"استروژن به سطح بالایی می‌رسد و تو را برای فاز بعدی و اوج باروری آماده می‌کند. بدنت به طور غریزی در حال آماده شدن است.",mood:"روحیه بسیار خوب و میل جنسی بیشتر. امروز روز درخشیدن توست! از این حس قدرت و جذابیت لذت ببر.",energy:8,libido:8,partner:"یک قرار شام دونفره یا رفتن به یک مهمانی می‌تواند بسیار لذت‌بخش باشد. او در این روزها از همیشه اجتماعی‌تر است.",pregnancy:4},{day:10,phase:"فولیکولی",icon:"fa-leaf",color:"var(--c-follicular)",description:"انرژی و میل جنسی بالا باقی می‌ماند. امروز احساس شکست‌ناپذیری می‌کنی و آماده‌ای تا هر چالشی را قبول کنی. از این قدرت استفاده کن.",bleeding:0,hormones:"استروژن زیاد است و تو را سرشار از حس خوب و انرژی نگه می‌دارد. این دوره، زمان طلایی خلاقیت و بهره‌وری توست.",mood:"روحیه عالی و انگیزه بالا. از بودن در جمع و ارتباط با دیگران لذت می‌بری و به راحتی می‌توانی دیگران را متقاعد کنی.",energy:8,libido:8,partner:"با هم یک فعالیت ورزشی یا سرگرمی جدید را امتحان کنید. هیجان مشترک رابطه را تقویت می‌کند.",pregnancy:5},{day:11,phase:"فولیکولی",icon:"fa-leaf",color:"var(--c-follicular)",description:"شمارش معکوس برای تخمک‌گذاری شروع شده! انرژی و میل جنسی به شکل قابل توجهی زیاد است و بدنت در حال رسیدن به اوج آمادگی است.",bleeding:0,hormones:"استروژن در سطح بالا قرار دارد و بدن در حال ارسال سیگنال‌های آمادگی برای باروری است. این آمادگی در تمام وجودت حس می‌شود.",mood:"انگیزه و میل جنسی قابل توجه. احساس می‌کنی بسیار جذاب و خواستنی هستی و اعتماد به نفست به اوج می‌رسد.",energy:9,libido:9,partner:"به او بگو که چقدر زیبا و جذاب است. تعریف و تمجید تو در این روزها معجزه می‌کند و حس فوق‌العاده‌ای به او می‌دهد.",pregnancy:6},{day:12,phase:"فولیکولی",icon:"fa-leaf",color:"var(--c-follicular)",description:"انرژی همچنان بالاست و میل جنسی به اوج خود نزدیک می‌شود. تو در بهترین حالت اجتماعی و ارتباطی خود هستی.",bleeding:0,hormones:"استروژن (هورمون ستاره درونت!) به بیشینه خود نزدیک می‌شود و تو را برای روز بزرگ آماده می‌کند.",mood:"خلق عالی و انرژی زیاد. آماده‌ای تا مرکز توجه باشی و بدرخشی. از این حس قدرت لذت ببر.",energy:9,libido:9,partner:"با دوستان مشترکتان یک برنامه تفریحی ترتیب دهید. او از بودن در جمع لذت خواهد برد و بسیار خوش‌صحبت خواهد بود.",pregnancy:7},{day:13,phase:"فولیکولی",icon:"fa-leaf",color:"var(--c-follicular)",description:"بدن شما مانند یک کمان کشیده شده آماده برای رها کردن تخمک است. امروز احساس جذابیت و قدرت فوق‌العاده‌ای داری.",bleeding:0,hormones:"استروژن در بیشترین مقدار خود قرار دارد و بدن برای رویداد اصلی یعنی تخمک‌گذاری، آماده می‌شود.",mood:"انگیزه و میل جنسی بالا. اعتماد به نفست در اوج است و آماده‌ای تا دنیا را فتح کنی. این حس را جشن بگیر.",energy:9,libido:10,partner:"یک هدیه کوچک و بی‌مقدمه یا یک شاخه گل می‌تواند او را بسیار خوشحال کند و نشان‌دهنده توجه تو باشد.",pregnancy:8},{day:14,phase:"فولیکولی",icon:"fa-leaf",color:"var(--c-follicular)",description:"بالاترین سطح انرژی و میل جنسی! استروژن در قله‌ی خود قرار دارد و تو را به یک آهنربای جذابیت تبدیل کرده است.",bleeding:0,hormones:"استروژن در پیک (اوج) خود است و تو را تبدیل به یک ستاره درخشان کرده! این اوج قدرت زنانه توست.",mood:"روحیه عالی و انرژی زیاد. بهترین زمان برای درخشیدن و ارائه توانایی‌هایت در کار و زندگی شخصی است.",energy:10,libido:10,partner:"به او بگو که چقدر به وجودش و موفقیت‌هایش افتخار می‌کنی. از این فرصت برای تحسین او و ابراز عشق و میک لاو استفاده کن.",pregnancy:9},{day:15,phase:"فولیکولی",icon:"fa-leaf",color:"var(--c-follicular)",description:"انرژی و میل جنسی در اوج مطلق قرار دارند. این آخرین روزهای فاز بهاری بدن توست. از این حس قدرت و سرزندگی نهایت استفاده را ببر.",bleeding:0,hormones:"استروژن بسیار بالاست و همه چیز برای رویداد بزرگ فردا (تخمک‌گذاری) مهیاست. بدنت کاملاً آماده است.",mood:"انگیزه و میل جنسی بالا. احساس قدرت و سرزندگی فوق‌العاده‌ای داری و آماده‌ای تا بدرخشی.",energy:10,libido:10,partner:"از این انرژی فوق‌العاده برای یک شب رمانتیک و فراموش‌نشدنی استفاده کنید. بهترین زمان برای یک معاشقه و سکس  است.",pregnancy:9},{day:16,phase:"فولیکولی",icon:"fa-leaf",color:"var(--c-follicular)",description:"بدن در حال انتقال به فاز تخمک‌گذاری است. انرژی همچنان در اوج است و همه چیز برای رویداد اصلی مهیاست.",bleeding:0,hormones:"استروژن بالا و بدن کاملاً برای تخمک‌گذاری آماده است. شمارش معکوس برای لحظه بزرگ شروع شده!",mood:"خلق و انرژی زیاد. احساس می‌کنی روی ابرها راه می‌روی و هیچ چیز نمی‌تواند جلوی تو را بگیرد.",energy:10,libido:10,partner:"امروز بهترین روز برای گرفتن تصمیم‌های مهم دونفره یا برنامه‌ریزی برای آینده است. از این شفافیت ذهنی استفاده کنید.",pregnancy:10},{day:17,phase:"تخمک‌گذاری",special:"ovulation",icon:"fa-star",color:"var(--c-ovulation)",description:"روز تخمک‌گذاری! امروز تخمک بالغ و زیبا از تخمدان آزاد می‌شود. تو در اوج باروری، قدرت زنانگی و جذابیت خودت هستی.",bleeding:0,hormones:"اوج استروژن باعث یک جهش در هورمون LH (هورمون لوتئینه‌کننده که مثل یک جرقه برای آزادسازی تخمک است) شده.",mood:"اعتماد به نفس بالا، اجتماعی، خوش‌صحبت و فوق‌العاده جذاب! حس می‌کنی ملکه جهان هستی و واقعاً هم هستی!",energy:10,libido:10,partner:"امروز بهترین روز برای ابراز عشق و برنامه‌ریزی یک قرار عاشقانه و خاص است. از این انرژی و جذابیت فوق‌العاده لذت ببرید.",pregnancy:10},{day:18,phase:"لوتئال",icon:"fa-moon",color:"var(--c-luteal)",description:"به فصل پاییز خوش آمدی. بعد از هیجان تابستان، حالا بدن با افزایش پروژسترون وارد فاز آرامش می‌شود تا رحم را برای بارداری احتمالی آماده کند.",bleeding:0,hormones:"پروژسترون (هورمون آرامش و حامی بارداری) در حال افزایش و استروژن در حال کاهش است. این تغییر، شیفت از انرژی بیرونی به درونی است.",mood:"ممکن است کمی آرام‌تر و درون‌گراتر شوی. احتمال تحریک‌پذیری و تغییرات خلقی اولیه وجود دارد. حس «لانه‌سازی» سراغت می‌آید.",energy:9,libido:9,partner:"حمایت و صبوری در این فاز جدید اهمیت زیادی دارد. از این آرامش نسبی لذت ببرید و یک شب آرام را با هم بگذرانید.",pregnancy:8},{day:19,phase:"لوتئال",icon:"fa-moon",color:"var(--c-luteal)",description:"انرژی کمی کمتر شده و ممکن است نشانه‌های اولیه پیش از قاعدگی یا PMS (مجموعه‌ای از علائم جسمی و روحی قبل از پریود) مثل نفخ یا حساسیت سینه ظاهر شوند.",bleeding:0,hormones:"پروژسترون بالا است و بدن را در حالت آماده‌باش و کمی تنش نگه می‌دارد. این هورمون دمای بدن را نیز کمی بالا می‌برد.",mood:"امکان اضطراب یا تغییرات خلقی بیشتر است. شاید کمی بی‌قرار باشی و ندانی دلیلش چیست. این به خاطر نوسان هورمون‌هاست.",energy:8,libido:8,partner:"صبور باش و اگر دیدی کمی مضطرب است، به او اطمینان و آرامش بده. یک آغوش گرم می‌تواند بسیار کمک‌کننده باشد.",pregnancy:7},{day:20,phase:"لوتئال",icon:"fa-moon",color:"var(--c-luteal)",description:"انرژی و میل جنسی به کاهش تدریجی خود ادامه می‌دهند. تمایل به آرامش، کارهای خانگی و مرتب‌سازی بیشتر می‌شود.",bleeding:0,hormones:"پروژسترون همچنان بالاست و این حالت آرام و کمی سنگین را حفظ می‌کند. بدن هنوز منتظر سیگنال بارداری است.",mood:"احتمال تحریک‌پذیری و تغییرات خلقی وجود دارد. آستانه تحملت ممکن است کمی پایین آمده باشد و به سکوت بیشتری نیاز داشته باشی.",energy:8,libido:7,partner:"به نیاز او برای آرامش احترام بگذار و او را برای بیرون رفتن یا مهمانی رفتن تحت فشار قرار نده.",pregnancy:6},{day:21,phase:"لوتئال",icon:"fa-moon",color:"var(--c-luteal)",description:"سطح انرژی متوسط است و علائم PMS (سندروم پیش از قاعدگی) ممکن است خود را بیشتر نشان دهند.",bleeding:0,hormones:"پروژسترون هنوز بالاست اما بدن کم‌کم آماده کاهش سطح آن می‌شود، چون سیگنال بارداری را دریافت نکرده است.",mood:"احتمال تغییرات خلقی و حساسیت احساسی. ممکن است دلت بخواهد به خاطرات گذشته فکر کنی یا کمی بغض کنی.",energy:7,libido:6,partner:"یک شنونده خوب باش. گاهی او فقط نیاز دارد حرف بزند بدون اینکه راه‌حلی از تو بخواهد. فقط گوش کن و همدلی نشان بده.",pregnancy:5},{day:22,phase:"لوتئال",icon:"fa-moon",color:"var(--c-luteal)",description:"انرژی و میل جنسی در سراشیبی قرار گرفته‌اند. بدن کم‌کم متوجه می‌شود که بارداری رخ نداده و آماده افت هورمونی می‌شود.",bleeding:0,hormones:"پروژسترون رو به کاهش است و این سرآغاز علائم شدیدتر PMS است. این افت هورمونی دلیل اصلی تغییرات خلقی است.",mood:"احتمال تحریک‌پذیری بیشتر است. صبر و حوصله‌ات کمتر از همیشه است و ممکن است به سادگی از کوره در بروی.",energy:6,libido:5,partner:"آرامش خودت را حفظ کن و مسائل را شخصی نکن. این حالت گذراست و به زودی تمام می‌شود.",pregnancy:4},{day:23,phase:"لوتئال",icon:"fa-moon",color:"var(--c-luteal)",description:"کاهش انرژی ادامه دارد. علائم جسمی PMS مانند نفخ، سردرد یا جوش صورت ممکن است شدیدتر شوند.",bleeding:0,hormones:"پروژسترون به سرعت در حال کاهش است و بدن را تحت تاثیر قرار می‌دهد. این افت، سیگنال شروع چرخه جدید است.",mood:"امکان اضطراب یا حساسیت احساسی بیشتر است. ممکن است احساس کنی کسی تو را درک نمی‌کند و بسیار تنها هستی.",energy:6,libido:4,partner:"در کارهای خانه به او کمک کن. همین کارهای کوچک، حمایت بزرگی محسوب می‌شود و به او نشان می‌دهد که تنها نیست.",pregnancy:3},{day:24,phase:"لوتئال",special:"pms",icon:"fa-moon",color:"var(--c-luteal)",description:"شروع رسمی PMS (سندروم پیش از قاعدگی)! سطح انرژی و میل جنسی کاهش می‌یابد. رسماً وارد هفته پیش از قاعدگی شده‌ای. با خودت مهربان باش.",bleeding:0,hormones:"پروژسترون پایین می‌آید و این باعث تشدید علائم روحی و جسمی می‌شود. تعادل هورمونی به هم می‌ریزد.",mood:"احتمال بروز علائم پیش از قاعدگی بیشتر است. ممکن است احساس کلافگی، بی‌قراری و غمگینی کنی.",energy:5,libido:4,partner:"از بحث و جدل‌های بی‌مورد پرهیز کن. الان زمان مناسبی برای حل مسائل پیچیده نیست. فقط آرامش را حفظ کن.",pregnancy:2},{day:25,phase:"لوتئال",special:"pms",icon:"fa-moon",color:"var(--c-luteal)",description:"انرژی متوسط است و بدن در حال آماده شدن برای چرخه بعدی است. وقتش است سرعت را کم کنی و به خودت و نیازهایت توجه کنی.",bleeding:0,hormones:"پروژسترون کاهش یافته است و هورمون آرامش‌بخش در حال ترک بدن است. این باعث می‌شود احساس آسیب‌پذیری کنی.",mood:"احتمال تغییرات خلقی و حساسیت احساسی وجود دارد. ممکن است از یک تبلیغ تلویزیونی هم اشکت دربیاید و این کاملاً اوکی است!",energy:5,libido:3,partner:"از او بپرس: «شکلات می‌خوای یا پیتزا؟» گاهی بهترین راه حمایت، برآورده کردن هوس‌های کوچک و نشان دادن توجه است!",pregnancy:1},{day:26,phase:"لوتئال",special:"pms",icon:"fa-moon",color:"var(--c-luteal)",description:"انرژی کم است و بدن برای شروع سیکل جدید آماده می‌شود. با خودت مهربان باش و برنامه سنگین نچین. نه گفتن را تمرین کن.",bleeding:0,hormones:"پروژسترون پایین‌تر شده و بدن خودش را برای شروع مجدد و ریزش دیواره رحم آماده می‌کند.",mood:"خلق ممکن است بسیار متغیر باشد. در یک لحظه شاد و در لحظه بعد غمگین هستی. این نوسان طبیعی است.",energy:4,libido:3,partner:"صبور باش و به یاد داشته باش که این حالت موقتی است و به زودی تمام می‌شود. او به درک تو نیاز دارد.",pregnancy:1},{day:27,phase:"لوتئال",special:"pms",icon:"fa-moon",color:"var(--c-luteal)",description:"به قاعدگی خیلی نزدیک شده‌ای. علائم PMS (سندروم پیش از قاعدگی) می‌تواند به اوج خود برسد. نفس عمیق بکش.",bleeding:0,hormones:"پروژسترون نزدیک به پایین‌ترین مقدار است و این افت شدید باعث این همه حساسیت روحی و جسمی می‌شود.",mood:"پوست دلت نازک شده! ممکن است با کوچکترین حرفی ناراحت شوی یا بغض کنی. خودت را سرزنش نکن و به خودت عشق بورز.",energy:3,libido:2,partner:"اینجا مرحله «فقط سکوت کن و بغلش کن» است! حرف‌هایش را به دل نگیر و فقط حضور داشته باش. این بزرگترین کمک است.",pregnancy:0},{day:28,phase:"لوتئال",special:"pms",icon:"fa-moon",color:"var(--c-luteal)",description:"آمادگی نهایی برای قاعدگی. حساسیت و تحریک‌پذیری در بالاترین حد خود قرار دارد. فقط سعی کن این روز را به سلامت بگذرانی.",bleeding:0,hormones:"پروژسترون بسیار پایین است و بدن در آستانه شروع چرخه جدید قرار دارد. بدن در حال آماده‌باش کامل است.",mood:"حساسیت و تحریک‌پذیری ممکن است زیاد باشد. احساس می‌کنی در یک دیگ زودپز در حال جوشیدنی. از موقعیت‌های استرس‌زا دوری کن.",energy:3,libido:2,partner:"فضایی آرام و بدون تنش برایش فراهم کن و از او توقع زیادی نداشته باش. بگذار در آرامش باشد.",pregnancy:0},{day:29,phase:"لوتئال",special:"pms",icon:"fa-moon",color:"var(--c-luteal)",description:"آمادگی کامل برای شروع قاعدگی. بدن در حال آماده شدن برای رهاسازی است. به خودت استراحت مطلق بده.",bleeding:0,hormones:"پروژسترون پایین است و بدن منتظر سیگنال شروع پریود است. این سکوت قبل از طوفان (قاعدگی) است.",mood:"علائم جسمی و خلقی می‌تواند اوج بگیرد. ممکن است از همه چیز و همه کس خسته باشی و فقط سکوت بخواهی.",energy:2,libido:1,partner:"قهرمان باش! تمام مسئولیت‌های خانه را به عهده بگیر و بگذار استراحت کند. این بهترین نوع عشق ورزیدن است.",pregnancy:0},{day:30,phase:"لوتئال",special:"pms",icon:"fa-moon",color:"var(--c-luteal)",description:"پایان فاز پاییزی. بدن در سکوت کامل، منتظر شروع دوباره است. انرژی در پایین‌ترین سطح خود قرار دارد.",bleeding:0,hormones:"پروژسترون به حداقل رسیده است و بدن در حالت انتظار برای شروع مجدد قرار دارد. این پایان یک سفر و آغاز سفری دیگر است.",mood:"حساسیت و تحریک‌پذیری زیاد است. احساس می‌کنی روی لبه‌ی تیغ راه می‌روی و بسیار آسیب‌پذیری.",energy:2,libido:1,partner:"فقط کنارش باش. حضور آرام تو بهترین حمایت است و نشان می‌دهد که در هر حالی، چه در اوج انرژی و چه در خستگی، دوستش داری.",pregnancy:0},{day:31,phase:"لوتئال",special:"pms",icon:"fa-moon",color:"var(--c-luteal)",description:"آخرین روز این سفر! بدن آماده می‌شود تا با شروع خونریزی فردا، دکمه ری‌استارت را بزند و از نو شروع کند.",bleeding:0,hormones:"پروژسترون و استروژن هر دو در کف مطلق قرار دارند و منتظرند تا با شروع پریود، همه‌چیز از نو شروع شود.",mood:"حساسیت و نوسانات خلقی زیاد است. خسته از خستگی هستی! این نیز بگذرد و فردا روز جدیدی است.",energy:1,libido:1,partner:"صبر تو امروز، سرمایه‌گذاری برای روزهای خوب و پر انرژی آینده است. امشب شام مورد علاقه‌اش را درست کن!",pregnancy:0}];
        const toPersian = str => str.toString().replace(/[0-9]/g, w => '۰۱۲۳۴۵۶۷۸۹' [w]);
        
        // --- Date & Cycle Logic ---
        function getDayData(d,t){const a=4,e=Math.max(10,t-14);let o;if(d<=a)o={...cycleData[d]};else if(d<e){const t=Math.round(5+(d-5)/(e-5-1)*11);o={...cycleData[Math.min(16,t)]}}else if(d===e)o={...cycleData[17]};else{const a=Math.round(18+(d-e-1)/(t-e-1)*13);o={...cycleData[Math.min(31,a)]}}return t-d<=7&&d>e&&(o.special="pms"),o}
        function toJalali(date){const a=date.getUTCFullYear(),e=date.getUTCMonth()+1,t=date.getUTCDate();const n=[0,31,59,90,120,151,181,212,243,273,304,334],o=e>2?a+1:a;let r=355666+365*a+Math.floor((o+3)/4)-Math.floor((o+99)/100)+Math.floor((o+399)/400)+t+n[e-1];let i=-1595+33*Math.floor(r/12053);r%=12053,i+=4*Math.floor(r/1461),r%=1461,r>365&&(i+=Math.floor((r-1)/365),r=(r-1)%365);const l=r<186?1+Math.floor(r/31):7+Math.floor((r-186)/30),s=1+(r<186?r%31:(r-186)%30);return{jy:i,jm:l,jd:s}}
        function getJalaliMonthLength(a,e){return e<=6?31:e<=11?30:((a-474)%2820+512)*682%2816<682?30:29}
        function jalaliToDate(jalaliStr){const[jy,jm,jd]=jalaliStr.split("-").map(Number);function toGregorian(jy,jm,jd){let gy;if(jy>979){gy=1600;jy-=979}else{gy=621}let days=(365*jy)+(parseInt(jy/33)*8)+(parseInt(((jy%33)+3)/4))+78+jd+((jm<7)?(jm-1)*31:((jm-7)*30)+186);gy+=400*parseInt(days/146097);days%=146097;if(days>36524){gy+=100*parseInt(--days/36524);days%=36524;if(days>=365)days++}gy+=4*parseInt(days/1461);days%=1461;if(days>365){gy+=parseInt((days-1)/365);days=(days-1)%365}let gd=days+1;const sal_a=[0,31,(gy%4==0&&gy%100!=0||gy%400==0)?29:28,31,30,31,30,31,31,30,31,30,31];let gm;for(gm=0;gm<13;gm++){if(gd<=sal_a[gm])break;gd-=sal_a[gm]}return[gy,gm,gd]}const[gYear,gMonth,gDay]=toGregorian(jy,jm,jd);return new Date(Date.UTC(gYear,gMonth-1,gDay))}
        const getTodayUTC = () => { const today = new Date(); return new Date(Date.UTC(today.getFullYear(), today.getMonth(), today.getDate())); };
        const dateDiff = (a, b) => Math.floor((b.getTime() - a.getTime()) / (1000 * 60 * 60 * 24));
        
        // --- NEW, FIXED WHEEL SELECTOR CLASS ---
        class WheelSelector {
            constructor(options) {
                this.el = document.querySelector(options.el);
                this.source = options.source;
                this.itemHeight = 44;
                this.middleIndex = 2; // Position of the selected item in the visible list
                this.onChange = options.onChange || function() {};
                this._init(options.selectedIndex || 0);
            }
            _init(selectedIndex) {
                this.el.innerHTML = `<ul class="selector-list">${this.source
                    .map(item => `<li class="selector-item">${item.text}</li>`)
                    .join("")}</ul><div class="selector-highlight"></div>`;
                this.list = this.el.querySelector("ul");
                this.items = this.el.querySelectorAll("li");
                this.select(selectedIndex, false);
                this._attachEvents();
            }
            _attachEvents() {
                let startY = 0, scrollStart = 0, isDragging = false;
                const onStart = (e) => {
                    e.stopPropagation();
                    startY = e.touches ? e.touches[0].clientY : e.clientY;
                    scrollStart = parseFloat(this.list.style.transform.replace("translateY(", "")) || 0;
                    this.list.style.transition = "none";
                    isDragging = true;
                };
                const onMove = (e) => {
                    if (!isDragging) return;
                    e.preventDefault();
                    let moveY = (e.touches ? e.touches[0].clientY : e.clientY) - startY;
                    this.list.style.transform = `translateY(${scrollStart + moveY}px)`;
                };
                const onEnd = () => { if (isDragging) { isDragging = false; this._snap(); } };
                const onWheel = (e) => {
                    e.preventDefault();
                    let currentScroll = parseFloat(this.list.style.transform.replace("translateY(", "")) || 0;
                    this.list.style.transition = "none";
                    this.list.style.transform = `translateY(${currentScroll - e.deltaY}px)`;
                    clearTimeout(this.wheelTimeout);
                    this.wheelTimeout = setTimeout(() => this._snap(), 150);
                };
                this.el.addEventListener("mousedown", onStart);
                document.addEventListener("mousemove", onMove);
                document.addEventListener("mouseup", onEnd);
                this.el.addEventListener("wheel", onWheel, { passive: false });
                this.el.addEventListener("touchstart", onStart, { passive: false });
                this.el.addEventListener("touchmove", onMove, { passive: false });
                this.el.addEventListener("touchend", onEnd);
            }
            _snap() {
                let finalScroll = parseFloat(this.list.style.transform.replace("translateY(", "")) || 0;
                let targetIndex = Math.round((finalScroll - this.middleIndex * this.itemHeight) / -this.itemHeight);
                this.select(targetIndex);
            }
            select(index, triggerChange = true) {
                index = Math.max(0, Math.min(index, this.source.length - 1));
                const hasChanged = this.selectedIndex !== index;
                this.selectedIndex = index;
                this.list.style.transition = "transform 0.2s ease-out";
                this.list.style.transform = `translateY(${(this.middleIndex - this.selectedIndex) * this.itemHeight}px)`;
                this.items.forEach((item, i) => item.classList.toggle("selected", i === this.selectedIndex));
                if (hasChanged && triggerChange) {
                    this.onChange(this.getValue());
                }
            }
            updateSource(newSource) {
                this.source = newSource;
                this.list.innerHTML = this.source
                    .map(item => `<li class="selector-item">${item.text}</li>`)
                    .join("");
                this.items = this.el.querySelectorAll("li");
                const newSelectedIndex = Math.min(this.selectedIndex, this.source.length - 1);
                this.select(newSelectedIndex, false);
            }
            getValue() { return this.source[this.selectedIndex].value; }
        }


        // --- Global State ---
        const dom = {};
        const appState = { startDate: null, cycleLength: 28, currentDisplayDate: getTodayUTC(), cycleHistory: [] };
        let activeDateInput = null;
        
        // --- UI Rendering ---
        const renderUI = () => {
            if (!appState.startDate) return;
            
            const dayDiff = dateDiff(appState.startDate, appState.currentDisplayDate);
            const trackerView = document.getElementById('trackerView');
            
            let tempCard = trackerView.querySelector('.temp-card');
            if (tempCard) tempCard.remove();
            
            if (dayDiff < 0) {
                const tempMsgCard = document.createElement('div');
                tempMsgCard.className = 'card-base temp-card';
                tempMsgCard.style.textAlign = 'center';
                tempMsgCard.style.color = 'var(--text-subtle)';
                const jDate = toJalali(appState.currentDisplayDate);
                tempMsgCard.innerHTML = `تاریخ نمایش داده شده (${toPersian(`${jDate.jy}/${jDate.jm}/${jDate.jd}`)}) قبل از شروع چرخه فعلی شماست.`;
                trackerView.prepend(tempMsgCard);
                document.getElementById("detailsGrid").innerHTML = '';
                document.getElementById("displayedJalaliDate").textContent = toPersian(`${jDate.jy}/${String(jDate.jm).padStart(2, "0")}/${String(jDate.jd).padStart(2, "0")}`);
                return;
            };

            const dayOfCycle = (dayDiff % appState.cycleLength) + 1;
            const data = getDayData(dayOfCycle, appState.cycleLength);
            let phaseColor = data.color, phaseIcon = data.icon;
            document.documentElement.style.setProperty('--phase-theme-color', data.color);
            
            const specialBanner = document.getElementById("specialDayBanner");
            specialBanner.style.display = 'none';
            if (data.special === 'ovulation') {
                specialBanner.innerHTML = `<i class="fa-solid fa-star"></i> روز تخمک‌گذاری! شانس باروری در اوج است.`;
                specialBanner.className = "special-banner ovulation";
                specialBanner.style.display = 'flex';
            } else if (data.special === 'pms') {
                phaseColor = 'var(--c-pms)';
                phaseIcon = 'fa-cloud-bolt';
                document.documentElement.style.setProperty('--phase-theme-color', phaseColor);
                specialBanner.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> احتمال علائم PMS. مراقب خود باشید.`;
                specialBanner.className = "special-banner pms";
                specialBanner.style.display = 'flex';
            }
            
            const periodAlert = document.getElementById("periodAlertCard");
            const daysRemaining = appState.cycleLength - dayOfCycle;
            if (daysRemaining >= 0 && daysRemaining <= 2) {
                let alertText = daysRemaining === 0 ? "پریود شما احتمالاً از <b>فردا</b> شروع می‌شود." : `پریود شما تا <b>${toPersian(daysRemaining + 1)} روز دیگر</b> شروع می‌شود.`;
                periodAlert.innerHTML = `<i class="fa-solid fa-bell"></i>${alertText}`;
                periodAlert.style.display = 'flex';
            } else {
                periodAlert.style.display = 'none';
            }
            
            const progressCircle = document.getElementById("progress-circle-fg");
            const r = 45, circ = 2 * Math.PI * r;
            progressCircle.style.stroke = phaseColor;
            progressCircle.style.strokeDasharray = circ;
            progressCircle.style.strokeDashoffset = circ - (dayOfCycle / appState.cycleLength) * circ;
            
            document.getElementById("progressDayNumber").textContent = toPersian(dayOfCycle);
            const phaseIconEl = document.getElementById("phaseIcon");
            phaseIconEl.className = `fa-solid ${phaseIcon}`;
            phaseIconEl.style.color = phaseColor;
            document.getElementById("cyclePhaseTitle").textContent = data.phase;
            
            const jDate = toJalali(appState.currentDisplayDate);
            document.getElementById("displayedJalaliDate").textContent = toPersian(`${jDate.jy}/${String(jDate.jm).padStart(2, "0")}/${String(jDate.jd).padStart(2, "0")}`);
            
            const renderStat = (label, value) => {
                const getQualitativeText = (val) => { if (val >= 8) return 'بالا'; if (val >= 4) return 'متوسط'; if (val > 0) return 'کم'; return '—'; };
                return `<div class="stat-item"><div class="stat-label"><span>${label}</span><span>${getQualitativeText(value)}</span></div><div class="progress-bar-container"><div class="progress-bar" style="width: ${value * 10}%"></div></div></div>`;
            };

            document.getElementById("detailsGrid").innerHTML = `
                <div class="card-base"><div class="detail-card-header"><i class="detail-card-icon fa-solid fa-book-open"></i><h3 class="detail-card-title">توضیحات روز</h3></div><div class="detail-card-content"><p>${data.description}</p></div></div>
                <div class="card-base"><div class="detail-card-header"><i class="detail-card-icon fa-solid fa-face-grin-beam"></i><h3 class="detail-card-title">وضعیت احساسی</h3></div><div class="detail-card-content"><p>${data.mood}</p></div></div>
                <div class="card-base"><div class="detail-card-header"><i class="detail-card-icon fa-solid fa-heart-pulse"></i><h3 class="detail-card-title">وضعیت فیزیکی</h3></div><div class="detail-card-content"><div class="stats-grid">${renderStat("سطح انرژی", data.energy)}${renderStat("میل جنسی", data.libido)}${renderStat("خونریزی", data.bleeding)}${renderStat("احتمال باروری", data.pregnancy)}</div></div></div>
                <div class="card-base"><div class="detail-card-header"><i class="detail-card-icon fa-solid fa-hand-holding-heart"></i><h3 class="detail-card-title">راهنمایی</h3></div><div class="detail-card-content"><p><b>تغییرات هورمونی:</b> ${data.hormones}<br><b>توصیه به شریک:</b> ${data.partner}</p></div></div>`;
        };

        const renderHistoryList = () => {
            dom.historyListContainer.innerHTML = '';
            if (appState.cycleHistory.length === 0) {
                dom.historyListContainer.innerHTML = `<p class="history-placeholder">تاریخچه‌ای برای نمایش وجود ندارد.</p>`;
                return;
            }
            appState.cycleHistory.forEach((item, index) => {
                const itemDate = new Date(item.startDate);
                const jDate = toJalali(itemDate);
                const formattedDate = toPersian(`${jDate.jy}/${String(jDate.jm).padStart(2, '0')}/${String(jDate.jd).padStart(2, '0')}`);
                
                const element = document.createElement('div');
                element.className = 'history-item';
                element.innerHTML = `
                    <div class="item-info">
                        <span class="item-date">${formattedDate}</span>
                        <span class="item-duration">طول چرخه: ${toPersian(item.duration)} روز</span>
                    </div>
                    <div class="item-actions">
                        <button class="edit-btn" data-index="${index}" title="ویرایش"><i class="fa-solid fa-pencil"></i></button>
                        <button class="delete-btn" data-index="${index}" title="حذف"><i class="fa-solid fa-trash-can"></i></button>
                    </div>`;
                dom.historyListContainer.appendChild(element);
            });
        };

        // --- Page & Modal Toggling ---
        const showPage = (pageName) => {
            dom.appContainer.style.display = 'none';
            dom.historyView.style.display = 'none';
            if (pageName === 'tracker') {
                dom.appContainer.style.display = 'block';
            } else if (pageName === 'history') {
                renderHistoryList();
                dom.historyView.style.display = 'block';
            }
        };

        const togglePanel = (overlay, panel, show) => {
            overlay.classList.toggle("active", show);
            panel.classList.toggle("active", show);
        };

        const toggleModal = (modal, show) => modal.classList.toggle('visible', show);

        // --- Data Management ---
        const saveSettings = (startDate, cycleLength) => {
            const settings = { startDate, cycleLength: parseInt(cycleLength, 10) };
            localStorage.setItem("lunaAppSettings", JSON.stringify(settings));
            return settings;
        };

        const saveHistory = () => {
            appState.cycleHistory.sort((a, b) => new Date(b.startDate) - new Date(a.startDate));
            localStorage.setItem('lunaCycleHistory', JSON.stringify(appState.cycleHistory));
        };

        const startNewCycle = () => {
            const newStartDate = appState.currentDisplayDate;
            const oldStartDate = appState.startDate;
            
            if (oldStartDate) {
                const duration = dateDiff(oldStartDate, newStartDate);
                if (duration > 10 && duration < 90) { // Basic validation
                    appState.cycleHistory.push({ startDate: oldStartDate.toISOString().split('T')[0], duration });
                    saveHistory();
                }
            }
            
            appState.startDate = newStartDate;
            const newJalaliStartDate = toJalali(newStartDate);
            const newJalaliString = `${newJalaliStartDate.jy}-${newJalaliStartDate.jm}-${newJalaliStartDate.jd}`;
            saveSettings(newJalaliString, appState.cycleLength);
            
            toggleModal(dom.confirmPeriodModal, false);
            renderUI();
        };

        // --- Initializers ---
        const initializePickers = () => {
            const today = toJalali(new Date());

            const getRange = (start, end, isPersian) => Array.from({ length: end - start + 1 }, (_, i) => ({ value: start + i, text: isPersian ? toPersian(start + i) : start + i }));
            const getMonths = () => [
                { value: 1, text: 'فروردین' }, { value: 2, text: 'اردیبهشت' },
                { value: 3, text: 'خرداد' }, { value: 4, text: 'تیر' },
                { value: 5, text: 'مرداد' }, { value: 6, text: 'شهریور' },
                { value: 7, text: 'مهر' }, { value: 8, text: 'آبان' },
                { value: 9, text: 'آذر' }, { value: 10, text: 'دی' },
                { value: 11, text: 'بهمن' }, { value: 12, text: 'اسفند' }
            ];
            const getDays = (year, month) => getRange(1, getJalaliMonthLength(year, month), true);

            const updateDaySelector = () => {
                const yearValue = parseInt(yearPicker.getValue());
                const monthValue = parseInt(monthPicker.getValue());
                dayPicker.updateSource(getDays(yearValue, monthValue));
            };

            let yearPicker = new WheelSelector({
                el: "#pdp-year",
                source: getRange(1350, today.jy + 5, true),
                selectedIndex: today.jy - 1350,
                onChange: updateDaySelector
            });
            let monthPicker = new WheelSelector({
                el: "#pdp-month",
                source: getMonths(),
                selectedIndex: today.jm - 1,
                onChange: updateDaySelector
            });
            let dayPicker = new WheelSelector({
                el: "#pdp-day",
                source: getDays(today.jy, today.jm),
                selectedIndex: today.jd - 1,
            });

            dom.confirmDate.addEventListener("click", () => {
                if (!activeDateInput) return;
                const year = yearPicker.getValue();
                const month = monthPicker.getValue();
                const day = dayPicker.getValue();
                const pad = num => (num < 10 ? "0" : "") + num;
                activeDateInput.value = `${toPersian(year)}/${toPersian(pad(month))}/${toPersian(pad(day))}`;
                activeDateInput.dataset.jalaliDate = `${year}-${month}-${day}`;
                toggleModal(dom.datePickerModal, false);
            });
            
            const createRange = (start, end) => Array.from({ length: end - start + 1 }, (_, i) => ({ value: start + i, text: toPersian(start + i) }));
            const cycleLengthPicker = new WheelSelector({ el: "#cycle-length-column", source: createRange(15, 45), selectedIndex: 28 - 15 });
            dom.confirmCycle.addEventListener("click", () => {
                const length = cycleLengthPicker.getValue();
                const inputs = [document.getElementById('cycleLength'), dom.settingsCycleLengthInput];
                inputs.forEach(input => {
                    if(input) {
                        input.value = `${toPersian(length)} روز`;
                        input.dataset.cycleLength = length;
                    }
                });
                toggleModal(dom.cycleLengthPickerModal, false);
            });
        };

        const attachGlobalListeners = () => {
            dom.themeToggle.addEventListener("change", () => {
                const theme = dom.themeToggle.checked ? "dark" : "light";
                document.documentElement.classList.toggle("dark-mode", theme === "dark");
                localStorage.setItem("lunaTheme", theme);
            });

            dom.openSettingsBtn.addEventListener("click", () => {
                const settings = JSON.parse(localStorage.getItem("lunaAppSettings"));
                if (settings) {
                    const [y,m,d] = settings.startDate.split('-');
                    dom.settingsPeriodDateInput.value = toPersian(`${y}/${String(m).padStart(2,'0')}/${String(d).padStart(2,'0')}`);
                    dom.settingsPeriodDateInput.dataset.jalaliDate = settings.startDate;
                    dom.settingsCycleLengthInput.value = `${toPersian(settings.cycleLength)} روز`;
                    dom.settingsCycleLengthInput.dataset.cycleLength = settings.cycleLength;
                }
                togglePanel(dom.settingsOverlay, dom.settingsPanel, true)
            });
            dom.aboutBtn.addEventListener("click", () => togglePanel(dom.aboutOverlay, dom.aboutPanel, true));
            [dom.cancelSettingsBtn, dom.settingsOverlay].forEach(el => el.addEventListener("click", (e) => { if (e.target === el) togglePanel(dom.settingsOverlay, dom.settingsPanel, false) }));
            [dom.closeAboutBtn, dom.aboutOverlay].forEach(el => el.addEventListener("click", (e) => { if (e.target === el) togglePanel(dom.aboutOverlay, dom.aboutPanel, false) }));

            dom.viewHistoryBtn.addEventListener('click', () => {
                togglePanel(dom.settingsOverlay, dom.settingsPanel, false);
                showPage('history');
            });
            dom.backToTrackerBtn.addEventListener('click', () => showPage('tracker'));
            
            dom.saveSettingsBtn.addEventListener("click", () => {
                const startDate = dom.settingsPeriodDateInput.dataset.jalaliDate;
                const cycleLength = dom.settingsCycleLengthInput.dataset.cycleLength;
                if (!startDate) return alert("لطفا تاریخ را انتخاب کنید.");
                const newSettings = saveSettings(startDate, cycleLength);
                appState.startDate = jalaliToDate(newSettings.startDate);
                appState.cycleLength = newSettings.cycleLength;
                renderUI();
                togglePanel(dom.settingsOverlay, dom.settingsPanel, false);
            });

            // Corrected listeners for closing modals
            [dom.closeDateModal, dom.datePickerModal].forEach(el => el.addEventListener('click', (e) => { if (e.target === el) toggleModal(dom.datePickerModal, false) }));
            [dom.closeCycleModal, dom.cycleLengthPickerModal].forEach(el => el.addEventListener('click', (e) => { if (e.target === el) toggleModal(dom.cycleLengthPickerModal, false) }));
            [dom.closeWarningModalBtn, dom.warningModal].forEach(el => el.addEventListener('click', (e) => { if (e.target === el) toggleModal(dom.warningModal, false) }));
            [dom.cancelNewPeriodBtn, dom.confirmPeriodModal].forEach(el => el.addEventListener('click', (e) => { if (e.target === el) toggleModal(dom.confirmPeriodModal, false) }));
            
            dom.confirmNewPeriodBtn.addEventListener('click', startNewCycle);

            dom.addHistoryEntryBtn.addEventListener('click', () => {
                dom.editHistoryIndex.value = '';
                dom.editHistoryTitle.textContent = 'افزودن چرخه';
                dom.historyPeriodDate.value = '';
                dom.historyCycleLength.value = '';
                togglePanel(dom.editHistoryModalOverlay, dom.editHistoryPanel, true)
            });
            dom.historyListContainer.addEventListener('click', e => {
                const editBtn = e.target.closest('.edit-btn');
                const deleteBtn = e.target.closest('.delete-btn');
                if (editBtn) {
                    const index = parseInt(editBtn.dataset.index, 10);
                    const entry = appState.cycleHistory[index];
                    dom.editHistoryIndex.value = index;
                    dom.editHistoryTitle.textContent = 'ویرایش چرخه';
                    const [y, m, d] = entry.startDate.split('-');
                    const jDate = toJalali(new Date(Date.UTC(y, m-1, d)));
                    dom.historyPeriodDate.dataset.jalaliDate = `${jDate.jy}-${jDate.jm}-${jDate.jd}`;
                    dom.historyPeriodDate.value = toPersian(`${jDate.jy}/${String(jDate.jm).padStart(2, '0')}/${String(jDate.jd).padStart(2, '0')}`);
                    dom.historyCycleLength.value = entry.duration;
                    togglePanel(dom.editHistoryModalOverlay, dom.editHistoryPanel, true);
                }
                if (deleteBtn) {
                    if (confirm('آیا از حذف این چرخه مطمئن هستید؟')) {
                        const index = parseInt(deleteBtn.dataset.index, 10);
                        appState.cycleHistory.splice(index, 1);
                        saveHistory();
                        renderHistoryList();
                    }
                }
            });

            dom.settingsPeriodDateInput.addEventListener("click", e => { activeDateInput = e.target; toggleModal(dom.datePickerModal, true); });
            dom.historyPeriodDate.addEventListener("click", e => { activeDateInput = e.target; toggleModal(dom.datePickerModal, true); });
            dom.settingsCycleLengthInput.addEventListener("click", () => toggleModal(dom.cycleLengthPickerModal, true));
            [dom.cancelHistoryEditBtn, dom.editHistoryModalOverlay].forEach(el => el.addEventListener("click", e => { if (e.target === el) togglePanel(dom.editHistoryModalOverlay, dom.editHistoryPanel, false) }));
            dom.saveHistoryEditBtn.addEventListener('click', () => {
                const index = parseInt(dom.editHistoryIndex.value, 10);
                const jalaliDateStr = dom.historyPeriodDate.dataset.jalaliDate;
                const duration = parseInt(dom.historyCycleLength.value, 10);

                if (!jalaliDateStr || !duration || duration < 10 || duration > 90) return alert('لطفا تاریخ شروع و طول چرخه معتبر (بین ۱۰ تا ۹۰ روز) را وارد کنید.');
                
                const gregorianDate = jalaliToDate(jalaliDateStr).toISOString().split('T')[0];
                const newEntry = { startDate: gregorianDate, duration };
                
                if (isNaN(index)) { // Add new
                    appState.cycleHistory.push(newEntry);
                } else { // Edit existing
                    appState.cycleHistory[index] = newEntry;
                }
                
                saveHistory();
                renderHistoryList();
                togglePanel(dom.editHistoryModalOverlay, dom.editHistoryPanel, false);
            });
        };
        
        const attachTrackerListeners = () => {
             document.getElementById('trackerView').addEventListener('click', e => {
                const button = e.target.closest('button');
                if (!button) return;

                switch(button.id) {
                    case 'prevDayBtn':
                        if (dateDiff(appState.startDate, appState.currentDisplayDate) < 1) {
                            toggleModal(dom.warningModal, true);
                            return;
                        }
                        appState.currentDisplayDate.setUTCDate(appState.currentDisplayDate.getUTCDate() - 1);
                        break;
                    case 'nextDayBtn':
                        appState.currentDisplayDate.setUTCDate(appState.currentDisplayDate.getUTCDate() + 1);
                        break;
                    case 'todayBtn':
                        appState.currentDisplayDate = getTodayUTC();
                        break;
                    case 'startOfCycleBtn':
                        if (appState.startDate) appState.currentDisplayDate = new Date(appState.startDate.getTime());
                        break;
                    case 'logPeriodBtn':
                        const jDate = toJalali(appState.currentDisplayDate);
                        dom.confirmPeriodDateText.textContent = toPersian(`${jDate.jy}/${String(jDate.jm).padStart(2,'0')}/${String(jDate.jd).padStart(2,'0')}`);
                        toggleModal(dom.confirmPeriodModal, true);
                        break;
                    default:
                        return;
                }
                renderUI();
            });
        };
        
        const showTracker = (settings) => {
            dom.mainContent.innerHTML = trackerViewHTML;
            appState.startDate = jalaliToDate(settings.startDate);
            appState.cycleLength = settings.cycleLength;
            appState.currentDisplayDate = getTodayUTC();
            attachTrackerListeners();
            renderUI();
        };

        const showSetup = () => {
            dom.mainContent.innerHTML = setupViewHTML;
            const startBtn = document.getElementById('startTrackingBtn');
            const lastPeriodDateInput = document.getElementById('lastPeriodDate');
            const cycleLengthInput = document.getElementById('cycleLength');
            
            cycleLengthInput.dataset.cycleLength = 28;

            lastPeriodDateInput.addEventListener('click', e => {
                activeDateInput = e.target;
                toggleModal(dom.datePickerModal, true);
            });
            cycleLengthInput.addEventListener('click', () => toggleModal(dom.cycleLengthPickerModal, true));
            startBtn.addEventListener('click', () => {
                const date = lastPeriodDateInput.dataset.jalaliDate;
                const length = parseInt(cycleLengthInput.dataset.cycleLength, 10);
                if (!date || !length) return alert("لطفا تاریخ و طول چرخه را انتخاب کنید.");
                const settings = saveSettings(date, length);
                showTracker(settings);
            });
        };

        const loadData = () => {
            // Cache all DOM elements
            dom.appContainer = document.getElementById('appContainer');
            dom.mainContent = document.getElementById('mainContent');
            dom.historyView = document.getElementById('historyView');
            dom.historyListContainer = document.getElementById('historyListContainer');
            dom.backToTrackerBtn = document.getElementById('backToTrackerBtn');
            dom.addHistoryEntryBtn = document.getElementById('addHistoryEntryBtn');
            dom.themeToggle = document.getElementById('themeToggle');
            dom.openSettingsBtn = document.getElementById('openSettingsBtn');
            dom.settingsOverlay = document.getElementById('settingsOverlay');
            dom.settingsPanel = document.getElementById('settingsPanel');
            dom.settingsPeriodDateInput = document.getElementById('settingsPeriodDate');
            dom.settingsCycleLengthInput = document.getElementById('settingsCycleLength');
            dom.viewHistoryBtn = document.getElementById('viewHistoryBtn');
            dom.cancelSettingsBtn = document.getElementById('cancelSettingsBtn');
            dom.saveSettingsBtn = document.getElementById('saveSettingsBtn');
            dom.aboutBtn = document.getElementById('aboutBtn');
            dom.aboutOverlay = document.getElementById('aboutOverlay');
            dom.aboutPanel = document.getElementById('aboutPanel');
            dom.closeAboutBtn = document.getElementById('closeAboutBtn');
            dom.datePickerModal = document.getElementById('datePickerModal');
            dom.closeDateModal = document.getElementById('closeDateModal');
            dom.confirmDate = document.getElementById('confirmDate');
            dom.cycleLengthPickerModal = document.getElementById('cycleLengthPickerModal');
            dom.closeCycleModal = document.getElementById('closeCycleModal');
            dom.confirmCycle = document.getElementById('confirmCycle');
            dom.warningModal = document.getElementById('warningModal');
            dom.closeWarningModalBtn = document.getElementById('closeWarningModalBtn');
            dom.confirmPeriodModal = document.getElementById('confirmPeriodModal');
            dom.confirmPeriodDateText = document.getElementById('confirmPeriodDateText');
            dom.cancelNewPeriodBtn = document.getElementById('cancelNewPeriodBtn');
            dom.confirmNewPeriodBtn = document.getElementById('confirmNewPeriodBtn');
            dom.editHistoryModalOverlay = document.getElementById('editHistoryModalOverlay');
            dom.editHistoryPanel = document.getElementById('editHistoryPanel');
            dom.editHistoryTitle = document.getElementById('editHistoryTitle');
            dom.editHistoryIndex = document.getElementById('editHistoryIndex');
            dom.historyPeriodDate = document.getElementById('historyPeriodDate');
            dom.historyCycleLength = document.getElementById('historyCycleLength');
            dom.cancelHistoryEditBtn = document.getElementById('cancelHistoryEditBtn');
            dom.saveHistoryEditBtn = document.getElementById('saveHistoryEditBtn');
            
            // Theme
            const savedTheme = localStorage.getItem("lunaTheme") || (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
            document.documentElement.classList.toggle("dark-mode", savedTheme === "dark");
            dom.themeToggle.checked = savedTheme === "dark";

            // Data
            try {
                const savedHistory = JSON.parse(localStorage.getItem("lunaCycleHistory"));
                 if (Array.isArray(savedHistory)) appState.cycleHistory = savedHistory;
            } catch (e) { console.error("Could not parse cycle history", e); }

            const savedSettings = JSON.parse(localStorage.getItem("lunaAppSettings"));
            if (savedSettings && savedSettings.startDate) {
                showTracker(savedSettings);
            } else {
                showSetup();
            }

            initializePickers();
            attachGlobalListeners();
        };

        loadData();

        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker.register("service-worker.js").catch(err => console.log("ServiceWorker registration failed: ", err));
            });
        }
    });
    </script>
</body>
</html>