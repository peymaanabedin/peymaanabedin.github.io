<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>مشاور تخصصی ایران پودر</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
    body { font-family: 'Vazirmatn', sans-serif; background: #f3f4f6; }
    .chat-container { max-width: 600px; margin: 32px auto; background: #fff; border-radius: 1.5rem; box-shadow: 0 10px 25px rgba(0,0,0,.09); display: flex; flex-direction: column; min-height: 85vh; max-height: 820px; }
    .chat-header { background: linear-gradient(90deg, #6366f1 70%, #818cf8 100%); color: #fff; padding: 1.6rem; text-align: center; font-size: 1.3rem; font-weight: bold; border-top-left-radius: 1.5rem; border-top-right-radius: 1.5rem; }
    .chat-messages { flex: 1; padding: 1.3rem; overflow-y: auto; display: flex; flex-direction: column; gap: 1.1rem; background: #f9fafb; }
    .message { max-width: 92%; padding: .82rem 1.08rem; border-radius: 1rem; line-height: 1.8; font-size: 1.1rem; }
    .message.user { background: #e0e7ff; align-self: flex-end; color: #3730a3; border-bottom-right-radius: .2rem; }
    .message.bot { background: #f0fdf4; align-self: flex-start; color: #047857; border-bottom-left-radius: .2rem; }
    .chat-input-container { display: flex; padding: 1.2rem; border-top: 1px solid #e5e7eb; background: #fff; border-bottom-left-radius: 1.5rem; border-bottom-right-radius: 1.5rem; }
    .chat-input { flex: 1; padding: 0.8rem 1rem; border: 1px solid #d1d5db; border-radius: 0.8rem; font-size: 1.1rem; outline: none; text-align: right; }
    .send-button { background: #6366f1; color: #fff; border: none; padding: 0.8rem 1.2rem; border-radius: 0.8rem; margin-right: 1rem; cursor: pointer; font-size: 1.15rem; }
    .loading-indicator { display: flex; align-items: center; justify-content: flex-start; padding: 0.7rem 1rem; border-radius: 1rem; background: #e0f2fe; align-self: flex-start; color: #2563eb; }
    .loading-indicator .dot { width: 8px; height: 8px; background: #2563eb; border-radius: 50%; margin: 0 2px; animation: bounce 0.65s infinite alternate; }
    .loading-indicator .dot:nth-child(2) { animation-delay: .22s; }
    .loading-indicator .dot:nth-child(3) { animation-delay: .44s; }
    @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-6px); } }
  </style>
</head>
<body>
<div class="chat-container">
  <div class="chat-header">مشاور تخصصی ایران پودر</div>
  <div class="chat-messages" id="chat-messages"></div>
  <div class="chat-input-container">
    <input type="text" id="user-input" class="chat-input" placeholder="پیام خود را بنویسید..." autocomplete="off" />
    <button id="send-button" class="send-button"><span>&#x1F680;</span></button>
  </div>
</div>
<script type="module">
// ========= تنظیمات ==========
const API_URL = "https://iranpowder.peymaancrafts.workers.dev/";

// لیست سوالات تعاملی و انسانی با توضیح
const FIELDS = [
  {
    key: "gender",
    ask: [
      "برای شروع، ممنون می‌شم بدونم خانم هستید یا آقا؟ این رو صرفاً برای اینکه برنامه تغذیه و مکمل دقیق‌تری تنظیم کنم می‌پرسم؛ چون شرایط بدنی بین خانم‌ها و آقایان فرق داره."
    ],
    validate: v => /^(خانم|آقا|مرد|زن)$/i.test(v.trim())
  },
  {
    key: "name",
    ask: [
      "ممنون بابت پاسختون 🌸 حالا اگه مشکلی نیست، اسمتون رو لطفاً کامل بنویسید. دوست دارم بدونم با چه کسی صحبت می‌کنم تا بتونم همه چیز رو شخصی‌سازی کنم."
    ],
    validate: v => v.trim().length >= 2
  },
  {
    key: "age",
    ask: [
      n => `عالی، ${n} عزیز! سن رو هم لطف می‌کنید بگید؟ فقط عدد کافیه. سن خیلی تو انتخاب نوع و مقدار مکمل و حتی توصیه‌های تمرینی مؤثره.`
    ],
    validate: v => /^\d+$/.test(v) && +v > 10 && +v < 100
  },
  {
    key: "height",
    ask: [
      n => `قدتون رو هم بفرمایید (سانتی‌متر). این به من کمک می‌کنه شاخص توده بدن رو دقیق‌تر محاسبه کنم.`
    ],
    validate: v => /^\d+$/.test(v) && +v > 100 && +v < 250
  },
  {
    key: "weight",
    ask: [
      "وزن فعلی‌تون رو هم لطفا دقیق بنویسید (کیلوگرم). وزن و قد مهم‌ترین پارامترها برای برنامه اصولی تغذیه و تمرین هستن."
    ],
    validate: v => /^\d+$/.test(v) && +v > 20 && +v < 300
  },
  {
    key: "goal",
    ask: [
      "هدف اصلی شما از مشاوره با ایران پودر چیه؟ مثلاً افزایش عضله، کاهش وزن، تناسب اندام، یا فقط انرژی و سلامتی بیشتر؟ هر چی به ذهن‌تون می‌رسه راحت بیان کنید."
    ],
    validate: v => v.trim().length > 2
  },
  {
    key: "trainingHistory",
    ask: [
      g => `در مورد سابقه ورزشی‌تون دوست دارم بدونم: چند ساله ورزش می‌کنید؟ چه ورزش‌هایی رو تا حالا جدی دنبال کردید؟ سطح خودتون رو مبتدی، متوسط یا حرفه‌ای می‌دونید؟`
    ],
    validate: v => v.trim().length > 2
  },
  {
    key: "dietActivity",
    ask: [
      g => "الان رژیم غذایی خاصی دارید؟ یا اینکه اصولاً چقدر به تغذیه و سبک زندگی سالم اهمیت می‌دید؟ چند روز در هفته ورزش می‌کنید؟"
    ],
    validate: v => v.trim().length > 2
  },
  {
    key: "healthAllergies",
    ask: [
      "آیا به ماده غذایی یا داروی خاصی حساسیت دارید یا تجربه واکنش حساسیتی داشتید؟ هر چیزی حتی خفیف هم باشه لطفا بنویسید. چون برای انتخاب مکمل‌ها خیلی مهمه."
    ],
    validate: v => true // هر پاسخی
  },
  {
    key: "illnessHistory",
    ask: [
      "آیا سابقه بیماری یا مصرف داروی خاصی دارید؟ حتی اگر بیماری مزمن یا کوتاه‌مدت بوده باشه یا دارویی مصرف می‌کنید، حتما بگید که مکملی که پیشنهاد می‌دم برای شما ایمن باشه."
    ],
    validate: v => true // هر پاسخی
  },
  {
    key: "phone",
    ask: [
      "اگر دوست داشتید، شماره تماس‌تون رو هم بنویسید (اختیاری). فقط برای پشتیبانی بیشتر، اگر لازم بود باهاتون هماهنگ می‌کنیم."
    ],
    validate: v => !v || /^(\+98|0)?9\d{9}$/.test(v.trim())
  }
];

const USER = {};
let STEP = 0, repeatCount = 0;
const chatMessages = document.getElementById("chat-messages");
const userInput = document.getElementById("user-input");
const sendButton = document.getElementById("send-button");

function appendMessage(text, sender) {
  const messageDiv = document.createElement("div");
  messageDiv.classList.add("message", sender);
  messageDiv.innerHTML = sender === "bot"
    ? text.replace(/ایران پودر/g, "<strong>ایران پودر</strong>")
    : text;
  chatMessages.appendChild(messageDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}
function showLoadingIndicator(text = "") {
  const loadingDiv = document.createElement("div");
  loadingDiv.classList.add("loading-indicator");
  loadingDiv.innerHTML = text
    ? `<span>${text}</span>`
    : `<div class="dot"></div><div class="dot"></div><div class="dot"></div>`;
  chatMessages.appendChild(loadingDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
  return loadingDiv;
}
function removeElement(element) {
  if (element && element.parentNode) element.parentNode.removeChild(element);
}
function toggleInput(enabled) {
  userInput.disabled = !enabled;
  sendButton.disabled = !enabled;
  if (enabled) userInput.focus();
}

function personalize(question, prevAnswers) {
  if (typeof question === "function") {
    // به تابع قبلی‌ها بده
    return question(prevAnswers.name || "", prevAnswers.goal || "");
  }
  return question;
}

function nextQuestion() {
  if (STEP >= FIELDS.length || (FIELDS[STEP].key === "phone" && Object.keys(USER).length === FIELDS.length - 1)) {
    appendMessage("خیلی خیلی ممنون بابت این توضیحات کامل! حالا بر اساس اطلاعات شما، مناسب‌ترین مکمل‌ها و برنامه را معرفی می‌کنم. چند لحظه صبر کن لطفا ...", "bot");
    handleRecommendation();
    return;
  }
  let qObj = FIELDS[STEP];
  let prevs = { ...USER };
  let qText = personalize(qObj.ask[0], prevs);
  appendMessage(qText, "bot");
  toggleInput(true);
}

async function handleRecommendation() {
  toggleInput(false);
  const loading = showLoadingIndicator("در حال بررسی تخصصی شرایط شما...");
  const prompt = `
    تو یک مشاور ورزشی-تغذیه‌ای بسیار بااخلاق، انسانی، همدل و خوش‌برخورد برای برند ایران پودر هستی.
    اطلاعات زیر متعلق به کاربر است:
    ${Object.entries(USER).map(([k,v])=>`${k}: ${v}`).join('\n')}
    با لحن کاملاً صمیمی و حرفه‌ای، توصیه‌ای بنویس که شامل:
    - خوشامد و احترام به کاربر و اشاره به اطلاعاتی که داده
    - تحلیل هدف، شرایط و سبک زندگی و پیشنهاد مکمل مناسب (حداکثر سه مورد)
    - توضیح دوستانه و علمی هر مکمل و دلیل انتخاب
    - قیمت و نحوه مصرف
    - جمع‌بندی و یک جمله انگیزشی یا پیشنهاد مشاوره بیشتر
    فقط جواب نهایی رو فارسی و کاملاً تعاملی بنویس.
  `;
  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: prompt }] }] })
    });
    removeElement(loading);
    const data = await res.json();
    let answer = (data?.candidates?.[0]?.content?.parts?.[0]?.text ?? "").trim();
    appendMessage(answer || "پاسخی دریافت نشد!", "bot");
    toggleInput(true);
  } catch (e) {
    removeElement(loading);
    appendMessage("متاسفانه سیستم مشاوره فعلا پاسخگو نیست. لطفاً چند دقیقه دیگر دوباره تلاش کنید.", "bot");
  }
}

async function handleUserInput() {
  const msg = userInput.value.trim();
  if (!msg) return;
  appendMessage(msg, "user");
  userInput.value = "";
  toggleInput(false);

  // اعتبارسنجی
  let field = FIELDS[STEP];
  if (field.validate(msg)) {
    // بازخورد مثبت
    if (field.key !== "phone")
      appendMessage(pickFeedback(field.key, msg), "bot");
    USER[field.key] = msg;
    STEP++;
    repeatCount = 0;
    setTimeout(() => nextQuestion(), 1000);
  } else {
    repeatCount++;
    if (repeatCount < 3) {
      appendMessage(
        `<span style='color:#d97706'>مطمئن نیستم جواب دقیق بود.</span> ${personalize(field.ask[0], USER)}`, "bot"
      );
      toggleInput(true);
    } else {
      appendMessage("اگر به هر دلیل مایل به پاسخ نیستید، فقط بنویسید «رد» یا «هیچ» تا رد شود.", "bot");
      toggleInput(true);
      repeatCount = 0;
    }
  }
}

// بازخوردهای دوستانه و تعاملی بر اساس نوع جواب
function pickFeedback(field, answer) {
  if (!answer.trim()) return "";
  if (["gender","name","age","height","weight"].includes(field)) {
    return [
      "عالی، مرسی که جواب دادی! 😊",
      "سپاس از دقتت. اطلاعات خیلی کمک می‌کنه.",
      "فوق‌العاده! می‌ریم سراغ سوال بعد."
    ][Math.floor(Math.random()*3)];
  }
  if (field === "goal") return "چقدر انگیزه‌ات جالبه! هدف رو عالی گفتی.";
  if (field === "trainingHistory") return "سابقه‌ ورزشی‌ات خیلی مهمه. ممنون که توضیح دادی!";
  if (field === "dietActivity") return "خب حالا با این توضیحات بهتر می‌تونم کمک کنم!";
  if (field === "healthAllergies" || field === "illnessHistory") {
    if (/^(نه|ندارم|خیر|نداریم|هیچ)/i.test(answer)) return "خوشحالم که مشکلی نداری، اما اگر هر وقت چیزی یادت اومد، بهم بگو.";
    return "ممنون بابت دقت و صداقتت. این مورد رو حتما لحاظ می‌کنم.";
  }
  return "";
}

// ==== شروع مکالمه ====
function startConversation() {
  appendMessage(
    "سلام و خوش اومدی به چت تخصصی <strong>ایران پودر</strong> 🌟<br>این گفت‌وگو کاملاً محرمانه است و فقط هدفش اینه که برنامه دقیق و مناسب شرایط تو پیدا کنیم. هر سوالی داشتی وسط کار بپرس.<br>خب، بریم سراغ سوالات!",
    "bot"
  );
  setTimeout(() => nextQuestion(), 1200);
  toggleInput(true);
}

sendButton.addEventListener("click", handleUserInput);
userInput.addEventListener("keypress", e => {
  if (e.key === "Enter" && !userInput.disabled) handleUserInput();
});
window.onload = startConversation;
</script>
</body>
</html>
