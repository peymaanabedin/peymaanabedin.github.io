<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>مشاور تخصصی آذرپودر</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
    body { font-family: 'Vazirmatn', sans-serif; background: #f3f4f6; }
    .chat-container { max-width: 600px; margin: 32px auto; background: #fff; border-radius: 1.5rem; box-shadow: 0 10px 25px rgba(0,0,0,.09); display: flex; flex-direction: column; min-height: 85vh; max-height: 820px; }
    .chat-header { background: linear-gradient(90deg, #6366f1 70%, #818cf8 100%); color: #fff; padding: 1.6rem; text-align: center; font-size: 1.3rem; font-weight: bold; border-top-left-radius: 1.5rem; border-top-right-radius: 1.5rem; }
    .chat-messages { flex: 1; padding: 1.3rem; overflow-y: auto; display: flex; flex-direction: column; gap: 1.1rem; background: #f9fafb; }
    .message { max-width: 92%; padding: .82rem 1.08rem; border-radius: 1rem; line-height: 1.8; font-size: 1.1rem; }
    .message.user { background: #e0e7ff; align-self: flex-end; color: #3730a3; border-bottom-right-radius: .2rem; }
    .message.bot { background: #f0fdf4; align-self: flex-start; color: #047857; border-bottom-left-radius: .2rem; }
    .chat-input-container { display: flex; padding: 1.2rem; border-top: 1px solid #e5e7eb; background: #fff; border-bottom-left-radius: 1.5rem; border-bottom-right-radius: 1.5rem; }
    .chat-input { flex: 1; padding: 0.8rem 1rem; border: 1px solid #d1d5db; border-radius: 0.8rem; font-size: 1.1rem; outline: none; text-align: right; }
    .send-button { background: #6366f1; color: #fff; border: none; padding: 0.8rem 1.2rem; border-radius: 0.8rem; margin-right: 1rem; cursor: pointer; font-size: 1.15rem; }
    .loading-indicator { display: flex; align-items: center; justify-content: flex-start; padding: 0.7rem 1rem; border-radius: 1rem; background: #e0f2fe; align-self: flex-start; color: #2563eb; }
    .loading-indicator .dot { width: 8px; height: 8px; background: #2563eb; border-radius: 50%; margin: 0 2px; animation: bounce 0.65s infinite alternate; }
    .loading-indicator .dot:nth-child(2) { animation-delay: .22s; }
    .loading-indicator .dot:nth-child(3) { animation-delay: .44s; }
    @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-6px); } }
  </style>
</head>
<body>
<div class="chat-container">
  <div class="chat-header">مشاور تخصصی آذرپودر</div>
  <div class="chat-messages" id="chat-messages"></div>
  <div class="chat-input-container">
    <input type="text" id="user-input" class="chat-input" placeholder="پاسخ یا سوال خود را بنویسید..." autocomplete="off" />
    <button id="send-button" class="send-button"><span>&#x1F680;</span></button>
  </div>
</div>
<script type="module">
// =======================
// فقط آدرس Worker خودت را قرار بده:
const API_URL = "https://iranpowder.peymaancrafts.workers.dev/";
// =======================

// محصولات نمونه برند آذرپودر
const azarpowderProducts = [
  { name: "پروتئین وی کنسانتره آذرپودر", price: "۲,۹۰۰,۰۰۰ تومان", url: "protein-whey", howToUse: "یک پیمانه (۲۵ گرم) بلافاصله پس از تمرین و یک پیمانه صبح ناشتا", sideEffects: "در افراد حساس به لاکتوز ممکن است موجب نفخ شود.", description: "پروتئین وی با جذب سریع، کمک به ریکاوری عضلانی و حفظ توده عضلانی، مناسب ورزشکاران قدرتی و بدنسازها." },
  { name: "گینر پرکالری آذرپودر", price: "۲,۴۰۰,۰۰۰ تومان", url: "gainer", howToUse: "دو پیمانه در روز (میان وعده و بعد تمرین)", sideEffects: "در صورت مصرف زیاد ممکن است موجب افزایش چربی شود.", description: "گینر حاوی کربوهیدرات و پروتئین بالا، مناسب افزایش وزن و حجم عضلانی سریع." },
  { name: "کراتین مونوهیدرات آذرپودر", price: "۱,۲۰۰,۰۰۰ تومان", url: "creatine-monohydrate", howToUse: "۵ گرم روزانه همراه آب، ترجیحاً بعد تمرین", sideEffects: "مصرف آب کافی ضروری است، ممکن است موجب احتباس آب در عضلات شود.", description: "کراتین موجب افزایش قدرت، ریکاوری سریع‌تر و افزایش توان عضلات در تمرینات شدید می‌شود." },
  { name: "آمینواسید شاخه‌دار (BCAA) آذرپودر", price: "۱,۵۰۰,۰۰۰ تومان", url: "bcaa", howToUse: "۱۰ گرم قبل یا حین تمرین", sideEffects: "در دوزهای معمول بی‌خطر است.", description: "BCAA برای جلوگیری از تجزیه عضلات و کاهش خستگی در تمرینات طولانی و هوازی کاربرد دارد." },
  { name: "گلوتامین آذرپودر", price: "۱,۱۰۰,۰۰۰ تومان", url: "glutamine", howToUse: "۵ گرم پس از تمرین و قبل خواب", sideEffects: "به طور معمول بی‌عارضه است.", description: "گلوتامین به ریکاوری، تقویت سیستم ایمنی و کاهش درد عضلانی کمک می‌کند." },
  { name: "مولتی‌ویتامین ورزشی آذرپودر", price: "۸۵۰,۰۰۰ تومان", url: "multi-vitamin", howToUse: "یک عدد قرص همراه صبحانه", sideEffects: "مصرف بیش از حد ویتامین A و D توصیه نمی‌شود.", description: "حاوی ویتامین‌ها و مواد معدنی لازم برای ورزشکاران جهت تأمین نیاز روزانه و حمایت از عملکرد بدن." },
  { name: "پمپ (Pre-workout) آذرپودر", price: "۱,۸۰۰,۰۰۰ تومان", url: "preworkout", howToUse: "یک پیمانه ۳۰ دقیقه قبل از تمرین", sideEffects: "افراد با فشار خون بالا یا مشکلات قلبی با مشورت پزشک مصرف کنند.", description: "افزایش انرژی، تمرکز و خون‌رسانی عضلات جهت اجرای تمرین پرفشار." },
  { name: "اُمگا۳ آذرپودر", price: "۹۰۰,۰۰۰ تومان", url: "omega-3", howToUse: "یک عدد کپسول همراه ناهار", sideEffects: "در افراد با حساسیت به ماهی منع مصرف دارد.", description: "تقویت سلامت قلب، کاهش التهاب و کمک به ریکاوری عضلانی." },
  { name: "کپسول ویتامین D3 آذرپودر (۵۰۰۰ واحد)", price: "۶۰۰,۰۰۰ تومان", url: "vitamin-d3", howToUse: "هفته‌ای دو تا سه بار یک عدد بعد غذا", sideEffects: "مصرف بیش از حد می‌تواند مشکلات کبدی ایجاد کند.", description: "حفظ سلامت استخوان و تنظیم هورمون‌های بدن برای ورزشکاران." }
];

// قانون تک‌سوالی و مدیریت تکرار پرسش
const FIELDS = [
  {
    key: "gender",
    ask: [
      "ابتدا لطفاً مشخص کنید خانم هستید یا آقا؟ این مورد صرفاً برای تنظیم مشاوره علمی دقیق مهم است."
    ],
    validate: v => /^(خانم|آقا|مرد|زن)$/i.test(v.trim())
  },
  {
    key: "name",
    ask: [
      "ممنون! اسمتون رو می‌فرمایید؟ این کمک می‌کنه با احترام بیشتری مخاطب قرار بدم و برنامه کاملاً شخصی پیشنهاد کنم."
    ],
    validate: v => v.trim().length >= 2
  },
  {
    key: "age",
    ask: [
      n => `${n ? n + " عزیز، " : ""}سن شما رو بدونم لطفاً؟ فقط عدد کافیه. سن برای تعیین نوع مکمل و توصیه‌های علمی مهمه.`
    ],
    validate: v => /^\d+$/.test(v) && +v > 10 && +v < 100
  },
  {
    key: "height",
    ask: [
      "قدتون چند سانتی‌متر هست؟ این مورد برای محاسبه شاخص‌های وزنی و تناسب اندام ضروریه."
    ],
    validate: v => /^\d+$/.test(v) && +v > 100 && +v < 250
  },
  {
    key: "weight",
    ask: [
      "وزن فعلی‌تون چند کیلوگرمه؟ لطفاً عدد دقیق رو بنویسید."
    ],
    validate: v => /^\d+$/.test(v) && +v > 20 && +v < 300
  },
  {
    key: "goal",
    ask: [
      "هدفتون از این مشاوره رو دقیق بگید: افزایش عضله؟ کاهش وزن؟ تناسب اندام؟ یا فقط سلامتی و نشاط؟"
    ],
    validate: v => v.trim().length > 2
  },
  {
    key: "trainingHistory",
    ask: [
      "سابقه ورزشی دارید؟ چند ساله ورزش می‌کنید و چه ورزش‌هایی رو جدی‌تر انجام دادید؟"
    ],
    validate: v => v.trim().length > 2
  },
  {
    key: "dietActivity",
    ask: [
      "آیا رژیم غذایی خاصی دارید یا سبک تغذیه خاصی رو رعایت می‌کنید؟ میزان فعالیت و ورزش‌تون رو هم لطفا توضیح بدید."
    ],
    validate: v => v.trim().length > 2
  },
  {
    key: "healthAllergies",
    ask: [
      "به دارو یا ماده غذایی خاصی حساسیت دارید؟ هر چیزی حتی خفیف باشه هم مهمه و باید بدونم."
    ],
    validate: v => true
  },
  {
    key: "illnessHistory",
    ask: [
      "سابقه بیماری یا مصرف داروی خاصی دارید؟ این اطلاعات در توصیه مکمل‌های ایمن و علمی اهمیت زیادی داره."
    ],
    validate: v => true
  },
  {
    key: "phone",
    ask: [
      "اگر دوست دارید، شماره تماس‌تون رو بنویسید (اختیاری). پشتیبانی فقط برای هماهنگی و پیگیری استفاده می‌شه."
    ],
    validate: v => !v || /^(\+98|0)?9\d{9}$/.test(v.trim())
  }
];

const USER = {};
let STEP = 0, repeatCount = 0;
const chatMessages = document.getElementById("chat-messages");
const userInput = document.getElementById("user-input");
const sendButton = document.getElementById("send-button");

function appendMessage(text, sender) {
  const messageDiv = document.createElement("div");
  messageDiv.classList.add("message", sender);
  messageDiv.innerHTML = sender === "bot"
    ? text.replace(/آذرپودر/g, "<strong>آذرپودر</strong>")
    : text;
  chatMessages.appendChild(messageDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}
function showLoadingIndicator(text = "") {
  const loadingDiv = document.createElement("div");
  loadingDiv.classList.add("loading-indicator");
  loadingDiv.innerHTML = text
    ? `<span>${text}</span>`
    : `<div class="dot"></div><div class="dot"></div><div class="dot"></div>`;
  chatMessages.appendChild(loadingDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
  return loadingDiv;
}
function removeElement(element) {
  if (element && element.parentNode) element.parentNode.removeChild(element);
}
function toggleInput(enabled) {
  userInput.disabled = !enabled;
  sendButton.disabled = !enabled;
  if (enabled) userInput.focus();
}

function personalize(question, prevAnswers) {
  if (typeof question === "function") {
    return question(prevAnswers.name || "", prevAnswers.goal || "");
  }
  return question;
}

function nextQuestion(isRepeat = false) {
  if (STEP >= FIELDS.length || (FIELDS[STEP].key === "phone" && Object.keys(USER).length === FIELDS.length - 1)) {
    appendMessage("سپاس بابت پاسخ‌های دقیق! حالا مشاوره تخصصی و پیشنهاد بهترین مکمل‌های آذرپودر رو می‌فرستم. چند لحظه صبر کنید ...", "bot");
    handleRecommendation();
    return;
  }
  let qObj = FIELDS[STEP];
  let prevs = { ...USER };
  let qText = personalize(qObj.ask[0], prevs);
  if (isRepeat) {
    qText = "<span style='color:#d97706'>پاسخ شما مبهم بود. این سوال مهمه و لازمه فقط به همین سوال جواب بدید:</span><br>" + qText;
  }
  appendMessage(qText, "bot");
  toggleInput(true);
}

async function handleRecommendation() {
  toggleInput(false);
  const loading = showLoadingIndicator("در حال بررسی تخصصی شرایط شما...");
  // آماده‌سازی متن معرفی محصولات و لینک خرید
  const productsText = azarpowderProducts.map(p =>
    `- ${p.name}: ${p.description} | <b>قیمت:</b> ${p.price} | <b>نحوه مصرف:</b> ${p.howToUse} | <b>عوارض:</b> ${p.sideEffects} | <a href="https://azar-powder.com/product/${p.url}" target="_blank">خرید آنلاین</a>`
  ).join('\n');

  const prompt = `
  تو یک مشاور حرفه‌ای ورزشی و تغذیه‌ای برای برند آذرپودر هستی و با توجه به اطلاعات زیر، فقط باید مشاوره تخصصی و دقیق و تحلیلی بدهی:
  اطلاعات کامل کاربر:
  ${Object.entries(USER).map(([k,v])=>`${k}: ${v}`).join('\n')}
  
  لیست مکمل‌ها و محصولات آذرپودر:
  ${productsText}
  
  قوانین پاسخ:
  ۱. خروجی فقط به زبان فارسی و لحن کاملاً انسانی و حرفه‌ای، با تحلیل عمیق و توضیحات علمی باشد.
  ۲. حداقل ۲۰۰ کلمه بنویس و هر مکمل پیشنهادی را مفصل تحلیل کن، دلیل علمی انتخاب، هشدارها و نحوه مصرف کامل توضیح داده شود.
  ۳. برای هر مکمل پیشنهادی، لینک خرید را مطابق نمونه بالا در پاسخ قرار بده.
  ۴. اگر کاربر بیماری یا حساسیت دارد، محدودیت‌های مهم را یادآوری کن.
  ۵. هیچ‌وقت بیشتر از یک پیشنهاد را در یک پاراگراف ننویس (تحلیل هر مکمل در پاراگراف جدا).
  ۶. هیچ‌وقت تبلیغ مستقیم یا اغراق ننویس و صادق باش.
  ۷. جمع‌بندی و جمله انگیزشی فراموش نشود.
  فقط متن آماده برای نمایش به کاربر ارسال شود (بدون تگ اضافی یا خروجی JSON).
  `;

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: prompt }] }] })
    });
    removeElement(loading);
    const data = await res.json();
    let answer = (data?.candidates?.[0]?.content?.parts?.[0]?.text ?? "").trim();
    appendMessage(answer || "پاسخی دریافت نشد!", "bot");
    toggleInput(true);
  } catch (e) {
    removeElement(loading);
    appendMessage("متاسفانه سیستم مشاوره فعلا پاسخگو نیست. لطفاً چند دقیقه دیگر دوباره تلاش کنید.", "bot");
  }
}

async function handleUserInput() {
  const msg = userInput.value.trim();
  if (!msg) return;
  appendMessage(msg, "user");
  userInput.value = "";
  toggleInput(false);

  // اعتبارسنجی
  let field = FIELDS[STEP];
  if (field.validate(msg)) {
    USER[field.key] = msg;
    repeatCount = 0;
    setTimeout(() => nextQuestion(false), 800);
  } else {
    repeatCount++;
    if (repeatCount < 3) {
      setTimeout(() => nextQuestion(true), 600);
    } else {
      appendMessage("اگر نمی‌خواهید به این سوال جواب بدید، فقط بنویسید «رد» تا سوال بعدی پرسیده شود.", "bot");
      toggleInput(true);
      repeatCount = 0;
    }
  }
}

// شروع گفتگو
function startConversation() {
  appendMessage(
    "سلام به شما! 👋<br>به مشاوره تخصصی <strong>آذرپودر</strong> خوش آمدید.<br>در هر مرحله فقط یک سؤال پرسیده می‌شود و هیچ‌وقت دو سؤال با هم مطرح نخواهد شد.<br>اگر به سؤالی جواب ندادید، مجدد همان سؤال را با لحن جدید می‌پرسم. بریم سراغ اولین سؤال:",
    "bot"
  );
  setTimeout(() => nextQuestion(), 1200);
  toggleInput(true);
}

sendButton.addEventListener("click", handleUserInput);
userInput.addEventListener("keypress", e => {
  if (e.key === "Enter" && !userInput.disabled) handleUserInput();
});
window.onload = startConversation;
</script>
</body>
</html>
