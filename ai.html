<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù…Ø´Ø§ÙˆØ± ØªØ®ØµØµÛŒ Ø¢Ø°Ø±Ù¾ÙˆØ¯Ø±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
    body { font-family: 'Vazirmatn', sans-serif; background: #f3f4f6; }
    .chat-container { max-width: 600px; margin: 32px auto; background: #fff; border-radius: 1.5rem; box-shadow: 0 10px 25px rgba(0,0,0,.09); display: flex; flex-direction: column; min-height: 85vh; max-height: 820px; }
    .chat-header { background: linear-gradient(90deg, #6366f1 70%, #818cf8 100%); color: #fff; padding: 1.6rem; text-align: center; font-size: 1.3rem; font-weight: bold; border-top-left-radius: 1.5rem; border-top-right-radius: 1.5rem; }
    .chat-messages { flex: 1; padding: 1.3rem; overflow-y: auto; display: flex; flex-direction: column; gap: 1.1rem; background: #f9fafb; }
    .message { max-width: 92%; padding: .82rem 1.08rem; border-radius: 1rem; line-height: 1.8; font-size: 1.1rem; }
    .message.user { background: #e0e7ff; align-self: flex-end; color: #3730a3; border-bottom-right-radius: .2rem; }
    .message.bot { background: #f0fdf4; align-self: flex-start; color: #047857; border-bottom-left-radius: .2rem; }
    .chat-input-container { display: flex; padding: 1.2rem; border-top: 1px solid #e5e7eb; background: #fff; border-bottom-left-radius: 1.5rem; border-bottom-right-radius: 1.5rem; }
    .chat-input { flex: 1; padding: 0.8rem 1rem; border: 1px solid #d1d5db; border-radius: 0.8rem; font-size: 1.1rem; outline: none; text-align: right; }
    .send-button { background: #6366f1; color: #fff; border: none; padding: 0.8rem 1.2rem; border-radius: 0.8rem; margin-right: 1rem; cursor: pointer; font-size: 1.15rem; }
    .loading-indicator { display: flex; align-items: center; justify-content: flex-start; padding: 0.7rem 1rem; border-radius: 1rem; background: #e0f2fe; align-self: flex-start; color: #2563eb; }
    .loading-indicator .dot { width: 8px; height: 8px; background: #2563eb; border-radius: 50%; margin: 0 2px; animation: bounce 0.65s infinite alternate; }
    .loading-indicator .dot:nth-child(2) { animation-delay: .22s; }
    .loading-indicator .dot:nth-child(3) { animation-delay: .44s; }
    @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-6px); } }
  </style>
</head>
<body>
<div class="chat-container">
  <div class="chat-header">Ù…Ø´Ø§ÙˆØ± ØªØ®ØµØµÛŒ Ø¢Ø°Ø±Ù¾ÙˆØ¯Ø±</div>
  <div class="chat-messages" id="chat-messages"></div>
  <div class="chat-input-container">
    <input type="text" id="user-input" class="chat-input" placeholder="Ù¾Ø§Ø³Ø® ÛŒØ§ Ø³ÙˆØ§Ù„ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." autocomplete="off" />
    <button id="send-button" class="send-button"><span>&#x1F680;</span></button>
  </div>
</div>
<script type="module">
// =======================
// ÙÙ‚Ø· Ø¢Ø¯Ø±Ø³ Worker Ø®ÙˆØ¯Øª Ø±Ø§ Ù‚Ø±Ø§Ø± Ø¨Ø¯Ù‡:
const API_URL = "https://iranpowder.peymaancrafts.workers.dev/";
// =======================

// Ù…Ø­ØµÙˆÙ„Ø§Øª Ù†Ù…ÙˆÙ†Ù‡ Ø¨Ø±Ù†Ø¯ Ø¢Ø°Ø±Ù¾ÙˆØ¯Ø±
const azarpowderProducts = [
  { name: "Ù¾Ø±ÙˆØªØ¦ÛŒÙ† ÙˆÛŒ Ú©Ù†Ø³Ø§Ù†ØªØ±Ù‡ Ø¢Ø°Ø±Ù¾ÙˆØ¯Ø±", price: "Û²,Û¹Û°Û°,Û°Û°Û° ØªÙˆÙ…Ø§Ù†", url: "protein-whey", howToUse: "ÛŒÚ© Ù¾ÛŒÙ…Ø§Ù†Ù‡ (Û²Ûµ Ú¯Ø±Ù…) Ø¨Ù„Ø§ÙØ§ØµÙ„Ù‡ Ù¾Ø³ Ø§Ø² ØªÙ…Ø±ÛŒÙ† Ùˆ ÛŒÚ© Ù¾ÛŒÙ…Ø§Ù†Ù‡ ØµØ¨Ø­ Ù†Ø§Ø´ØªØ§", sideEffects: "Ø¯Ø± Ø§ÙØ±Ø§Ø¯ Ø­Ø³Ø§Ø³ Ø¨Ù‡ Ù„Ø§Ú©ØªÙˆØ² Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù…ÙˆØ¬Ø¨ Ù†ÙØ® Ø´ÙˆØ¯.", description: "Ù¾Ø±ÙˆØªØ¦ÛŒÙ† ÙˆÛŒ Ø¨Ø§ Ø¬Ø°Ø¨ Ø³Ø±ÛŒØ¹ØŒ Ú©Ù…Ú© Ø¨Ù‡ Ø±ÛŒÚ©Ø§ÙˆØ±ÛŒ Ø¹Ø¶Ù„Ø§Ù†ÛŒ Ùˆ Ø­ÙØ¸ ØªÙˆØ¯Ù‡ Ø¹Ø¶Ù„Ø§Ù†ÛŒØŒ Ù…Ù†Ø§Ø³Ø¨ ÙˆØ±Ø²Ø´Ú©Ø§Ø±Ø§Ù† Ù‚Ø¯Ø±ØªÛŒ Ùˆ Ø¨Ø¯Ù†Ø³Ø§Ø²Ù‡Ø§." },
  { name: "Ú¯ÛŒÙ†Ø± Ù¾Ø±Ú©Ø§Ù„Ø±ÛŒ Ø¢Ø°Ø±Ù¾ÙˆØ¯Ø±", price: "Û²,Û´Û°Û°,Û°Û°Û° ØªÙˆÙ…Ø§Ù†", url: "gainer", howToUse: "Ø¯Ùˆ Ù¾ÛŒÙ…Ø§Ù†Ù‡ Ø¯Ø± Ø±ÙˆØ² (Ù…ÛŒØ§Ù† ÙˆØ¹Ø¯Ù‡ Ùˆ Ø¨Ø¹Ø¯ ØªÙ…Ø±ÛŒÙ†)", sideEffects: "Ø¯Ø± ØµÙˆØ±Øª Ù…ØµØ±Ù Ø²ÛŒØ§Ø¯ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù…ÙˆØ¬Ø¨ Ø§ÙØ²Ø§ÛŒØ´ Ú†Ø±Ø¨ÛŒ Ø´ÙˆØ¯.", description: "Ú¯ÛŒÙ†Ø± Ø­Ø§ÙˆÛŒ Ú©Ø±Ø¨ÙˆÙ‡ÛŒØ¯Ø±Ø§Øª Ùˆ Ù¾Ø±ÙˆØªØ¦ÛŒÙ† Ø¨Ø§Ù„Ø§ØŒ Ù…Ù†Ø§Ø³Ø¨ Ø§ÙØ²Ø§ÛŒØ´ ÙˆØ²Ù† Ùˆ Ø­Ø¬Ù… Ø¹Ø¶Ù„Ø§Ù†ÛŒ Ø³Ø±ÛŒØ¹." },
  { name: "Ú©Ø±Ø§ØªÛŒÙ† Ù…ÙˆÙ†ÙˆÙ‡ÛŒØ¯Ø±Ø§Øª Ø¢Ø°Ø±Ù¾ÙˆØ¯Ø±", price: "Û±,Û²Û°Û°,Û°Û°Û° ØªÙˆÙ…Ø§Ù†", url: "creatine-monohydrate", howToUse: "Ûµ Ú¯Ø±Ù… Ø±ÙˆØ²Ø§Ù†Ù‡ Ù‡Ù…Ø±Ø§Ù‡ Ø¢Ø¨ØŒ ØªØ±Ø¬ÛŒØ­Ø§Ù‹ Ø¨Ø¹Ø¯ ØªÙ…Ø±ÛŒÙ†", sideEffects: "Ù…ØµØ±Ù Ø¢Ø¨ Ú©Ø§ÙÛŒ Ø¶Ø±ÙˆØ±ÛŒ Ø§Ø³ØªØŒ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù…ÙˆØ¬Ø¨ Ø§Ø­ØªØ¨Ø§Ø³ Ø¢Ø¨ Ø¯Ø± Ø¹Ø¶Ù„Ø§Øª Ø´ÙˆØ¯.", description: "Ú©Ø±Ø§ØªÛŒÙ† Ù…ÙˆØ¬Ø¨ Ø§ÙØ²Ø§ÛŒØ´ Ù‚Ø¯Ø±ØªØŒ Ø±ÛŒÚ©Ø§ÙˆØ±ÛŒ Ø³Ø±ÛŒØ¹â€ŒØªØ± Ùˆ Ø§ÙØ²Ø§ÛŒØ´ ØªÙˆØ§Ù† Ø¹Ø¶Ù„Ø§Øª Ø¯Ø± ØªÙ…Ø±ÛŒÙ†Ø§Øª Ø´Ø¯ÛŒØ¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯." },
  { name: "Ø¢Ù…ÛŒÙ†ÙˆØ§Ø³ÛŒØ¯ Ø´Ø§Ø®Ù‡â€ŒØ¯Ø§Ø± (BCAA) Ø¢Ø°Ø±Ù¾ÙˆØ¯Ø±", price: "Û±,ÛµÛ°Û°,Û°Û°Û° ØªÙˆÙ…Ø§Ù†", url: "bcaa", howToUse: "Û±Û° Ú¯Ø±Ù… Ù‚Ø¨Ù„ ÛŒØ§ Ø­ÛŒÙ† ØªÙ…Ø±ÛŒÙ†", sideEffects: "Ø¯Ø± Ø¯ÙˆØ²Ù‡Ø§ÛŒ Ù…Ø¹Ù…ÙˆÙ„ Ø¨ÛŒâ€ŒØ®Ø·Ø± Ø§Ø³Øª.", description: "BCAA Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªØ¬Ø²ÛŒÙ‡ Ø¹Ø¶Ù„Ø§Øª Ùˆ Ú©Ø§Ù‡Ø´ Ø®Ø³ØªÚ¯ÛŒ Ø¯Ø± ØªÙ…Ø±ÛŒÙ†Ø§Øª Ø·ÙˆÙ„Ø§Ù†ÛŒ Ùˆ Ù‡ÙˆØ§Ø²ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø¯ Ø¯Ø§Ø±Ø¯." },
  { name: "Ú¯Ù„ÙˆØªØ§Ù…ÛŒÙ† Ø¢Ø°Ø±Ù¾ÙˆØ¯Ø±", price: "Û±,Û±Û°Û°,Û°Û°Û° ØªÙˆÙ…Ø§Ù†", url: "glutamine", howToUse: "Ûµ Ú¯Ø±Ù… Ù¾Ø³ Ø§Ø² ØªÙ…Ø±ÛŒÙ† Ùˆ Ù‚Ø¨Ù„ Ø®ÙˆØ§Ø¨", sideEffects: "Ø¨Ù‡ Ø·ÙˆØ± Ù…Ø¹Ù…ÙˆÙ„ Ø¨ÛŒâ€ŒØ¹Ø§Ø±Ø¶Ù‡ Ø§Ø³Øª.", description: "Ú¯Ù„ÙˆØªØ§Ù…ÛŒÙ† Ø¨Ù‡ Ø±ÛŒÚ©Ø§ÙˆØ±ÛŒØŒ ØªÙ‚ÙˆÛŒØª Ø³ÛŒØ³ØªÙ… Ø§ÛŒÙ…Ù†ÛŒ Ùˆ Ú©Ø§Ù‡Ø´ Ø¯Ø±Ø¯ Ø¹Ø¶Ù„Ø§Ù†ÛŒ Ú©Ù…Ú© Ù…ÛŒâ€ŒÚ©Ù†Ø¯." },
  { name: "Ù…ÙˆÙ„ØªÛŒâ€ŒÙˆÛŒØªØ§Ù…ÛŒÙ† ÙˆØ±Ø²Ø´ÛŒ Ø¢Ø°Ø±Ù¾ÙˆØ¯Ø±", price: "Û¸ÛµÛ°,Û°Û°Û° ØªÙˆÙ…Ø§Ù†", url: "multi-vitamin", howToUse: "ÛŒÚ© Ø¹Ø¯Ø¯ Ù‚Ø±Øµ Ù‡Ù…Ø±Ø§Ù‡ ØµØ¨Ø­Ø§Ù†Ù‡", sideEffects: "Ù…ØµØ±Ù Ø¨ÛŒØ´ Ø§Ø² Ø­Ø¯ ÙˆÛŒØªØ§Ù…ÛŒÙ† A Ùˆ D ØªÙˆØµÛŒÙ‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯.", description: "Ø­Ø§ÙˆÛŒ ÙˆÛŒØªØ§Ù…ÛŒÙ†â€ŒÙ‡Ø§ Ùˆ Ù…ÙˆØ§Ø¯ Ù…Ø¹Ø¯Ù†ÛŒ Ù„Ø§Ø²Ù… Ø¨Ø±Ø§ÛŒ ÙˆØ±Ø²Ø´Ú©Ø§Ø±Ø§Ù† Ø¬Ù‡Øª ØªØ£Ù…ÛŒÙ† Ù†ÛŒØ§Ø² Ø±ÙˆØ²Ø§Ù†Ù‡ Ùˆ Ø­Ù…Ø§ÛŒØª Ø§Ø² Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø¨Ø¯Ù†." },
  { name: "Ù¾Ù…Ù¾ (Pre-workout) Ø¢Ø°Ø±Ù¾ÙˆØ¯Ø±", price: "Û±,Û¸Û°Û°,Û°Û°Û° ØªÙˆÙ…Ø§Ù†", url: "preworkout", howToUse: "ÛŒÚ© Ù¾ÛŒÙ…Ø§Ù†Ù‡ Û³Û° Ø¯Ù‚ÛŒÙ‚Ù‡ Ù‚Ø¨Ù„ Ø§Ø² ØªÙ…Ø±ÛŒÙ†", sideEffects: "Ø§ÙØ±Ø§Ø¯ Ø¨Ø§ ÙØ´Ø§Ø± Ø®ÙˆÙ† Ø¨Ø§Ù„Ø§ ÛŒØ§ Ù…Ø´Ú©Ù„Ø§Øª Ù‚Ù„Ø¨ÛŒ Ø¨Ø§ Ù…Ø´ÙˆØ±Øª Ù¾Ø²Ø´Ú© Ù…ØµØ±Ù Ú©Ù†Ù†Ø¯.", description: "Ø§ÙØ²Ø§ÛŒØ´ Ø§Ù†Ø±Ú˜ÛŒØŒ ØªÙ…Ø±Ú©Ø² Ùˆ Ø®ÙˆÙ†â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¹Ø¶Ù„Ø§Øª Ø¬Ù‡Øª Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø±ÛŒÙ† Ù¾Ø±ÙØ´Ø§Ø±." },
  { name: "Ø§ÙÙ…Ú¯Ø§Û³ Ø¢Ø°Ø±Ù¾ÙˆØ¯Ø±", price: "Û¹Û°Û°,Û°Û°Û° ØªÙˆÙ…Ø§Ù†", url: "omega-3", howToUse: "ÛŒÚ© Ø¹Ø¯Ø¯ Ú©Ù¾Ø³ÙˆÙ„ Ù‡Ù…Ø±Ø§Ù‡ Ù†Ø§Ù‡Ø§Ø±", sideEffects: "Ø¯Ø± Ø§ÙØ±Ø§Ø¯ Ø¨Ø§ Ø­Ø³Ø§Ø³ÛŒØª Ø¨Ù‡ Ù…Ø§Ù‡ÛŒ Ù…Ù†Ø¹ Ù…ØµØ±Ù Ø¯Ø§Ø±Ø¯.", description: "ØªÙ‚ÙˆÛŒØª Ø³Ù„Ø§Ù…Øª Ù‚Ù„Ø¨ØŒ Ú©Ø§Ù‡Ø´ Ø§Ù„ØªÙ‡Ø§Ø¨ Ùˆ Ú©Ù…Ú© Ø¨Ù‡ Ø±ÛŒÚ©Ø§ÙˆØ±ÛŒ Ø¹Ø¶Ù„Ø§Ù†ÛŒ." },
  { name: "Ú©Ù¾Ø³ÙˆÙ„ ÙˆÛŒØªØ§Ù…ÛŒÙ† D3 Ø¢Ø°Ø±Ù¾ÙˆØ¯Ø± (ÛµÛ°Û°Û° ÙˆØ§Ø­Ø¯)", price: "Û¶Û°Û°,Û°Û°Û° ØªÙˆÙ…Ø§Ù†", url: "vitamin-d3", howToUse: "Ù‡ÙØªÙ‡â€ŒØ§ÛŒ Ø¯Ùˆ ØªØ§ Ø³Ù‡ Ø¨Ø§Ø± ÛŒÚ© Ø¹Ø¯Ø¯ Ø¨Ø¹Ø¯ ØºØ°Ø§", sideEffects: "Ù…ØµØ±Ù Ø¨ÛŒØ´ Ø§Ø² Ø­Ø¯ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ù…Ø´Ú©Ù„Ø§Øª Ú©Ø¨Ø¯ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†Ø¯.", description: "Ø­ÙØ¸ Ø³Ù„Ø§Ù…Øª Ø§Ø³ØªØ®ÙˆØ§Ù† Ùˆ ØªÙ†Ø¸ÛŒÙ… Ù‡ÙˆØ±Ù…ÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ø¨Ø¯Ù† Ø¨Ø±Ø§ÛŒ ÙˆØ±Ø²Ø´Ú©Ø§Ø±Ø§Ù†." }
];

// Ù‚Ø§Ù†ÙˆÙ† ØªÚ©â€ŒØ³ÙˆØ§Ù„ÛŒ Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª ØªÚ©Ø±Ø§Ø± Ù¾Ø±Ø³Ø´
const FIELDS = [
  {
    key: "gender",
    ask: [
      "Ø§Ø¨ØªØ¯Ø§ Ù„Ø·ÙØ§Ù‹ Ù…Ø´Ø®Øµ Ú©Ù†ÛŒØ¯ Ø®Ø§Ù†Ù… Ù‡Ø³ØªÛŒØ¯ ÛŒØ§ Ø¢Ù‚Ø§ØŸ Ø§ÛŒÙ† Ù…ÙˆØ±Ø¯ ØµØ±ÙØ§Ù‹ Ø¨Ø±Ø§ÛŒ ØªÙ†Ø¸ÛŒÙ… Ù…Ø´Ø§ÙˆØ±Ù‡ Ø¹Ù„Ù…ÛŒ Ø¯Ù‚ÛŒÙ‚ Ù…Ù‡Ù… Ø§Ø³Øª."
    ],
    validate: v => /^(Ø®Ø§Ù†Ù…|Ø¢Ù‚Ø§|Ù…Ø±Ø¯|Ø²Ù†)$/i.test(v.trim())
  },
  {
    key: "name",
    ask: [
      "Ù…Ù…Ù†ÙˆÙ†! Ø§Ø³Ù…ØªÙˆÙ† Ø±Ùˆ Ù…ÛŒâ€ŒÙØ±Ù…Ø§ÛŒÛŒØ¯ØŸ Ø§ÛŒÙ† Ú©Ù…Ú© Ù…ÛŒâ€ŒÚ©Ù†Ù‡ Ø¨Ø§ Ø§Ø­ØªØ±Ø§Ù… Ø¨ÛŒØ´ØªØ±ÛŒ Ù…Ø®Ø§Ø·Ø¨ Ù‚Ø±Ø§Ø± Ø¨Ø¯Ù… Ùˆ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø´Ø®ØµÛŒ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ú©Ù†Ù…."
    ],
    validate: v => v.trim().length >= 2
  },
  {
    key: "age",
    ask: [
      n => `${n ? n + " Ø¹Ø²ÛŒØ²ØŒ " : ""}Ø³Ù† Ø´Ù…Ø§ Ø±Ùˆ Ø¨Ø¯ÙˆÙ†Ù… Ù„Ø·ÙØ§Ù‹ØŸ ÙÙ‚Ø· Ø¹Ø¯Ø¯ Ú©Ø§ÙÛŒÙ‡. Ø³Ù† Ø¨Ø±Ø§ÛŒ ØªØ¹ÛŒÛŒÙ† Ù†ÙˆØ¹ Ù…Ú©Ù…Ù„ Ùˆ ØªÙˆØµÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ø¹Ù„Ù…ÛŒ Ù…Ù‡Ù…Ù‡.`
    ],
    validate: v => /^\d+$/.test(v) && +v > 10 && +v < 100
  },
  {
    key: "height",
    ask: [
      "Ù‚Ø¯ØªÙˆÙ† Ú†Ù†Ø¯ Ø³Ø§Ù†ØªÛŒâ€ŒÙ…ØªØ± Ù‡Ø³ØªØŸ Ø§ÛŒÙ† Ù…ÙˆØ±Ø¯ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø§Ø®Øµâ€ŒÙ‡Ø§ÛŒ ÙˆØ²Ù†ÛŒ Ùˆ ØªÙ†Ø§Ø³Ø¨ Ø§Ù†Ø¯Ø§Ù… Ø¶Ø±ÙˆØ±ÛŒÙ‡."
    ],
    validate: v => /^\d+$/.test(v) && +v > 100 && +v < 250
  },
  {
    key: "weight",
    ask: [
      "ÙˆØ²Ù† ÙØ¹Ù„ÛŒâ€ŒØªÙˆÙ† Ú†Ù†Ø¯ Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…Ù‡ØŸ Ù„Ø·ÙØ§Ù‹ Ø¹Ø¯Ø¯ Ø¯Ù‚ÛŒÙ‚ Ø±Ùˆ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯."
    ],
    validate: v => /^\d+$/.test(v) && +v > 20 && +v < 300
  },
  {
    key: "goal",
    ask: [
      "Ù‡Ø¯ÙØªÙˆÙ† Ø§Ø² Ø§ÛŒÙ† Ù…Ø´Ø§ÙˆØ±Ù‡ Ø±Ùˆ Ø¯Ù‚ÛŒÙ‚ Ø¨Ú¯ÛŒØ¯: Ø§ÙØ²Ø§ÛŒØ´ Ø¹Ø¶Ù„Ù‡ØŸ Ú©Ø§Ù‡Ø´ ÙˆØ²Ù†ØŸ ØªÙ†Ø§Ø³Ø¨ Ø§Ù†Ø¯Ø§Ù…ØŸ ÛŒØ§ ÙÙ‚Ø· Ø³Ù„Ø§Ù…ØªÛŒ Ùˆ Ù†Ø´Ø§Ø·ØŸ"
    ],
    validate: v => v.trim().length > 2
  },
  {
    key: "trainingHistory",
    ask: [
      "Ø³Ø§Ø¨Ù‚Ù‡ ÙˆØ±Ø²Ø´ÛŒ Ø¯Ø§Ø±ÛŒØ¯ØŸ Ú†Ù†Ø¯ Ø³Ø§Ù„Ù‡ ÙˆØ±Ø²Ø´ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ Ùˆ Ú†Ù‡ ÙˆØ±Ø²Ø´â€ŒÙ‡Ø§ÛŒÛŒ Ø±Ùˆ Ø¬Ø¯ÛŒâ€ŒØªØ± Ø§Ù†Ø¬Ø§Ù… Ø¯Ø§Ø¯ÛŒØ¯ØŸ"
    ],
    validate: v => v.trim().length > 2
  },
  {
    key: "dietActivity",
    ask: [
      "Ø¢ÛŒØ§ Ø±Ú˜ÛŒÙ… ØºØ°Ø§ÛŒÛŒ Ø®Ø§ØµÛŒ Ø¯Ø§Ø±ÛŒØ¯ ÛŒØ§ Ø³Ø¨Ú© ØªØºØ°ÛŒÙ‡ Ø®Ø§ØµÛŒ Ø±Ùˆ Ø±Ø¹Ø§ÛŒØª Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ØŸ Ù…ÛŒØ²Ø§Ù† ÙØ¹Ø§Ù„ÛŒØª Ùˆ ÙˆØ±Ø²Ø´â€ŒØªÙˆÙ† Ø±Ùˆ Ù‡Ù… Ù„Ø·ÙØ§ ØªÙˆØ¶ÛŒØ­ Ø¨Ø¯ÛŒØ¯."
    ],
    validate: v => v.trim().length > 2
  },
  {
    key: "healthAllergies",
    ask: [
      "Ø¨Ù‡ Ø¯Ø§Ø±Ùˆ ÛŒØ§ Ù…Ø§Ø¯Ù‡ ØºØ°Ø§ÛŒÛŒ Ø®Ø§ØµÛŒ Ø­Ø³Ø§Ø³ÛŒØª Ø¯Ø§Ø±ÛŒØ¯ØŸ Ù‡Ø± Ú†ÛŒØ²ÛŒ Ø­ØªÛŒ Ø®ÙÛŒÙ Ø¨Ø§Ø´Ù‡ Ù‡Ù… Ù…Ù‡Ù…Ù‡ Ùˆ Ø¨Ø§ÛŒØ¯ Ø¨Ø¯ÙˆÙ†Ù…."
    ],
    validate: v => true
  },
  {
    key: "illnessHistory",
    ask: [
      "Ø³Ø§Ø¨Ù‚Ù‡ Ø¨ÛŒÙ…Ø§Ø±ÛŒ ÛŒØ§ Ù…ØµØ±Ù Ø¯Ø§Ø±ÙˆÛŒ Ø®Ø§ØµÛŒ Ø¯Ø§Ø±ÛŒØ¯ØŸ Ø§ÛŒÙ† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø± ØªÙˆØµÛŒÙ‡ Ù…Ú©Ù…Ù„â€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ…Ù† Ùˆ Ø¹Ù„Ù…ÛŒ Ø§Ù‡Ù…ÛŒØª Ø²ÛŒØ§Ø¯ÛŒ Ø¯Ø§Ø±Ù‡."
    ],
    validate: v => true
  },
  {
    key: "phone",
    ask: [
      "Ø§Ú¯Ø± Ø¯ÙˆØ³Øª Ø¯Ø§Ø±ÛŒØ¯ØŒ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³â€ŒØªÙˆÙ† Ø±Ùˆ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ). Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ø§Ù‡Ù†Ú¯ÛŒ Ùˆ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´Ù‡."
    ],
    validate: v => !v || /^(\+98|0)?9\d{9}$/.test(v.trim())
  }
];

const USER = {};
let STEP = 0, repeatCount = 0;
const chatMessages = document.getElementById("chat-messages");
const userInput = document.getElementById("user-input");
const sendButton = document.getElementById("send-button");

function appendMessage(text, sender) {
  const messageDiv = document.createElement("div");
  messageDiv.classList.add("message", sender);
  messageDiv.innerHTML = sender === "bot"
    ? text.replace(/Ø¢Ø°Ø±Ù¾ÙˆØ¯Ø±/g, "<strong>Ø¢Ø°Ø±Ù¾ÙˆØ¯Ø±</strong>")
    : text;
  chatMessages.appendChild(messageDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}
function showLoadingIndicator(text = "") {
  const loadingDiv = document.createElement("div");
  loadingDiv.classList.add("loading-indicator");
  loadingDiv.innerHTML = text
    ? `<span>${text}</span>`
    : `<div class="dot"></div><div class="dot"></div><div class="dot"></div>`;
  chatMessages.appendChild(loadingDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
  return loadingDiv;
}
function removeElement(element) {
  if (element && element.parentNode) element.parentNode.removeChild(element);
}
function toggleInput(enabled) {
  userInput.disabled = !enabled;
  sendButton.disabled = !enabled;
  if (enabled) userInput.focus();
}

function personalize(question, prevAnswers) {
  if (typeof question === "function") {
    return question(prevAnswers.name || "", prevAnswers.goal || "");
  }
  return question;
}

function nextQuestion(isRepeat = false) {
  if (STEP >= FIELDS.length || (FIELDS[STEP].key === "phone" && Object.keys(USER).length === FIELDS.length - 1)) {
    appendMessage("Ø³Ù¾Ø§Ø³ Ø¨Ø§Ø¨Øª Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ Ø¯Ù‚ÛŒÙ‚! Ø­Ø§Ù„Ø§ Ù…Ø´Ø§ÙˆØ±Ù‡ ØªØ®ØµØµÛŒ Ùˆ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø¨Ù‡ØªØ±ÛŒÙ† Ù…Ú©Ù…Ù„â€ŒÙ‡Ø§ÛŒ Ø¢Ø°Ø±Ù¾ÙˆØ¯Ø± Ø±Ùˆ Ù…ÛŒâ€ŒÙØ±Ø³ØªÙ…. Ú†Ù†Ø¯ Ù„Ø­Ø¸Ù‡ ØµØ¨Ø± Ú©Ù†ÛŒØ¯ ...", "bot");
    handleRecommendation();
    return;
  }
  let qObj = FIELDS[STEP];
  let prevs = { ...USER };
  let qText = personalize(qObj.ask[0], prevs);
  if (isRepeat) {
    qText = "<span style='color:#d97706'>Ù¾Ø§Ø³Ø® Ø´Ù…Ø§ Ù…Ø¨Ù‡Ù… Ø¨ÙˆØ¯. Ø§ÛŒÙ† Ø³ÙˆØ§Ù„ Ù…Ù‡Ù…Ù‡ Ùˆ Ù„Ø§Ø²Ù…Ù‡ ÙÙ‚Ø· Ø¨Ù‡ Ù‡Ù…ÛŒÙ† Ø³ÙˆØ§Ù„ Ø¬ÙˆØ§Ø¨ Ø¨Ø¯ÛŒØ¯:</span><br>" + qText;
  }
  appendMessage(qText, "bot");
  toggleInput(true);
}

async function handleRecommendation() {
  toggleInput(false);
  const loading = showLoadingIndicator("Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ ØªØ®ØµØµÛŒ Ø´Ø±Ø§ÛŒØ· Ø´Ù…Ø§...");
  // Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù…ØªÙ† Ù…Ø¹Ø±ÙÛŒ Ù…Ø­ØµÙˆÙ„Ø§Øª Ùˆ Ù„ÛŒÙ†Ú© Ø®Ø±ÛŒØ¯
  const productsText = azarpowderProducts.map(p =>
    `- ${p.name}: ${p.description} | <b>Ù‚ÛŒÙ…Øª:</b> ${p.price} | <b>Ù†Ø­ÙˆÙ‡ Ù…ØµØ±Ù:</b> ${p.howToUse} | <b>Ø¹ÙˆØ§Ø±Ø¶:</b> ${p.sideEffects} | <a href="https://azar-powder.com/product/${p.url}" target="_blank">Ø®Ø±ÛŒØ¯ Ø¢Ù†Ù„Ø§ÛŒÙ†</a>`
  ).join('\n');

  const prompt = `
  ØªÙˆ ÛŒÚ© Ù…Ø´Ø§ÙˆØ± Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ ÙˆØ±Ø²Ø´ÛŒ Ùˆ ØªØºØ°ÛŒÙ‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ù†Ø¯ Ø¢Ø°Ø±Ù¾ÙˆØ¯Ø± Ù‡Ø³ØªÛŒ Ùˆ Ø¨Ø§ ØªÙˆØ¬Ù‡ Ø¨Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø²ÛŒØ±ØŒ ÙÙ‚Ø· Ø¨Ø§ÛŒØ¯ Ù…Ø´Ø§ÙˆØ±Ù‡ ØªØ®ØµØµÛŒ Ùˆ Ø¯Ù‚ÛŒÙ‚ Ùˆ ØªØ­Ù„ÛŒÙ„ÛŒ Ø¨Ø¯Ù‡ÛŒ:
  Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ù…Ù„ Ú©Ø§Ø±Ø¨Ø±:
  ${Object.entries(USER).map(([k,v])=>`${k}: ${v}`).join('\n')}
  
  Ù„ÛŒØ³Øª Ù…Ú©Ù…Ù„â€ŒÙ‡Ø§ Ùˆ Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¢Ø°Ø±Ù¾ÙˆØ¯Ø±:
  ${productsText}
  
  Ù‚ÙˆØ§Ù†ÛŒÙ† Ù¾Ø§Ø³Ø®:
  Û±. Ø®Ø±ÙˆØ¬ÛŒ ÙÙ‚Ø· Ø¨Ù‡ Ø²Ø¨Ø§Ù† ÙØ§Ø±Ø³ÛŒ Ùˆ Ù„Ø­Ù† Ú©Ø§Ù…Ù„Ø§Ù‹ Ø§Ù†Ø³Ø§Ù†ÛŒ Ùˆ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒØŒ Ø¨Ø§ ØªØ­Ù„ÛŒÙ„ Ø¹Ù…ÛŒÙ‚ Ùˆ ØªÙˆØ¶ÛŒØ­Ø§Øª Ø¹Ù„Ù…ÛŒ Ø¨Ø§Ø´Ø¯.
  Û². Ø­Ø¯Ø§Ù‚Ù„ Û²Û°Û° Ú©Ù„Ù…Ù‡ Ø¨Ù†ÙˆÛŒØ³ Ùˆ Ù‡Ø± Ù…Ú©Ù…Ù„ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ Ø±Ø§ Ù…ÙØµÙ„ ØªØ­Ù„ÛŒÙ„ Ú©Ù†ØŒ Ø¯Ù„ÛŒÙ„ Ø¹Ù„Ù…ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ØŒ Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ Ùˆ Ù†Ø­ÙˆÙ‡ Ù…ØµØ±Ù Ú©Ø§Ù…Ù„ ØªÙˆØ¶ÛŒØ­ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯.
  Û³. Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ù…Ú©Ù…Ù„ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒØŒ Ù„ÛŒÙ†Ú© Ø®Ø±ÛŒØ¯ Ø±Ø§ Ù…Ø·Ø§Ø¨Ù‚ Ù†Ù…ÙˆÙ†Ù‡ Ø¨Ø§Ù„Ø§ Ø¯Ø± Ù¾Ø§Ø³Ø® Ù‚Ø±Ø§Ø± Ø¨Ø¯Ù‡.
  Û´. Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø¨ÛŒÙ…Ø§Ø±ÛŒ ÛŒØ§ Ø­Ø³Ø§Ø³ÛŒØª Ø¯Ø§Ø±Ø¯ØŒ Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ù…Ù‡Ù… Ø±Ø§ ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ú©Ù†.
  Ûµ. Ù‡ÛŒÚ†â€ŒÙˆÙ‚Øª Ø¨ÛŒØ´ØªØ± Ø§Ø² ÛŒÚ© Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø±Ø§ Ø¯Ø± ÛŒÚ© Ù¾Ø§Ø±Ø§Ú¯Ø±Ø§Ù Ù†Ù†ÙˆÛŒØ³ (ØªØ­Ù„ÛŒÙ„ Ù‡Ø± Ù…Ú©Ù…Ù„ Ø¯Ø± Ù¾Ø§Ø±Ø§Ú¯Ø±Ø§Ù Ø¬Ø¯Ø§).
  Û¶. Ù‡ÛŒÚ†â€ŒÙˆÙ‚Øª ØªØ¨Ù„ÛŒØº Ù…Ø³ØªÙ‚ÛŒÙ… ÛŒØ§ Ø§ØºØ±Ø§Ù‚ Ù†Ù†ÙˆÛŒØ³ Ùˆ ØµØ§Ø¯Ù‚ Ø¨Ø§Ø´.
  Û·. Ø¬Ù…Ø¹â€ŒØ¨Ù†Ø¯ÛŒ Ùˆ Ø¬Ù…Ù„Ù‡ Ø§Ù†Ú¯ÛŒØ²Ø´ÛŒ ÙØ±Ø§Ù…ÙˆØ´ Ù†Ø´ÙˆØ¯.
  ÙÙ‚Ø· Ù…ØªÙ† Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø§Ø±Ø³Ø§Ù„ Ø´ÙˆØ¯ (Ø¨Ø¯ÙˆÙ† ØªÚ¯ Ø§Ø¶Ø§ÙÛŒ ÛŒØ§ Ø®Ø±ÙˆØ¬ÛŒ JSON).
  `;

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: prompt }] }] })
    });
    removeElement(loading);
    const data = await res.json();
    let answer = (data?.candidates?.[0]?.content?.parts?.[0]?.text ?? "").trim();
    appendMessage(answer || "Ù¾Ø§Ø³Ø®ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯!", "bot");
    toggleInput(true);
  } catch (e) {
    removeElement(loading);
    appendMessage("Ù…ØªØ§Ø³ÙØ§Ù†Ù‡ Ø³ÛŒØ³ØªÙ… Ù…Ø´Ø§ÙˆØ±Ù‡ ÙØ¹Ù„Ø§ Ù¾Ø§Ø³Ø®Ú¯Ùˆ Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ú†Ù†Ø¯ Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¯ÛŒÚ¯Ø± Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.", "bot");
  }
}

async function handleUserInput() {
  const msg = userInput.value.trim();
  if (!msg) return;
  appendMessage(msg, "user");
  userInput.value = "";
  toggleInput(false);

  // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ
  let field = FIELDS[STEP];
  if (field.validate(msg)) {
    USER[field.key] = msg;
    repeatCount = 0;
    setTimeout(() => nextQuestion(false), 800);
  } else {
    repeatCount++;
    if (repeatCount < 3) {
      setTimeout(() => nextQuestion(true), 600);
    } else {
      appendMessage("Ø§Ú¯Ø± Ù†Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¨Ù‡ Ø§ÛŒÙ† Ø³ÙˆØ§Ù„ Ø¬ÙˆØ§Ø¨ Ø¨Ø¯ÛŒØ¯ØŒ ÙÙ‚Ø· Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯ Â«Ø±Ø¯Â» ØªØ§ Ø³ÙˆØ§Ù„ Ø¨Ø¹Ø¯ÛŒ Ù¾Ø±Ø³ÛŒØ¯Ù‡ Ø´ÙˆØ¯.", "bot");
      toggleInput(true);
      repeatCount = 0;
    }
  }
}

// Ø´Ø±ÙˆØ¹ Ú¯ÙØªÚ¯Ùˆ
function startConversation() {
  appendMessage(
    "Ø³Ù„Ø§Ù… Ø¨Ù‡ Ø´Ù…Ø§! ğŸ‘‹<br>Ø¨Ù‡ Ù…Ø´Ø§ÙˆØ±Ù‡ ØªØ®ØµØµÛŒ <strong>Ø¢Ø°Ø±Ù¾ÙˆØ¯Ø±</strong> Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯.<br>Ø¯Ø± Ù‡Ø± Ù…Ø±Ø­Ù„Ù‡ ÙÙ‚Ø· ÛŒÚ© Ø³Ø¤Ø§Ù„ Ù¾Ø±Ø³ÛŒØ¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ù‡ÛŒÚ†â€ŒÙˆÙ‚Øª Ø¯Ùˆ Ø³Ø¤Ø§Ù„ Ø¨Ø§ Ù‡Ù… Ù…Ø·Ø±Ø­ Ù†Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.<br>Ø§Ú¯Ø± Ø¨Ù‡ Ø³Ø¤Ø§Ù„ÛŒ Ø¬ÙˆØ§Ø¨ Ù†Ø¯Ø§Ø¯ÛŒØ¯ØŒ Ù…Ø¬Ø¯Ø¯ Ù‡Ù…Ø§Ù† Ø³Ø¤Ø§Ù„ Ø±Ø§ Ø¨Ø§ Ù„Ø­Ù† Ø¬Ø¯ÛŒØ¯ Ù…ÛŒâ€ŒÙ¾Ø±Ø³Ù…. Ø¨Ø±ÛŒÙ… Ø³Ø±Ø§Øº Ø§ÙˆÙ„ÛŒÙ† Ø³Ø¤Ø§Ù„:",
    "bot"
  );
  setTimeout(() => nextQuestion(), 1200);
  toggleInput(true);
}

sendButton.addEventListener("click", handleUserInput);
userInput.addEventListener("keypress", e => {
  if (e.key === "Enter" && !userInput.disabled) handleUserInput();
});
window.onload = startConversation;
</script>
</body>
</html>
