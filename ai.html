<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù…Ø´Ø§ÙˆØ± ØªØ®ØµØµÛŒ Ø§ÛŒØ±Ø§Ù† Ù¾ÙˆØ¯Ø±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
    body { font-family: 'Vazirmatn', sans-serif; background: #f3f4f6; }
    .chat-container { max-width: 600px; margin: 32px auto; background: #fff; border-radius: 1.5rem; box-shadow: 0 10px 25px rgba(0,0,0,.09); display: flex; flex-direction: column; min-height: 85vh; max-height: 820px; }
    .chat-header { background: linear-gradient(90deg, #6366f1 70%, #818cf8 100%); color: #fff; padding: 1.6rem; text-align: center; font-size: 1.3rem; font-weight: bold; border-top-left-radius: 1.5rem; border-top-right-radius: 1.5rem; }
    .chat-messages { flex: 1; padding: 1.3rem; overflow-y: auto; display: flex; flex-direction: column; gap: 1.1rem; background: #f9fafb; }
    .message { max-width: 92%; padding: .82rem 1.08rem; border-radius: 1rem; line-height: 1.8; font-size: 1.1rem; }
    .message.user { background: #e0e7ff; align-self: flex-end; color: #3730a3; border-bottom-right-radius: .2rem; }
    .message.bot { background: #f0fdf4; align-self: flex-start; color: #047857; border-bottom-left-radius: .2rem; }
    .chat-input-container { display: flex; padding: 1.2rem; border-top: 1px solid #e5e7eb; background: #fff; border-bottom-left-radius: 1.5rem; border-bottom-right-radius: 1.5rem; }
    .chat-input { flex: 1; padding: 0.8rem 1rem; border: 1px solid #d1d5db; border-radius: 0.8rem; font-size: 1.1rem; outline: none; text-align: right; }
    .send-button { background: #6366f1; color: #fff; border: none; padding: 0.8rem 1.2rem; border-radius: 0.8rem; margin-right: 1rem; cursor: pointer; font-size: 1.15rem; }
    .loading-indicator { display: flex; align-items: center; justify-content: flex-start; padding: 0.7rem 1rem; border-radius: 1rem; background: #e0f2fe; align-self: flex-start; color: #2563eb; }
    .loading-indicator .dot { width: 8px; height: 8px; background: #2563eb; border-radius: 50%; margin: 0 2px; animation: bounce 0.65s infinite alternate; }
    .loading-indicator .dot:nth-child(2) { animation-delay: .22s; }
    .loading-indicator .dot:nth-child(3) { animation-delay: .44s; }
    @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-6px); } }
  </style>
</head>
<body>
<div class="chat-container">
  <div class="chat-header">Ù…Ø´Ø§ÙˆØ± ØªØ®ØµØµÛŒ Ø§ÛŒØ±Ø§Ù† Ù¾ÙˆØ¯Ø±</div>
  <div class="chat-messages" id="chat-messages"></div>
  <div class="chat-input-container">
    <input type="text" id="user-input" class="chat-input" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." autocomplete="off" />
    <button id="send-button" class="send-button"><span>&#x1F680;</span></button>
  </div>
</div>
<script type="module">
// ========= ØªÙ†Ø¸ÛŒÙ…Ø§Øª ==========
const API_URL = "https://iranpowder.peymaancrafts.workers.dev/";

// Ù„ÛŒØ³Øª Ø³ÙˆØ§Ù„Ø§Øª ØªØ¹Ø§Ù…Ù„ÛŒ Ùˆ Ø§Ù†Ø³Ø§Ù†ÛŒ Ø¨Ø§ ØªÙˆØ¶ÛŒØ­
const FIELDS = [
  {
    key: "gender",
    ask: [
      "Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ Ù…Ù…Ù†ÙˆÙ† Ù…ÛŒâ€ŒØ´Ù… Ø¨Ø¯ÙˆÙ†Ù… Ø®Ø§Ù†Ù… Ù‡Ø³ØªÛŒØ¯ ÛŒØ§ Ø¢Ù‚Ø§ØŸ Ø§ÛŒÙ† Ø±Ùˆ ØµØ±ÙØ§Ù‹ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¨Ø±Ù†Ø§Ù…Ù‡ ØªØºØ°ÛŒÙ‡ Ùˆ Ù…Ú©Ù…Ù„ Ø¯Ù‚ÛŒÙ‚â€ŒØªØ±ÛŒ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†Ù… Ù…ÛŒâ€ŒÙ¾Ø±Ø³Ù…Ø› Ú†ÙˆÙ† Ø´Ø±Ø§ÛŒØ· Ø¨Ø¯Ù†ÛŒ Ø¨ÛŒÙ† Ø®Ø§Ù†Ù…â€ŒÙ‡Ø§ Ùˆ Ø¢Ù‚Ø§ÛŒØ§Ù† ÙØ±Ù‚ Ø¯Ø§Ø±Ù‡."
    ],
    validate: v => /^(Ø®Ø§Ù†Ù…|Ø¢Ù‚Ø§|Ù…Ø±Ø¯|Ø²Ù†)$/i.test(v.trim())
  },
  {
    key: "name",
    ask: [
      "Ù…Ù…Ù†ÙˆÙ† Ø¨Ø§Ø¨Øª Ù¾Ø§Ø³Ø®ØªÙˆÙ† ğŸŒ¸ Ø­Ø§Ù„Ø§ Ø§Ú¯Ù‡ Ù…Ø´Ú©Ù„ÛŒ Ù†ÛŒØ³ØªØŒ Ø§Ø³Ù…ØªÙˆÙ† Ø±Ùˆ Ù„Ø·ÙØ§Ù‹ Ú©Ø§Ù…Ù„ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯. Ø¯ÙˆØ³Øª Ø¯Ø§Ø±Ù… Ø¨Ø¯ÙˆÙ†Ù… Ø¨Ø§ Ú†Ù‡ Ú©Ø³ÛŒ ØµØ­Ø¨Øª Ù…ÛŒâ€ŒÚ©Ù†Ù… ØªØ§ Ø¨ØªÙˆÙ†Ù… Ù‡Ù…Ù‡ Ú†ÛŒØ² Ø±Ùˆ Ø´Ø®ØµÛŒâ€ŒØ³Ø§Ø²ÛŒ Ú©Ù†Ù…."
    ],
    validate: v => v.trim().length >= 2
  },
  {
    key: "age",
    ask: [
      n => `Ø¹Ø§Ù„ÛŒØŒ ${n} Ø¹Ø²ÛŒØ²! Ø³Ù† Ø±Ùˆ Ù‡Ù… Ù„Ø·Ù Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ Ø¨Ú¯ÛŒØ¯ØŸ ÙÙ‚Ø· Ø¹Ø¯Ø¯ Ú©Ø§ÙÛŒÙ‡. Ø³Ù† Ø®ÛŒÙ„ÛŒ ØªÙˆ Ø§Ù†ØªØ®Ø§Ø¨ Ù†ÙˆØ¹ Ùˆ Ù…Ù‚Ø¯Ø§Ø± Ù…Ú©Ù…Ù„ Ùˆ Ø­ØªÛŒ ØªÙˆØµÛŒÙ‡â€ŒÙ‡Ø§ÛŒ ØªÙ…Ø±ÛŒÙ†ÛŒ Ù…Ø¤Ø«Ø±Ù‡.`
    ],
    validate: v => /^\d+$/.test(v) && +v > 10 && +v < 100
  },
  {
    key: "height",
    ask: [
      n => `Ù‚Ø¯ØªÙˆÙ† Ø±Ùˆ Ù‡Ù… Ø¨ÙØ±Ù…Ø§ÛŒÛŒØ¯ (Ø³Ø§Ù†ØªÛŒâ€ŒÙ…ØªØ±). Ø§ÛŒÙ† Ø¨Ù‡ Ù…Ù† Ú©Ù…Ú© Ù…ÛŒâ€ŒÚ©Ù†Ù‡ Ø´Ø§Ø®Øµ ØªÙˆØ¯Ù‡ Ø¨Ø¯Ù† Ø±Ùˆ Ø¯Ù‚ÛŒÙ‚â€ŒØªØ± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ú©Ù†Ù….`
    ],
    validate: v => /^\d+$/.test(v) && +v > 100 && +v < 250
  },
  {
    key: "weight",
    ask: [
      "ÙˆØ²Ù† ÙØ¹Ù„ÛŒâ€ŒØªÙˆÙ† Ø±Ùˆ Ù‡Ù… Ù„Ø·ÙØ§ Ø¯Ù‚ÛŒÙ‚ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯ (Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…). ÙˆØ²Ù† Ùˆ Ù‚Ø¯ Ù…Ù‡Ù…â€ŒØªØ±ÛŒÙ† Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø§ØµÙˆÙ„ÛŒ ØªØºØ°ÛŒÙ‡ Ùˆ ØªÙ…Ø±ÛŒÙ† Ù‡Ø³ØªÙ†."
    ],
    validate: v => /^\d+$/.test(v) && +v > 20 && +v < 300
  },
  {
    key: "goal",
    ask: [
      "Ù‡Ø¯Ù Ø§ØµÙ„ÛŒ Ø´Ù…Ø§ Ø§Ø² Ù…Ø´Ø§ÙˆØ±Ù‡ Ø¨Ø§ Ø§ÛŒØ±Ø§Ù† Ù¾ÙˆØ¯Ø± Ú†ÛŒÙ‡ØŸ Ù…Ø«Ù„Ø§Ù‹ Ø§ÙØ²Ø§ÛŒØ´ Ø¹Ø¶Ù„Ù‡ØŒ Ú©Ø§Ù‡Ø´ ÙˆØ²Ù†ØŒ ØªÙ†Ø§Ø³Ø¨ Ø§Ù†Ø¯Ø§Ù…ØŒ ÛŒØ§ ÙÙ‚Ø· Ø§Ù†Ø±Ú˜ÛŒ Ùˆ Ø³Ù„Ø§Ù…ØªÛŒ Ø¨ÛŒØ´ØªØ±ØŸ Ù‡Ø± Ú†ÛŒ Ø¨Ù‡ Ø°Ù‡Ù†â€ŒØªÙˆÙ† Ù…ÛŒâ€ŒØ±Ø³Ù‡ Ø±Ø§Ø­Øª Ø¨ÛŒØ§Ù† Ú©Ù†ÛŒØ¯."
    ],
    validate: v => v.trim().length > 2
  },
  {
    key: "trainingHistory",
    ask: [
      g => `Ø¯Ø± Ù…ÙˆØ±Ø¯ Ø³Ø§Ø¨Ù‚Ù‡ ÙˆØ±Ø²Ø´ÛŒâ€ŒØªÙˆÙ† Ø¯ÙˆØ³Øª Ø¯Ø§Ø±Ù… Ø¨Ø¯ÙˆÙ†Ù…: Ú†Ù†Ø¯ Ø³Ø§Ù„Ù‡ ÙˆØ±Ø²Ø´ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ØŸ Ú†Ù‡ ÙˆØ±Ø²Ø´â€ŒÙ‡Ø§ÛŒÛŒ Ø±Ùˆ ØªØ§ Ø­Ø§Ù„Ø§ Ø¬Ø¯ÛŒ Ø¯Ù†Ø¨Ø§Ù„ Ú©Ø±Ø¯ÛŒØ¯ØŸ Ø³Ø·Ø­ Ø®ÙˆØ¯ØªÙˆÙ† Ø±Ùˆ Ù…Ø¨ØªØ¯ÛŒØŒ Ù…ØªÙˆØ³Ø· ÛŒØ§ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ù…ÛŒâ€ŒØ¯ÙˆÙ†ÛŒØ¯ØŸ`
    ],
    validate: v => v.trim().length > 2
  },
  {
    key: "dietActivity",
    ask: [
      g => "Ø§Ù„Ø§Ù† Ø±Ú˜ÛŒÙ… ØºØ°Ø§ÛŒÛŒ Ø®Ø§ØµÛŒ Ø¯Ø§Ø±ÛŒØ¯ØŸ ÛŒØ§ Ø§ÛŒÙ†Ú©Ù‡ Ø§ØµÙˆÙ„Ø§Ù‹ Ú†Ù‚Ø¯Ø± Ø¨Ù‡ ØªØºØ°ÛŒÙ‡ Ùˆ Ø³Ø¨Ú© Ø²Ù†Ø¯Ú¯ÛŒ Ø³Ø§Ù„Ù… Ø§Ù‡Ù…ÛŒØª Ù…ÛŒâ€ŒØ¯ÛŒØ¯ØŸ Ú†Ù†Ø¯ Ø±ÙˆØ² Ø¯Ø± Ù‡ÙØªÙ‡ ÙˆØ±Ø²Ø´ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ØŸ"
    ],
    validate: v => v.trim().length > 2
  },
  {
    key: "healthAllergies",
    ask: [
      "Ø¢ÛŒØ§ Ø¨Ù‡ Ù…Ø§Ø¯Ù‡ ØºØ°Ø§ÛŒÛŒ ÛŒØ§ Ø¯Ø§Ø±ÙˆÛŒ Ø®Ø§ØµÛŒ Ø­Ø³Ø§Ø³ÛŒØª Ø¯Ø§Ø±ÛŒØ¯ ÛŒØ§ ØªØ¬Ø±Ø¨Ù‡ ÙˆØ§Ú©Ù†Ø´ Ø­Ø³Ø§Ø³ÛŒØªÛŒ Ø¯Ø§Ø´ØªÛŒØ¯ØŸ Ù‡Ø± Ú†ÛŒØ²ÛŒ Ø­ØªÛŒ Ø®ÙÛŒÙ Ù‡Ù… Ø¨Ø§Ø´Ù‡ Ù„Ø·ÙØ§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯. Ú†ÙˆÙ† Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ú©Ù…Ù„â€ŒÙ‡Ø§ Ø®ÛŒÙ„ÛŒ Ù…Ù‡Ù…Ù‡."
    ],
    validate: v => true // Ù‡Ø± Ù¾Ø§Ø³Ø®ÛŒ
  },
  {
    key: "illnessHistory",
    ask: [
      "Ø¢ÛŒØ§ Ø³Ø§Ø¨Ù‚Ù‡ Ø¨ÛŒÙ…Ø§Ø±ÛŒ ÛŒØ§ Ù…ØµØ±Ù Ø¯Ø§Ø±ÙˆÛŒ Ø®Ø§ØµÛŒ Ø¯Ø§Ø±ÛŒØ¯ØŸ Ø­ØªÛŒ Ø§Ú¯Ø± Ø¨ÛŒÙ…Ø§Ø±ÛŒ Ù…Ø²Ù…Ù† ÛŒØ§ Ú©ÙˆØªØ§Ù‡â€ŒÙ…Ø¯Øª Ø¨ÙˆØ¯Ù‡ Ø¨Ø§Ø´Ù‡ ÛŒØ§ Ø¯Ø§Ø±ÙˆÛŒÛŒ Ù…ØµØ±Ù Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ØŒ Ø­ØªÙ…Ø§ Ø¨Ú¯ÛŒØ¯ Ú©Ù‡ Ù…Ú©Ù…Ù„ÛŒ Ú©Ù‡ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù…ÛŒâ€ŒØ¯Ù… Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ Ø§ÛŒÙ…Ù† Ø¨Ø§Ø´Ù‡."
    ],
    validate: v => true // Ù‡Ø± Ù¾Ø§Ø³Ø®ÛŒ
  },
  {
    key: "phone",
    ask: [
      "Ø§Ú¯Ø± Ø¯ÙˆØ³Øª Ø¯Ø§Ø´ØªÛŒØ¯ØŒ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³â€ŒØªÙˆÙ† Ø±Ùˆ Ù‡Ù… Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ). ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¨ÛŒØ´ØªØ±ØŒ Ø§Ú¯Ø± Ù„Ø§Ø²Ù… Ø¨ÙˆØ¯ Ø¨Ø§Ù‡Ø§ØªÙˆÙ† Ù‡Ù…Ø§Ù‡Ù†Ú¯ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…."
    ],
    validate: v => !v || /^(\+98|0)?9\d{9}$/.test(v.trim())
  }
];

const USER = {};
let STEP = 0, repeatCount = 0;
const chatMessages = document.getElementById("chat-messages");
const userInput = document.getElementById("user-input");
const sendButton = document.getElementById("send-button");

function appendMessage(text, sender) {
  const messageDiv = document.createElement("div");
  messageDiv.classList.add("message", sender);
  messageDiv.innerHTML = sender === "bot"
    ? text.replace(/Ø§ÛŒØ±Ø§Ù† Ù¾ÙˆØ¯Ø±/g, "<strong>Ø§ÛŒØ±Ø§Ù† Ù¾ÙˆØ¯Ø±</strong>")
    : text;
  chatMessages.appendChild(messageDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}
function showLoadingIndicator(text = "") {
  const loadingDiv = document.createElement("div");
  loadingDiv.classList.add("loading-indicator");
  loadingDiv.innerHTML = text
    ? `<span>${text}</span>`
    : `<div class="dot"></div><div class="dot"></div><div class="dot"></div>`;
  chatMessages.appendChild(loadingDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
  return loadingDiv;
}
function removeElement(element) {
  if (element && element.parentNode) element.parentNode.removeChild(element);
}
function toggleInput(enabled) {
  userInput.disabled = !enabled;
  sendButton.disabled = !enabled;
  if (enabled) userInput.focus();
}

function personalize(question, prevAnswers) {
  if (typeof question === "function") {
    // Ø¨Ù‡ ØªØ§Ø¨Ø¹ Ù‚Ø¨Ù„ÛŒâ€ŒÙ‡Ø§ Ø¨Ø¯Ù‡
    return question(prevAnswers.name || "", prevAnswers.goal || "");
  }
  return question;
}

function nextQuestion() {
  if (STEP >= FIELDS.length || (FIELDS[STEP].key === "phone" && Object.keys(USER).length === FIELDS.length - 1)) {
    appendMessage("Ø®ÛŒÙ„ÛŒ Ø®ÛŒÙ„ÛŒ Ù…Ù…Ù†ÙˆÙ† Ø¨Ø§Ø¨Øª Ø§ÛŒÙ† ØªÙˆØ¶ÛŒØ­Ø§Øª Ú©Ø§Ù…Ù„! Ø­Ø§Ù„Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù…Ø§ØŒ Ù…Ù†Ø§Ø³Ø¨â€ŒØªØ±ÛŒÙ† Ù…Ú©Ù…Ù„â€ŒÙ‡Ø§ Ùˆ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±Ø§ Ù…Ø¹Ø±ÙÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ù…. Ú†Ù†Ø¯ Ù„Ø­Ø¸Ù‡ ØµØ¨Ø± Ú©Ù† Ù„Ø·ÙØ§ ...", "bot");
    handleRecommendation();
    return;
  }
  let qObj = FIELDS[STEP];
  let prevs = { ...USER };
  let qText = personalize(qObj.ask[0], prevs);
  appendMessage(qText, "bot");
  toggleInput(true);
}

async function handleRecommendation() {
  toggleInput(false);
  const loading = showLoadingIndicator("Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ ØªØ®ØµØµÛŒ Ø´Ø±Ø§ÛŒØ· Ø´Ù…Ø§...");
  const prompt = `
    ØªÙˆ ÛŒÚ© Ù…Ø´Ø§ÙˆØ± ÙˆØ±Ø²Ø´ÛŒ-ØªØºØ°ÛŒÙ‡â€ŒØ§ÛŒ Ø¨Ø³ÛŒØ§Ø± Ø¨Ø§Ø§Ø®Ù„Ø§Ù‚ØŒ Ø§Ù†Ø³Ø§Ù†ÛŒØŒ Ù‡Ù…Ø¯Ù„ Ùˆ Ø®ÙˆØ´â€ŒØ¨Ø±Ø®ÙˆØ±Ø¯ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ù†Ø¯ Ø§ÛŒØ±Ø§Ù† Ù¾ÙˆØ¯Ø± Ù‡Ø³ØªÛŒ.
    Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø²ÛŒØ± Ù…ØªØ¹Ù„Ù‚ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø§Ø³Øª:
    ${Object.entries(USER).map(([k,v])=>`${k}: ${v}`).join('\n')}
    Ø¨Ø§ Ù„Ø­Ù† Ú©Ø§Ù…Ù„Ø§Ù‹ ØµÙ…ÛŒÙ…ÛŒ Ùˆ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒØŒ ØªÙˆØµÛŒÙ‡â€ŒØ§ÛŒ Ø¨Ù†ÙˆÛŒØ³ Ú©Ù‡ Ø´Ø§Ù…Ù„:
    - Ø®ÙˆØ´Ø§Ù…Ø¯ Ùˆ Ø§Ø­ØªØ±Ø§Ù… Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ùˆ Ø§Ø´Ø§Ø±Ù‡ Ø¨Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§ØªÛŒ Ú©Ù‡ Ø¯Ø§Ø¯Ù‡
    - ØªØ­Ù„ÛŒÙ„ Ù‡Ø¯ÙØŒ Ø´Ø±Ø§ÛŒØ· Ùˆ Ø³Ø¨Ú© Ø²Ù†Ø¯Ú¯ÛŒ Ùˆ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù…Ú©Ù…Ù„ Ù…Ù†Ø§Ø³Ø¨ (Ø­Ø¯Ø§Ú©Ø«Ø± Ø³Ù‡ Ù…ÙˆØ±Ø¯)
    - ØªÙˆØ¶ÛŒØ­ Ø¯ÙˆØ³ØªØ§Ù†Ù‡ Ùˆ Ø¹Ù„Ù…ÛŒ Ù‡Ø± Ù…Ú©Ù…Ù„ Ùˆ Ø¯Ù„ÛŒÙ„ Ø§Ù†ØªØ®Ø§Ø¨
    - Ù‚ÛŒÙ…Øª Ùˆ Ù†Ø­ÙˆÙ‡ Ù…ØµØ±Ù
    - Ø¬Ù…Ø¹â€ŒØ¨Ù†Ø¯ÛŒ Ùˆ ÛŒÚ© Ø¬Ù…Ù„Ù‡ Ø§Ù†Ú¯ÛŒØ²Ø´ÛŒ ÛŒØ§ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù…Ø´Ø§ÙˆØ±Ù‡ Ø¨ÛŒØ´ØªØ±
    ÙÙ‚Ø· Ø¬ÙˆØ§Ø¨ Ù†Ù‡Ø§ÛŒÛŒ Ø±Ùˆ ÙØ§Ø±Ø³ÛŒ Ùˆ Ú©Ø§Ù…Ù„Ø§Ù‹ ØªØ¹Ø§Ù…Ù„ÛŒ Ø¨Ù†ÙˆÛŒØ³.
  `;
  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: prompt }] }] })
    });
    removeElement(loading);
    const data = await res.json();
    let answer = (data?.candidates?.[0]?.content?.parts?.[0]?.text ?? "").trim();
    appendMessage(answer || "Ù¾Ø§Ø³Ø®ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯!", "bot");
    toggleInput(true);
  } catch (e) {
    removeElement(loading);
    appendMessage("Ù…ØªØ§Ø³ÙØ§Ù†Ù‡ Ø³ÛŒØ³ØªÙ… Ù…Ø´Ø§ÙˆØ±Ù‡ ÙØ¹Ù„Ø§ Ù¾Ø§Ø³Ø®Ú¯Ùˆ Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ú†Ù†Ø¯ Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¯ÛŒÚ¯Ø± Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.", "bot");
  }
}

async function handleUserInput() {
  const msg = userInput.value.trim();
  if (!msg) return;
  appendMessage(msg, "user");
  userInput.value = "";
  toggleInput(false);

  // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ
  let field = FIELDS[STEP];
  if (field.validate(msg)) {
    // Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯ Ù…Ø«Ø¨Øª
    if (field.key !== "phone")
      appendMessage(pickFeedback(field.key, msg), "bot");
    USER[field.key] = msg;
    STEP++;
    repeatCount = 0;
    setTimeout(() => nextQuestion(), 1000);
  } else {
    repeatCount++;
    if (repeatCount < 3) {
      appendMessage(
        `<span style='color:#d97706'>Ù…Ø·Ù…Ø¦Ù† Ù†ÛŒØ³ØªÙ… Ø¬ÙˆØ§Ø¨ Ø¯Ù‚ÛŒÙ‚ Ø¨ÙˆØ¯.</span> ${personalize(field.ask[0], USER)}`, "bot"
      );
      toggleInput(true);
    } else {
      appendMessage("Ø§Ú¯Ø± Ø¨Ù‡ Ù‡Ø± Ø¯Ù„ÛŒÙ„ Ù…Ø§ÛŒÙ„ Ø¨Ù‡ Ù¾Ø§Ø³Ø® Ù†ÛŒØ³ØªÛŒØ¯ØŒ ÙÙ‚Ø· Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯ Â«Ø±Ø¯Â» ÛŒØ§ Â«Ù‡ÛŒÚ†Â» ØªØ§ Ø±Ø¯ Ø´ÙˆØ¯.", "bot");
      toggleInput(true);
      repeatCount = 0;
    }
  }
}

// Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ø¯ÙˆØ³ØªØ§Ù†Ù‡ Ùˆ ØªØ¹Ø§Ù…Ù„ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹ Ø¬ÙˆØ§Ø¨
function pickFeedback(field, answer) {
  if (!answer.trim()) return "";
  if (["gender","name","age","height","weight"].includes(field)) {
    return [
      "Ø¹Ø§Ù„ÛŒØŒ Ù…Ø±Ø³ÛŒ Ú©Ù‡ Ø¬ÙˆØ§Ø¨ Ø¯Ø§Ø¯ÛŒ! ğŸ˜Š",
      "Ø³Ù¾Ø§Ø³ Ø§Ø² Ø¯Ù‚ØªØª. Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø®ÛŒÙ„ÛŒ Ú©Ù…Ú© Ù…ÛŒâ€ŒÚ©Ù†Ù‡.",
      "ÙÙˆÙ‚â€ŒØ§Ù„Ø¹Ø§Ø¯Ù‡! Ù…ÛŒâ€ŒØ±ÛŒÙ… Ø³Ø±Ø§Øº Ø³ÙˆØ§Ù„ Ø¨Ø¹Ø¯."
    ][Math.floor(Math.random()*3)];
  }
  if (field === "goal") return "Ú†Ù‚Ø¯Ø± Ø§Ù†Ú¯ÛŒØ²Ù‡â€ŒØ§Øª Ø¬Ø§Ù„Ø¨Ù‡! Ù‡Ø¯Ù Ø±Ùˆ Ø¹Ø§Ù„ÛŒ Ú¯ÙØªÛŒ.";
  if (field === "trainingHistory") return "Ø³Ø§Ø¨Ù‚Ù‡â€Œ ÙˆØ±Ø²Ø´ÛŒâ€ŒØ§Øª Ø®ÛŒÙ„ÛŒ Ù…Ù‡Ù…Ù‡. Ù…Ù…Ù†ÙˆÙ† Ú©Ù‡ ØªÙˆØ¶ÛŒØ­ Ø¯Ø§Ø¯ÛŒ!";
  if (field === "dietActivity") return "Ø®Ø¨ Ø­Ø§Ù„Ø§ Ø¨Ø§ Ø§ÛŒÙ† ØªÙˆØ¶ÛŒØ­Ø§Øª Ø¨Ù‡ØªØ± Ù…ÛŒâ€ŒØªÙˆÙ†Ù… Ú©Ù…Ú© Ú©Ù†Ù…!";
  if (field === "healthAllergies" || field === "illnessHistory") {
    if (/^(Ù†Ù‡|Ù†Ø¯Ø§Ø±Ù…|Ø®ÛŒØ±|Ù†Ø¯Ø§Ø±ÛŒÙ…|Ù‡ÛŒÚ†)/i.test(answer)) return "Ø®ÙˆØ´Ø­Ø§Ù„Ù… Ú©Ù‡ Ù…Ø´Ú©Ù„ÛŒ Ù†Ø¯Ø§Ø±ÛŒØŒ Ø§Ù…Ø§ Ø§Ú¯Ø± Ù‡Ø± ÙˆÙ‚Øª Ú†ÛŒØ²ÛŒ ÛŒØ§Ø¯Øª Ø§ÙˆÙ…Ø¯ØŒ Ø¨Ù‡Ù… Ø¨Ú¯Ùˆ.";
    return "Ù…Ù…Ù†ÙˆÙ† Ø¨Ø§Ø¨Øª Ø¯Ù‚Øª Ùˆ ØµØ¯Ø§Ù‚ØªØª. Ø§ÛŒÙ† Ù…ÙˆØ±Ø¯ Ø±Ùˆ Ø­ØªÙ…Ø§ Ù„Ø­Ø§Ø¸ Ù…ÛŒâ€ŒÚ©Ù†Ù….";
  }
  return "";
}

// ==== Ø´Ø±ÙˆØ¹ Ù…Ú©Ø§Ù„Ù…Ù‡ ====
function startConversation() {
  appendMessage(
    "Ø³Ù„Ø§Ù… Ùˆ Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒ Ø¨Ù‡ Ú†Øª ØªØ®ØµØµÛŒ <strong>Ø§ÛŒØ±Ø§Ù† Ù¾ÙˆØ¯Ø±</strong> ğŸŒŸ<br>Ø§ÛŒÙ† Ú¯ÙØªâ€ŒÙˆÚ¯Ùˆ Ú©Ø§Ù…Ù„Ø§Ù‹ Ù…Ø­Ø±Ù…Ø§Ù†Ù‡ Ø§Ø³Øª Ùˆ ÙÙ‚Ø· Ù‡Ø¯ÙØ´ Ø§ÛŒÙ†Ù‡ Ú©Ù‡ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯Ù‚ÛŒÙ‚ Ùˆ Ù…Ù†Ø§Ø³Ø¨ Ø´Ø±Ø§ÛŒØ· ØªÙˆ Ù¾ÛŒØ¯Ø§ Ú©Ù†ÛŒÙ…. Ù‡Ø± Ø³ÙˆØ§Ù„ÛŒ Ø¯Ø§Ø´ØªÛŒ ÙˆØ³Ø· Ú©Ø§Ø± Ø¨Ù¾Ø±Ø³.<br>Ø®Ø¨ØŒ Ø¨Ø±ÛŒÙ… Ø³Ø±Ø§Øº Ø³ÙˆØ§Ù„Ø§Øª!",
    "bot"
  );
  setTimeout(() => nextQuestion(), 1200);
  toggleInput(true);
}

sendButton.addEventListener("click", handleUserInput);
userInput.addEventListener("keypress", e => {
  if (e.key === "Enter" && !userInput.disabled) handleUserInput();
});
window.onload = startConversation;
</script>
</body>
</html>
