<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>مشاور تخصصی آذرپودر</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
    body { font-family: 'Vazirmatn', sans-serif; background: #f3f4f6; }
    .chat-container { max-width: 600px; margin: 32px auto; background: #fff; border-radius: 1.5rem; box-shadow: 0 10px 25px rgba(0,0,0,.09); display: flex; flex-direction: column; min-height: 85vh; max-height: 820px; }
    .chat-header { background: linear-gradient(90deg, #6366f1 70%, #818cf8 100%); color: #fff; padding: 1.6rem; text-align: center; font-size: 1.3rem; font-weight: bold; border-top-left-radius: 1.5rem; border-top-right-radius: 1.5rem; }
    .chat-messages { flex: 1; padding: 1.3rem; overflow-y: auto; display: flex; flex-direction: column; gap: 1.1rem; background: #f9fafb; }
    .message { max-width: 92%; padding: .82rem 1.08rem; border-radius: 1rem; line-height: 1.8; font-size: 1.1rem; }
    .message.user { background: #e0e7ff; align-self: flex-end; color: #3730a3; border-bottom-right-radius: .2rem; }
    .message.bot { background: #f0fdf4; align-self: flex-start; color: #047857; border-bottom-left-radius: .2rem; }
    .chat-input-container { display: flex; padding: 1.2rem; border-top: 1px solid #e5e7eb; background: #fff; border-bottom-left-radius: 1.5rem; border-bottom-right-radius: 1.5rem; }
    .chat-input { flex: 1; padding: 0.8rem 1rem; border: 1px solid #d1d5db; border-radius: 0.8rem; font-size: 1.1rem; outline: none; text-align: right; }
    .send-button { background: #6366f1; color: #fff; border: none; padding: 0.8rem 1.2rem; border-radius: 0.8rem; margin-right: 1rem; cursor: pointer; font-size: 1.15rem; }
    .loading-indicator { display: flex; align-items: center; justify-content: flex-start; padding: 0.7rem 1rem; border-radius: 1rem; background: #e0f2fe; align-self: flex-start; color: #2563eb; }
    .loading-indicator .dot { width: 8px; height: 8px; background: #2563eb; border-radius: 50%; margin: 0 2px; animation: bounce 0.65s infinite alternate; }
    .loading-indicator .dot:nth-child(2) { animation-delay: .22s; }
    .loading-indicator .dot:nth-child(3) { animation-delay: .44s; }
    @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-6px); } }
  </style>
</head>
<body>
<div class="chat-container">
  <div class="chat-header">مشاوره تخصصی دکتر آذرپودر</div>
  <div class="chat-messages" id="chat-messages"></div>
  <div class="chat-input-container">
    <input type="text" id="user-input" class="chat-input" placeholder="پاسخ یا سوال خود را بنویسید..." autocomplete="off" />
    <button id="send-button" class="send-button"><span>&#x1F680;</span></button>
  </div>
</div>
<script type="module">
  //v2
// ============== تنظیمات و محصولات ===============
const API_URL = "https://iranpowder.peymaancrafts.workers.dev/";

const azarpowderProducts = [
  { name: "پروتئین وی کنسانتره آذرپودر", price: "۲,۹۰۰,۰۰۰ تومان", url: "protein-whey", howToUse: "یک پیمانه (۲۵ گرم) بلافاصله پس از تمرین و یک پیمانه صبح ناشتا", sideEffects: "در افراد حساس به لاکتوز ممکن است موجب نفخ شود.", description: "پروتئین وی با جذب سریع، کمک به ریکاوری عضلانی و حفظ توده عضلانی، مناسب ورزشکاران قدرتی و بدنسازها." },
  { name: "گینر پرکالری آذرپودر", price: "۲,۴۰۰,۰۰۰ تومان", url: "gainer", howToUse: "دو پیمانه در روز (میان وعده و بعد تمرین)", sideEffects: "در صورت مصرف زیاد ممکن است موجب افزایش چربی شود.", description: "گینر حاوی کربوهیدرات و پروتئین بالا، مناسب افزایش وزن و حجم عضلانی سریع." },
  { name: "کراتین مونوهیدرات آذرپودر", price: "۱,۲۰۰,۰۰۰ تومان", url: "creatine-monohydrate", howToUse: "۵ گرم روزانه همراه آب، ترجیحاً بعد تمرین", sideEffects: "مصرف آب کافی ضروری است، ممکن است موجب احتباس آب در عضلات شود.", description: "کراتین موجب افزایش قدرت، ریکاوری سریع‌تر و افزایش توان عضلات در تمرینات شدید می‌شود." },
  { name: "آمینواسید شاخه‌دار (BCAA) آذرپودر", price: "۱,۵۰۰,۰۰۰ تومان", url: "bcaa", howToUse: "۱۰ گرم قبل یا حین تمرین", sideEffects: "در دوزهای معمول بی‌خطر است.", description: "BCAA برای جلوگیری از تجزیه عضلات و کاهش خستگی در تمرینات طولانی و هوازی کاربرد دارد." },
  { name: "گلوتامین آذرپودر", price: "۱,۱۰۰,۰۰۰ تومان", url: "glutamine", howToUse: "۵ گرم پس از تمرین و قبل خواب", sideEffects: "به طور معمول بی‌عارضه است.", description: "گلوتامین به ریکاوری، تقویت سیستم ایمنی و کاهش درد عضلانی کمک می‌کند." },
  { name: "مولتی‌ویتامین ورزشی آذرپودر", price: "۸۵۰,۰۰۰ تومان", url: "multi-vitamin", howToUse: "یک عدد قرص همراه صبحانه", sideEffects: "مصرف بیش از حد ویتامین A و D توصیه نمی‌شود.", description: "حاوی ویتامین‌ها و مواد معدنی لازم برای ورزشکاران جهت تأمین نیاز روزانه و حمایت از عملکرد بدن." },
  { name: "پمپ (Pre-workout) آذرپودر", price: "۱,۸۰۰,۰۰۰ تومان", url: "preworkout", howToUse: "یک پیمانه ۳۰ دقیقه قبل از تمرین", sideEffects: "افراد با فشار خون بالا یا مشکلات قلبی با مشورت پزشک مصرف کنند.", description: "افزایش انرژی، تمرکز و خون‌رسانی عضلات جهت اجرای تمرین پرفشار." },
  { name: "اُمگا۳ آذرپودر", price: "۹۰۰,۰۰۰ تومان", url: "omega-3", howToUse: "یک عدد کپسول همراه ناهار", sideEffects: "در افراد با حساسیت به ماهی منع مصرف دارد.", description: "تقویت سلامت قلب، کاهش التهاب و کمک به ریکاوری عضلانی." },
  { name: "کپسول ویتامین D3 آذرپودر (۵۰۰۰ واحد)", price: "۶۰۰,۰۰۰ تومان", url: "vitamin-d3", howToUse: "هفته‌ای دو تا سه بار یک عدد بعد غذا", sideEffects: "مصرف بیش از حد می‌تواند مشکلات کبدی ایجاد کند.", description: "حفظ سلامت استخوان و تنظیم هورمون‌های بدن برای ورزشکاران." }
];

// قانون تک‌سوالی، تکرار با لحن پزشک متخصص
const FIELDS = [
  {
    key: "gender",
    ask: [
      "لطفاً بفرمایید خانم هستید یا آقا؟ این سؤال صرفاً برای اینکه برنامه دقیقی طراحی کنم مهم است."
    ],
    retry: [
      "ببخشید، فقط باید مشخص کنید خانم هستید یا آقا تا برنامه علمی براتون تنظیم کنم."
    ],
    validate: v => /خانم|آقا|مرد|زن/i.test((v||"").replace(/ /g,''))
  },
  {
    key: "name",
    ask: [
      "خیلی ممنون. نام کوچک‌تون رو هم لطفاً وارد کنید که با احترام و دقت بیشتر راهنمایی‌تون کنم."
    ],
    retry: [
      "فقط نام خودتون رو لطفاً بنویسید تا گفتگوی ما دوستانه‌تر باشه."
    ],
    validate: v => !!v && v.trim().length >= 2
  },
  {
    key: "age",
    ask: [
      n => `سپاسگزارم ${n ? n + " عزیز" : ""}! سن شما چند سال است؟ فقط عدد را وارد کنید.`
    ],
    retry: [
      "سن برای تجویز مکمل و برنامه خیلی مهم است. لطفاً سن خود را فقط به عدد بنویسید."
    ],
    validate: v => /^\d+$/.test(v) && +v > 10 && +v < 100
  },
  {
    key: "height",
    ask: [
      "قدتان را هم لطفاً به سانتی‌متر بنویسید."
    ],
    retry: [
      "لطفاً قد را فقط با عدد وارد کنید (مثلاً ۱۷۶)."
    ],
    validate: v => /^\d+$/.test(v) && +v > 100 && +v < 250
  },
  {
    key: "weight",
    ask: [
      "وزن فعلی شما چند کیلوگرم است؟"
    ],
    retry: [
      "لطفاً وزن را فقط به عدد (کیلوگرم) وارد کنید."
    ],
    validate: v => /^\d+$/.test(v) && +v > 20 && +v < 300
  },
  {
    key: "goal",
    ask: [
      "هدف اصلی شما از این مشاوره چیست؟ مثلا افزایش عضله، کاهش وزن، یا فقط سلامتی و انرژی؟"
    ],
    retry: [
      "لطفاً هدفتان را دقیق‌تر بفرمایید تا برنامه‌ای مناسب ارائه کنم."
    ],
    validate: v => v && v.trim().length > 2
  },
  {
    key: "trainingHistory",
    ask: [
      "سابقه ورزشی شما چطور بوده؟ چند سال و چه رشته‌هایی را جدی دنبال کرده‌اید؟"
    ],
    retry: [
      "لطفاً سابقه ورزشی و رشته‌هایی که تمرین داشته‌اید را بنویسید."
    ],
    validate: v => v && v.trim().length > 2
  },
  {
    key: "dietActivity",
    ask: [
      "الان از چه رژیم یا سبک تغذیه‌ای پیروی می‌کنید؟ میزان فعالیت روزانه یا هفتگی چطور است؟"
    ],
    retry: [
      "توضیح کوتاهی درباره رژیم غذایی و تعداد جلسات تمرین هفته‌تان لطفاً بدهید."
    ],
    validate: v => v && v.trim().length > 2
  },
  {
    key: "healthAllergies",
    ask: [
      "آیا به دارو یا غذایی حساسیت دارید یا تاکنون واکنش آلرژیک جدی داشته‌اید؟"
    ],
    retry: [
      "هرگونه حساسیت یا آلرژی غذایی یا دارویی را لطفاً یادآور شوید."
    ],
    validate: v => true
  },
  {
    key: "illnessHistory",
    ask: [
      "سابقه بیماری یا مصرف داروی خاصی دارید که لازم باشد بدانم؟"
    ],
    retry: [
      "اگر بیماری یا داروی خاصی مصرف می‌کنید حتماً بنویسید. اگر نه، بفرمایید ندارم."
    ],
    validate: v => true
  },
  {
    key: "phone",
    ask: [
      "اگر مایل بودید شماره تماس برای پیگیری مشاوره وارد کنید (اختیاری است)."
    ],
    retry: [
      "در صورت تمایل، شماره تماس را وارد کنید یا رد کنید."
    ],
    validate: v => !v || /^(\+98|0)?9\d{9}$/.test((v||"").trim())
  }
];

const USER = {};
let STEP = 0, repeatCount = 0;
const chatMessages = document.getElementById("chat-messages");
const userInput = document.getElementById("user-input");
const sendButton = document.getElementById("send-button");

function appendMessage(text, sender) {
  const messageDiv = document.createElement("div");
  messageDiv.classList.add("message", sender);
  messageDiv.innerHTML = sender === "bot"
    ? text.replace(/آذرپودر/g, "<strong>آذرپودر</strong>")
    : text;
  chatMessages.appendChild(messageDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}
function showLoadingIndicator(text = "") {
  const loadingDiv = document.createElement("div");
  loadingDiv.classList.add("loading-indicator");
  loadingDiv.innerHTML = text
    ? `<span>${text}</span>`
    : `<div class="dot"></div><div class="dot"></div><div class="dot"></div>`;
  chatMessages.appendChild(loadingDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
  return loadingDiv;
}
function removeElement(element) {
  if (element && element.parentNode) element.parentNode.removeChild(element);
}
function toggleInput(enabled) {
  userInput.disabled = !enabled;
  sendButton.disabled = !enabled;
  if (enabled) userInput.focus();
}

function personalize(question, prevAnswers) {
  if (typeof question === "function") {
    return question(prevAnswers.name || "", prevAnswers.goal || "");
  }
  return question;
}

function nextQuestion(isRetry = false) {
  if (STEP >= FIELDS.length || (FIELDS[STEP].key === "phone" && Object.keys(USER).length >= FIELDS.length - 1)) {
    appendMessage("از پاسخ‌گویی شما سپاسگزارم. بر اساس شرایط شما، راهنمای تخصصی و مکمل‌های مناسب را معرفی می‌کنم.", "bot");
    handleRecommendation();
    return;
  }
  let qObj = FIELDS[STEP];
  let prevs = { ...USER };
  let qText = isRetry && qObj.retry ? qObj.retry[0] : personalize(qObj.ask[0], prevs);
  appendMessage(qText, "bot");
  toggleInput(true);
}

async function handleRecommendation() {
  toggleInput(false);
  const loading = showLoadingIndicator("در حال تحلیل شرایط بدنی و اهداف شما توسط دکتر متخصص آذرپودر...");
  const productsText = azarpowderProducts.map(p =>
    `- ${p.name}: ${p.description} | <b>قیمت:</b> ${p.price} | <b>نحوه مصرف:</b> ${p.howToUse} | <b>عوارض:</b> ${p.sideEffects} | <a href="https://azar-powder.com/product/${p.url}" target="_blank">خرید آنلاین</a>`
  ).join('\n');

  const prompt = `
  شما نقش یک پزشک و مشاور تغذیه و ورزشی حرفه‌ای را برای برند آذرپودر بازی می‌کنید. پاسخ باید:
  - لحن کاملاً انسانی، علمی و با احترام و تجربه دکترانه باشد.
  - برای هر مکمل پیشنهادی تحلیل تخصصی، هشدارها، نحوه مصرف، لینک خرید: https://azar-powder.com/product/slug قرار بگیرد.
  - دست‌کم ۲۰۰ کلمه بنویسید، هر مکمل در پاراگراف جداگانه.
  - هیچ تبلیغ اغراق‌آمیز و بزرگ‌نمایی نباشد. صداقت و دلسوزی دکترانه داشته باشد.
  - اگر بیمار یا حساسیت دارد، محدودیت‌ها را یادآوری کن.
  اطلاعات کاربر:
  ${Object.entries(USER).map(([k,v])=>`${k}: ${v}`).join('\n')}
  لیست محصولات آذرپودر:
  ${productsText}
  فقط متن مشاوره آماده برای نمایش ارسال شود.
  `;

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: prompt }] }] })
    });
    removeElement(loading);
    const data = await res.json();
    let answer = (data?.candidates?.[0]?.content?.parts?.[0]?.text ?? "").trim();
    appendMessage(answer || "پاسخی دریافت نشد!", "bot");
    toggleInput(true);
  } catch (e) {
    removeElement(loading);
    appendMessage("متاسفانه سیستم مشاوره فعلا پاسخگو نیست. لطفاً چند دقیقه دیگر دوباره تلاش کنید.", "bot");
  }
}

async function handleUserInput() {
  const msg = userInput.value.trim();
  if (!msg) return;
  appendMessage(msg, "user");
  userInput.value = "";
  toggleInput(false);

  let field = FIELDS[STEP];
  // اگر کاربر نوشت رد یا هیچ، رد کن
  if (/^(رد|هیچ)$/i.test(msg)) {
    appendMessage("باشه، این سؤال را رد می‌کنم و می‌رویم سراغ مورد بعدی.", "bot");
    STEP++; repeatCount = 0;
    setTimeout(() => nextQuestion(false), 800);
    return;
  }
  if (field.validate(msg)) {
    USER[field.key] = msg;
    STEP++; repeatCount = 0;
    setTimeout(() => nextQuestion(false), 800);
  } else {
    repeatCount++;
    if (repeatCount < 3) {
      setTimeout(() => nextQuestion(true), 600);
    } else {
      appendMessage("اگر تمایلی به پاسخ ندارید فقط بنویسید رد تا سوال بعدی پرسیده شود.", "bot");
      toggleInput(true);
      repeatCount = 0;
    }
  }
}

// شروع گفتگو
function startConversation() {
  appendMessage(
    "سلام و عرض ادب! من دکتر مشاور تخصصی تغذیه و ورزش هستم.<br>در این گفت‌وگو، فقط چند سؤال ساده و کاملاً محرمانه می‌پرسم تا بهترین راهنمایی را مخصوص بدن شما ارائه کنم.<br>همه اطلاعات فقط برای سلامت و موفقیت شماست. با حوصله و راحتی پاسخ بدهید، و هر سوالی داشتی بپرس.<br><br>بریم سراغ سؤال اول:",
    "bot"
  );
  setTimeout(() => nextQuestion(false), 1300);
  toggleInput(true);
}

sendButton.addEventListener("click", handleUserInput);
userInput.addEventListener("keypress", e => {
  if (e.key === "Enter" && !userInput.disabled) handleUserInput();
});
window.onload = startConversation;
</script>
</body>
</html>
