<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù…Ø´Ø§ÙˆØ± ØªØ®ØµØµÛŒ Ø§ÛŒØ±Ø§Ù† Ù¾ÙˆØ¯Ø±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
    body { font-family: 'Vazirmatn', sans-serif; background: #f3f4f6; }
    .chat-container { max-width: 600px; margin: 32px auto; background: #fff; border-radius: 1.5rem; box-shadow: 0 10px 25px rgba(0,0,0,.09); display: flex; flex-direction: column; min-height: 85vh; max-height: 820px; }
    .chat-header { background: linear-gradient(90deg, #6366f1 70%, #818cf8 100%); color: #fff; padding: 1.6rem; text-align: center; font-size: 1.3rem; font-weight: bold; border-top-left-radius: 1.5rem; border-top-right-radius: 1.5rem; }
    .chat-messages { flex: 1; padding: 1.3rem; overflow-y: auto; display: flex; flex-direction: column; gap: 1.1rem; background: #f9fafb; }
    .message { max-width: 92%; padding: .82rem 1.08rem; border-radius: 1rem; line-height: 1.8; font-size: 1.1rem; }
    .message.user { background: #e0e7ff; align-self: flex-end; color: #3730a3; border-bottom-right-radius: .2rem; }
    .message.bot { background: #f0fdf4; align-self: flex-start; color: #047857; border-bottom-left-radius: .2rem; }
    .chat-input-container { display: flex; padding: 1.2rem; border-top: 1px solid #e5e7eb; background: #fff; border-bottom-left-radius: 1.5rem; border-bottom-right-radius: 1.5rem; }
    .chat-input { flex: 1; padding: 0.8rem 1rem; border: 1px solid #d1d5db; border-radius: 0.8rem; font-size: 1.1rem; outline: none; text-align: right; }
    .send-button { background: #6366f1; color: #fff; border: none; padding: 0.8rem 1.2rem; border-radius: 0.8rem; margin-right: 1rem; cursor: pointer; font-size: 1.15rem; }
    .loading-indicator { display: flex; align-items: center; justify-content: flex-start; padding: 0.7rem 1rem; border-radius: 1rem; background: #e0f2fe; align-self: flex-start; color: #2563eb; }
    .loading-indicator .dot { width: 8px; height: 8px; background: #2563eb; border-radius: 50%; margin: 0 2px; animation: bounce 0.65s infinite alternate; }
    .loading-indicator .dot:nth-child(2) { animation-delay: .22s; }
    .loading-indicator .dot:nth-child(3) { animation-delay: .44s; }
    @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-6px); } }
  </style>
</head>
<body>
<div class="chat-container">
  <div class="chat-header">Ù…Ø´Ø§ÙˆØ± ØªØ®ØµØµÛŒ Ø§ÛŒØ±Ø§Ù† Ù¾ÙˆØ¯Ø±</div>
  <div class="chat-messages" id="chat-messages"></div>
  <div class="chat-input-container">
    <input type="text" id="user-input" class="chat-input" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." autocomplete="off" />
    <button id="send-button" class="send-button"><span>&#x1F680;</span></button>
  </div>
</div>
<script type="module">
// ======== Ø¢Ø¯Ø±Ø³ Cloudflare Worker Ø´Ù…Ø§ ========
const API_URL = "https://iranpowder.peymaancrafts.workers.dev/";

// ======== ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ùˆ Ø³ÙˆØ§Ù„Ø§Øª ========
const userFields = [
  "gender", "name", "age", "height", "weight",
  "goal", "trainingHistory", "dietActivity", "healthAllergies", "illnessHistory", "phone"
];

const questions = {
  gender: [
    "Ø¯Ø± Ø§Ø¨ØªØ¯Ø§ Ø¨ÙØ±Ù…Ø§ÛŒÛŒØ¯ Ø®Ø§Ù†Ù… Ù‡Ø³ØªÛŒØ¯ ÛŒØ§ Ø¢Ù‚Ø§ØŸ (Ø¬Ù†Ø³ÛŒØª Ø¨Ø±Ø§ÛŒ ØªÙ†Ø¸ÛŒÙ… Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯Ù‚ÛŒÙ‚ Ù…Ù‡Ù… Ø§Ø³Øª.)",
    "Ù„Ø·ÙØ§ Ù…Ø´Ø®Øµ Ú©Ù†ÛŒØ¯ Ø¬Ù†Ø³ÛŒØª Ø´Ù…Ø§ Ú†ÛŒØ³ØªØŸ (Ø®Ø§Ù†Ù… ÛŒØ§ Ø¢Ù‚Ø§)"
  ],
  name: [
    "Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø¨ÙØ±Ù…Ø§ÛŒÛŒØ¯ ØªØ§ Ø¨Ø§ Ù‡Ù… Ø±Ø§Ø­Øªâ€ŒØªØ± ØµØ­Ø¨Øª Ú©Ù†ÛŒÙ….",
    "Ù…ÛŒâ€ŒØªÙˆÙ†Ù… Ø§Ø³Ù…ØªÙˆÙ† Ø±Ùˆ Ø¨Ø¯ÙˆÙ†Ù…ØŸ Ø§ÛŒÙ† Ú©Ù…Ú© Ù…ÛŒâ€ŒÚ©Ù†Ù‡ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø´Ø®ØµÛŒ Ø¨Ø±Ø§ØªÙˆÙ† Ø·Ø±Ø§Ø­ÛŒ Ú©Ù†Ù…."
  ],
  age: [
    "Ø³Ù† Ø´Ù…Ø§ Ú†Ù†Ø¯ Ø³Ø§Ù„ Ø§Ø³ØªØŸ (ÙÙ‚Ø· Ø¹Ø¯Ø¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯)",
    "Ú†Ù†Ø¯ Ø³Ø§Ù„ Ø¯Ø§Ø±ÛŒØ¯ØŸ"
  ],
  height: [
    "Ù‚Ø¯ Ø´Ù…Ø§ Ú†Ù†Ø¯ Ø³Ø§Ù†ØªÛŒâ€ŒÙ…ØªØ± Ø§Ø³ØªØŸ (Ù…Ø«Ù„Ø§Ù‹ Û±Û¸Û°)",
    "Ù„Ø·ÙØ§ Ø¹Ø¯Ø¯ Ù‚Ø¯ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯."
  ],
  weight: [
    "ÙˆØ²Ù† ÙØ¹Ù„ÛŒ Ø´Ù…Ø§ Ú†Ù†Ø¯ Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù… Ø§Ø³ØªØŸ",
    "ÙˆØ²Ù†ØªØ§Ù† Ø±Ø§ Ù„Ø·ÙØ§Ù‹ Ø¨Ù‡ Ø¹Ø¯Ø¯ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯."
  ],
  goal: [
    "Ù‡Ø¯Ù Ø´Ù…Ø§ Ø§Ø² Ù…Ø´Ø§ÙˆØ±Ù‡ Ú†ÛŒØ³ØªØŸ Ù…Ø«Ù„Ø§ Ø§ÙØ²Ø§ÛŒØ´ Ø¹Ø¶Ù„Ù‡ØŒ Ú©Ø§Ù‡Ø´ ÙˆØ²Ù†ØŒ ÛŒØ§ ÙÙ‚Ø· Ø³Ù„Ø§Ù…Øª Ùˆ Ù†Ø´Ø§Ø·ØŸ",
    "Ú†Ù‡ Ù‡Ø¯Ù Ø¨Ø¯Ù†ÛŒ ÛŒØ§ ÙˆØ±Ø²Ø´ÛŒ Ø±Ø§ Ø¯Ù†Ø¨Ø§Ù„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ØŸ"
  ],
  trainingHistory: [
    "Ø³Ø§Ø¨Ù‚Ù‡ ØªÙ…Ø±ÛŒÙ†ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ØªÙˆØ¶ÛŒØ­ Ø¯Ù‡ÛŒØ¯. Ù…Ø«Ù„Ø§ Ú†Ù†Ø¯ Ø³Ø§Ù„ ÙˆØ±Ø²Ø´ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ Ùˆ Ú†Ù‡ ÙˆØ±Ø²Ø´ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒØ¯ØŸ",
    "Ú†Ù†Ø¯ ÙˆÙ‚Øª Ø§Ø³Øª ÙˆØ±Ø²Ø´ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ØŸ Ø³Ø·Ø­ Ø®ÙˆØ¯ Ø±Ø§ Ù…Ø¨ØªØ¯ÛŒØŒ Ù…ØªÙˆØ³Ø· ÛŒØ§ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ù…ÛŒâ€ŒØ¯Ø§Ù†ÛŒØ¯ØŸ"
  ],
  dietActivity: [
    "Ø±Ú˜ÛŒÙ… ØºØ°Ø§ÛŒÛŒ ÙØ¹Ù„ÛŒ Ùˆ Ù…ÛŒØ²Ø§Ù† ÙØ¹Ø§Ù„ÛŒØª Ø¨Ø¯Ù†ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø¨ÙØ±Ù…Ø§ÛŒÛŒØ¯.",
    "Ú†Ù†Ø¯ Ø±ÙˆØ² Ø¯Ø± Ù‡ÙØªÙ‡ ÙˆØ±Ø²Ø´ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ Ùˆ Ø±Ú˜ÛŒÙ… Ø®Ø§ØµÛŒ Ø¯Ø§Ø±ÛŒØ¯ØŸ"
  ],
  healthAllergies: [
    "Ø¢ÛŒØ§ Ø¨Ù‡ Ù…Ø§Ø¯Ù‡ ØºØ°Ø§ÛŒÛŒ ÛŒØ§ Ø¯Ø§Ø±ÙˆÛŒ Ø®Ø§ØµÛŒ Ø­Ø³Ø§Ø³ÛŒØª Ø¯Ø§Ø±ÛŒØ¯ØŸ",
    "Ø­Ø³Ø§Ø³ÛŒØª ÛŒØ§ Ø¢Ù„Ø±Ú˜ÛŒ ØºØ°Ø§ÛŒÛŒ Ø¯Ø§Ø±ÛŒØ¯ØŸ"
  ],
  illnessHistory: [
    "Ø¢ÛŒØ§ Ø¨ÛŒÙ…Ø§Ø±ÛŒ Ø®Ø§ØµÛŒ Ø¯Ø§Ø±ÛŒØ¯ ÛŒØ§ Ø¯Ø§Ø±ÙˆÛŒ Ø®Ø§ØµÛŒ Ù…ØµØ±Ù Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ØŸ",
    "Ø³ÙˆØ§Ø¨Ù‚ Ø¨ÛŒÙ…Ø§Ø±ÛŒ ÛŒØ§ Ù…Ø´Ú©Ù„Ø§Øª Ù¾Ø²Ø´Ú©ÛŒ Ø®Ø§ØµÛŒ Ø¯Ø§Ø±ÛŒØ¯ØŸ"
  ],
  phone: [
    "Ø¯Ø± ØµÙˆØ±Øª ØªÙ…Ø§ÛŒÙ„ØŒ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø®ÙˆØ¯ Ø±Ø§ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯ ØªØ§ Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±Ø¯. (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)",
    "Ø§Ú¯Ø± Ø¯ÙˆØ³Øª Ø¯Ø§Ø´ØªÛŒØ¯ØŒ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)."
  ]
};

let userInfo = Object.fromEntries(userFields.map(f => [f, null]));
let conversationState = "collecting_info";
let currentField = null;
let repeatCount = 0;

const iranPowderProducts = [
  { name: "Ù¾Ø±ÙˆØªØ¦ÛŒÙ† ÙˆÛŒ Ø§ÛŒØ±Ø§Ù† Ù¾ÙˆØ¯Ø±", price: "Û²,ÛµÛ°Û°,Û°Û°Û° ØªÙˆÙ…Ø§Ù†", howToUse: "ÛŒÚ© Ù¾ÛŒÙ…Ø§Ù†Ù‡ Ø¨Ø¹Ø¯ Ø§Ø² ØªÙ…Ø±ÛŒÙ†", sideEffects: "Ø¯Ø± ØµÙˆØ±Øª Ø­Ø³Ø§Ø³ÛŒØª Ø¨Ù‡ Ù„Ø§Ú©ØªÙˆØ² Ø¨Ø§ Ø§Ø­ØªÛŒØ§Ø· Ù…ØµØ±Ù Ø´ÙˆØ¯." },
  { name: "Ú¯ÛŒÙ†Ø± Ø§ÛŒØ±Ø§Ù† Ù¾ÙˆØ¯Ø±", price: "Û±,Û¸Û°Û°,Û°Û°Û° ØªÙˆÙ…Ø§Ù†", howToUse: "Ø¯Ùˆ Ù¾ÛŒÙ…Ø§Ù†Ù‡ Ø¯Ø± Ø±ÙˆØ²ØŒ Ø¨Ø¹Ø¯ Ø§Ø² ØªÙ…Ø±ÛŒÙ† Ùˆ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù…ÛŒØ§Ù†â€ŒÙˆØ¹Ø¯Ù‡", sideEffects: "Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¨Ø§Ø¹Ø« Ù†ÙØ® Ù…ÙˆÙ‚Øª Ø´ÙˆØ¯." },
  { name: "Ú©Ø±Ø§ØªÛŒÙ† Ù…ÙˆÙ†ÙˆÙ‡ÛŒØ¯Ø±Ø§Øª Ø§ÛŒØ±Ø§Ù† Ù¾ÙˆØ¯Ø±", price: "Û¹ÛµÛ°,Û°Û°Û° ØªÙˆÙ…Ø§Ù†", howToUse: "Ûµ Ú¯Ø±Ù… Ø¯Ø± Ø±ÙˆØ² Ù‡Ù…Ø±Ø§Ù‡ Ø¨Ø§ Ø¢Ø¨ ÛŒØ§ Ø¢Ø¨Ù…ÛŒÙˆÙ‡", sideEffects: "Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù…ØµØ±Ù Ø¢Ø¨ ÙØ±Ø§ÙˆØ§Ù† Ø¯Ø§Ø±Ø¯." },
];

// ======== UI ========
const chatMessages = document.getElementById("chat-messages");
const userInput = document.getElementById("user-input");
const sendButton = document.getElementById("send-button");

function appendMessage(text, sender) {
  const messageDiv = document.createElement("div");
  messageDiv.classList.add("message", sender);
  messageDiv.innerHTML = sender === "bot" ? text.replace(/Ø§ÛŒØ±Ø§Ù† Ù¾ÙˆØ¯Ø±/g, "<strong>Ø§ÛŒØ±Ø§Ù† Ù¾ÙˆØ¯Ø±</strong>") : text;
  chatMessages.appendChild(messageDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

function showLoadingIndicator(text = "") {
  const loadingDiv = document.createElement("div");
  loadingDiv.classList.add("loading-indicator");
  loadingDiv.innerHTML = text
    ? `<span>${text}</span>`
    : `<div class="dot"></div><div class="dot"></div><div class="dot"></div>`;
  chatMessages.appendChild(loadingDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
  return loadingDiv;
}
function removeElement(element) {
  if (element && element.parentNode) element.parentNode.removeChild(element);
}
function toggleInput(enabled) {
  userInput.disabled = !enabled;
  sendButton.disabled = !enabled;
  if (enabled) userInput.focus();
}

function pickRandom(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}

// ======== Ù…Ù†Ø·Ù‚ Ø³ÙˆØ§Ù„Ø§Øª ========
function getNextField() {
  return userFields.find(f => userInfo[f] === null);
}

function askNextQuestion(isRepeat = false) {
  currentField = getNextField();
  if (!currentField || (currentField === "phone" && Object.values(userInfo).filter(v => v === null).length === 1)) {
    appendMessage("Ø®ÛŒÙ„ÛŒ Ù…Ù…Ù†ÙˆÙ† Ø¨Ø§Ø¨Øª Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§! Ø­Ø§Ù„Ø§ Ù…Ù†Ø§Ø³Ø¨â€ŒØªØ±ÛŒÙ† Ù…Ú©Ù…Ù„â€ŒÙ‡Ø§ Ùˆ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø´Ø±Ø§ÛŒØ· Ø´Ù…Ø§ Ù…Ø¹Ø±ÙÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ù…. Ù„Ø·ÙØ§Ù‹ Ú†Ù†Ø¯ Ù„Ø­Ø¸Ù‡ ØµØ¨Ø± Ú©Ù†ÛŒØ¯ ...", "bot");
    conversationState = "recommendation";
    handleRecommendation();
    return;
  }
  let prompt = pickRandom(questions[currentField]);
  if (isRepeat) {
    prompt = `<span style='color:#d97706'>Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§ÙˆØ±Ù‡ Ù…Ù‡Ù… Ø§Ø³Øª.</span><br>` + prompt;
  }
  appendMessage(prompt, "bot");
  toggleInput(true);
}

function isValidAnswer(field, value) {
  value = value.trim();
  if (!value) return false;
  if (field === "gender") return /^(Ø®Ø§Ù†Ù…|Ø¢Ù‚Ø§|Ù…Ø±Ø¯|Ø²Ù†)$/i.test(value);
  if (field === "age") return /^\d+$/.test(value) && +value > 10 && +value < 100;
  if (field === "height") return /^\d+$/.test(value) && +value > 100 && +value < 250;
  if (field === "weight") return /^\d+$/.test(value) && +value > 20 && +value < 300;
  if (field === "phone" && value && !/^(\+98|0)?9\d{9}$/.test(value)) return false;
  // Ø³Ø§ÛŒØ± ÙÛŒÙ„Ø¯Ù‡Ø§ Ø¨Ø§ ÛŒÚ© Ø¬Ù…Ù„Ù‡ Ù‡Ù… Ù…Ø¹ØªØ¨Ø±Ù†Ø¯
  return true;
}

// ======== ØªÙˆØµÛŒÙ‡ Ù†Ù‡Ø§ÛŒÛŒ Ùˆ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù¾Ø±Ø§Ú©Ø³ÛŒ ========
async function fetchWithRetry(prompt) {
  for (let attempt = 1; attempt <= 2; attempt++) {
    try {
      const response = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: prompt }] }] }),
      });
      if (!response.ok) throw new Error(`API Error: ${response.status}`);
      const result = await response.json();
      let text = (result?.candidates?.[0]?.content?.parts?.[0]?.text ?? "").trim();
      return text || "Ù¾Ø§Ø³Ø®ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯!";
    } catch (error) {
      if (attempt < 2) {
        showLoadingIndicator(`Ø¯Ø± Ø­Ø§Ù„ ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯ Ø¨Ø±Ø§ÛŒ Ø§Ø±ØªØ¨Ø§Ø·...`);
        await new Promise(r => setTimeout(r, attempt * 1300));
      } else throw error;
    }
  }
}

async function handleRecommendation() {
  toggleInput(false);
  const loading = showLoadingIndicator("Ø¯Ø± Ø­Ø§Ù„ ØªØ­Ù„ÛŒÙ„ ØªØ®ØµØµÛŒ Ø´Ø±Ø§ÛŒØ· Ø´Ù…Ø§...");
  const prompt = `
    Ø´Ù…Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† ÛŒÚ© Ù…Ø´Ø§ÙˆØ± ØªØºØ°ÛŒÙ‡ Ùˆ Ù…Ú©Ù…Ù„ ÙˆØ±Ø²Ø´ÛŒ Ø¨Ø³ÛŒØ§Ø± Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ù†Ø¯ Ø§ÛŒØ±Ø§Ù† Ù¾ÙˆØ¯Ø± Ø¨Ø§ÛŒØ¯ Ø¨Ø§ ØªÙˆØ¬Ù‡ Ø¨Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø²ÛŒØ±:
    Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±: ${JSON.stringify(userInfo)}
    Ù…Ø­ØµÙˆÙ„Ø§Øª: ${JSON.stringify(iranPowderProducts)}
    1. Ø¨Ø§ Ù†Ø§Ù… Ùˆ Ø§Ø­ØªØ±Ø§Ù… Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø´Ø±ÙˆØ¹ Ú©Ù† Ùˆ ØªÙˆØ¶ÛŒØ­ Ø¨Ø¯Ù‡ ØªØ­Ù„ÛŒÙ„â€ŒÙ‡Ø§ÛŒØª Ø¨Ø± Ø§Ø³Ø§Ø³ Ø´Ø±Ø§ÛŒØ· Ø§ÙˆØ³Øª.
    2. Ø¨Ù‡ØªØ±ÛŒÙ† Ù…Ú©Ù…Ù„â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ù‡Ø¯Ù Ùˆ Ø´Ø±Ø§ÛŒØ·Ø´ ØªØ­Ù„ÛŒÙ„ Ùˆ Ù…Ø¹Ø±ÙÛŒ Ú©Ù† (Ø­Ø¯Ø§Ú©Ø«Ø± Ø³Ù‡ Ù…ÙˆØ±Ø¯).
    3. Ù‚ÛŒÙ…Øª Ùˆ Ù†Ø­ÙˆÙ‡ Ù…ØµØ±Ù Ù‡Ø± Ù…Ú©Ù…Ù„ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³.
    4. Ù†Ú©ØªÙ‡ Ù†Ù‡Ø§ÛŒÛŒ ÛŒØ§ ØªÙˆØµÛŒÙ‡ Ú©ÙˆØªØ§Ù‡ Ø¨Ø±Ø§ÛŒ Ø³Ø¨Ú© Ø²Ù†Ø¯Ú¯ÛŒ Ø³Ø§Ù„Ù… ÛŒØ§ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¨Ù†ÙˆÛŒØ³.
    5. Ø®Ø±ÙˆØ¬ÛŒ ÙÙ‚Ø· Ù…ØªÙ† ÙØ§Ø±Ø³ÛŒ Ø¨Ø§Ø´Ø¯ Ùˆ Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
  `;
  try {
    const res = await fetchWithRetry(prompt);
    removeElement(loading);
    appendMessage(res, "bot");
    toggleInput(true);
  } catch (e) {
    removeElement(loading);
    appendMessage("Ù…ØªØ§Ø³ÙØ§Ù†Ù‡ Ø³ÛŒØ³ØªÙ… Ù…Ø´Ø§ÙˆØ±Ù‡ ÙØ¹Ù„Ø§ Ù¾Ø§Ø³Ø®Ú¯Ùˆ Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ú†Ù†Ø¯ Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¯ÛŒÚ¯Ø± Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.", "bot");
  }
}

// ======== Ù‡Ù†Ø¯Ù„ÛŒÙ†Ú¯ ÙˆØ±ÙˆØ¯ÛŒ ========
async function handleUserInput() {
  const msg = userInput.value.trim();
  if (!msg) return;
  appendMessage(msg, "user");
  userInput.value = "";
  toggleInput(false);

  // Ø°Ø®ÛŒØ±Ù‡ Ù…Ù‚Ø¯Ø§Ø± ÛŒØ§ ØªÚ©Ø±Ø§Ø± Ø³ÙˆØ§Ù„
  if (conversationState === "collecting_info" && currentField) {
    if (isValidAnswer(currentField, msg)) {
      userInfo[currentField] = msg;
      repeatCount = 0;
      setTimeout(() => askNextQuestion(), 550);
    } else {
      repeatCount++;
      if (repeatCount < 3) setTimeout(() => askNextQuestion(true), 400);
      else {
        appendMessage("Ø§Ú¯Ø± Ø¨Ù‡ Ù‡Ø± Ø¯Ù„ÛŒÙ„ÛŒ Ù…Ø§ÛŒÙ„ Ø¨Ù‡ Ù¾Ø§Ø³Ø® Ù†ÛŒØ³ØªÛŒØ¯ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ÙÙ‚Ø· Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯ \"Ø±Ø¯\" ÛŒØ§ \"Ù‡ÛŒÚ†\" ØªØ§ Ø¨Ù‡ Ø³ÙˆØ§Ù„ Ø¨Ø¹Ø¯ Ø¨Ø±ÙˆÛŒÙ….", "bot");
        toggleInput(true);
        repeatCount = 0;
      }
    }
  }
}

// ======== Ø´Ø±ÙˆØ¹ Ù…Ú©Ø§Ù„Ù…Ù‡ ========
function startConversation() {
  appendMessage(
    "Ø³Ù„Ø§Ù…! Ø¨Ù‡ Ù…Ø´Ø§ÙˆØ±Ù‡ ØªØ®ØµØµÛŒ <strong>Ø§ÛŒØ±Ø§Ù† Ù¾ÙˆØ¯Ø±</strong> Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ ğŸ˜Š<br>Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¨Ù‡ØªØ±ÛŒÙ† Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±Ø§ Ø§Ø±Ø§Ø¦Ù‡ Ø¨Ø¯Ù… Ú†Ù†Ø¯ Ø³ÙˆØ§Ù„ Ú©ÙˆØªØ§Ù‡ Ù…ÛŒâ€ŒÙ¾Ø±Ø³Ù…Ø› Ù„Ø·ÙØ§Ù‹ Ø¨Ø§ Ø­ÙˆØµÙ„Ù‡ Ùˆ ØµØ¯Ø§Ù‚Øª Ø¬ÙˆØ§Ø¨ Ø¯Ù‡ÛŒØ¯.<br><span style='color:#6366f1'>Ø¯Ø± Ù‡Ø± Ù…Ø±Ø­Ù„Ù‡ Ø§Ú¯Ø± Ø³ÙˆØ§Ù„ÛŒ Ø¯Ø§Ø´ØªÛŒØ¯ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ù¾Ø±Ø³ÛŒØ¯.</span>",
    "bot"
  );
  setTimeout(() => askNextQuestion(), 1000);
  toggleInput(true);
}

sendButton.addEventListener("click", handleUserInput);
userInput.addEventListener("keypress", e => {
  if (e.key === "Enter" && !userInput.disabled) handleUserInput();
});
window.onload = startConversation;
</script>
</body>
</html>
