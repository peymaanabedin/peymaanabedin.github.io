<!DOCTYPE html>
<html lang="en" dir="ltr" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>PromptVault Pro</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />

  <meta name="theme-color" content="#ffffff" id="meta-theme-color">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
          animation: {
            'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
            'fade-in': 'fadeIn 0.2s ease-out',
            'pop': 'pop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275)'
          },
          keyframes: {
            slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
            fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
            pop: { '0%': { transform: 'scale(0.8)' }, '100%': { transform: 'scale(1)' } }
          }
        }
      }
    }
  </script>

  <style>
    body { -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; user-select: none; }
    .hide-scroll::-webkit-scrollbar { display: none; }
    .touch-scale:active { transform: scale(0.96); transition: transform 0.1s; }
    
    .glass { 
      background: rgba(255,255,255,0.85); 
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(0,0,0,0.05); 
    }
    .dark .glass { 
      background: rgba(17,24,39,0.85); 
      border-bottom: 1px solid rgba(255,255,255,0.05); 
    }
    
    /* Prevent iOS Zoom on Inputs */
    input, textarea { font-size: 16px !important; }
    
    /* Long press highlighting */
    .pressing { transform: scale(0.95); opacity: 0.8; transition: all 0.2s; }
  </style>
</head>

<body class="bg-gray-50 text-gray-900 dark:bg-gray-950 dark:text-gray-100 h-[100dvh] flex flex-col overflow-hidden w-full transition-colors duration-200">

  <header class="flex-none z-30 w-full glass absolute top-0 left-0 transition-colors">
    <div class="px-4 pt-safe-top pb-2 flex justify-between items-center h-16 mt-safe">
      <div class="flex items-center gap-3">
        <img src="https://i.postimg.cc/J7qwgGck/App-Icon-2x.png" class="w-10 h-10 rounded-xl shadow-sm border border-black/5 dark:border-white/10" alt="Logo">
        <h1 class="text-xl font-bold tracking-tight">PromptVault</h1>
      </div>
      <button id="btn-settings" class="w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center touch-scale">
        <i class="fa-solid fa-gear text-gray-600 dark:text-gray-300"></i>
      </button>
    </div>

    <nav class="flex items-center gap-2 px-4 pb-3 overflow-x-auto hide-scroll w-full border-b border-gray-200/50 dark:border-gray-800" id="nav-cats"></nav>
  </header>

  <div class="flex-none pt-[7.5rem] px-4 pb-2 z-20 bg-gray-50 dark:bg-gray-950 transition-colors">
    <div class="relative group">
      <i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-blue-500 transition-colors"></i>
      <input type="text" id="search-input" class="w-full bg-white dark:bg-gray-900 pl-11 pr-12 py-3.5 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-800 focus:ring-2 focus:ring-blue-500 outline-none transition-shadow" placeholder="Search prompts..." autocomplete="off">
      
      <button id="btn-clear-search" class="hidden absolute right-12 top-1/2 -translate-y-1/2 w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-500 flex items-center justify-center text-xs touch-scale">
        <i class="fa-solid fa-xmark"></i>
      </button>

      <button id="btn-view" class="absolute right-2 top-1/2 -translate-y-1/2 w-9 h-9 flex items-center justify-center text-gray-400 hover:text-blue-500 touch-scale">
        <i class="fa-solid fa-grid-2"></i>
      </button>
    </div>
  </div>

  <main id="scroll-area" class="flex-grow overflow-y-auto px-4 pb-32 hide-scroll relative">
    <div id="grid-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 pb-6"></div>
    <div id="empty-state" class="hidden flex flex-col items-center justify-center py-24 text-center opacity-50">
      <div class="w-20 h-20 bg-gray-200 dark:bg-gray-800 rounded-full flex items-center justify-center mb-4 text-3xl">
        <i class="fa-solid fa-layer-group text-gray-400"></i>
      </div>
      <p class="font-medium">No prompts found</p>
    </div>
  </main>

  <button id="btn-add" class="fixed bottom-6 right-6 w-14 h-14 bg-gradient-to-tr from-blue-600 to-indigo-600 text-white rounded-full shadow-xl shadow-blue-600/30 flex items-center justify-center text-2xl touch-scale z-40 animate-pop">
    <i class="fa-solid fa-plus"></i>
  </button>

  <div id="modal-form" class="fixed inset-0 z-50 hidden" role="dialog">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm opacity-0 transition-opacity" id="form-backdrop"></div>
    <div class="absolute bottom-0 left-0 right-0 bg-white dark:bg-gray-900 rounded-t-[2rem] max-h-[92dvh] flex flex-col transform translate-y-full transition-transform duration-300" id="form-panel">
      
      <div class="w-full flex justify-center pt-3 pb-1">
        <div class="w-12 h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full"></div>
      </div>

      <div class="flex justify-between items-center px-5 py-2 border-b border-gray-50 dark:border-gray-800/50">
        <button id="btn-cancel-form" class="text-gray-500 font-medium px-2 py-2 touch-scale">Cancel</button>
        <h3 class="font-bold text-lg" id="form-title">New Prompt</h3>
        <button id="btn-save-form" class="text-blue-600 font-bold px-2 py-2 touch-scale">Save</button>
      </div>

      <div class="overflow-y-auto p-5 space-y-6 hide-scroll pb-10" id="form-content">
        <form id="main-form" class="space-y-5">
          <input type="hidden" id="inp-id">
          
          <div class="relative w-full h-44 bg-gray-50 dark:bg-gray-800/50 rounded-2xl flex flex-col items-center justify-center border-2 border-dashed border-gray-200 dark:border-gray-700 overflow-hidden group transition-colors" id="img-zone">
            <img id="img-preview" class="absolute inset-0 w-full h-full object-cover hidden z-10" />
            <div id="img-placeholder" class="text-center text-gray-400 group-hover:text-blue-500 transition-colors">
              <i class="fa-solid fa-cloud-arrow-up text-3xl mb-2"></i>
              <div class="text-xs font-bold uppercase tracking-wide">Upload Image</div>
            </div>
            <input type="file" id="inp-file" accept="image/*" class="absolute inset-0 opacity-0 z-20 cursor-pointer">
            <button type="button" id="btn-clear-img" class="absolute top-3 right-3 z-30 w-8 h-8 bg-black/50 backdrop-blur text-white rounded-full hidden items-center justify-center touch-scale"><i class="fa-solid fa-xmark"></i></button>
          </div>

          <div class="space-y-2">
            <label class="text-[11px] font-bold text-gray-400 uppercase ml-1 tracking-wider">Prompt Name</label>
            <input type="text" id="inp-name" class="w-full bg-gray-100 dark:bg-gray-800 border-none rounded-xl px-4 py-3.5 font-semibold focus:ring-2 focus:ring-blue-500 transition-all placeholder-gray-400" placeholder="e.g. Minimalist Logo">
          </div>

          <div class="space-y-2">
            <label class="text-[11px] font-bold text-gray-400 uppercase ml-1 tracking-wider">Category</label>
            <div class="flex gap-2 overflow-x-auto hide-scroll pt-1" id="form-cats"></div>
          </div>

          <div class="space-y-2">
            <div class="flex justify-between items-end px-1">
              <label class="text-[11px] font-bold text-gray-400 uppercase tracking-wider">The Prompt</label>
              <button type="button" id="btn-paste" class="text-[10px] bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 px-3 py-1.5 rounded-lg font-bold touch-scale flex items-center gap-1.5">
                <i class="fa-solid fa-paste"></i> PASTE
              </button>
            </div>
            <textarea id="inp-prompt" rows="6" class="w-full bg-gray-100 dark:bg-gray-800 border-none rounded-2xl p-4 text-base leading-relaxed focus:ring-2 focus:ring-blue-500 transition-all placeholder-gray-400" placeholder="Detailed description of the prompt..."></textarea>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div id="modal-detail" class="fixed inset-0 z-50 hidden" role="dialog">
    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm opacity-0 transition-opacity duration-200" id="detail-backdrop"></div>
    
    <div class="absolute inset-x-0 bottom-0 top-16 bg-white dark:bg-gray-900 rounded-t-[2rem] flex flex-col transform translate-y-full transition-transform duration-300 shadow-2xl" id="detail-panel">
      
      <div class="flex-none h-16 px-5 flex justify-between items-center border-b border-gray-100 dark:border-gray-800">
        <button id="btn-close-detail" class="w-9 h-9 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center touch-scale text-gray-500"><i class="fa-solid fa-chevron-down"></i></button>
        <span id="detail-cat-badge" class="text-[10px] font-extrabold uppercase bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 px-3 py-1.5 rounded-lg tracking-wider">BRANDING</span>
      </div>

      <div class="flex-1 overflow-y-auto hide-scroll p-0 pb-4">
        <div class="w-full h-72 bg-gray-100 dark:bg-gray-800 relative group cursor-zoom-in" onclick="openFullscreen()">
            <img id="detail-img" class="w-full h-full object-contain bg-black/5 dark:bg-black/20">
            <div class="absolute bottom-3 right-3 bg-black/60 text-white text-[10px] font-bold px-3 py-1.5 rounded-full backdrop-blur pointer-events-none flex items-center gap-1">
              <i class="fa-solid fa-expand"></i> Tap to View
            </div>
        </div>
        
        <div class="p-6">
            <div class="flex justify-between items-start mb-5">
                <h2 id="detail-title" class="text-2xl font-bold leading-tight pr-4"></h2>
                <button id="detail-fav-btn" class="w-11 h-11 rounded-full bg-gray-50 dark:bg-gray-800 flex-shrink-0 flex items-center justify-center text-2xl transition-all touch-scale">
                    <i class="fa-regular fa-heart text-gray-400"></i>
                </button>
            </div>
            
            <div class="bg-gray-50 dark:bg-gray-800/50 p-5 rounded-2xl border border-gray-100 dark:border-gray-800">
                <p id="detail-text" class="text-[15px] text-gray-700 dark:text-gray-300 leading-relaxed whitespace-pre-wrap select-text font-medium"></p>
            </div>
        </div>
      </div>

      <div class="flex-none p-4 bg-white dark:bg-gray-900 border-t border-gray-100 dark:border-gray-800 grid grid-cols-4 gap-3 z-20 pb-safe-bottom">
        <button id="act-copy" class="col-span-2 bg-blue-600 text-white rounded-xl py-3.5 font-bold shadow-lg shadow-blue-600/20 touch-scale flex items-center justify-center gap-2">
            <i class="fa-regular fa-copy"></i> Copy
        </button>
        <button id="act-edit" class="bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 rounded-xl py-3.5 font-bold touch-scale flex flex-col items-center justify-center text-[10px] gap-0.5">
            <i class="fa-solid fa-pen text-sm"></i> Edit
        </button>
        <button id="act-more" class="bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 rounded-xl py-3.5 font-bold touch-scale flex flex-col items-center justify-center text-[10px] gap-0.5">
             <i class="fa-solid fa-ellipsis text-sm"></i> More
        </button>
      </div>
    </div>
  </div>

  <div id="ctx-menu" class="fixed inset-0 z-[60] hidden" role="dialog">
    <div class="absolute inset-0 bg-black/40 backdrop-blur-[2px] opacity-0 transition-opacity" id="ctx-backdrop"></div>
    <div class="absolute bottom-6 left-4 right-4 bg-white dark:bg-gray-900 rounded-2xl shadow-2xl overflow-hidden transform scale-95 opacity-0 transition-all origin-bottom" id="ctx-panel">
      <div class="p-4 border-b border-gray-100 dark:border-gray-800 text-center bg-gray-50/50 dark:bg-gray-800/20">
        <h4 id="ctx-title" class="font-bold text-sm truncate text-gray-500">Actions</h4>
      </div>
      <div class="p-2 space-y-1">
        <button id="ctx-fav" class="w-full text-left px-4 py-3.5 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800 flex items-center gap-3 font-semibold transition-colors">
            <div class="w-6 text-center"><i class="fa-regular fa-heart"></i></div> <span>Favorites</span>
        </button>
        <button id="ctx-dup" class="w-full text-left px-4 py-3.5 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800 flex items-center gap-3 font-semibold transition-colors">
            <div class="w-6 text-center"><i class="fa-solid fa-clone text-blue-500"></i></div> <span>Duplicate</span>
        </button>
        <button id="ctx-edit" class="w-full text-left px-4 py-3.5 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800 flex items-center gap-3 font-semibold transition-colors">
            <div class="w-6 text-center"><i class="fa-solid fa-pen text-gray-500"></i></div> <span>Edit</span>
        </button>
        <div class="h-px bg-gray-100 dark:bg-gray-800 my-1 mx-2"></div>
        <button id="ctx-del" class="w-full text-left px-4 py-3.5 rounded-xl hover:bg-red-50 dark:hover:bg-red-900/20 text-red-500 flex items-center gap-3 font-semibold transition-colors">
            <div class="w-6 text-center"><i class="fa-solid fa-trash"></i></div> <span>Delete</span>
        </button>
      </div>
      <div class="p-2">
        <button id="ctx-cancel" class="w-full py-3.5 rounded-xl font-bold text-gray-500 bg-gray-100 dark:bg-gray-800">Cancel</button>
      </div>
    </div>
  </div>

  <div id="modal-fs" class="fixed inset-0 z-[70] bg-black hidden flex-col justify-center animate-fade-in">
    <button onclick="closeFullscreen()" class="absolute top-6 right-6 z-50 w-10 h-10 bg-white/20 text-white rounded-full flex items-center justify-center backdrop-blur touch-scale"><i class="fa-solid fa-xmark"></i></button>
    <img id="fs-img" class="w-full max-h-screen object-contain">
  </div>

  <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-gray-900/90 dark:bg-white/90 backdrop-blur text-white dark:text-black px-6 py-3 rounded-full shadow-2xl text-sm font-bold transition-all duration-300 opacity-0 translate-y-4 pointer-events-none z-[80]"></div>

  <script>
    // Config
    const DB_NAME = 'PV_Pro_v4';
    
    // Updated Categories with Branding
    const CATS = [
      {id:'all', label:'All', icon:'fa-layer-group'},
      {id:'fav', label:'Favorites', icon:'fa-heart text-red-500'},
      {id:'branding', label:'Branding', icon:'fa-vector-square'}, // NEW
      {id:'art', label:'Art', icon:'fa-palette'},
      {id:'photo', label:'Photo', icon:'fa-camera'},
      {id:'personal', label:'Personal', icon:'fa-user'},
      {id:'work', label:'Work', icon:'fa-briefcase'}
    ];
    
    let db, prompts=[], filtered=[], currentCat='all', view='grid', editId=null, imgBlob=null, longPressTimer;
    
    const $ = id => document.getElementById(id);
    const vib = () => navigator.vibrate?.(10);
    const showToast = msg => {
        const t = $('toast'); t.innerText=msg; t.classList.remove('opacity-0','translate-y-4');
        setTimeout(()=>t.classList.add('opacity-0','translate-y-4'),2000);
    };

    // DB Init
    const initDB = () => new Promise(res => {
        const r = indexedDB.open(DB_NAME, 1);
        r.onupgradeneeded = e => e.target.result.createObjectStore('prompts', {keyPath:'id'});
        r.onsuccess = () => { db = r.result; res(); };
    });
    const dbOp = (mode, fn) => new Promise(res => {
        const tx = db.transaction('prompts', mode);
        const req = fn(tx.objectStore('prompts'));
        req.onsuccess = () => res(req.result);
    });

    // App Start
    async function init() {
        if(localStorage.getItem('theme')==='dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) document.documentElement.classList.add('dark');
        await initDB();
        renderCats();
        loadData();
        setupEvents();
    }

    async function loadData() {
        prompts = await dbOp('readonly', s => s.getAll());
        prompts.sort((a,b) => b.id - a.id);
        applyFilter();
    }

    function applyFilter() {
        const q = $('search-input').value.toLowerCase();
        filtered = prompts.filter(p => {
            const cm = currentCat==='all' ? true : (currentCat==='fav' ? p.fav : p.cat===currentCat);
            return cm && (p.name.toLowerCase().includes(q) || p.prompt.toLowerCase().includes(q));
        });
        
        // Show/Hide Clear Button
        if (q.length > 0) $('btn-clear-search').classList.remove('hidden');
        else $('btn-clear-search').classList.add('hidden');

        renderGrid();
    }

    function renderGrid() {
        const grid = $('grid-container');
        grid.innerHTML = '';
        if(filtered.length===0) return $('empty-state').classList.remove('hidden');
        $('empty-state').classList.add('hidden');

        // Render subset for performance
        filtered.slice(0, 50).forEach(p => {
            const url = p.img ? URL.createObjectURL(p.img) : null;
            const card = document.createElement('div');
            
            // Reliable Long Press
            const startPress = (e) => { 
               card.classList.add('pressing');
               longPressTimer = setTimeout(() => { 
                   card.classList.remove('pressing');
                   openContextMenu(p); 
               }, 600); 
            };
            const cancelPress = () => { 
               card.classList.remove('pressing');
               clearTimeout(longPressTimer); 
            };
            
            card.addEventListener('touchstart', startPress, {passive:true});
            card.addEventListener('touchend', cancelPress);
            card.addEventListener('touchmove', cancelPress);
            card.addEventListener('contextmenu', e => { e.preventDefault(); openContextMenu(p); });

            card.onclick = () => {
                if(card.classList.contains('pressing')) return; // prevent click on long press
                openDetail(p);
            };

            if(view === 'grid') {
                card.className = 'relative aspect-square rounded-2xl bg-white dark:bg-gray-800 shadow-sm border border-black/5 dark:border-white/5 overflow-hidden transition-transform animate-fade-in select-none';
                card.innerHTML = `
                    ${url ? `<img src="${url}" class="w-full h-full object-cover">` : `<div class="w-full h-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white text-2xl font-extrabold">${p.name[0]}</div>`}
                    ${p.fav ? '<div class="absolute top-2 right-2 w-7 h-7 bg-white/90 dark:bg-black/60 backdrop-blur rounded-full flex items-center justify-center text-red-500 text-xs shadow-sm"><i class="fa-solid fa-heart"></i></div>' : ''}
                    <div class="absolute bottom-0 inset-x-0 p-3 bg-gradient-to-t from-black/80 via-black/40 to-transparent">
                        <p class="text-white text-xs font-bold truncate">${p.name}</p>
                    </div>
                `;
            } else {
                card.className = 'flex items-center gap-4 p-3 bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-black/5 dark:border-white/5 touch-scale animate-fade-in select-none';
                card.innerHTML = `
                    <div class="w-16 h-16 rounded-xl overflow-hidden flex-shrink-0 bg-gray-100">
                         ${url ? `<img src="${url}" class="w-full h-full object-cover">` : `<div class="w-full h-full bg-indigo-500 flex items-center justify-center text-white font-bold text-xl">${p.name[0]}</div>`}
                    </div>
                    <div class="flex-grow min-w-0">
                        <div class="flex justify-between items-center mb-1">
                            <h4 class="font-bold text-sm dark:text-gray-100 truncate">${p.name}</h4>
                            ${p.fav ? '<i class="fa-solid fa-heart text-red-500 text-xs"></i>' : ''}
                        </div>
                        <p class="text-xs text-gray-500 truncate leading-relaxed">${p.prompt}</p>
                    </div>
                `;
            }
            grid.appendChild(card);
        });
    }

    // --- Detail Modal ---
    function openDetail(p) {
        vib();
        editId = p.id;
        $('detail-title').innerText = p.name;
        $('detail-text').innerText = p.prompt;
        $('detail-cat-badge').innerText = CATS.find(c=>c.id===p.cat)?.label || 'Other';
        
        const url = p.img ? URL.createObjectURL(p.img) : null;
        $('detail-img').src = url || '';
        $('detail-img').parentElement.style.display = url ? 'block' : 'none';

        updateFavIcon(p.fav);

        const modal = $('modal-detail');
        const panel = $('detail-panel');
        const backdrop = $('detail-backdrop');
        
        modal.classList.remove('hidden');
        setTimeout(() => {
            backdrop.classList.remove('opacity-0');
            panel.classList.remove('translate-y-full');
        }, 10);
    }

    function updateFavIcon(isFav) {
        const btn = $('detail-fav-btn');
        btn.innerHTML = `<i class="fa-${isFav?'solid':'regular'} fa-heart ${isFav?'text-red-500':'text-gray-400'}"></i>`;
        btn.className = `w-11 h-11 rounded-full flex-shrink-0 flex items-center justify-center text-2xl transition-all touch-scale ${isFav ? 'bg-red-50 dark:bg-red-900/20' : 'bg-gray-50 dark:bg-gray-800'}`;
        
        btn.onclick = async () => {
            const p = prompts.find(x=>x.id===editId);
            p.fav = !p.fav;
            await dbOp('readwrite', s=>s.put(p));
            updateFavIcon(p.fav);
            applyFilter();
        };
    }

    // --- Context Menu ---
    let ctxId = null;
    function openContextMenu(p) {
        vib();
        ctxId = p.id;
        $('ctx-title').innerText = p.name;
        
        // Dynamic Fav Text
        const favBtn = $('ctx-fav');
        favBtn.innerHTML = `<div class="w-6 text-center"><i class="fa-${p.fav?'solid':'regular'} fa-heart ${p.fav?'text-red-500':''}"></i></div> <span>${p.fav?'Remove Favorite':'Add Favorite'}</span>`;
        
        const modal = $('ctx-menu');
        const panel = $('ctx-panel');
        modal.classList.remove('hidden');
        setTimeout(() => {
            $('ctx-backdrop').classList.remove('opacity-0');
            panel.classList.remove('opacity-0', 'scale-95');
        }, 10);
    }

    function closeCtx() {
        $('ctx-panel').classList.add('opacity-0', 'scale-95');
        $('ctx-backdrop').classList.add('opacity-0');
        setTimeout(() => $('ctx-menu').classList.add('hidden'), 200);
    }

    async function handleCtxAction(action) {
        closeCtx();
        const p = prompts.find(x=>x.id===ctxId);
        if(!p) return;

        if(action === 'fav') {
            p.fav = !p.fav;
            await dbOp('readwrite', s=>s.put(p));
            showToast(p.fav ? 'Added to Favorites' : 'Removed from Favorites');
        } else if (action === 'dup') {
            const copy = {...p, id: Date.now(), name: p.name + ' (Copy)', fav: false};
            await dbOp('readwrite', s=>s.put(copy));
            showToast('Prompt Duplicated');
        } else if (action === 'del') {
            if(confirm('Delete this prompt?')) {
                await dbOp('readwrite', s=>s.delete(ctxId));
                showToast('Deleted');
            }
        } else if (action === 'edit') {
            openForm(p);
            return;
        }
        loadData();
    }

    // --- Form Logic ---
    function openForm(editObj = null) {
        vib();
        $('main-form').reset();
        editId = editObj ? editObj.id : null;
        imgBlob = editObj ? editObj.img : null;
        
        $('form-title').innerText = editId ? 'Edit Prompt' : 'New Prompt';
        $('inp-name').value = editObj ? editObj.name : '';
        $('inp-prompt').value = editObj ? editObj.prompt : '';
        
        // Cat Radio
        const catVal = editObj ? editObj.cat : 'branding'; // Default to Branding if new
        const radio = document.querySelector(`input[name="cat"][value="${catVal}"]`);
        if(radio) radio.checked = true;

        updateImgPreview();
        
        const modal = $('modal-form');
        modal.classList.remove('hidden');
        setTimeout(() => {
            $('form-backdrop').classList.remove('opacity-0');
            $('form-panel').classList.remove('translate-y-full');
        }, 10);
    }

    async function savePrompt() {
        const name = $('inp-name').value.trim() || 'Untitled';
        const prompt = $('inp-prompt').value.trim();
        if(!prompt) return showToast('Prompt is empty!');
        const cat = document.querySelector('input[name="cat"]:checked').value;

        const data = {
            id: editId || Date.now(),
            name, prompt, cat,
            img: imgBlob,
            fav: editId ? (prompts.find(x=>x.id===editId)?.fav || false) : false
        };

        await dbOp('readwrite', s => s.put(data));
        closeForm();
        loadData();
        showToast('Saved successfully');
        
        if(editId && !$('modal-detail').classList.contains('hidden')) {
            openDetail(data);
        }
    }

    // --- Rendering ---
    function renderCats() {
        const nav = $('nav-cats');
        const formC = $('form-cats');
        nav.innerHTML=''; formC.innerHTML='';
        CATS.forEach(c => {
            // Nav Item
            const btn = document.createElement('button');
            const active = currentCat === c.id;
            btn.className = `flex-none px-4 py-2 rounded-full text-xs font-bold border transition-all flex items-center gap-2 touch-scale ${active ? 'bg-blue-600 text-white border-blue-600 shadow-md shadow-blue-500/30' : 'bg-white dark:bg-gray-800 text-gray-500 border-gray-200 dark:border-gray-700'}`;
            btn.innerHTML = `<i class="fa-solid ${c.icon}"></i> ${c.label}`;
            btn.onclick = () => { vib(); currentCat=c.id; renderCats(); applyFilter(); };
            nav.appendChild(btn);

            // Form Radio
            if(c.id !== 'all' && c.id !== 'fav') {
                const l = document.createElement('label');
                l.className = 'cursor-pointer touch-scale';
                l.innerHTML = `
                    <input type="radio" name="cat" value="${c.id}" class="peer hidden" ${c.id==='branding'?'checked':''}>
                    <div class="px-3 py-2 rounded-lg bg-gray-50 dark:bg-gray-800 text-gray-400 border border-transparent text-[10px] font-bold peer-checked:bg-blue-50 dark:peer-checked:bg-blue-900/20 peer-checked:text-blue-600 uppercase transition-all ring-1 ring-transparent peer-checked:ring-blue-500/20">
                        ${c.label}
                    </div>`;
                formC.appendChild(l);
            }
        });
    }

    function updateImgPreview() {
        if(imgBlob) {
            $('img-preview').src = URL.createObjectURL(imgBlob);
            $('img-preview').classList.remove('hidden');
            $('btn-clear-img').classList.remove('hidden');
            $('btn-clear-img').classList.add('flex');
            $('img-placeholder').classList.add('hidden');
        } else {
            $('img-preview').classList.add('hidden');
            $('btn-clear-img').classList.add('hidden');
            $('btn-clear-img').classList.remove('flex');
            $('img-placeholder').classList.remove('hidden');
            $('inp-file').value = '';
        }
    }

    function setupEvents() {
        $('btn-add').onclick = () => openForm();
        $('btn-view').onclick = () => { view = view==='grid'?'list':'grid'; renderGrid(); };
        $('search-input').oninput = applyFilter;
        $('btn-clear-search').onclick = () => { $('search-input').value=''; applyFilter(); $('search-input').focus(); };
        $('btn-settings').onclick = () => { document.documentElement.classList.toggle('dark'); localStorage.setItem('theme', document.documentElement.classList.contains('dark')?'dark':'light'); };

        // Form
        $('btn-cancel-form').onclick = closeForm;
        $('form-backdrop').onclick = closeForm;
        $('btn-save-form').onclick = savePrompt;
        $('btn-paste').onclick = async () => { try{ $('inp-prompt').value = await navigator.clipboard.readText(); }catch{showToast('Permission denied');} };
        $('inp-file').onchange = e => {
            const f = e.target.files[0]; if(!f) return;
            const r = new FileReader(); r.onload=ev=>{
                const i=new Image(); i.onload=()=>{
                    const c=document.createElement('canvas'); const max=800;
                    let w=i.width, h=i.height; if(w>h && w>max){h*=max/w;w=max}else if(h>max){w*=max/h;h=max}
                    c.width=w; c.height=h; c.getContext('2d').drawImage(i,0,0,w,h);
                    c.toBlob(b=>{imgBlob=b; updateImgPreview()}, 'image/jpeg', 0.85);
                }; i.src=ev.target.result;
            }; r.readAsDataURL(f);
        };
        $('btn-clear-img').onclick = (e) => { e.stopPropagation(); e.preventDefault(); imgBlob=null; updateImgPreview(); };

        // Detail
        $('btn-close-detail').onclick = closeDetail;
        $('detail-backdrop').onclick = closeDetail;
        $('act-copy').onclick = () => { navigator.clipboard.writeText($('detail-text').innerText); showToast('Copied to clipboard'); };
        $('act-edit').onclick = () => { closeDetail(); setTimeout(()=>openForm(prompts.find(x=>x.id===editId)), 250); };
        $('act-more').onclick = () => { closeDetail(); setTimeout(()=>openContextMenu(prompts.find(x=>x.id===editId)), 250); };

        // Context
        $('ctx-backdrop').onclick = closeCtx;
        $('ctx-cancel').onclick = closeCtx;
        $('ctx-fav').onclick = () => handleCtxAction('fav');
        $('ctx-dup').onclick = () => handleCtxAction('dup');
        $('ctx-edit').onclick = () => handleCtxAction('edit');
        $('ctx-del').onclick = () => handleCtxAction('del');
    }

    function closeForm() {
        $('form-panel').classList.add('translate-y-full');
        $('form-backdrop').classList.add('opacity-0');
        setTimeout(()=>$('modal-form').classList.add('hidden'),300);
    }
    function closeDetail() {
        $('detail-panel').classList.add('translate-y-full');
        $('detail-backdrop').classList.add('opacity-0');
        setTimeout(()=>$('modal-detail').classList.add('hidden'),300);
    }
    function openFullscreen(){ $('fs-img').src = $('detail-img').src; $('modal-fs').classList.remove('hidden'); }
    function closeFullscreen(){ $('modal-fs').classList.add('hidden'); }

    init();
  </script>
</body>
</html>