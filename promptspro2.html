<!DOCTYPE html>
<html lang="en" dir="ltr" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>PromptVault Elite</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />

  <meta name="theme-color" content="#ffffff" id="meta-theme-color">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
          animation: {
            'fade-in': 'fadeIn 0.2s cubic-bezier(0.16, 1, 0.3, 1)',
            'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
            'pop': 'pop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)'
          },
          keyframes: {
            fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
            slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
            pop: { '0%': { transform: 'scale(0.8) translateY(10px)', opacity: '0' }, '100%': { transform: 'scale(1) translateY(0)', opacity: '1' } }
          }
        }
      }
    }
  </script>

  <style>
    body { -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; user-select: none; }
    .hide-scroll::-webkit-scrollbar { display: none; }
    .touch-scale { transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1); }
    .touch-scale:active { transform: scale(0.94); }
    
    .glass { 
      background: rgba(255,255,255,0.8); 
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(0,0,0,0.05); 
    }
    .dark .glass { 
      background: rgba(17,24,39,0.8); 
      border-bottom: 1px solid rgba(255,255,255,0.05); 
    }
    
    input, textarea { font-size: 16px !important; }
    
    /* Hardware acceleration for smoother animations */
    .gpu { transform: translateZ(0); will-change: transform, opacity; }
    
    /* Long press visual cue */
    .pressing { transform: scale(0.96); opacity: 0.9; filter: grayscale(0.2); transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
  </style>
</head>

<body class="bg-gray-50 text-gray-900 dark:bg-gray-950 dark:text-gray-100 h-[100dvh] flex flex-col overflow-hidden w-full transition-colors duration-300 selection:bg-indigo-500 selection:text-white">

  <header class="flex-none z-30 w-full glass absolute top-0 left-0 transition-colors">
    <div class="px-5 pt-safe-top pb-2 flex justify-between items-center h-16 mt-safe">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl bg-gradient-to-tr from-indigo-600 to-blue-500 shadow-lg shadow-indigo-500/20 p-0.5">
           <img src="https://i.postimg.cc/J7qwgGck/App-Icon-2x.png" class="w-full h-full rounded-[10px] object-cover" alt="Logo">
        </div>
        <h1 class="text-xl font-bold tracking-tight bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-400 bg-clip-text text-transparent">PromptVault</h1>
      </div>
      <button id="btn-settings" class="w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center touch-scale text-gray-600 dark:text-gray-300">
        <i class="fa-solid fa-gear"></i>
      </button>
    </div>

    <nav class="flex items-center gap-2 px-4 pb-3 overflow-x-auto hide-scroll w-full border-b border-gray-200/50 dark:border-gray-800 scroll-smooth" id="nav-cats"></nav>
  </header>

  <div class="flex-none pt-[7.5rem] px-4 pb-2 z-20 bg-gray-50 dark:bg-gray-950 transition-colors">
    <div class="relative group">
      <div class="absolute inset-0 bg-white dark:bg-gray-900 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-800 transition-shadow group-focus-within:shadow-md group-focus-within:border-indigo-500/50"></div>
      <i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 z-10"></i>
      <input type="text" id="search-input" class="relative z-10 w-full bg-transparent pl-11 pr-12 py-3.5 rounded-2xl outline-none text-base placeholder-gray-400 font-medium" placeholder="Search your vault..." autocomplete="off">
      <button id="btn-clear-search" class="hidden absolute right-12 top-1/2 -translate-y-1/2 w-7 h-7 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-500 flex items-center justify-center text-[10px] touch-scale z-20"><i class="fa-solid fa-xmark"></i></button>
      <button id="btn-view" class="absolute right-2 top-1/2 -translate-y-1/2 w-9 h-9 flex items-center justify-center text-gray-400 hover:text-indigo-500 touch-scale z-20"><i class="fa-solid fa-grid-2"></i></button>
    </div>
  </div>

  <main id="scroll-area" class="flex-grow overflow-y-auto px-4 pb-32 hide-scroll relative">
    <div id="grid-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 pb-6"></div>
    
    <div id="empty-state" class="hidden flex flex-col items-center justify-center py-24 text-center opacity-60">
      <div class="w-24 h-24 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center mb-4">
        <i class="fa-solid fa-layer-group text-4xl text-gray-300 dark:text-gray-600"></i>
      </div>
      <h3 class="font-bold text-lg">No prompts found</h3>
      <p class="text-sm text-gray-500">Add a new prompt or try another tab.</p>
    </div>
  </main>

  <button id="btn-add" class="fixed bottom-6 right-6 w-14 h-14 bg-gradient-to-br from-indigo-600 to-blue-600 text-white rounded-full shadow-xl shadow-indigo-600/30 flex items-center justify-center text-2xl touch-scale z-40 animate-pop">
    <i class="fa-solid fa-plus"></i>
  </button>

  <div id="modal-settings" class="fixed inset-0 z-50 hidden" role="dialog">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm opacity-0 transition-opacity duration-300" id="settings-backdrop"></div>
    <div class="absolute bottom-0 left-0 right-0 bg-white dark:bg-gray-900 rounded-t-[2rem] max-h-[85vh] flex flex-col transform translate-y-full transition-transform duration-300 gpu" id="settings-panel">
      
      <div class="p-5 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center">
        <h2 class="text-xl font-bold">Settings</h2>
        <button id="btn-close-settings" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center text-gray-500 touch-scale"><i class="fa-solid fa-xmark"></i></button>
      </div>

      <div class="p-5 space-y-4 overflow-y-auto pb-10">
        <button id="btn-theme" class="w-full flex items-center justify-between p-4 rounded-2xl bg-gray-50 dark:bg-gray-800 touch-scale group">
          <div class="flex items-center gap-3">
             <div class="w-10 h-10 rounded-xl bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 flex items-center justify-center group-hover:scale-110 transition-transform"><i class="fa-solid fa-moon text-lg"></i></div>
             <span class="font-bold text-sm">Dark Mode</span>
          </div>
          <div id="theme-status" class="text-xs font-bold uppercase text-gray-400 bg-white dark:bg-black/20 px-3 py-1 rounded-full">Off</div>
        </button>

        <div class="h-px bg-gray-100 dark:bg-gray-800 my-2"></div>
        <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider pl-1">Actions</h4>

        <button id="btn-backup" class="w-full flex items-center justify-between p-4 rounded-2xl bg-gray-50 dark:bg-gray-800 touch-scale group">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-blue-100 dark:bg-blue-900/30 text-blue-600 flex items-center justify-center group-hover:scale-110 transition-transform"><i class="fa-solid fa-database text-lg"></i></div>
            <div class="text-left">
              <span class="font-bold text-sm block">Backup Library</span>
              <span class="text-[10px] text-gray-500">Export as JSON</span>
            </div>
          </div>
          <i class="fa-solid fa-download text-gray-400"></i>
        </button>

        <button id="btn-export-fav" class="w-full flex items-center justify-between p-4 rounded-2xl bg-gray-50 dark:bg-gray-800 touch-scale group">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-red-100 dark:bg-red-900/30 text-red-500 flex items-center justify-center group-hover:scale-110 transition-transform"><i class="fa-solid fa-heart text-lg"></i></div>
            <div class="text-left">
              <span class="font-bold text-sm block">Export Favorites</span>
              <span class="text-[10px] text-gray-500">Only saved items</span>
            </div>
          </div>
          <i class="fa-solid fa-file-export text-gray-400"></i>
        </button>

        <label class="w-full flex items-center justify-between p-4 rounded-2xl bg-gray-50 dark:bg-gray-800 touch-scale cursor-pointer group">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 flex items-center justify-center group-hover:scale-110 transition-transform"><i class="fa-solid fa-upload text-lg"></i></div>
            <span class="font-bold text-sm">Restore Data</span>
          </div>
          <input type="file" id="inp-restore" accept=".json" class="hidden">
          <i class="fa-solid fa-file-import text-gray-400"></i>
        </label>
        
        <div class="text-center pt-4">
            <p class="text-xs text-gray-400 font-medium">Prompts in Vault: <span id="stat-count" class="text-gray-900 dark:text-white font-bold ml-1">0</span></p>
        </div>
      </div>
    </div>
  </div>

  <div id="modal-form" class="fixed inset-0 z-50 hidden" role="dialog">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm opacity-0 transition-opacity duration-300" id="form-backdrop"></div>
    <div class="absolute bottom-0 left-0 right-0 bg-white dark:bg-gray-900 rounded-t-[2rem] max-h-[92dvh] flex flex-col transform translate-y-full transition-transform duration-300 gpu" id="form-panel">
      
      <div class="w-full flex justify-center pt-3 pb-1"><div class="w-12 h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full"></div></div>
      <div class="flex justify-between items-center px-5 py-2 border-b border-gray-50 dark:border-gray-800/50">
        <button id="btn-cancel-form" class="text-gray-500 font-medium px-2 py-2 touch-scale">Cancel</button>
        <h3 class="font-bold text-lg" id="form-title">New Prompt</h3>
        <button id="btn-save-form" class="text-indigo-600 font-bold px-2 py-2 touch-scale">Save</button>
      </div>

      <div class="overflow-y-auto p-5 space-y-6 hide-scroll pb-10" id="form-content">
        <form id="main-form" class="space-y-5">
          <input type="hidden" id="inp-id">
          
          <div class="relative w-full h-44 bg-gray-50 dark:bg-gray-800/50 rounded-2xl flex flex-col items-center justify-center border-2 border-dashed border-gray-200 dark:border-gray-700 overflow-hidden group transition-all hover:border-indigo-400" id="img-zone">
            <img id="img-preview" class="absolute inset-0 w-full h-full object-cover hidden z-10 transition-opacity duration-300" />
            <div id="img-placeholder" class="text-center text-gray-400 group-hover:text-indigo-500 transition-colors">
              <div class="w-12 h-12 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-2"><i class="fa-solid fa-cloud-arrow-up text-xl"></i></div>
              <div class="text-[10px] font-bold uppercase tracking-wide">Upload Image</div>
            </div>
            <input type="file" id="inp-file" accept="image/*" class="absolute inset-0 opacity-0 z-20 cursor-pointer">
            <button type="button" id="btn-clear-img" class="absolute top-3 right-3 z-30 w-8 h-8 bg-black/50 backdrop-blur text-white rounded-full hidden items-center justify-center touch-scale"><i class="fa-solid fa-xmark"></i></button>
          </div>

          <div class="space-y-2">
            <label class="text-[11px] font-bold text-gray-400 uppercase ml-1 tracking-wider">Name</label>
            <input type="text" id="inp-name" class="w-full bg-gray-100 dark:bg-gray-800 border-none rounded-2xl px-4 py-4 font-bold focus:ring-2 focus:ring-indigo-500 transition-all placeholder-gray-400 text-lg" placeholder="e.g. Neon City">
          </div>

          <div class="space-y-2">
            <label class="text-[11px] font-bold text-gray-400 uppercase ml-1 tracking-wider">Category</label>
            <div class="flex gap-2 overflow-x-auto hide-scroll pt-1" id="form-cats"></div>
          </div>

          <div class="space-y-2">
            <label class="text-[11px] font-bold text-gray-400 uppercase ml-1 tracking-wider">The Prompt</label>
            
            <button type="button" id="btn-paste" class="w-full py-3.5 bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600 dark:text-indigo-300 rounded-xl font-bold touch-scale flex items-center justify-center gap-2 mb-2 border border-indigo-100 dark:border-indigo-900/30">
                <i class="fa-regular fa-clipboard text-lg"></i>
                <span>PASTE CLIPBOARD</span>
            </button>
            
            <textarea id="inp-prompt" rows="6" class="w-full bg-gray-100 dark:bg-gray-800 border-none rounded-2xl p-4 text-base leading-relaxed focus:ring-2 focus:ring-indigo-500 transition-all placeholder-gray-400 font-medium" placeholder="Prompt details..."></textarea>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div id="modal-detail" class="fixed inset-0 z-50 hidden" role="dialog">
    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm opacity-0 transition-opacity duration-300" id="detail-backdrop"></div>
    <div class="absolute inset-x-0 bottom-0 top-16 bg-white dark:bg-gray-900 rounded-t-[2rem] flex flex-col transform translate-y-full transition-transform duration-300 shadow-2xl gpu" id="detail-panel">
      <div class="flex-none h-16 px-5 flex justify-between items-center border-b border-gray-100 dark:border-gray-800">
        <button id="btn-close-detail" class="w-9 h-9 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center touch-scale text-gray-500"><i class="fa-solid fa-chevron-down"></i></button>
        <span id="detail-cat-badge" class="text-[10px] font-extrabold uppercase bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 px-3 py-1.5 rounded-lg tracking-wider">BRANDING</span>
      </div>
      <div class="flex-1 overflow-y-auto hide-scroll p-0 pb-4">
        <div class="w-full h-72 bg-gray-100 dark:bg-gray-800 relative group cursor-zoom-in" onclick="openFullscreen()">
            <img id="detail-img" class="w-full h-full object-contain bg-black/5 dark:bg-black/20 transition-opacity">
            <div class="absolute bottom-3 right-3 bg-black/60 text-white text-[10px] font-bold px-3 py-1.5 rounded-full backdrop-blur pointer-events-none flex items-center gap-1"><i class="fa-solid fa-expand"></i> View</div>
        </div>
        <div class="p-6">
            <div class="flex justify-between items-start mb-5">
                <h2 id="detail-title" class="text-2xl font-bold leading-tight pr-4"></h2>
                <button id="detail-fav-btn" class="w-11 h-11 rounded-full bg-gray-50 dark:bg-gray-800 flex-shrink-0 flex items-center justify-center text-2xl transition-all touch-scale"><i class="fa-regular fa-heart text-gray-400"></i></button>
            </div>
            <div class="bg-gray-50 dark:bg-gray-800/50 p-5 rounded-2xl border border-gray-100 dark:border-gray-800">
                <p id="detail-text" class="text-[15px] text-gray-700 dark:text-gray-300 leading-relaxed whitespace-pre-wrap select-text font-medium"></p>
            </div>
        </div>
      </div>
      <div class="flex-none p-4 bg-white dark:bg-gray-900 border-t border-gray-100 dark:border-gray-800 grid grid-cols-4 gap-3 z-20 pb-safe-bottom">
        <button id="act-copy" class="col-span-2 bg-indigo-600 text-white rounded-xl py-3.5 font-bold shadow-lg shadow-indigo-600/20 touch-scale flex items-center justify-center gap-2"><i class="fa-regular fa-copy"></i> Copy</button>
        <button id="act-edit" class="bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 rounded-xl py-3.5 font-bold touch-scale flex flex-col items-center justify-center text-[10px] gap-0.5"><i class="fa-solid fa-pen text-sm"></i> Edit</button>
        <button id="act-more" class="bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 rounded-xl py-3.5 font-bold touch-scale flex flex-col items-center justify-center text-[10px] gap-0.5"><i class="fa-solid fa-ellipsis text-sm"></i> More</button>
      </div>
    </div>
  </div>

  <div id="ctx-menu" class="fixed inset-0 z-[60] hidden" role="dialog">
    <div class="absolute inset-0 bg-black/40 backdrop-blur-[2px] opacity-0 transition-opacity" id="ctx-backdrop"></div>
    <div class="absolute bottom-6 left-4 right-4 bg-white dark:bg-gray-900 rounded-2xl shadow-2xl overflow-hidden transform scale-95 opacity-0 transition-all origin-bottom" id="ctx-panel">
      <div class="p-4 border-b border-gray-100 dark:border-gray-800 text-center bg-gray-50/50 dark:bg-gray-800/20"><h4 id="ctx-title" class="font-bold text-sm truncate text-gray-500">Actions</h4></div>
      <div class="p-2 space-y-1">
        <button id="ctx-copy" class="w-full text-left px-4 py-3.5 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800 flex items-center gap-3 font-semibold transition-colors"><div class="w-6 text-center"><i class="fa-regular fa-copy text-indigo-500"></i></div> <span>Copy Prompt</span></button>
        <button id="ctx-fav" class="w-full text-left px-4 py-3.5 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800 flex items-center gap-3 font-semibold transition-colors"><div class="w-6 text-center"><i class="fa-regular fa-heart"></i></div> <span>Favorites</span></button>
        <button id="ctx-dup" class="w-full text-left px-4 py-3.5 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800 flex items-center gap-3 font-semibold transition-colors"><div class="w-6 text-center"><i class="fa-solid fa-clone text-gray-400"></i></div> <span>Duplicate</span></button>
        <button id="ctx-edit" class="w-full text-left px-4 py-3.5 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800 flex items-center gap-3 font-semibold transition-colors"><div class="w-6 text-center"><i class="fa-solid fa-pen text-gray-400"></i></div> <span>Edit</span></button>
        <div class="h-px bg-gray-100 dark:bg-gray-800 my-1 mx-2"></div>
        <button id="ctx-del" class="w-full text-left px-4 py-3.5 rounded-xl hover:bg-red-50 dark:hover:bg-red-900/20 text-red-500 flex items-center gap-3 font-semibold transition-colors"><div class="w-6 text-center"><i class="fa-solid fa-trash"></i></div> <span>Delete</span></button>
      </div>
      <div class="p-2"><button id="ctx-cancel" class="w-full py-3.5 rounded-xl font-bold text-gray-500 bg-gray-100 dark:bg-gray-800">Cancel</button></div>
    </div>
  </div>

  <div id="modal-fs" class="fixed inset-0 z-[70] bg-black hidden flex-col justify-center animate-fade-in">
    <button onclick="closeFullscreen()" class="absolute top-6 right-6 z-50 w-10 h-10 bg-white/20 text-white rounded-full flex items-center justify-center backdrop-blur touch-scale"><i class="fa-solid fa-xmark"></i></button>
    <img id="fs-img" class="w-full max-h-screen object-contain">
  </div>
  
  <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-gray-900/90 dark:bg-white/90 backdrop-blur text-white dark:text-black px-6 py-3 rounded-full shadow-2xl text-sm font-bold transition-all duration-300 opacity-0 translate-y-4 pointer-events-none z-[80] whitespace-nowrap"></div>

  <script>
    const DB_NAME = 'PV_Elite_v6';
    // Categories with new additions
    const CATS = [
      {id:'all', label:'All', icon:'fa-layer-group'},
      {id:'fav', label:'Favorites', icon:'fa-heart text-red-500'},
      {id:'branding', label:'Branding', icon:'fa-copyright'},
      {id:'art', label:'Art', icon:'fa-palette'},
      {id:'photo', label:'Photo', icon:'fa-camera'},
      {id:'vectors', label:'Vectors', icon:'fa-vector-square'},
      {id:'code', label:'Code', icon:'fa-code'},
      {id:'tools', label:'Tools', icon:'fa-wrench'},
      {id:'fun', label:'Fun', icon:'fa-face-laugh-beam'},
      {id:'personal', label:'Personal', icon:'fa-user'},
      {id:'work', label:'Work', icon:'fa-briefcase'}
    ];
    
    let db, prompts=[], filtered=[], currentCat='all', view='grid', editId=null, imgBlob=null, longPressTimer;
    const $ = id => document.getElementById(id);
    const vib = () => navigator.vibrate?.(10);
    const showToast = msg => { const t = $('toast'); t.innerText=msg; t.classList.remove('opacity-0','translate-y-4'); setTimeout(()=>t.classList.add('opacity-0','translate-y-4'),2000); };

    // DB Init
    const initDB = () => new Promise(res => {
        const r = indexedDB.open(DB_NAME, 1);
        r.onupgradeneeded = e => e.target.result.createObjectStore('prompts', {keyPath:'id'});
        r.onsuccess = () => { db = r.result; res(); };
    });
    const dbOp = (mode, fn) => new Promise(res => {
        const tx = db.transaction('prompts', mode);
        const req = fn(tx.objectStore('prompts'));
        req.onsuccess = () => res(req.result);
    });

    async function init() {
        if(localStorage.getItem('theme')==='dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            $('theme-status').innerText = "On";
        }
        await initDB(); loadData(); setupEvents();
    }

    async function loadData() {
        prompts = await dbOp('readonly', s => s.getAll());
        prompts.sort((a,b) => b.id - a.id);
        $('stat-count').innerText = prompts.length;
        renderCats(); // Update counts
        applyFilter();
    }
    
    // Calculate counts for categories
    function getCatCount(catId) {
        if (catId === 'all') return prompts.length;
        if (catId === 'fav') return prompts.filter(p => p.fav).length;
        return prompts.filter(p => p.cat === catId).length;
    }

    function applyFilter() {
        const q = $('search-input').value.toLowerCase();
        filtered = prompts.filter(p => {
            const cm = currentCat==='all' ? true : (currentCat==='fav' ? p.fav : p.cat===currentCat);
            return cm && (p.name.toLowerCase().includes(q) || p.prompt.toLowerCase().includes(q));
        });
        if (q.length > 0) $('btn-clear-search').classList.remove('hidden'); else $('btn-clear-search').classList.add('hidden');
        renderGrid();
    }

    function renderGrid() {
        const grid = $('grid-container'); grid.innerHTML = '';
        if(filtered.length===0) return $('empty-state').classList.remove('hidden');
        $('empty-state').classList.add('hidden');
        
        const frag = document.createDocumentFragment();
        filtered.slice(0, 50).forEach(p => {
            const url = p.img ? URL.createObjectURL(p.img) : null;
            const card = document.createElement('div');
            const startPress = () => { card.classList.add('pressing'); longPressTimer = setTimeout(() => { card.classList.remove('pressing'); openContextMenu(p); }, 500); };
            const cancelPress = () => { card.classList.remove('pressing'); clearTimeout(longPressTimer); };
            card.addEventListener('touchstart', startPress, {passive:true}); card.addEventListener('touchend', cancelPress); card.addEventListener('touchmove', cancelPress);
            card.addEventListener('contextmenu', e => { e.preventDefault(); openContextMenu(p); });
            card.onclick = () => { if(card.classList.contains('pressing')) return; openDetail(p); };

            if(view === 'grid') {
                card.className = 'relative aspect-square rounded-2xl bg-white dark:bg-gray-800 shadow-sm border border-black/5 dark:border-white/5 overflow-hidden transition-all animate-fade-in select-none';
                card.innerHTML = `
                    ${url ? `<img src="${url}" class="w-full h-full object-cover">` : `<div class="w-full h-full bg-gradient-to-br from-indigo-500 to-blue-600 flex items-center justify-center text-white text-2xl font-extrabold">${p.name[0]}</div>`}
                    ${p.fav ? '<div class="absolute top-2 right-2 w-7 h-7 bg-white/90 dark:bg-black/60 backdrop-blur rounded-full flex items-center justify-center text-red-500 text-xs shadow-sm"><i class="fa-solid fa-heart"></i></div>' : ''}
                    <div class="absolute bottom-0 inset-x-0 p-3 bg-gradient-to-t from-black/80 via-black/50 to-transparent"><p class="text-white text-xs font-bold truncate tracking-wide">${p.name}</p></div>
                `;
            } else {
                card.className = 'flex items-center gap-4 p-3 bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-black/5 dark:border-white/5 touch-scale animate-fade-in select-none';
                card.innerHTML = `
                    <div class="w-16 h-16 rounded-xl overflow-hidden flex-shrink-0 bg-gray-100">
                         ${url ? `<img src="${url}" class="w-full h-full object-cover">` : `<div class="w-full h-full bg-indigo-500 flex items-center justify-center text-white font-bold text-xl">${p.name[0]}</div>`}
                    </div>
                    <div class="flex-grow min-w-0">
                        <div class="flex justify-between items-center mb-1"><h4 class="font-bold text-sm dark:text-gray-100 truncate">${p.name}</h4>${p.fav ? '<i class="fa-solid fa-heart text-red-500 text-xs"></i>' : ''}</div>
                        <p class="text-xs text-gray-500 truncate leading-relaxed">${p.prompt}</p>
                    </div>
                `;
            }
            frag.appendChild(card);
        });
        grid.appendChild(frag);
    }

    function renderCats() {
        const nav = $('nav-cats'); const formC = $('form-cats'); nav.innerHTML=''; formC.innerHTML='';
        CATS.forEach(c => {
            const count = getCatCount(c.id);
            const btn = document.createElement('button');
            const active = currentCat === c.id;
            btn.className = `flex-none px-4 py-2.5 rounded-full text-xs font-bold border transition-all flex items-center gap-2 touch-scale ${active ? 'bg-indigo-600 text-white border-indigo-600 shadow-md shadow-indigo-500/30' : 'bg-white dark:bg-gray-800 text-gray-500 border-gray-200 dark:border-gray-700'}`;
            // Added Count inside parens
            btn.innerHTML = `<i class="fa-solid ${c.icon}"></i> ${c.label} <span class="ml-0.5 opacity-70 font-medium">(${count})</span>`;
            btn.onclick = () => { vib(); currentCat=c.id; renderCats(); applyFilter(); };
            nav.appendChild(btn);
            
            if(c.id !== 'all' && c.id !== 'fav') {
                const l = document.createElement('label'); l.className = 'cursor-pointer touch-scale';
                l.innerHTML = `<input type="radio" name="cat" value="${c.id}" class="peer hidden" ${c.id==='branding'?'checked':''}><div class="px-4 py-2.5 rounded-xl bg-gray-50 dark:bg-gray-800 text-gray-400 border border-transparent text-[10px] font-bold peer-checked:bg-indigo-50 dark:peer-checked:bg-indigo-900/20 peer-checked:text-indigo-600 uppercase transition-all ring-1 ring-transparent peer-checked:ring-indigo-500/20">${c.label}</div>`;
                formC.appendChild(l);
            }
        });
    }

    // Modal & Action Logic
    function openDetail(p) {
        vib(); editId = p.id;
        $('detail-title').innerText = p.name;
        $('detail-text').innerText = p.prompt;
        $('detail-cat-badge').innerText = CATS.find(c=>c.id===p.cat)?.label || 'Other';
        const url = p.img ? URL.createObjectURL(p.img) : null;
        $('detail-img').src = url || ''; $('detail-img').parentElement.style.display = url ? 'block' : 'none';
        updateFavIcon(p.fav);
        $('modal-detail').classList.remove('hidden');
        setTimeout(() => { $('detail-backdrop').classList.remove('opacity-0'); $('detail-panel').classList.remove('translate-y-full'); }, 10);
    }
    function updateFavIcon(isFav) {
        const btn = $('detail-fav-btn');
        btn.innerHTML = `<i class="fa-${isFav?'solid':'regular'} fa-heart ${isFav?'text-red-500':'text-gray-400'}"></i>`;
        btn.className = `w-11 h-11 rounded-full flex-shrink-0 flex items-center justify-center text-2xl transition-all touch-scale ${isFav ? 'bg-red-50 dark:bg-red-900/20' : 'bg-gray-50 dark:bg-gray-800'}`;
        btn.onclick = async () => { const p = prompts.find(x=>x.id===editId); p.fav = !p.fav; await dbOp('readwrite', s=>s.put(p)); updateFavIcon(p.fav); loadData(); };
    }
    
    // Settings Logic
    function openSettings() { vib(); $('modal-settings').classList.remove('hidden'); setTimeout(() => { $('settings-backdrop').classList.remove('opacity-0'); $('settings-panel').classList.remove('translate-y-full'); }, 10); }
    function closeSettings() { $('settings-panel').classList.add('translate-y-full'); $('settings-backdrop').classList.add('opacity-0'); setTimeout(() => $('modal-settings').classList.add('hidden'), 300); }
    async function exportData(onlyFav) {
        let data = await dbOp('readonly', s => s.getAll());
        if(onlyFav) data = data.filter(x=>x.fav);
        if(!data.length) return showToast('Nothing to export');
        const exp = await Promise.all(data.map(async p => {
            let b64 = null; if(p.img) { b64 = await new Promise(r => { const fr = new FileReader(); fr.onload=()=>r(fr.result); fr.readAsDataURL(p.img); }); }
            return { ...p, img: b64 };
        }));
        const blob = new Blob([JSON.stringify(exp)], {type:'application/json'});
        const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`PV_${onlyFav?'Favs':'Full'}_${Date.now()}.json`; a.click();
    }

    // Context Menu
    function openContextMenu(p) { vib(); ctxId = p.id; $('ctx-title').innerText = p.name; $('ctx-fav').innerHTML = `<div class="w-6 text-center"><i class="fa-${p.fav?'solid':'regular'} fa-heart ${p.fav?'text-red-500':''}"></i></div> <span>${p.fav?'Remove Favorite':'Add Favorite'}</span>`; $('modal-fs').classList.add('hidden'); $('ctx-menu').classList.remove('hidden'); setTimeout(() => { $('ctx-backdrop').classList.remove('opacity-0'); $('ctx-panel').classList.remove('opacity-0', 'scale-95'); }, 10); }
    function closeCtx() { $('ctx-panel').classList.add('opacity-0', 'scale-95'); $('ctx-backdrop').classList.add('opacity-0'); setTimeout(() => $('ctx-menu').classList.add('hidden'), 200); }
    async function handleCtxAction(a) { 
        closeCtx(); const p=prompts.find(x=>x.id===ctxId); if(!p)return; 
        if(a==='copy') { navigator.clipboard.writeText(p.prompt); showToast('Prompt Copied!'); }
        else if(a==='fav'){ p.fav=!p.fav; await dbOp('readwrite', s=>s.put(p)); showToast(p.fav?'Added to Favorites':'Removed'); } 
        else if(a==='dup'){ const c={...p, id:Date.now(), name:p.name+' (Copy)', fav:false}; await dbOp('readwrite', s=>s.put(c)); showToast('Duplicated'); } 
        else if(a==='del'){ if(confirm('Delete?')){ await dbOp('readwrite', s=>s.delete(ctxId)); showToast('Deleted'); } } 
        else if(a==='edit'){ openForm(p); return; } 
        loadData(); 
    }

    // Events
    function setupEvents() {
        $('btn-add').onclick = () => openForm();
        $('btn-view').onclick = () => { view = view==='grid'?'list':'grid'; renderGrid(); };
        $('search-input').oninput = applyFilter;
        $('btn-clear-search').onclick = () => { $('search-input').value=''; applyFilter(); $('search-input').focus(); };
        $('btn-settings').onclick = openSettings; $('btn-close-settings').onclick = closeSettings; $('settings-backdrop').onclick = closeSettings;
        $('btn-theme').onclick = () => { document.documentElement.classList.toggle('dark'); const isDark = document.documentElement.classList.contains('dark'); localStorage.setItem('theme', isDark?'dark':'light'); $('theme-status').innerText = isDark ? "On" : "Off"; };
        $('btn-backup').onclick = () => exportData(false); $('btn-export-fav').onclick = () => exportData(true);
        $('inp-restore').onchange = e => {
            const f = e.target.files[0]; if(!f) return;
            const r = new FileReader(); r.onload=async ev=>{
                try{ const j = JSON.parse(ev.target.result); const imp = j.map(p => { let b = null; if(p.img && typeof p.img === 'string') { const a=p.img.split(','); const m=a[0].match(/:(.*?);/)[1]; const bin=atob(a[1]); let n=bin.length; const u8=new Uint8Array(n); while(n--)u8[n]=bin.charCodeAt(n); b=new Blob([u8],{type:m}); } return {...p, img: b}; }); const tx=db.transaction('prompts','readwrite'); const s=tx.objectStore('prompts'); s.clear(); imp.forEach(i=>s.put(i)); tx.oncomplete = ()=>{ closeSettings(); loadData(); showToast('Restored!'); }; } catch { showToast('Invalid File'); }
            }; r.readAsText(f);
        };
        $('btn-cancel-form').onclick = closeForm; $('form-backdrop').onclick = closeForm; $('btn-save-form').onclick = savePrompt;
        $('btn-paste').onclick = async () => { try{ $('inp-prompt').value = await navigator.clipboard.readText(); }catch{showToast('Permission denied');} };
        $('inp-file').onchange = e => { const f = e.target.files[0]; if(!f) return; const r = new FileReader(); r.onload=ev=>{ const i=new Image(); i.onload=()=>{ const c=document.createElement('canvas'); const max=800; let w=i.width, h=i.height; if(w>h && w>max){h*=max/w;w=max}else if(h>max){w*=max/h;h=max} c.width=w; c.height=h; c.getContext('2d').drawImage(i,0,0,w,h); c.toBlob(b=>{imgBlob=b; updateImgPreview()}, 'image/jpeg', 0.85); }; i.src=ev.target.result; }; r.readAsDataURL(f); };
        $('btn-clear-img').onclick = (e) => { e.stopPropagation(); e.preventDefault(); imgBlob=null; updateImgPreview(); };
        $('btn-close-detail').onclick = closeDetail; $('detail-backdrop').onclick = closeDetail;
        $('act-copy').onclick = () => { navigator.clipboard.writeText($('detail-text').innerText); showToast('Copied to clipboard'); };
        $('act-edit').onclick = () => { closeDetail(); setTimeout(()=>openForm(prompts.find(x=>x.id===editId)), 250); };
        $('act-more').onclick = () => { closeDetail(); setTimeout(()=>openContextMenu(prompts.find(x=>x.id===editId)), 250); };
        $('ctx-backdrop').onclick = closeCtx; $('ctx-cancel').onclick = closeCtx;
        $('ctx-copy').onclick = () => handleCtxAction('copy'); $('ctx-fav').onclick = () => handleCtxAction('fav'); $('ctx-dup').onclick = () => handleCtxAction('dup'); $('ctx-edit').onclick = () => handleCtxAction('edit'); $('ctx-del').onclick = () => handleCtxAction('del');
    }

    function openForm(editObj = null) {
        vib(); $('main-form').reset(); editId = editObj ? editObj.id : null; imgBlob = editObj ? editObj.img : null;
        $('form-title').innerText = editId ? 'Edit Prompt' : 'New Prompt';
        $('inp-name').value = editObj ? editObj.name : ''; $('inp-prompt').value = editObj ? editObj.prompt : '';
        const catVal = editObj ? editObj.cat : 'branding'; const radio = document.querySelector(`input[name="cat"][value="${catVal}"]`); if(radio) radio.checked = true;
        updateImgPreview(); $('modal-form').classList.remove('hidden'); setTimeout(() => { $('form-backdrop').classList.remove('opacity-0'); $('form-panel').classList.remove('translate-y-full'); }, 10);
    }
    function updateImgPreview() { if(imgBlob) { $('img-preview').src = URL.createObjectURL(imgBlob); $('img-preview').classList.remove('hidden'); $('btn-clear-img').classList.remove('hidden'); $('btn-clear-img').classList.add('flex'); $('img-placeholder').classList.add('hidden'); } else { $('img-preview').classList.add('hidden'); $('btn-clear-img').classList.add('hidden'); $('btn-clear-img').classList.remove('flex'); $('img-placeholder').classList.remove('hidden'); $('inp-file').value = ''; } }
    async function savePrompt() { const name = $('inp-name').value.trim() || 'Untitled'; const prompt = $('inp-prompt').value.trim(); if(!prompt) return showToast('Prompt is empty!'); const cat = document.querySelector('input[name="cat"]:checked').value; const data = { id: editId || Date.now(), name, prompt, cat, img: imgBlob, fav: editId ? (prompts.find(x=>x.id===editId)?.fav || false) : false }; await dbOp('readwrite', s => s.put(data)); closeForm(); loadData(); showToast('Saved successfully'); if(editId && !$('modal-detail').classList.contains('hidden')) openDetail(data); }
    function closeForm() { $('form-panel').classList.add('translate-y-full'); $('form-backdrop').classList.add('opacity-0'); setTimeout(()=>$('modal-form').classList.add('hidden'),300); }
    function closeDetail() { $('detail-panel').classList.add('translate-y-full'); $('detail-backdrop').classList.add('opacity-0'); setTimeout(()=>$('modal-detail').classList.add('hidden'),300); }
    function closeFullscreen(){ $('modal-fs').classList.add('hidden'); } function openFullscreen(){ $('fs-img').src = $('detail-img').src; $('modal-fs').classList.remove('hidden'); }

    init();
  </script>
</body>
</html>