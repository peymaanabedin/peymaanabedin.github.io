<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" media="(prefers-color-scheme: dark)">
  <meta name="theme-color" content="#f7f7fb" media="(prefers-color-scheme: light)">
  <title>Save Loc — GPS Bookmarks</title>

  <!-- App icons -->
  <link rel="apple-touch-icon" href="https://i.postimg.cc/vT811GJ3/App-Icon-2x.png" />
  <link rel="icon" href="https://i.postimg.cc/vT811GJ3/App-Icon-2x.png" />

  <!-- Leaflet (map picker & preview) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />

  <style>
    :root{
      --bg:#0b1220;--bg-grad:#0e1628;--panel:#0f1726;--panel-2:#121a2b;--muted:#8aa0bf;--text:#eef3ff;
      --accent:#0a84ff;--accent-2:#34d399;--danger:#ff453a;--border:#1f273a;--shadow:0 12px 28px rgba(0,0,0,.28);
      --radius:18px;--gap:14px;
    }
    @media (prefers-color-scheme:light){
      :root{
        --bg:#f7f7fb;--bg-grad:#fff;--panel:#ffffff;--panel-2:#fafafa;--muted:#6e7a8a;--text:#0d0f14;
        --accent:#007aff;--accent-2:#34c759;--danger:#ff3b30;--border:#e7e9ee;--shadow:0 10px 24px rgba(0,0,0,.06);
      }
    }
    [data-theme="light"]{
      --bg:#f7f7fb;--bg-grad:#fff;--panel:#ffffff;--panel-2:#fafafa;--muted:#6e7a8a;--text:#0d0f14;
      --accent:#007aff;--accent-2:#34c759;--danger:#ff3b30;--border:#e7e9ee;--shadow:0 10px 24px rgba(0,0,0,.06);
    }
    [data-theme="dark"]{
      --bg:#0b1220;--bg-grad:#0e1628;--panel:#0f1726;--panel-2:#121a2b;--muted:#8aa0bf;--text:#eef3ff;
      --accent:#0a84ff;--accent-2:#34d399;--danger:#ff453a;--border:#1f273a;--shadow:0 12px 28px rgba(0,0,0,.28);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:linear-gradient(180deg,var(--bg) 0%,var(--bg) 60%,var(--bg-grad) 100%);
      color:var(--text);font:16px/1.45 -apple-system,system-ui,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
      -webkit-text-size-adjust:100%;
    }

    /* ===== Top App Bar (mobile friendly) ===== */
    .appbar{
      position:sticky;top:0;z-index:30;background:color-mix(in oklab,var(--bg) 88%,transparent);
      backdrop-filter:blur(10px);border-bottom:1px solid var(--border);
    }
    .appbar .row{display:flex;align-items:center;gap:12px;padding:10px 12px;max-width:960px;margin:0 auto}
    .brand{display:flex;align-items:center;gap:10px;min-width:0}
    .brand img{width:28px;height:28px;border-radius:7px;box-shadow:0 4px 18px rgba(0,0,0,.18)}
    .brand .title{font-weight:900;letter-spacing:.2px;white-space:nowrap}
    .brand .sub{font-size:12px;color:var(--muted);white-space:nowrap}
    .grow{flex:1}
    .seg{background:var(--panel-2);border:1px solid var(--border);padding:3px;border-radius:999px;display:flex;gap:3px}
    .seg button{border:0;background:transparent;padding:8px 12px;border-radius:999px;color:var(--muted);font-weight:600}
    .seg button[aria-pressed="true"]{background:var(--panel);color:var(--text);box-shadow:var(--shadow)}
    .icon-btn{appearance:none;background:var(--panel-2);border:1px solid var(--border);border-radius:12px;padding:9px;cursor:pointer}
    .icon-btn:active{transform:translateY(1px)}

    .wrap{max-width:960px;margin:0 auto;padding:12px}

    .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    .grid{display:grid;gap:var(--gap)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .pill{border-radius:999px;padding:8px 12px;font-size:13px;color:var(--muted);border:1px solid var(--border);background:var(--panel-2)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}

    input[type="text"],input[type="search"],textarea{
      width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:var(--panel-2);color:var(--text);font-size:16px;
    }
    .btn{appearance:none;border:1px solid var(--border);border-radius:12px;padding:12px 14px;font-weight:700;display:inline-flex;align-items:center;gap:8px;cursor:pointer;background:var(--panel-2);color:var(--text)}
    .btn:active{transform:translateY(1px)}
    .primary{background:linear-gradient(180deg,color-mix(in oklab,var(--accent) 90%,#fff 10%),var(--accent));color:#fff;border:none}
    .success{background:linear-gradient(180deg,color-mix(in oklab,var(--accent-2) 85%,#fff 15%),var(--accent-2));color:#042a18;border:none}
    .danger{background:linear-gradient(180deg,#ff6b6b,var(--danger));color:#fff;border:none}
    .ghost{background:var(--panel-2)}
    .soft{background:var(--panel-2);border:1px dashed var(--border);color:var(--muted);font-weight:600}

    .progress{height:4px;background:var(--panel-2);border-radius:999px;overflow:hidden}
    .progress>i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent-2))}

    /* Places list cards */
    .empty{border:1px dashed var(--border);border-radius:12px;padding:18px;text-align:center;color:var(--muted)}
    .place{border:1px solid var(--border);border-radius:14px;background:linear-gradient(180deg,var(--panel),color-mix(in oklab,var(--panel) 75%,var(--panel-2) 25%));padding:12px}
    .place-h{display:flex;align-items:center;gap:10px}
    .place-title{font-weight:800;min-width:0;overflow:hidden;text-overflow:ellipsis}
    .place-sub{font-size:12px;color:var(--muted)}
    .place-actions{display:none;margin-top:10px;gap:8px;flex-wrap:wrap}
    .place.open .place-actions{display:flex}

    /* Chips (categories) */
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border:1px solid var(--border);background:var(--panel-2);border-radius:999px;cursor:pointer}
    .chip[aria-pressed="true"]{background:var(--panel);box-shadow:var(--shadow)}
    .chip input{display:none}

    /* Dialogs */
    dialog{width:min(640px,94vw);border:1px solid var(--border);background:var(--panel);color:var(--text);border-radius:16px;padding:0;box-shadow:var(--shadow)}
    dialog::backdrop{background:rgba(0,0,0,.55)}
    .modal-head{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
    .modal-body{padding:12px 14px;display:grid;gap:12px}
    .modal-actions{padding:12px 14px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end}
    .help{font-size:12px;color:var(--muted)}

    /* Map areas */
    #pickerMap, #previewMap{width:100%;height:min(60vh,440px);border-radius:12px;border:1px solid var(--border);overflow:hidden}
    .map-toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}

    /* Toast */
    .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:var(--panel);border:1px solid var(--border);padding:10px 14px;border-radius:12px;color:var(--text);box-shadow:var(--shadow);opacity:0;pointer-events:none;transition:.25s;z-index:60}
    .toast.show{opacity:1;pointer-events:auto;bottom:28px}

    footer{padding:12px;text-align:center;color:var(--muted)}
  </style>
</head>
<body>
  <!-- App Bar -->
  <div class="appbar">
    <div class="row">
      <div class="brand" style="min-width:0">
        <img src="https://i.postimg.cc/vT811GJ3/App-Icon-2x.png" alt="Save Loc icon" />
        <div style="min-width:0">
          <div class="title">Save Loc</div>
          <div class="sub">GPS bookmarks • offline • share</div>
        </div>
      </div>
      <div class="grow"></div>
      <div class="seg" role="tablist" aria-label="Theme">
        <button id="themeAuto" aria-pressed="true">Auto</button>
        <button id="themeLight" aria-pressed="false">Light</button>
        <button id="themeDark" aria-pressed="false">Dark</button>
      </div>
      <button id="installBtn" class="icon-btn" hidden title="Install">⬇️</button>
      <button id="a2hsHint" class="icon-btn" hidden title="Add to Home">＋</button>
      <button id="settingsBtn" class="icon-btn" title="Settings">⚙️</button>
    </div>
  </div>

  <main class="wrap grid" style="padding-top:10px">
    <!-- Live location -->
    <section class="card grid">
      <div class="row" style="justify-content:space-between">
        <h2 style="margin:0;font-size:16px;display:flex;align-items:center;gap:8px">Current Location</h2>
        <span id="permStatus" class="pill">Permission: <b>unknown</b></span>
      </div>
      <div class="progress"><i id="progBar"></i></div>

      <div class="row">
        <button id="locateBtn" class="btn primary">📍 Get Precise</button>
        <button id="openPicker" class="btn ghost">🗺️ Map Picker</button>
        <button id="saveLiveBtn" class="btn success" disabled>⭐ Save</button>
        <button id="shareBtn" class="btn ghost" disabled>↗︎ Share</button>
      </div>

      <div class="row">
        <div class="pill mono" id="latBox">lat: –</div>
        <div class="pill mono" id="lngBox">lng: –</div>
        <div class="pill" id="accBox">accuracy: –</div>
      </div>
      <div class="row">
        <button id="copyLat" class="btn ghost" disabled>📋 Copy lat</button>
        <button id="copyLng" class="btn ghost" disabled>📋 Copy lng</button>
        <button id="copyBoth" class="btn ghost" disabled>📋 Copy lat,lng</button>
      </div>
      <div class="row" id="addrRow" style="display:none">
        <div class="pill" id="addrChip">📍 Resolving address…</div>
      </div>
      <div class="muted" id="tsBox">—</div>

      <div class="row">
        <button id="openApple" class="btn" disabled>🗺️ Apple</button>
        <button id="openGoogle" class="btn" disabled>🗺️ Google</button>
        <button id="openWaze" class="btn" disabled>🚘 Waze</button>
        <button id="dirApple" class="btn" disabled>➡️ Directions</button>
        <button id="openCustom" class="btn" disabled>🔗 Other App</button>
      </div>
    </section>

    <!-- Saved places -->
    <section class="card grid">
      <div class="row" style="justify-content:space-between">
        <h2 style="margin:0;font-size:16px">Saved Places</h2>
        <input id="searchBox" type="search" placeholder="Search name, address, notes…" aria-label="Search" />
      </div>
      <div id="listArea" class="grid">
        <div class="empty">No places yet. Use <b>Get Precise</b> or <b>Map Picker</b>.</div>
      </div>
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <button id="exportBtn" class="btn ghost">⬇️ Export</button>
          <input id="importFile" type="file" accept="application/json" hidden />
          <button id="importBtn" class="btn ghost">⬆️ Import</button>
        </div>
        <div class="row">
          <button id="backupBtn" class="btn ghost">🧰 Backup</button>
          <input id="restoreFile" type="file" accept="application/json" hidden />
          <button id="restoreBtn" class="btn ghost">🧳 Restore</button>
          <button id="clearAllBtn" class="btn danger">🗑️ Clear All</button>
        </div>
      </div>
    </section>
  </main>

  <footer>App created by <b>peymaan abedinpour</b></footer>
  <div id="toast" class="toast" role="status" aria-live="polite">Done</div>

  <!-- Settings -->
  <dialog id="settingsModal">
    <div class="modal-head">
      <strong>Settings</strong>
      <div class="grow"></div>
      <button id="closeSettings" class="icon-btn" title="Close">✕</button>
    </div>
    <div class="modal-body">
      <div>
        <label for="customTpl" class="muted">Custom URL template (Other App)</label>
        <input id="customTpl" type="text" placeholder="myapp://open?lat={lat}&lng={lng}&name={name}" />
        <div class="help">Placeholders: <code>{lat}</code>, <code>{lng}</code>, <code>{name}</code>. Example: <code>waze://?ll={lat},{lng}&navigate=yes</code></div>
      </div>

      <div>
        <label class="muted">Categories</label>
        <div id="catList" class="grid" style="grid-template-columns:repeat(auto-fill,minmax(220px,1fr))"></div>
        <div class="row">
          <input id="newCatName" type="text" placeholder="Category name (e.g., Parking)" />
          <input id="newCatIcon" type="text" placeholder="Emoji (e.g., 🅿️)" style="max-width:140px" />
          <button id="addCatBtn" class="btn success">Add</button>
        </div>
        <div class="help">Use emoji icons (🏠 💼 🅿️ ⭐ 👤 📌). Edit or delete below.</div>
      </div>

      <div>
        <label for="shareTitle" class="muted">Share title</label>
        <input id="shareTitle" type="text" placeholder="Save Loc" />
      </div>
    </div>
    <div class="modal-actions">
      <button id="testCustom" class="btn ghost">Test Custom</button>
      <div class="grow"></div>
      <button id="saveSettings" class="btn primary">Save</button>
    </div>
  </dialog>

  <!-- Save/Edit Modal -->
  <dialog id="saveModal">
    <div class="modal-head">
      <strong id="saveModalTitle">Save Location</strong>
      <div class="grow"></div>
      <button id="closeSave" class="icon-btn">✕</button>
    </div>
    <div class="modal-body">
      <div>
        <label class="muted" for="placeName">Name</label>
        <input id="placeName" type="text" placeholder="My Spot" />
      </div>
      <div>
        <label class="muted">Category</label>
        <div id="catChips" class="chips"></div>
        <div class="row">
          <input id="quickCatName" type="text" placeholder="New category name" />
          <input id="quickCatIcon" type="text" placeholder="Emoji (e.g., 📌)" style="max-width:140px" />
          <button id="quickAddCat" class="btn success">Add</button>
        </div>
      </div>
      <div>
        <label class="muted" for="placeNotes">Notes</label>
        <textarea id="placeNotes" rows="3" placeholder="Optional notes (gate code, floor, contact…)"></textarea>
      </div>
      <div class="row">
        <div class="pill mono" id="saveLat">lat: —</div>
        <div class="pill mono" id="saveLng">lng: —</div>
        <div class="pill" id="saveAcc">accuracy: —</div>
      </div>
      <div class="row">
        <div class="pill" id="saveAddr">📍 —</div>
      </div>
    </div>
    <div class="modal-actions">
      <button id="saveCancel" class="btn ghost">Cancel</button>
      <button id="saveConfirm" class="btn primary">Save</button>
    </div>
  </dialog>

  <!-- Map Picker Modal -->
  <dialog id="pickerModal">
    <div class="modal-head">
      <strong>Pick on Map</strong>
      <div class="grow"></div>
      <button id="closePicker" class="icon-btn">✕</button>
    </div>
    <div class="modal-body">
      <div id="pickerMap"></div>
      <div class="map-toolbar">
        <input id="pickerSearch" type="text" placeholder="Search address…" />
        <button id="pickerSearchBtn" class="btn ghost">🔎 Search</button>
        <button id="pickerUse" class="btn success">Use This Point</button>
      </div>
      <div class="help">Drag the pin or long-press the map to drop a new pin. Search won’t change text zoom.</div>
    </div>
  </dialog>

  <!-- Preview Modal -->
  <dialog id="previewModal">
    <div class="modal-head">
      <strong id="previewTitle">Preview</strong>
      <div class="grow"></div>
      <button id="closePreview" class="icon-btn">✕</button>
    </div>
    <div class="modal-body">
      <div id="previewMap"></div>
      <div id="previewAddr" class="muted">—</div>
      <div class="row">
        <button id="pvApple" class="btn">🗺️ Apple</button>
        <button id="pvGoogle" class="btn">🗺️ Google</button>
        <button id="pvWaze" class="btn">🚘 Waze</button>
        <button id="pvDir" class="btn">➡️ Directions</button>
        <button id="pvShare" class="btn ghost">↗︎ Share</button>
      </div>
    </div>
  </dialog>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    /* ===== Manifest (runtime) ===== */
    (function makeManifest(){
      const manifest = {
        name:"Save Loc — GPS Bookmarks",
        short_name:"Save Loc",
        start_url:"./",
        display:"standalone",
        background_color:"#0b1220",
        theme_color:"#0b1220",
        icons:[
          {"src":"https://i.postimg.cc/vT811GJ3/App-Icon-2x.png","sizes":"192x192","type":"image/png","purpose":"any maskable"},
          {"src":"https://i.postimg.cc/vT811GJ3/App-Icon-2x.png","sizes":"512x512","type":"image/png","purpose":"any maskable"}
        ]
      };
      const blob = new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"});
      const url = URL.createObjectURL(blob);
      const link = document.createElement('link'); link.rel = 'manifest'; link.href = url; document.head.appendChild(link);
    })();

    /* ===== Service Worker (offline shell) ===== */
    (function makeSW(){
      if(!('serviceWorker' in navigator)) return;
      const swCode = `
        const CACHE='saveloc-v4';
        const ASSETS=['./'];
        self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS)).then(self.skipWaiting()))});
        self.addEventListener('activate',e=>{e.waitUntil(self.clients.claim())});
        self.addEventListener('fetch',e=>{
          e.respondWith(
            caches.match(e.request).then(c=>c||fetch(e.request).then(res=>{
              const copy=res.clone(); caches.open(CACHE).then(cache=>cache.put(e.request,copy)).catch(()=>{});
              return res;
            }).catch(()=>caches.match('./')))
          );
        });
      `;
      const blob = new Blob([swCode], {type:'text/javascript'});
      navigator.serviceWorker.register(URL.createObjectURL(blob));
    })();

    /* ===== Elements ===== */
    const themeAuto = document.getElementById('themeAuto');
    const themeLight = document.getElementById('themeLight');
    const themeDark = document.getElementById('themeDark');

    const installBtn = document.getElementById('installBtn');
    const a2hsHint = document.getElementById('a2hsHint');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsModal = document.getElementById('settingsModal');
    const closeSettings = document.getElementById('closeSettings');
    const saveSettingsBtn = document.getElementById('saveSettings');
    const testCustom = document.getElementById('testCustom');

    const customTpl = document.getElementById('customTpl');
    const shareTitle = document.getElementById('shareTitle');

    const catList = document.getElementById('catList');
    const newCatName = document.getElementById('newCatName');
    const newCatIcon = document.getElementById('newCatIcon');
    const addCatBtn = document.getElementById('addCatBtn');

    const locateBtn = document.getElementById('locateBtn');
    const openPicker = document.getElementById('openPicker');
    const saveLiveBtn = document.getElementById('saveLiveBtn');
    const shareBtn = document.getElementById('shareBtn');
    const progBar = document.getElementById('progBar');
    const permStatus = document.getElementById('permStatus');

    const latBox = document.getElementById('latBox');
    const lngBox = document.getElementById('lngBox');
    const accBox = document.getElementById('accBox');
    const tsBox  = document.getElementById('tsBox');
    const addrRow = document.getElementById('addrRow');
    const addrChip = document.getElementById('addrChip');

    const copyLat = document.getElementById('copyLat');
    const copyLng = document.getElementById('copyLng');
    const copyBoth = document.getElementById('copyBoth');

    const openApple = document.getElementById('openApple');
    const openGoogle = document.getElementById('openGoogle');
    const openWaze = document.getElementById('openWaze');
    const openCustom = document.getElementById('openCustom');
    const dirApple = document.getElementById('dirApple');

    const listArea = document.getElementById('listArea');
    const searchBox = document.getElementById('searchBox');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const importFile = document.getElementById('importFile');
    const backupBtn = document.getElementById('backupBtn');
    const restoreBtn = document.getElementById('restoreBtn');
    const restoreFile = document.getElementById('restoreFile');
    const clearAllBtn = document.getElementById('clearAllBtn');

    const pickerModal = document.getElementById('pickerModal');
    const pickerMapEl = document.getElementById('pickerMap');
    const pickerSearch = document.getElementById('pickerSearch');
    const pickerSearchBtn = document.getElementById('pickerSearchBtn');
    const pickerUse = document.getElementById('pickerUse');
    const closePicker = document.getElementById('closePicker');

    const previewModal = document.getElementById('previewModal');
    const previewTitle = document.getElementById('previewTitle');
    const previewMapEl = document.getElementById('previewMap');
    const previewAddr = document.getElementById('previewAddr');
    const pvApple = document.getElementById('pvApple');
    const pvGoogle = document.getElementById('pvGoogle');
    const pvWaze = document.getElementById('pvWaze');
    const pvDir = document.getElementById('pvDir');
    const pvShare = document.getElementById('pvShare');
    const closePreview = document.getElementById('closePreview');

    const saveModal = document.getElementById('saveModal');
    const saveModalTitle = document.getElementById('saveModalTitle');
    const closeSave = document.getElementById('closeSave');
    const saveLat = document.getElementById('saveLat');
    const saveLng = document.getElementById('saveLng');
    const saveAcc = document.getElementById('saveAcc');
    const saveAddr = document.getElementById('saveAddr');
    const placeName = document.getElementById('placeName');
    const placeNotes = document.getElementById('placeNotes');
    const catChips = document.getElementById('catChips');
    const quickCatName = document.getElementById('quickCatName');
    const quickCatIcon = document.getElementById('quickCatIcon');
    const quickAddCat = document.getElementById('quickAddCat');
    const saveCancel = document.getElementById('saveCancel');
    const saveConfirm = document.getElementById('saveConfirm');

    /* ===== Helpers & State ===== */
    const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    function toast(msg){ const el = document.getElementById('toast'); el.textContent=msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),1800); }
    function formatTs(t){ return new Date(t).toLocaleString(); }
    function setProgress(p){ progBar.style.width = Math.max(0, Math.min(100, p)) + '%'; }
    function downloadBlob(data, type, name){ const blob=new Blob([data],{type}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url); }

    let current = null;     // live location {lat,lng,acc,ts,address?}
    let picker = null;      // Leaflet map (picker)
    let pickerMarker = null;
    let preview = null;     // Leaflet map (preview)
    let previewMarker = null;
    let pendingSave = null; // record to save/edit in saveModal
    let editId = null;      // when editing

    /* ===== Theme ===== */
    const PREF_THEME='saveloc.theme';
    function applyTheme(val){
      document.documentElement.removeAttribute('data-theme');
      if(val==='light'||val==='dark') document.documentElement.setAttribute('data-theme',val);
      [themeAuto,themeLight,themeDark].forEach(b=>b.setAttribute('aria-pressed','false'));
      (val==='light'?themeLight:val==='dark'?themeDark:themeAuto).setAttribute('aria-pressed','true');
      localStorage.setItem(PREF_THEME,val);
    }
    [themeAuto,themeLight,themeDark].forEach(btn=>btn.addEventListener('click',()=>applyTheme(btn===themeLight?'light':btn===themeDark?'dark':'auto')));
    applyTheme(localStorage.getItem(PREF_THEME)||'auto');

    /* ===== Install prompts ===== */
    let deferredPrompt=null;
    window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; installBtn.hidden=false; });
    installBtn.addEventListener('click', async ()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; installBtn.hidden=true; });
    if(isIOS && !isStandalone){ a2hsHint.hidden=false; a2hsHint.addEventListener('click', ()=> toast('On iPhone: Share ▸ Add to Home Screen')); }

    /* ===== Permissions ===== */
    async function checkPerm(){
      if(!navigator.permissions || !navigator.geolocation){ permStatus.innerHTML='Permission: <b>unknown</b>'; return; }
      try{
        const st = await navigator.permissions.query({name:'geolocation'});
        const map = { 'granted':'<b style="color:var(--accent-2)">granted</b>', 'denied':'<b style="color:var(--danger)">denied</b>', 'prompt':'<b>prompt</b>' };
        permStatus.innerHTML = 'Permission: ' + (map[st.state] || '<b>unknown</b>');
        st.onchange = ()=>{ permStatus.innerHTML = 'Permission: ' + (map[st.state] || '<b>unknown</b>'); };
      }catch{ permStatus.innerHTML='Permission: <b>unknown</b>'; }
    }
    checkPerm();

    /* ===== Storage ===== */
    const KEY='saveloc.places.v1';
    const PREF='saveloc.prefs.v1';
    const CATS='saveloc.categories.v1';
    function readPlaces(){ try{ return JSON.parse(localStorage.getItem(KEY)) || []; }catch{ return []; } }
    function writePlaces(arr){ localStorage.setItem(KEY, JSON.stringify(arr)); }
    function readPrefs(){ const def={customTpl:'',shareTitle:'Save Loc'}; try{ return {...def, ...(JSON.parse(localStorage.getItem(PREF))||{})}; }catch{ return def; } }
    function writePrefs(p){ localStorage.setItem(PREF, JSON.stringify(p)); }
    function readCats(){
      const def=[{id:'home',name:'Home',icon:'🏠'},{id:'work',name:'Work',icon:'💼'},{id:'parking',name:'Parking',icon:'🅿️'},{id:'fav',name:'Favorite',icon:'⭐'},{id:'customer',name:'Customer',icon:'👤'}];
      try{ const saved = JSON.parse(localStorage.getItem(CATS)); if(Array.isArray(saved)&&saved.length) return saved; localStorage.setItem(CATS, JSON.stringify(def)); return def; }catch{ return def; }
    }
    function writeCats(arr){ localStorage.setItem(CATS, JSON.stringify(arr)); }

    /* ===== Reverse Geocode (cached) ===== */
    function reverseGeocode(lat,lng){
      const key='addr:'+lat.toFixed(5)+','+lng.toFixed(5);
      const cached=localStorage.getItem(key); if(cached) return Promise.resolve(cached);
      return fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}&zoom=18&addressdetails=0`,{headers:{'Accept':'application/json'}})
        .then(r=>r.ok?r.json():Promise.reject()).then(j=>j.display_name||'').then(addr=>{ if(addr) localStorage.setItem(key,addr); return addr; })
        .catch(()=> '');
    }

    /* ===== Map links ===== */
    const appleLink = (lat,lng,name='') => `https://maps.apple.com/?ll=${lat},${lng}&q=${encodeURIComponent(name||`${lat.toFixed(6)},${lng.toFixed(6)}`)}`;
    const googleLink = (lat,lng) => `https://maps.google.com/?q=${lat},${lng}`;
    const wazeLink = (lat,lng) => `https://waze.com/ul?ll=${lat},${lng}&navigate=yes`;
    const appleDirections = (lat,lng,addr='') => `https://maps.apple.com/?daddr=${lat},${lng}&q=${encodeURIComponent(addr||`${lat.toFixed(6)},${lng.toFixed(6)}`)}&dirflg=d&saddr=Current%20Location`;
    function customLink(lat,lng,name){ const {customTpl}=readPrefs(); if(!customTpl) return ''; return customTpl.replaceAll('{lat}',lat).replaceAll('{lng}',lng).replaceAll('{name}',encodeURIComponent(name||'')); }

    /* ===== Live Location ===== */
    function enableLive(on){
      [saveLiveBtn,shareBtn,openApple,openGoogle,openWaze,dirApple,openCustom,copyLat,copyLng,copyBoth].forEach(b=>b.disabled=!on);
    }
    locateBtn.addEventListener('click', ()=>{
      if(!navigator.geolocation){ toast('Geolocation not supported'); return; }
      setProgress(10); addrRow.style.display='none';
      navigator.geolocation.getCurrentPosition(onPos,onErr,{enableHighAccuracy:true,timeout:15000,maximumAge:0});
      let t=10, iv=setInterval(()=>{ t=Math.min(95,t+4); setProgress(t); },300);
      function onPos(pos){
        clearInterval(iv); setProgress(100);
        const {latitude,longitude,accuracy}=pos.coords;
        current={lat:latitude,lng:longitude,acc:Math.round(accuracy),ts:Date.now()};
        latBox.textContent='lat: '+latitude.toFixed(6);
        lngBox.textContent='lng: '+longitude.toFixed(6);
        accBox.textContent='accuracy: ±'+Math.round(accuracy)+' m';
        tsBox.textContent='Timestamp: '+formatTs(current.ts);
        enableLive(true);
        reverseGeocode(latitude,longitude).then(addr=>{ if(addr){ current.address=addr; addrChip.textContent='📍 '+addr; addrRow.style.display='flex'; } });
        setTimeout(()=>setProgress(0),400);
      }
      function onErr(err){ clearInterval(iv); setProgress(0); toast(err.message||'Location error'); }
    });

    copyLat.onclick = async ()=>{ if(!current) return; try{ await navigator.clipboard.writeText(String(current.lat)); toast('Latitude copied'); }catch{ toast('Copy failed'); } };
    copyLng.onclick = async ()=>{ if(!current) return; try{ await navigator.clipboard.writeText(String(current.lng)); toast('Longitude copied'); }catch{ toast('Copy failed'); } };
    copyBoth.onclick = async ()=>{ if(!current) return; try{ await navigator.clipboard.writeText(`${current.lat},${current.lng}`); toast('lat,lng copied'); }catch{ toast('Copy failed'); } };

    shareBtn.addEventListener('click', async ()=>{
      if(!current) return;
      const prefs = readPrefs();
      const url = googleLink(current.lat,current.lng);
      const text = `${current.address? current.address : 'Pinned location'} — ${current.lat.toFixed(6)},${current.lng.toFixed(6)} (±${current.acc} m)`;
      if(navigator.share){ try{ await navigator.share({ title:prefs.shareTitle||'Save Loc', text, url }); }catch{} }
      else{ try{ await navigator.clipboard.writeText(`${text}\n${url}`); toast('Share copied'); }catch{ toast('Share failed'); } }
    });

    openApple.onclick = ()=>{ if(!current) return; window.open(appleLink(current.lat,current.lng,current.address||'Location'),'_blank','noopener'); };
    openGoogle.onclick = ()=>{ if(!current) return; window.open(googleLink(current.lat,current.lng),'_blank','noopener'); };
    openWaze.onclick = ()=>{ if(!current) return; window.open(wazeLink(current.lat,current.lng),'_blank','noopener'); };
    dirApple.onclick = ()=>{ if(!current) return; window.open(appleDirections(current.lat,current.lng,current.address||'Destination'),'_blank','noopener'); };
    openCustom.onclick = ()=>{ if(!current) return; const url=customLink(current.lat,current.lng,current.address||''); if(url) window.location.href=url; else toast('Set a custom URL in Settings'); };

    /* ===== Save flow (live or picker) ===== */
    function openSaveModal(record, mode='save'){
      pendingSave = record; editId = (mode==='edit') ? record.id : null;
      saveModalTitle.textContent = (mode==='edit') ? 'Edit Location' : 'Save Location';
      placeName.value = record.name || (record.address? record.address.split(',')[0] : 'My Spot');
      placeNotes.value = record.notes || '';
      saveLat.textContent = 'lat: '+record.lat.toFixed(6);
      saveLng.textContent = 'lng: '+record.lng.toFixed(6);
      saveAcc.textContent = 'accuracy: ±'+(record.acc ?? '—')+' m';
      saveAddr.textContent = '📍 '+(record.address || '—');
      renderCatChips(record.category);
      saveModal.showModal();
    }
    closeSave.onclick = ()=> saveModal.close();
    saveCancel.onclick = ()=> saveModal.close();
    saveConfirm.onclick = ()=>{
      if(!pendingSave) return;
      const cat = selectedCatFromChips();
      const place = {
        id: editId || (crypto.randomUUID?.() || (Date.now()+'-'+Math.random().toString(16).slice(2))),
        name: (placeName.value||'Unnamed').trim(),
        lat: +pendingSave.lat, lng: +pendingSave.lng, acc: +pendingSave.acc || 0,
        ts: pendingSave.ts || Date.now(),
        address: pendingSave.address || '',
        category: cat,
        notes: (placeNotes.value||'').trim()
      };
      if(editId){
        const arr=readPlaces(); const i=arr.findIndex(x=>x.id===editId); if(i>-1) arr[i]=place; writePlaces(arr);
      }else{
        const arr=readPlaces(); arr.unshift(place); writePlaces(arr);
      }
      saveModal.close(); renderList(); toast(editId?'Updated ✅':'Saved ⭐');
    };

    saveLiveBtn.onclick = ()=>{ if(!current) return; openSaveModal({ ...current, name:'Current spot' }, 'save'); };

    /* ===== Map Picker ===== */
    openPicker.onclick = ()=>{
      pickerModal.showModal();
      setTimeout(initPicker, 20);
    };
    closePicker.onclick = ()=> pickerModal.close();
    function initPicker(){
      if(!picker){
        picker = L.map(pickerMapEl,{zoomControl:true, attributionControl:false}).setView([35.6892,51.3890],13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(picker);
        pickerMarker = L.marker(picker.getCenter(),{draggable:true}).addTo(picker);
        picker.on('longpress', e=>{ pickerMarker.setLatLng(e.latlng); });
        picker.on('click', e=>{ pickerMarker.setLatLng(e.latlng); });
      } else { picker.invalidateSize(); }
      if(current){ picker.setView([current.lat,current.lng],16); pickerMarker.setLatLng([current.lat,current.lng]); }
    }
    pickerSearchBtn.onclick = ()=>{
      const q = pickerSearch.value.trim(); if(!q) return;
      fetch(`https://nominatim.openstreetmap.org/search?format=jsonv2&q=${encodeURIComponent(q)}&limit=1`)
        .then(r=>r.ok?r.json():[]).then(arr=>{
          if(arr && arr[0]){ const {lat,lon,display_name}=arr[0]; const latf=+lat, lonf=+lon; picker.setView([latf,lonf],16); pickerMarker.setLatLng([latf,lonf]); toast('Found'); }
          else toast('Not found');
        }).catch(()=>toast('Search error'));
    };
    pickerUse.onclick = ()=>{
      const {lat,lng} = pickerMarker.getLatLng();
      const rec = {lat: +lat, lng: +lng, acc: 0, ts: Date.now()};
      reverseGeocode(lat,lng).then(addr=>{ if(addr) rec.address=addr; openSaveModal(rec,'save'); });
      pickerModal.close();
    };

    /* ===== Settings ===== */
    function renderCatList(){
      const cats = readCats(); catList.innerHTML='';
      cats.forEach((c,idx)=>{
        const row = document.createElement('div'); row.className='row'; row.style.justifyContent='space-between';
        const left = document.createElement('div'); left.className='chip'; left.textContent = `${c.icon} ${c.name}`;
        const right = document.createElement('div'); right.className='row';
        const edit = document.createElement('button'); edit.className='btn ghost'; edit.textContent='Edit';
        edit.onclick = ()=>{
          const nn = prompt('Name:', c.name); if(nn===null) return;
          const ni = prompt('Icon (emoji):', c.icon); if(ni===null) return;
          const arr=readCats(); arr[idx]={...c,name:(nn||c.name).trim(),icon:(ni||c.icon).trim()}; writeCats(arr); renderCatList(); toast('Category updated');
        };
        const del = document.createElement('button'); del.className='btn danger'; del.textContent='Delete';
        del.onclick = ()=>{
          if(!confirm('Delete this category?')) return;
          const arr=readCats().filter(x=>x.id!==c.id); writeCats(arr); renderCatList(); toast('Category deleted');
        };
        right.append(edit,del); row.append(left,right); catList.appendChild(row);
      });
    }
    function renderCatChips(selected){
      const cats=readCats(); catChips.innerHTML='';
      cats.forEach(c=>{
        const b=document.createElement('button'); b.className='chip'; b.setAttribute('aria-pressed', selected && selected.id===c.id ? 'true':'false');
        b.textContent = `${c.icon} ${c.name}`;
        b.onclick = ()=>{
          [...catChips.children].forEach(n=>n.setAttribute('aria-pressed','false'));
          b.setAttribute('aria-pressed','true');
          b.dataset.selected = '1';
          b.dataset.catId = c.id;
        };
        b.dataset.catId = c.id;
        catChips.appendChild(b);
      });
      if(selected){
        const btn=[...catChips.children].find(x=>x.dataset.catId===selected.id);
        if(btn) btn.setAttribute('aria-pressed','true');
      } else if(catChips.firstChild){
        catChips.firstChild.setAttribute('aria-pressed','true');
      }
    }
    function selectedCatFromChips(){
      const cats=readCats();
      const btn=[...catChips.children].find(x=>x.getAttribute('aria-pressed')==='true');
      const id=btn?btn.dataset.catId:cats[0]?.id;
      return cats.find(c=>c.id===id) || cats[0];
    }
    quickAddCat.onclick = ()=>{
      const name=(quickCatName.value||'').trim(); const icon=(quickCatIcon.value||'📌').trim();
      if(!name){ toast('Enter category name'); return; }
      const arr=readCats(); const cat={id:(Date.now()+'-'+Math.random().toString(16).slice(2)), name, icon}; arr.push(cat); writeCats(arr);
      quickCatName.value=''; quickCatIcon.value='';
      renderCatChips(cat); toast('Category added');
    };

    settingsBtn.onclick = ()=>{ const p=readPrefs(); customTpl.value=p.customTpl||''; shareTitle.value=p.shareTitle||'Save Loc'; renderCatList(); settingsModal.showModal(); };
    closeSettings.onclick = ()=> settingsModal.close();
    saveSettingsBtn.onclick = ()=>{ writePrefs({customTpl:customTpl.value.trim(), shareTitle:shareTitle.value.trim()}); toast('Settings saved'); settingsModal.close(); };
    testCustom.onclick = ()=>{
      const tpl=customTpl.value.trim(); if(!tpl){ toast('Set a template'); return; }
      const url=tpl.replaceAll('{lat}','35.6892').replaceAll('{lng}','51.3890').replaceAll('{name}',encodeURIComponent('Test Point'));
      window.location.href=url;
    };

    /* ===== List rendering (cards with expand) ===== */
    function renderList(){
      const q=(searchBox.value||'').toLowerCase().trim();
      const items=readPlaces().filter(p=>{
        const hay=(p.name||'')+' '+(p.address||'')+' '+(p.notes||'')+' '+(p.category?.name||'');
        return !q || hay.toLowerCase().includes(q);
      });
      listArea.innerHTML='';
      if(!items.length){ const d=document.createElement('div'); d.className='empty'; d.textContent='No matches.'; listArea.appendChild(d); return; }

      items.forEach(p=>{
        const card=document.createElement('div'); card.className='place';
        const head=document.createElement('div'); head.className='place-h';
        const title=document.createElement('div'); title.className='place-title'; title.textContent=`${p.category?.icon||'📌'} ${p.name}`;
        const sub=document.createElement('div'); sub.className='place-sub mono';
        sub.textContent=`${p.lat.toFixed(6)}, ${p.lng.toFixed(6)} • ±${p.acc} m • ${formatTs(p.ts)}`;
        head.append(title);
        const subWrap=document.createElement('div'); subWrap.appendChild(sub);

        // Notes (collapsed preview)
        if(p.notes){ const notes=document.createElement('div'); notes.className='place-sub'; notes.textContent='📝 '+p.notes; subWrap.appendChild(notes); }

        const meta=document.createElement('div'); meta.appendChild(subWrap);
        const headerRow=document.createElement('div'); headerRow.style.display='flex'; headerRow.style.justifyContent='space-between'; headerRow.style.gap='10px';
        headerRow.append(head, meta);

        const actions=document.createElement('div'); actions.className='place-actions';
        const btn=(label,cls,fn)=>{ const b=document.createElement('button'); b.className='btn '+cls; b.textContent=label; b.onclick=fn; return b; };

        const previewBtn = btn('Preview','',()=>openPreview(p));
        const appleBtn = btn('Apple','',()=>window.open(appleLink(p.lat,p.lng,p.name),'_blank','noopener'));
        const googleBtn = btn('Google','',()=>window.open(googleLink(p.lat,p.lng),'_blank','noopener'));
        const wazeBtn = btn('Waze','',()=>window.open(wazeLink(p.lat,p.lng),'_blank','noopener'));
        const dirBtn = btn('Directions','',()=>window.open(appleDirections(p.lat,p.lng,p.address||p.name),'_blank','noopener'));
        const shareBtn2 = btn('Share','ghost',()=>sharePlace(p));
        const copyPair = btn('Copy lat,lng','ghost',async()=>{ try{ await navigator.clipboard.writeText(`${p.lat},${p.lng}`); toast('Copied'); }catch{ toast('Copy failed'); } });
        const editBtn = btn('Edit','ghost',()=>{ openSaveModal(p,'edit'); });
        const delBtn = btn('Delete','danger',()=>{ if(confirm('Delete this place?')){ remove(p.id); renderList(); toast('Deleted'); } });

        actions.append(previewBtn, appleBtn, googleBtn, wazeBtn, dirBtn, shareBtn2, copyPair, editBtn, delBtn);

        // expand/collapse
        card.append(headerRow, actions);
        card.addEventListener('click', (e)=>{ if(e.target.closest('.btn')) return; card.classList.toggle('open'); });

        listArea.appendChild(card);
      });
    }

    async function sharePlace(p){
      const prefs=readPrefs(); const url=googleLink(p.lat,p.lng);
      const text=`${p.name} — ${p.lat.toFixed(6)},${p.lng.toFixed(6)} (±${p.acc} m)${p.address? '\n'+p.address:''}${p.notes? '\n📝 '+p.notes:''}`;
      if(navigator.share){ try{ await navigator.share({title:prefs.shareTitle||'Save Loc', text, url}); }catch{} }
      else{ try{ await navigator.clipboard.writeText(`${text}\n${url}`); toast('Share copied'); }catch{ toast('Share failed'); } }
    }
    function update(id,patch){ const arr=readPlaces(); const i=arr.findIndex(x=>x.id===id); if(i>-1){ arr[i]={...arr[i],...patch}; writePlaces(arr); } }
    function remove(id){ writePlaces(readPlaces().filter(x=>x.id!==id)); }
    searchBox.addEventListener('input', renderList);

    /* ===== Preview (Leaflet) ===== */
    function openPreview(p){
      previewModal.showModal();
      setTimeout(()=>{
        if(!preview){
          preview=L.map(previewMapEl,{zoomControl:true, attributionControl:false});
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(preview);
        }
        preview.setView([p.lat,p.lng],16);
        if(previewMarker) preview.removeLayer(previewMarker);
        previewMarker=L.marker([p.lat,p.lng]).addTo(preview);
        preview.invalidateSize();
      },20);
      previewTitle.textContent = `${p.category?.icon||'📌'} ${p.name}`;
      previewAddr.textContent = p.address || '—';
      pvApple.onclick = ()=>window.open(appleLink(p.lat,p.lng,p.name),'_blank','noopener');
      pvGoogle.onclick = ()=>window.open(googleLink(p.lat,p.lng),'_blank','noopener');
      pvWaze.onclick = ()=>window.open(wazeLink(p.lat,p.lng),'_blank','noopener');
      pvDir.onclick = ()=>window.open(appleDirections(p.lat,p.lng,p.address||p.name),'_blank','noopener');
      pvShare.onclick = ()=>sharePlace(p);
      if(!p.address){ reverseGeocode(p.lat,p.lng).then(addr=>{ if(addr){ p.address=addr; update(p.id,{address:addr}); previewAddr.textContent=addr; renderList(); } }); }
    }
    closePreview.onclick = ()=> previewModal.close();

    /* ===== Export / Import / Backup / Restore ===== */
    exportBtn.onclick = ()=> downloadBlob(JSON.stringify(readPlaces(),null,2),'application/json','saveloc-places.json');
    importBtn.onclick = ()=> importFile.click();
    importFile.onchange = ()=>{
      const f=importFile.files[0]; if(!f) return;
      const fr=new FileReader(); fr.onload=()=>{
        try{ const arr=JSON.parse(fr.result); if(!Array.isArray(arr)) throw 0;
          const cur=readPlaces(); const map=new Map(cur.map(x=>[x.id,x])); for(const p of arr){ if(p&&p.id){ map.set(p.id,{...map.get(p.id),...p}); } }
          writePlaces([...map.values()].sort((a,b)=>b.ts-a.ts)); renderList(); toast('Imported');
        }catch{ toast('Import failed'); }
        importFile.value='';
      }; fr.readAsText(f);
    };

    backupBtn.onclick = ()=>{
      const backup={places:readPlaces(),categories:readCats(),prefs:readPrefs(),version:1,saved_at:new Date().toISOString()};
      downloadBlob(JSON.stringify(backup,null,2),'application/json','saveloc-backup.json');
    };
    restoreBtn.onclick = ()=> restoreFile.click();
    restoreFile.onchange = ()=>{
      const f=restoreFile.files[0]; if(!f) return;
      const fr=new FileReader(); fr.onload=()=>{
        try{ const obj=JSON.parse(fr.result);
          if(!obj || !Array.isArray(obj.places) || !Array.isArray(obj.categories)) throw 0;
          writePlaces(obj.places||[]); writeCats(obj.categories||[]); if(obj.prefs) writePrefs(obj.prefs);
          renderList(); toast('Backup restored');
        }catch{ toast('Restore failed'); }
        restoreFile.value='';
      }; fr.readAsText(f);
    };

    clearAllBtn.onclick = ()=>{ if(confirm('Remove ALL saved places?')){ localStorage.removeItem(KEY); renderList(); toast('Cleared'); } };

    /* ===== Settings open ===== */
    function renderCatListInit(){ renderCatList(); }
    /* ===== Initial render ===== */
    enableLive(false);
    renderList();

  </script>
</body>
</html>
