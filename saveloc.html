<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" media="(prefers-color-scheme: dark)">
  <meta name="theme-color" content="#f7f7fb" media="(prefers-color-scheme: light)">
  <title>Save Loc ‚Äî GPS Bookmarks</title>

  <!-- iOS PWA helpers -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="https://i.postimg.cc/vT811GJ3/App-Icon-2x.png" />
  <link rel="icon" href="https://i.postimg.cc/vT811GJ3/App-Icon-2x.png" />

  <style>
    :root{
      /* dark */
      --bg:#0b1220;--bg-grad:#0e1628;--panel:#0f1726;--panel-2:#121a2b;--muted:#8aa0bf;--text:#eef3ff;
      --accent:#007aff;--accent-2:#34d399;--danger:#ff3b30;--border:#1f273a;--shadow:0 12px 28px rgba(0,0,0,.28);
      --radius:18px;
    }
    @media (prefers-color-scheme:light){
      :root{
        --bg:#f7f7fb;--bg-grad:#fff;--panel:#ffffff;--panel-2:#fafafa;--muted:#6e7a8a;--text:#0d0f14;
        --accent:#007aff;--accent-2:#34c759;--danger:#ff3b30;--border:#e7e9ee;--shadow:0 10px 24px rgba(0,0,0,.06);
      }
    }
    [data-theme="light"]{
      --bg:#f7f7fb;--bg-grad:#fff;--panel:#ffffff;--panel-2:#fafafa;--muted:#6e7a8a;--text:#0d0f14;
      --accent:#007aff;--accent-2:#34c759;--danger:#ff3b30;--border:#e7e9ee;--shadow:0 10px 24px rgba(0,0,0,.06);
    }
    [data-theme="dark"]{
      --bg:#0b1220;--bg-grad:#0e1628;--panel:#0f1726;--panel-2:#121a2b;--muted:#8aa0bf;--text:#eef3ff;
      --accent:#0a84ff;--accent-2:#34d399;--danger:#ff453a;--border:#1f273a;--shadow:0 12px 28px rgba(0,0,0,.28);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:linear-gradient(180deg,var(--bg) 0%,var(--bg) 60%,var(--bg-grad) 100%);
      color:var(--text);font:16px/1.45 -apple-system,system-ui,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
    }

    header{
      position:sticky;top:0;z-index:15;background:color-mix(in oklab,var(--bg) 88%,transparent);
      backdrop-filter:blur(12px);border-bottom:1px solid var(--border);
    }
    .wrap{max-width:920px;margin:0 auto;padding:14px 16px}
    .title{display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{width:28px;height:28px;border-radius:6px;box-shadow:0 4px 18px rgba(0,0,0,.18)}
    .badge{font-size:12px;color:var(--muted)}
    .spacer{flex:1}

    .seg{background:var(--panel-2);border:1px solid var(--border);padding:4px;border-radius:999px;display:flex;gap:4px}
    .seg button{border:0;background:transparent;padding:8px 12px;border-radius:999px;color:var(--muted);font-weight:600}
    .seg button[aria-pressed="true"]{background:var(--panel);color:var(--text);box-shadow:var(--shadow)}

    .icon-btn{appearance:none;background:var(--panel-2);border:1px solid var(--border);border-radius:14px;padding:10px;cursor:pointer}
    .icon-btn:active{transform:translateY(1px)}

    .card{
      background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);
      box-shadow:var(--shadow);padding:14px;
    }
    .grid{display:grid;gap:12px}
    .grid-2{display:grid;gap:16px}
    @media(min-width:720px){ .grid-2{grid-template-columns:1.15fr .85fr} }
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .pill{border-radius:999px;padding:8px 12px;font-size:13px;color:var(--muted);border:1px solid var(--border);background:var(--panel-2)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
    input[type="text"],input[type="search"],select{
      width:100%;padding:12px 14px;border-radius:14px;border:1px solid var(--border);background:var(--panel-2);color:var(--text)
    }
    .btn{appearance:none;border:1px solid var(--border);border-radius:14px;padding:12px 14px;font-weight:700;display:inline-flex;align-items:center;gap:8px;cursor:pointer;background:var(--panel-2);color:var(--text)}
    .btn:active{transform:translateY(1px)}
    .primary{background:linear-gradient(180deg,color-mix(in oklab,var(--accent) 90%,#fff 10%),var(--accent));color:#fff;border:none}
    .success{background:linear-gradient(180deg,color-mix(in oklab,var(--accent-2) 85%,#fff 15%),var(--accent-2));color:#042a18;border:none}
    .danger{background:linear-gradient(180deg,#ff6b6b,var(--danger));color:#fff;border:none}
    .ghost{background:var(--panel-2)}

    .progress{height:4px;background:var(--panel-2);border-radius:999px;overflow:hidden}
    .progress>i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent-2))}

    .empty{border:1px dashed var(--border);border-radius:14px;padding:16px;text-align:center;color:var(--muted)}
    .loc-line{display:flex;align-items:center;gap:10px;justify-content:space-between;padding:12px;border-radius:14px;border:1px solid var(--border);background:linear-gradient(180deg,var(--panel),color-mix(in oklab,var(--panel) 75%,var(--panel-2) 25%))}
    .loc-meta{display:flex;flex-direction:column;gap:4px;min-width:0}
    .loc-name{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .loc-sub{font-size:12px;color:var(--muted)}
    .loc-actions{display:flex;gap:8px;flex-wrap:wrap}

    .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:var(--panel);border:1px solid var(--border);padding:10px 14px;border-radius:12px;color:var(--text);box-shadow:var(--shadow);opacity:0;pointer-events:none;transition:.25s;z-index:60}
    .toast.show{opacity:1;pointer-events:auto;bottom:28px}

    dialog{width:min(640px,92vw);border:1px solid var(--border);background:var(--panel);color:var(--text);border-radius:18px;padding:0;box-shadow:var(--shadow)}
    dialog::backdrop{background:rgba(0,0,0,.55)}
    .modal-head{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
    .modal-body{padding:14px 16px;display:grid;gap:12px}
    .modal-actions{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end}
    .help{font-size:12px;color:var(--muted)}
    label{font-size:13px;color:var(--muted)}
    .kv{display:grid;gap:8px}
    .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:var(--panel-2);border-radius:999px;padding:8px 10px}

    footer{padding:14px;text-align:center;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">
        <div class="brand">
          <img src="https://i.postimg.cc/vT811GJ3/App-Icon-2x.png" alt="Save Loc icon" />
          <div>
            <div style="font-size:18px;font-weight:900;letter-spacing:.2px">Save Loc</div>
            <div class="badge">GPS Bookmarks ‚Ä¢ Offline ‚Ä¢ Share</div>
          </div>
        </div>
        <div class="spacer"></div>

        <!-- Theme segment -->
        <div class="seg" role="tablist" aria-label="Theme">
          <button id="themeAuto" aria-pressed="true" aria-label="Auto">Auto</button>
          <button id="themeLight" aria-pressed="false" aria-label="Light">Light</button>
          <button id="themeDark" aria-pressed="false" aria-label="Dark">Dark</button>
        </div>

        <button id="installBtn" class="icon-btn" hidden title="Install">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 3v10m0 0 4-4m-4 4-4-4M5 21h14" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <button id="a2hsHint" class="icon-btn" hidden title="iOS Add to Home Screen">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 3v9m0-9 3 3m-3-3-3 3M6 12v7a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-7" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
          </svg>
        </button>
        <button id="settingsBtn" class="icon-btn" title="Settings">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <circle cx="12" cy="12" r="3.2" stroke="currentColor" stroke-width="1.7"/>
            <path d="M19.4 15a1 1 0 0 0 .2 1.1l.1.1a1.6 1.6 0 0 1-2.3 2.3l-.1-.1a1 1 0 0 0-1.1-.2 1 1 0 0 0-.6.9v.2a1.6 1.6 0 0 1-3.2 0v-.2a1 1 0 0 0-.6-.9 1 1 0 0 0-1.1.2l-.1.1a1.6 1.6 0 0 1-2.3-2.3l.1-.1a1 1 0 0 0 .2-1.1 1 1 0 0 0-.9-.6h-.2a1.6 1.6 0 0 1 0-3.2h.2a1 1 0 0 0 .9-.6 1 1 0 0 0-.2-1.1l-.1-.1a1.6 1.6 0 0 1 2.3-2.3l.1.1a1 1 0 0 0 1.1.2 1 1 0 0 0 .6-.9v-.2a1.6 1.6 0 0 1 3.2 0v.2a1 1 0 0 0 .6.9 1 1 0 0 0 1.1-.2l.1-.1a1.6 1.6 0 0 1 2.3 2.3l-.1.1a1 1 0 0 0-.2 1.1 1 1 0 0 0 .9.6h.2a1.6 1.6 0 0 1 0 3.2h-.2a1 1 0 0 0-.9.6Z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <main class="wrap grid-2" style="padding-top:14px;padding-bottom:18px">
    <!-- live location -->
    <section class="card grid">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
        <h2 style="margin:0;font-size:16px;display:flex;align-items:center;gap:8px">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 3v3m0 12v3M3 12h3m12 0h3M7 12a5 5 0 1 0 10 0 5 5 0 0 0-10 0Z" stroke="var(--accent)" stroke-width="1.6" stroke-linecap="round"/></svg>
          Current Location
        </h2>
        <span id="permStatus" class="pill">Permission: <b>unknown</b></span>
      </div>

      <div class="progress"><i id="progBar"></i></div>

      <div class="row">
        <button id="locateBtn" class="btn primary">üìç Get Precise</button>
        <button id="saveBtn" class="btn success" disabled>‚≠ê Save</button>
        <button id="shareBtn" class="btn ghost" disabled>‚ÜóÔ∏é Share</button>
        <button id="copyBtn" class="btn ghost" disabled>üìã Copy</button>
      </div>

      <div class="grid" style="gap:8px">
        <div class="row">
          <div class="pill mono" id="latBox">lat: ‚Äì</div>
          <div class="pill mono" id="lngBox">lng: ‚Äì</div>
          <div class="pill" id="accBox">accuracy: ‚Äì</div>
        </div>
        <div class="row" id="addrRow" style="display:none">
          <div class="chip" id="addrChip">üìç Resolving address‚Ä¶</div>
        </div>
        <div class="muted" id="tsBox">‚Äî</div>

        <div class="row" style="gap:10px">
          <button id="openApple" class="btn" disabled>üó∫Ô∏è Apple Maps</button>
          <button id="openGoogle" class="btn" disabled>üó∫Ô∏è Google Maps</button>
          <button id="openWaze" class="btn" disabled>üöò Waze</button>
          <button id="openCustom" class="btn" disabled>üîó Other App</button>
          <button id="dirApple" class="btn" disabled>‚û°Ô∏è Apple Directions</button>
        </div>
      </div>
    </section>

    <!-- saved list -->
    <section class="card grid">
      <div class="row" style="justify-content:space-between">
        <h2 style="margin:0;font-size:16px;display:flex;align-items:center;gap:8px">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M7 4h10v16l-5-3-5 3V4Z" stroke="var(--accent)" stroke-width="1.6" stroke-linejoin="round"/></svg>
          Saved Places
        </h2>
        <input id="searchBox" type="search" placeholder="Search by name or address‚Ä¶" aria-label="Search" />
      </div>

      <div id="listArea" class="grid" style="gap:10px">
        <div class="empty">No places yet. Grab your GPS and tap <b>Save</b>.</div>
      </div>

      <div class="row" style="justify-content:space-between">
        <div class="row">
          <button id="exportBtn" class="btn ghost">‚¨áÔ∏è Export</button>
          <button id="backupBtn" class="btn ghost">üß∞ Backup</button>
          <input id="importFile" type="file" accept="application/json" hidden />
          <button id="importBtn" class="btn ghost">‚¨ÜÔ∏è Import</button>
          <input id="restoreFile" type="file" accept="application/json" hidden />
          <button id="restoreBtn" class="btn ghost">üß≥ Restore</button>
        </div>
        <button id="clearAllBtn" class="btn danger">üóëÔ∏è Clear All</button>
      </div>
    </section>
  </main>

  <footer>App created by <b>peymaan abedinpour</b></footer>

  <div id="toast" class="toast" role="status" aria-live="polite">Done</div>

  <!-- Settings Modal -->
  <dialog id="settingsModal">
    <div class="modal-head">
      <strong>Settings</strong>
      <div class="spacer"></div>
      <button id="closeSettings" class="icon-btn" title="Close">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="kv">
        <label for="customTpl">Custom URL template (Other App)</label>
        <input id="customTpl" type="text" placeholder="myapp://open?lat={lat}&lng={lng}&name={name}" />
        <div class="help">Placeholders: <code>{lat}</code>, <code>{lng}</code>, <code>{name}</code>. Examples: <code>waze://?ll={lat},{lng}&navigate=yes</code></div>
      </div>

      <div class="kv">
        <label>Categories</label>
        <div id="catList" class="grid" style="grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:8px"></div>
        <div class="row">
          <input id="newCatName" type="text" placeholder="Category name (e.g., Parking)" />
          <input id="newCatIcon" type="text" placeholder="Emoji/Icon (e.g., üÖøÔ∏è)" style="max-width:140px" />
          <button id="addCatBtn" class="btn success">Add</button>
        </div>
        <div class="help">Tip: Use emoji as icons (üöó üè† üß≠ ‚≠ê üõí üìå). You can edit/delete existing ones.</div>
      </div>

      <div class="kv">
        <label for="shareTitle">Share title</label>
        <input id="shareTitle" type="text" placeholder="Save Loc" />
      </div>
    </div>
    <div class="modal-actions">
      <button id="testCustom" class="btn ghost">Test Custom</button>
      <div class="spacer"></div>
      <button id="saveSettings" class="btn primary">Save</button>
    </div>
  </dialog>

  <!-- Map Preview Modal -->
  <dialog id="mapModal">
    <div class="modal-head">
      <strong id="mapTitle">Preview</strong>
      <div class="spacer"></div>
      <button id="closeMap" class="icon-btn" title="Close">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="mapFrameWrap" style="border:1px solid var(--border);border-radius:14px;overflow:hidden;aspect-ratio:16/10;background:var(--panel-2)">
        <!-- iframe injected here -->
      </div>
      <div id="mapAddr" class="muted">‚Äî</div>
      <div class="row">
        <button id="mApple" class="btn">üó∫Ô∏è Apple</button>
        <button id="mGoogle" class="btn">üó∫Ô∏è Google</button>
        <button id="mWaze" class="btn">üöò Waze</button>
        <button id="mDirApple" class="btn">‚û°Ô∏è Directions</button>
        <button id="mShare" class="btn ghost">‚ÜóÔ∏é Share</button>
      </div>
    </div>
  </dialog>

  <script>
    /* -------- Manifest (runtime) -------- */
    (function makeManifest(){
      const manifest = {
        name:"Save Loc ‚Äî GPS Bookmarks",
        short_name:"Save Loc",
        start_url:"./",
        display:"standalone",
        background_color:"#0b1220",
        theme_color:"#0b1220",
        icons:[
          {"src":"https://i.postimg.cc/vT811GJ3/App-Icon-2x.png","sizes":"192x192","type":"image/png","purpose":"any maskable"},
          {"src":"https://i.postimg.cc/vT811GJ3/App-Icon-2x.png","sizes":"512x512","type":"image/png","purpose":"any maskable"}
        ]
      };
      const blob = new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"});
      const url = URL.createObjectURL(blob);
      const link = document.createElement('link'); link.rel = 'manifest'; link.href = url; document.head.appendChild(link);
    })();

    /* -------- Service Worker (offline) -------- */
    (function makeSW(){
      if(!('serviceWorker' in navigator)) return;
      const swCode = `
        const CACHE='saveloc-v3';
        const ASSETS=['./'];
        self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS)).then(self.skipWaiting()))});
        self.addEventListener('activate',e=>{e.waitUntil(self.clients.claim())});
        self.addEventListener('fetch',e=>{
          const req=e.request;
          e.respondWith(
            caches.match(req).then(c=>c||fetch(req).then(res=>{
              const copy=res.clone(); caches.open(CACHE).then(cache=>cache.put(req,copy)).catch(()=>{});
              return res;
            }).catch(()=>caches.match('./')))
          );
        });
      `;
      const blob = new Blob([swCode], {type:'text/javascript'});
      navigator.serviceWorker.register(URL.createObjectURL(blob));
    })();

    /* -------- Elements -------- */
    const themeAuto = document.getElementById('themeAuto');
    const themeLight = document.getElementById('themeLight');
    const themeDark = document.getElementById('themeDark');

    const installBtn = document.getElementById('installBtn');
    const a2hsHint = document.getElementById('a2hsHint');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsModal = document.getElementById('settingsModal');
    const closeSettings = document.getElementById('closeSettings');
    const saveSettings = document.getElementById('saveSettings');
    const testCustom = document.getElementById('testCustom');

    const customTpl = document.getElementById('customTpl');
    const shareTitle = document.getElementById('shareTitle');

    const catList = document.getElementById('catList');
    const newCatName = document.getElementById('newCatName');
    const newCatIcon = document.getElementById('newCatIcon');
    const addCatBtn = document.getElementById('addCatBtn');

    const latBox = document.getElementById('latBox');
    const lngBox = document.getElementById('lngBox');
    const accBox = document.getElementById('accBox');
    const tsBox  = document.getElementById('tsBox');
    const addrRow = document.getElementById('addrRow');
    const addrChip = document.getElementById('addrChip');
    const locateBtn = document.getElementById('locateBtn');
    const saveBtn = document.getElementById('saveBtn');
    const copyBtn = document.getElementById('copyBtn');
    const shareBtn = document.getElementById('shareBtn');
    const progBar = document.getElementById('progBar');
    const permStatus = document.getElementById('permStatus');

    const openApple = document.getElementById('openApple');
    const openGoogle = document.getElementById('openGoogle');
    const openWaze = document.getElementById('openWaze');
    const openCustom = document.getElementById('openCustom');
    const dirApple = document.getElementById('dirApple');

    const listArea = document.getElementById('listArea');
    const searchBox = document.getElementById('searchBox');
    const exportBtn = document.getElementById('exportBtn');
    const backupBtn = document.getElementById('backupBtn');
    const importBtn = document.getElementById('importBtn');
    const importFile = document.getElementById('importFile');
    const restoreBtn = document.getElementById('restoreBtn');
    const restoreFile = document.getElementById('restoreFile');
    const clearAllBtn = document.getElementById('clearAllBtn');

    const mapModal = document.getElementById('mapModal');
    const mapTitle = document.getElementById('mapTitle');
    const closeMap = document.getElementById('closeMap');
    const mapFrameWrap = document.getElementById('mapFrameWrap');
    const mapAddr = document.getElementById('mapAddr');
    const mApple = document.getElementById('mApple');
    const mGoogle = document.getElementById('mGoogle');
    const mWaze = document.getElementById('mWaze');
    const mDirApple = document.getElementById('mDirApple');
    const mShare = document.getElementById('mShare');

    /* -------- Helpers -------- */
    function toast(msg){ const el = document.getElementById('toast'); el.textContent = msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), 1800); }
    function formatTs(t){ return new Date(t).toLocaleString(); }
    function setProgress(p){ progBar.style.width = Math.max(0, Math.min(100, p)) + '%'; }
    const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

    /* -------- Theme -------- */
    const PREF_THEME='saveloc.theme';
    function applyTheme(val){
      document.documentElement.removeAttribute('data-theme');
      if(val==='light'||val==='dark'){ document.documentElement.setAttribute('data-theme', val); }
      [themeAuto,themeLight,themeDark].forEach(b=>b.setAttribute('aria-pressed','false'));
      (val==='light'?themeLight:val==='dark'?themeDark:themeAuto).setAttribute('aria-pressed','true');
      localStorage.setItem(PREF_THEME,val);
    }
    [themeAuto,themeLight,themeDark].forEach(btn=>btn.addEventListener('click',()=>applyTheme(btn===themeLight?'light':btn===themeDark?'dark':'auto')));
    applyTheme(localStorage.getItem(PREF_THEME)||'auto');

    /* -------- Install prompts -------- */
    let deferredPrompt=null;
    window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; installBtn.hidden=false; });
    installBtn?.addEventListener('click', async ()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; installBtn.hidden=true; });
    if(isIOS && !isStandalone){ a2hsHint.hidden=false; a2hsHint.addEventListener('click', ()=> toast('On iPhone: Share ‚ñ∏ Add to Home Screen')); }

    /* -------- Permissions -------- */
    async function checkPerm(){
      if(!navigator.permissions || !navigator.geolocation){ permStatus.innerHTML='Permission: <b>unknown</b>'; return; }
      try{
        const st = await navigator.permissions.query({name:'geolocation'});
        const map = { 'granted':'<b style="color:var(--accent-2)">granted</b>', 'denied':'<b style="color:var(--danger)">denied</b>', 'prompt':'<b>prompt</b>' };
        permStatus.innerHTML = 'Permission: ' + (map[st.state] || '<b>unknown</b>');
        st.onchange = ()=>{ permStatus.innerHTML = 'Permission: ' + (map[st.state] || '<b>unknown</b>'); };
      }catch{ permStatus.innerHTML='Permission: <b>unknown</b>'; }
    }
    checkPerm();

    /* -------- Storage -------- */
    const KEY='saveloc.places.v1';
    const PREF='saveloc.prefs.v1';
    const CATS='saveloc.categories.v1';
    function readPlaces(){ try{ return JSON.parse(localStorage.getItem(KEY)) || []; }catch{ return []; } }
    function writePlaces(arr){ localStorage.setItem(KEY, JSON.stringify(arr)); }
    function readPrefs(){
      const def = { customTpl:'', shareTitle:'Save Loc' };
      try{ return {...def, ...(JSON.parse(localStorage.getItem(PREF))||{})}; }catch{ return def; }
    }
    function writePrefs(p){ localStorage.setItem(PREF, JSON.stringify(p)); }
    function readCats(){
      const def = [
        {id:'home', name:'Home', icon:'üè†'},
        {id:'work', name:'Work', icon:'üíº'},
        {id:'parking', name:'Parking', icon:'üÖøÔ∏è'},
        {id:'fav', name:'Favorite', icon:'‚≠ê'},
        {id:'customer', name:'Customer', icon:'üë§'}
      ];
      try{
        const saved = JSON.parse(localStorage.getItem(CATS));
        if(Array.isArray(saved) && saved.length) return saved;
        localStorage.setItem(CATS, JSON.stringify(def));
        return def;
      }catch{ return def; }
    }
    function writeCats(arr){ localStorage.setItem(CATS, JSON.stringify(arr)); }

    /* -------- State -------- */
    let current=null; // {lat,lng,acc,ts,address?}
    let lastPreview=null; // place for map modal
    function enableLiveButtons(on){
      [saveBtn, copyBtn, shareBtn, openApple, openGoogle, openWaze, openCustom, dirApple].forEach(b=>b.disabled=!on);
    }

    /* -------- Geolocation + Reverse Geocode -------- */
    locateBtn.addEventListener('click', ()=>{
      if(!navigator.geolocation){ toast('Geolocation not supported'); return; }
      setProgress(10); addrRow.style.display='none';
      navigator.geolocation.getCurrentPosition(onPos, onErr, { enableHighAccuracy:true, timeout:15000, maximumAge:0 });
      let t=10, iv=setInterval(()=>{ t = Math.min(95,t+4); setProgress(t); }, 300);
      function onPos(pos){
        clearInterval(iv); setProgress(100);
        const { latitude, longitude, accuracy } = pos.coords;
        current = { lat: latitude, lng: longitude, acc: Math.round(accuracy), ts: Date.now() };
        latBox.textContent = 'lat: ' + latitude.toFixed(6);
        lngBox.textContent = 'lng: ' + longitude.toFixed(6);
        accBox.textContent = 'accuracy: ¬±' + Math.round(accuracy) + ' m';
        tsBox.textContent = 'Timestamp: ' + formatTs(current.ts);
        enableLiveButtons(true);
        reverseGeocode(latitude, longitude).then(addr=>{
          if(addr){ current.address = addr; addrChip.textContent = 'üìç ' + addr; addrRow.style.display='flex'; }
        }).catch(()=>{});
        setTimeout(()=>setProgress(0), 500);
      }
      function onErr(err){ clearInterval(iv); setProgress(0); toast(err.message || 'Location error'); }
    });

    function reverseGeocode(lat,lng){
      // Cache per lat,lng rounded
      const key = 'addr:'+lat.toFixed(5)+','+lng.toFixed(5);
      const cached = localStorage.getItem(key); if(cached) return Promise.resolve(cached);
      return fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}&zoom=18&addressdetails=0`,{headers:{'Accept':'application/json'}})
        .then(r=>r.ok?r.json():Promise.reject())
        .then(j=>j.display_name||'')
        .then(addr=>{ if(addr) localStorage.setItem(key,addr); return addr; })
        .catch(()=> '');
    }

    copyBtn.addEventListener('click', async ()=>{
      if(!current) return;
      const txt = `${current.lat},${current.lng} (¬±${current.acc}m @ ${new Date(current.ts).toISOString()})` + (current.address? `\n${current.address}`:'');
      try{ await navigator.clipboard.writeText(txt); toast('Copied'); }catch{ toast('Copy failed'); }
    });

    shareBtn.addEventListener('click', async ()=>{
      if(!current) return;
      const prefs = readPrefs();
      const url = googleLink(current.lat,current.lng);
      const text = `${current.address? current.address : 'Pinned location'} ‚Äî ${current.lat.toFixed(6)},${current.lng.toFixed(6)} (¬±${current.acc} m)`;
      if(navigator.share){
        try{ await navigator.share({ title: prefs.shareTitle||'Save Loc', text, url }); }catch{}
      }else{
        try{ await navigator.clipboard.writeText(`${text}\n${url}`); toast('Share copied'); }catch{ toast('Share failed'); }
      }
    });

    saveBtn.addEventListener('click', ()=>{
      if(!current) return;
      const cats = readCats();
      const name = prompt('Name this place:', current.address ? current.address.split(',')[0] : 'My Spot');
      if(name===null) return;

      // choose category (simple picker)
      const catStr = cats.map((c,i)=>`${i+1}. ${c.icon} ${c.name}`).join('\n') + `\n0. + Add new`;
      let pick = prompt(`Pick a category number:\n${catStr}`, '1');
      if(pick===null) return;
      pick = parseInt(pick,10); let cat = null;
      if(pick===0){
        const nn = prompt('New category name:','Custom'); if(nn===null) return;
        const ni = prompt('Icon (emoji):','üìå'); if(ni===null) return;
        const arr = readCats(); cat = {id: (Date.now()+'-'+Math.random().toString(16).slice(2)), name: nn.trim()||'Custom', icon: (ni||'üìå').trim()};
        arr.push(cat); writeCats(arr);
      }else{
        cat = cats[isNaN(pick)?0:Math.max(1,Math.min(cats.length,pick))-1] || cats[0];
      }

      const place = {
        id: crypto.randomUUID?.() || (Date.now()+'-'+Math.random().toString(16).slice(2)),
        name: (name || 'Unnamed').trim(),
        lat: +current.lat, lng: +current.lng, acc: +current.acc, ts: current.ts,
        category: cat, address: current.address || ''
      };
      const all = readPlaces(); all.unshift(place); writePlaces(all); renderList(); toast('Saved ‚≠ê');
    });

    /* -------- Map Links & Directions -------- */
    function appleLink(lat,lng,name=''){ const q = encodeURIComponent(name||`${lat.toFixed(6)},${lng.toFixed(6)}`); return `https://maps.apple.com/?ll=${lat},${lng}&q=${q}`; }
    function googleLink(lat,lng){ return `https://maps.google.com/?q=${lat},${lng}`; }
    function wazeLink(lat,lng){ return `https://waze.com/ul?ll=${lat},${lng}&navigate=yes`; }
    function appleDirections(lat,lng,addrOrName=''){ // saddr current location
      const d = encodeURIComponent(addrOrName||`${lat.toFixed(6)},${lng.toFixed(6)}`);
      return `https://maps.apple.com/?daddr=${lat},${lng}&q=${d}&dirflg=d&saddr=Current%20Location`;
    }
    function customLink(lat,lng,name){
      const { customTpl } = readPrefs(); if(!customTpl) return '';
      return customTpl.replaceAll('{lat}', lat).replaceAll('{lng}', lng).replaceAll('{name}', encodeURIComponent(name||''));
    }

    openApple.addEventListener('click', ()=>{ if(!current) return; window.open(appleLink(current.lat,current.lng,current.address||'Location'),'_blank','noopener'); });
    openGoogle.addEventListener('click', ()=>{ if(!current) return; window.open(googleLink(current.lat,current.lng),'_blank','noopener'); });
    openWaze.addEventListener('click', ()=>{ if(!current) return; window.open(wazeLink(current.lat,current.lng),'_blank','noopener'); });
    openCustom.addEventListener('click', ()=>{ if(!current) return; const url = customLink(current.lat,current.lng,current.address||''); if(url){ window.location.href = url; } else { toast('Set a custom URL in Settings'); } });
    dirApple.addEventListener('click', ()=>{ if(!current) return; window.open(appleDirections(current.lat,current.lng,current.address||'Destination'),'_blank','noopener'); });

    /* -------- List rendering + Preview Modal -------- */
    function renderList(){
      const q = (searchBox.value||'').toLowerCase().trim();
      const items = readPlaces().filter(p=>{
        const hay = (p.name||'') + ' ' + (p.address||'') + ' ' + (p.category?.name||'');
        return !q || hay.toLowerCase().includes(q);
      });
      listArea.innerHTML = '';
      if(!items.length){
        const d = document.createElement('div'); d.className='empty'; d.innerHTML='No matches.'; listArea.appendChild(d); return;
      }
      for(const p of items){
        const line = document.createElement('div'); line.className='loc-line';

        const meta = document.createElement('div'); meta.className='loc-meta';
        const name = document.createElement('div'); name.className='loc-name';
        name.textContent = `${p.category?.icon||'üìå'} ${p.name}`;
        const sub  = document.createElement('div'); sub.className='loc-sub mono';
        sub.textContent = `${p.lat.toFixed(6)}, ${p.lng.toFixed(6)} ‚Ä¢ ¬±${p.acc} m ‚Ä¢ ${formatTs(p.ts)}${p.address? ' ‚Ä¢ '+p.address:''}`;
        meta.append(name, sub);

        const actions = document.createElement('div'); actions.className='loc-actions';

        const mk = (label, handler, kind='')=>{ const b=document.createElement('button'); b.className='btn '+kind; b.textContent=label; b.addEventListener('click', handler); return b; };

        const prevBtn = mk('Preview', ()=>openPreview(p));
        const appleBtn = mk('Apple', ()=>window.open(appleLink(p.lat,p.lng,p.name),'_blank','noopener'));
        const gBtn = mk('Google', ()=>window.open(googleLink(p.lat,p.lng),'_blank','noopener'));
        const wBtn = mk('Waze', ()=>window.open(wazeLink(p.lat,p.lng),'_blank','noopener'));
        const dirBtn = mk('Directions', ()=>window.open(appleDirections(p.lat,p.lng,p.address||p.name),'_blank','noopener'));
        const shareBtn2 = mk('Share', ()=>sharePlace(p),'ghost');
        const renBtn = mk('Rename', ()=>{ const nv = prompt('Rename:', p.name); if(nv===null) return; p.name=(nv||'Unnamed').trim(); update(p.id,p); renderList(); }, 'ghost');
        const catBtn = mk('Edit Cat', ()=>editCatOfPlace(p), 'ghost');
        const delBtn = mk('Delete', ()=>{ if(confirm('Delete this place?')){ remove(p.id); renderList(); toast('Deleted'); } }, 'danger');

        actions.append(prevBtn, appleBtn, gBtn, wBtn, dirBtn, shareBtn2, renBtn, catBtn, delBtn);

        line.append(meta, actions);
        listArea.appendChild(line);
      }
    }

    function openPreview(p){
      lastPreview = p;
      mapTitle.textContent = `${p.category?.icon||'üìå'} ${p.name}`;
      mapAddr.textContent = p.address || '‚Äî';
      mapFrameWrap.innerHTML = '';
      const iframe = document.createElement('iframe');
      iframe.title = 'Map preview';
      iframe.width = '100%'; iframe.height = '100%'; iframe.style.border='0';
      iframe.loading = 'lazy'; iframe.referrerPolicy='no-referrer-when-downgrade';
      iframe.src = `https://maps.google.com/maps?q=${encodeURIComponent(p.lat+','+p.lng)}&z=16&output=embed`;
      mapFrameWrap.appendChild(iframe);

      mApple.onclick = ()=>window.open(appleLink(p.lat,p.lng,p.name),'_blank','noopener');
      mGoogle.onclick = ()=>window.open(googleLink(p.lat,p.lng),'_blank','noopener');
      mWaze.onclick = ()=>window.open(wazeLink(p.lat,p.lng),'_blank','noopener');
      mDirApple.onclick = ()=>window.open(appleDirections(p.lat,p.lng,p.address||p.name),'_blank','noopener');
      mShare.onclick = ()=>sharePlace(p);

      // if missing address, try to resolve and save
      if(!p.address){ reverseGeocode(p.lat,p.lng).then(addr=>{ if(addr){ p.address=addr; update(p.id,p); mapAddr.textContent=addr; renderList(); } }); }
      mapModal.showModal();
    }
    closeMap.addEventListener('click', ()=>mapModal.close());

    async function sharePlace(p){
      const prefs = readPrefs();
      const url = googleLink(p.lat,p.lng);
      const text = `${p.name} ‚Äî ${p.lat.toFixed(6)},${p.lng.toFixed(6)} (¬±${p.acc} m)${p.address? '\n'+p.address:''}`;
      if(navigator.share){ try{ await navigator.share({ title: prefs.shareTitle||'Save Loc', text, url }); }catch{} }
      else{ try{ await navigator.clipboard.writeText(`${text}\n${url}`); toast('Share copied'); }catch{ toast('Share failed'); } }
    }

    function update(id, patch){ const arr = readPlaces(); const i = arr.findIndex(x=>x.id===id); if(i>-1){ arr[i] = {...arr[i], ...patch}; writePlaces(arr); } }
    function remove(id){ const arr = readPlaces().filter(x=>x.id!==id); writePlaces(arr); }
    searchBox.addEventListener('input', renderList);

    function editCatOfPlace(p){
      const cats = readCats();
      const catStr = cats.map((c,i)=>`${i+1}. ${c.icon} ${c.name}`).join('\n') + `\n0. + Add new`;
      let pick = prompt(`Pick a category number:\n${catStr}`, '1');
      if(pick===null) return;
      pick = parseInt(pick,10); let cat = null;
      if(pick===0){
        const nn = prompt('New category name:','Custom'); if(nn===null) return;
        const ni = prompt('Icon (emoji):','üìå'); if(ni===null) return;
        const arr = readCats(); cat = {id: (Date.now()+'-'+Math.random().toString(16).slice(2)), name: nn.trim()||'Custom', icon: (ni||'üìå').trim()};
        arr.push(cat); writeCats(arr);
      }else{
        cat = cats[isNaN(pick)?0:Math.max(1,Math.min(cats.length,pick))-1] || cats[0];
      }
      update(p.id, {category:cat}); renderList(); toast('Category updated');
    }

    /* -------- Export / Import / Backup / Restore -------- */
    exportBtn.addEventListener('click', ()=>{
      const data = JSON.stringify(readPlaces(), null, 2);
      downloadBlob(data, 'application/json', 'saveloc-places.json');
    });
    importBtn.addEventListener('click', ()=> importFile.click());
    importFile.addEventListener('change', ()=>{
      const f = importFile.files[0]; if(!f) return;
      const fr = new FileReader();
      fr.onload = ()=>{
        try{
          const arr = JSON.parse(fr.result); if(!Array.isArray(arr)) throw new Error('Invalid file');
          const cur = readPlaces(); const map = new Map(cur.map(x=>[x.id,x]));
          for(const p of arr){ if(p && p.id){ map.set(p.id, {...map.get(p.id), ...p}); } }
          const merged = Array.from(map.values()).sort((a,b)=>b.ts-a.ts);
          writePlaces(merged); renderList(); toast('Imported');
        }catch(e){ toast('Import failed'); }
        importFile.value='';
      };
      fr.readAsText(f);
    });

    backupBtn.addEventListener('click', ()=>{
      const backup = { places: readPlaces(), categories: readCats(), prefs: readPrefs(), version: 1, saved_at: new Date().toISOString() };
      downloadBlob(JSON.stringify(backup,null,2),'application/json','saveloc-backup.json');
    });
    restoreBtn.addEventListener('click', ()=> restoreFile.click());
    restoreFile.addEventListener('change', ()=>{
      const f = restoreFile.files[0]; if(!f) return;
      const fr = new FileReader();
      fr.onload = ()=>{
        try{
          const obj = JSON.parse(fr.result);
          if(!obj || !Array.isArray(obj.places) || !Array.isArray(obj.categories)) throw new Error('Invalid backup');
          writePlaces(obj.places||[]);
          writeCats(obj.categories||[]);
          if(obj.prefs) writePrefs(obj.prefs);
          renderList(); renderCatList(); toast('Backup restored');
        }catch(e){ toast('Restore failed'); }
        restoreFile.value='';
      };
      fr.readAsText(f);
    });

    function downloadBlob(data, type, name){
      const blob = new Blob([data], {type:type}); const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url);
    }

    clearAllBtn.addEventListener('click', ()=>{
      if(confirm('Remove ALL saved places?')){ localStorage.removeItem(KEY); renderList(); toast('Cleared'); }
    });

    /* -------- Settings: Categories UI -------- */
    function renderCatList(){
      const cats = readCats(); catList.innerHTML='';
      cats.forEach((c,idx)=>{
        const row = document.createElement('div'); row.className='row'; row.style.justifyContent='space-between';
        const left = document.createElement('div'); left.className='chip'; left.textContent = `${c.icon} ${c.name}`;
        const right = document.createElement('div'); right.className='row';
        const edit = document.createElement('button'); edit.className='btn ghost'; edit.textContent='Edit';
        edit.onclick = ()=>{
          const nn = prompt('Name:', c.name); if(nn===null) return;
          const ni = prompt('Icon (emoji):', c.icon); if(ni===null) return;
          const arr = readCats(); arr[idx] = {...c, name:(nn||c.name).trim(), icon:(ni||c.icon).trim()}; writeCats(arr); renderCatList(); toast('Category updated');
        };
        const del = document.createElement('button'); del.className='btn danger'; del.textContent='Delete';
        del.onclick = ()=>{
          if(!confirm('Delete this category?')) return;
          const arr = readCats().filter(x=>x.id!==c.id); writeCats(arr); // places keep old ref; okay
          renderCatList(); toast('Category deleted');
        };
        right.append(edit,del); row.append(left,right); catList.appendChild(row);
      });
    }
    addCatBtn.addEventListener('click', ()=>{
      const name = (newCatName.value||'').trim(); const icon = (newCatIcon.value||'üìå').trim();
      if(!name){ toast('Enter a category name'); return; }
      const arr = readCats(); arr.push({id: (Date.now()+'-'+Math.random().toString(16).slice(2)), name, icon}); writeCats(arr);
      newCatName.value=''; newCatIcon.value=''; renderCatList(); toast('Category added');
    });

    /* -------- Settings modal wiring -------- */
    const prefsBoot = readPrefs();
    customTpl.value = prefsBoot.customTpl || '';
    shareTitle.value = prefsBoot.shareTitle || 'Save Loc';

    settingsBtn.addEventListener('click', ()=>{ renderCatList(); settingsModal.showModal(); });
    closeSettings.addEventListener('click', ()=> settingsModal.close());
    saveSettings.addEventListener('click', ()=>{ writePrefs({ customTpl:customTpl.value.trim(), shareTitle:shareTitle.value.trim() }); toast('Settings saved'); settingsModal.close(); });
    testCustom.addEventListener('click', ()=>{
      const tpl = customTpl.value.trim();
      if(!tpl){ toast('Set a URL template first'); return; }
      const url = tpl.replaceAll('{lat}','35.6892').replaceAll('{lng}','51.3890').replaceAll('{name}', encodeURIComponent('Test Point'));
      window.location.href = url;
    });

    /* -------- Initial render -------- */
    function initButtons(){
      const hasCustom = !!(readPrefs().customTpl);
      openCustom.disabled = !hasCustom || !current;
    }
    renderList(); initButtons(); enableLiveButtons(false);

  </script>
</body>
</html>
